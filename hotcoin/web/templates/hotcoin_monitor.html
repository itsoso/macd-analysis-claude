<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>热点币实盘监控</title>
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d29;
            --bg-card: #1e2130;
            --bg-hover: #262a3d;
            --text-primary: #e1e4ea;
            --text-secondary: #8b8fa3;
            --text-muted: #5c6078;
            --accent-blue: #4a9eff;
            --accent-green: #00d68f;
            --accent-red: #ff4d6a;
            --accent-yellow: #ffaa00;
            --accent-purple: #a855f7;
            --accent-orange: #f97316;
            --border: #2a2d3e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            padding: 20px; min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 24px; background: var(--bg-secondary);
            border-radius: 12px; margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .header h1 { font-size: 22px; font-weight: 700; }
        .header h1 span { color: var(--accent-yellow); }
        .header-right {
            display: flex; gap: 12px; align-items: center;
            font-size: 13px; color: var(--text-secondary);
        }
        .back-link {
            display: inline-block; color: var(--accent-blue);
            text-decoration: none; font-size: 14px; margin-bottom: 16px;
        }
        .back-link:hover { text-decoration: underline; }

        /* Buttons */
        .btn {
            border: none; padding: 6px 16px; border-radius: 6px;
            cursor: pointer; font-size: 13px; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.85; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent-blue); color: #fff; }
        .btn-outline {
            background: transparent; color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-outline.active { color: var(--accent-blue); border-color: var(--accent-blue); }

        /* Status dots */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-dot.online { background: var(--accent-green); }
        .status-dot.offline { background: var(--accent-red); }
        .status-dot.degraded { background: var(--accent-yellow); }

        /* Stats row */
        .stat-row { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box {
            flex: 1; min-width: 120px;
            background: var(--bg-secondary); border-radius: 8px;
            padding: 14px 18px; border: 1px solid var(--border);
        }
        .stat-box .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-box .value { font-size: 20px; font-weight: 700; }
        .stat-box .value.green { color: var(--accent-green); }
        .stat-box .value.red { color: var(--accent-red); }
        .stat-box .value.yellow { color: var(--accent-yellow); }
        .stat-box .value.blue { color: var(--accent-blue); }

        /* Two-column layout */
        .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }

        /* Card */
        .card {
            background: var(--bg-card); border-radius: 12px;
            border: 1px solid var(--border); padding: 20px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .card-header h2 {
            font-size: 15px; font-weight: 600; color: var(--text-secondary);
        }
        .card-header .badge {
            background: var(--accent-blue); color: #fff;
            padding: 2px 10px; border-radius: 10px; font-size: 12px;
        }

        /* Filter tabs */
        .filter-tabs { display: flex; gap: 6px; }
        .filter-tab {
            padding: 4px 12px; border-radius: 4px; font-size: 12px;
            cursor: pointer; color: var(--text-muted);
            background: transparent; border: 1px solid transparent;
            transition: all 0.2s;
        }
        .filter-tab:hover { color: var(--text-secondary); }
        .filter-tab.active {
            color: var(--accent-blue); border-color: var(--accent-blue);
            background: rgba(74, 158, 255, 0.08);
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th {
            text-align: left; padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted); font-weight: 500; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; user-select: none;
        }
        th:hover { color: var(--text-secondary); }
        td {
            padding: 8px 10px; border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        tr:hover { background: var(--bg-hover); }

        /* Heat bar */
        .heat-bar {
            width: 50px; height: 6px; background: #2a2d3e; border-radius: 3px;
            display: inline-block; position: relative; vertical-align: middle;
        }
        .heat-bar-fill {
            height: 100%; border-radius: 3px; position: absolute; left: 0; top: 0;
        }
        .heat-high { background: var(--accent-green); }
        .heat-mid { background: var(--accent-yellow); }
        .heat-low { background: var(--accent-red); }

        /* Color utilities */
        .chg-pos { color: var(--accent-green); }
        .chg-neg { color: var(--accent-red); }
        .chg-neutral { color: var(--text-muted); }

        /* Tags */
        .tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 500;
        }
        .tag-momentum { background: #1a3a2a; color: var(--accent-green); }
        .tag-listing { background: #3a2a1a; color: var(--accent-yellow); }
        .tag-social { background: #2a1a3a; color: var(--accent-purple); }
        .tag-mixed { background: #1a2a3a; color: var(--accent-blue); }
        .tag-unknown { background: #2a2a2a; color: var(--text-muted); }

        /* Alert level badges */
        .alert-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
        }
        .alert-L1 { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .alert-L2 { background: rgba(249, 115, 22, 0.18); color: var(--accent-orange); }
        .alert-L3 { background: rgba(255, 77, 106, 0.2); color: var(--accent-red); }
        .alert-NONE { color: var(--text-muted); font-size: 11px; }

        /* Pump phase tags */
        .pump-normal { color: var(--text-muted); }
        .pump-accumulation { background: rgba(74, 158, 255, 0.12); color: var(--accent-blue); }
        .pump-early_pump { background: rgba(0, 214, 143, 0.12); color: var(--accent-green); }
        .pump-main_pump { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .pump-distribution { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        /* Signal chips */
        .sig-chip {
            display: inline-block; padding: 1px 5px; border-radius: 3px;
            font-size: 10px; font-weight: 600; margin: 1px;
        }
        .sig-S { background: rgba(0, 214, 143, 0.12); color: var(--accent-green); }
        .sig-F { background: rgba(255, 77, 106, 0.12); color: var(--accent-red); }

        /* Heat dimension bars */
        .dim-bars { display: flex; gap: 2px; align-items: center; }
        .dim-bar {
            width: 8px; height: 16px; border-radius: 2px; background: #2a2d3e;
            position: relative; overflow: hidden;
        }
        .dim-bar-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; border-radius: 2px;
        }
        .dim-bar[title]:hover { opacity: 0.8; cursor: help; }
        .dim-announcement .dim-bar-fill { background: var(--accent-yellow); }
        .dim-social .dim-bar-fill { background: var(--accent-purple); }
        .dim-sentiment .dim-bar-fill { background: var(--accent-orange); }
        .dim-momentum .dim-bar-fill { background: var(--accent-green); }
        .dim-liquidity .dim-bar-fill { background: var(--accent-blue); }
        .dim-risk .dim-bar-fill { background: var(--accent-red); }

        /* Post feed */
        .post-feed { max-height: calc(100vh - 260px); overflow-y: auto; }
        .post-card {
            padding: 14px; border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }
        .post-card:hover { background: var(--bg-hover); }
        .post-card:last-child { border-bottom: none; }
        .post-meta {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 12px;
        }
        .post-source {
            display: flex; align-items: center; gap: 6px;
        }
        .post-source-icon {
            width: 18px; height: 18px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700;
        }
        .post-source-icon.square { background: #3a2a1a; color: var(--accent-yellow); }
        .post-source-icon.twitter { background: #1a2a3a; color: var(--accent-blue); }
        .post-time { color: var(--text-muted); font-size: 11px; }
        .post-title {
            font-weight: 600; font-size: 13px; margin-bottom: 4px;
            color: var(--text-primary); line-height: 1.4;
        }
        .post-body {
            font-size: 12px; color: var(--text-secondary);
            line-height: 1.5; margin-bottom: 8px;
            word-break: break-word;
        }
        .post-footer {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px;
        }
        .post-tickers { display: flex; gap: 4px; flex-wrap: wrap; }
        .ticker-chip {
            padding: 1px 6px; border-radius: 3px;
            background: rgba(74, 158, 255, 0.12); color: var(--accent-blue);
            font-size: 11px; font-weight: 600;
        }
        .sentiment-badge {
            padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;
        }
        .sentiment-pos { background: rgba(0, 214, 143, 0.12); color: var(--accent-green); }
        .sentiment-neg { background: rgba(255, 77, 106, 0.12); color: var(--accent-red); }
        .sentiment-neutral { background: rgba(90, 96, 120, 0.12); color: var(--text-muted); }

        /* Empty state */
        .empty-state {
            text-align: center; padding: 40px 20px;
            color: var(--text-muted); font-size: 14px;
        }
        .empty-state .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }

        /* Auto-refresh toggle */
        .auto-refresh-toggle {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: var(--text-muted);
        }
        .toggle-switch {
            width: 32px; height: 18px; border-radius: 9px;
            background: #3a3d4e; cursor: pointer; position: relative;
            transition: background 0.2s;
        }
        .toggle-switch.active { background: var(--accent-blue); }
        .toggle-switch::after {
            content: ''; position: absolute; width: 14px; height: 14px;
            border-radius: 50%; background: #fff; top: 2px; left: 2px;
            transition: transform 0.2s;
        }
        .toggle-switch.active::after { transform: translateX(14px); }

        /* Scrollbar */
        .post-feed::-webkit-scrollbar { width: 4px; }
        .post-feed::-webkit-scrollbar-track { background: transparent; }
        .post-feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <a href="/" class="back-link">&larr; 返回主页</a>

    <div class="header">
        <h1>热点币实盘监控 <span>HotCoin Monitor</span></h1>
        <div class="header-right">
            <span>引擎 <span class="status-dot" id="engine-dot"></span> <strong id="engine-state">-</strong></span>
            <span>WebSocket <span class="status-dot" id="ws-status"></span></span>
            <div class="auto-refresh-toggle">
                <span>自动刷新</span>
                <div class="toggle-switch active" id="auto-toggle" onclick="toggleAutoRefresh()"></div>
            </div>
            <button class="btn btn-primary" onclick="refreshAll()" id="refresh-btn">刷新</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="stat-row">
        <div class="stat-box">
            <div class="label">候选池</div>
            <div class="value yellow" id="stat-pool">-</div>
        </div>
        <div class="stat-box">
            <div class="label">今日异动</div>
            <div class="value green" id="stat-anomalies">-</div>
        </div>
        <div class="stat-box">
            <div class="label">活跃信号</div>
            <div class="value blue" id="stat-signals">-</div>
        </div>
        <div class="stat-box">
            <div class="label">持仓</div>
            <div class="value" id="stat-positions">0</div>
        </div>
        <div class="stat-box">
            <div class="label">模式</div>
            <div class="value" id="stat-mode" style="font-size:14px">-</div>
        </div>
        <div class="stat-box">
            <div class="label">数据更新</div>
            <div class="value" id="stat-update" style="font-size:13px;color:var(--text-muted)">-</div>
        </div>
    </div>

    <!-- Main content -->
    <div class="main-grid">
        <!-- Left: coin table -->
        <div class="card">
            <div class="card-header">
                <h2>热点币排行榜 <span class="badge" id="pool-badge">0</span></h2>
                <div class="filter-tabs" id="coin-filters">
                    <div class="filter-tab active" data-filter="all" onclick="setCoinFilter('all')">全部</div>
                    <div class="filter-tab" data-filter="momentum" onclick="setCoinFilter('momentum')">动量</div>
                    <div class="filter-tab" data-filter="social" onclick="setCoinFilter('social')">社交</div>
                    <div class="filter-tab" data-filter="listing" onclick="setCoinFilter('listing')">上新</div>
                </div>
            </div>
            <div style="overflow-x:auto">
                <table>
                    <thead>
                        <tr>
                            <th style="width:30px">#</th>
                            <th>币种</th>
                            <th onclick="sortCoins('alert_score')">预警</th>
                            <th onclick="sortCoins('heat_score')" id="th-heat">热度</th>
                            <th>阶段</th>
                            <th>信号</th>
                            <th>来源</th>
                            <th onclick="sortCoins('price_change_5m')">5m%</th>
                            <th onclick="sortCoins('price_change_24h')">24h%</th>
                            <th onclick="sortCoins('quote_volume_24h')">成交额</th>
                            <th onclick="sortCoins('volume_surge_ratio')">量比</th>
                            <th>热度维度</th>
                        </tr>
                    </thead>
                    <tbody id="coin-tbody"></tbody>
                </table>
            </div>
            <div class="empty-state" id="coin-empty" style="display:none">
                <div class="icon">&#x1F50D;</div>
                <div>暂无候选币种数据</div>
            </div>
        </div>

        <!-- Right: post feed -->
        <div class="card" style="padding:0;display:flex;flex-direction:column">
            <div class="card-header" style="padding:20px 20px 0 20px">
                <h2>热帖动态 <span class="badge" id="post-badge">0</span></h2>
                <div class="filter-tabs" id="post-filters">
                    <div class="filter-tab active" data-filter="all" onclick="setPostFilter('all')">全部</div>
                    <div class="filter-tab" data-filter="binance_square" onclick="setPostFilter('binance_square')">广场</div>
                    <div class="filter-tab" data-filter="twitter" onclick="setPostFilter('twitter')">Twitter</div>
                </div>
            </div>
            <div class="post-feed" id="post-feed">
                <div class="empty-state" id="post-empty">
                    <div class="icon">&#x1F4E1;</div>
                    <div>等待热帖数据...</div>
                    <div style="font-size:12px;margin-top:8px">社交监控启动后将自动采集</div>
                </div>
            </div>
        </div>
    </div>

<script>
// ── State ──
let allCoins = [];
let allPosts = [];
let coinFilter = 'all';
let postFilter = 'all';
let sortField = 'alert_score';
let sortAsc = false;
let autoRefresh = true;
let refreshTimer = null;

// ── Data fetch ──
async function refreshAll() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true; btn.textContent = '...';
    try {
        const [statusResp, postsResp] = await Promise.all([
            fetch('/hotcoin/api/status'),
            fetch('/hotcoin/api/hot_posts'),
        ]);
        if (statusResp.ok) {
            const data = await statusResp.json();
            updateStats(data);
            allCoins = data.candidates || [];
            renderCoins();
        }
        if (postsResp.ok) {
            const data = await postsResp.json();
            allPosts = data.posts || [];
            renderPosts();
        }
    } catch(e) { console.error('refresh error:', e); }
    btn.disabled = false; btn.textContent = '刷新';
}

function updateStats(data) {
    document.getElementById('stat-pool').textContent = data.pool_size || 0;
    document.getElementById('stat-anomalies').textContent = data.anomaly_count || 0;
    document.getElementById('stat-signals').textContent = data.active_signals || 0;
    document.getElementById('stat-positions').textContent = data.positions || 0;
    document.getElementById('stat-mode').textContent = data.paper ? 'Paper' : 'Live';
    document.getElementById('stat-mode').style.color =
        data.paper ? 'var(--accent-yellow)' : 'var(--accent-green)';

    const wsStatus = document.getElementById('ws-status');
    wsStatus.className = 'status-dot ' + (data.ws_connected ? 'online' : 'offline');

    const engineState = data.engine_state || 'unknown';
    document.getElementById('engine-state').textContent = engineState;
    const eDot = document.getElementById('engine-dot');
    eDot.className = 'status-dot ' + (
        engineState === 'tradeable' ? 'online' :
        engineState === 'degraded' ? 'degraded' : 'offline'
    );

    if (data.ts) {
        const d = new Date(data.ts * 1000);
        document.getElementById('stat-update').textContent = d.toLocaleTimeString();
    }
}

// ── Coin table ──
function renderCoins() {
    let coins = allCoins;
    if (coinFilter !== 'all') {
        coins = coins.filter(c =>
            coinFilter === 'mixed' ? true : c.source === coinFilter
        );
    }
    coins.sort((a, b) => {
        const va = a[sortField] || 0, vb = b[sortField] || 0;
        const cmp = sortAsc ? va - vb : vb - va;
        if (cmp !== 0) return cmp;
        // 次要排序: alert_score → heat_score
        const sec = sortField === 'alert_score' ? 'heat_score' : 'alert_score';
        return (b[sec] || 0) - (a[sec] || 0);
    });

    document.getElementById('pool-badge').textContent = coins.length;
    const tbody = document.getElementById('coin-tbody');
    const emptyEl = document.getElementById('coin-empty');

    if (coins.length === 0) {
        tbody.innerHTML = '';
        emptyEl.style.display = '';
        return;
    }
    emptyEl.style.display = 'none';

    tbody.innerHTML = coins.map((c, i) => {
        const heatCls = c.heat_score >= 60 ? 'heat-high' : (c.heat_score >= 40 ? 'heat-mid' : 'heat-low');
        const srcCls = 'tag-' + (c.source || 'unknown');
        const chg5m = c.price_change_5m || 0;
        const chg24h = c.price_change_24h || 0;
        const chg5cls = chg5m > 0 ? 'chg-pos' : (chg5m < 0 ? 'chg-neg' : 'chg-neutral');
        const chg24cls = chg24h > 0 ? 'chg-pos' : (chg24h < 0 ? 'chg-neg' : 'chg-neutral');

        const vol = c.quote_volume_24h || 0;
        let volStr;
        if (vol >= 1e9) volStr = '$' + (vol/1e9).toFixed(1) + 'B';
        else if (vol >= 1e6) volStr = '$' + (vol/1e6).toFixed(1) + 'M';
        else if (vol >= 1e3) volStr = '$' + (vol/1e3).toFixed(0) + 'K';
        else volStr = '$' + vol.toFixed(0);

        const surge = c.volume_surge_ratio;
        const surgeStr = surge ? surge.toFixed(1) + 'x' : '-';

        // Dimension bars
        const dims = [
            { cls: 'dim-announcement', val: c.score_announcement || 0, label: '公告' },
            { cls: 'dim-social', val: c.score_social || 0, label: '社交' },
            { cls: 'dim-sentiment', val: c.score_sentiment || 0, label: '情绪' },
            { cls: 'dim-momentum', val: c.score_momentum || 0, label: '动量' },
            { cls: 'dim-liquidity', val: c.score_liquidity || 0, label: '流动性' },
            { cls: 'dim-risk', val: c.score_risk_penalty || 0, label: '风险' },
        ];
        const dimHtml = dims.map(d => {
            const h = Math.min(100, Math.max(0, d.val));
            return `<div class="dim-bar ${d.cls}" title="${d.label}: ${d.val.toFixed(0)}"><div class="dim-bar-fill" style="height:${h}%"></div></div>`;
        }).join('');

        // Alert level
        const alertLv = c.alert_level || 'NONE';
        let alertHtml;
        if (alertLv === 'NONE') {
            alertHtml = '<span class="alert-NONE">-</span>';
        } else {
            const alertNames = { L1: '预警', L2: '起飞', L3: '确认' };
            alertHtml = `<span class="alert-badge alert-${alertLv}">${alertLv} ${alertNames[alertLv] || ''}</span>`;
            if (c.alert_score) alertHtml += `<div style="font-size:10px;color:var(--text-muted);margin-top:2px">${c.alert_score.toFixed(0)}分</div>`;
        }

        // Pump phase
        const phase = c.pump_phase || 'normal';
        const phaseNames = { normal: '-', accumulation: '吸筹', early_pump: '早拉', main_pump: '主升', distribution: '派发' };
        const phaseHtml = phase === 'normal'
            ? `<span class="pump-normal">-</span>`
            : `<span class="tag pump-${phase}">${phaseNames[phase] || phase}</span>`;

        // Signals + Filters
        const sigs = (c.active_signals || '').split(',').filter(Boolean);
        const filts = (c.active_filters || '').split(',').filter(Boolean);
        const sigHtml = sigs.map(s => `<span class="sig-chip sig-S">${s}</span>`).join('')
            + filts.map(f => `<span class="sig-chip sig-F">${f}</span>`).join('');

        return `<tr>
            <td style="color:var(--text-muted)">${i+1}</td>
            <td><strong>${c.symbol.replace('USDT','')}</strong><span style="color:var(--text-muted)">/U</span></td>
            <td>${alertHtml}</td>
            <td>
                <span style="margin-right:4px;font-weight:600">${c.heat_score.toFixed(0)}</span>
                <span class="heat-bar"><span class="heat-bar-fill ${heatCls}" style="width:${Math.min(100,c.heat_score)}%"></span></span>
            </td>
            <td>${phaseHtml}</td>
            <td style="max-width:120px">${sigHtml || '<span style="color:var(--text-muted)">-</span>'}</td>
            <td><span class="tag ${srcCls}">${c.source || '-'}</span></td>
            <td class="${chg5cls}">${(chg5m*100).toFixed(2)}%</td>
            <td class="${chg24cls}">${(chg24h*100).toFixed(2)}%</td>
            <td style="color:var(--text-secondary)">${volStr}</td>
            <td style="color:${surge && surge>=3 ? 'var(--accent-green)' : 'var(--text-secondary)'}">${surgeStr}</td>
            <td><div class="dim-bars">${dimHtml}</div></td>
        </tr>`;
    }).join('');
}

function sortCoins(field) {
    if (sortField === field) {
        sortAsc = !sortAsc;
    } else {
        sortField = field;
        sortAsc = false;
    }
    renderCoins();
}

function setCoinFilter(f) {
    coinFilter = f;
    document.querySelectorAll('#coin-filters .filter-tab').forEach(el => {
        el.classList.toggle('active', el.dataset.filter === f);
    });
    renderCoins();
}

// ── Post feed ──
function renderPosts() {
    let posts = allPosts;
    if (postFilter !== 'all') {
        posts = posts.filter(p => p.source === postFilter);
    }

    document.getElementById('post-badge').textContent = posts.length;
    const feed = document.getElementById('post-feed');
    const emptyEl = document.getElementById('post-empty');

    if (posts.length === 0) {
        feed.innerHTML = '';
        feed.appendChild(emptyEl);
        emptyEl.style.display = '';
        return;
    }

    let html = '';
    posts.forEach(p => {
        const isSquare = p.source === 'binance_square';
        const srcIcon = isSquare
            ? '<div class="post-source-icon square">B</div>'
            : '<div class="post-source-icon twitter">X</div>';
        const srcLabel = isSquare ? '币安广场' : 'Twitter';
        const author = p.author ? ` @${p.author}` : '';
        const time = p.ts ? new Date(p.ts * 1000).toLocaleTimeString() : '';

        const title = p.title ? `<div class="post-title">${escapeHtml(p.title)}</div>` : '';
        const body = p.body ? `<div class="post-body">${escapeHtml(p.body)}</div>` : '';

        const tickers = (p.tickers || []).map(t =>
            `<span class="ticker-chip">$${t}</span>`
        ).join('');

        const s = p.sentiment || 0;
        const sCls = s > 0.1 ? 'sentiment-pos' : (s < -0.1 ? 'sentiment-neg' : 'sentiment-neutral');
        const sLabel = s > 0 ? '+' + s.toFixed(2) : s.toFixed(2);

        html += `<div class="post-card">
            <div class="post-meta">
                <div class="post-source">${srcIcon}<span style="color:var(--text-secondary)">${srcLabel}${author}</span></div>
                <span class="post-time">${time}</span>
            </div>
            ${title}${body}
            <div class="post-footer">
                <div class="post-tickers">${tickers}</div>
                <span class="sentiment-badge ${sCls}">${sLabel}</span>
            </div>
        </div>`;
    });
    feed.innerHTML = html;
}

function setPostFilter(f) {
    postFilter = f;
    document.querySelectorAll('#post-filters .filter-tab').forEach(el => {
        el.classList.toggle('active', el.dataset.filter === f);
    });
    renderPosts();
}

function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

// ── Auto-refresh ──
function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    document.getElementById('auto-toggle').classList.toggle('active', autoRefresh);
    if (autoRefresh) startTimer();
    else stopTimer();
}

function startTimer() {
    stopTimer();
    refreshTimer = setInterval(refreshAll, 10000);
}

function stopTimer() {
    if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
}

// ── Init ──
refreshAll();
startTimer();
</script>
</body>
</html>
