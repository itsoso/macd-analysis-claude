<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>热点币仪表盘</title>
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d29;
            --bg-card: #1e2130;
            --bg-hover: #262a3d;
            --text-primary: #e1e4ea;
            --text-secondary: #8b8fa3;
            --text-muted: #5c6078;
            --accent-blue: #4a9eff;
            --accent-green: #00d68f;
            --accent-red: #ff4d6a;
            --accent-yellow: #ffaa00;
            --accent-purple: #a855f7;
            --border: #2a2d3e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            padding: 20px;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 24px; background: var(--bg-secondary);
            border-radius: 12px; margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .header h1 { font-size: 22px; font-weight: 700; }
        .header h1 span { color: var(--accent-yellow); }
        .header .status {
            display: flex; gap: 16px; align-items: center;
            font-size: 13px; color: var(--text-secondary);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-dot.online { background: var(--accent-green); }
        .status-dot.offline { background: var(--accent-red); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1200px) { .grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-card); border-radius: 12px;
            border: 1px solid var(--border); padding: 20px;
        }
        .card h2 {
            font-size: 15px; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 16px; display: flex; justify-content: space-between;
            align-items: center;
        }
        .card h2 .badge {
            background: var(--accent-blue); color: #fff;
            padding: 2px 10px; border-radius: 10px; font-size: 12px;
        }
        .full-width { grid-column: 1 / -1; }

        table {
            width: 100%; border-collapse: collapse; font-size: 13px;
        }
        th {
            text-align: left; padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted); font-weight: 500; font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        td {
            padding: 8px 10px; border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        tr:hover { background: var(--bg-hover); }

        .heat-bar {
            width: 60px; height: 6px; background: #2a2d3e; border-radius: 3px;
            display: inline-block; position: relative; vertical-align: middle;
        }
        .heat-bar-fill {
            height: 100%; border-radius: 3px; position: absolute; left: 0; top: 0;
        }
        .heat-high { background: var(--accent-green); }
        .heat-mid { background: var(--accent-yellow); }
        .heat-low { background: var(--accent-red); }

        .chg-pos { color: var(--accent-green); }
        .chg-neg { color: var(--accent-red); }
        .chg-neutral { color: var(--text-muted); }

        .tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 500;
        }
        .tag-momentum { background: #1a3a2a; color: var(--accent-green); }
        .tag-listing { background: #3a2a1a; color: var(--accent-yellow); }
        .tag-social { background: #2a1a3a; color: var(--accent-purple); }
        .tag-mixed { background: #1a2a3a; color: var(--accent-blue); }

        .signal-buy { color: var(--accent-green); font-weight: 700; }
        .signal-sell { color: var(--accent-red); font-weight: 700; }
        .signal-hold { color: var(--text-muted); }

        .stat-row { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box {
            flex: 1; min-width: 140px;
            background: var(--bg-secondary); border-radius: 8px;
            padding: 14px 18px; border: 1px solid var(--border);
        }
        .stat-box .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-box .value { font-size: 22px; font-weight: 700; }
        .stat-box .value.green { color: var(--accent-green); }
        .stat-box .value.red { color: var(--accent-red); }
        .stat-box .value.yellow { color: var(--accent-yellow); }

        .back-link {
            display: inline-block; color: var(--accent-blue);
            text-decoration: none; font-size: 14px; margin-bottom: 16px;
        }
        .back-link:hover { text-decoration: underline; }

        .refresh-btn {
            background: var(--accent-blue); color: #fff;
            border: none; padding: 6px 16px; border-radius: 6px;
            cursor: pointer; font-size: 13px;
        }
        .refresh-btn:hover { opacity: 0.85; }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .log-area {
            max-height: 300px; overflow-y: auto;
            background: var(--bg-primary); border-radius: 6px;
            padding: 12px; font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px; line-height: 1.6; color: var(--text-secondary);
        }
        .log-area .log-warn { color: var(--accent-yellow); }
        .log-area .log-info { color: var(--accent-blue); }
        .log-area .log-signal { color: var(--accent-green); font-weight: 600; }
    </style>
</head>
<body>
    <a href="/" class="back-link">&larr; 返回主页</a>

    <div class="header">
        <h1>热点币仪表盘 <span>HotCoin</span></h1>
        <div class="status">
            <span>WebSocket <span class="status-dot" id="ws-status"></span></span>
            <span>候选池 <strong id="pool-count">-</strong></span>
            <span>模式: <strong id="mode-label">Paper</strong></span>
            <button class="refresh-btn" onclick="refreshData()" id="refresh-btn">刷新</button>
        </div>
    </div>

    <div class="stat-row" id="stats-row">
        <div class="stat-box">
            <div class="label">候选池大小</div>
            <div class="value yellow" id="stat-pool">-</div>
        </div>
        <div class="stat-box">
            <div class="label">今日异动</div>
            <div class="value green" id="stat-anomalies">-</div>
        </div>
        <div class="stat-box">
            <div class="label">活跃信号</div>
            <div class="value" id="stat-signals">-</div>
        </div>
        <div class="stat-box">
            <div class="label">持仓数</div>
            <div class="value" id="stat-positions">0</div>
        </div>
        <div class="stat-box">
            <div class="label">今日损益</div>
            <div class="value" id="stat-pnl">$0.00</div>
        </div>
    </div>

    <div class="grid">
        <div class="card full-width">
            <h2>候选池 Top 20 <span class="badge" id="pool-badge">0</span></h2>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>币种</th>
                        <th>热度</th>
                        <th>来源</th>
                        <th>5m涨幅</th>
                        <th>24h涨幅</th>
                        <th>24h成交额</th>
                        <th>量比</th>
                        <th>状态</th>
                        <th>信号</th>
                    </tr>
                </thead>
                <tbody id="pool-tbody"></tbody>
            </table>
        </div>

        <div class="card">
            <h2>最近异动信号</h2>
            <div class="log-area" id="anomaly-log">
                <div style="color:var(--text-muted)">等待数据...</div>
            </div>
        </div>

        <div class="card">
            <h2>最近交易信号</h2>
            <div class="log-area" id="signal-log">
                <div style="color:var(--text-muted)">等待数据...</div>
            </div>
        </div>
    </div>

    <script>
    let autoRefreshTimer = null;

    async function refreshData() {
        const btn = document.getElementById('refresh-btn');
        btn.disabled = true;
        btn.textContent = '加载中...';
        try {
            const resp = await fetch('/hotcoin/api/status');
            if (!resp.ok) throw new Error(resp.statusText);
            const data = await resp.json();
            renderData(data);
        } catch(e) {
            console.error('刷新失败:', e);
        } finally {
            btn.disabled = false;
            btn.textContent = '刷新';
        }
    }

    function renderData(data) {
        // Stats
        document.getElementById('stat-pool').textContent = data.pool_size || 0;
        document.getElementById('pool-count').textContent = data.pool_size || 0;
        document.getElementById('stat-anomalies').textContent = data.anomaly_count || 0;
        document.getElementById('stat-signals').textContent = data.active_signals || 0;
        document.getElementById('stat-positions').textContent = data.positions || 0;
        document.getElementById('mode-label').textContent = data.paper ? 'Paper' : 'Live';

        const wsStatus = document.getElementById('ws-status');
        wsStatus.className = 'status-dot ' + (data.ws_connected ? 'online' : 'offline');

        // Pool table
        const tbody = document.getElementById('pool-tbody');
        const coins = data.candidates || [];
        document.getElementById('pool-badge').textContent = coins.length;
        tbody.innerHTML = '';
        coins.forEach((c, i) => {
            const row = document.createElement('tr');
            const heatClass = c.heat_score >= 60 ? 'heat-high' : (c.heat_score >= 40 ? 'heat-mid' : 'heat-low');
            const sourceClass = 'tag-' + (c.source || 'momentum');
            const chg5m = c.price_change_5m || 0;
            const chg24h = c.price_change_24h || 0;
            const chg5mClass = chg5m > 0 ? 'chg-pos' : (chg5m < 0 ? 'chg-neg' : 'chg-neutral');
            const chg24hClass = chg24h > 0 ? 'chg-pos' : (chg24h < 0 ? 'chg-neg' : 'chg-neutral');
            const sigClass = c.signal === 'BUY' ? 'signal-buy' : (c.signal === 'SELL' ? 'signal-sell' : 'signal-hold');

            row.innerHTML = `
                <td>${i+1}</td>
                <td><strong>${c.symbol.replace('USDT','')}</strong>/USDT</td>
                <td>
                    <span style="margin-right:4px">${c.heat_score.toFixed(0)}</span>
                    <span class="heat-bar"><span class="heat-bar-fill ${heatClass}" style="width:${Math.min(100,c.heat_score)}%"></span></span>
                </td>
                <td><span class="tag ${sourceClass}">${c.source}</span></td>
                <td class="${chg5mClass}">${(chg5m*100).toFixed(2)}%</td>
                <td class="${chg24hClass}">${(chg24h*100).toFixed(2)}%</td>
                <td>$${(c.quote_volume_24h/1e6).toFixed(2)}M</td>
                <td>${c.volume_surge_ratio ? c.volume_surge_ratio.toFixed(1)+'x' : '-'}</td>
                <td>${c.status}</td>
                <td class="${sigClass}">${c.signal || 'HOLD'}</td>
            `;
            tbody.appendChild(row);
        });

        // Anomaly log
        const anomalyLog = document.getElementById('anomaly-log');
        if (data.recent_anomalies && data.recent_anomalies.length > 0) {
            anomalyLog.innerHTML = data.recent_anomalies.map(a =>
                `<div class="log-signal">${a.time} ${a.symbol} vol=${a.vol_ratio}x chg5m=${a.price_chg_5m}</div>`
            ).join('');
        }

        // Signal log
        const signalLog = document.getElementById('signal-log');
        if (data.recent_signals && data.recent_signals.length > 0) {
            signalLog.innerHTML = data.recent_signals.map(s => {
                const cls = s.action === 'BUY' ? 'log-signal' : (s.action === 'SELL' ? 'log-warn' : 'log-info');
                return `<div class="${cls}">${s.time} ${s.action} ${s.symbol} strength=${s.strength} ${s.reason}</div>`;
            }).join('');
        }
    }

    // Auto-refresh every 10s
    function startAutoRefresh() {
        refreshData();
        autoRefreshTimer = setInterval(refreshData, 10000);
    }

    startAutoRefresh();
    </script>
</body>
</html>
