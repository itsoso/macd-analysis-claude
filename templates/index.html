<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒŒç¦»æŠ€æœ¯åˆ†æ - ä»£ç å®ç°ä¸å›æµ‹å±•ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d29;
            --bg-card: #1e2130;
            --bg-hover: #262a3d;
            --text-primary: #e1e4ea;
            --text-secondary: #8b8fa3;
            --text-muted: #5c6078;
            --accent-blue: #4a9eff;
            --accent-green: #00d68f;
            --accent-red: #ff4d6a;
            --accent-yellow: #ffaa00;
            --accent-purple: #a855f7;
            --border: #2a2d3e;
            --sidebar-w: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: var(--sidebar-w);
            min-width: var(--sidebar-w);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px 20px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .nav-section {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 20px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.15s;
            gap: 10px;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(74, 158, 255, 0.1);
            color: var(--accent-blue);
            border-left: 2px solid var(--accent-blue);
        }

        .nav-icon {
            width: 18px;
            text-align: center;
            font-size: 14px;
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .page {
            display: none;
            padding: 32px 40px;
            max-width: 1200px;
        }

        .page.active { display: block; }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent-blue);
        }

        .badge.green { background: rgba(0, 214, 143, 0.15); color: var(--accent-green); }
        .badge.red { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .badge.yellow { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .badge.purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.positive { color: var(--accent-green); }
        .stat-value.negative { color: var(--accent-red); }

        .stat-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Chapter Outline */
        .chapter {
            margin-bottom: 24px;
        }

        .chapter-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .chapter-num {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .chapter-num.ch1 { background: rgba(74, 158, 255, 0.15); color: var(--accent-blue); }
        .chapter-num.ch2 { background: rgba(0, 214, 143, 0.15); color: var(--accent-green); }
        .chapter-num.ch3 { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .chapter-num.ch4 { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .chapter-num.ch5 { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        .chapter-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chapter-content {
            padding-left: 48px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.8;
        }

        .chapter-content ul {
            padding-left: 18px;
        }

        .chapter-content li {
            margin-bottom: 4px;
        }

        .chapter-content .key-concept {
            color: var(--accent-blue);
            font-weight: 500;
        }

        /* Code Blocks */
        .code-section {
            margin-bottom: 24px;
        }

        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #161822;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .code-file { color: var(--accent-blue); font-weight: 500; }

        pre {
            background: #0d0f17;
            border: 1px solid var(--border);
            border-radius: 0 0 8px 8px;
            padding: 16px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        }

        code { font-family: inherit; }

        .kw { color: #c678dd; }
        .fn { color: #61afef; }
        .st { color: #98c379; }
        .cm { color: #5c6370; font-style: italic; }
        .nu { color: #d19a66; }
        .op { color: #56b6c2; }
        .cl { color: #e5c07b; }

        /* Chart Container */
        .chart-container {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .chart-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .chart-toolbar h3 {
            font-size: 14px;
            font-weight: 600;
        }

        #kline-chart { width: 100%; height: 400px; }
        #equity-chart { width: 100%; height: 300px; }

        /* Trade Table */
        .trade-table-wrap {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .pnl-pos { color: var(--accent-green); font-weight: 600; }
        .pnl-neg { color: var(--accent-red); font-weight: 600; }

        /* Principle cards */
        .principle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .principle-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .principle-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }

        .principle-card.sell::before { background: var(--accent-red); }
        .principle-card.buy::before { background: var(--accent-green); }

        .principle-card h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .principle-card p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.7;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Architecture */
        .arch-diagram {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            padding: 24px;
        }

        .arch-layer {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .arch-box {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            border: 1px solid var(--border);
        }

        .arch-box.entry { background: rgba(74, 158, 255, 0.15); color: var(--accent-blue); }
        .arch-box.data { background: rgba(0, 214, 143, 0.15); color: var(--accent-green); }
        .arch-box.core { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .arch-box.analysis { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .arch-box.out { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        .arch-arrow {
            color: var(--text-muted);
            font-size: 20px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar { width: 220px; min-width: 220px; }
            .page { padding: 24px 20px; }
            .principle-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h1>èƒŒç¦»æŠ€æœ¯åˆ†æ</h1>
            <p>æ±Ÿå—å°éš Â· ä»£ç å®ç° & ETHå›æµ‹</p>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">æ¦‚è§ˆ</div>
            <div class="nav-item active" data-page="overview">
                <span class="nav-icon">ğŸ“–</span> ä¹¦ç±å¤§çº²
            </div>
            <div class="nav-item" data-page="architecture">
                <span class="nav-icon">ğŸ—ï¸</span> é¡¹ç›®æ¶æ„
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ä»£ç å®ç°</div>
            <div class="nav-item" data-page="code-indicators">
                <span class="nav-icon">ğŸ“Š</span> æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
            </div>
            <div class="nav-item" data-page="code-pattern">
                <span class="nav-icon">ğŸ“</span> å‡ ä½•å½¢æ€èƒŒç¦»
            </div>
            <div class="nav-item" data-page="code-macd">
                <span class="nav-icon">ğŸ“ˆ</span> MACDèƒŒç¦»
            </div>
            <div class="nav-item" data-page="code-exhaustion">
                <span class="nav-icon">âš¡</span> èƒŒç¦»ä¸èƒŒé©°
            </div>
            <div class="nav-item" data-page="code-other">
                <span class="nav-icon">ğŸ”¬</span> å…¶ä»–æŒ‡æ ‡èƒŒç¦»
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ETH/USDT å›æµ‹</div>
            <div class="nav-item" data-page="backtest-summary">
                <span class="nav-icon">ğŸ’°</span> å›æµ‹æ‘˜è¦
            </div>
            <div class="nav-item" data-page="backtest-chart">
                <span class="nav-icon">ğŸ“‰</span> Kçº¿ä¸ä¿¡å·
            </div>
            <div class="nav-item" data-page="backtest-trades">
                <span class="nav-icon">ğŸ“‹</span> äº¤æ˜“æ˜ç»†
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">

        <!-- ====== ä¹¦ç±å¤§çº² ====== -->
        <div class="page active" id="overview">
            <div class="page-title">ã€ŠèƒŒç¦»æŠ€æœ¯åˆ†æã€‹ä¹¦ç±å¤§çº²</div>
            <div class="page-subtitle">æ±Ÿå—å°éš è‘— Â· ç†è´¢å­¦é™¢ç³»åˆ— Â· å…¨é¢è§£æèƒŒç¦»ä¸èƒŒé©°äº¤æ˜“ä½“ç³»</div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch1">ä¸€</div>
                    <div class="chapter-title">ç¬¬ä¸€ç«  Â· èƒŒç¦»æ€»è¿°</div>
                </div>
                <div class="chapter-content">
                    <p>èƒŒç¦»çš„æ ¸å¿ƒå®šä¹‰: <span class="key-concept">å°†å‰åä¸¤æ®µèµ°åŠ¿çš„ç‰¹å¾è¿›è¡Œæ¯”è¾ƒ, å‘ç°è¶‹åŠ¿è¡°ç«­ä¿¡å·</span></p>
                    <ul>
                        <li>èƒŒç¦»æ˜¯è¶‹åŠ¿è¡°ç«­çš„ä¿¡å·, ä½†ä¸ä¸€å®šé©¬ä¸Šåè½¬</li>
                        <li>å¯ä»¥"èƒŒç¦»äº†åˆèƒŒç¦»", ç›´åˆ°äº§ç”Ÿ<span class="key-concept">èƒŒé©°</span>æ‰æ˜¯æœ€ç»ˆåè½¬</li>
                        <li>èƒŒç¦»åˆ†ææ˜¯ç¡®è®¤æ€§åˆ†æ, è€Œéé¢„æµ‹æ€§åˆ†æ</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch2">äºŒ</div>
                    <div class="chapter-title">ç¬¬äºŒç«  Â· å‡ ä½•å½¢æ€èƒŒç¦»</div>
                </div>
                <div class="chapter-content">
                    <ul>
                        <li><span class="key-concept">è¶‹åŠ¿Kçº¿èƒŒç¦»</span> â€” ä¸Šæ¶¨ä¸­å‡ºç°å¤§é˜´çº¿/ä¸‹è·Œä¸­å‡ºç°å¤§é˜³çº¿, é¢„ç¤ºè¶‹åŠ¿å¯èƒ½åè½¬</li>
                        <li><span class="key-concept">è¶‹åŠ¿å¹…åº¦èƒŒç¦»</span> â€” åä¸€æ®µè¶‹åŠ¿çš„å‚ç›´å¹…åº¦å°äºå‰ä¸€æ®µ, è¯´æ˜æ¨åŠ¨åŠ›å‡å¼±</li>
                        <li><span class="key-concept">æ—¶é—´åº¦èƒŒç¦»</span> â€” åä¸€æ®µè¶‹åŠ¿æŒç»­Kçº¿æ•°å°‘äºå‰ä¸€æ®µ, æ—¶é—´ä¸Šçš„è¡°ç«­</li>
                        <li><span class="key-concept">å‡çº¿èƒŒç¦»</span> â€” ä»·æ ¼å‰§çƒˆç©¿è¶Šé•¿æœŸå‡çº¿(å‡çº¿æ–¹å‘ä¸ä»·æ ¼è¿åŠ¨æ–¹å‘ç›¸å)</li>
                        <li><span class="key-concept">å‡çº¿ç›¸äº¤é¢ç§¯èƒŒç¦»</span> â€” çŸ­æœŸä¸é•¿æœŸå‡çº¿ä¹‹é—´çš„é¢ç§¯ç¼©å°</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch3">ä¸‰</div>
                    <div class="chapter-title">ç¬¬ä¸‰ç«  Â· MACDæŠ€æœ¯æŒ‡æ ‡èƒŒç¦» (æ ¸å¿ƒç« èŠ‚)</div>
                </div>
                <div class="chapter-content">
                    <ul>
                        <li><span class="key-concept">é»„ç™½çº¿(DIF/DEA)èƒŒç¦»</span> â€” ä»·æ ¼åˆ›æ–°é«˜/ä½, DIF/DEAçº¿æœªåŒæ­¥åˆ›æ–°é«˜/ä½</li>
                        <li><span class="key-concept">å½©æŸ±çº¿é•¿åº¦èƒŒç¦»</span> â€” çº¢/ç»¿æŸ±æœ€å¤§é•¿åº¦ç¼©çŸ­
                            <ul>
                                <li><strong>å½“å †èƒŒç¦»</strong>: åŒä¸€å †æŸ±ä½“å†…åé¢çš„æŸ±å­æ¯”å‰é¢çŸ­</li>
                                <li><strong>é‚»å †èƒŒç¦»</strong>: ç›¸é‚»ä¸¤å †æŸ±ä½“ä¸­åå †æœ€å¤§æŸ±å­æ¯”å‰å †çŸ­</li>
                                <li><strong>éš”å †èƒŒç¦»</strong>: éš”å¼€çš„ä¸¤å †æŸ±ä½“ä¸­åå †ä¸å¦‚å‰å †(æœ€é‡è¦!)</li>
                            </ul>
                        </li>
                        <li><span class="key-concept">å½©æŸ±çº¿é¢ç§¯èƒŒç¦»</span> â€” æŸ±ä½“å †é¢ç§¯ç¼©å° (é‚»å †/éš”å †)</li>
                        <li><span class="key-concept">é»„ç™½çº¿ç›¸äº¤é¢ç§¯èƒŒç¦»</span> â€” DIFä¸DEAå›´åˆçš„é¢ç§¯ç¼©å°</li>
                        <li><span class="key-concept">é‡‘å‰/æ­»å‰</span> â€” DIFä¸Šç©¿/ä¸‹ç©¿DEAçš„äº¤å‰ä¿¡å·</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch4">å››</div>
                    <div class="chapter-title">ç¬¬å››ç«  Â· èƒŒç¦»ä¸èƒŒé©° (æ ¸å¿ƒç­–ç•¥)</div>
                </div>
                <div class="chapter-content">
                    <div class="principle-grid" style="padding-left:0; margin-top:12px;">
                        <div class="principle-card sell">
                            <h3>å–ç‚¹ç”¨èƒŒç¦» (å®æ—©å‹¿æ™š)</h3>
                            <p>
                                æ»¡è¶³ä»»ä¸€æ¡ä»¶å³è€ƒè™‘å–å‡º:<br>
                                â‘  MACD DIFè¿œç¦»é›¶è½´åè¿”å›, é‡æ–°ä¸Šå‡ä¸åˆ›æ–°é«˜ + å·²æœ‰ä¸€æ¬¡éš”å †èƒŒç¦»<br>
                                â‘¡ è™½æœªè¿”å›é›¶è½´, ä½†å·²æœ‰ä¸¤æ¬¡ä»¥ä¸Šéš”å †èƒŒç¦»
                            </p>
                        </div>
                        <div class="principle-card buy">
                            <h3>ä¹°ç‚¹ç”¨èƒŒé©° (å®è¿Ÿå‹¿æ—©)</h3>
                            <p>
                                éœ€<strong>åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</strong>æ‰è€ƒè™‘ä¹°å…¥:<br>
                                â‘  äº§ç”Ÿäº†ä¸¤æ¬¡ä»¥ä¸Šéš”å †èƒŒç¦»<br>
                                â‘¡ MACD DIFçº¿ä¸¤æ¬¡è¿”å›é›¶è½´åå†åº¦åº•èƒŒç¦»
                            </p>
                        </div>
                    </div>
                    <ul>
                        <li><span class="key-concept">èƒŒé©°</span> = è¶‹åŠ¿çš„æœ€åä¸€æ¬¡èƒŒç¦», ä¸€æ—¦äº§ç”Ÿé©¬ä¸Šåè½¬</li>
                        <li>èƒŒç¦»å¯ä»¥åå¤, ä½†èƒŒé©°åªå‡ºç°ä¸€æ¬¡</li>
                        <li>èƒŒé©°æ˜¯èƒŒç¦»é‡ç§¯ç´¯åˆ°è´¨å˜çš„é£è·ƒ</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch5">äº”</div>
                    <div class="chapter-title">ç¬¬äº”ç«  Â· å…¶ä»–èƒŒç¦»æ–¹æ³•</div>
                </div>
                <div class="chapter-content">
                    <ul>
                        <li><span class="key-concept">KDJæŒ‡æ ‡èƒŒç¦»</span> â€” ä»·æ ¼æ–°é«˜/ä½è€ŒKDJçš„K/Dçº¿æœªåŒæ­¥, å°¤å…¶åœ¨è¶…ä¹°(>80)/è¶…å–(<20)åŒºåŸŸ</li>
                        <li><span class="key-concept">CCIæŒ‡æ ‡èƒŒç¦»</span> â€” ä»·æ ¼æ–°é«˜/ä½è€ŒCCIæœªåŒæ­¥, CCIè¶Šè¿‡+100(å¤©çº¿)æˆ–è·Œç ´-100(åœ°çº¿)ä¸ºå¼ºä¿¡å·</li>
                        <li><span class="key-concept">RSIæŒ‡æ ‡èƒŒç¦»</span> â€” ä»·æ ¼æ–°é«˜/ä½è€ŒRSIæœªåŒæ­¥, å…³æ³¨RSIåœ¨80ä»¥ä¸Š(è¶…ä¹°)æˆ–20ä»¥ä¸‹(è¶…å–)çš„åŒºåŸŸ</li>
                        <li><span class="key-concept">é‡ä»·èƒŒç¦»</span> â€” ä»·å‡é‡å‡(ä¸Šæ¶¨ä¹åŠ›)ã€ä»·è·Œé‡å¢(ææ…ŒæŠ›å”®)ã€åœ°é‡åœ°ä»·(æ½œåœ¨åº•éƒ¨)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ====== é¡¹ç›®æ¶æ„ ====== -->
        <div class="page" id="architecture">
            <div class="page-title">é¡¹ç›®æ¶æ„</div>
            <div class="page-subtitle">åŸºäº Python å®ç°çš„å®Œæ•´èƒŒç¦»åˆ†æç³»ç»Ÿ</div>

            <div class="card">
                <div class="card-title">ç³»ç»Ÿæ¶æ„å›¾</div>
                <div class="arch-diagram">
                    <div class="arch-layer">
                        <div class="arch-box entry">main.py<br><small>å‘½ä»¤è¡Œå…¥å£</small></div>
                        <div class="arch-box entry">app.py<br><small>Web å±•ç¤º</small></div>
                        <div class="arch-box entry">backtest.py<br><small>å›æµ‹å¼•æ“</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box analysis">ComprehensiveAnalyzer<br><small>ç»¼åˆåˆ†æå™¨</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box core">PatternDiv<br><small>å½¢æ€èƒŒç¦»</small></div>
                        <div class="arch-box core">MACDDiv<br><small>MACDèƒŒç¦»</small></div>
                        <div class="arch-box core">Exhaustion<br><small>èƒŒé©°åˆ†æ</small></div>
                        <div class="arch-box core">KDJ/CCI/RSI<br><small>æŒ‡æ ‡èƒŒç¦»</small></div>
                        <div class="arch-box core">VolPrice<br><small>é‡ä»·èƒŒç¦»</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box data">indicators.py<br><small>æŠ€æœ¯æŒ‡æ ‡è®¡ç®—</small></div>
                        <div class="arch-box data">config.py<br><small>å‚æ•°é…ç½®</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box out">binance_fetcher.py<br><small>å¸å®‰æ•°æ®è·å–</small></div>
                        <div class="arch-box out">data_fetcher.py<br><small>Aè‚¡/CSVæ•°æ®</small></div>
                        <div class="arch-box out">visualization.py<br><small>å›¾è¡¨å¯è§†åŒ–</small></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">æ–‡ä»¶ç»“æ„</div>
                <pre><code><span class="st">macd-analysis-claude/</span>
â”œâ”€â”€ <span class="fn">config.py</span>             <span class="cm"># å…¨å±€å‚æ•°é…ç½® (MACD/KDJ/CCI/RSIå‚æ•°, èƒŒç¦»é˜ˆå€¼)</span>
â”œâ”€â”€ <span class="fn">indicators.py</span>         <span class="cm"># æŠ€æœ¯æŒ‡æ ‡: SMA, EMA, MACD, KDJ, CCI, RSI</span>
â”œâ”€â”€ <span class="fn">binance_fetcher.py</span>    <span class="cm"># å¸å®‰APIæ•°æ®è·å– (10åˆ†é’ŸKçº¿)</span>
â”œâ”€â”€ <span class="fn">data_fetcher.py</span>       <span class="cm"># Aè‚¡/CSV/æ¨¡æ‹Ÿæ•°æ®è·å–</span>
â”œâ”€â”€ <span class="fn">backtest.py</span>           <span class="cm"># å›æµ‹å¼•æ“ (æ­¢æŸæ­¢ç›ˆ/å†·å´æœŸ/ä¿¡å·è¿‡æ»¤)</span>
â”œâ”€â”€ <span class="fn">visualization.py</span>      <span class="cm"># Matplotlib å¤šé¢æ¿å›¾è¡¨</span>
â”œâ”€â”€ <span class="fn">main.py</span>               <span class="cm"># å‘½ä»¤è¡Œä¸»ç¨‹åº</span>
â”œâ”€â”€ <span class="fn">app.py</span>                <span class="cm"># Flask Web åº”ç”¨</span>
â”œâ”€â”€ <span class="st">divergence/</span>           <span class="cm"># èƒŒç¦»æ£€æµ‹æ¨¡å—åŒ…</span>
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ <span class="fn">pattern_divergence.py</span>    <span class="cm"># ç¬¬äºŒç« : å‡ ä½•å½¢æ€èƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">macd_divergence.py</span>       <span class="cm"># ç¬¬ä¸‰ç« : MACDèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">exhaustion.py</span>            <span class="cm"># ç¬¬å››ç« : èƒŒç¦»ä¸èƒŒé©°</span>
â”‚   â”œâ”€â”€ <span class="fn">kdj_divergence.py</span>        <span class="cm"># ç¬¬äº”ç« : KDJèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">cci_divergence.py</span>        <span class="cm"># ç¬¬äº”ç« : CCIèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">rsi_divergence.py</span>        <span class="cm"># ç¬¬äº”ç« : RSIèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">volume_price_divergence.py</span>  <span class="cm"># ç¬¬äº”ç« : é‡ä»·èƒŒç¦»</span>
â”‚   â””â”€â”€ <span class="fn">comprehensive.py</span>         <span class="cm"># ç»¼åˆåˆ†æ & è¯„åˆ†</span>
â””â”€â”€ <span class="st">templates/</span>
    â””â”€â”€ index.html        <span class="cm"># Web å±•ç¤ºé¡µé¢</span></code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : æŠ€æœ¯æŒ‡æ ‡ ====== -->
        <div class="page" id="code-indicators">
            <div class="page-title">æŠ€æœ¯æŒ‡æ ‡è®¡ç®—</div>
            <div class="page-subtitle">indicators.py Â· æ‰€æœ‰åˆ†æçš„åŸºç¡€</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">indicators.py</span>
                    <span>MACD è®¡ç®—</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">calc_macd</span>(close: pd.Series, fast=<span class="nu">12</span>, slow=<span class="nu">26</span>, signal=<span class="nu">9</span>) -> pd.DataFrame:
    <span class="st">"""è®¡ç®—MACDæŒ‡æ ‡: DIF, DEA, MACD_BAR"""</span>
    ema_fast = close.ewm(span=fast, adjust=<span class="kw">False</span>).mean()
    ema_slow = close.ewm(span=slow, adjust=<span class="kw">False</span>).mean()
    dif = ema_fast - ema_slow                    <span class="cm"># å¿«çº¿-æ…¢çº¿ = DIF(ç™½çº¿)</span>
    dea = dif.ewm(span=signal, adjust=<span class="kw">False</span>).mean()  <span class="cm"># DIFçš„EMA = DEA(é»„çº¿)</span>
    bar = <span class="nu">2</span> * (dif - dea)                       <span class="cm"># çº¢ç»¿æŸ± = 2*(DIF-DEA)</span>
    <span class="kw">return</span> pd.DataFrame({<span class="st">'DIF'</span>: dif, <span class="st">'DEA'</span>: dea, <span class="st">'MACD_BAR'</span>: bar})</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">indicators.py</span>
                    <span>KDJ / CCI / RSI</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">calc_kdj</span>(high, low, close, n=<span class="nu">9</span>, m1=<span class="nu">3</span>, m2=<span class="nu">3</span>):
    <span class="st">"""KDJéšæœºæŒ‡æ ‡: RSV -> K -> D -> J"""</span>
    lowest = low.rolling(n).min()
    highest = high.rolling(n).max()
    rsv = (close - lowest) / (highest - lowest) * <span class="nu">100</span>
    k = rsv.ewm(com=m1-<span class="nu">1</span>, adjust=<span class="kw">False</span>).mean()
    d = k.ewm(com=m2-<span class="nu">1</span>, adjust=<span class="kw">False</span>).mean()
    j = <span class="nu">3</span> * k - <span class="nu">2</span> * d
    <span class="kw">return</span> pd.DataFrame({<span class="st">'K'</span>: k, <span class="st">'D'</span>: d, <span class="st">'J'</span>: j})

<span class="kw">def</span> <span class="fn">calc_cci</span>(high, low, close, n=<span class="nu">14</span>):
    <span class="st">"""CCIé¡ºåŠ¿æŒ‡æ ‡: TPçš„åç¦»åº¦/å¹³å‡åå·®"""</span>
    tp = (high + low + close) / <span class="nu">3</span>
    ma = tp.rolling(n).mean()
    md = tp.rolling(n).apply(<span class="kw">lambda</span> x: np.abs(x - x.mean()).mean())
    <span class="kw">return</span> (tp - ma) / (<span class="nu">0.015</span> * md)

<span class="kw">def</span> <span class="fn">calc_rsi</span>(close, period=<span class="nu">6</span>):
    <span class="st">"""RSIç›¸å¯¹å¼ºå¼±æŒ‡æ ‡: æ¶¨å¹…å‡å€¼/(æ¶¨å¹…å‡å€¼+è·Œå¹…å‡å€¼)*100"""</span>
    delta = close.diff()
    gain = delta.clip(lower=<span class="nu">0</span>).ewm(alpha=<span class="nu">1</span>/period, adjust=<span class="kw">False</span>).mean()
    loss = (-delta.clip(upper=<span class="nu">0</span>)).ewm(alpha=<span class="nu">1</span>/period, adjust=<span class="kw">False</span>).mean()
    <span class="kw">return</span> <span class="nu">100</span> - <span class="nu">100</span> / (<span class="nu">1</span> + gain / loss)</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">indicators.py</span>
                    <span>è¾…åŠ©å‡½æ•°: æ³¢å³°æ³¢è°· / è¶‹åŠ¿åˆ†æ®µ / MACDæŸ±å †è¯†åˆ«</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">find_swing_highs</span>(series, order=<span class="nu">5</span>):
    <span class="st">"""å¯»æ‰¾å±€éƒ¨é«˜ç‚¹(æ³¢å³°), order=å‰åå„5æ ¹Kçº¿èŒƒå›´"""</span>
    highs = []
    <span class="kw">for</span> i <span class="kw">in</span> range(order, len(series) - order):
        <span class="kw">if</span> all(series.iloc[i] >= series.iloc[i-j] <span class="kw">for</span> j <span class="kw">in</span> range(<span class="nu">1</span>, order+<span class="nu">1</span>)) \
           <span class="kw">and</span> all(series.iloc[i] >= series.iloc[i+j] <span class="kw">for</span> j <span class="kw">in</span> range(<span class="nu">1</span>, order+<span class="nu">1</span>)):
            highs.append(i)
    <span class="kw">return</span> highs

<span class="kw">def</span> <span class="fn">identify_bar_groups</span>(bar: pd.Series):
    <span class="st">"""è¯†åˆ«MACDæŸ±å †: è¿ç»­çº¢æŸ±(>0)æˆ–ç»¿æŸ±(<0)ä¸ºä¸€å †"""</span>
    groups = []
    current_sign = <span class="kw">None</span>
    start_idx = <span class="nu">0</span>
    <span class="kw">for</span> i, v <span class="kw">in</span> enumerate(bar):
        sign = <span class="st">'red'</span> <span class="kw">if</span> v >= <span class="nu">0</span> <span class="kw">else</span> <span class="st">'green'</span>
        <span class="kw">if</span> sign != current_sign:
            <span class="kw">if</span> current_sign <span class="kw">is not None</span>:
                groups.append({<span class="st">'type'</span>: current_sign, <span class="st">'start'</span>: start_idx, <span class="st">'end'</span>: i-<span class="nu">1</span>})
            current_sign = sign
            start_idx = i
    groups.append({<span class="st">'type'</span>: current_sign, <span class="st">'start'</span>: start_idx, <span class="st">'end'</span>: len(bar)-<span class="nu">1</span>})
    <span class="kw">return</span> groups</code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : å‡ ä½•å½¢æ€èƒŒç¦» ====== -->
        <div class="page" id="code-pattern">
            <div class="page-title">ç¬¬äºŒç«  Â· å‡ ä½•å½¢æ€èƒŒç¦»</div>
            <div class="page-subtitle">pattern_divergence.py Â· 5ç§å½¢æ€èƒŒç¦»æ£€æµ‹</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/pattern_divergence.py</span>
                    <span>è¶‹åŠ¿Kçº¿èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_kline_divergence</span>(<span class="kw">self</span>, lookback=<span class="nu">20</span>, body_ratio=<span class="nu">0.02</span>):
    <span class="st">"""æ£€æµ‹è¶‹åŠ¿ä¸­å‡ºç°çš„åå‘å¤§Kçº¿
    ä¸Šæ¶¨è¶‹åŠ¿ä¸­çš„å¤§é˜´çº¿(å®ä½“>=2%), æˆ–ä¸‹è·Œè¶‹åŠ¿ä¸­çš„å¤§é˜³çº¿"""</span>
    signals = []
    <span class="kw">for</span> i <span class="kw">in</span> range(lookback, len(df)):
        body = abs(df[<span class="st">'close'</span>].iloc[i] - df[<span class="st">'open'</span>].iloc[i])
        body_pct = body / df[<span class="st">'open'</span>].iloc[i]
        <span class="kw">if</span> body_pct < body_ratio:
            <span class="kw">continue</span>
        <span class="cm"># åˆ¤æ–­è¿‘æœŸè¶‹åŠ¿æ–¹å‘ (ç”¨MAæ–œç‡)</span>
        trend = df[<span class="st">'close'</span>].iloc[i-lookback:i].mean() - df[<span class="st">'close'</span>].iloc[i-lookback]
        is_bearish = df[<span class="st">'close'</span>].iloc[i] < df[<span class="st">'open'</span>].iloc[i]
        <span class="kw">if</span> trend > <span class="nu">0</span> <span class="kw">and</span> is_bearish:   <span class="cm"># ä¸Šæ¶¨ä¸­å¤§é˜´çº¿</span>
            signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'idx'</span>: i, <span class="st">'severity'</span>: body_pct})
        <span class="kw">elif</span> trend < <span class="nu">0</span> <span class="kw">and not</span> is_bearish:  <span class="cm"># ä¸‹è·Œä¸­å¤§é˜³çº¿</span>
            signals.append({<span class="st">'type'</span>: <span class="st">'bottom'</span>, <span class="st">'idx'</span>: i})
    <span class="kw">return</span> signals</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/pattern_divergence.py</span>
                    <span>è¶‹åŠ¿å¹…åº¦ & æ—¶é—´åº¦èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_amplitude_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>, shrink_ratio=<span class="nu">0.7</span>):
    <span class="st">"""æ£€æµ‹è¶‹åŠ¿å¹…åº¦è¡°å‡: åä¸€æ®µæ¶¨/è·Œå¹… < å‰ä¸€æ®µ Ã— shrink_ratio"""</span>
    up_segs, down_segs = identify_trend_segments(df, order)
    signals = []
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(up_segs)):
        prev_amp = up_segs[i-<span class="nu">1</span>][<span class="st">'amplitude'</span>]
        curr_amp = up_segs[i][<span class="st">'amplitude'</span>]
        <span class="kw">if</span> curr_amp < prev_amp * shrink_ratio:
            signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'ratio'</span>: curr_amp/prev_amp})
    <span class="kw">return</span> signals

<span class="kw">def</span> <span class="fn">detect_time_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>, shrink_ratio=<span class="nu">0.7</span>):
    <span class="st">"""æ£€æµ‹æ—¶é—´åº¦è¡°å‡: åä¸€æ®µæŒç»­Kçº¿æ•° < å‰ä¸€æ®µ Ã— shrink_ratio"""</span>
    <span class="cm"># é€»è¾‘ç±»ä¼¼å¹…åº¦èƒŒç¦», æ¯”è¾ƒ segment['duration'] å³Kçº¿æ•°</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/pattern_divergence.py</span>
                    <span>å‡çº¿ç›¸äº¤é¢ç§¯èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_ma_area_divergence</span>(<span class="kw">self</span>, short_period=<span class="nu">5</span>, long_period=<span class="nu">30</span>):
    <span class="st">"""çŸ­æœŸå‡çº¿ä¸é•¿æœŸå‡çº¿ä¹‹é—´çš„é¢ç§¯é€æ¸ç¼©å° -> è¶‹åŠ¿å‡å¼±"""</span>
    ma_short = df[<span class="st">'close'</span>].rolling(short_period).mean()
    ma_long  = df[<span class="st">'close'</span>].rolling(long_period).mean()
    diff = ma_short - ma_long           <span class="cm"># MAå·®å€¼åºåˆ—</span>
    <span class="cm"># å°†è¿ç»­æ­£å€¼/è´Ÿå€¼åŒºé—´è¯†åˆ«ä¸ºä¸€ä¸ª"é¢ç§¯æ®µ"</span>
    <span class="cm"># æ¯”è¾ƒç›¸é‚»åŒå‘é¢ç§¯æ®µ: åæ®µé¢ç§¯ < å‰æ®µé¢ç§¯ Ã— shrink_ratio</span></code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : MACDèƒŒç¦» ====== -->
        <div class="page" id="code-macd">
            <div class="page-title">ç¬¬ä¸‰ç«  Â· MACD æŠ€æœ¯æŒ‡æ ‡èƒŒç¦»</div>
            <div class="page-subtitle">macd_divergence.py Â· ä¹¦ä¸­æœ€æ ¸å¿ƒçš„èƒŒç¦»æ£€æµ‹</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/macd_divergence.py</span>
                    <span>é»„ç™½çº¿(DIF/DEA)èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_dif_dea_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
    <span class="st">"""ä»·æ ¼åˆ›æ–°é«˜ä½†DIF/DEAæœªåˆ›æ–°é«˜ = é¡¶èƒŒç¦»
    ä»·æ ¼åˆ›æ–°ä½ä½†DIF/DEAæœªåˆ›æ–°ä½ = åº•èƒŒç¦»"""</span>
    price_highs = find_swing_highs(df[<span class="st">'high'</span>], order)
    dif_at_highs = [df[<span class="st">'DIF'</span>].iloc[h] <span class="kw">for</span> h <span class="kw">in</span> price_highs]

    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(price_highs)):
        <span class="cm"># ä»·æ ¼æ–°é«˜ä½†DIFæœªæ–°é«˜ -> é¡¶èƒŒç¦»</span>
        <span class="kw">if</span> df[<span class="st">'high'</span>].iloc[price_highs[i]] > df[<span class="st">'high'</span>].iloc[price_highs[i-<span class="nu">1</span>]] \
           <span class="kw">and</span> dif_at_highs[i] < dif_at_highs[i-<span class="nu">1</span>] * <span class="nu">0.9</span>:
            signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'subtype'</span>: <span class="st">'dif_dea'</span>, ...})</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/macd_divergence.py</span>
                    <span>å½©æŸ±çº¿é•¿åº¦èƒŒç¦» (å½“å †/é‚»å †/éš”å †)</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_bar_length_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
    <span class="st">"""MACDæŸ±çº¿é•¿åº¦èƒŒç¦» â€” ä¸‰ç§å­ç±»å‹"""</span>
    groups = identify_bar_groups(df[<span class="st">'MACD_BAR'</span>])

    <span class="cm"># 1. å½“å †èƒŒç¦»: åŒä¸€å †å†…åé¢æŸ±å­çš„æœ€å¤§å€¼å¼€å§‹ç¼©å°</span>
    <span class="kw">for</span> g <span class="kw">in</span> groups:
        bars = df[<span class="st">'MACD_BAR'</span>].iloc[g[<span class="st">'start'</span>]:g[<span class="st">'end'</span>]+<span class="nu">1</span>]
        peak_idx = bars.abs().idxmax()
        <span class="cm"># å¦‚æœå³°å€¼å‡ºç°åœ¨å †çš„å‰åŠéƒ¨åˆ†, ååŠéƒ¨åˆ†æŒç»­ç¼©å° -> å½“å †èƒŒç¦»</span>

    <span class="cm"># 2. é‚»å †èƒŒç¦»: ç›¸é‚»ä¸¤ä¸ªåŒè‰²å †çš„æœ€å¤§æŸ±å­å¯¹æ¯”</span>
    red_groups = [g <span class="kw">for</span> g <span class="kw">in</span> groups <span class="kw">if</span> g[<span class="st">'type'</span>] == <span class="st">'red'</span>]
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(red_groups)):
        <span class="kw">if</span> max_bar(red_groups[i]) < max_bar(red_groups[i-<span class="nu">1</span>]) * <span class="nu">0.7</span>:
            <span class="cm"># é‚»å †èƒŒç¦» (å¦‚æœä¸¤å †ç›¸é‚») æˆ– éš”å †èƒŒç¦» (å¦‚æœä¸­é—´éš”äº†å…¶ä»–å †)</span>

    <span class="cm"># 3. éš”å †èƒŒç¦» (æœ€é‡è¦! åˆ¤æ–­èƒŒé©°çš„æ ¸å¿ƒä¾æ®)</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/macd_divergence.py</span>
                    <span>å½©æŸ±çº¿é¢ç§¯èƒŒç¦» & é‡‘å‰æ­»å‰åˆ†æ</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_bar_area_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
    <span class="st">"""æŸ±å †é¢ç§¯(æ‰€æœ‰æŸ±å­ç»å¯¹å€¼ä¹‹å’Œ)èƒŒç¦»"""</span>
    groups = identify_bar_groups(df[<span class="st">'MACD_BAR'</span>])
    <span class="kw">for</span> g <span class="kw">in</span> groups:
        g[<span class="st">'area'</span>] = df[<span class="st">'MACD_BAR'</span>].iloc[g[<span class="st">'start'</span>]:g[<span class="st">'end'</span>]+<span class="nu">1</span>].abs().sum()
    <span class="cm"># æ¯”è¾ƒåŒè‰²ç›¸é‚»/éš”å †çš„é¢ç§¯å˜åŒ–</span>

<span class="kw">def</span> <span class="fn">analyze_macd_crosses</span>(<span class="kw">self</span>):
    <span class="st">"""é‡‘å‰: DIFä¸Šç©¿DEA (ä¹°å…¥ä¿¡å·)
    æ­»å‰: DIFä¸‹ç©¿DEA (å–å‡ºä¿¡å·)
    é›¶è½´ä¸Šæ–¹é‡‘å‰æ›´å¼º, é›¶è½´ä¸‹æ–¹æ­»å‰æ›´å¼±"""</span>
    crosses = find_macd_crosses(df[<span class="st">'DIF'</span>], df[<span class="st">'DEA'</span>])
    <span class="kw">for</span> c <span class="kw">in</span> crosses:
        c[<span class="st">'above_zero'</span>] = df[<span class="st">'DIF'</span>].iloc[c[<span class="st">'idx'</span>]] > <span class="nu">0</span>
    <span class="kw">return</span> crosses</code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : èƒŒç¦»ä¸èƒŒé©° ====== -->
        <div class="page" id="code-exhaustion">
            <div class="page-title">ç¬¬å››ç«  Â· èƒŒç¦»ä¸èƒŒé©°</div>
            <div class="page-subtitle">exhaustion.py Â· å…¨ä¹¦æœ€æ ¸å¿ƒçš„æ“ä½œç­–ç•¥</div>

            <div class="principle-grid">
                <div class="principle-card sell">
                    <h3>å–ç‚¹ç”¨èƒŒç¦» (å®æ—©å‹¿æ™š)</h3>
                    <p>MACDéš”å †èƒŒç¦»ä¸€æ¬¡ + DIFè¿”å›é›¶è½´ â†’ å³è€ƒè™‘å–å‡º<br>
                    æˆ–: ä¸¤æ¬¡ä»¥ä¸Šéš”å †èƒŒç¦» â†’ æ— è®ºæ˜¯å¦è¿”å›é›¶è½´éƒ½è€ƒè™‘å–å‡º</p>
                </div>
                <div class="principle-card buy">
                    <h3>ä¹°ç‚¹ç”¨èƒŒé©° (å®è¿Ÿå‹¿æ—©)</h3>
                    <p>äºŒæ¬¡ä»¥ä¸Šéš”å †èƒŒç¦» + DIFä¸¤æ¬¡è¿”å›é›¶è½´åå†åº¦åº•èƒŒç¦» â†’ æ‰è€ƒè™‘ä¹°å…¥<br>
                    æ¡ä»¶æ›´ä¸¥æ ¼, å‡å°‘æŠ„åº•é£é™©</p>
                </div>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/exhaustion.py</span>
                    <span>èƒŒé©°æ£€æµ‹æ ¸å¿ƒé€»è¾‘</span>
                </div>
                <pre><code><span class="kw">class</span> <span class="cl">ExhaustionAnalyzer</span>:
    <span class="st">"""èƒŒé©°åˆ†æå™¨ â€” è¶‹åŠ¿çš„æœ€åä¸€æ¬¡èƒŒç¦»"""</span>

    <span class="kw">def</span> <span class="fn">_count_zero_returns</span>(<span class="kw">self</span>, direction=<span class="st">'top'</span>):
        <span class="st">"""è®¡ç®—MACD DIFçº¿è¿”å›é›¶è½´çš„æ¬¡æ•°
        é¡¶èƒŒé©°: DIFä»æ­£å€¼åŒºåŸŸå›åˆ°0é™„è¿‘å†å›å‡çš„æ¬¡æ•°
        åº•èƒŒé©°: DIFä»è´Ÿå€¼åŒºåŸŸå›åˆ°0é™„è¿‘å†å›è½çš„æ¬¡æ•°"""</span>
        dif = <span class="kw">self</span>.df[<span class="st">'DIF'</span>]
        zero_threshold = dif.abs().mean() * <span class="nu">0.1</span>  <span class="cm"># æ¥è¿‘é›¶è½´çš„é˜ˆå€¼</span>
        <span class="cm"># éå†DIFåºåˆ—, æ£€æµ‹ "è¿œç¦»é›¶è½´ -> æ¥è¿‘é›¶è½´ -> å†æ¬¡è¿œç¦»" çš„æ¨¡å¼</span>
        returns = []
        <span class="cm">...</span>
        <span class="kw">return</span> returns

    <span class="kw">def</span> <span class="fn">_count_separated_divergences</span>(<span class="kw">self</span>, direction=<span class="st">'top'</span>):
        <span class="st">"""è®¡ç®—éš”å †èƒŒç¦»æ¬¡æ•°(æœ€å…³é”®çš„èƒŒé©°åˆ¤æ®)"""</span>
        <span class="cm"># ä½¿ç”¨ MACDDivergenceAnalyzer è·å–éš”å †èƒŒç¦»ä¿¡å·</span>
        bar_divs = <span class="kw">self</span>.macd_analyzer.detect_bar_length_divergence()
        separated = [d <span class="kw">for</span> d <span class="kw">in</span> bar_divs
                     <span class="kw">if</span> d.get(<span class="st">'subtype'</span>) == <span class="st">'separated'</span>
                     <span class="kw">and</span> d[<span class="st">'type'</span>] == direction]
        <span class="kw">return</span> separated

    <span class="kw">def</span> <span class="fn">detect_exhaustion</span>(<span class="kw">self</span>):
        <span class="st">"""ç»¼åˆåˆ¤æ–­èƒŒé©°"""</span>
        results = []

        <span class="cm"># é¡¶èƒŒé©° (å–å‡ºæ¡ä»¶å®½æ¾)</span>
        top_sep = <span class="kw">self</span>._count_separated_divergences(<span class="st">'top'</span>)
        top_zeros = <span class="kw">self</span>._count_zero_returns(<span class="st">'top'</span>)
        <span class="kw">if</span> len(top_sep) >= <span class="nu">1</span> <span class="kw">and</span> len(top_zeros) >= <span class="nu">1</span>:
            results.append({<span class="st">'type'</span>: <span class="st">'top_exhaustion'</span>, <span class="st">'confidence'</span>: <span class="st">'high'</span>})
        <span class="kw">elif</span> len(top_sep) >= <span class="nu">2</span>:
            results.append({<span class="st">'type'</span>: <span class="st">'top_exhaustion'</span>, <span class="st">'confidence'</span>: <span class="st">'medium'</span>})

        <span class="cm"># åº•èƒŒé©° (ä¹°å…¥æ¡ä»¶ä¸¥æ ¼)</span>
        bot_sep = <span class="kw">self</span>._count_separated_divergences(<span class="st">'bottom'</span>)
        bot_zeros = <span class="kw">self</span>._count_zero_returns(<span class="st">'bottom'</span>)
        <span class="kw">if</span> len(bot_sep) >= <span class="nu">2</span> <span class="kw">and</span> len(bot_zeros) >= <span class="nu">2</span>:
            results.append({<span class="st">'type'</span>: <span class="st">'bottom_exhaustion'</span>, <span class="st">'confidence'</span>: <span class="st">'high'</span>})

        <span class="kw">return</span> results</code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : å…¶ä»–æŒ‡æ ‡ ====== -->
        <div class="page" id="code-other">
            <div class="page-title">ç¬¬äº”ç«  Â· å…¶ä»–æŒ‡æ ‡èƒŒç¦»</div>
            <div class="page-subtitle">KDJ / CCI / RSI / é‡ä»·èƒŒç¦»</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/kdj_divergence.py</span>
                    <span>KDJæŒ‡æ ‡èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">class</span> <span class="cl">KDJDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_top_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
        <span class="st">"""ä»·æ ¼åˆ›æ–°é«˜ + Kå€¼åœ¨è¶…ä¹°åŒº(>80) + Kå€¼æœªåˆ›æ–°é«˜ = KDJé¡¶èƒŒç¦»"""</span>
        price_highs = find_swing_highs(df[<span class="st">'high'</span>], order)
        <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(price_highs)):
            k_val = df[<span class="st">'K'</span>].iloc[price_highs[i]]
            <span class="kw">if</span> k_val > <span class="nu">80</span> <span class="kw">and</span> k_val < df[<span class="st">'K'</span>].iloc[price_highs[i-<span class="nu">1</span>]]:
                signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'indicator'</span>: <span class="st">'KDJ'</span>})

    <span class="kw">def</span> <span class="fn">detect_bottom_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
        <span class="st">"""ä»·æ ¼åˆ›æ–°ä½ + Kå€¼åœ¨è¶…å–åŒº(<20) + Kå€¼æœªåˆ›æ–°ä½ = KDJåº•èƒŒç¦»"""</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/cci_divergence.py Â· divergence/rsi_divergence.py</span>
                    <span>CCI & RSI èƒŒç¦»</span>
                </div>
                <pre><code><span class="cm"># CCI: å¤©çº¿+100, åœ°çº¿-100</span>
<span class="kw">class</span> <span class="cl">CCIDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_top_divergence</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·æ ¼æ–°é«˜ + CCIåœ¨+100ä»¥ä¸Š + CCIæœªæ–°é«˜"""</span>
    <span class="kw">def</span> <span class="fn">detect_spring_autumn_crosses</span>(<span class="kw">self</span>):
        <span class="st">"""CCIç©¿è¶Šå¤©çº¿+100(åšå¤š) / è·Œç ´åœ°çº¿-100(åšç©º)"""</span>

<span class="cm"># RSI: è¶…ä¹°>80, è¶…å–<20</span>
<span class="kw">class</span> <span class="cl">RSIDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_top_divergence</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·æ ¼æ–°é«˜ + RSI>80 + RSIæœªæ–°é«˜"""</span>
    <span class="kw">def</span> <span class="fn">detect_bottom_divergence</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·æ ¼æ–°ä½ + RSI<20 + RSIæœªæ–°ä½"""</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/volume_price_divergence.py</span>
                    <span>é‡ä»·èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">class</span> <span class="cl">VolumePriceDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_price_up_volume_down</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·å‡é‡å‡: ä»·æ ¼ä¸Šæ¶¨ä½†æˆäº¤é‡ä¸‹é™, ä¸Šæ¶¨è¶‹åŠ¿å¯èƒ½è¡°ç«­"""</span>
        <span class="cm"># æ¯”è¾ƒç›¸é‚»ä¸Šæ¶¨æ®µçš„æˆäº¤é‡: åæ®µé‡ < å‰æ®µé‡</span>

    <span class="kw">def</span> <span class="fn">detect_price_down_volume_up</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·è·Œé‡å¢: ä»·æ ¼ä¸‹è·Œä½†æˆäº¤é‡å¢åŠ , å¯èƒ½æ˜¯ææ…ŒæŠ›å”®"""</span>

    <span class="kw">def</span> <span class="fn">detect_ground_volume</span>(<span class="kw">self</span>):
        <span class="st">"""åœ°é‡åœ°ä»·: æˆäº¤é‡æä½+ä»·æ ¼ä½ä½, å¯èƒ½æ˜¯åº•éƒ¨ä¿¡å·
        é‡ < è¿‘æœŸå‡é‡çš„30% -> åœ°é‡"""</span></code></pre>
            </div>
        </div>

        <!-- ====== å›æµ‹æ‘˜è¦ ====== -->
        <div class="page" id="backtest-summary">
            <div class="page-title">ETH/USDT å›æµ‹æ‘˜è¦</div>
            <div class="page-subtitle">10åˆ†é’ŸKçº¿ Â· å¸å®‰ç°è´§ Â· èƒŒç¦»/èƒŒé©°ç­–ç•¥</div>

            <div id="summary-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½å›æµ‹æ•°æ®...
            </div>

            <div id="summary-content" style="display:none;">
                <div class="stats-grid" id="stats-grid"></div>

                <div class="card">
                    <div class="card-title">ç­–ç•¥è¯´æ˜</div>
                    <div class="principle-grid">
                        <div class="principle-card sell">
                            <h3>å–å‡ºä¿¡å·</h3>
                            <p>
                                â€¢ ç»¼åˆé¡¶èƒŒç¦»è¯„åˆ† â‰¥ 45<br>
                                â€¢ èƒŒé©°å–å‡ºä¿¡å· (æœ€é«˜ä¼˜å…ˆçº§)<br>
                                â€¢ æ­¢æŸ: -5% / æ­¢ç›ˆ: +8%<br>
                                â€¢ éµå¾ª "å–ç‚¹ç”¨èƒŒç¦», å®æ—©å‹¿æ™š"
                            </p>
                        </div>
                        <div class="principle-card buy">
                            <h3>ä¹°å…¥ä¿¡å·</h3>
                            <p>
                                â€¢ ç»¼åˆåº•èƒŒç¦»è¯„åˆ† â‰¥ 65<br>
                                â€¢ èƒŒé©°ä¹°å…¥ä¿¡å· (æœ€é«˜ä¼˜å…ˆçº§)<br>
                                â€¢ å†·å´æœŸ: 30æ ¹Kçº¿ (5å°æ—¶)<br>
                                â€¢ éµå¾ª "ä¹°ç‚¹ç”¨èƒŒé©°, å®è¿Ÿå‹¿æ—©"
                            </p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>èµ„äº§æ›²çº¿</h3>
                        <span style="font-size:12px;color:var(--text-muted);">è“çº¿=ç­–ç•¥å‡€å€¼ | åŸºå‡†=ETHä¹°å…¥æŒæœ‰</span>
                    </div>
                    <div id="equity-chart"></div>
                </div>
            </div>
        </div>

        <!-- ====== Kçº¿å›¾ ====== -->
        <div class="page" id="backtest-chart">
            <div class="page-title">Kçº¿å›¾ä¸äº¤æ˜“ä¿¡å·</div>
            <div class="page-subtitle">ETH/USDT 10åˆ†é’ŸKçº¿ Â· ä¹°å–ç‚¹æ ‡æ³¨</div>

            <div id="chart-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...
            </div>

            <div id="chart-content" style="display:none;">
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>ETH/USDT Â· 10åˆ†é’Ÿ</h3>
                    </div>
                    <div id="kline-chart"></div>
                </div>
            </div>
        </div>

        <!-- ====== äº¤æ˜“æ˜ç»† ====== -->
        <div class="page" id="backtest-trades">
            <div class="page-title">äº¤æ˜“æ˜ç»†</div>
            <div class="page-subtitle">å®Œæ•´äº¤æ˜“è®°å½• (ä¹°å…¥-å–å‡ºé…å¯¹)</div>

            <div id="trades-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½äº¤æ˜“æ•°æ®...
            </div>

            <div id="trades-content" style="display:none;">
                <div class="stats-grid" id="trade-stats"></div>
                <div class="card">
                    <div class="card-title">äº¤æ˜“è®°å½•</div>
                    <div class="trade-table-wrap">
                        <table id="trades-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ä¹°å…¥æ—¶é—´</th>
                                    <th>ä¹°å…¥ä»·</th>
                                    <th>å–å‡ºæ—¶é—´</th>
                                    <th>å–å‡ºä»·</th>
                                    <th>ç›ˆäº(USDT)</th>
                                    <th>ç›ˆäº%</th>
                                    <th>ä¹°å…¥åŸå› </th>
                                    <th>å–å‡ºåŸå› </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
    // ===== Navigation =====
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            item.classList.add('active');
            const pageId = item.dataset.page;
            document.getElementById(pageId).classList.add('active');

            // Lazy load backtest data
            if (pageId.startsWith('backtest') && !window._backtestLoaded) {
                loadBacktestData();
            }
        });
    });

    // ===== Backtest Data =====
    let btData = null;

    async function loadBacktestData() {
        if (window._backtestLoaded) return;
        try {
            const resp = await fetch('/api/backtest');
            if (!resp.ok) throw new Error('No data');
            btData = await resp.json();
            window._backtestLoaded = true;
            renderSummary();
            renderEquityChart();
            renderKlineChart();
            renderTrades();
        } catch (e) {
            document.querySelectorAll('.loading').forEach(el => {
                el.innerHTML = '<span style="color:var(--accent-red)">æœªæ‰¾åˆ°å›æµ‹æ•°æ®ã€‚è¯·å…ˆè¿è¡Œ: python backtest.py</span>';
            });
        }
    }

    function renderSummary() {
        const s = btData.summary;
        document.getElementById('summary-loading').style.display = 'none';
        document.getElementById('summary-content').style.display = 'block';

        const statsHtml = [
            {label: 'ç­–ç•¥æ”¶ç›Š', value: s.total_return + '%', cls: s.total_return >= 0 ? 'positive' : 'negative'},
            {label: 'ä¹°å…¥æŒæœ‰æ”¶ç›Š', value: s.buy_hold_return + '%', cls: s.buy_hold_return >= 0 ? 'positive' : 'negative'},
            {label: 'æœ€ç»ˆèµ„é‡‘', value: '$' + s.final_equity.toLocaleString(), cls: s.final_equity >= s.initial_capital ? 'positive' : 'negative'},
            {label: 'æœ€å¤§å›æ’¤', value: s.max_drawdown + '%', cls: 'negative'},
            {label: 'äº¤æ˜“æ¬¡æ•°', value: s.total_trades, cls: ''},
            {label: 'èƒœç‡', value: s.win_rate + '%', cls: s.win_rate >= 50 ? 'positive' : 'negative', note: s.win_count + 'èƒœ / ' + s.lose_count + 'è´Ÿ'},
            {label: 'å¹³å‡ç›ˆåˆ©', value: '+' + s.avg_win_pct + '%', cls: 'positive'},
            {label: 'å¹³å‡äºæŸ', value: s.avg_loss_pct + '%', cls: 'negative'},
            {label: 'Sharpeæ¯”ç‡', value: s.sharpe_ratio, cls: s.sharpe_ratio >= 0 ? 'positive' : 'negative'},
            {label: 'å›æµ‹å¤©æ•°', value: s.total_days + 'å¤©', cls: ''},
        ].map(item => `
            <div class="stat-card">
                <div class="stat-label">${item.label}</div>
                <div class="stat-value ${item.cls}">${item.value}</div>
                ${item.note ? '<div class="stat-note">' + item.note + '</div>' : ''}
            </div>
        `).join('');
        document.getElementById('stats-grid').innerHTML = statsHtml;
    }

    function renderEquityChart() {
        const container = document.getElementById('equity-chart');
        if (!btData || !btData.equity_curve || !btData.equity_curve.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 300,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const equitySeries = chart.addLineSeries({
            color: '#4a9eff', lineWidth: 2, title: 'ç­–ç•¥å‡€å€¼',
        });

        const eqData = btData.equity_curve.map(e => ({
            time: Math.floor(new Date(e.date).getTime() / 1000),
            value: e.equity,
        }));
        equitySeries.setData(eqData);

        // Buy & hold baseline
        if (btData.kline_data && btData.kline_data.length > 0) {
            const baseline = chart.addLineSeries({
                color: '#5c6078', lineWidth: 1, lineStyle: 2, title: 'ä¹°å…¥æŒæœ‰',
            });
            const firstPrice = btData.kline_data[0].close;
            const initCap = btData.summary.initial_capital;
            const bhData = btData.kline_data.map(k => ({
                time: Math.floor(new Date(k.date).getTime() / 1000),
                value: initCap * (k.close / firstPrice),
            }));
            baseline.setData(bhData);
        }

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderKlineChart() {
        const container = document.getElementById('kline-chart');
        document.getElementById('chart-loading').style.display = 'none';
        document.getElementById('chart-content').style.display = 'block';

        if (!btData || !btData.kline_data || !btData.kline_data.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 400,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#00d68f', downColor: '#ff4d6a',
            borderUpColor: '#00d68f', borderDownColor: '#ff4d6a',
            wickUpColor: '#00d68f', wickDownColor: '#ff4d6a',
        });

        const kData = btData.kline_data.map(k => ({
            time: Math.floor(new Date(k.date).getTime() / 1000),
            open: k.open, high: k.high, low: k.low, close: k.close,
        }));
        candleSeries.setData(kData);

        // Add markers for signals
        if (btData.signals && btData.signals.length > 0) {
            const markers = btData.signals.map(s => ({
                time: Math.floor(new Date(s.date).getTime() / 1000),
                position: s.signal === 'BUY' ? 'belowBar' : 'aboveBar',
                color: s.signal === 'BUY' ? '#00d68f' : '#ff4d6a',
                shape: s.signal === 'BUY' ? 'arrowUp' : 'arrowDown',
                text: s.signal === 'BUY' ? 'B' : 'S',
            }));
            candleSeries.setMarkers(markers);
        }

        // Volume
        const volSeries = chart.addHistogramSeries({
            priceFormat: { type: 'volume' },
            priceScaleId: 'vol',
        });
        chart.priceScale('vol').applyOptions({
            scaleMargins: { top: 0.85, bottom: 0 },
        });
        const vData = btData.kline_data.map(k => ({
            time: Math.floor(new Date(k.date).getTime() / 1000),
            value: k.volume,
            color: k.close >= k.open ? 'rgba(0,214,143,0.3)' : 'rgba(255,77,106,0.3)',
        }));
        volSeries.setData(vData);

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderTrades() {
        document.getElementById('trades-loading').style.display = 'none';
        document.getElementById('trades-content').style.display = 'block';

        if (!btData || !btData.completed_trades) return;

        const trades = btData.completed_trades;
        const totalPnl = trades.reduce((s, t) => s + t.pnl, 0);
        const bestTrade = trades.reduce((b, t) => t.pnl_pct > b.pnl_pct ? t : b, trades[0] || {pnl_pct:0});
        const worstTrade = trades.reduce((w, t) => t.pnl_pct < w.pnl_pct ? t : w, trades[0] || {pnl_pct:0});

        document.getElementById('trade-stats').innerHTML = [
            {label: 'æ€»ç›ˆäº', value: '$' + totalPnl.toFixed(2), cls: totalPnl >= 0 ? 'positive' : 'negative'},
            {label: 'æœ€ä½³äº¤æ˜“', value: '+' + (bestTrade.pnl_pct||0).toFixed(2) + '%', cls: 'positive'},
            {label: 'æœ€å·®äº¤æ˜“', value: (worstTrade.pnl_pct||0).toFixed(2) + '%', cls: 'negative'},
            {label: 'å®Œæˆäº¤æ˜“', value: trades.length, cls: ''},
        ].map(item => `
            <div class="stat-card">
                <div class="stat-label">${item.label}</div>
                <div class="stat-value ${item.cls}">${item.value}</div>
            </div>
        `).join('');

        const tbody = document.querySelector('#trades-table tbody');
        tbody.innerHTML = trades.map((t, i) => `
            <tr>
                <td>${i + 1}</td>
                <td>${formatDate(t.buy_date)}</td>
                <td>$${t.buy_price.toFixed(2)}</td>
                <td>${formatDate(t.sell_date)}</td>
                <td>$${t.sell_price.toFixed(2)}</td>
                <td class="${t.pnl >= 0 ? 'pnl-pos' : 'pnl-neg'}">${t.pnl >= 0 ? '+' : ''}${t.pnl.toFixed(2)}</td>
                <td class="${t.pnl_pct >= 0 ? 'pnl-pos' : 'pnl-neg'}">${t.pnl_pct >= 0 ? '+' : ''}${t.pnl_pct.toFixed(2)}%</td>
                <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.buy_reason||''}">${t.buy_reason || '-'}</td>
                <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.sell_reason||''}">${t.sell_reason || '-'}</td>
            </tr>
        `).join('');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    </script>
</body>
</html>
