<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒŒç¦»æŠ€æœ¯åˆ†æ - ä»£ç å®ç°ä¸å›æµ‹å±•ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d29;
            --bg-card: #1e2130;
            --bg-hover: #262a3d;
            --text-primary: #e1e4ea;
            --text-secondary: #8b8fa3;
            --text-muted: #5c6078;
            --accent-blue: #4a9eff;
            --accent-green: #00d68f;
            --accent-red: #ff4d6a;
            --accent-yellow: #ffaa00;
            --accent-purple: #a855f7;
            --border: #2a2d3e;
            --sidebar-w: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: var(--sidebar-w);
            min-width: var(--sidebar-w);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px 20px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .nav-section {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 20px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.15s;
            gap: 10px;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(74, 158, 255, 0.1);
            color: var(--accent-blue);
            border-left: 2px solid var(--accent-blue);
        }

        .nav-icon {
            width: 18px;
            text-align: center;
            font-size: 14px;
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .page {
            display: none;
            padding: 32px 40px;
            max-width: 1200px;
        }

        .page.active { display: block; }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent-blue);
        }

        .badge.green { background: rgba(0, 214, 143, 0.15); color: var(--accent-green); }
        .badge.red { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .badge.yellow { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .badge.purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.positive { color: var(--accent-green); }
        .stat-value.negative { color: var(--accent-red); }

        .stat-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Chapter Outline */
        .chapter {
            margin-bottom: 24px;
        }

        .chapter-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .chapter-num {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .chapter-num.ch1 { background: rgba(74, 158, 255, 0.15); color: var(--accent-blue); }
        .chapter-num.ch2 { background: rgba(0, 214, 143, 0.15); color: var(--accent-green); }
        .chapter-num.ch3 { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .chapter-num.ch4 { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .chapter-num.ch5 { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        .chapter-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chapter-content {
            padding-left: 48px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.8;
        }

        .chapter-content ul {
            padding-left: 18px;
        }

        .chapter-content li {
            margin-bottom: 4px;
        }

        .chapter-content .key-concept {
            color: var(--accent-blue);
            font-weight: 500;
        }

        /* Code Blocks */
        .code-section {
            margin-bottom: 24px;
        }

        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #161822;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .code-file { color: var(--accent-blue); font-weight: 500; }

        pre {
            background: #0d0f17;
            border: 1px solid var(--border);
            border-radius: 0 0 8px 8px;
            padding: 16px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        }

        code { font-family: inherit; }

        .kw { color: #c678dd; }
        .fn { color: #61afef; }
        .st { color: #98c379; }
        .cm { color: #5c6370; font-style: italic; }
        .nu { color: #d19a66; }
        .op { color: #56b6c2; }
        .cl { color: #e5c07b; }

        /* Chart Container */
        .chart-container {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .chart-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .chart-toolbar h3 {
            font-size: 14px;
            font-weight: 600;
        }

        #kline-chart { width: 100%; height: 400px; }
        #equity-chart { width: 100%; height: 300px; }

        /* Trade Table */
        .trade-table-wrap {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .pnl-pos { color: var(--accent-green); font-weight: 600; }
        .pnl-neg { color: var(--accent-red); font-weight: 600; }

        /* Principle cards */
        .principle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .principle-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .principle-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }

        .principle-card.sell::before { background: var(--accent-red); }
        .principle-card.buy::before { background: var(--accent-green); }

        .principle-card h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .principle-card p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.7;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Architecture */
        .arch-diagram {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            padding: 24px;
        }

        .arch-layer {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .arch-box {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            border: 1px solid var(--border);
        }

        .arch-box.entry { background: rgba(74, 158, 255, 0.15); color: var(--accent-blue); }
        .arch-box.data { background: rgba(0, 214, 143, 0.15); color: var(--accent-green); }
        .arch-box.core { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }
        .arch-box.analysis { background: rgba(255, 170, 0, 0.15); color: var(--accent-yellow); }
        .arch-box.out { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        .arch-arrow {
            color: var(--text-muted);
            font-size: 20px;
        }

        /* Responsive */
        /* Multi-interval bar chart */
        .bar-chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
            height: 260px;
            padding: 20px 10px 0;
        }

        .bar-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 72px;
        }

        .bar-value {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .bar-rect {
            width: 100%;
            border-radius: 4px 4px 0 0;
            min-height: 2px;
            transition: all 0.3s ease;
            position: relative;
        }

        .bar-rect:hover {
            opacity: 0.8;
            transform: scaleX(1.1);
        }

        .bar-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .bar-zero-line {
            width: 100%;
            height: 1px;
            background: var(--text-muted);
            position: relative;
        }

        /* Multi table highlight */
        #sc-table th, #sc-opt-table th {
            text-align: center;
            font-size: 11px;
            padding: 8px 10px;
            white-space: nowrap;
        }

        #sc-table td, #sc-opt-table td {
            text-align: center;
            font-size: 12px;
            padding: 8px 10px;
            white-space: nowrap;
        }

        #multi-table th {
            text-align: center;
            font-size: 11px;
            padding: 8px 6px;
            white-space: nowrap;
        }

        #multi-table td {
            text-align: center;
            font-size: 12px;
            padding: 7px 6px;
            white-space: nowrap;
        }

        #multi-table tr.best-row td {
            background: rgba(0, 214, 143, 0.05);
        }

        .cell-best {
            color: var(--accent-green) !important;
            font-weight: 700 !important;
        }

        .cell-worst {
            color: var(--accent-red) !important;
        }

        /* Conclusion */
        .conclusion-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conclusion-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .conclusion-item {
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .conclusion-item h4 {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .conclusion-item p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            margin-right: 4px;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0622a); color: #fff; }

        /* Legend for equity chart */
        .equity-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .legend-item:hover { background: var(--bg-hover); }
        .legend-item.disabled { opacity: 0.3; }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        @media (max-width: 900px) {
            .sidebar { width: 220px; min-width: 220px; }
            .page { padding: 24px 20px; }
            .principle-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .conclusion-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h1>èƒŒç¦»æŠ€æœ¯åˆ†æ</h1>
            <p>æ±Ÿå—å°éš Â· ä»£ç å®ç° & ETHå›æµ‹</p>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">æ¦‚è§ˆ</div>
            <div class="nav-item active" data-page="overview">
                <span class="nav-icon">ğŸ“–</span> ä¹¦ç±å¤§çº²
            </div>
            <div class="nav-item" data-page="architecture">
                <span class="nav-icon">ğŸ—ï¸</span> é¡¹ç›®æ¶æ„
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ä»£ç å®ç°</div>
            <div class="nav-item" data-page="code-indicators">
                <span class="nav-icon">ğŸ“Š</span> æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
            </div>
            <div class="nav-item" data-page="code-pattern">
                <span class="nav-icon">ğŸ“</span> å‡ ä½•å½¢æ€èƒŒç¦»
            </div>
            <div class="nav-item" data-page="code-macd">
                <span class="nav-icon">ğŸ“ˆ</span> MACDèƒŒç¦»
            </div>
            <div class="nav-item" data-page="code-exhaustion">
                <span class="nav-icon">âš¡</span> èƒŒç¦»ä¸èƒŒé©°
            </div>
            <div class="nav-item" data-page="code-other">
                <span class="nav-icon">ğŸ”¬</span> å…¶ä»–æŒ‡æ ‡èƒŒç¦»
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ETH/USDT å›æµ‹</div>
            <div class="nav-item" data-page="global-strategy">
                <span class="nav-icon">ğŸ†</span> å…¨å±€æœ€ä¼˜ç­–ç•¥
            </div>
            <div class="nav-item" data-page="strategy-compare">
                <span class="nav-icon">ğŸ”¬</span> ç­–ç•¥ä¼˜åŒ–å¯¹æ¯”
            </div>
            <div class="nav-item" data-page="strategy-futures">
                <span class="nav-icon">ğŸ“Š</span> åˆçº¦åšç©ºç­–ç•¥
            </div>
            <div class="nav-item" data-page="multi-compare">
                <span class="nav-icon">ğŸ“Š</span> å¤šå‘¨æœŸå¯¹æ¯”
            </div>
            <div class="nav-item" data-page="backtest-summary">
                <span class="nav-icon">ğŸ’°</span> å•å‘¨æœŸè¯¦æƒ…
            </div>
            <div class="nav-item" data-page="backtest-chart">
                <span class="nav-icon">ğŸ“‰</span> Kçº¿ä¸ä¿¡å·
            </div>
            <div class="nav-item" data-page="backtest-trades">
                <span class="nav-icon">ğŸ“‹</span> äº¤æ˜“æ˜ç»†
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">

        <!-- ====== ä¹¦ç±å¤§çº² ====== -->
        <div class="page active" id="overview">
            <div class="page-title">ã€ŠèƒŒç¦»æŠ€æœ¯åˆ†æã€‹ä¹¦ç±å¤§çº²</div>
            <div class="page-subtitle">æ±Ÿå—å°éš è‘— Â· ç†è´¢å­¦é™¢ç³»åˆ— Â· å…¨é¢è§£æèƒŒç¦»ä¸èƒŒé©°äº¤æ˜“ä½“ç³»</div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch1">ä¸€</div>
                    <div class="chapter-title">ç¬¬ä¸€ç«  Â· èƒŒç¦»æ€»è¿°</div>
                </div>
                <div class="chapter-content">
                    <p>èƒŒç¦»çš„æ ¸å¿ƒå®šä¹‰: <span class="key-concept">å°†å‰åä¸¤æ®µèµ°åŠ¿çš„ç‰¹å¾è¿›è¡Œæ¯”è¾ƒ, å‘ç°è¶‹åŠ¿è¡°ç«­ä¿¡å·</span></p>
                    <ul>
                        <li>èƒŒç¦»æ˜¯è¶‹åŠ¿è¡°ç«­çš„ä¿¡å·, ä½†ä¸ä¸€å®šé©¬ä¸Šåè½¬</li>
                        <li>å¯ä»¥"èƒŒç¦»äº†åˆèƒŒç¦»", ç›´åˆ°äº§ç”Ÿ<span class="key-concept">èƒŒé©°</span>æ‰æ˜¯æœ€ç»ˆåè½¬</li>
                        <li>èƒŒç¦»åˆ†ææ˜¯ç¡®è®¤æ€§åˆ†æ, è€Œéé¢„æµ‹æ€§åˆ†æ</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch2">äºŒ</div>
                    <div class="chapter-title">ç¬¬äºŒç«  Â· å‡ ä½•å½¢æ€èƒŒç¦»</div>
                </div>
                <div class="chapter-content">
                    <ul>
                        <li><span class="key-concept">è¶‹åŠ¿Kçº¿èƒŒç¦»</span> â€” ä¸Šæ¶¨ä¸­å‡ºç°å¤§é˜´çº¿/ä¸‹è·Œä¸­å‡ºç°å¤§é˜³çº¿, é¢„ç¤ºè¶‹åŠ¿å¯èƒ½åè½¬</li>
                        <li><span class="key-concept">è¶‹åŠ¿å¹…åº¦èƒŒç¦»</span> â€” åä¸€æ®µè¶‹åŠ¿çš„å‚ç›´å¹…åº¦å°äºå‰ä¸€æ®µ, è¯´æ˜æ¨åŠ¨åŠ›å‡å¼±</li>
                        <li><span class="key-concept">æ—¶é—´åº¦èƒŒç¦»</span> â€” åä¸€æ®µè¶‹åŠ¿æŒç»­Kçº¿æ•°å°‘äºå‰ä¸€æ®µ, æ—¶é—´ä¸Šçš„è¡°ç«­</li>
                        <li><span class="key-concept">å‡çº¿èƒŒç¦»</span> â€” ä»·æ ¼å‰§çƒˆç©¿è¶Šé•¿æœŸå‡çº¿(å‡çº¿æ–¹å‘ä¸ä»·æ ¼è¿åŠ¨æ–¹å‘ç›¸å)</li>
                        <li><span class="key-concept">å‡çº¿ç›¸äº¤é¢ç§¯èƒŒç¦»</span> â€” çŸ­æœŸä¸é•¿æœŸå‡çº¿ä¹‹é—´çš„é¢ç§¯ç¼©å°</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch3">ä¸‰</div>
                    <div class="chapter-title">ç¬¬ä¸‰ç«  Â· MACDæŠ€æœ¯æŒ‡æ ‡èƒŒç¦» (æ ¸å¿ƒç« èŠ‚)</div>
                </div>
                <div class="chapter-content">
                    <ul>
                        <li><span class="key-concept">é»„ç™½çº¿(DIF/DEA)èƒŒç¦»</span> â€” ä»·æ ¼åˆ›æ–°é«˜/ä½, DIF/DEAçº¿æœªåŒæ­¥åˆ›æ–°é«˜/ä½</li>
                        <li><span class="key-concept">å½©æŸ±çº¿é•¿åº¦èƒŒç¦»</span> â€” çº¢/ç»¿æŸ±æœ€å¤§é•¿åº¦ç¼©çŸ­
                            <ul>
                                <li><strong>å½“å †èƒŒç¦»</strong>: åŒä¸€å †æŸ±ä½“å†…åé¢çš„æŸ±å­æ¯”å‰é¢çŸ­</li>
                                <li><strong>é‚»å †èƒŒç¦»</strong>: ç›¸é‚»ä¸¤å †æŸ±ä½“ä¸­åå †æœ€å¤§æŸ±å­æ¯”å‰å †çŸ­</li>
                                <li><strong>éš”å †èƒŒç¦»</strong>: éš”å¼€çš„ä¸¤å †æŸ±ä½“ä¸­åå †ä¸å¦‚å‰å †(æœ€é‡è¦!)</li>
                            </ul>
                        </li>
                        <li><span class="key-concept">å½©æŸ±çº¿é¢ç§¯èƒŒç¦»</span> â€” æŸ±ä½“å †é¢ç§¯ç¼©å° (é‚»å †/éš”å †)</li>
                        <li><span class="key-concept">é»„ç™½çº¿ç›¸äº¤é¢ç§¯èƒŒç¦»</span> â€” DIFä¸DEAå›´åˆçš„é¢ç§¯ç¼©å°</li>
                        <li><span class="key-concept">é‡‘å‰/æ­»å‰</span> â€” DIFä¸Šç©¿/ä¸‹ç©¿DEAçš„äº¤å‰ä¿¡å·</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch4">å››</div>
                    <div class="chapter-title">ç¬¬å››ç«  Â· èƒŒç¦»ä¸èƒŒé©° (æ ¸å¿ƒç­–ç•¥)</div>
                </div>
                <div class="chapter-content">
                    <div class="principle-grid" style="padding-left:0; margin-top:12px;">
                        <div class="principle-card sell">
                            <h3>å–ç‚¹ç”¨èƒŒç¦» (å®æ—©å‹¿æ™š)</h3>
                            <p>
                                æ»¡è¶³ä»»ä¸€æ¡ä»¶å³è€ƒè™‘å–å‡º:<br>
                                â‘  MACD DIFè¿œç¦»é›¶è½´åè¿”å›, é‡æ–°ä¸Šå‡ä¸åˆ›æ–°é«˜ + å·²æœ‰ä¸€æ¬¡éš”å †èƒŒç¦»<br>
                                â‘¡ è™½æœªè¿”å›é›¶è½´, ä½†å·²æœ‰ä¸¤æ¬¡ä»¥ä¸Šéš”å †èƒŒç¦»
                            </p>
                        </div>
                        <div class="principle-card buy">
                            <h3>ä¹°ç‚¹ç”¨èƒŒé©° (å®è¿Ÿå‹¿æ—©)</h3>
                            <p>
                                éœ€<strong>åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</strong>æ‰è€ƒè™‘ä¹°å…¥:<br>
                                â‘  äº§ç”Ÿäº†ä¸¤æ¬¡ä»¥ä¸Šéš”å †èƒŒç¦»<br>
                                â‘¡ MACD DIFçº¿ä¸¤æ¬¡è¿”å›é›¶è½´åå†åº¦åº•èƒŒç¦»
                            </p>
                        </div>
                    </div>
                    <ul>
                        <li><span class="key-concept">èƒŒé©°</span> = è¶‹åŠ¿çš„æœ€åä¸€æ¬¡èƒŒç¦», ä¸€æ—¦äº§ç”Ÿé©¬ä¸Šåè½¬</li>
                        <li>èƒŒç¦»å¯ä»¥åå¤, ä½†èƒŒé©°åªå‡ºç°ä¸€æ¬¡</li>
                        <li>èƒŒé©°æ˜¯èƒŒç¦»é‡ç§¯ç´¯åˆ°è´¨å˜çš„é£è·ƒ</li>
                    </ul>
                </div>
            </div>

            <div class="chapter">
                <div class="chapter-header">
                    <div class="chapter-num ch5">äº”</div>
                    <div class="chapter-title">ç¬¬äº”ç«  Â· å…¶ä»–èƒŒç¦»æ–¹æ³•</div>
                </div>
                <div class="chapter-content">
                    <ul>
                        <li><span class="key-concept">KDJæŒ‡æ ‡èƒŒç¦»</span> â€” ä»·æ ¼æ–°é«˜/ä½è€ŒKDJçš„K/Dçº¿æœªåŒæ­¥, å°¤å…¶åœ¨è¶…ä¹°(>80)/è¶…å–(<20)åŒºåŸŸ</li>
                        <li><span class="key-concept">CCIæŒ‡æ ‡èƒŒç¦»</span> â€” ä»·æ ¼æ–°é«˜/ä½è€ŒCCIæœªåŒæ­¥, CCIè¶Šè¿‡+100(å¤©çº¿)æˆ–è·Œç ´-100(åœ°çº¿)ä¸ºå¼ºä¿¡å·</li>
                        <li><span class="key-concept">RSIæŒ‡æ ‡èƒŒç¦»</span> â€” ä»·æ ¼æ–°é«˜/ä½è€ŒRSIæœªåŒæ­¥, å…³æ³¨RSIåœ¨80ä»¥ä¸Š(è¶…ä¹°)æˆ–20ä»¥ä¸‹(è¶…å–)çš„åŒºåŸŸ</li>
                        <li><span class="key-concept">é‡ä»·èƒŒç¦»</span> â€” ä»·å‡é‡å‡(ä¸Šæ¶¨ä¹åŠ›)ã€ä»·è·Œé‡å¢(ææ…ŒæŠ›å”®)ã€åœ°é‡åœ°ä»·(æ½œåœ¨åº•éƒ¨)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ====== é¡¹ç›®æ¶æ„ ====== -->
        <div class="page" id="architecture">
            <div class="page-title">é¡¹ç›®æ¶æ„</div>
            <div class="page-subtitle">åŸºäº Python å®ç°çš„å®Œæ•´èƒŒç¦»åˆ†æç³»ç»Ÿ</div>

            <div class="card">
                <div class="card-title">ç³»ç»Ÿæ¶æ„å›¾</div>
                <div class="arch-diagram">
                    <div class="arch-layer">
                        <div class="arch-box entry">main.py<br><small>å‘½ä»¤è¡Œå…¥å£</small></div>
                        <div class="arch-box entry">app.py<br><small>Web å±•ç¤º</small></div>
                        <div class="arch-box entry">backtest.py<br><small>å›æµ‹å¼•æ“</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box analysis">ComprehensiveAnalyzer<br><small>ç»¼åˆåˆ†æå™¨</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box core">PatternDiv<br><small>å½¢æ€èƒŒç¦»</small></div>
                        <div class="arch-box core">MACDDiv<br><small>MACDèƒŒç¦»</small></div>
                        <div class="arch-box core">Exhaustion<br><small>èƒŒé©°åˆ†æ</small></div>
                        <div class="arch-box core">KDJ/CCI/RSI<br><small>æŒ‡æ ‡èƒŒç¦»</small></div>
                        <div class="arch-box core">VolPrice<br><small>é‡ä»·èƒŒç¦»</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box data">indicators.py<br><small>æŠ€æœ¯æŒ‡æ ‡è®¡ç®—</small></div>
                        <div class="arch-box data">config.py<br><small>å‚æ•°é…ç½®</small></div>
                    </div>
                    <div class="arch-arrow">â†“</div>
                    <div class="arch-layer">
                        <div class="arch-box out">binance_fetcher.py<br><small>å¸å®‰æ•°æ®è·å–</small></div>
                        <div class="arch-box out">data_fetcher.py<br><small>Aè‚¡/CSVæ•°æ®</small></div>
                        <div class="arch-box out">visualization.py<br><small>å›¾è¡¨å¯è§†åŒ–</small></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">æ–‡ä»¶ç»“æ„</div>
                <pre><code><span class="st">macd-analysis-claude/</span>
â”œâ”€â”€ <span class="fn">config.py</span>             <span class="cm"># å…¨å±€å‚æ•°é…ç½® (MACD/KDJ/CCI/RSIå‚æ•°, èƒŒç¦»é˜ˆå€¼)</span>
â”œâ”€â”€ <span class="fn">indicators.py</span>         <span class="cm"># æŠ€æœ¯æŒ‡æ ‡: SMA, EMA, MACD, KDJ, CCI, RSI</span>
â”œâ”€â”€ <span class="fn">binance_fetcher.py</span>    <span class="cm"># å¸å®‰APIæ•°æ®è·å– (10åˆ†é’ŸKçº¿)</span>
â”œâ”€â”€ <span class="fn">data_fetcher.py</span>       <span class="cm"># Aè‚¡/CSV/æ¨¡æ‹Ÿæ•°æ®è·å–</span>
â”œâ”€â”€ <span class="fn">backtest.py</span>           <span class="cm"># å›æµ‹å¼•æ“ (æ­¢æŸæ­¢ç›ˆ/å†·å´æœŸ/ä¿¡å·è¿‡æ»¤)</span>
â”œâ”€â”€ <span class="fn">visualization.py</span>      <span class="cm"># Matplotlib å¤šé¢æ¿å›¾è¡¨</span>
â”œâ”€â”€ <span class="fn">main.py</span>               <span class="cm"># å‘½ä»¤è¡Œä¸»ç¨‹åº</span>
â”œâ”€â”€ <span class="fn">app.py</span>                <span class="cm"># Flask Web åº”ç”¨</span>
â”œâ”€â”€ <span class="st">divergence/</span>           <span class="cm"># èƒŒç¦»æ£€æµ‹æ¨¡å—åŒ…</span>
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ <span class="fn">pattern_divergence.py</span>    <span class="cm"># ç¬¬äºŒç« : å‡ ä½•å½¢æ€èƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">macd_divergence.py</span>       <span class="cm"># ç¬¬ä¸‰ç« : MACDèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">exhaustion.py</span>            <span class="cm"># ç¬¬å››ç« : èƒŒç¦»ä¸èƒŒé©°</span>
â”‚   â”œâ”€â”€ <span class="fn">kdj_divergence.py</span>        <span class="cm"># ç¬¬äº”ç« : KDJèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">cci_divergence.py</span>        <span class="cm"># ç¬¬äº”ç« : CCIèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">rsi_divergence.py</span>        <span class="cm"># ç¬¬äº”ç« : RSIèƒŒç¦»</span>
â”‚   â”œâ”€â”€ <span class="fn">volume_price_divergence.py</span>  <span class="cm"># ç¬¬äº”ç« : é‡ä»·èƒŒç¦»</span>
â”‚   â””â”€â”€ <span class="fn">comprehensive.py</span>         <span class="cm"># ç»¼åˆåˆ†æ & è¯„åˆ†</span>
â””â”€â”€ <span class="st">templates/</span>
    â””â”€â”€ index.html        <span class="cm"># Web å±•ç¤ºé¡µé¢</span></code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : æŠ€æœ¯æŒ‡æ ‡ ====== -->
        <div class="page" id="code-indicators">
            <div class="page-title">æŠ€æœ¯æŒ‡æ ‡è®¡ç®—</div>
            <div class="page-subtitle">indicators.py Â· æ‰€æœ‰åˆ†æçš„åŸºç¡€</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">indicators.py</span>
                    <span>MACD è®¡ç®—</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">calc_macd</span>(close: pd.Series, fast=<span class="nu">12</span>, slow=<span class="nu">26</span>, signal=<span class="nu">9</span>) -> pd.DataFrame:
    <span class="st">"""è®¡ç®—MACDæŒ‡æ ‡: DIF, DEA, MACD_BAR"""</span>
    ema_fast = close.ewm(span=fast, adjust=<span class="kw">False</span>).mean()
    ema_slow = close.ewm(span=slow, adjust=<span class="kw">False</span>).mean()
    dif = ema_fast - ema_slow                    <span class="cm"># å¿«çº¿-æ…¢çº¿ = DIF(ç™½çº¿)</span>
    dea = dif.ewm(span=signal, adjust=<span class="kw">False</span>).mean()  <span class="cm"># DIFçš„EMA = DEA(é»„çº¿)</span>
    bar = <span class="nu">2</span> * (dif - dea)                       <span class="cm"># çº¢ç»¿æŸ± = 2*(DIF-DEA)</span>
    <span class="kw">return</span> pd.DataFrame({<span class="st">'DIF'</span>: dif, <span class="st">'DEA'</span>: dea, <span class="st">'MACD_BAR'</span>: bar})</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">indicators.py</span>
                    <span>KDJ / CCI / RSI</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">calc_kdj</span>(high, low, close, n=<span class="nu">9</span>, m1=<span class="nu">3</span>, m2=<span class="nu">3</span>):
    <span class="st">"""KDJéšæœºæŒ‡æ ‡: RSV -> K -> D -> J"""</span>
    lowest = low.rolling(n).min()
    highest = high.rolling(n).max()
    rsv = (close - lowest) / (highest - lowest) * <span class="nu">100</span>
    k = rsv.ewm(com=m1-<span class="nu">1</span>, adjust=<span class="kw">False</span>).mean()
    d = k.ewm(com=m2-<span class="nu">1</span>, adjust=<span class="kw">False</span>).mean()
    j = <span class="nu">3</span> * k - <span class="nu">2</span> * d
    <span class="kw">return</span> pd.DataFrame({<span class="st">'K'</span>: k, <span class="st">'D'</span>: d, <span class="st">'J'</span>: j})

<span class="kw">def</span> <span class="fn">calc_cci</span>(high, low, close, n=<span class="nu">14</span>):
    <span class="st">"""CCIé¡ºåŠ¿æŒ‡æ ‡: TPçš„åç¦»åº¦/å¹³å‡åå·®"""</span>
    tp = (high + low + close) / <span class="nu">3</span>
    ma = tp.rolling(n).mean()
    md = tp.rolling(n).apply(<span class="kw">lambda</span> x: np.abs(x - x.mean()).mean())
    <span class="kw">return</span> (tp - ma) / (<span class="nu">0.015</span> * md)

<span class="kw">def</span> <span class="fn">calc_rsi</span>(close, period=<span class="nu">6</span>):
    <span class="st">"""RSIç›¸å¯¹å¼ºå¼±æŒ‡æ ‡: æ¶¨å¹…å‡å€¼/(æ¶¨å¹…å‡å€¼+è·Œå¹…å‡å€¼)*100"""</span>
    delta = close.diff()
    gain = delta.clip(lower=<span class="nu">0</span>).ewm(alpha=<span class="nu">1</span>/period, adjust=<span class="kw">False</span>).mean()
    loss = (-delta.clip(upper=<span class="nu">0</span>)).ewm(alpha=<span class="nu">1</span>/period, adjust=<span class="kw">False</span>).mean()
    <span class="kw">return</span> <span class="nu">100</span> - <span class="nu">100</span> / (<span class="nu">1</span> + gain / loss)</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">indicators.py</span>
                    <span>è¾…åŠ©å‡½æ•°: æ³¢å³°æ³¢è°· / è¶‹åŠ¿åˆ†æ®µ / MACDæŸ±å †è¯†åˆ«</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">find_swing_highs</span>(series, order=<span class="nu">5</span>):
    <span class="st">"""å¯»æ‰¾å±€éƒ¨é«˜ç‚¹(æ³¢å³°), order=å‰åå„5æ ¹Kçº¿èŒƒå›´"""</span>
    highs = []
    <span class="kw">for</span> i <span class="kw">in</span> range(order, len(series) - order):
        <span class="kw">if</span> all(series.iloc[i] >= series.iloc[i-j] <span class="kw">for</span> j <span class="kw">in</span> range(<span class="nu">1</span>, order+<span class="nu">1</span>)) \
           <span class="kw">and</span> all(series.iloc[i] >= series.iloc[i+j] <span class="kw">for</span> j <span class="kw">in</span> range(<span class="nu">1</span>, order+<span class="nu">1</span>)):
            highs.append(i)
    <span class="kw">return</span> highs

<span class="kw">def</span> <span class="fn">identify_bar_groups</span>(bar: pd.Series):
    <span class="st">"""è¯†åˆ«MACDæŸ±å †: è¿ç»­çº¢æŸ±(>0)æˆ–ç»¿æŸ±(<0)ä¸ºä¸€å †"""</span>
    groups = []
    current_sign = <span class="kw">None</span>
    start_idx = <span class="nu">0</span>
    <span class="kw">for</span> i, v <span class="kw">in</span> enumerate(bar):
        sign = <span class="st">'red'</span> <span class="kw">if</span> v >= <span class="nu">0</span> <span class="kw">else</span> <span class="st">'green'</span>
        <span class="kw">if</span> sign != current_sign:
            <span class="kw">if</span> current_sign <span class="kw">is not None</span>:
                groups.append({<span class="st">'type'</span>: current_sign, <span class="st">'start'</span>: start_idx, <span class="st">'end'</span>: i-<span class="nu">1</span>})
            current_sign = sign
            start_idx = i
    groups.append({<span class="st">'type'</span>: current_sign, <span class="st">'start'</span>: start_idx, <span class="st">'end'</span>: len(bar)-<span class="nu">1</span>})
    <span class="kw">return</span> groups</code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : å‡ ä½•å½¢æ€èƒŒç¦» ====== -->
        <div class="page" id="code-pattern">
            <div class="page-title">ç¬¬äºŒç«  Â· å‡ ä½•å½¢æ€èƒŒç¦»</div>
            <div class="page-subtitle">pattern_divergence.py Â· 5ç§å½¢æ€èƒŒç¦»æ£€æµ‹</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/pattern_divergence.py</span>
                    <span>è¶‹åŠ¿Kçº¿èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_kline_divergence</span>(<span class="kw">self</span>, lookback=<span class="nu">20</span>, body_ratio=<span class="nu">0.02</span>):
    <span class="st">"""æ£€æµ‹è¶‹åŠ¿ä¸­å‡ºç°çš„åå‘å¤§Kçº¿
    ä¸Šæ¶¨è¶‹åŠ¿ä¸­çš„å¤§é˜´çº¿(å®ä½“>=2%), æˆ–ä¸‹è·Œè¶‹åŠ¿ä¸­çš„å¤§é˜³çº¿"""</span>
    signals = []
    <span class="kw">for</span> i <span class="kw">in</span> range(lookback, len(df)):
        body = abs(df[<span class="st">'close'</span>].iloc[i] - df[<span class="st">'open'</span>].iloc[i])
        body_pct = body / df[<span class="st">'open'</span>].iloc[i]
        <span class="kw">if</span> body_pct < body_ratio:
            <span class="kw">continue</span>
        <span class="cm"># åˆ¤æ–­è¿‘æœŸè¶‹åŠ¿æ–¹å‘ (ç”¨MAæ–œç‡)</span>
        trend = df[<span class="st">'close'</span>].iloc[i-lookback:i].mean() - df[<span class="st">'close'</span>].iloc[i-lookback]
        is_bearish = df[<span class="st">'close'</span>].iloc[i] < df[<span class="st">'open'</span>].iloc[i]
        <span class="kw">if</span> trend > <span class="nu">0</span> <span class="kw">and</span> is_bearish:   <span class="cm"># ä¸Šæ¶¨ä¸­å¤§é˜´çº¿</span>
            signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'idx'</span>: i, <span class="st">'severity'</span>: body_pct})
        <span class="kw">elif</span> trend < <span class="nu">0</span> <span class="kw">and not</span> is_bearish:  <span class="cm"># ä¸‹è·Œä¸­å¤§é˜³çº¿</span>
            signals.append({<span class="st">'type'</span>: <span class="st">'bottom'</span>, <span class="st">'idx'</span>: i})
    <span class="kw">return</span> signals</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/pattern_divergence.py</span>
                    <span>è¶‹åŠ¿å¹…åº¦ & æ—¶é—´åº¦èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_amplitude_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>, shrink_ratio=<span class="nu">0.7</span>):
    <span class="st">"""æ£€æµ‹è¶‹åŠ¿å¹…åº¦è¡°å‡: åä¸€æ®µæ¶¨/è·Œå¹… < å‰ä¸€æ®µ Ã— shrink_ratio"""</span>
    up_segs, down_segs = identify_trend_segments(df, order)
    signals = []
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(up_segs)):
        prev_amp = up_segs[i-<span class="nu">1</span>][<span class="st">'amplitude'</span>]
        curr_amp = up_segs[i][<span class="st">'amplitude'</span>]
        <span class="kw">if</span> curr_amp < prev_amp * shrink_ratio:
            signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'ratio'</span>: curr_amp/prev_amp})
    <span class="kw">return</span> signals

<span class="kw">def</span> <span class="fn">detect_time_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>, shrink_ratio=<span class="nu">0.7</span>):
    <span class="st">"""æ£€æµ‹æ—¶é—´åº¦è¡°å‡: åä¸€æ®µæŒç»­Kçº¿æ•° < å‰ä¸€æ®µ Ã— shrink_ratio"""</span>
    <span class="cm"># é€»è¾‘ç±»ä¼¼å¹…åº¦èƒŒç¦», æ¯”è¾ƒ segment['duration'] å³Kçº¿æ•°</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/pattern_divergence.py</span>
                    <span>å‡çº¿ç›¸äº¤é¢ç§¯èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_ma_area_divergence</span>(<span class="kw">self</span>, short_period=<span class="nu">5</span>, long_period=<span class="nu">30</span>):
    <span class="st">"""çŸ­æœŸå‡çº¿ä¸é•¿æœŸå‡çº¿ä¹‹é—´çš„é¢ç§¯é€æ¸ç¼©å° -> è¶‹åŠ¿å‡å¼±"""</span>
    ma_short = df[<span class="st">'close'</span>].rolling(short_period).mean()
    ma_long  = df[<span class="st">'close'</span>].rolling(long_period).mean()
    diff = ma_short - ma_long           <span class="cm"># MAå·®å€¼åºåˆ—</span>
    <span class="cm"># å°†è¿ç»­æ­£å€¼/è´Ÿå€¼åŒºé—´è¯†åˆ«ä¸ºä¸€ä¸ª"é¢ç§¯æ®µ"</span>
    <span class="cm"># æ¯”è¾ƒç›¸é‚»åŒå‘é¢ç§¯æ®µ: åæ®µé¢ç§¯ < å‰æ®µé¢ç§¯ Ã— shrink_ratio</span></code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : MACDèƒŒç¦» ====== -->
        <div class="page" id="code-macd">
            <div class="page-title">ç¬¬ä¸‰ç«  Â· MACD æŠ€æœ¯æŒ‡æ ‡èƒŒç¦»</div>
            <div class="page-subtitle">macd_divergence.py Â· ä¹¦ä¸­æœ€æ ¸å¿ƒçš„èƒŒç¦»æ£€æµ‹</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/macd_divergence.py</span>
                    <span>é»„ç™½çº¿(DIF/DEA)èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_dif_dea_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
    <span class="st">"""ä»·æ ¼åˆ›æ–°é«˜ä½†DIF/DEAæœªåˆ›æ–°é«˜ = é¡¶èƒŒç¦»
    ä»·æ ¼åˆ›æ–°ä½ä½†DIF/DEAæœªåˆ›æ–°ä½ = åº•èƒŒç¦»"""</span>
    price_highs = find_swing_highs(df[<span class="st">'high'</span>], order)
    dif_at_highs = [df[<span class="st">'DIF'</span>].iloc[h] <span class="kw">for</span> h <span class="kw">in</span> price_highs]

    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(price_highs)):
        <span class="cm"># ä»·æ ¼æ–°é«˜ä½†DIFæœªæ–°é«˜ -> é¡¶èƒŒç¦»</span>
        <span class="kw">if</span> df[<span class="st">'high'</span>].iloc[price_highs[i]] > df[<span class="st">'high'</span>].iloc[price_highs[i-<span class="nu">1</span>]] \
           <span class="kw">and</span> dif_at_highs[i] < dif_at_highs[i-<span class="nu">1</span>] * <span class="nu">0.9</span>:
            signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'subtype'</span>: <span class="st">'dif_dea'</span>, ...})</code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/macd_divergence.py</span>
                    <span>å½©æŸ±çº¿é•¿åº¦èƒŒç¦» (å½“å †/é‚»å †/éš”å †)</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_bar_length_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
    <span class="st">"""MACDæŸ±çº¿é•¿åº¦èƒŒç¦» â€” ä¸‰ç§å­ç±»å‹"""</span>
    groups = identify_bar_groups(df[<span class="st">'MACD_BAR'</span>])

    <span class="cm"># 1. å½“å †èƒŒç¦»: åŒä¸€å †å†…åé¢æŸ±å­çš„æœ€å¤§å€¼å¼€å§‹ç¼©å°</span>
    <span class="kw">for</span> g <span class="kw">in</span> groups:
        bars = df[<span class="st">'MACD_BAR'</span>].iloc[g[<span class="st">'start'</span>]:g[<span class="st">'end'</span>]+<span class="nu">1</span>]
        peak_idx = bars.abs().idxmax()
        <span class="cm"># å¦‚æœå³°å€¼å‡ºç°åœ¨å †çš„å‰åŠéƒ¨åˆ†, ååŠéƒ¨åˆ†æŒç»­ç¼©å° -> å½“å †èƒŒç¦»</span>

    <span class="cm"># 2. é‚»å †èƒŒç¦»: ç›¸é‚»ä¸¤ä¸ªåŒè‰²å †çš„æœ€å¤§æŸ±å­å¯¹æ¯”</span>
    red_groups = [g <span class="kw">for</span> g <span class="kw">in</span> groups <span class="kw">if</span> g[<span class="st">'type'</span>] == <span class="st">'red'</span>]
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(red_groups)):
        <span class="kw">if</span> max_bar(red_groups[i]) < max_bar(red_groups[i-<span class="nu">1</span>]) * <span class="nu">0.7</span>:
            <span class="cm"># é‚»å †èƒŒç¦» (å¦‚æœä¸¤å †ç›¸é‚») æˆ– éš”å †èƒŒç¦» (å¦‚æœä¸­é—´éš”äº†å…¶ä»–å †)</span>

    <span class="cm"># 3. éš”å †èƒŒç¦» (æœ€é‡è¦! åˆ¤æ–­èƒŒé©°çš„æ ¸å¿ƒä¾æ®)</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/macd_divergence.py</span>
                    <span>å½©æŸ±çº¿é¢ç§¯èƒŒç¦» & é‡‘å‰æ­»å‰åˆ†æ</span>
                </div>
                <pre><code><span class="kw">def</span> <span class="fn">detect_bar_area_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
    <span class="st">"""æŸ±å †é¢ç§¯(æ‰€æœ‰æŸ±å­ç»å¯¹å€¼ä¹‹å’Œ)èƒŒç¦»"""</span>
    groups = identify_bar_groups(df[<span class="st">'MACD_BAR'</span>])
    <span class="kw">for</span> g <span class="kw">in</span> groups:
        g[<span class="st">'area'</span>] = df[<span class="st">'MACD_BAR'</span>].iloc[g[<span class="st">'start'</span>]:g[<span class="st">'end'</span>]+<span class="nu">1</span>].abs().sum()
    <span class="cm"># æ¯”è¾ƒåŒè‰²ç›¸é‚»/éš”å †çš„é¢ç§¯å˜åŒ–</span>

<span class="kw">def</span> <span class="fn">analyze_macd_crosses</span>(<span class="kw">self</span>):
    <span class="st">"""é‡‘å‰: DIFä¸Šç©¿DEA (ä¹°å…¥ä¿¡å·)
    æ­»å‰: DIFä¸‹ç©¿DEA (å–å‡ºä¿¡å·)
    é›¶è½´ä¸Šæ–¹é‡‘å‰æ›´å¼º, é›¶è½´ä¸‹æ–¹æ­»å‰æ›´å¼±"""</span>
    crosses = find_macd_crosses(df[<span class="st">'DIF'</span>], df[<span class="st">'DEA'</span>])
    <span class="kw">for</span> c <span class="kw">in</span> crosses:
        c[<span class="st">'above_zero'</span>] = df[<span class="st">'DIF'</span>].iloc[c[<span class="st">'idx'</span>]] > <span class="nu">0</span>
    <span class="kw">return</span> crosses</code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : èƒŒç¦»ä¸èƒŒé©° ====== -->
        <div class="page" id="code-exhaustion">
            <div class="page-title">ç¬¬å››ç«  Â· èƒŒç¦»ä¸èƒŒé©°</div>
            <div class="page-subtitle">exhaustion.py Â· å…¨ä¹¦æœ€æ ¸å¿ƒçš„æ“ä½œç­–ç•¥</div>

            <div class="principle-grid">
                <div class="principle-card sell">
                    <h3>å–ç‚¹ç”¨èƒŒç¦» (å®æ—©å‹¿æ™š)</h3>
                    <p>MACDéš”å †èƒŒç¦»ä¸€æ¬¡ + DIFè¿”å›é›¶è½´ â†’ å³è€ƒè™‘å–å‡º<br>
                    æˆ–: ä¸¤æ¬¡ä»¥ä¸Šéš”å †èƒŒç¦» â†’ æ— è®ºæ˜¯å¦è¿”å›é›¶è½´éƒ½è€ƒè™‘å–å‡º</p>
                </div>
                <div class="principle-card buy">
                    <h3>ä¹°ç‚¹ç”¨èƒŒé©° (å®è¿Ÿå‹¿æ—©)</h3>
                    <p>äºŒæ¬¡ä»¥ä¸Šéš”å †èƒŒç¦» + DIFä¸¤æ¬¡è¿”å›é›¶è½´åå†åº¦åº•èƒŒç¦» â†’ æ‰è€ƒè™‘ä¹°å…¥<br>
                    æ¡ä»¶æ›´ä¸¥æ ¼, å‡å°‘æŠ„åº•é£é™©</p>
                </div>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/exhaustion.py</span>
                    <span>èƒŒé©°æ£€æµ‹æ ¸å¿ƒé€»è¾‘</span>
                </div>
                <pre><code><span class="kw">class</span> <span class="cl">ExhaustionAnalyzer</span>:
    <span class="st">"""èƒŒé©°åˆ†æå™¨ â€” è¶‹åŠ¿çš„æœ€åä¸€æ¬¡èƒŒç¦»"""</span>

    <span class="kw">def</span> <span class="fn">_count_zero_returns</span>(<span class="kw">self</span>, direction=<span class="st">'top'</span>):
        <span class="st">"""è®¡ç®—MACD DIFçº¿è¿”å›é›¶è½´çš„æ¬¡æ•°
        é¡¶èƒŒé©°: DIFä»æ­£å€¼åŒºåŸŸå›åˆ°0é™„è¿‘å†å›å‡çš„æ¬¡æ•°
        åº•èƒŒé©°: DIFä»è´Ÿå€¼åŒºåŸŸå›åˆ°0é™„è¿‘å†å›è½çš„æ¬¡æ•°"""</span>
        dif = <span class="kw">self</span>.df[<span class="st">'DIF'</span>]
        zero_threshold = dif.abs().mean() * <span class="nu">0.1</span>  <span class="cm"># æ¥è¿‘é›¶è½´çš„é˜ˆå€¼</span>
        <span class="cm"># éå†DIFåºåˆ—, æ£€æµ‹ "è¿œç¦»é›¶è½´ -> æ¥è¿‘é›¶è½´ -> å†æ¬¡è¿œç¦»" çš„æ¨¡å¼</span>
        returns = []
        <span class="cm">...</span>
        <span class="kw">return</span> returns

    <span class="kw">def</span> <span class="fn">_count_separated_divergences</span>(<span class="kw">self</span>, direction=<span class="st">'top'</span>):
        <span class="st">"""è®¡ç®—éš”å †èƒŒç¦»æ¬¡æ•°(æœ€å…³é”®çš„èƒŒé©°åˆ¤æ®)"""</span>
        <span class="cm"># ä½¿ç”¨ MACDDivergenceAnalyzer è·å–éš”å †èƒŒç¦»ä¿¡å·</span>
        bar_divs = <span class="kw">self</span>.macd_analyzer.detect_bar_length_divergence()
        separated = [d <span class="kw">for</span> d <span class="kw">in</span> bar_divs
                     <span class="kw">if</span> d.get(<span class="st">'subtype'</span>) == <span class="st">'separated'</span>
                     <span class="kw">and</span> d[<span class="st">'type'</span>] == direction]
        <span class="kw">return</span> separated

    <span class="kw">def</span> <span class="fn">detect_exhaustion</span>(<span class="kw">self</span>):
        <span class="st">"""ç»¼åˆåˆ¤æ–­èƒŒé©°"""</span>
        results = []

        <span class="cm"># é¡¶èƒŒé©° (å–å‡ºæ¡ä»¶å®½æ¾)</span>
        top_sep = <span class="kw">self</span>._count_separated_divergences(<span class="st">'top'</span>)
        top_zeros = <span class="kw">self</span>._count_zero_returns(<span class="st">'top'</span>)
        <span class="kw">if</span> len(top_sep) >= <span class="nu">1</span> <span class="kw">and</span> len(top_zeros) >= <span class="nu">1</span>:
            results.append({<span class="st">'type'</span>: <span class="st">'top_exhaustion'</span>, <span class="st">'confidence'</span>: <span class="st">'high'</span>})
        <span class="kw">elif</span> len(top_sep) >= <span class="nu">2</span>:
            results.append({<span class="st">'type'</span>: <span class="st">'top_exhaustion'</span>, <span class="st">'confidence'</span>: <span class="st">'medium'</span>})

        <span class="cm"># åº•èƒŒé©° (ä¹°å…¥æ¡ä»¶ä¸¥æ ¼)</span>
        bot_sep = <span class="kw">self</span>._count_separated_divergences(<span class="st">'bottom'</span>)
        bot_zeros = <span class="kw">self</span>._count_zero_returns(<span class="st">'bottom'</span>)
        <span class="kw">if</span> len(bot_sep) >= <span class="nu">2</span> <span class="kw">and</span> len(bot_zeros) >= <span class="nu">2</span>:
            results.append({<span class="st">'type'</span>: <span class="st">'bottom_exhaustion'</span>, <span class="st">'confidence'</span>: <span class="st">'high'</span>})

        <span class="kw">return</span> results</code></pre>
            </div>
        </div>

        <!-- ====== ä»£ç : å…¶ä»–æŒ‡æ ‡ ====== -->
        <div class="page" id="code-other">
            <div class="page-title">ç¬¬äº”ç«  Â· å…¶ä»–æŒ‡æ ‡èƒŒç¦»</div>
            <div class="page-subtitle">KDJ / CCI / RSI / é‡ä»·èƒŒç¦»</div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/kdj_divergence.py</span>
                    <span>KDJæŒ‡æ ‡èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">class</span> <span class="cl">KDJDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_top_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
        <span class="st">"""ä»·æ ¼åˆ›æ–°é«˜ + Kå€¼åœ¨è¶…ä¹°åŒº(>80) + Kå€¼æœªåˆ›æ–°é«˜ = KDJé¡¶èƒŒç¦»"""</span>
        price_highs = find_swing_highs(df[<span class="st">'high'</span>], order)
        <span class="kw">for</span> i <span class="kw">in</span> range(<span class="nu">1</span>, len(price_highs)):
            k_val = df[<span class="st">'K'</span>].iloc[price_highs[i]]
            <span class="kw">if</span> k_val > <span class="nu">80</span> <span class="kw">and</span> k_val < df[<span class="st">'K'</span>].iloc[price_highs[i-<span class="nu">1</span>]]:
                signals.append({<span class="st">'type'</span>: <span class="st">'top'</span>, <span class="st">'indicator'</span>: <span class="st">'KDJ'</span>})

    <span class="kw">def</span> <span class="fn">detect_bottom_divergence</span>(<span class="kw">self</span>, order=<span class="nu">5</span>):
        <span class="st">"""ä»·æ ¼åˆ›æ–°ä½ + Kå€¼åœ¨è¶…å–åŒº(<20) + Kå€¼æœªåˆ›æ–°ä½ = KDJåº•èƒŒç¦»"""</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/cci_divergence.py Â· divergence/rsi_divergence.py</span>
                    <span>CCI & RSI èƒŒç¦»</span>
                </div>
                <pre><code><span class="cm"># CCI: å¤©çº¿+100, åœ°çº¿-100</span>
<span class="kw">class</span> <span class="cl">CCIDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_top_divergence</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·æ ¼æ–°é«˜ + CCIåœ¨+100ä»¥ä¸Š + CCIæœªæ–°é«˜"""</span>
    <span class="kw">def</span> <span class="fn">detect_spring_autumn_crosses</span>(<span class="kw">self</span>):
        <span class="st">"""CCIç©¿è¶Šå¤©çº¿+100(åšå¤š) / è·Œç ´åœ°çº¿-100(åšç©º)"""</span>

<span class="cm"># RSI: è¶…ä¹°>80, è¶…å–<20</span>
<span class="kw">class</span> <span class="cl">RSIDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_top_divergence</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·æ ¼æ–°é«˜ + RSI>80 + RSIæœªæ–°é«˜"""</span>
    <span class="kw">def</span> <span class="fn">detect_bottom_divergence</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·æ ¼æ–°ä½ + RSI<20 + RSIæœªæ–°ä½"""</span></code></pre>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <span class="code-file">divergence/volume_price_divergence.py</span>
                    <span>é‡ä»·èƒŒç¦»</span>
                </div>
                <pre><code><span class="kw">class</span> <span class="cl">VolumePriceDivergenceAnalyzer</span>:
    <span class="kw">def</span> <span class="fn">detect_price_up_volume_down</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·å‡é‡å‡: ä»·æ ¼ä¸Šæ¶¨ä½†æˆäº¤é‡ä¸‹é™, ä¸Šæ¶¨è¶‹åŠ¿å¯èƒ½è¡°ç«­"""</span>
        <span class="cm"># æ¯”è¾ƒç›¸é‚»ä¸Šæ¶¨æ®µçš„æˆäº¤é‡: åæ®µé‡ < å‰æ®µé‡</span>

    <span class="kw">def</span> <span class="fn">detect_price_down_volume_up</span>(<span class="kw">self</span>):
        <span class="st">"""ä»·è·Œé‡å¢: ä»·æ ¼ä¸‹è·Œä½†æˆäº¤é‡å¢åŠ , å¯èƒ½æ˜¯ææ…ŒæŠ›å”®"""</span>

    <span class="kw">def</span> <span class="fn">detect_ground_volume</span>(<span class="kw">self</span>):
        <span class="st">"""åœ°é‡åœ°ä»·: æˆäº¤é‡æä½+ä»·æ ¼ä½ä½, å¯èƒ½æ˜¯åº•éƒ¨ä¿¡å·
        é‡ < è¿‘æœŸå‡é‡çš„30% -> åœ°é‡"""</span></code></pre>
            </div>
        </div>

        <!-- ====== å…¨å±€æœ€ä¼˜ç­–ç•¥ ====== -->
        <div class="page" id="global-strategy">
            <div class="page-title">å…¨å±€å¤šå‘¨æœŸèåˆç­–ç•¥</div>
            <div class="page-subtitle">åˆå§‹é…ç½® 100,000 USDT + ä»·å€¼ 100,000 USDT çš„ ETH Â· 9ä¸ªå‘¨æœŸåŠ æƒä¿¡å·èåˆ</div>

            <div id="gs-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½å…¨å±€ç­–ç•¥æ•°æ®...
            </div>

            <div id="gs-content" style="display:none;">
                <!-- æ‘˜è¦ç»Ÿè®¡ -->
                <div class="stats-grid" id="gs-stats"></div>

                <!-- ç­–ç•¥è¯´æ˜ -->
                <div class="card">
                    <div class="card-title">ç­–ç•¥è¯´æ˜</div>
                    <div class="principle-grid">
                        <div class="principle-card sell">
                            <h3>å–å‡ºé€»è¾‘ (å®æ—©å‹¿æ™š)</h3>
                            <p>
                                â€¢ å¤šå‘¨æœŸèƒŒé©°å–å‡ºä¿¡å· â†’ å–å‡º60%ä»“ä½<br>
                                â€¢ åŠ æƒé¡¶èƒŒç¦»â‰¥35 ä¸”ä»“ä½>30% â†’ å–å‡º30~40%<br>
                                â€¢ å¼ºé¡¶èƒŒç¦»â‰¥50 ä¸”ä»“ä½>20% â†’ å–å‡º40~60%<br>
                                â€¢ ETHæµ®äºè¶…12% â†’ æ­¢æŸå‡ä»“50%
                            </p>
                        </div>
                        <div class="principle-card buy">
                            <h3>ä¹°å…¥é€»è¾‘ (å®è¿Ÿå‹¿æ—©)</h3>
                            <p>
                                â€¢ å¤šå‘¨æœŸèƒŒé©°ä¹°å…¥ä¿¡å· â†’ ä¹°å…¥50%å¯ç”¨èµ„é‡‘<br>
                                â€¢ åŠ æƒåº•èƒŒç¦»â‰¥45 ä¸”ä»“ä½<50% â†’ ä¹°å…¥30%<br>
                                â€¢ å¼ºåº•èƒŒç¦»â‰¥60 ä¸”ä»“ä½<60% â†’ ä¹°å…¥50%<br>
                                â€¢ å†·å´æœŸ: 8å°æ—¶
                            </p>
                        </div>
                    </div>
                    <div style="margin-top:16px;">
                        <div class="card-title" style="font-size:14px;">å„å‘¨æœŸæƒé‡</div>
                        <div id="gs-weights" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;"></div>
                    </div>
                </div>

                <!-- èµ„äº§æ›²çº¿ -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>æ€»èµ„äº§æ›²çº¿</h3>
                        <span style="font-size:12px;color:var(--text-muted);">è“çº¿=ç­–ç•¥æ€»èµ„äº§ | ç°è™šçº¿=ä¹°å…¥æŒæœ‰</span>
                    </div>
                    <div id="gs-equity-chart" style="width:100%;height:350px;"></div>
                </div>

                <!-- ä»“ä½å˜åŒ– -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>ETHä»“ä½æ¯”ä¾‹å˜åŒ–</h3>
                        <span style="font-size:12px;color:var(--text-muted);">ETHå æ€»èµ„äº§çš„æ¯”ä¾‹</span>
                    </div>
                    <div id="gs-ratio-chart" style="width:100%;height:200px;"></div>
                </div>

                <!-- äº¤æ˜“æ˜ç»†è¡¨ -->
                <div class="card">
                    <div class="card-title">å…¨éƒ¨äº¤æ˜“æ˜ç»† <span class="badge" id="gs-trade-count"></span></div>
                    <div class="trade-table-wrap" style="max-height:600px;">
                        <table id="gs-trades-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                    <th>ç±»å‹</th>
                                    <th>ETHä»·æ ¼</th>
                                    <th>æ•°é‡(ETH)</th>
                                    <th>é‡‘é¢(USDT)</th>
                                    <th>æ‰‹ç»­è´¹</th>
                                    <th>USDTä½™é¢</th>
                                    <th>ETHæŒä»“</th>
                                    <th>æ€»èµ„äº§</th>
                                    <th>åŸå› </th>
                                    <th>å„å‘¨æœŸä¿¡å·</th>
                                </tr>
                            </thead>
                            <tbody id="gs-trades-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== åˆçº¦åšç©ºç­–ç•¥ ====== -->
        <div class="page" id="strategy-futures">
            <div class="page-title">åˆçº¦åšç©ºç­–ç•¥</div>
            <div class="page-subtitle">å…è®¸åšç©º Â· USDTæ°¸ç»­åˆçº¦ Â· é€ä»“æ¨¡å¼ Â· å¤šç§ç­–ç•¥å¯¹æ¯”</div>

            <div class="card" id="ft-intro">
                <div class="card-title">åˆçº¦äº¤æ˜“è§„åˆ™</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;">
                    <div style="background:var(--bg-hover);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">ä¿è¯é‡‘æ¨¡å¼</div>
                        <div style="font-size:16px;font-weight:700;color:var(--accent-blue);">é€ä»“ Isolated</div>
                    </div>
                    <div style="background:var(--bg-hover);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">æ‰‹ç»­è´¹</div>
                        <div style="font-size:16px;font-weight:700;color:var(--accent-yellow);">Taker 0.05%</div>
                    </div>
                    <div style="background:var(--bg-hover);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">èµ„é‡‘è´¹ç‡</div>
                        <div style="font-size:16px;font-weight:700;color:var(--accent-purple);">Â±0.01%/8h</div>
                    </div>
                    <div style="background:var(--bg-hover);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">é£æ§ä¸Šé™</div>
                        <div style="font-size:16px;font-weight:700;color:var(--accent-red);">10%ä¿è¯é‡‘</div>
                    </div>
                </div>
                <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
                    <b>åˆå§‹é…ç½®:</b> 100,000 USDT + ä»·å€¼100,000 USDTçš„ETH<br>
                    <b>æ æ†ä¸Šé™:</b> æœ€é«˜3x Â· å•ç¬”ä¿è¯é‡‘â‰¤æ€»èµ„äº§5% Â· ç´¯è®¡ä¿è¯é‡‘ååâ‰¤åˆå§‹150%<br>
                    <b>åšç©ºæœºåˆ¶:</b> é¡¶èƒŒç¦»/èƒŒé©°ä¿¡å·â†’å¼€ç©ºä»“å¯¹å†²æˆ–åšç©ºè·åˆ© Â· åº•ä¿¡å·â†’å¹³ç©º<br>
                    <b>æ»‘ç‚¹æ¨¡å‹:</b> 0.1%åŒå‘æ»‘ç‚¹(å«å¸‚åœºå†²å‡»)
                </div>
            </div>

            <!-- ç­–ç•¥è¯´æ˜å¡ç‰‡ -->
            <div class="card">
                <div class="card-title">5ç§åˆçº¦ç­–ç•¥ + 1ä¸ªçº¯ç°è´§å¯¹ç…§</div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="ft-strategy-cards"></div>
            </div>

            <!-- æŸ±çŠ¶å›¾å¯¹æ¯” -->
            <div class="card">
                <div class="card-title">æ”¶ç›Šä¸è¶…é¢æ”¶ç›Šå¯¹æ¯”</div>
                <div id="ft-bar-chart" style="width:100%;min-height:350px;"></div>
            </div>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="card">
                <div class="card-title">è¯¦ç»†æŒ‡æ ‡å¯¹æ¯”</div>
                <div class="trade-table-wrap" style="max-height:none;">
                    <table id="ft-table">
                        <thead><tr id="ft-table-head"></tr></thead>
                        <tbody id="ft-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- èµ„äº§æ›²çº¿ -->
            <div class="card">
                <div class="card-title">èµ„äº§æ›²çº¿å¯¹æ¯”</div>
                <div id="ft-equity-chart" style="width:100%;height:400px;"></div>
            </div>

            <!-- æœ€ä½³ç­–ç•¥äº¤æ˜“æ˜ç»† -->
            <div class="card">
                <div class="card-title">æœ€ä½³ç­–ç•¥äº¤æ˜“æ˜ç»† <span class="badge green" id="ft-trade-count"></span></div>
                <div class="trade-table-wrap" style="max-height:500px;">
                    <table id="ft-trades-table">
                        <thead>
                            <tr>
                                <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>æ–¹å‘</th><th>ä»·æ ¼</th>
                                <th>æ•°é‡</th><th>åä¹‰ä»·å€¼</th><th>æ æ†</th>
                                <th>USDTä½™é¢</th><th>å†»ç»“ä¿è¯é‡‘</th><th>æ€»èµ„äº§</th><th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody id="ft-trades-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ç»“è®º -->
            <div class="card" id="ft-conclusion"></div>
        </div>

        <!-- ====== ç­–ç•¥ä¼˜åŒ–å¯¹æ¯” ====== -->
        <div class="page" id="strategy-compare">
            <div class="page-title">ç­–ç•¥ä¼˜åŒ–å¯¹æ¯”å®éªŒ</div>
            <div class="page-subtitle">6ç§ç­–ç•¥æ€è·¯ + 12ç§å‚æ•°å˜ä½“ Â· å¯»æ‰¾æœ€ä¼˜ç­–ç•¥é…ç½®</div>

            <div id="sc-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½ç­–ç•¥å¯¹æ¯”æ•°æ®...
            </div>

            <div id="sc-content" style="display:none;">
                <!-- ç¬¬ä¸€éƒ¨åˆ†: 6å¤§ç­–ç•¥å¯¹æ¯” -->
                <div class="card">
                    <div class="card-title">6å¤§ç­–ç•¥æ€è·¯å¯¹æ¯” <span class="badge purple">Phase 1</span></div>
                    <div class="page-subtitle" style="margin-bottom:16px;">ç›¸åŒæ•°æ®ã€ç›¸åŒåˆå§‹èµ„é‡‘(10ä¸‡USDT+10ä¸‡ETH)ï¼Œæµ‹è¯•6ç§ä¸åŒç­–ç•¥é€»è¾‘</div>

                    <!-- ç­–ç•¥è¯´æ˜å¡ç‰‡ -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="sc-strategy-cards"></div>

                    <!-- è¶…é¢æ”¶ç›Šå¯¹æ¯”æŸ±çŠ¶å›¾ -->
                    <div id="sc-bar-chart" style="width:100%;min-height:320px;margin-bottom:20px;"></div>

                    <!-- å¯¹æ¯”è¡¨æ ¼ -->
                    <div class="trade-table-wrap" style="max-height:none;">
                        <table id="sc-table">
                            <thead><tr id="sc-table-head"></tr></thead>
                            <tbody id="sc-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ç¬¬äºŒéƒ¨åˆ†: æœ€ä¼˜ç­–ç•¥å‚æ•°è°ƒä¼˜ -->
                <div class="card">
                    <div class="card-title">æœ€ä¼˜ç­–ç•¥å‚æ•°è°ƒä¼˜ <span class="badge green">Phase 2</span></div>
                    <div class="page-subtitle" style="margin-bottom:16px;">åŸºäºæœ€ä¼˜ç­–ç•¥(æ¸è¿›å‡ä»“)ï¼Œæµ‹è¯•12ç§å‚æ•°ç»„åˆå¯»æ‰¾æœ€ä¼˜é…ç½®</div>

                    <!-- ä¼˜åŒ–å˜ä½“æŸ±çŠ¶å›¾ -->
                    <div id="sc-opt-bar" style="width:100%;min-height:360px;margin-bottom:20px;"></div>

                    <!-- ä¼˜åŒ–å˜ä½“è¡¨æ ¼ -->
                    <div class="trade-table-wrap" style="max-height:none;">
                        <table id="sc-opt-table">
                            <thead><tr id="sc-opt-head"></tr></thead>
                            <tbody id="sc-opt-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- èµ„äº§æ›²çº¿å¯¹æ¯” -->
                <div class="card">
                    <div class="card-title">TOPç­–ç•¥èµ„äº§æ›²çº¿å¯¹æ¯”</div>
                    <div id="sc-equity-chart" style="width:100%;height:380px;"></div>
                </div>

                <!-- æœ€ç»ˆç»“è®º -->
                <div class="card" id="sc-conclusion"></div>

                <!-- ç¬¬ä¸‰éƒ¨åˆ†: æ·±åº¦æŒ‡æ ‡å¢å¼º -->
                <div id="se-section" style="display:none;">
                    <div class="card">
                        <div class="card-title">æ·±åº¦æŒ‡æ ‡å¢å¼ºç­–ç•¥ <span class="badge" style="background:rgba(255,77,106,0.15);color:var(--accent-red);">Phase 3 Â· å…¨æŒ‡æ ‡</span></div>
                        <div class="page-subtitle" style="margin-bottom:16px;">
                            å……åˆ†åˆ©ç”¨ä¹¦ä¸­ç¬¬äºŒ~äº”ç« çš„æ‰€æœ‰ç»†ç²’åº¦æŒ‡æ ‡ï¼šMACDé‡‘å‰æ­»å‰ã€KDJè¶…ä¹°è¶…å–ã€CCIå¤©åœ°çº¿ã€RSIæå€¼ã€é‡ä»·èƒŒç¦»ã€å‡ ä½•å½¢æ€
                        </div>

                        <!-- ç­–ç•¥è¯´æ˜ -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="se-strategy-cards"></div>

                        <!-- æŸ±çŠ¶å›¾ -->
                        <div id="se-bar-chart" style="width:100%;min-height:320px;margin-bottom:20px;"></div>

                        <!-- è¡¨æ ¼ -->
                        <div class="trade-table-wrap" style="max-height:none;">
                            <table id="se-table">
                                <thead><tr id="se-table-head"></tr></thead>
                                <tbody id="se-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- èµ„äº§æ›²çº¿å¯¹æ¯” -->
                    <div class="card">
                        <div class="card-title">å¢å¼ºç­–ç•¥èµ„äº§æ›²çº¿</div>
                        <div id="se-equity-chart" style="width:100%;height:380px;"></div>
                    </div>

                    <!-- æœ€ä½³ç­–ç•¥äº¤æ˜“æ˜ç»† -->
                    <div class="card">
                        <div class="card-title">æœ€ä½³ç­–ç•¥äº¤æ˜“æ˜ç»† <span class="badge green" id="se-trade-count"></span></div>
                        <div class="trade-table-wrap" style="max-height:500px;">
                            <table id="se-trades-table">
                                <thead>
                                    <tr>
                                        <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>ä»·æ ¼</th>
                                        <th>æ•°é‡</th><th>é‡‘é¢</th><th>æ‰‹ç»­è´¹</th>
                                        <th>USDTä½™é¢</th><th>ETHæŒä»“</th><th>æ€»èµ„äº§</th><th>åŸå› </th>
                                    </tr>
                                </thead>
                                <tbody id="se-trades-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ç»ˆæç»“è®º -->
                    <div class="card" id="se-conclusion"></div>
                </div>
            </div>
        </div>

        <!-- ====== å¤šå‘¨æœŸå¯¹æ¯” ====== -->
        <div class="page" id="multi-compare">
            <div class="page-title">12å‘¨æœŸå›æµ‹å¯¹æ¯”</div>
            <div class="page-subtitle">ETH/USDT Â· 10åˆ†é’Ÿ ~ 32å°æ—¶ Â· èƒŒç¦»/èƒŒé©°ç­–ç•¥åœ¨ä¸åŒæ—¶é—´æ¡†æ¶ä¸‹çš„è¡¨ç°</div>

            <div id="multi-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½å¤šå‘¨æœŸå›æµ‹æ•°æ®...
            </div>

            <div id="multi-content" style="display:none;">
                <!-- è¶…é¢æ”¶ç›ŠæŸ±çŠ¶å›¾ -->
                <div class="card">
                    <div class="card-title">è¶…é¢æ”¶ç›Šå¯¹æ¯” <span class="badge green">ç­–ç•¥æ”¶ç›Š - ä¹°å…¥æŒæœ‰æ”¶ç›Š</span></div>
                    <div id="alpha-bar-chart" style="width:100%;height:320px;"></div>
                </div>

                <!-- æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”è¡¨ -->
                <div class="card">
                    <div class="card-title">æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”è¡¨</div>
                    <div class="trade-table-wrap" style="max-height:none;">
                        <table id="multi-table">
                            <thead><tr id="multi-table-head"></tr></thead>
                            <tbody id="multi-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- èµ„äº§æ›²çº¿å åŠ å›¾ -->
                <div class="card">
                    <div class="card-title">èµ„äº§æ›²çº¿å åŠ  <span class="badge">ç‚¹å‡»å›¾ä¾‹åˆ‡æ¢æ˜¾ç¤º</span></div>
                    <div id="multi-equity-chart" style="width:100%;height:380px;"></div>
                </div>

                <!-- ç»“è®º -->
                <div class="card" id="multi-conclusion"></div>
            </div>
        </div>

        <!-- ====== å›æµ‹æ‘˜è¦ ====== -->
        <div class="page" id="backtest-summary">
            <div class="page-title">ETH/USDT å›æµ‹æ‘˜è¦</div>
            <div class="page-subtitle">10åˆ†é’ŸKçº¿ Â· å¸å®‰ç°è´§ Â· èƒŒç¦»/èƒŒé©°ç­–ç•¥</div>

            <div id="summary-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½å›æµ‹æ•°æ®...
            </div>

            <div id="summary-content" style="display:none;">
                <div class="stats-grid" id="stats-grid"></div>

                <div class="card">
                    <div class="card-title">ç­–ç•¥è¯´æ˜</div>
                    <div class="principle-grid">
                        <div class="principle-card sell">
                            <h3>å–å‡ºä¿¡å·</h3>
                            <p>
                                â€¢ ç»¼åˆé¡¶èƒŒç¦»è¯„åˆ† â‰¥ 45<br>
                                â€¢ èƒŒé©°å–å‡ºä¿¡å· (æœ€é«˜ä¼˜å…ˆçº§)<br>
                                â€¢ æ­¢æŸ: -5% / æ­¢ç›ˆ: +8%<br>
                                â€¢ éµå¾ª "å–ç‚¹ç”¨èƒŒç¦», å®æ—©å‹¿æ™š"
                            </p>
                        </div>
                        <div class="principle-card buy">
                            <h3>ä¹°å…¥ä¿¡å·</h3>
                            <p>
                                â€¢ ç»¼åˆåº•èƒŒç¦»è¯„åˆ† â‰¥ 65<br>
                                â€¢ èƒŒé©°ä¹°å…¥ä¿¡å· (æœ€é«˜ä¼˜å…ˆçº§)<br>
                                â€¢ å†·å´æœŸ: 30æ ¹Kçº¿ (5å°æ—¶)<br>
                                â€¢ éµå¾ª "ä¹°ç‚¹ç”¨èƒŒé©°, å®è¿Ÿå‹¿æ—©"
                            </p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>èµ„äº§æ›²çº¿</h3>
                        <span style="font-size:12px;color:var(--text-muted);">è“çº¿=ç­–ç•¥å‡€å€¼ | åŸºå‡†=ETHä¹°å…¥æŒæœ‰</span>
                    </div>
                    <div id="equity-chart"></div>
                </div>
            </div>
        </div>

        <!-- ====== Kçº¿å›¾ ====== -->
        <div class="page" id="backtest-chart">
            <div class="page-title">Kçº¿å›¾ä¸äº¤æ˜“ä¿¡å·</div>
            <div class="page-subtitle">ETH/USDT 10åˆ†é’ŸKçº¿ Â· ä¹°å–ç‚¹æ ‡æ³¨</div>

            <div id="chart-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...
            </div>

            <div id="chart-content" style="display:none;">
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>ETH/USDT Â· 10åˆ†é’Ÿ</h3>
                    </div>
                    <div id="kline-chart"></div>
                </div>
            </div>
        </div>

        <!-- ====== äº¤æ˜“æ˜ç»† ====== -->
        <div class="page" id="backtest-trades">
            <div class="page-title">äº¤æ˜“æ˜ç»†</div>
            <div class="page-subtitle">å®Œæ•´äº¤æ˜“è®°å½• (ä¹°å…¥-å–å‡ºé…å¯¹)</div>

            <div id="trades-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½äº¤æ˜“æ•°æ®...
            </div>

            <div id="trades-content" style="display:none;">
                <div class="stats-grid" id="trade-stats"></div>
                <div class="card">
                    <div class="card-title">äº¤æ˜“è®°å½•</div>
                    <div class="trade-table-wrap">
                        <table id="trades-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ä¹°å…¥æ—¶é—´</th>
                                    <th>ä¹°å…¥ä»·</th>
                                    <th>å–å‡ºæ—¶é—´</th>
                                    <th>å–å‡ºä»·</th>
                                    <th>ç›ˆäº(USDT)</th>
                                    <th>ç›ˆäº%</th>
                                    <th>ä¹°å…¥åŸå› </th>
                                    <th>å–å‡ºåŸå› </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
    // ===== Constants =====
    const INTERVALS = ['10m','15m','30m','1h','2h','3h','4h','6h','8h','16h','24h','32h'];
    const INTERVAL_LABELS = {'10m':'10åˆ†é’Ÿ','15m':'15åˆ†é’Ÿ','30m':'30åˆ†é’Ÿ','1h':'1å°æ—¶','2h':'2å°æ—¶','3h':'3å°æ—¶','4h':'4å°æ—¶','6h':'6å°æ—¶','8h':'8å°æ—¶','16h':'16å°æ—¶','24h':'24å°æ—¶','32h':'32å°æ—¶'};
    const COLORS = ['#4a9eff','#ff4d6a','#00d68f','#ffaa00','#a855f7','#06b6d4','#f43f5e','#84cc16','#ec4899','#f97316','#8b5cf6','#14b8a6'];

    // ===== Navigation =====
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            item.classList.add('active');
            const pageId = item.dataset.page;
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'global-strategy' && !window._gsLoaded) loadGlobalStrategy();
                if (pageId === 'strategy-compare' && !window._scLoaded) loadStrategyCompare();
                if (pageId === 'strategy-futures' && !window._ftLoaded) loadFuturesStrategy();
                if (pageId === 'multi-compare' && !window._multiLoaded) loadMultiData();
                if (pageId.startsWith('backtest') && !window._backtestLoaded) loadBacktestData();
        });
    });

    // ========================================
    //   Global Strategy
    // ========================================
    let gsData = null;

    async function loadGlobalStrategy() {
        if (window._gsLoaded) return;
        try {
            const resp = await fetch('/api/global_strategy');
            if (!resp.ok) throw new Error('No data');
            gsData = await resp.json();
            window._gsLoaded = true;
            renderGS();
            document.getElementById('gs-loading').style.display = 'none';
            document.getElementById('gs-content').style.display = 'block';
        } catch (e) {
            document.getElementById('gs-loading').innerHTML =
                '<span style="color:var(--accent-red)">æœªæ‰¾åˆ°å…¨å±€ç­–ç•¥æ•°æ®ã€‚è¯·å…ˆè¿è¡Œ: python global_strategy.py</span>';
        }
    }

    function renderGS() {
        const s = gsData.summary;
        const trades = gsData.trades || [];

        // Stats
        document.getElementById('gs-stats').innerHTML = [
            {label:'åˆå§‹æ€»èµ„äº§', value:'$'+s.initial_total.toLocaleString(), cls:''},
            {label:'æœ€ç»ˆæ€»èµ„äº§', value:'$'+s.final_total.toLocaleString(), cls: s.final_total >= s.initial_total ? 'positive' : 'negative'},
            {label:'ç­–ç•¥æ”¶ç›Š', value: s.strategy_return+'%', cls: s.strategy_return >= 0 ? 'positive' : 'negative'},
            {label:'ä¹°å…¥æŒæœ‰æ”¶ç›Š', value: s.buy_hold_return+'%', cls: s.buy_hold_return >= 0 ? 'positive' : 'negative'},
            {label:'è¶…é¢æ”¶ç›Š', value: (s.alpha >= 0 ? '+' : '') + s.alpha + '%', cls: s.alpha >= 0 ? 'positive' : 'negative'},
            {label:'æœ€å¤§å›æ’¤', value: s.max_drawdown+'%', cls:'negative'},
            {label:'ETHä»·æ ¼å˜åŒ–', value: s.eth_price_change+'%', cls: s.eth_price_change >= 0 ? 'positive' : 'negative'},
            {label:'ä¹°å…¥/å–å‡ºæ¬¡æ•°', value: s.total_buy_trades + 'ä¹° / ' + s.total_sell_trades + 'å–', cls:''},
            {label:'æœ€ç»ˆUSDT', value: '$'+s.final_usdt.toLocaleString(), cls:''},
            {label:'æœ€ç»ˆETHæŒä»“', value: s.final_eth_qty + ' ETH', cls:'', note: '$' + s.final_eth_value.toLocaleString()},
        ].map(item => `
            <div class="stat-card">
                <div class="stat-label">${item.label}</div>
                <div class="stat-value ${item.cls}" style="font-size:${item.value.length > 12 ? '18' : '24'}px;">${item.value}</div>
                ${item.note ? '<div class="stat-note">' + item.note + '</div>' : ''}
            </div>
        `).join('');

        // Weights
        const weights = gsData.tf_weights || {};
        document.getElementById('gs-weights').innerHTML = Object.entries(weights)
            .sort((a,b) => b[1] - a[1])
            .map(([tf, w]) => {
                const pct = Math.round(w * 100);
                const hue = pct > 70 ? 142 : pct > 50 ? 45 : 220;
                return `<div style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);font-size:12px;">
                    <strong>${INTERVAL_LABELS[tf] || tf}</strong>
                    <span style="color:hsl(${hue},70%,60%);margin-left:4px;">${pct}%</span>
                    <div style="height:3px;margin-top:4px;border-radius:2px;background:var(--border);width:80px;">
                        <div style="height:100%;width:${pct}%;background:hsl(${hue},70%,60%);border-radius:2px;"></div>
                    </div>
                </div>`;
            }).join('');

        // Trade count badge
        document.getElementById('gs-trade-count').textContent = trades.length + 'ç¬”äº¤æ˜“';

        // Equity chart
        renderGSEquity();

        // Ratio chart
        renderGSRatio();

        // Trades table
        renderGSTrades();
    }

    function renderGSEquity() {
        const container = document.getElementById('gs-equity-chart');
        const ph = gsData.portfolio_history || [];
        if (!ph.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 350,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        // Strategy total
        const stLine = chart.addLineSeries({ color: '#4a9eff', lineWidth: 2, title: 'ç­–ç•¥æ€»èµ„äº§' });
        stLine.setData(ph.map(p => ({
            time: Math.floor(new Date(p.time).getTime() / 1000),
            value: p.total,
        })));

        // Buy & hold baseline
        const initTotal = gsData.summary.initial_total;
        const firstEthP = ph[0].eth_price;
        const bhLine = chart.addLineSeries({ color: '#5c6078', lineWidth: 1, lineStyle: 2, title: 'ä¹°å…¥æŒæœ‰' });
        bhLine.setData(ph.map(p => ({
            time: Math.floor(new Date(p.time).getTime() / 1000),
            value: 100000 + (100000 / firstEthP) * p.eth_price,
        })));

        // Buy/sell markers on equity
        const markers = (gsData.trades || []).map(t => ({
            time: Math.floor(new Date(t.time).getTime() / 1000),
            position: t.action === 'BUY' ? 'belowBar' : 'aboveBar',
            color: t.action === 'BUY' ? '#00d68f' : '#ff4d6a',
            shape: t.action === 'BUY' ? 'arrowUp' : 'arrowDown',
            text: t.action === 'BUY' ? 'B' : 'S',
        }));
        stLine.setMarkers(markers);

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderGSRatio() {
        const container = document.getElementById('gs-ratio-chart');
        const ph = gsData.portfolio_history || [];
        if (!ph.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 200,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
            rightPriceScale: { autoScale: true },
        });

        const areaS = chart.addAreaSeries({
            topColor: 'rgba(74,158,255,0.3)',
            bottomColor: 'rgba(74,158,255,0.02)',
            lineColor: '#4a9eff',
            lineWidth: 1,
            title: 'ETHä»“ä½%',
        });
        areaS.setData(ph.map(p => ({
            time: Math.floor(new Date(p.time).getTime() / 1000),
            value: p.eth_ratio,
        })));

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderGSTrades() {
        const trades = gsData.trades || [];
        const tbody = document.getElementById('gs-trades-body');

        tbody.innerHTML = trades.map((t, i) => {
            const isBuy = t.action === 'BUY';
            const actionCls = isBuy ? 'pnl-pos' : 'pnl-neg';
            const typeBg = t.type === 'æ­¢æŸå‡ä»“' ? 'background:rgba(255,77,106,0.08);' : '';
            const dt = new Date(t.time);
            const timeStr = `${dt.getMonth()+1}/${dt.getDate()} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;

            return `<tr style="${typeBg}">
                <td>${i+1}</td>
                <td style="white-space:nowrap;">${timeStr}</td>
                <td class="${actionCls}" style="font-weight:700;">${t.action}</td>
                <td>${t.type}</td>
                <td>$${t.price.toLocaleString()}</td>
                <td>${t.quantity.toFixed(4)}</td>
                <td>$${t.value.toLocaleString()}</td>
                <td>$${t.fee.toFixed(2)}</td>
                <td>$${t.usdt_after.toLocaleString()}</td>
                <td>${t.eth_after.toFixed(4)}</td>
                <td>$${t.total_assets.toLocaleString()}</td>
                <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${t.reason}">${t.reason}</td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;color:var(--text-muted);" title="${t.signal_tf||''}">${t.signal_tf||'â€”'}</td>
            </tr>`;
        }).join('');
    }

    // ========================================
    //   Strategy Compare & Optimize
    // ========================================
    let scData = null;
    let scOptData = null;

    async function loadStrategyCompare() {
        if (window._scLoaded) return;
        try {
            const [r1, r2] = await Promise.all([
                fetch('/api/strategy_compare'),
                fetch('/api/strategy_optimize'),
            ]);
            if (!r1.ok || !r2.ok) throw new Error('No data');
            scData = await r1.json();
            scOptData = await r2.json();
            window._scLoaded = true;
            renderSCPage();
            document.getElementById('sc-loading').style.display = 'none';
            document.getElementById('sc-content').style.display = 'block';
            // Also load enhanced strategies
            loadEnhancedStrategy();
        } catch (e) {
            document.getElementById('sc-loading').innerHTML =
                '<span style="color:var(--accent-red)">æœªæ‰¾åˆ°ç­–ç•¥å¯¹æ¯”æ•°æ®ã€‚è¯·å…ˆè¿è¡Œ python strategy_compare.py && python strategy_optimize.py</span>';
        }
    }

    function renderSCPage() {
        renderSCCards();
        renderSCBarChart();
        renderSCTable();
        renderSCOptBar();
        renderSCOptTable();
        renderSCEquity();
        renderSCConclusion();
    }

    function renderSCCards() {
        const strategies = scData.strategies || [];
        const descriptions = {
            'A: å¤šå‘¨æœŸèåˆ (baseline)': { icon: 'ğŸ”€', desc: 'å¤šå‘¨æœŸä¿¡å·åŠ æƒèåˆï¼Œç»¼åˆå¤šä¸ªæ—¶é—´æ¡†æ¶çš„èƒŒç¦»/èƒŒé©°ä¿¡å·åšå†³ç­–', color: '#4a9eff' },
            'B: 4hä¸“æ³¨ç­–ç•¥': { icon: 'ğŸ¯', desc: 'åªä½¿ç”¨4hå‘¨æœŸä¿¡å·ï¼Œæœ€ä¼˜å•å‘¨æœŸä¸“æ³¨æ“ä½œï¼Œé«˜é˜ˆå€¼+é•¿å†·å´æœŸ', color: '#a855f7' },
            'C: è¶‹åŠ¿è·Ÿéšé˜²å¾¡': { icon: 'ğŸ“‰', desc: 'MA50åˆ¤æ–­è¶‹åŠ¿æ–¹å‘ï¼Œä¸‹è·Œåªå–ä¸ä¹°ï¼Œä¸Šæ¶¨è¶‹åŠ¿ä¸­æ‰è€ƒè™‘ä¹°å…¥', color: '#f97316' },
            'D: ä¿å®ˆé«˜é˜ˆå€¼': { icon: 'ğŸ›¡ï¸', desc: 'æé«˜ä¿¡å·é˜ˆå€¼(å…±æŒ¯å¾—åˆ†â‰¥55/60)ï¼Œ36å°æ—¶å†·å´æœŸï¼Œåªåšç¡®å®šæ€§æœ€é«˜çš„äº¤æ˜“', color: '#06b6d4' },
            'E: æ¸è¿›å‡ä»“': { icon: 'â¬‡ï¸', desc: 'æ ¹æ®èƒŒç¦»å¼ºåº¦é€æ­¥å–å‡ºETHï¼Œä¿ç•™10%åº•ä»“ï¼Œåªåœ¨å¼ºèƒŒé©°ä¿¡å·ä¹°å›', color: '#00d68f' },
            'F: åŠ¨æ€å†å¹³è¡¡': { icon: 'âš–ï¸', desc: 'æ ¹æ®èƒŒç¦»ä¿¡å·åŠ¨æ€è°ƒæ•´ETHç›®æ ‡æ¯”ä¾‹(10%~70%)ï¼Œåå·®>8%æ—¶å†å¹³è¡¡', color: '#ffaa00' },
        };

        const container = document.getElementById('sc-strategy-cards');
        container.innerHTML = strategies.map(s => {
            const d = descriptions[s.name] || { icon: 'ğŸ“Š', desc: '', color: '#4a9eff' };
            const alpha = s.summary.alpha;
            const alphaColor = alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            return `<div style="padding:16px;border-radius:10px;border:1px solid var(--border);border-top:3px solid ${d.color};">
                <div style="font-size:20px;margin-bottom:8px;">${d.icon}</div>
                <div style="font-weight:600;font-size:14px;margin-bottom:6px;">${s.name}</div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin-bottom:10px;">${d.desc}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;color:var(--text-muted);">${s.summary.total_trades}ç¬”äº¤æ˜“</span>
                    <span style="font-size:16px;font-weight:700;color:${alphaColor};">${alpha >= 0 ? '+' : ''}${alpha.toFixed(2)}%</span>
                </div>
            </div>`;
        }).join('');
    }

    function renderSCBarChart() {
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const container = document.getElementById('sc-bar-chart');
        const maxAbs = Math.max(...strategies.map(s => Math.abs(s.summary.alpha)), 1);
        const barColors = ['#00d68f', '#06b6d4', '#ffaa00', '#a855f7', '#4a9eff', '#ff4d6a'];

        const barH = 220;
        let html = '<div style="position:relative;height:' + (barH + 60) + 'px;display:flex;align-items:center;">';
        html += '<div style="display:flex;flex-direction:column;justify-content:space-between;height:' + barH + 'px;padding-right:8px;font-size:11px;color:var(--text-muted);width:50px;text-align:right;">';
        html += '<span>+' + maxAbs.toFixed(0) + '%</span><span>0%</span><span>-' + maxAbs.toFixed(0) + '%</span></div>';
        html += '<div style="flex:1;display:flex;align-items:center;height:' + barH + 'px;position:relative;">';
        html += '<div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--text-muted);opacity:0.3;"></div>';
        html += '<div style="display:flex;align-items:center;height:100%;width:100%;justify-content:space-around;">';

        strategies.forEach((s, i) => {
            const alpha = s.summary.alpha;
            const h = Math.abs(alpha / maxAbs) * (barH / 2 - 10);
            const isPos = alpha >= 0;
            const color = barColors[i % barColors.length];
            const valColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';
            const shortName = s.name.split(':')[1] || s.name;

            html += '<div style="display:flex;flex-direction:column;align-items:center;flex:1;max-width:130px;height:100%;justify-content:center;position:relative;">';
            if (isPos) {
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:50%;">';
                html += '<span style="font-size:12px;font-weight:700;color:' + valColor + ';margin-bottom:3px;">' + (alpha >= 0 ? '+' : '') + alpha.toFixed(2) + '%</span>';
                html += '<div style="width:48px;height:' + h + 'px;background:' + color + ';border-radius:6px 6px 0 0;opacity:0.85;"></div>';
                html += '</div><div style="height:50%;"></div>';
            } else {
                html += '<div style="height:50%;"></div>';
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:50%;">';
                html += '<div style="width:48px;height:' + h + 'px;background:' + color + ';border-radius:0 0 6px 6px;opacity:0.85;"></div>';
                html += '<span style="font-size:12px;font-weight:700;color:' + valColor + ';margin-top:3px;">' + alpha.toFixed(2) + '%</span>';
                html += '</div>';
            }
            html += '<div style="position:absolute;bottom:-28px;font-size:11px;color:var(--text-muted);white-space:nowrap;text-align:center;">' + shortName.trim() + '</div>';
            html += '</div>';
        });

        html += '</div></div></div>';
        container.innerHTML = html;
    }

    function renderSCTable() {
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        let headHtml = '<th style="text-align:left;">æ’å</th><th style="text-align:left;">ç­–ç•¥</th>';
        headHtml += '<th>ç­–ç•¥æ”¶ç›Š</th><th>ä¹°å…¥æŒæœ‰</th><th>è¶…é¢æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>äº¤æ˜“æ•°</th><th>æœ€ç»ˆèµ„äº§</th>';
        document.getElementById('sc-table-head').innerHTML = headHtml;

        const tbody = document.getElementById('sc-table-body');
        tbody.innerHTML = strategies.map((s, i) => {
            const sm = s.summary;
            const isBest = i === 0;
            const rowStyle = isBest ? 'background:rgba(0,214,143,0.05);' : '';
            const rankBadge = i < 3 ? `<span class="rank-badge rank-${i+1}">${i+1}</span>` : `<span style="padding:0 8px;color:var(--text-muted);">${i+1}</span>`;
            const alphaColor = sm.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const retColor = sm.strategy_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            return `<tr style="${rowStyle}">
                <td>${rankBadge}</td>
                <td style="text-align:left;font-weight:${isBest?'700':'500'};">${s.name}${isBest?' â˜…':''}</td>
                <td style="color:${retColor};font-weight:600;">${sm.strategy_return >= 0 ? '+' : ''}${sm.strategy_return}%</td>
                <td style="color:var(--text-muted);">${sm.buy_hold_return}%</td>
                <td style="color:${alphaColor};font-weight:700;">${sm.alpha >= 0 ? '+' : ''}${sm.alpha}%</td>
                <td style="color:var(--accent-red);">${sm.max_drawdown}%</td>
                <td>${sm.total_trades}</td>
                <td style="font-weight:600;">$${sm.final_total.toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    function renderSCOptBar() {
        const results = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const container = document.getElementById('sc-opt-bar');
        const maxAbs = Math.max(...results.map(r => Math.abs(r.summary.alpha)), 1);

        const barH = 260;
        let html = '<div style="position:relative;height:' + (barH + 70) + 'px;display:flex;align-items:center;">';
        html += '<div style="display:flex;flex-direction:column;justify-content:space-between;height:' + barH + 'px;padding-right:8px;font-size:11px;color:var(--text-muted);width:50px;text-align:right;">';
        html += '<span>+' + maxAbs.toFixed(0) + '%</span><span>0%</span><span>-' + maxAbs.toFixed(0) + '%</span></div>';
        html += '<div style="flex:1;display:flex;align-items:center;height:' + barH + 'px;position:relative;overflow-x:auto;">';
        html += '<div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--text-muted);opacity:0.3;"></div>';
        html += '<div style="display:flex;align-items:center;height:100%;min-width:100%;justify-content:space-around;">';

        const optColors = results.map((r, i) => {
            const a = r.summary.alpha;
            if (a >= 8) return '#00d68f';
            if (a >= 5) return '#06b6d4';
            if (a >= 2) return '#4a9eff';
            if (a >= 0) return '#ffaa00';
            return '#ff4d6a';
        });

        results.forEach((r, i) => {
            const alpha = r.summary.alpha;
            const h = Math.abs(alpha / maxAbs) * (barH / 2 - 15);
            const isPos = alpha >= 0;
            const color = optColors[i];
            const valColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';
            const label = r.name.split(':')[0];

            html += '<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:55px;max-width:80px;height:100%;justify-content:center;position:relative;">';
            if (isPos) {
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:50%;">';
                html += '<span style="font-size:10px;font-weight:700;color:' + valColor + ';margin-bottom:2px;">' + (alpha >= 0 ? '+' : '') + alpha.toFixed(1) + '%</span>';
                html += '<div style="width:28px;height:' + h + 'px;background:' + color + ';border-radius:4px 4px 0 0;opacity:0.85;"></div>';
                html += '</div><div style="height:50%;"></div>';
            } else {
                html += '<div style="height:50%;"></div>';
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:50%;">';
                html += '<div style="width:28px;height:' + h + 'px;background:' + color + ';border-radius:0 0 4px 4px;opacity:0.85;"></div>';
                html += '<span style="font-size:10px;font-weight:700;color:' + valColor + ';margin-top:2px;">' + alpha.toFixed(1) + '%</span>';
                html += '</div>';
            }
            html += '<div style="position:absolute;bottom:-34px;font-size:10px;color:var(--text-muted);white-space:nowrap;text-align:center;transform:rotate(-15deg);">' + label + '</div>';
            html += '</div>';
        });

        html += '</div></div></div>';
        container.innerHTML = html;
    }

    function renderSCOptTable() {
        const results = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        let headHtml = '<th style="text-align:left;">#</th><th style="text-align:left;">å˜ä½“</th>';
        headHtml += '<th>ç­–ç•¥æ”¶ç›Š</th><th>è¶…é¢æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>äº¤æ˜“æ•°</th><th>æœ€ç»ˆèµ„äº§</th>';
        document.getElementById('sc-opt-head').innerHTML = headHtml;

        const tbody = document.getElementById('sc-opt-body');
        tbody.innerHTML = results.map((r, i) => {
            const sm = r.summary;
            const isBest = i === 0;
            const rowStyle = isBest ? 'background:rgba(0,214,143,0.05);' : (i < 3 ? 'background:rgba(74,158,255,0.03);' : '');
            const alphaColor = sm.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const retColor = sm.strategy_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const medal = i === 0 ? ' ğŸ¥‡' : i === 1 ? ' ğŸ¥ˆ' : i === 2 ? ' ğŸ¥‰' : '';
            return `<tr style="${rowStyle}">
                <td style="font-weight:600;color:var(--text-muted);">${i+1}</td>
                <td style="text-align:left;font-weight:${isBest?'700':'400'};font-size:12px;">${r.name}${medal}</td>
                <td style="color:${retColor};">${sm.strategy_return >= 0 ? '+' : ''}${sm.strategy_return}%</td>
                <td style="color:${alphaColor};font-weight:700;">${sm.alpha >= 0 ? '+' : ''}${sm.alpha}%</td>
                <td style="color:var(--accent-red);">${sm.max_drawdown}%</td>
                <td>${sm.total_trades}</td>
                <td style="font-weight:500;">$${sm.final_total.toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    function renderSCEquity() {
        const container = document.getElementById('sc-equity-chart');

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 380,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        // Show top 6 optimization variants
        const results = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const topN = results.slice(0, 6);
        const eqColors = ['#00d68f', '#06b6d4', '#4a9eff', '#ffaa00', '#a855f7', '#f43f5e'];

        topN.forEach((r, i) => {
            const hist = r.history || [];
            if (hist.length < 2) return;
            const line = chart.addLineSeries({
                color: eqColors[i],
                lineWidth: i === 0 ? 3 : 1,
                title: r.name.split(':')[0],
            });
            line.setData(hist.map(h => ({
                time: Math.floor(new Date(h.time).getTime() / 1000),
                value: h.total,
            })));
        });

        // Also show strategies from phase 1
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        if (strategies.length > 0) {
            const bestS = strategies[0];
            const hist = bestS.history || [];
            if (hist.length >= 2) {
                const line = chart.addLineSeries({
                    color: '#5c6078', lineWidth: 1, lineStyle: 2,
                    title: 'ä¹°å…¥æŒæœ‰(å‚è€ƒ)',
                });
                // Approximate buy-hold using first and last points
                const initT = bestS.summary.initial_total;
                const bhRet = bestS.summary.buy_hold_return / 100;
                const startV = initT;
                const endV = initT * (1 + bhRet);
                const startTime = Math.floor(new Date(hist[0].time).getTime() / 1000);
                const endTime = Math.floor(new Date(hist[hist.length-1].time).getTime() / 1000);
                line.setData(hist.map((h, idx) => {
                    const t = Math.floor(new Date(h.time).getTime() / 1000);
                    const progress = (t - startTime) / (endTime - startTime || 1);
                    return { time: t, value: startV + (endV - startV) * progress };
                }));
            }
        }

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderSCConclusion() {
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const optResults = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        const bestStrategy = strategies[0];
        const bestOpt = optResults[0];
        const worstOpt = optResults[optResults.length - 1];

        let html = '<div class="conclusion-title">ğŸ”¬ ç­–ç•¥ä¼˜åŒ–ç»“è®º</div>';
        html += '<div class="conclusion-grid">';

        // Finding 1: Best strategy type
        html += '<div class="conclusion-item" style="border-color:var(--accent-green);">';
        html += '<h4 style="color:var(--accent-green);">æœ€ä¼˜ç­–ç•¥æ€è·¯</h4>';
        html += '<p>';
        html += '<strong>' + bestStrategy.name + '</strong> ä»¥è¶…é¢æ”¶ç›Š <strong style="color:var(--accent-green);">' + (bestStrategy.summary.alpha >= 0 ? '+' : '') + bestStrategy.summary.alpha + '%</strong> é¢†å…ˆå…¶ä»–5ç§ç­–ç•¥ã€‚';
        html += '<br><br>';
        html += 'æ ¸å¿ƒé€»è¾‘: åœ¨ä¸‹è·Œè¶‹åŠ¿ä¸­<strong>é€æ­¥å‡ä»“</strong>è€Œéä¸€æ¬¡æ€§æ“ä½œï¼Œ';
        html += 'ä¿ç•™æœ€ä½åº•ä»“(10%)é˜²æ­¢è¸ç©ºï¼Œåªåœ¨å¼ºèƒŒé©°ä¿¡å·å‡ºç°æ—¶æ‰ä¹°å›ã€‚';
        html += '</p></div>';

        // Finding 2: Best optimized variant
        html += '<div class="conclusion-item" style="border-color:var(--accent-blue);">';
        html += '<h4 style="color:var(--accent-blue);">æœ€ä¼˜å‚æ•°é…ç½®</h4>';
        html += '<p>';
        html += '<strong>' + bestOpt.name + '</strong> è¿›ä¸€æ­¥å°†è¶…é¢æ”¶ç›Šæå‡è‡³ <strong style="color:var(--accent-green);">' + (bestOpt.summary.alpha >= 0 ? '+' : '') + bestOpt.summary.alpha + '%</strong>';
        html += 'ï¼Œæœ€å¤§å›æ’¤ <strong>' + bestOpt.summary.max_drawdown + '%</strong> (ä¼˜äºåŸºå‡†)ã€‚';
        html += '<br><br>';
        html += 'å…³é”®å‘ç°: åœ¨ä¸‹è·Œè¡Œæƒ…ä¸­ï¼Œ<strong>"åªå–ä¸ä¹°"</strong>ç­–ç•¥åè€Œè¡¨ç°æœ€å¥½â€”â€”å‡å°‘ä¸ç¡®å®šæ€§ä¹°å…¥ï¼Œè®©åˆ©æ¶¦è‡ªç„¶ç§¯ç´¯ã€‚';
        html += '</p></div>';

        // Finding 3: What doesn't work
        html += '<div class="conclusion-item" style="border-color:var(--accent-red);">';
        html += '<h4 style="color:var(--accent-red);">å¤±æ•ˆç­–ç•¥è­¦ç¤º</h4>';
        html += '<p>';
        const worst = strategies[strategies.length - 1];
        html += '<strong>' + worst.name + '</strong> è¡¨ç°æœ€å·®(è¶…é¢ ' + worst.summary.alpha + '%)ã€‚';
        html += '<br><br>';
        html += 'è¿‡äºé¢‘ç¹çš„å¤šå‘¨æœŸä¿¡å·èåˆåœ¨éœ‡è¡è¡Œæƒ…ä¸­äº§ç”Ÿå¤§é‡<strong>å‡ä¿¡å·</strong>ï¼Œå¯¼è‡´é¢‘ç¹äº¤æ˜“å’Œæ‰‹ç»­è´¹æŸè€—ã€‚';
        html += '<br>æé«˜å–å‡ºé˜ˆå€¼(â‰¥30)æˆ–è¿‡åº¦ä¾èµ–4hå•å‘¨æœŸåŒæ ·æ•ˆæœä¸ä½³ã€‚';
        html += '</p></div>';

        // Finding 4: Actionable insight
        html += '<div class="conclusion-item" style="border-color:var(--accent-yellow);">';
        html += '<h4 style="color:var(--accent-yellow);">å®æ“å»ºè®®</h4>';
        html += '<p>';
        html += 'ğŸ“Œ <strong>ç†Šå¸‚</strong>: æ¸è¿›å‡ä»“ç­–ç•¥(E)æœ€ä¼˜ï¼Œé™ä½æœ€ä½ä»“ä½è‡³5%ï¼Œå–å‡ºå†·å´æœŸ5h';
        html += '<br>ğŸ“Œ <strong>éœ‡è¡å¸‚</strong>: åŠ¨æ€å†å¹³è¡¡(F)æˆ–è¶‹åŠ¿è·Ÿéš(C)æ›´ç¨³å¥';
        html += '<br>ğŸ“Œ <strong>ç‰›å¸‚</strong>: éœ€åå‘ä¼˜åŒ–â€”â€”æ¸è¿›åŠ ä»“ã€é«˜é˜ˆå€¼æ‰å–å‡º';
        html += '<br><br>';
        html += '<span style="color:var(--text-muted);font-size:12px;">âš ï¸ ä»¥ä¸Šç»“è®ºåŸºäºæœ€è¿‘30å¤©ä¸‹è·Œè¡Œæƒ…ï¼Œä¸åŒå¸‚åœºç¯å¢ƒéœ€é‡æ–°éªŒè¯</span>';
        html += '</p></div>';

        html += '</div>';
        document.getElementById('sc-conclusion').innerHTML = html;
    }

    // ========================================
    //   Enhanced Strategy (Phase 3)
    // ========================================
    let seData = null;

    async function loadEnhancedStrategy() {
        try {
            const resp = await fetch('/api/strategy_enhanced');
            if (!resp.ok) return;
            seData = await resp.json();
            document.getElementById('se-section').style.display = 'block';
            renderSEPage();
        } catch (e) { /* silently fail if not available */ }
    }

    function renderSEPage() {
        renderSECards();
        renderSEBarChart();
        renderSETable();
        renderSEEquity();
        renderSETrades();
        renderSEConclusion();
    }

    function renderSECards() {
        const results = seData.enhanced_results || [];
        const descriptions = {
            'G: æŒ‡æ ‡å…±æŒ¯': { icon: 'ğŸ””', desc: 'KDJ/CCI/RSI/MACDå¤šæŒ‡æ ‡åŒæ—¶ç¡®è®¤(â‰¥3ä¸ª)æ‰æ“ä½œï¼Œå‡å°‘å‡ä¿¡å·', color: '#a855f7' },
            'H: MACDäº¤å‰æ‹©æ—¶': { icon: 'âœ‚ï¸', desc: 'æ­»å‰+èƒŒç¦»=å–å‡ºï¼Œé‡‘å‰+èƒŒé©°=ä¹°å…¥ï¼Œç”¨äº¤å‰åšç²¾ç¡®å…¥åœºæ—¶æœº', color: '#4a9eff' },
            'I: KDJ+RSIæå€¼': { icon: 'ğŸ“', desc: 'KDJ>75/RSI>65=è¶…ä¹°åŒºå–å‡ºï¼ŒKDJ<25/RSI<35=è¶…å–åŒºä¹°å…¥', color: '#06b6d4' },
            'J: é‡ä»·ç¡®è®¤': { icon: 'ğŸ“Š', desc: 'ä»·å‡é‡å‡=ä¸Šæ¶¨ä¹åŠ›â†’å–å‡ºç¡®è®¤ï¼›åœ°é‡+èƒŒé©°=æ½œåœ¨åº•éƒ¨â†’ä¹°å…¥', color: '#00d68f' },
            'K: ä¹¦ä¸­ä¸¥æ ¼åŸåˆ™': { icon: 'ğŸ“–', desc: 'ä¸¥æ ¼éµå¾ªï¼šéš”å †èƒŒç¦»+DIFé›¶è½´è¿”å›â†’å–ï¼›åŒéš”å †+åŒé›¶è½´+èƒŒé©°â†’æ‰ä¹°', color: '#ffaa00' },
            'L: å…¨æŒ‡æ ‡ç»ˆæèåˆ': { icon: 'ğŸ†', desc: 'æ¸è¿›å‡ä»“åŸºç¡€+å¤šæŒ‡æ ‡å…±æŒ¯+MACDæ‹©æ—¶+KDJ/RSIè¿‡æ»¤+é‡ä»·ç¡®è®¤+è¶‹åŠ¿åˆ¤æ–­', color: '#f43f5e' },
            'E9: åªå–ä¸ä¹°(å¯¹ç…§)': { icon: 'ğŸ“‰', desc: 'ä¸Šä¸€è½®å† å†›ç­–ç•¥ä½œä¸ºåŸºå‡†å¯¹ç…§', color: '#5c6078' },
        };

        const container = document.getElementById('se-strategy-cards');
        const sorted = [...results].sort((a, b) => b.summary.alpha - a.summary.alpha);
        container.innerHTML = sorted.slice(0, 6).map(r => {
            const d = descriptions[r.name] || { icon: 'ğŸ“Š', desc: r.name, color: '#4a9eff' };
            const alpha = r.summary.alpha;
            const alphaColor = alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            return `<div style="padding:14px;border-radius:10px;border:1px solid var(--border);border-top:3px solid ${d.color};">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:18px;">${d.icon}</span>
                    <span style="font-weight:600;font-size:13px;">${r.name}</span>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);line-height:1.5;margin-bottom:8px;min-height:40px;">${d.desc}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:11px;color:var(--text-muted);">${r.summary.total_trades}ç¬” | å›æ’¤${r.summary.max_drawdown}%</span>
                    <span style="font-size:15px;font-weight:700;color:${alphaColor};">${alpha >= 0 ? '+' : ''}${alpha.toFixed(2)}%</span>
                </div>
            </div>`;
        }).join('');
    }

    function renderSEBarChart() {
        const results = (seData.enhanced_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const container = document.getElementById('se-bar-chart');
        const maxAbs = Math.max(...results.map(r => Math.abs(r.summary.alpha)), 1);
        const barH = 240;

        let html = '<div style="position:relative;height:' + (barH + 60) + 'px;display:flex;align-items:center;">';
        html += '<div style="display:flex;flex-direction:column;justify-content:space-between;height:' + barH + 'px;padding-right:8px;font-size:11px;color:var(--text-muted);width:50px;text-align:right;">';
        html += '<span>+' + maxAbs.toFixed(0) + '%</span><span>0%</span><span>-' + maxAbs.toFixed(0) + '%</span></div>';
        html += '<div style="flex:1;display:flex;align-items:center;height:' + barH + 'px;position:relative;">';
        html += '<div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--text-muted);opacity:0.3;"></div>';
        html += '<div style="display:flex;align-items:center;height:100%;width:100%;justify-content:space-around;">';

        const seColors = ['#00d68f', '#06b6d4', '#4a9eff', '#ffaa00', '#a855f7', '#f43f5e', '#5c6078'];
        results.forEach((r, i) => {
            const alpha = r.summary.alpha;
            const h = Math.abs(alpha / maxAbs) * (barH / 2 - 12);
            const isPos = alpha >= 0;
            const color = seColors[i % seColors.length];
            const valColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';
            const shortName = r.name.split(':')[1] || r.name.split(':')[0];

            html += '<div style="display:flex;flex-direction:column;align-items:center;flex:1;max-width:120px;height:100%;justify-content:center;position:relative;">';
            if (isPos) {
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:50%;">';
                html += '<span style="font-size:12px;font-weight:700;color:' + valColor + ';margin-bottom:3px;">' + (alpha >= 0 ? '+' : '') + alpha.toFixed(1) + '%</span>';
                html += '<div style="width:44px;height:' + h + 'px;background:' + color + ';border-radius:6px 6px 0 0;opacity:0.85;"></div>';
                html += '</div><div style="height:50%;"></div>';
            } else {
                html += '<div style="height:50%;"></div>';
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:50%;">';
                html += '<div style="width:44px;height:' + h + 'px;background:' + color + ';border-radius:0 0 6px 6px;opacity:0.85;"></div>';
                html += '<span style="font-size:12px;font-weight:700;color:' + valColor + ';margin-top:3px;">' + alpha.toFixed(1) + '%</span>';
                html += '</div>';
            }
            html += '<div style="position:absolute;bottom:-28px;font-size:10px;color:var(--text-muted);white-space:nowrap;text-align:center;">' + shortName.trim() + '</div>';
            html += '</div>';
        });

        html += '</div></div></div>';
        container.innerHTML = html;
    }

    function renderSETable() {
        const results = (seData.enhanced_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        let headHtml = '<th style="text-align:left;">#</th><th style="text-align:left;">ç­–ç•¥</th>';
        headHtml += '<th>ç­–ç•¥æ”¶ç›Š</th><th>ä¹°å…¥æŒæœ‰</th><th>è¶…é¢æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>äº¤æ˜“æ•°</th><th>ä¹°å…¥</th><th>å–å‡º</th><th>æœ€ç»ˆèµ„äº§</th>';
        document.getElementById('se-table-head').innerHTML = headHtml;

        const tbody = document.getElementById('se-table-body');
        tbody.innerHTML = results.map((r, i) => {
            const sm = r.summary;
            const isBest = i === 0;
            const rowStyle = isBest ? 'background:rgba(0,214,143,0.05);' : '';
            const alphaColor = sm.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const retColor = sm.strategy_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const medal = i === 0 ? ' ğŸ¥‡' : i === 1 ? ' ğŸ¥ˆ' : i === 2 ? ' ğŸ¥‰' : '';
            return `<tr style="${rowStyle}">
                <td style="font-weight:600;color:var(--text-muted);">${i+1}</td>
                <td style="text-align:left;font-weight:${isBest?'700':'400'};font-size:12px;">${r.name}${medal}</td>
                <td style="color:${retColor};font-weight:600;">${sm.strategy_return >= 0 ? '+' : ''}${sm.strategy_return}%</td>
                <td style="color:var(--text-muted);">${sm.buy_hold_return}%</td>
                <td style="color:${alphaColor};font-weight:700;font-size:14px;">${sm.alpha >= 0 ? '+' : ''}${sm.alpha}%</td>
                <td style="color:var(--accent-red);">${sm.max_drawdown}%</td>
                <td>${sm.total_trades}</td>
                <td style="color:var(--accent-green);">${sm.buy_trades}</td>
                <td style="color:var(--accent-red);">${sm.sell_trades}</td>
                <td style="font-weight:600;">$${sm.final_total.toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    function renderSEEquity() {
        const container = document.getElementById('se-equity-chart');
        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 380,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const results = (seData.enhanced_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const eqColors = ['#00d68f', '#06b6d4', '#4a9eff', '#ffaa00', '#a855f7', '#f43f5e', '#5c6078'];

        results.forEach((r, i) => {
            const hist = r.history || [];
            if (hist.length < 2) return;
            const line = chart.addLineSeries({
                color: eqColors[i % eqColors.length],
                lineWidth: i === 0 ? 3 : (i <= 2 ? 2 : 1),
                title: r.name.split(':')[0],
            });
            line.setData(hist.map(h => ({
                time: Math.floor(new Date(h.time).getTime() / 1000),
                value: h.total,
            })));
        });

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderSETrades() {
        const results = (seData.enhanced_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const best = results[0];
        if (!best) return;

        const trades = best.trades || [];
        document.getElementById('se-trade-count').textContent = best.name + ' Â· ' + trades.length + 'ç¬”';

        const tbody = document.getElementById('se-trades-body');
        tbody.innerHTML = trades.map((t, i) => {
            const isBuy = t.action === 'BUY';
            const cls = isBuy ? 'pnl-pos' : 'pnl-neg';
            const dt = new Date(t.time);
            const ts = `${dt.getMonth()+1}/${dt.getDate()} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
            return `<tr>
                <td>${i+1}</td>
                <td style="white-space:nowrap;">${ts}</td>
                <td class="${cls}" style="font-weight:700;">${t.action}</td>
                <td>$${t.price.toLocaleString()}</td>
                <td>${t.quantity.toFixed(4)}</td>
                <td>$${t.value.toLocaleString()}</td>
                <td>$${t.fee.toFixed(2)}</td>
                <td>$${t.usdt_after.toLocaleString()}</td>
                <td>${t.eth_after.toFixed(4)}</td>
                <td>$${t.total.toLocaleString()}</td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;" title="${t.reason}">${t.reason}</td>
            </tr>`;
        }).join('');
    }

    function renderSEConclusion() {
        const results = (seData.enhanced_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const best = results[0];
        const second = results[1];
        const baseline = results.find(r => r.name.includes('å¯¹ç…§'));

        let html = '<div class="conclusion-title">ğŸ† ç»ˆæç­–ç•¥ä¼˜åŒ–ç»“è®º</div>';
        html += '<div class="conclusion-grid">';

        // å† å†›ç­–ç•¥
        html += '<div class="conclusion-item" style="border-color:var(--accent-green);">';
        html += '<h4 style="color:var(--accent-green);">ğŸ¥‡ æœ€ä¼˜ç­–ç•¥</h4>';
        html += '<p><strong>' + best.name + '</strong><br>';
        html += 'è¶…é¢æ”¶ç›Š: <strong style="color:var(--accent-green);">' + (best.summary.alpha >= 0 ? '+' : '') + best.summary.alpha + '%</strong><br>';
        html += 'æœ€å¤§å›æ’¤: <strong>' + best.summary.max_drawdown + '%</strong><br>';
        html += 'äº¤æ˜“æ¬¡æ•°: ' + best.summary.total_trades + 'ç¬”<br>';
        html += 'æœ€ç»ˆèµ„äº§: $' + best.summary.final_total.toLocaleString();
        if (baseline) {
            const improve = (best.summary.alpha - baseline.summary.alpha).toFixed(1);
            html += '<br><br>ç›¸æ¯”åŸºå‡†æå‡ <strong style="color:var(--accent-blue);">+' + improve + '%</strong>';
        }
        html += '</p></div>';

        // å…³é”®å‘ç°
        html += '<div class="conclusion-item" style="border-color:var(--accent-blue);">';
        html += '<h4 style="color:var(--accent-blue);">ğŸ”¬ å…³é”®å‘ç°</h4>';
        html += '<p>';
        html += 'â€¢ <strong>é‡ä»·èƒŒç¦»</strong>æ˜¯æœ€æœ‰ä»·å€¼çš„è¾…åŠ©æŒ‡æ ‡â€”â€”"ä»·å‡é‡å‡"ç²¾ç¡®ç¡®è®¤å–å‡ºæ—¶æœº<br>';
        html += 'â€¢ <strong>KDJ/RSIè¶…ä¹°è¶…å–</strong>æä¾›æœ‰æ•ˆè¿‡æ»¤ï¼Œé¿å…åœ¨ä¸­æ€§åŒºåŸŸé¢‘ç¹æ“ä½œ<br>';
        html += 'â€¢ <strong>å¤šæŒ‡æ ‡å…±æŒ¯</strong>è¦æ±‚è¿‡é«˜(â‰¥3ä¸ª)åè€Œå¯¼è‡´è¿‡åº¦äº¤æ˜“(-0.82%)<br>';
        html += 'â€¢ <strong>ä¹¦ä¸­ä¸¥æ ¼åŸåˆ™</strong>åœ¨30å¤©çª—å£å†…è¿‡äºä¿å®ˆï¼Œæ— äº¤æ˜“ä¿¡å·äº§ç”Ÿ';
        html += '</p></div>';

        // æŒ‡æ ‡ä»·å€¼æ’å
        html += '<div class="conclusion-item" style="border-color:var(--accent-purple);">';
        html += '<h4 style="color:var(--accent-purple);">ğŸ“Š æŒ‡æ ‡ä»·å€¼æ’å</h4>';
        html += '<p>';
        html += '<strong>1. é‡ä»·åˆ†æ</strong> â€” ä»·å‡é‡å‡+åœ°é‡ä¿¡å·,æœ€æœ‰æ•ˆçš„ç¡®è®¤å·¥å…·<br>';
        html += '<strong>2. MACDèƒŒç¦»/èƒŒé©°</strong> â€” æ ¸å¿ƒä¿¡å·æ¥æºï¼Œéš”å †èƒŒç¦»æœ€é‡è¦<br>';
        html += '<strong>3. è¶‹åŠ¿åˆ¤æ–­(MA50)</strong> â€” ä¸‹è·Œè¶‹åŠ¿ä¸­åŠ å¤§å–å‡ºåŠ›åº¦æ•ˆæœæ˜¾è‘—<br>';
        html += '<strong>4. KDJ/RSIæå€¼</strong> â€” æœ‰æ•ˆçš„è¾…åŠ©è¿‡æ»¤ï¼Œè¶…ä¹°åŒºå–å‡ºç¡®è®¤ç‡é«˜<br>';
        html += '<strong>5. CCIå¤©åœ°çº¿</strong> â€” ç©¿è¶ŠÂ±100ä½œä¸ºè¾…åŠ©å‚è€ƒ<br>';
        html += '<strong>6. å‡ ä½•å½¢æ€</strong> â€” å¹…åº¦/æ—¶é—´è¡°å‡æä¾›é¢å¤–ä½è¯';
        html += '</p></div>';

        // ä¸‰é˜¶æ®µå¯¹æ¯”
        html += '<div class="conclusion-item" style="border-color:var(--accent-yellow);">';
        html += '<h4 style="color:var(--accent-yellow);">ğŸ“ˆ ä¸‰é˜¶æ®µä¼˜åŒ–å†ç¨‹</h4>';
        html += '<p>';
        html += '<strong>Phase 1</strong>: 6ç§ç­–ç•¥æ€è·¯ â†’ æ¸è¿›å‡ä»“æœ€ä¼˜ +7.13%<br>';
        html += '<strong>Phase 2</strong>: å‚æ•°è°ƒä¼˜ â†’ åªå–ä¸ä¹°å˜ä½“ +9.06%<br>';
        html += '<strong>Phase 3</strong>: æ·±åº¦æŒ‡æ ‡å¢å¼º â†’ <strong style="color:var(--accent-green);">' + best.name + ' ' + (best.summary.alpha >= 0 ? '+' : '') + best.summary.alpha + '%</strong><br>';
        html += '<br>ä¸‰è½®ä¼˜åŒ–å°†è¶…é¢æ”¶ç›Šä»+7.13%æå‡è‡³+' + best.summary.alpha.toFixed(1) + '%';
        html += '</p></div>';

        html += '</div>';
        document.getElementById('se-conclusion').innerHTML = html;
    }

    // ========================================
    //   Multi-Interval Comparison
    // ========================================
    let multiData = null;

    async function loadMultiData() {
        if (window._multiLoaded) return;
        try {
            const resp = await fetch('/api/backtest_multi');
            if (!resp.ok) throw new Error('No data');
            multiData = await resp.json();
            window._multiLoaded = true;
            renderMultiBarChart();
            renderMultiTable();
            renderMultiEquity();
            renderConclusion();
            document.getElementById('multi-loading').style.display = 'none';
            document.getElementById('multi-content').style.display = 'block';
        } catch (e) {
            document.getElementById('multi-loading').innerHTML =
                '<span style="color:var(--accent-red)">æœªæ‰¾åˆ°å¤šå‘¨æœŸæ•°æ®ã€‚è¯·å…ˆç”Ÿæˆ backtest_multi.json</span>';
        }
    }

    function renderMultiBarChart() {
        const container = document.getElementById('alpha-bar-chart');
        const items = INTERVALS.map((iv, i) => {
            const s = multiData[iv];
            const alpha = s ? (s.total_return - s.buy_hold_return) : null;
            return { iv, alpha, color: COLORS[i], label: INTERVAL_LABELS[iv] };
        }).filter(x => x.alpha !== null);

        const maxAbs = Math.max(...items.map(x => Math.abs(x.alpha)), 1);

        // Build bar chart with CSS
        const barH = 200;
        const zeroY = barH / 2;

        let html = '<div style="position:relative;height:' + (barH + 60) + 'px;display:flex;align-items:center;">';
        // Y axis labels
        html += '<div style="display:flex;flex-direction:column;justify-content:space-between;height:' + barH + 'px;padding-right:8px;font-size:11px;color:var(--text-muted);width:50px;text-align:right;">';
        html += '<span>+' + maxAbs.toFixed(0) + '%</span>';
        html += '<span>0%</span>';
        html += '<span>-' + maxAbs.toFixed(0) + '%</span>';
        html += '</div>';
        // Bars
        html += '<div style="flex:1;display:flex;align-items:center;height:' + barH + 'px;position:relative;">';
        // Zero line
        html += '<div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--text-muted);opacity:0.3;"></div>';
        // Bar area
        html += '<div style="display:flex;align-items:center;height:100%;width:100%;justify-content:space-around;">';

        items.forEach(item => {
            const pct = item.alpha / maxAbs;
            const h = Math.abs(pct) * (barH / 2 - 10);
            const isPos = item.alpha >= 0;
            const barColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';
            const valColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';

            html += '<div style="display:flex;flex-direction:column;align-items:center;flex:1;max-width:80px;height:100%;justify-content:center;position:relative;">';
            if (isPos) {
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:50%;">';
                html += '<span style="font-size:11px;font-weight:600;color:' + valColor + ';margin-bottom:3px;">+' + item.alpha.toFixed(1) + '%</span>';
                html += '<div style="width:32px;height:' + h + 'px;background:' + barColor + ';border-radius:4px 4px 0 0;opacity:0.85;"></div>';
                html += '</div>';
                html += '<div style="height:50%;"></div>';
            } else {
                html += '<div style="height:50%;"></div>';
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:50%;">';
                html += '<div style="width:32px;height:' + h + 'px;background:' + barColor + ';border-radius:0 0 4px 4px;opacity:0.85;"></div>';
                html += '<span style="font-size:11px;font-weight:600;color:' + valColor + ';margin-top:3px;">' + item.alpha.toFixed(1) + '%</span>';
                html += '</div>';
            }
            html += '<div style="position:absolute;bottom:-24px;font-size:11px;color:var(--text-muted);white-space:nowrap;">' + item.label + '</div>';
            html += '</div>';
        });

        html += '</div></div></div>';
        container.innerHTML = html;
    }

    function renderMultiTable() {
        // Header
        let headHtml = '<th style="text-align:left;">æŒ‡æ ‡</th>';
        INTERVALS.forEach((iv, i) => {
            headHtml += '<th>' + INTERVAL_LABELS[iv] + '</th>';
        });
        document.getElementById('multi-table-head').innerHTML = headHtml;

        // Rows
        const rows = [
            { label: 'ç­–ç•¥æ”¶ç›Š', key: 'total_return', unit: '%', signed: true, higherBetter: true },
            { label: 'ä¹°å…¥æŒæœ‰', key: 'buy_hold_return', unit: '%', signed: true },
            { label: 'è¶…é¢æ”¶ç›Š', key: '_alpha', unit: '%', signed: true, higherBetter: true },
            { label: 'æœ€å¤§å›æ’¤', key: 'max_drawdown', unit: '%', lowerBetter: true },
            { label: 'äº¤æ˜“æ¬¡æ•°', key: 'total_trades', unit: '' },
            { label: 'èƒœç‡', key: 'win_rate', unit: '%', higherBetter: true },
            { label: 'å¹³å‡ç›ˆåˆ©', key: 'avg_win_pct', unit: '%', higherBetter: true },
            { label: 'å¹³å‡äºæŸ', key: 'avg_loss_pct', unit: '%' },
            { label: 'Sharpe', key: 'sharpe_ratio', unit: '', higherBetter: true },
        ];

        let bodyHtml = '';
        rows.forEach(row => {
            let vals = INTERVALS.map(iv => {
                const s = multiData[iv];
                if (!s) return null;
                if (row.key === '_alpha') return s.total_return - s.buy_hold_return;
                return s[row.key];
            });

            // Find best value (only among intervals with trades)
            let bestIdx = -1;
            if (row.higherBetter) {
                let best = -Infinity;
                vals.forEach((v, i) => {
                    const s = multiData[INTERVALS[i]];
                    if (v !== null && s && s.total_trades > 0 && v > best) { best = v; bestIdx = i; }
                });
            } else if (row.lowerBetter) {
                let best = Infinity;
                vals.forEach((v, i) => {
                    const s = multiData[INTERVALS[i]];
                    if (v !== null && s && s.total_trades > 0 && Math.abs(v) < Math.abs(best)) { best = v; bestIdx = i; }
                });
            }

            bodyHtml += '<tr>';
            bodyHtml += '<td style="text-align:left;font-weight:600;color:var(--text-primary);">' + row.label + '</td>';
            vals.forEach((v, i) => {
                if (v === null) {
                    bodyHtml += '<td style="color:var(--text-muted);">â€”</td>';
                } else {
                    let cls = '';
                    if (i === bestIdx) cls = 'cell-best';
                    let display;
                    if (row.unit === '%') {
                        display = (row.signed && v > 0 ? '+' : '') + v.toFixed(1) + '%';
                    } else {
                        display = typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(1)) : v;
                    }
                    // Color coding for return/alpha
                    let style = '';
                    if (row.key === 'total_return' || row.key === '_alpha') {
                        style = v >= 0 ? 'color:var(--accent-green);' : 'color:var(--accent-red);';
                    }
                    bodyHtml += '<td class="' + cls + '" style="' + style + '">' + display + '</td>';
                }
            });
            bodyHtml += '</tr>';
        });

        document.getElementById('multi-table-body').innerHTML = bodyHtml;
    }

    function renderMultiEquity() {
        const container = document.getElementById('multi-equity-chart');

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 380,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
            rightPriceScale: { borderVisible: false },
        });

        const series = {};
        // Only show intervals with equity curves and trades
        const activeIntervals = INTERVALS.filter(iv => {
            const s = multiData[iv];
            return s && s.equity_curve && s.equity_curve.length > 0 && s.total_trades > 0;
        });

        activeIntervals.forEach((iv, i) => {
            const s = multiData[iv];
            const ec = s.equity_curve;
            if (!ec || ec.length < 2) return;

            const line = chart.addLineSeries({
                color: COLORS[i % COLORS.length],
                lineWidth: iv === '4h' ? 3 : 1,
                title: INTERVAL_LABELS[iv],
            });

            // Normalize to percentage
            const initVal = ec[0].equity || 10000;
            const data = ec.map(e => ({
                time: Math.floor(new Date(e.date).getTime() / 1000),
                value: (e.equity / initVal) * 100,
            }));
            line.setData(data);
            series[iv] = line;
        });

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderConclusion() {
        // Rank by alpha (only intervals with actual trades)
        const ranked = INTERVALS
            .filter(iv => multiData[iv] && multiData[iv].total_trades > 0)
            .map(iv => ({
                iv,
                label: INTERVAL_LABELS[iv],
                alpha: multiData[iv].total_return - multiData[iv].buy_hold_return,
                ret: multiData[iv].total_return,
                dd: multiData[iv].max_drawdown,
                trades: multiData[iv].total_trades,
                wr: multiData[iv].win_rate,
            }))
            .sort((a, b) => b.alpha - a.alpha);

        const noTrade = INTERVALS.filter(iv => multiData[iv] && multiData[iv].total_trades === 0);

        let html = '<div class="conclusion-title">åˆ†æç»“è®º</div>';
        html += '<div class="conclusion-grid">';

        // Top 3
        html += '<div class="conclusion-item" style="border-color:var(--accent-green);">';
        html += '<h4 style="color:var(--accent-green);">è¶…é¢æ”¶ç›Šæ’å (æœ‰å®é™…äº¤æ˜“)</h4>';
        html += '<div style="margin-top:8px;">';
        ranked.slice(0, 5).forEach((r, i) => {
            const rankCls = i < 3 ? ' rank-' + (i+1) : '';
            const badge = i < 3 ? '<span class="rank-badge' + rankCls + '">' + (i+1) + '</span>' : '<span style="display:inline-block;width:26px;text-align:center;color:var(--text-muted);">' + (i+1) + '.</span>';
            html += '<div style="padding:4px 0;font-size:13px;">';
            html += badge;
            html += '<strong>' + r.label + '</strong>';
            html += ' <span style="color:' + (r.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + ';font-weight:600;">' + (r.alpha >= 0 ? '+' : '') + r.alpha.toFixed(1) + '%</span>';
            html += ' <span style="color:var(--text-muted);font-size:11px;">(' + r.trades + 'ç¬”, èƒœç‡' + r.wr.toFixed(0) + '%)</span>';
            html += '</div>';
        });
        html += '</div></div>';

        // Key insight
        const best = ranked[0];
        html += '<div class="conclusion-item" style="border-color:var(--accent-blue);">';
        html += '<h4 style="color:var(--accent-blue);">æ ¸å¿ƒå‘ç°</h4>';
        html += '<p>';
        html += '<strong>' + best.label + '</strong> æ˜¯å½“å‰è¡Œæƒ…æœ€ä¼˜å‘¨æœŸï¼Œè¶…é¢æ”¶ç›Š <strong style="color:var(--accent-green);">' + (best.alpha >= 0 ? '+' : '') + best.alpha.toFixed(1) + '%</strong>ã€‚';
        html += '<br><br>';
        html += 'èƒŒç¦»/èƒŒé©°æœ¬è´¨æ˜¯<strong>è¶‹åŠ¿çº§åˆ«</strong>ä¿¡å·ã€‚æ—¶é—´æ¡†æ¶è¶Šå¤§ï¼Œä¿¡å·å™ªéŸ³è¶Šå°‘ï¼Œä½†äº¤æ˜“æœºä¼šä¹Ÿè¶Šå°‘ã€‚';
        html += '<br><br>';
        html += '<strong>æœ€ä¼˜çª—å£: 2h ~ 8h</strong>ï¼Œå…¼é¡¾ä¿¡å·è´¨é‡å’Œäº¤æ˜“é¢‘ç‡ã€‚';
        if (noTrade.length > 0) {
            html += '<br><br><span style="color:var(--text-muted);font-size:12px;">' + noTrade.map(iv => INTERVAL_LABELS[iv]).join('ã€') + ' æœªè§¦å‘äº¤æ˜“ä¿¡å·ï¼ŒæŒå¸ä¸åŠ¨ã€‚</span>';
        }
        html += '</p></div>';

        html += '</div>';
        document.getElementById('multi-conclusion').innerHTML = html;
    }

    // ========================================
    //   Single Interval Detail (existing)
    // ========================================
    let btData = null;

    async function loadBacktestData() {
        if (window._backtestLoaded) return;
        try {
            const resp = await fetch('/api/backtest');
            if (!resp.ok) throw new Error('No data');
            btData = await resp.json();
            window._backtestLoaded = true;
            renderSummary();
            renderEquityChart();
            renderKlineChart();
            renderTrades();
        } catch (e) {
            ['summary-loading','chart-loading','trades-loading'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<span style="color:var(--accent-red)">æœªæ‰¾åˆ°å›æµ‹æ•°æ®ã€‚è¯·å…ˆè¿è¡Œ: python backtest.py</span>';
            });
        }
    }

    function renderSummary() {
        const s = btData.summary;
        document.getElementById('summary-loading').style.display = 'none';
        document.getElementById('summary-content').style.display = 'block';

        const statsHtml = [
            {label: 'ç­–ç•¥æ”¶ç›Š', value: s.total_return + '%', cls: s.total_return >= 0 ? 'positive' : 'negative'},
            {label: 'ä¹°å…¥æŒæœ‰æ”¶ç›Š', value: s.buy_hold_return + '%', cls: s.buy_hold_return >= 0 ? 'positive' : 'negative'},
            {label: 'æœ€ç»ˆèµ„é‡‘', value: '$' + s.final_equity.toLocaleString(), cls: s.final_equity >= s.initial_capital ? 'positive' : 'negative'},
            {label: 'æœ€å¤§å›æ’¤', value: s.max_drawdown + '%', cls: 'negative'},
            {label: 'äº¤æ˜“æ¬¡æ•°', value: s.total_trades, cls: ''},
            {label: 'èƒœç‡', value: s.win_rate + '%', cls: s.win_rate >= 50 ? 'positive' : 'negative', note: s.win_count + 'èƒœ / ' + s.lose_count + 'è´Ÿ'},
            {label: 'å¹³å‡ç›ˆåˆ©', value: '+' + s.avg_win_pct + '%', cls: 'positive'},
            {label: 'å¹³å‡äºæŸ', value: s.avg_loss_pct + '%', cls: 'negative'},
            {label: 'Sharpeæ¯”ç‡', value: s.sharpe_ratio, cls: s.sharpe_ratio >= 0 ? 'positive' : 'negative'},
            {label: 'å›æµ‹å¤©æ•°', value: s.total_days + 'å¤©', cls: ''},
        ].map(item => `
            <div class="stat-card">
                <div class="stat-label">${item.label}</div>
                <div class="stat-value ${item.cls}">${item.value}</div>
                ${item.note ? '<div class="stat-note">' + item.note + '</div>' : ''}
            </div>
        `).join('');
        document.getElementById('stats-grid').innerHTML = statsHtml;
    }

    function renderEquityChart() {
        const container = document.getElementById('equity-chart');
        if (!btData || !btData.equity_curve || !btData.equity_curve.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 300,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const equitySeries = chart.addLineSeries({ color: '#4a9eff', lineWidth: 2, title: 'ç­–ç•¥å‡€å€¼' });
        equitySeries.setData(btData.equity_curve.map(e => ({
            time: Math.floor(new Date(e.date).getTime() / 1000), value: e.equity,
        })));

        if (btData.kline_data && btData.kline_data.length > 0) {
            const baseline = chart.addLineSeries({ color: '#5c6078', lineWidth: 1, lineStyle: 2, title: 'ä¹°å…¥æŒæœ‰' });
            const fp = btData.kline_data[0].close;
            const ic = btData.summary.initial_capital;
            baseline.setData(btData.kline_data.map(k => ({
                time: Math.floor(new Date(k.date).getTime() / 1000), value: ic * (k.close / fp),
            })));
        }
        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderKlineChart() {
        const container = document.getElementById('kline-chart');
        document.getElementById('chart-loading').style.display = 'none';
        document.getElementById('chart-content').style.display = 'block';
        if (!btData || !btData.kline_data || !btData.kline_data.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 400,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const cs = chart.addCandlestickSeries({
            upColor: '#00d68f', downColor: '#ff4d6a',
            borderUpColor: '#00d68f', borderDownColor: '#ff4d6a',
            wickUpColor: '#00d68f', wickDownColor: '#ff4d6a',
        });
        cs.setData(btData.kline_data.map(k => ({
            time: Math.floor(new Date(k.date).getTime() / 1000),
            open: k.open, high: k.high, low: k.low, close: k.close,
        })));

        if (btData.signals && btData.signals.length > 0) {
            cs.setMarkers(btData.signals.map(s => ({
                time: Math.floor(new Date(s.date).getTime() / 1000),
                position: s.signal === 'BUY' ? 'belowBar' : 'aboveBar',
                color: s.signal === 'BUY' ? '#00d68f' : '#ff4d6a',
                shape: s.signal === 'BUY' ? 'arrowUp' : 'arrowDown',
                text: s.signal === 'BUY' ? 'B' : 'S',
            })));
        }

        const vs = chart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'vol' });
        chart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.85, bottom: 0 } });
        vs.setData(btData.kline_data.map(k => ({
            time: Math.floor(new Date(k.date).getTime() / 1000), value: k.volume,
            color: k.close >= k.open ? 'rgba(0,214,143,0.3)' : 'rgba(255,77,106,0.3)',
        })));

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderTrades() {
        document.getElementById('trades-loading').style.display = 'none';
        document.getElementById('trades-content').style.display = 'block';
        if (!btData || !btData.completed_trades) return;

        const trades = btData.completed_trades;
        const totalPnl = trades.reduce((s, t) => s + t.pnl, 0);
        const best = trades.length ? trades.reduce((b, t) => t.pnl_pct > b.pnl_pct ? t : b, trades[0]) : {pnl_pct:0};
        const worst = trades.length ? trades.reduce((w, t) => t.pnl_pct < w.pnl_pct ? t : w, trades[0]) : {pnl_pct:0};

        document.getElementById('trade-stats').innerHTML = [
            {label:'æ€»ç›ˆäº', value:'$'+totalPnl.toFixed(2), cls:totalPnl>=0?'positive':'negative'},
            {label:'æœ€ä½³äº¤æ˜“', value:'+'+(best.pnl_pct||0).toFixed(2)+'%', cls:'positive'},
            {label:'æœ€å·®äº¤æ˜“', value:(worst.pnl_pct||0).toFixed(2)+'%', cls:'negative'},
            {label:'å®Œæˆäº¤æ˜“', value:trades.length, cls:''},
        ].map(item=>`<div class="stat-card"><div class="stat-label">${item.label}</div><div class="stat-value ${item.cls}">${item.value}</div></div>`).join('');

        document.querySelector('#trades-table tbody').innerHTML = trades.map((t,i)=>`
            <tr>
                <td>${i+1}</td>
                <td>${fmtDate(t.buy_date)}</td><td>$${t.buy_price.toFixed(2)}</td>
                <td>${fmtDate(t.sell_date)}</td><td>$${t.sell_price.toFixed(2)}</td>
                <td class="${t.pnl>=0?'pnl-pos':'pnl-neg'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</td>
                <td class="${t.pnl_pct>=0?'pnl-pos':'pnl-neg'}">${t.pnl_pct>=0?'+':''}${t.pnl_pct.toFixed(2)}%</td>
                <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.buy_reason||''}">${t.buy_reason||'-'}</td>
                <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.sell_reason||''}">${t.sell_reason||'-'}</td>
            </tr>`).join('');
    }

    function fmtDate(s) {
        if (!s) return '-';
        const d = new Date(s);
        return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // ===================== åˆçº¦åšç©ºç­–ç•¥ =====================
    async function loadFuturesStrategy() {
        try {
            const res = await fetch('/api/strategy_futures');
            if (!res.ok) throw new Error('æ— æ•°æ®');
            const data = await res.json();
            window._ftLoaded = true;
            renderFuturesPage(data);
        } catch (e) {
            document.getElementById('ft-intro').innerHTML += `<p style="color:var(--accent-red);margin-top:12px;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
        }
    }

    function renderFuturesPage(data) {
        const results = data.futures_results || [];
        const sorted = [...results].sort((a, b) => (b.summary?.alpha || 0) - (a.summary?.alpha || 0));

        renderFTCards(sorted);
        renderFTBarChart(sorted);
        renderFTTable(sorted);
        renderFTEquity(results);
        renderFTTrades(sorted[0]); // best strategy
        renderFTConclusion(sorted, data.best_strategy);
    }

    function renderFTCards(sorted) {
        const descs = {
            'å¯¹ç…§': { icon: 'ğŸ“¦', color: 'var(--text-muted)', desc: 'çº¯ç°è´§é‡ä»·ç¡®è®¤ç­–ç•¥,ä¸ä½¿ç”¨åˆçº¦' },
            'M': { icon: 'ğŸ›¡ï¸', color: 'var(--accent-blue)', desc: 'æŒæœ‰ç°è´§ETH,é¡¶èƒŒç¦»å¼€ç©ºå¤´å¯¹å†²ä¸‹è·Œ' },
            'N': { icon: 'âš¡', color: 'var(--accent-purple)', desc: 'çº¯åˆçº¦åŒå‘äº¤æ˜“,ä¸æŒæœ‰ç°è´§' },
            'O': { icon: 'ğŸš€', color: 'var(--accent-green)', desc: 'ç°è´§+åˆçº¦å¢å¼º,å‡ä»“åŒæ—¶å¼€ç©º' },
            'P': { icon: 'ğŸ¯', color: 'var(--accent-yellow)', desc: 'ä¿¡å·å¼ºåº¦å†³å®šæ æ†å€æ•°å’Œä»“ä½æ–¹å‘' },
            'Q': { icon: 'ğŸ“Š', color: 'var(--accent-red)', desc: 'é‡ä»·ç¡®è®¤+åˆçº¦,ä»·å‡é‡å‡å¼€ç©º' },
        };
        const box = document.getElementById('ft-strategy-cards');
        box.innerHTML = sorted.map((r, i) => {
            const s = r.summary;
            const key = r.name.split(':')[0].replace('å¯¹ç…§', 'å¯¹ç…§');
            const d = descs[key] || descs['å¯¹ç…§'];
            const isTop = i === 0;
            return `<div style="background:var(--bg-hover);border-radius:10px;padding:14px;${isTop ? 'border:1.5px solid var(--accent-green);' : ''}">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:22px;">${d.icon}</span>
                    <span style="font-weight:700;font-size:14px;color:${d.color};">${r.name}${isTop ? ' â˜…' : ''}</span>
                </div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${d.desc}</div>
                <div style="display:flex;gap:14px;font-size:13px;">
                    <span style="color:${s.alpha > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${s.alpha > 0 ? '+' : ''}${s.alpha}% Î±</span>
                    <span style="color:var(--text-muted);">${s.max_drawdown}% DD</span>
                    <span style="color:var(--text-muted);">${s.total_trades}ç¬”</span>
                    ${s.liquidations > 0 ? `<span style="color:var(--accent-red);">å¼ºå¹³${s.liquidations}</span>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    function renderFTBarChart(sorted) {
        const container = document.getElementById('ft-bar-chart');
        const barW = Math.floor((container.clientWidth - 80) / sorted.length);
        const maxVal = Math.max(...sorted.map(r => Math.abs(r.summary?.alpha || 0)), 10);
        const scale = 280 / maxVal;

        let html = `<svg width="100%" height="350" viewBox="0 0 ${container.clientWidth} 350">`;
        sorted.forEach((r, i) => {
            const s = r.summary;
            const alpha = s?.alpha || 0;
            const ret = s?.strategy_return || 0;
            const x = 50 + i * barW;
            const barH = Math.abs(alpha) * scale;
            const y = alpha >= 0 ? (300 - barH) : 300;
            const color = alpha >= 0 ? '#00d68f' : '#ff4d6a';
            const retH = Math.max(Math.abs(ret) * scale * 0.3, 2);
            const retY = ret >= 0 ? (300 - retH) : 300;
            const retColor = ret >= 0 ? 'rgba(74,158,255,0.6)' : 'rgba(255,77,106,0.4)';

            html += `<rect x="${x}" y="${y}" width="${barW * 0.35}" height="${barH}" fill="${color}" rx="3"/>`;
            html += `<rect x="${x + barW * 0.4}" y="${retY}" width="${barW * 0.35}" height="${retH}" fill="${retColor}" rx="3"/>`;
            html += `<text x="${x + barW * 0.37}" y="${Math.min(y, retY) - 6}" text-anchor="middle" fill="${color}" font-size="11" font-weight="700">${alpha > 0 ? '+' : ''}${alpha.toFixed(1)}%</text>`;
            html += `<text x="${x + barW * 0.37}" y="325" text-anchor="middle" fill="#8b8fa3" font-size="10" transform="rotate(-15,${x + barW * 0.37},325)">${r.name.split(':')[0]}</text>`;
        });
        html += `<line x1="48" y1="300" x2="${container.clientWidth}" y2="300" stroke="#2a2d3e" stroke-width="1"/>`;
        html += `<text x="14" y="304" fill="#5c6078" font-size="10">0%</text>`;
        html += `</svg>`;
        html += `<div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:12px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:#00d68f;border-radius:2px;margin-right:4px;"></span>è¶…é¢æ”¶ç›Š(Î±)</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:rgba(74,158,255,0.6);border-radius:2px;margin-right:4px;"></span>ç­–ç•¥æ”¶ç›Š</span>
        </div>`;
        container.innerHTML = html;
    }

    function renderFTTable(sorted) {
        const head = document.getElementById('ft-table-head');
        const body = document.getElementById('ft-table-body');
        head.innerHTML = `<th>#</th><th>ç­–ç•¥</th><th>ç­–ç•¥æ”¶ç›Š</th><th>ä¹°å…¥æŒæœ‰</th><th>è¶…é¢æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>äº¤æ˜“æ•°</th><th>å¼ºå¹³</th><th>æœ€ç»ˆèµ„äº§</th>`;

        body.innerHTML = sorted.map((r, i) => {
            const s = r.summary;
            const cls = i === 0 ? 'style="background:rgba(0,214,143,0.08);"' : '';
            return `<tr ${cls}>
                <td>${i + 1}</td>
                <td><b>${r.name}</b>${i === 0 ? ' â˜…' : ''}</td>
                <td style="color:${s.strategy_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${s.strategy_return > 0 ? '+' : ''}${s.strategy_return}%</td>
                <td>${s.buy_hold_return > 0 ? '+' : ''}${s.buy_hold_return}%</td>
                <td style="color:${s.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight:700;">${s.alpha > 0 ? '+' : ''}${s.alpha}%</td>
                <td>${s.max_drawdown}%</td>
                <td>${s.total_trades}</td>
                <td style="color:${s.liquidations > 0 ? 'var(--accent-red)' : 'var(--text-muted)'}">${s.liquidations}</td>
                <td>$${Number(s.final_total).toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    function renderFTEquity(results) {
        const container = document.getElementById('ft-equity-chart');
        container.innerHTML = '';
        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 400,
            layout: { background: { type: 'solid', color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            rightPriceScale: { borderColor: '#2a2d3e' },
            timeScale: { borderColor: '#2a2d3e', timeVisible: true },
        });

        const colors = ['#00d68f', '#4a9eff', '#a855f7', '#ffaa00', '#ff4d6a', '#8b8fa3'];
        results.forEach((r, i) => {
            if (!r.history || r.history.length === 0) return;
            const series = chart.addLineSeries({
                color: colors[i % colors.length],
                lineWidth: r.name.includes('â˜…') || i === 0 ? 2.5 : 1.5,
                title: r.name.split(':')[0].trim(),
            });
            const lineData = r.history.map(h => ({
                time: Math.floor(new Date(h.time).getTime() / 1000),
                value: h.total,
            }));
            series.setData(lineData);
        });
        chart.timeScale().fitContent();
    }

    function renderFTTrades(bestResult) {
        if (!bestResult || !bestResult.trades) return;
        const trades = bestResult.trades;
        document.getElementById('ft-trade-count').textContent = `${trades.length} ç¬”äº¤æ˜“`;
        const body = document.getElementById('ft-trades-body');

        const actionColors = {
            'SPOT_BUY': 'var(--accent-green)',
            'SPOT_SELL': 'var(--accent-red)',
            'OPEN_LONG': 'var(--accent-blue)',
            'CLOSE_LONG': 'var(--accent-purple)',
            'OPEN_SHORT': 'var(--accent-red)',
            'CLOSE_SHORT': 'var(--accent-green)',
            'LIQUIDATED': '#ff0000',
        };
        const actionLabels = {
            'SPOT_BUY': 'ç°è´§ä¹°å…¥',
            'SPOT_SELL': 'ç°è´§å–å‡º',
            'OPEN_LONG': 'å¼€å¤š',
            'CLOSE_LONG': 'å¹³å¤š',
            'OPEN_SHORT': 'å¼€ç©º',
            'CLOSE_SHORT': 'å¹³ç©º',
            'LIQUIDATED': 'å¼ºå¹³',
        };

        body.innerHTML = trades.map((t, i) => {
            const c = actionColors[t.action] || 'var(--text-primary)';
            const label = actionLabels[t.action] || t.action;
            return `<tr>
                <td>${i + 1}</td>
                <td>${fmtDate(t.time)}</td>
                <td style="color:${c};font-weight:700;">${label}</td>
                <td>${t.direction === 'long' ? 'ğŸ“ˆå¤š' : 'ğŸ“‰ç©º'}</td>
                <td>$${t.price.toLocaleString()}</td>
                <td>${t.quantity.toFixed(4)}</td>
                <td>$${Number(t.value).toLocaleString()}</td>
                <td>${t.leverage}x</td>
                <td>$${Number(t.usdt_after).toLocaleString()}</td>
                <td>$${Number(t.frozen_margin).toLocaleString()}</td>
                <td style="font-weight:600;">$${Number(t.total).toLocaleString()}</td>
                <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;">${t.reason}</td>
            </tr>`;
        }).join('');
    }

    function renderFTConclusion(sorted, bestName) {
        const best = sorted[0]?.summary;
        const baseline = sorted.find(r => r.name.includes('å¯¹ç…§'))?.summary;
        if (!best) return;

        const box = document.getElementById('ft-conclusion');
        box.innerHTML = `
            <div class="card-title">åˆçº¦ç­–ç•¥åˆ†æç»“è®º</div>
            <div style="line-height:2;font-size:14px;color:var(--text-secondary);">
                <p><b style="color:var(--accent-green);font-size:16px;">ğŸ† æœ€ä½³ç­–ç•¥: ${sorted[0].name}</b></p>
                <p style="margin-top:8px;">
                    ç­–ç•¥æ”¶ç›Š <b style="color:var(--accent-green);">${best.strategy_return > 0 ? '+' : ''}${best.strategy_return}%</b>
                    | è¶…é¢æ”¶ç›Š(Î±) <b style="color:var(--accent-green);">${best.alpha > 0 ? '+' : ''}${best.alpha}%</b>
                    | æœ€å¤§å›æ’¤ <b>${best.max_drawdown}%</b>
                    | æœ€ç»ˆèµ„äº§ <b>$${Number(best.final_total).toLocaleString()}</b>
                </p>
                <p style="margin-top:10px;">
                    <b>å¯¹ç…§ç»„(çº¯ç°è´§):</b>
                    æ”¶ç›Š ${baseline?.strategy_return > 0 ? '+' : ''}${baseline?.strategy_return}%
                    | è¶…é¢ ${baseline?.alpha > 0 ? '+' : ''}${baseline?.alpha}%
                    | å›æ’¤ ${baseline?.max_drawdown}%
                </p>
                <div style="margin-top:16px;padding:14px;background:var(--bg-hover);border-radius:8px;border-left:3px solid var(--accent-blue);">
                    <b style="color:var(--accent-blue);">å…³é”®å‘ç°:</b><br>
                    <span>1. åšç©ºèƒ½åŠ›æ˜¾è‘—æå‡äº†ç­–ç•¥åœ¨ä¸‹è·Œå¸‚ä¸­çš„è¡¨ç°ï¼Œè¶…é¢ä»çº¯ç°è´§çš„ +${baseline?.alpha}% æå‡åˆ° +${best.alpha}%</span><br>
                    <span>2. ${sorted[0].name} é€šè¿‡${sorted[0].name.includes('è‡ªé€‚åº”') ? 'æ ¹æ®ä¿¡å·å¼ºåº¦åŠ¨æ€è°ƒæ•´æ æ†' : 'çµæ´»çš„å¤šç©ºåˆ‡æ¢'}å®ç°æœ€ä¼˜é£é™©æ”¶ç›Šæ¯”</span><br>
                    <span>3. åˆçº¦ä¿è¯é‡‘ä¸Šé™(10%)å’Œç»ˆèº«ååé™åˆ¶(150%)æœ‰æ•ˆé˜²æ­¢è¿‡åº¦æ æ†åŒ–</span><br>
                    <span>4. ${best.liquidations === 0 ? 'æ‰€æœ‰ç­–ç•¥å‡æœªè§¦å‘å¼ºåˆ¶å¹³ä»“' : `å­˜åœ¨${best.liquidations}æ¬¡å¼ºå¹³`}ï¼Œè¯´æ˜é£æ§å‚æ•°è®¾ç½®åˆç†</span><br>
                    <span>5. ç°è´§æ¸è¿›å‡ä»“ + åˆçº¦åšç©ºçš„ç»„åˆæ–¹å¼ï¼Œæ¯”çº¯åšç©ºæˆ–çº¯ç°è´§æ›´ç¨³å¥</span>
                </div>
            </div>`;
    }
    </script>
</body>
</html>
