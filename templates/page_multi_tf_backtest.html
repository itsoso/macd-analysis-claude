{% extends "base.html" %}
{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­–å›æµ‹ â€” åŠ æƒå…±è¯† + å…±æŒ¯é“¾{% endblock %}
{% block content %}
<h1 class="page-title">å¤šå‘¨æœŸè”åˆå†³ç­–å›æµ‹</h1>
<p class="page-subtitle">åŠ æƒå…±è¯† + å…±æŒ¯é“¾æ£€æµ‹ + å¤§å°å‘¨æœŸå®šè°ƒ Â· å¤šç§TFç»„åˆæ–¹æ¡ˆ Ã— å¤šä¸ªä¸»æ—¶é—´æ¡†æ¶</p>

<div id="mtf-loading" class="loading">
    <div class="spinner"></div> åŠ è½½å¤šå‘¨æœŸè”åˆå†³ç­–å›æµ‹ç»“æœ...
</div>

<div id="mtf-content" style="display:none;">

<!-- æ ¸å¿ƒå¯¹æ¯”å¡ç‰‡ -->
<div class="stats-grid" id="mtf-hero"></div>

<!-- å•TFæœ€ä¼˜ vs å¤šTFæœ€ä¼˜ å¯¹æ¯” -->
<div class="card" style="border-left: 4px solid var(--accent-blue);">
    <div class="card-title">ğŸ†š å•å‘¨æœŸæœ€ä¼˜ vs å¤šå‘¨æœŸè”åˆå†³ç­–æœ€ä¼˜</div>
    <div id="mtf-vs"></div>
</div>

<!-- ç®—æ³•è¯´æ˜ -->
<div class="card">
    <div class="card-title">ğŸ§  å¤šå‘¨æœŸè”åˆå†³ç­–ç®—æ³•</div>
    <div class="algo-grid">
        <div class="algo-card">
            <div class="algo-icon">âš–ï¸</div>
            <div class="algo-title">åŠ æƒå…±è¯†</div>
            <div class="algo-desc">å¤§å‘¨æœŸæƒé‡è¿œé«˜äºå°å‘¨æœŸ<br>24h=28, 4h=15, 1h=8, 15m=3<br>å½’ä¸€åŒ–å¾—åˆ† 0~100</div>
        </div>
        <div class="algo-card">
            <div class="algo-icon">ğŸ”—</div>
            <div class="algo-title">å…±æŒ¯é“¾æ£€æµ‹</div>
            <div class="algo-desc">æ‰«æç›¸é‚»TFè¿ç»­åŒå‘é“¾<br>å¦‚ 1hâ†’4hâ†’8hâ†’12h<br>â‰¥3çº§ä¸”å«4h+æ—¶å¢å¼ºä¿¡å·</div>
        </div>
        <div class="algo-card">
            <div class="algo-icon">ğŸ”ï¸</div>
            <div class="algo-title">å¤§å‘¨æœŸå®šè°ƒ</div>
            <div class="algo-desc">â‰¥4h çš„å‘¨æœŸå•ç‹¬ç»Ÿè®¡<br>ä½œä¸ºè¶‹åŠ¿æ–¹å‘åŸºè°ƒ<br>å¤§å°åå‘æ—¶ä¿¡å·è¡°å‡50%</div>
        </div>
        <div class="algo-card">
            <div class="algo-icon">ğŸ“Š</div>
            <div class="algo-title">å†³ç­–çŸ©é˜µ</div>
            <div class="algo-desc">å¤§å°åŒå‘+å…±æŒ¯é“¾ â†’ å¢å¼º<br>å¤§å°åå‘ â†’ è¡°å‡<br>ç»¼åˆå¾—åˆ†é©±åŠ¨å¼€ä»“/å¹³ä»“</div>
        </div>
    </div>
</div>

<!-- å…¨éƒ¨å¤šTFç»„åˆç»“æœè¡¨ -->
<div class="card">
    <div class="card-title">ğŸ“‹ å…¨éƒ¨å¤šå‘¨æœŸç»„åˆå›æµ‹ç»“æœ</div>
    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">
        6ç§TFç»„åˆæ–¹æ¡ˆ Ã— 3ä¸ªä¸»æ—¶é—´æ¡†æ¶ = 18ç§é…ç½®ï¼ŒæŒ‰Alphaæ’åº
    </p>
    <div style="overflow-x:auto;">
        <table class="data-table" id="mtf-table">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>ç»„åˆæ–¹æ¡ˆ</th>
                    <th>ä¸»TF</th>
                    <th>å‚ä¸å‘¨æœŸ</th>
                    <th>Alpha (Î±)</th>
                    <th>ç­–ç•¥æ”¶ç›Š</th>
                    <th>ä¹°æŒæ”¶ç›Š</th>
                    <th>æœ€å¤§å›æ’¤</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                    <th>vs å•TF</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- å„ä¸»TFå¯¹æ¯”æŸ±çŠ¶å›¾ -->
<div class="card">
    <div class="card-title">ğŸ“Š å„ä¸»æ—¶é—´æ¡†æ¶ Alpha å¯¹æ¯”</div>
    <div id="mtf-chart"></div>
</div>

<!-- æ–¹æ¡ˆåˆ†æ -->
<div class="card" style="border-left: 4px solid var(--accent-green);">
    <div class="card-title">ğŸ’¡ æ–¹æ¡ˆåˆ†æä¸å»ºè®®</div>
    <div id="mtf-analysis"></div>
</div>

<!-- æƒé‡è¡¨ -->
<div class="card">
    <div class="card-title">ğŸ“ å„æ—¶é—´æ¡†æ¶æƒé‡é…ç½®</div>
    <div id="mtf-weights"></div>
</div>

<!-- å•TFåŸºå‡†å¯¹æ¯” -->
<div class="card">
    <div class="card-title">ğŸ“Š å•å‘¨æœŸåŸºå‡†æ€§èƒ½ (ä½œä¸ºå¯¹æ¯”åŸºçº¿)</div>
    <div style="overflow-x:auto;">
        <table class="data-table" id="baseline-table">
            <thead>
                <tr>
                    <th>æ—¶é—´æ¡†æ¶</th>
                    <th>Alpha (Î±)</th>
                    <th>ç­–ç•¥æ”¶ç›Š</th>
                    <th>ä¹°æŒæ”¶ç›Š</th>
                    <th>æœ€å¤§å›æ’¤</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

</div>

<style>
.algo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 12px;
}
.algo-card {
    background: var(--bg-hover);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border: 1px solid var(--border-subtle);
    transition: transform 0.2s, box-shadow 0.2s;
}
.algo-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.algo-icon { font-size: 2em; margin-bottom: 8px; }
.algo-title { font-weight: 700; font-size: 1.05em; margin-bottom: 6px; }
.algo-desc { font-size: 0.82em; color: var(--text-secondary); line-height: 1.7; }

.vs-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 20px;
    align-items: center;
    margin: 20px 0;
}
.vs-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    border: 2px solid var(--border-subtle);
}
.vs-card.single { border-color: #888; }
.vs-card.multi { border-color: var(--accent-blue); box-shadow: 0 0 20px rgba(74,158,255,0.15); }
.vs-arrow { font-size: 2em; color: var(--accent-blue); font-weight: bold; }
.vs-label { font-size: 0.85em; color: var(--text-dim); margin-bottom: 8px; }
.vs-alpha { font-size: 2em; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
.vs-detail { margin-top: 12px; font-size: 0.85em; color: var(--text-secondary); line-height: 1.8; }
.improvement-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1em;
    margin-top: 10px;
}
.improvement-badge.positive { background: linear-gradient(135deg, #00d68f, #00b077); color: #000; }
.improvement-badge.negative { background: rgba(255,255,255,0.1); color: var(--text-secondary); }

.bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 0.9em;
}
.bar-label {
    min-width: 180px;
    text-align: right;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.85em;
}
.bar-track {
    flex: 1;
    height: 22px;
    background: rgba(255,255,255,0.04);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}
.bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    padding-left: 8px;
    font-size: 0.78em;
    font-weight: 700;
    color: #000;
    white-space: nowrap;
}
.bar-fill.green { background: linear-gradient(90deg, #00d68f, #00ff99); }
.bar-fill.blue { background: linear-gradient(90deg, #4a9eff, #6bb3ff); }
.bar-fill.orange { background: linear-gradient(90deg, #ffaa00, #ffcc44); }
.bar-fill.red { background: linear-gradient(90deg, #ff4d6a, #ff6b8a); }

.weight-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    margin-top: 12px;
}
.weight-item {
    text-align: center;
    padding: 12px 8px;
    border-radius: 8px;
    background: var(--bg-hover);
    border: 1px solid var(--border-subtle);
}
.weight-tf { font-weight: 700; font-size: 1em; }
.weight-val { font-size: 0.85em; color: var(--text-secondary); margin-top: 4px; }
.weight-bar {
    height: 4px;
    border-radius: 2px;
    margin-top: 6px;
    background: rgba(255,255,255,0.08);
}
.weight-bar-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--accent-blue);
}

.analysis-item {
    padding: 12px 16px;
    background: var(--bg-hover);
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 3px solid var(--accent-blue);
    font-size: 0.92em;
    line-height: 1.7;
    color: var(--text-secondary);
}
.analysis-item strong { color: var(--text-primary); }

@media (max-width: 768px) {
    .vs-grid { grid-template-columns: 1fr; }
    .vs-arrow { transform: rotate(90deg); text-align: center; }
    .algo-grid { grid-template-columns: 1fr 1fr; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const resp = await fetch('/api/optimize_six_book');
        if (!resp.ok) throw new Error('APIè¿”å›é”™è¯¯');
        const data = await resp.json();
        renderMultiTF(data);
    } catch(e) {
        document.getElementById('mtf-loading').innerHTML =
            '<p style="color:var(--accent-red)">åŠ è½½å¤±è´¥: ' + e.message +
            '<br><small>è¯·å…ˆè¿è¡Œ python optimize_six_book.py ç”Ÿæˆå›æµ‹æ•°æ®</small></p>';
    }
});

function renderMultiTF(data) {
    document.getElementById('mtf-loading').style.display = 'none';
    document.getElementById('mtf-content').style.display = 'block';

    const multiResults = data.multi_tf_results || [];
    const multiBest = data.multi_tf_best || {};
    const singleBest = data.global_best || {};
    const baselines = data.baseline_by_tf || [];
    const singleAlpha = singleBest.alpha || 0;

    if (multiResults.length === 0) {
        document.getElementById('mtf-content').innerHTML =
            '<div class="card"><p style="color:var(--text-secondary);text-align:center;padding:40px;">æš‚æ— å¤šå‘¨æœŸè”åˆå†³ç­–å›æµ‹æ•°æ®ã€‚è¯·é‡æ–°è¿è¡Œ optimize_six_book.py ä»¥ç”Ÿæˆ Phase E æ•°æ®ã€‚</p></div>';
        return;
    }

    // â•â•â• Hero Stats â•â•â•
    const vs = (multiBest.alpha || 0) - singleAlpha;
    const multiWin = vs > 0;
    document.getElementById('mtf-hero').innerHTML = `
        <div class="stat-card">
            <div class="stat-label">ğŸ† å¤šå‘¨æœŸæœ€ä¼˜ Alpha</div>
            <div class="stat-value" style="color:var(--accent-blue);font-size:1.8em;">+${(multiBest.alpha||0).toFixed(2)}%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“ æœ€ä¼˜æ–¹æ¡ˆ</div>
            <div class="stat-value" style="font-size:1.1em;">${multiBest.combo_name || '-'} @ ${multiBest.primary_tf || '-'}</div>
        </div>
        <div class="stat-card ${multiWin ? 'positive' : ''}">
            <div class="stat-label">vs å•TFæœ€ä¼˜ (${singleBest.tf || '?'} +${singleAlpha.toFixed(1)}%)</div>
            <div class="stat-value" style="color:${vs >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                ${vs >= 0 ? '+' : ''}${vs.toFixed(2)}%
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“‰ æœ€ä¼˜å›æ’¤</div>
            <div class="stat-value" style="color:var(--accent-red);">${(multiBest.max_drawdown||0).toFixed(2)}%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ”„ äº¤æ˜“æ¬¡æ•°</div>
            <div class="stat-value">${multiBest.total_trades || 0}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“Š å‚ä¸å‘¨æœŸ</div>
            <div class="stat-value" style="font-size:0.95em;">${(multiBest.decision_tfs || []).join(', ')}</div>
        </div>
    `;

    // â•â•â• VS comparison â•â•â•
    document.getElementById('mtf-vs').innerHTML = `
        <div class="vs-grid">
            <div class="vs-card single">
                <div class="vs-label">å•å‘¨æœŸæœ€ä¼˜ (${singleBest.tf || '-'})</div>
                <div class="vs-alpha" style="color:var(--accent-green);">+${singleAlpha.toFixed(2)}%</div>
                <div class="vs-detail">
                    å‚æ•°: ${singleBest.tag || '-'}<br>
                    ç­–ç•¥æ”¶ç›Š: +${(singleBest.strategy_return||0).toFixed(2)}%<br>
                    å›æ’¤: ${(singleBest.max_drawdown||0).toFixed(2)}%<br>
                    äº¤æ˜“: ${singleBest.total_trades||0}æ¬¡
                </div>
            </div>
            <div class="vs-arrow">â†’</div>
            <div class="vs-card multi">
                <div class="vs-label">å¤šå‘¨æœŸè”åˆå†³ç­– (${multiBest.combo_name||'-'} @ ${multiBest.primary_tf||'-'})</div>
                <div class="vs-alpha" style="color:var(--accent-blue);">+${(multiBest.alpha||0).toFixed(2)}%</div>
                <div class="vs-detail">
                    å‚ä¸TFs: ${(multiBest.decision_tfs||[]).join(', ')}<br>
                    ç­–ç•¥æ”¶ç›Š: +${(multiBest.strategy_return||0).toFixed(2)}%<br>
                    å›æ’¤: ${(multiBest.max_drawdown||0).toFixed(2)}%<br>
                    äº¤æ˜“: ${multiBest.total_trades||0}æ¬¡
                </div>
                <div class="improvement-badge ${vs >= 0 ? 'positive' : 'negative'}">
                    ${vs >= 0 ? 'å¤šå‘¨æœŸæ›´ä¼˜ +' : ''}${vs.toFixed(2)}%
                    ${vs < 0 ? ' Â· ä½†å›æ’¤æ›´ä½æ›´ç¨³å¥' : ''}
                </div>
            </div>
        </div>

        <div style="margin-top:16px;padding:14px 18px;background:var(--bg-hover);border-radius:10px;font-size:0.88em;color:var(--text-secondary);line-height:1.8;">
            <strong style="color:var(--text-primary);">æ ¸å¿ƒå·®å¼‚:</strong><br>
            ğŸ“Š äº¤æ˜“é¢‘ç‡: å•TF ${singleBest.total_trades||0}æ¬¡ â†’ å¤šTF ${multiBest.total_trades||0}æ¬¡
            (${multiBest.total_trades < singleBest.total_trades ? 'å‡å°‘' + Math.round((1 - multiBest.total_trades / singleBest.total_trades) * 100) + '%' : 'å¢åŠ '})<br>
            ğŸ“‰ æœ€å¤§å›æ’¤: ${(singleBest.max_drawdown||0).toFixed(2)}% â†’ ${(multiBest.max_drawdown||0).toFixed(2)}%
            (${Math.abs(multiBest.max_drawdown) < Math.abs(singleBest.max_drawdown) ? 'âœ… æ›´ç¨³å¥' : 'å›æ’¤ç•¥å¢'})<br>
            ğŸ’¡ å¤šå‘¨æœŸå…±è¯†é€šè¿‡è¿‡æ»¤å™ªéŸ³ä¿¡å·æé«˜äº†æ¯ç¬”äº¤æ˜“çš„è´¨é‡ï¼Œé€‚åˆå®ç›˜é£æ§æ›´ä¸¥æ ¼çš„åœºæ™¯
        </div>
    `;

    // â•â•â• Results table â•â•â•
    const tbody = document.querySelector('#mtf-table tbody');
    multiResults.forEach((r, i) => {
        const tr = document.createElement('tr');
        const vsVal = r.alpha - singleAlpha;
        const isBest = i < 3;
        if (isBest) tr.style.background = 'rgba(74,158,255,0.06)';
        const star = i === 0 ? ' ğŸ†' : i < 3 ? ' â­' : '';
        tr.innerHTML = `
            <td style="font-weight:700;">#${r.rank}${star}</td>
            <td style="font-weight:600;">${r.combo_name}</td>
            <td><code>${r.primary_tf}</code></td>
            <td style="font-size:0.82em;max-width:200px;color:var(--text-secondary);">${(r.decision_tfs||[]).join(', ')}</td>
            <td style="color:var(--accent-green);font-weight:700;">+${r.alpha.toFixed(2)}%</td>
            <td>+${r.strategy_return.toFixed(2)}%</td>
            <td>${(r.buy_hold_return||0).toFixed(2)}%</td>
            <td style="color:var(--accent-red);">${r.max_drawdown.toFixed(2)}%</td>
            <td>${r.total_trades}</td>
            <td style="color:${vsVal >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};font-weight:600;">
                ${vsVal >= 0 ? '+' : ''}${vsVal.toFixed(2)}%
            </td>
        `;
        tbody.appendChild(tr);
    });

    // â•â•â• Bar chart â•â•â•
    const maxAlpha = Math.max(...multiResults.map(r => r.alpha), singleAlpha);
    const colors = ['green', 'blue', 'orange'];
    let chartHtml = '';

    // Add single TF baseline
    const singlePct = Math.max(5, (singleAlpha / maxAlpha) * 100);
    chartHtml += `<div class="bar-row">
        <span class="bar-label">ğŸ… å•TFæœ€ä¼˜ (${singleBest.tf})</span>
        <div class="bar-track">
            <div class="bar-fill red" style="width:${singlePct}%">+${singleAlpha.toFixed(1)}%</div>
        </div>
    </div>`;
    chartHtml += '<div style="height:8px;"></div>';

    // Group by combo_name
    const comboGroups = {};
    multiResults.forEach(r => {
        if (!comboGroups[r.combo_name]) comboGroups[r.combo_name] = [];
        comboGroups[r.combo_name].push(r);
    });

    Object.entries(comboGroups).forEach(([name, items]) => {
        items.forEach((r, ci) => {
            const pct = Math.max(5, (r.alpha / maxAlpha) * 100);
            const color = colors[ci % colors.length];
            chartHtml += `<div class="bar-row">
                <span class="bar-label">${name} @ ${r.primary_tf}</span>
                <div class="bar-track">
                    <div class="bar-fill ${color}" style="width:${pct}%">+${r.alpha.toFixed(1)}%</div>
                </div>
            </div>`;
        });
        chartHtml += '<div style="height:6px;"></div>';
    });

    document.getElementById('mtf-chart').innerHTML = chartHtml;

    // â•â•â• Analysis â•â•â•
    let analysisHtml = '';

    // Find best per primary TF
    const byPTF = {};
    multiResults.forEach(r => {
        if (!byPTF[r.primary_tf] || r.alpha > byPTF[r.primary_tf].alpha) {
            byPTF[r.primary_tf] = r;
        }
    });

    analysisHtml += `<div class="analysis-item">
        <strong>ğŸ† æœ€ä½³ä¸»æ—¶é—´æ¡†æ¶:</strong> åœ¨ç›¸åŒçš„å¤šTFç»„åˆä¸‹ï¼Œ
        ${Object.entries(byPTF).sort((a,b) => b[1].alpha - a[1].alpha)
            .map(([tf, r]) => `<strong>${tf}</strong> (Î±=${r.alpha.toFixed(1)}%)`)
            .join(' > ')}ã€‚
        ä¸»TFè¶Šå¿«(1h)ï¼Œå†³ç­–é¢‘ç‡è¶Šé«˜ã€äº¤æ˜“æœºä¼šæ›´å¤šï¼›ä¸»TFè¶Šæ…¢(4h)ï¼Œä¿¡å·æ›´ç¨³ä½†æœºä¼šæ›´å°‘ã€‚
    </div>`;

    // Find best combo
    const byCombo = {};
    multiResults.forEach(r => {
        if (!byCombo[r.combo_name] || r.alpha > byCombo[r.combo_name].alpha) {
            byCombo[r.combo_name] = r;
        }
    });

    const sortedCombos = Object.entries(byCombo).sort((a,b) => b[1].alpha - a[1].alpha);
    analysisHtml += `<div class="analysis-item">
        <strong>ğŸ† æœ€ä½³TFç»„åˆ:</strong>
        ${sortedCombos.map(([name, r]) => `<strong>${name}</strong> (Î±=${r.alpha.toFixed(1)}%)`).join(' > ')}ã€‚
    </div>`;

    // Drawdown analysis
    const minDD = multiResults.reduce((best, r) => Math.abs(r.max_drawdown) < Math.abs(best.max_drawdown) ? r : best);
    analysisHtml += `<div class="analysis-item">
        <strong>ğŸ›¡ï¸ æœ€ä½å›æ’¤:</strong> ${minDD.combo_name} @ ${minDD.primary_tf}ï¼Œ
        å›æ’¤ä»… ${minDD.max_drawdown.toFixed(2)}%ï¼ŒAlpha ${minDD.alpha.toFixed(2)}%ã€‚
        ${Math.abs(minDD.max_drawdown) < Math.abs(singleBest.max_drawdown) ?
            'æ¯”å•TFæœ€ä¼˜å›æ’¤æ›´ä½ï¼Œé£æ§æ›´ä¼˜ç§€ã€‚' : ''}
    </div>`;

    // Trade frequency
    const minTrades = multiResults.reduce((best, r) => r.total_trades < best.total_trades ? r : best);
    analysisHtml += `<div class="analysis-item">
        <strong>ğŸ“‰ æœ€ä½äº¤æ˜“é¢‘ç‡:</strong> ${minTrades.combo_name} @ ${minTrades.primary_tf}ï¼Œ
        ä»… ${minTrades.total_trades} æ¬¡äº¤æ˜“ (å•TF: ${singleBest.total_trades}æ¬¡)ï¼Œ
        æ¯ç¬”äº¤æ˜“å¹³å‡è´¡çŒ® Î±=${(minTrades.alpha / Math.max(1, minTrades.total_trades)).toFixed(2)}%ã€‚
        é«˜è´¨é‡ä½é¢‘äº¤æ˜“æ›´é€‚åˆå®ç›˜æ“ä½œã€‚
    </div>`;

    analysisHtml += `<div class="analysis-item" style="border-color:var(--accent-green);">
        <strong>ğŸ’¡ å®ç›˜å»ºè®®:</strong>
        å¤šå‘¨æœŸè”åˆå†³ç­–çš„æ ¸å¿ƒä¼˜åŠ¿ä¸åœ¨äºç»å¯¹Alphaæ›´é«˜ï¼Œè€Œåœ¨äºï¼š
        <strong>æ›´å°‘çš„äº¤æ˜“æ¬¡æ•°</strong>(é™ä½æ‰‹ç»­è´¹å’Œæ»‘ç‚¹)ã€
        <strong>æ›´ä½çš„å›æ’¤</strong>(æ›´å¥½çš„èµ„é‡‘æ›²çº¿)ã€
        <strong>æ›´é«˜çš„å•ç¬”è´¨é‡</strong>(åªåœ¨å¤šTFå…±è¯†æ—¶å…¥åœº)ã€‚
        å»ºè®®å®ç›˜é‡‡ç”¨ <strong>${multiBest.combo_name} @ ${multiBest.primary_tf}</strong> é…ç½®ï¼Œ
        å…¼é¡¾æ”¶ç›Šå’Œé£æ§ã€‚
    </div>`;

    document.getElementById('mtf-analysis').innerHTML = analysisHtml;

    // â•â•â• Weights â•â•â•
    const weights = {
        '10m': 2, '15m': 3, '30m': 5, '1h': 8, '2h': 10, '3h': 12,
        '4h': 15, '6h': 18, '8h': 20, '12h': 22, '16h': 25, '24h': 28
    };
    const maxW = 28;
    let wHtml = '<div class="weight-grid">';
    for (const [tf, w] of Object.entries(weights)) {
        const pct = (w / maxW * 100).toFixed(0);
        const isLarge = w >= 15;
        wHtml += `<div class="weight-item" ${isLarge ? 'style="border-color:var(--accent-blue);"' : ''}>
            <div class="weight-tf" ${isLarge ? 'style="color:var(--accent-blue);"' : ''}>${tf}</div>
            <div class="weight-val">æƒé‡ ${w}</div>
            <div class="weight-bar"><div class="weight-bar-fill" style="width:${pct}%"></div></div>
        </div>`;
    }
    wHtml += '</div>';
    wHtml += `<p style="margin-top:12px;font-size:0.82em;color:var(--text-dim);">
        â‰¥4h çš„å‘¨æœŸ(è“è‰²è¾¹æ¡†)è¢«è§†ä¸º"å¤§å‘¨æœŸ"ï¼Œåœ¨å…±è¯†ç®—æ³•ä¸­æ‹¥æœ‰è¶‹åŠ¿å®šè°ƒæƒã€‚
        24h çš„æƒé‡(28)çº¦ç­‰äº 9 ä¸ª 15m(3) çš„æƒé‡ã€‚
    </p>`;
    document.getElementById('mtf-weights').innerHTML = wHtml;

    // â•â•â• Baseline table â•â•â•
    const blBody = document.querySelector('#baseline-table tbody');
    const topTfs = data.top_timeframes || [];
    const sortedBL = [...baselines].sort((a, b) => b.alpha - a.alpha);
    sortedBL.forEach(b => {
        const isTop = topTfs.includes(b.tf);
        const tr = document.createElement('tr');
        if (isTop) tr.style.background = 'rgba(255,215,0,0.04)';
        tr.innerHTML = `
            <td>${isTop ? 'â­ ' : ''}${b.tf}</td>
            <td style="color:${b.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};font-weight:600;">
                ${b.alpha >= 0 ? '+' : ''}${b.alpha.toFixed(2)}%
            </td>
            <td>${b.strategy_return >= 0 ? '+' : ''}${b.strategy_return.toFixed(2)}%</td>
            <td>${b.buy_hold_return >= 0 ? '+' : ''}${b.buy_hold_return.toFixed(2)}%</td>
            <td style="color:var(--accent-red);">${b.max_drawdown.toFixed(2)}%</td>
            <td>${b.total_trades}</td>
        `;
        blBody.appendChild(tr);
    });
}
</script>
{% endblock %}
