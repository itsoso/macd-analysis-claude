{% extends "base.html" %}
{% block title %}è£¸Kçº¿äº¤æ˜“æ³• Â· é€æ—¥ç›ˆäº{% endblock %}
{% block content %}
<style>
:root {
    --bg-page: #0f1117; --bg-card: #1a1d28; --bg-card2: #22263a;
    --border: #2a2e42; --text: #e8e8f0; --text-muted: #8b8fa8;
    --accent: #5b8af5; --green: #22c55e; --red: #ef4444;
    --orange: #f59e0b; --purple: #a78bfa; --cyan: #06b6d4;
}
.nkd { padding: 20px; max-width: 1500px; margin: 0 auto; color: var(--text); }
.nkd h1 { font-size: 1.8rem; font-weight: 700; text-align: center; margin-bottom: 4px; }
.nkd h1 span { color: var(--accent); }
.nkd .sub { text-align: center; color: var(--text-muted); font-size: 0.88rem; margin-bottom: 20px; }
.meta-bar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
.mbadge { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 5px 12px; font-size: 0.8rem; }
.mbadge b { color: var(--accent); margin-right: 4px; }

.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px 22px; margin-bottom: 18px; }
.card .title { font-size: 1.05rem; font-weight: 600; margin-bottom: 10px; }
.card .icon { margin-right: 5px; }

.mg { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin: 14px 0; }
.mi { background: var(--bg-card2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; }
.mi .lb { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 3px; }
.mi .vl { font-size: 1.2rem; font-weight: 700; }
.pos { color: var(--green); } .neg { color: var(--red); } .neu { color: var(--orange); }

.chart-box { width: 100%; height: 300px; position: relative; }

/* æŒä»“æ—¶é—´çº¿ */
.timeline { position: relative; }
.tl-row { display: flex; align-items: stretch; min-height: 40px; border-bottom: 1px solid var(--border); font-size: 0.78rem; transition: background 0.15s; }
.tl-row:hover { background: rgba(91,138,245,0.06); }
.tl-date { width: 90px; flex-shrink: 0; padding: 8px 6px; color: var(--text-muted); font-size: 0.75rem; display: flex; align-items: center; }
.tl-price { width: 75px; flex-shrink: 0; padding: 8px 4px; display: flex; align-items: center; justify-content: flex-end; }
.tl-bar { flex: 1; display: flex; align-items: center; padding: 4px 8px; gap: 6px; }
.tl-pnl { width: 90px; flex-shrink: 0; padding: 8px 6px; text-align: right; font-weight: 600; display: flex; align-items: center; justify-content: flex-end; }
.tl-total { width: 100px; flex-shrink: 0; padding: 8px 6px; text-align: right; display: flex; align-items: center; justify-content: flex-end; font-size: 0.76rem; }
.tl-signal { flex: 0 0 200px; padding: 8px 6px; font-size: 0.72rem; color: var(--text-muted); display: flex; align-items: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tl-trade { flex: 0 0 180px; padding: 8px 6px; font-size: 0.72rem; display: flex; align-items: center; }

.pos-long { background: rgba(34,197,94,0.12); border-left: 3px solid var(--green); }
.pos-short { background: rgba(239,68,68,0.12); border-left: 3px solid var(--red); }
.pos-none { border-left: 3px solid transparent; }
.pos-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
.pos-pill.long { background: rgba(34,197,94,0.2); color: var(--green); }
.pos-pill.short { background: rgba(239,68,68,0.2); color: var(--red); }

.trade-mark { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; margin-right: 3px; }
.trade-mark.open { background: rgba(6,182,212,0.2); color: var(--cyan); }
.trade-mark.close { background: rgba(245,158,11,0.2); color: var(--orange); }

.tl-header { display: flex; background: var(--bg-card2); border-bottom: 2px solid var(--border); font-weight: 600; font-size: 0.72rem; color: var(--text-muted); position: sticky; top: 0; z-index: 2; }
.tl-header > div { padding: 8px 6px; }

/* äº¤æ˜“è¡¨ */
.dt { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.dt th { background: var(--bg-card2); padding: 8px 6px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.72rem; position: sticky; top: 0; }
.dt td { padding: 6px; border-bottom: 1px solid var(--border); }
.dt .center { text-align: center; }
.dt tr:hover { background: rgba(91,138,245,0.06); }

.loading { text-align: center; padding: 60px; color: var(--text-muted); }
.spin { display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: sp 1s linear infinite; margin-bottom: 10px; }
@keyframes sp { to { transform: rotate(360deg); } }

/* æ»šåŠ¨å®¹å™¨ */
.scroll-y { max-height: 700px; overflow-y: auto; }
details summary { cursor: pointer; }
details summary:hover { color: var(--accent); }

.dd-bar { height: 6px; background: var(--bg-card2); border-radius: 3px; overflow: hidden; margin-top: 2px; }
.dd-fill { height: 100%; background: var(--red); border-radius: 3px; }
</style>

<div class="nkd" id="nkd-root">
    <div class="loading"><div class="spin"></div><div>åŠ è½½è£¸Kçº¿é€æ—¥ç›ˆäºæ•°æ®...</div></div>
</div>

<script src="/static/js/chart.umd.min.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const root = document.getElementById('nkd-root');
    let data;
    try {
        const resp = await fetch('/api/naked_kline_daily');
        if (!resp.ok) throw new Error('æœªæ‰¾åˆ°æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œ python backtest_naked_kline.py');
        data = await resp.json();
    } catch (e) {
        root.innerHTML = `<div class="loading" style="color:var(--red)">âŒ ${e.message}</div>`;
        return;
    }
    if (data.error) { root.innerHTML = `<div class="loading" style="color:var(--red)">âŒ ${data.error}</div>`; return; }

    const m = data.run_meta || {};
    const s = data.summary || {};
    const daily = data.daily_records || [];
    const trades = data.trade_details || [];
    const equity = data.equity_curve || [];
    const sigs = data.signals || [];

    const fv = v => v != null ? (typeof v === 'number' ? v.toFixed(2) : v) : '-';
    const fc = v => v != null ? '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0}) : '-';
    const cls = v => v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu';

    // æ„å»ºäº¤æ˜“æ—¥æœŸç´¢å¼•: date -> [{trade}]
    const tradeByDate = {};
    trades.forEach(t => {
        const d = (t.time || '').slice(0, 10);
        if (!tradeByDate[d]) tradeByDate[d] = [];
        tradeByDate[d].push(t);
    });

    let html = `
    <h1>ğŸ•¯ï¸ <span>è£¸Kçº¿äº¤æ˜“æ³•</span> Â· é€æ—¥æŒä»“ç›ˆäº</h1>
    <div class="sub">è®¸ä½³èªã€Šè£¸Kçº¿äº¤æ˜“æ³•ã€‹Â· ETH/USDT æ—¥çº¿ Â· æ¯æ—¥å®Œæ•´æŒä»“ä¸äº¤æ˜“è®°å½•</div>
    <div class="meta-bar">
        <span class="mbadge"><b>ğŸ“…</b>${m.start_date||''} ~ ${m.end_date||''}</span>
        <span class="mbadge"><b>ğŸ’°</b>$${(m.initial_capital||100000).toLocaleString()}</span>
        <span class="mbadge"><b>âš¡</b>${m.leverage||3}x</span>
        <span class="mbadge"><b>ğŸ¯</b>é£é™©${((m.risk_per_trade||0.02)*100).toFixed(0)}%</span>
        <span class="mbadge"><b>ğŸ–¥ï¸</b>${m.runner||''} @ ${m.host||''}</span>
        <span class="mbadge"><b>ğŸ•</b>${m.run_time||''}</span>
    </div>`;

    // â•â•â•â•â•â• æ±‡æ€»å¡ç‰‡ â•â•â•â•â•â•
    html += `<div class="card"><div class="title"><span class="icon">ğŸ“Š</span>å›æµ‹æ±‡æ€»</div>
    <div class="mg">
        <div class="mi"><div class="lb">æ€»æ”¶ç›Šç‡</div><div class="vl ${cls(s.total_return_pct)}">${fv(s.total_return_pct)}%</div></div>
        <div class="mi"><div class="lb">å¹´åŒ–æ”¶ç›Š</div><div class="vl ${cls(s.annual_return_pct)}">${fv(s.annual_return_pct)}%</div></div>
        <div class="mi"><div class="lb">æœ€å¤§å›æ’¤</div><div class="vl neg">${fv(s.max_drawdown_pct)}%</div></div>
        <div class="mi"><div class="lb">äº¤æ˜“æ¬¡æ•°</div><div class="vl neu">${s.total_trades||0}</div></div>
        <div class="mi"><div class="lb">èƒœç‡</div><div class="vl ${(s.win_rate_pct||0)>=50?'pos':'neg'}">${fv(s.win_rate_pct)}%</div></div>
        <div class="mi"><div class="lb">ç›ˆäºæ¯”</div><div class="vl ${(s.profit_factor||0)>=1.5?'pos':'neu'}">${fv(s.profit_factor)}</div></div>
        <div class="mi"><div class="lb">æœŸæœ«èµ„é‡‘</div><div class="vl">${fc(s.final_capital)}</div></div>
        <div class="mi"><div class="lb">æ€»è´¹ç”¨</div><div class="vl">${fc((s.total_fees||0)+(s.total_slippage||0)+(s.total_funding||0))}</div></div>
    </div></div>`;

    // â•â•â•â•â•â• èµ„é‡‘æ›²çº¿ + å›æ’¤ â•â•â•â•â•â•
    html += `<div class="card">
        <div class="title"><span class="icon">ğŸ“ˆ</span>èµ„é‡‘æ›²çº¿ & å›æ’¤ & ETHä»·æ ¼</div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
    </div>`;

    // â•â•â•â•â•â• é€æ—¥ç›ˆäº+æŒä»“æ—¶é—´çº¿ â•â•â•â•â•â•
    html += `<div class="card">
        <div class="title"><span class="icon">ğŸ“‹</span>é€æ—¥æŒä»“ç›ˆäº (${daily.length} å¤©)</div>
        <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:8px;">
            æ¯å¤©å±•ç¤º: æ—¥æœŸ | ETHæ”¶ç›˜ä»· | æŒä»“çŠ¶æ€ | æœªå®ç°PnL | è´¦æˆ·æ€»å€¼ | ä¿¡å· | å½“æ—¥äº¤æ˜“
        </div>
        <div class="timeline scroll-y">
            <div class="tl-header">
                <div class="tl-date">æ—¥æœŸ</div>
                <div class="tl-price">æ”¶ç›˜ä»·</div>
                <div class="tl-bar" style="flex:0 0 120px">æŒä»“</div>
                <div class="tl-pnl">æœªå®ç°PnL</div>
                <div class="tl-total">è´¦æˆ·æ€»å€¼</div>
                <div class="tl-signal">ä¿¡å·</div>
                <div class="tl-trade">å½“æ—¥äº¤æ˜“</div>
            </div>`;

    daily.forEach(d => {
        const p = d.position;
        const posClass = p ? (p.direction === 'long' ? 'pos-long' : 'pos-short') : 'pos-none';
        const dayTrades = tradeByDate[d.date] || [];

        let posHtml = '-';
        if (p) {
            posHtml = `<span class="pos-pill ${p.direction}">${p.direction==='long'?'ğŸŸ¢å¤š':'ğŸ”´ç©º'}</span>
                <span style="font-size:0.7rem;color:var(--text-muted)">@${fv(p.entry_price)} Ã—${fv(p.quantity)}</span>`;
        }

        let pnlHtml = '-';
        if (p && p.unrealized_pnl != null) {
            const pnlVal = p.unrealized_pnl;
            pnlHtml = `<span class="${cls(pnlVal)}" style="font-weight:600">$${fv(pnlVal)}</span>`;
        }

        let tradeHtml = '';
        dayTrades.forEach(t => {
            const isOpen = t.action === 'OPEN';
            tradeHtml += `<span class="trade-mark ${isOpen?'open':'close'}">${isOpen?'å¼€':'å¹³'}${t.direction==='long'?'å¤š':'ç©º'}</span>`;
            if (!isOpen && t.pnl != null) {
                tradeHtml += `<span class="${cls(t.pnl)}" style="font-size:0.68rem;font-weight:600">$${fv(t.pnl)}</span> `;
            }
        });

        const trendIcon = d.trend === 'up' ? 'ğŸŸ¢' : d.trend === 'down' ? 'ğŸ”´' : 'ğŸŸ¡';
        const retCls = cls(d.return_pct);

        html += `<div class="tl-row ${posClass}">
            <div class="tl-date">${d.date}</div>
            <div class="tl-price">$${fv(d.close || d.open)}</div>
            <div class="tl-bar" style="flex:0 0 120px">${posHtml}</div>
            <div class="tl-pnl">${pnlHtml}</div>
            <div class="tl-total"><span class="${retCls}">${fc(d.total_value)}</span></div>
            <div class="tl-signal">${trendIcon} ${d.signal || ''}</div>
            <div class="tl-trade">${tradeHtml || '<span style="color:var(--text-muted)">-</span>'}</div>
        </div>`;
    });
    html += '</div></div>';

    // â•â•â•â•â•â• å®Œæ•´äº¤æ˜“è®°å½• â•â•â•â•â•â•
    html += `<div class="card"><details open>
        <summary class="title" style="cursor:pointer"><span class="icon">ğŸ’¹</span>å®Œæ•´äº¤æ˜“è®°å½• (${trades.length} ç¬”)</summary>
        <div style="overflow-x:auto;margin-top:10px;">
        <table class="dt" style="font-size:0.72rem;white-space:nowrap;"><thead><tr>
            <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>æ–¹å‘</th>
            <th class="center">å¸‚åœºä»·</th><th class="center">æˆäº¤ä»·</th>
            <th class="center">æ•°é‡</th><th class="center">åä¹‰ä»·å€¼</th>
            <th class="center">ä¿è¯é‡‘</th><th class="center">æ æ†</th>
            <th class="center">æ‰‹ç»­è´¹</th><th class="center">æ»‘ç‚¹</th>
            <th class="center">PnL</th><th class="center">æŒä»“å¤©æ•°</th>
            <th class="center">è´¦æˆ·æ€»å€¼</th><th>åŸå› </th>
        </tr></thead><tbody>`;
    trades.forEach((t, i) => {
        const pCls = t.pnl > 0 ? 'color:var(--green)' : t.pnl < 0 ? 'color:var(--red)' : '';
        html += `<tr>
            <td>${i+1}</td><td>${t.time||''}</td>
            <td style="font-weight:600;${t.action==='OPEN'?'color:var(--cyan)':'color:var(--orange)'}">${t.action}</td>
            <td>${t.direction==='long'?'ğŸŸ¢å¤š':'ğŸ”´ç©º'}</td>
            <td class="center">$${fv(t.market_price)}</td>
            <td class="center">$${fv(t.exec_price)}</td>
            <td class="center">${fv(t.quantity)}</td>
            <td class="center">${fc(t.notional_value)}</td>
            <td class="center">${fc(t.margin)}</td>
            <td class="center">${t.leverage||'-'}x</td>
            <td class="center">$${fv(t.fee)}</td>
            <td class="center">$${fv(t.slippage_cost)}</td>
            <td class="center" style="${pCls};font-weight:700">$${fv(t.pnl)}</td>
            <td class="center">${t.bars_held != null ? t.bars_held+'å¤©' : '-'}</td>
            <td class="center">${fc(t.after_total)}</td>
            <td style="font-size:0.68rem;max-width:200px;overflow:hidden;text-overflow:ellipsis">${t.close_reason||t.pattern||''}</td>
        </tr>`;
    });
    html += '</tbody></table></div></details></div>';

    // â•â•â•â•â•â• äº¤æ˜“ç»Ÿè®¡ â•â•â•â•â•â•
    const closeTrades = trades.filter(t => t.action === 'CLOSE');
    const wins = closeTrades.filter(t => t.pnl > 0);
    const losses = closeTrades.filter(t => t.pnl <= 0);
    const avgHold = closeTrades.reduce((s,t) => s + (t.bars_held||0), 0) / (closeTrades.length||1);

    html += `<div class="card"><div class="title"><span class="icon">ğŸ“Š</span>äº¤æ˜“ç»Ÿè®¡åˆ†æ</div>
    <div class="mg">
        <div class="mi"><div class="lb">ç›ˆåˆ©ç¬”æ•°</div><div class="vl pos">${wins.length}</div></div>
        <div class="mi"><div class="lb">äºæŸç¬”æ•°</div><div class="vl neg">${losses.length}</div></div>
        <div class="mi"><div class="lb">å¹³å‡ç›ˆåˆ©</div><div class="vl pos">$${fv(wins.reduce((s,t)=>s+t.pnl,0)/(wins.length||1))}</div></div>
        <div class="mi"><div class="lb">å¹³å‡äºæŸ</div><div class="vl neg">$${fv(losses.reduce((s,t)=>s+t.pnl,0)/(losses.length||1))}</div></div>
        <div class="mi"><div class="lb">æœ€å¤§å•ç¬”ç›ˆåˆ©</div><div class="vl pos">$${fv(Math.max(0,...closeTrades.map(t=>t.pnl)))}</div></div>
        <div class="mi"><div class="lb">æœ€å¤§å•ç¬”äºæŸ</div><div class="vl neg">$${fv(Math.min(0,...closeTrades.map(t=>t.pnl)))}</div></div>
        <div class="mi"><div class="lb">å¹³å‡æŒä»“å¤©æ•°</div><div class="vl neu">${avgHold.toFixed(1)}å¤©</div></div>
        <div class="mi"><div class="lb">æ€»æ‰‹ç»­è´¹+æ»‘ç‚¹</div><div class="vl">${fc((s.total_fees||0)+(s.total_slippage||0))}</div></div>
    </div>
    <div style="margin-top:14px;"><div class="chart-box" style="height:220px"><canvas id="pnlChart"></canvas></div></div>
    </div>`;

    root.innerHTML = html;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Chart 1: èµ„é‡‘æ›²çº¿ + å›æ’¤ + ä»·æ ¼
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (equity.length > 0) {
        const labels = equity.map(e => e.date);
        new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'è´¦æˆ·æ€»å€¼', data: equity.map(e=>e.total), borderColor: '#5b8af5', backgroundColor: 'rgba(91,138,245,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y' },
                    { label: 'ETHä»·æ ¼', data: equity.map(e=>e.price), borderColor: '#f59e0b', borderWidth: 1.5, tension: 0.3, pointRadius: 0, borderDash: [4,2], yAxisID: 'y1' },
                    { label: 'å›æ’¤%', data: equity.map(e=> -(e.drawdown||0)), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1, yAxisID: 'y2' },
                ],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { labels: { color: '#8b8fa8', font: { size: 10 } } } },
                scales: {
                    x: { ticks: { color: '#8b8fa8', maxTicksLimit: 15, font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.5)' } },
                    y: { position: 'left', ticks: { color: '#5b8af5', font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.3)' } },
                    y1: { position: 'right', ticks: { color: '#f59e0b', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                    y2: { position: 'right', ticks: { color: '#ef4444', font: { size: 9 }, callback: v=>v+'%' }, grid: { drawOnChartArea: false }, max: 0, min: -(s.max_drawdown_pct||15)*1.2 },
                },
            },
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Chart 2: æ¯ç¬”äº¤æ˜“PnLç€‘å¸ƒå›¾
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (closeTrades.length > 0) {
        new Chart(document.getElementById('pnlChart'), {
            type: 'bar',
            data: {
                labels: closeTrades.map((t,i) => `#${i+1}`),
                datasets: [{
                    label: 'å•ç¬”PnL',
                    data: closeTrades.map(t => t.pnl),
                    backgroundColor: closeTrades.map(t => t.pnl >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)'),
                    borderColor: closeTrades.map(t => t.pnl >= 0 ? '#22c55e' : '#ef4444'),
                    borderWidth: 1,
                }],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8b8fa8', font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.3)' } },
                    y: { ticks: { color: '#8b8fa8', font: { size: 9 }, callback: v=>'$'+v }, grid: { color: 'rgba(42,46,66,0.3)' } },
                },
            },
        });
    }
});
</script>
{% endblock %}
