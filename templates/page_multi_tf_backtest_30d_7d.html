{% extends "base.html" %}

{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­– Â· 60å¤© / 30å¤© / 7å¤© å›æµ‹{% endblock %}

{% block extra_styles %}
<style>
    .bt-hero {
        background: linear-gradient(135deg, rgba(168,85,247,0.12), rgba(74,158,255,0.1));
        border: 1px solid var(--border);
        padding: 36px 32px;
        border-radius: 14px;
        margin-bottom: 28px;
    }
    .bt-hero h1 {
        font-size: 1.6rem; font-weight: 700;
        background: linear-gradient(135deg, #a855f7, var(--accent-blue));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin: 0 0 6px 0;
    }
    .bt-hero .subtitle { color: var(--text-secondary); font-size: 0.9rem; }
    .bt-hero .badges { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .bt-hero .badge-item {
        background: rgba(255,255,255,0.06); border: 1px solid var(--border);
        padding: 5px 14px; border-radius: 16px; font-size: 0.8rem; color: var(--text-secondary);
    }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .summary-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
    .summary-card.hl { border-color: #a855f7; background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(74,158,255,0.06)); }
    .summary-card .s-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .summary-card .s-value { font-size: 1.5rem; font-weight: 700; }
    .summary-card .s-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

    .sec-title { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); margin: 32px 0 18px 0; padding-bottom: 10px; border-bottom: 2px solid #a855f7; display: flex; align-items: center; gap: 8px; }
    .sec-title .icon { font-size: 1.1rem; }

    .hbar-chart { margin: 16px 0; }
    .hbar-group { margin-bottom: 18px; }
    .hbar-group-label { font-size: 0.82rem; color: var(--text-primary); margin-bottom: 6px; font-weight: 500; }
    .hbar-row { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
    .hbar-period { width: 32px; font-size: 0.72rem; font-weight: 600; flex-shrink: 0; text-align: right; }
    .hbar-period.p60 { color: var(--accent-blue); }
    .hbar-period.p30 { color: #a855f7; }
    .hbar-period.p7 { color: var(--accent-yellow); }
    .hbar-track { flex: 1; height: 22px; background: rgba(255,255,255,0.04); border-radius: 4px; overflow: hidden; }
    .hbar-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; font-size: 0.72rem; font-weight: 600; color: #fff; min-width: 50px; transition: width 0.5s ease; }
    .hbar-fill.f60 { background: linear-gradient(90deg, #2563eb, #38bdf8); }
    .hbar-fill.f30 { background: linear-gradient(90deg, #a855f7, #818cf8); }
    .hbar-fill.f7 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .hbar-legend { display: flex; gap: 20px; margin-bottom: 14px; font-size: 0.82rem; color: var(--text-secondary); }
    .hbar-legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 3px; vertical-align: middle; margin-right: 4px; }

    .tab-wrap { margin-top: 4px; }
    .tab-header { display: flex; gap: 0; }
    .tab-btn { padding: 10px 24px; border: 1px solid var(--border); border-bottom: none; background: var(--bg-secondary); cursor: pointer; font-size: 0.88rem; font-weight: 600; color: var(--text-muted); border-radius: 8px 8px 0 0; transition: all 0.2s; }
    .tab-btn.active { background: var(--bg-card); color: #a855f7; border-color: #a855f7; border-bottom-color: var(--bg-card); }
    .tab-btn:hover:not(.active) { color: var(--text-secondary); }
    .tab-body { display: none; background: var(--bg-card); border: 1px solid #a855f7; border-top: none; border-radius: 0 8px 8px 8px; padding: 20px; }
    .tab-body.active { display: block; }

    .dt { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .dt th { background: var(--bg-secondary); padding: 10px 8px; text-align: left; font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.4px; border-bottom: 2px solid var(--border); white-space: nowrap; }
    .dt td { padding: 9px 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-variant-numeric: tabular-nums; }
    .dt tr:hover td { background: var(--bg-hover); }
    .dt tr.gold td { background: rgba(168,85,247,0.08); }
    .dt tr.gold:hover td { background: rgba(168,85,247,0.14); }
    .dt .pos { color: var(--accent-green); font-weight: 600; }
    .dt .neg { color: var(--accent-red); font-weight: 600; }
    .dt .center { text-align: center; }

    .tbadge { display: inline-block; padding: 2px 7px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 5px; vertical-align: middle; }
    .tbadge.ptf { background: rgba(168,85,247,0.15); color: #a855f7; }
    .tbadge.combo { background: rgba(74,158,255,0.15); color: var(--accent-blue); }

    .insight-box { background: rgba(168,85,247,0.06); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 20px 24px; margin-top: 16px; }
    .insight-box h4 { color: #a855f7; margin: 0 0 12px 0; font-size: 1rem; }
    .insight-box ul { margin: 0; padding-left: 18px; color: var(--text-secondary); }
    .insight-box li { margin-bottom: 8px; line-height: 1.7; font-size: 0.88rem; }
    .insight-box strong { color: var(--text-primary); }
    .insight-box code { background: rgba(168,85,247,0.12); color: #a855f7; padding: 1px 6px; border-radius: 4px; font-size: 0.82rem; }

    .baseline-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .baseline-box h4 { color: var(--accent-blue); margin: 0 0 12px 0; }

    .ld-box { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }
</style>
{% endblock %}

{% block content %}
<div id="root">
    <div class="ld-box" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 14px; color: var(--text-muted);">æ­£åœ¨åŠ è½½å¤šå‘¨æœŸå›æµ‹æ•°æ®...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/multi_tf_backtest_30d_7d')
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('loading').innerHTML =
                    '<p style="color:var(--accent-red);">' + data.error + '</p>';
                return;
            }
            render(data);
        })
        .catch(err => {
            document.getElementById('loading').innerHTML =
                '<p style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ' + err.message + '</p>';
        });
});

function render(data) {
    const r60 = data.results_60d || [];
    const r30 = data.results_30d || [];
    const r7 = data.results_7d || [];
    const s = data.summary || {};
    const s60 = s['60d'] || {};
    const s30 = s['30d'] || {};
    const s7 = s['7d'] || {};
    const fm = data.fee_model || {};
    const bc = data.base_config || {};
    const baselines = data.single_tf_baselines || {};
    const realism = data.realism || {};
    const runMeta = data.run_meta || {};
    const recentRuns = data.recent_runs || [];
    const wf = data.walk_forward || {};
    const wfRankings = wf.rankings || [];
    const wfWindows = wf.windows || [];

    const root = document.getElementById('root');
    root.innerHTML = '';

    const num = v => Number(v || 0);
    const keyOf = row => `${row.combo_name}@${row.primary_tf}`;
    const findByKey = (rows, key) => rows.find(x => keyOf(x) === key);
    const fmtCombo = row => row && row.combo_name ? `${row.combo_name}@${row.primary_tf}` : '-';

    const top60 = r60[0] || {};
    const top30 = r30[0] || {};
    const top7 = r7[0] || {};

    // â”€â”€ Hero â”€â”€
    root.innerHTML += `
        <div class="bt-hero">
            <h1>ğŸ”— å¤šå‘¨æœŸè”åˆå†³ç­– Â· 60å¤© / 30å¤© / 7å¤© å›æµ‹</h1>
            <div class="subtitle">åŠ æƒå…±è¯† + å…±æŒ¯é“¾æ£€æµ‹ Â· å¸å®‰ ETH/USDT çœŸå®Kçº¿ Â· å«æ‰‹ç»­è´¹/æ»‘ç‚¹/èµ„é‡‘è´¹ç‡</div>
            <div class="badges">
                <span class="badge-item">ğŸ§  å¤šå‘¨æœŸè”åˆå†³ç­–</span>
                <span class="badge-item">åŸºçº¿: ${bc.best_single_tf||'1h'} Î±=${fv(bc.best_single_alpha)}%</span>
                <span class="badge-item">Taker ${fm.taker_fee||'0.05%'}</span>
                <span class="badge-item">æ»‘ç‚¹ ${fm.slippage||'0.1%'}</span>
                ${runMeta.runner ? `<span class="badge-item">æ¥æº: ${runMeta.runner}</span>` : ''}
                ${runMeta.host ? `<span class="badge-item">ä¸»æœº: ${runMeta.host}</span>` : ''}
                ${realism.regime_aware ? `<span class="badge-item">Regime-aware: ON</span>` : ''}
                ${realism.protections ? `<span class="badge-item">Protections: ON</span>` : ''}
                ${wf.enabled ? `<span class="badge-item">WF: ${wf.windows_built || 0}çª— (${wf.train_days||90}D/${wf.test_days||7}D)</span>` : ''}
                <span class="badge-item">${data.run_time ? new Date(data.run_time).toLocaleString('zh-CN') : ''}</span>
            </div>
        </div>
    `;

    // â”€â”€ Summary Cards â”€â”€
    root.innerHTML += `
        <div class="summary-grid">
            <div class="summary-card hl">
                <div class="s-label">60å¤©æœ€ä¼˜ Alpha</div>
                <div class="s-value" style="color:${num(s60.best_alpha)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s60.best_alpha)}%</div>
                <div class="s-detail">${fmtCombo(top60)}</div>
            </div>
            <div class="summary-card hl">
                <div class="s-label">30å¤©æœ€ä¼˜ Alpha</div>
                <div class="s-value" style="color:${num(s30.best_alpha)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s30.best_alpha)}%</div>
                <div class="s-detail">${fmtCombo(top30)}</div>
            </div>
            <div class="summary-card hl">
                <div class="s-label">7å¤©æœ€ä¼˜ Alpha</div>
                <div class="s-value" style="color:${num(s7.best_alpha)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s7.best_alpha)}%</div>
                <div class="s-detail">${fmtCombo(top7)}</div>
            </div>
            <div class="summary-card">
                <div class="s-label">60å¤©å¹³å‡ Alpha</div>
                <div class="s-value" style="color:${num(s60.avg_alpha)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s60.avg_alpha)}%</div>
                <div class="s-detail">${s60.profitable_count||0}/${s60.total_count||0} ç­–ç•¥ç›ˆåˆ©</div>
            </div>
            <div class="summary-card">
                <div class="s-label">30å¤©å¹³å‡ Alpha</div>
                <div class="s-value" style="color:${num(s30.avg_alpha)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s30.avg_alpha)}%</div>
                <div class="s-detail">${s30.profitable_count||0}/${s30.total_count||0} ç­–ç•¥ç›ˆåˆ©</div>
            </div>
            <div class="summary-card">
                <div class="s-label">7å¤©å¹³å‡ Alpha</div>
                <div class="s-value" style="color:${num(s7.avg_alpha)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s7.avg_alpha)}%</div>
                <div class="s-detail">${s7.profitable_count||0}/${s7.total_count||0} ç­–ç•¥ç›ˆåˆ©</div>
            </div>
            <div class="summary-card">
                <div class="s-label">å¹³å‡äº¤æ˜“æ•° (60/30/7)</div>
                <div class="s-value" style="color:var(--accent-blue)">${num(s60.avg_trades).toFixed(0)} / ${num(s30.avg_trades).toFixed(0)} / ${num(s7.avg_trades).toFixed(0)}</div>
                <div class="s-detail">çª—å£è¶ŠçŸ­ï¼Œäº¤æ˜“é¢‘ç‡é€šå¸¸ä¸‹é™</div>
            </div>
            <div class="summary-card">
                <div class="s-label">å•TFåŸºçº¿</div>
                <div class="s-value" style="color:var(--text-secondary)">${fv(bc.best_single_alpha)}%</div>
                <div class="s-detail">${bc.best_single_tf||'1h'} Â· ${bc.fusion_mode||'c6_veto_4'}</div>
            </div>
        </div>
    `;

    if (recentRuns.length) {
        let runHtml = `<div class="sec-title"><span class="icon">ğŸ—‚ï¸</span> å›æµ‹è®°å½•ï¼ˆæœ€è¿‘è¿è¡Œï¼‰</div>`;
        runHtml += '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
        runHtml += '<th>#</th><th>è¿è¡Œæ—¶é—´</th><th>æ¥æº</th><th>ä¸»æœº</th><th class="center">60å¤©Top</th><th class="center">30å¤©Top</th><th class="center">7å¤©Top</th>';
        runHtml += '</tr></thead><tbody>';
        recentRuns.slice(0, 10).forEach((r, idx) => {
            const t = r.run_time ? new Date(r.run_time).toLocaleString('zh-CN') : '-';
            runHtml += `<tr ${idx === 0 ? 'class="gold"' : ''}>
                <td>${idx + 1}</td>
                <td>${t}</td>
                <td>${r.runner || '-'}</td>
                <td>${r.host || '-'}</td>
                <td class="center">${r.top_60d ? `${r.top_60d.combo} (${fv(r.top_60d.alpha)}%)` : '-'}</td>
                <td class="center">${r.top_30d ? `${r.top_30d.combo} (${fv(r.top_30d.alpha)}%)` : '-'}</td>
                <td class="center">${r.top_7d ? `${r.top_7d.combo} (${fv(r.top_7d.alpha)}%)` : '-'}</td>
            </tr>`;
        });
        runHtml += '</tbody></table></div>';
        root.innerHTML += runHtml;
    }

    if (wfRankings.length) {
        let wfHtml = `<div class="sec-title"><span class="icon">ğŸ§ª</span> Walk-Forward ç¨³å¥æ¦œ</div>`;
        wfHtml += '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
        wfHtml += '<th>#</th><th>ç»„åˆ</th><th>å†³ç­–TFs</th><th class="center">å‘½ä¸­çª—å£</th><th class="center">Avg Alpha</th><th class="center">Min Alpha</th><th class="center">Avg å›æ’¤</th><th class="center">èƒœç‡</th><th class="center">ç¨³å¥åˆ†</th>';
        wfHtml += '</tr></thead><tbody>';
        wfRankings.slice(0, 10).forEach((r, idx) => {
            const tfs = (r.decision_tfs || []).join(', ');
            wfHtml += `<tr ${idx === 0 ? 'class="gold"' : ''}>
                <td>${idx + 1}</td>
                <td><strong>${r.combo || '-'}</strong></td>
                <td style="font-size:0.75rem;color:var(--text-muted)">${tfs}</td>
                <td class="center">${r.windows || 0}</td>
                <td class="center ${num(r.avg_alpha)>=0?'pos':'neg'}">${fv(r.avg_alpha)}%</td>
                <td class="center ${num(r.min_alpha)>=0?'pos':'neg'}">${fv(r.min_alpha)}%</td>
                <td class="center neg">${num(r.avg_mdd).toFixed(2)}%</td>
                <td class="center">${(num(r.win_rate) * 100).toFixed(1)}%</td>
                <td class="center ${num(r.robust_score)>=0?'pos':'neg'}">${num(r.robust_score).toFixed(2)}</td>
            </tr>`;
        });
        wfHtml += '</tbody></table></div>';

        if (wfWindows.length) {
            const windowLines = wfWindows.map(w => {
                const st = w.test_start ? new Date(w.test_start).toLocaleDateString('zh-CN') : '-';
                const et = w.test_end ? new Date(w.test_end).toLocaleDateString('zh-CN') : '-';
                const top = w.top_combo ? `${w.top_combo.combo} (${fv(w.top_combo.alpha)}%)` : '-';
                return `<li><strong>${w.window_id}</strong>: ${st} ~ ${et} Â· TOP ${top}</li>`;
            }).join('');
            wfHtml += `<div class="insight-box" style="margin-top:12px;">
                <h4>çª—å£è®°å½•</h4>
                <ul>${windowLines}</ul>
            </div>`;
        }
        root.innerHTML += wfHtml;
    }

    // â”€â”€ Single TF Baselines â”€â”€
    const bl60 = baselines['60'] || {};
    const bl30 = baselines['30'] || {};
    const bl7 = baselines['7'] || {};
    const ptfs = Array.from(new Set([
        ...Object.keys(bl60), ...Object.keys(bl30), ...Object.keys(bl7)
    ])).sort((a, b) => a.localeCompare(b));

    if (ptfs.length) {
        let blHtml = `<div class="sec-title"><span class="icon">ğŸ“</span> å•TFåŸºçº¿å¯¹æ¯” (vs å¤šå‘¨æœŸ)</div>`;
        blHtml += '<div class="baseline-box"><div style="overflow-x:auto"><table class="dt"><thead><tr>';
        blHtml += '<th>ä¸»TF</th><th class="center">60å¤©å•TF</th><th class="center">60å¤©å¤šTFæœ€ä¼˜</th><th class="center">å·®å¼‚</th>';
        blHtml += '<th class="center">30å¤©å•TF</th><th class="center">30å¤©å¤šTFæœ€ä¼˜</th><th class="center">å·®å¼‚</th>';
        blHtml += '<th class="center">7å¤©å•TF</th><th class="center">7å¤©å¤šTFæœ€ä¼˜</th><th class="center">å·®å¼‚</th>';
        blHtml += '</tr></thead><tbody>';

        for (const ptf of ptfs) {
            const s60a = num(bl60[ptf]?.alpha);
            const s30a = num(bl30[ptf]?.alpha);
            const s7a = num(bl7[ptf]?.alpha);
            const m60a = num(r60.find(r => r.primary_tf === ptf)?.alpha);
            const m30a = num(r30.find(r => r.primary_tf === ptf)?.alpha);
            const m7a = num(r7.find(r => r.primary_tf === ptf)?.alpha);

            blHtml += `<tr>
                <td><strong>${ptf}</strong></td>
                <td class="center ${s60a>=0?'pos':'neg'}">${fv(s60a)}%</td>
                <td class="center ${m60a>=0?'pos':'neg'}">${fv(m60a)}%</td>
                <td class="center ${(m60a-s60a)>=0?'pos':'neg'}">${fv(m60a-s60a)}%</td>
                <td class="center ${s30a>=0?'pos':'neg'}">${fv(s30a)}%</td>
                <td class="center ${m30a>=0?'pos':'neg'}">${fv(m30a)}%</td>
                <td class="center ${(m30a-s30a)>=0?'pos':'neg'}">${fv(m30a-s30a)}%</td>
                <td class="center ${s7a>=0?'pos':'neg'}">${fv(s7a)}%</td>
                <td class="center ${m7a>=0?'pos':'neg'}">${fv(m7a)}%</td>
                <td class="center ${(m7a-s7a)>=0?'pos':'neg'}">${fv(m7a-s7a)}%</td>
            </tr>`;
        }

        blHtml += '</tbody></table></div></div>';
        root.innerHTML += blHtml;
    }

    // â”€â”€ Alpha Bar Chart â”€â”€
    const matched = [];
    for (const row60 of r60) {
        const key = keyOf(row60);
        const row30 = findByKey(r30, key);
        const row7 = findByKey(r7, key);
        if (row30 && row7) {
            matched.push({ key, a60: num(row60.alpha), a30: num(row30.alpha), a7: num(row7.alpha) });
        }
    }

    if (matched.length) {
        const maxA = Math.max(
            ...matched.map(m => Math.abs(m.a60)),
            ...matched.map(m => Math.abs(m.a30)),
            ...matched.map(m => Math.abs(m.a7)),
            1
        );

        let barHtml = `<div class="sec-title"><span class="icon">ğŸ“Š</span> Alpha å¯è§†åŒ–å¯¹æ¯”</div>`;
        barHtml += '<div class="hbar-legend"><span><span class="hbar-legend-dot" style="background:#2563eb"></span> 60å¤©</span>';
        barHtml += '<span><span class="hbar-legend-dot" style="background:#a855f7"></span> 30å¤©</span>';
        barHtml += '<span><span class="hbar-legend-dot" style="background:#f59e0b"></span> 7å¤©</span></div>';
        barHtml += '<div class="hbar-chart">';

        for (const m of matched.slice(0, 12)) {
            const w60 = Math.max(3, (Math.abs(m.a60) / maxA) * 100);
            const w30 = Math.max(3, (Math.abs(m.a30) / maxA) * 100);
            const w7 = Math.max(3, (Math.abs(m.a7) / maxA) * 100);

            barHtml += `
                <div class="hbar-group">
                    <div class="hbar-group-label">${m.key}</div>
                    <div class="hbar-row">
                        <div class="hbar-period p60">60d</div>
                        <div class="hbar-track"><div class="hbar-fill f60" style="width:${w60}%">${fv(m.a60)}%</div></div>
                    </div>
                    <div class="hbar-row">
                        <div class="hbar-period p30">30d</div>
                        <div class="hbar-track"><div class="hbar-fill f30" style="width:${w30}%">${fv(m.a30)}%</div></div>
                    </div>
                    <div class="hbar-row">
                        <div class="hbar-period p7">7d</div>
                        <div class="hbar-track"><div class="hbar-fill f7" style="width:${w7}%">${fv(m.a7)}%</div></div>
                    </div>
                </div>`;
        }

        barHtml += '</div>';
        root.innerHTML += barHtml;
    }

    // â”€â”€ VS Table â”€â”€
    let vsHtml = `<div class="sec-title"><span class="icon">âš–ï¸</span> 60å¤© / 30å¤© / 7å¤© é€æ–¹æ¡ˆå¯¹æ¯”</div>`;
    vsHtml += '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
    vsHtml += '<th>æ–¹æ¡ˆ</th><th class="center">ä¸»TF</th>';
    vsHtml += '<th class="center">60å¤©Alpha</th><th class="center">60å¤©å›æ’¤</th><th class="center">60å¤©äº¤æ˜“</th><th class="center">vså•TF</th>';
    vsHtml += '<th class="center">30å¤©Alpha</th><th class="center">30å¤©å›æ’¤</th><th class="center">30å¤©äº¤æ˜“</th><th class="center">vså•TF</th>';
    vsHtml += '<th class="center">7å¤©Alpha</th><th class="center">7å¤©å›æ’¤</th><th class="center">7å¤©äº¤æ˜“</th><th class="center">vså•TF</th>';
    vsHtml += '</tr></thead><tbody>';

    for (const m of matched) {
        const row60 = findByKey(r60, m.key);
        const row30 = findByKey(r30, m.key);
        const row7 = findByKey(r7, m.key);
        if (!row60 || !row30 || !row7) continue;

        vsHtml += `<tr class="${m.key === keyOf(top60) ? 'gold' : ''}">
            <td><span class="tbadge combo">${row60.combo_name}</span></td>
            <td class="center"><span class="tbadge ptf">${row60.primary_tf}</span></td>
            <td class="center ${num(row60.alpha)>=0?'pos':'neg'}">${fv(row60.alpha)}%</td>
            <td class="center neg">${num(row60.max_drawdown).toFixed(2)}%</td>
            <td class="center">${num(row60.total_trades).toFixed(0)}</td>
            <td class="center ${num(row60.vs_single_tf)>=0?'pos':'neg'}">${fv(row60.vs_single_tf)}%</td>
            <td class="center ${num(row30.alpha)>=0?'pos':'neg'}">${fv(row30.alpha)}%</td>
            <td class="center neg">${num(row30.max_drawdown).toFixed(2)}%</td>
            <td class="center">${num(row30.total_trades).toFixed(0)}</td>
            <td class="center ${num(row30.vs_single_tf)>=0?'pos':'neg'}">${fv(row30.vs_single_tf)}%</td>
            <td class="center ${num(row7.alpha)>=0?'pos':'neg'}">${fv(row7.alpha)}%</td>
            <td class="center neg">${num(row7.max_drawdown).toFixed(2)}%</td>
            <td class="center">${num(row7.total_trades).toFixed(0)}</td>
            <td class="center ${num(row7.vs_single_tf)>=0?'pos':'neg'}">${fv(row7.vs_single_tf)}%</td>
        </tr>`;
    }

    vsHtml += '</tbody></table></div>';
    root.innerHTML += vsHtml;

    // â”€â”€ Detail Tabs â”€â”€
    let tabHtml = `<div class="sec-title"><span class="icon">ğŸ“‹</span> è¯¦ç»†å›æµ‹ç»“æœ</div>`;
    tabHtml += `<div class="tab-wrap">
        <div class="tab-header">
            <div class="tab-btn active" onclick="switchTab(this,'t60')">æœ€è¿‘60å¤©</div>
            <div class="tab-btn" onclick="switchTab(this,'t30')">æœ€è¿‘30å¤©</div>
            <div class="tab-btn" onclick="switchTab(this,'t7')">æœ€è¿‘7å¤©</div>
        </div>
        <div class="tab-body active" id="t60">${buildTbl(r60)}</div>
        <div class="tab-body" id="t30">${buildTbl(r30)}</div>
        <div class="tab-body" id="t7">${buildTbl(r7)}</div>
    </div>`;
    root.innerHTML += tabHtml;

    // â”€â”€ Stats Compare â”€â”€
    let statHtml = `<div class="sec-title"><span class="icon">ğŸ“ˆ</span> æ€»ä½“ç»Ÿè®¡å¯¹æ¯”</div>`;
    statHtml += `<div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>æŒ‡æ ‡</th><th class="center">60å¤©</th><th class="center">30å¤©</th><th class="center">7å¤©</th></tr></thead>
        <tbody>
            <tr><td>å¹³å‡ Alpha</td><td class="center ${num(s60.avg_alpha)>=0?'pos':'neg'}">${fv(s60.avg_alpha)}%</td><td class="center ${num(s30.avg_alpha)>=0?'pos':'neg'}">${fv(s30.avg_alpha)}%</td><td class="center ${num(s7.avg_alpha)>=0?'pos':'neg'}">${fv(s7.avg_alpha)}%</td></tr>
            <tr><td>æœ€ä¼˜ Alpha</td><td class="center ${num(s60.best_alpha)>=0?'pos':'neg'}">${fv(s60.best_alpha)}%</td><td class="center ${num(s30.best_alpha)>=0?'pos':'neg'}">${fv(s30.best_alpha)}%</td><td class="center ${num(s7.best_alpha)>=0?'pos':'neg'}">${fv(s7.best_alpha)}%</td></tr>
            <tr><td>æœ€å·® Alpha</td><td class="center ${num(s60.worst_alpha)>=0?'pos':'neg'}">${fv(s60.worst_alpha)}%</td><td class="center ${num(s30.worst_alpha)>=0?'pos':'neg'}">${fv(s30.worst_alpha)}%</td><td class="center ${num(s7.worst_alpha)>=0?'pos':'neg'}">${fv(s7.worst_alpha)}%</td></tr>
            <tr><td>ç›ˆåˆ©ç­–ç•¥æ•°</td><td class="center">${s60.profitable_count||0} / ${s60.total_count||0}</td><td class="center">${s30.profitable_count||0} / ${s30.total_count||0}</td><td class="center">${s7.profitable_count||0} / ${s7.total_count||0}</td></tr>
            <tr><td>å¹³å‡äº¤æ˜“æ•°</td><td class="center">${num(s60.avg_trades).toFixed(0)}</td><td class="center">${num(s30.avg_trades).toFixed(0)}</td><td class="center">${num(s7.avg_trades).toFixed(0)}</td></tr>
        </tbody>
    </table></div>`;
    root.innerHTML += statHtml;

    // â”€â”€ Strategy Explanation â”€â”€
    root.innerHTML += `
        <div class="sec-title"><span class="icon">ğŸ§ </span> å¤šå‘¨æœŸè”åˆå†³ç­–ç­–ç•¥è¯´æ˜</div>
        <div class="insight-box">
            <h4>ğŸ“ ä»€ä¹ˆæ˜¯å¤šå‘¨æœŸè”åˆå†³ç­–?</h4>
            <ul>
                <li><strong>æ ¸å¿ƒç†å¿µ</strong>: åŒæ—¶è®¡ç®—å¤šä¸ªæ—¶é—´æ¡†æ¶(å¦‚15m/30m/1h/4h/8h/24h)çš„å…­ç»´ä¿¡å·ï¼Œé€šè¿‡åŠ æƒå…±è¯†ç®—æ³•ç»Ÿä¸€å†³ç­–ï¼Œé¿å…å•ä¸€å‘¨æœŸçš„"ä¸€å¶éšœç›®"ã€‚</li>
                <li><strong>åŠ æƒå…±è¯†</strong>: å¤§å‘¨æœŸæƒé‡è¿œé«˜äºå°å‘¨æœŸ (<code>24h=28</code> vs <code>15m=3</code>)ã€‚3ä¸ªå°å‘¨æœŸçœ‹å¤šæ— æ³•å¯¹æŠ—2ä¸ªå¤§å‘¨æœŸçœ‹ç©ºã€‚</li>
                <li><strong>å…±æŒ¯é“¾æ£€æµ‹</strong>: ç›¸é‚»æ—¶é—´æ¡†æ¶è¿ç»­åŒæ–¹å‘ä¿¡å·(å¦‚ <code>1hâ†’4hâ†’8hâ†’24h</code> å…¨çœ‹å¤š)å½¢æˆå…±æŒ¯é“¾ï¼Œä¿¡å·å¯é åº¦æ›´é«˜ã€‚</li>
                <li><strong>å¤§å‘¨æœŸå®šè°ƒ</strong>: â‰¥4h çš„å‘¨æœŸä½œä¸ºè¶‹åŠ¿"è£åˆ¤"ï¼Œå°å‘¨æœŸä¸èƒ½é€†åŠ¿æ“ä½œã€‚å¤§å‘¨æœŸçœ‹å¤šä½†å°å‘¨æœŸçœ‹ç©º â†’ ç­‰å¾…ï¼Œä¸åšç©ºã€‚</li>
                <li><strong>"ä¸»TF"æ¦‚å¿µ</strong>: ä¸»TF(å¦‚1h/4h)å†³å®šäº¤æ˜“é¢‘ç‡å’ŒKçº¿ç²’åº¦ã€‚è¾…åŠ©TFæä¾›æ–¹å‘ç¡®è®¤ã€‚</li>
            </ul>
        </div>
    `;

    // â”€â”€ Insights â”€â”€
    const top5_60 = new Set(r60.slice(0, 5).map(keyOf));
    const top5_30 = new Set(r30.slice(0, 5).map(keyOf));
    const top5_7 = new Set(r7.slice(0, 5).map(keyOf));
    const stableTopKeys = [...top5_60].filter(k => top5_30.has(k) && top5_7.has(k));

    const stableRows = stableTopKeys.map(k => {
        const a60 = num(findByKey(r60, k)?.alpha);
        const a30 = num(findByKey(r30, k)?.alpha);
        const a7 = num(findByKey(r7, k)?.alpha);
        return { key: k, a60, a30, a7, minAlpha: Math.min(a60, a30, a7) };
    }).sort((a, b) => b.minAlpha - a.minAlpha);

    const bestStable = stableRows[0];
    const bestWf = wfRankings[0];
    const avgDecay = num(s60.avg_alpha) - num(s7.avg_alpha);
    const bestDecay = num(s60.best_alpha) - num(s7.best_alpha);
    const regimeHint = avgDecay > 80
        ? 'ä¸­æœŸè¶‹åŠ¿æ›´å¼ºï¼ŒçŸ­å‘¨æœŸå™ªå£°æ›´é«˜'
        : avgDecay > 40
            ? 'ä¸­æœŸä¼˜åŠ¿æ˜æ˜¾ï¼ŒçŸ­å‘¨æœŸä»å¯ç›ˆåˆ©'
            : 'çŸ­ä¸­æœŸè¡¨ç°æ¥è¿‘ï¼Œè·¨çª—å£ç¨³å®šæ€§è¾ƒå¥½';

    root.innerHTML += `
        <div class="sec-title"><span class="icon">ğŸ’¡</span> è‡ªåŠ¨è§£è¯»ï¼ˆæœ¬æ¬¡å›æµ‹ï¼‰</div>
        <div class="insight-box">
            <h4>ğŸ” æ ¸å¿ƒç»“è®º</h4>
            <ul>
                <li><strong>æœ€ä¼˜ç»„åˆ</strong>: 60å¤© <code>${fmtCombo(top60)}</code> (${fv(top60.alpha)}%)ï¼›30å¤© <code>${fmtCombo(top30)}</code> (${fv(top30.alpha)}%)ï¼›7å¤© <code>${fmtCombo(top7)}</code> (${fv(top7.alpha)}%)ã€‚</li>
                <li><strong>çª—å£è¡°å‡</strong>: å¹³å‡ Alpha å˜åŒ– <strong>${fv(avgDecay)}%</strong>ï¼ˆ60å¤©-7å¤©ï¼‰ï¼Œæœ€ä¼˜ Alpha å˜åŒ– <strong>${fv(bestDecay)}%</strong>ï¼Œå½“å‰å¸‚åœºç‰¹å¾å¯å½’çº³ä¸º <strong>${regimeHint}</strong>ã€‚</li>
                <li><strong>ç¨³å®šç»„åˆ</strong>: ${
                    bestStable
                        ? `åœ¨ä¸‰çª—å£éƒ½è¿›å…¥ TOP5 çš„æœ€ä½³ç»„åˆæ˜¯ <code>${bestStable.key}</code>ï¼ŒAlpha ä¸º ${fv(bestStable.a60)}% / ${fv(bestStable.a30)}% / ${fv(bestStable.a7)}%ã€‚`
                        : 'å½“å‰æ²¡æœ‰ç»„åˆåŒæ—¶è¿›å…¥ 60/30/7 ä¸‰çª—å£ TOP5ï¼Œå»ºè®®ä¼˜å…ˆç­›é€‰ 30å¤©å’Œ7å¤©éƒ½ä¸ºæ­£ä¸”å›æ’¤æ›´å°çš„ç»„åˆã€‚'
                }</li>
                <li><strong>WFç¨³å¥æ¦œ</strong>: ${
                    bestWf
                        ? `æ»šåŠ¨éªŒè¯ç¬¬ä¸€åä¸º <code>${bestWf.combo}</code>ï¼ŒAvg Alpha=${fv(bestWf.avg_alpha)}%ï¼ŒMin Alpha=${fv(bestWf.min_alpha)}%ï¼Œèƒœç‡ ${(num(bestWf.win_rate) * 100).toFixed(1)}%ã€‚`
                        : 'æœªç”Ÿæˆ walk-forward ç»“æœï¼ˆå¯èƒ½å·²ç¦ç”¨æˆ–å†å²æ•°æ®ä¸è¶³ï¼‰ã€‚'
                }</li>
                <li><strong>ç›¸å¯¹å•TF</strong>: å¤§å¤šæ•°ç»„åˆçš„ <code>vså•TF</code> ä¸ºæ­£ï¼Œè¯´æ˜å¤šå‘¨æœŸé—¨æ§åœ¨å½“å‰æ ·æœ¬ä¸­æå‡äº†åŒä¸»TFä¸‹çš„è¶…é¢æ”¶ç›Šã€‚</li>
                <li><strong>å®ç›˜å»ºè®®</strong>: è‹¥åç¨³å¥ï¼Œä¼˜å…ˆè€ƒè™‘ 30å¤©å’Œ7å¤©åŒä¸ºæ­£ä¸”å›æ’¤æ›´å°çš„ç»„åˆï¼›è‹¥åè¶‹åŠ¿ï¼Œå‚è€ƒ 60å¤©é¢†å…ˆç»„åˆå¹¶åŠ ä¸¥ä»“ä½ä¸æ­¢æŸçº¦æŸã€‚</li>
            </ul>
        </div>
    `;

    // â”€â”€ äº¤æ˜“æ˜ç»†ï¼ˆTOP1 ç»„åˆçš„å®Œæ•´äº¤æ˜“è®°å½•ï¼‰â”€â”€
    const tradeDetailPeriods = [
        { label: '60å¤©', results: r60 },
        { label: '30å¤©', results: r30 },
        { label: '7å¤©', results: r7 },
    ];
    let tdHtml = `<div class="sec-title"><span class="icon">ğŸ“‹</span> TOP ç»„åˆäº¤æ˜“æ˜ç»†ï¼ˆäººå·¥ Reviewï¼‰</div>`;
    tdHtml += '<div style="margin-bottom:12px;color:var(--text-muted);font-size:0.8rem">ä»…å±•ç¤ºå„çª—å£ TOP1 ç»„åˆçš„å…¨é‡äº¤æ˜“è®°å½•ï¼Œå«æ—¶é—´ã€ä»·æ ¼ã€æ•°é‡ã€è´¹ç”¨ã€PnLã€ä»“ä½å¿«ç…§ç­‰ã€‚</div>';

    tradeDetailPeriods.forEach(p => {
        const top = p.results[0];
        if (!top || !top.trade_details || !top.trade_details.length) return;
        const trades = top.trade_details;
        const comboKey = `${top.combo_name}@${top.primary_tf}`;
        tdHtml += `<details style="margin-bottom:18px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px 16px;">`;
        tdHtml += `<summary style="cursor:pointer;font-weight:600;font-size:0.95rem;">ğŸ“Š ${p.label} Â· ${comboKey} â€” ${trades.length} ç¬”äº¤æ˜“ (Î±=${fv(top.alpha)}%)</summary>`;
        tdHtml += `<div style="overflow-x:auto;margin-top:12px;">`;
        tdHtml += `<table class="dt" style="font-size:0.72rem;white-space:nowrap;">`;
        tdHtml += `<thead><tr>
            <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>æ–¹å‘</th>
            <th class="center">å¸‚åœºä»·</th><th class="center">æˆäº¤ä»·</th>
            <th class="center">æ•°é‡</th><th class="center">åä¹‰ä»·å€¼</th>
            <th class="center">ä¿è¯é‡‘</th><th class="center">æ æ†</th>
            <th class="center">æ‰‹ç»­è´¹</th><th class="center">æ»‘ç‚¹</th>
            <th class="center">PnL</th><th class="center">å…¥åœºä»·</th>
            <th class="center">è´¦æˆ·æ€»å€¼</th><th class="center">å¯ç”¨USDT</th>
            <th>åŸå› </th>
        </tr></thead><tbody>`;
        trades.forEach((t, i) => {
            const actionCls = {
                'OPEN_SHORT': 'neg', 'OPEN_LONG': 'pos',
                'CLOSE_SHORT': 'pos', 'CLOSE_LONG': 'neg',
                'SPOT_BUY': 'pos', 'SPOT_SELL': 'neg',
                'PARTIAL_TP': 'pos', 'LIQUIDATED': 'neg',
            }[t.action] || '';
            const pnlCls = (t.pnl || 0) >= 0 ? 'pos' : 'neg';
            const timeStr = t.time ? t.time.replace('T', ' ').slice(0, 19) : '-';
            const n = v => v != null ? Number(v) : 0;
            tdHtml += `<tr>
                <td>${i + 1}</td>
                <td>${timeStr}</td>
                <td class="${actionCls}" style="font-weight:600">${t.action || '-'}</td>
                <td>${t.direction || '-'}</td>
                <td class="center">${n(t.market_price).toFixed(2)}</td>
                <td class="center">${n(t.exec_price).toFixed(2)}</td>
                <td class="center">${n(t.quantity).toFixed(4)}</td>
                <td class="center">${n(t.notional_value).toFixed(0)}</td>
                <td class="center">${t.margin ? n(t.margin).toFixed(0) : '-'}</td>
                <td class="center">${t.leverage || '-'}x</td>
                <td class="center">${n(t.fee).toFixed(2)}</td>
                <td class="center">${n(t.slippage_cost).toFixed(2)}</td>
                <td class="center ${pnlCls}">${t.pnl != null ? n(t.pnl).toFixed(0) : '-'}</td>
                <td class="center">${t.entry_price ? n(t.entry_price).toFixed(2) : '-'}</td>
                <td class="center">${n(t.after_total).toFixed(0)}</td>
                <td class="center">${n(t.after_available).toFixed(0)}</td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${t.reason||''}">${t.reason || '-'}</td>
            </tr>`;
        });
        tdHtml += '</tbody></table></div>';
        // äº¤æ˜“æ±‡æ€»
        const opens = trades.filter(t => t.action && t.action.startsWith('OPEN'));
        const closes = trades.filter(t => t.action && (t.action.startsWith('CLOSE') || t.action === 'PARTIAL_TP'));
        const totalFees = trades.reduce((s, t) => s + (t.fee || 0) + (t.slippage_cost || 0), 0);
        const totalPnl = closes.reduce((s, t) => s + (t.pnl || 0), 0);
        const wins = closes.filter(t => (t.pnl || 0) > 0).length;
        const losses = closes.filter(t => (t.pnl || 0) < 0).length;
        tdHtml += `<div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:6px;font-size:0.78rem;color:var(--text-secondary)">`;
        tdHtml += `ğŸ“ˆ å¼€ä»“ ${opens.length} æ¬¡ Â· å¹³ä»“ ${closes.length} æ¬¡ Â· ç›ˆåˆ© ${wins} æ¬¡ Â· äºæŸ ${losses} æ¬¡ Â· èƒœç‡ ${closes.length > 0 ? (wins / closes.length * 100).toFixed(0) : '-'}%`;
        tdHtml += ` Â· ç´¯è®¡PnL <span class="${totalPnl>=0?'pos':'neg'}">${totalPnl>=0?'+':''}${totalPnl.toFixed(0)}</span>`;
        tdHtml += ` Â· ç´¯è®¡è´¹ç”¨ ${totalFees.toFixed(0)}`;
        tdHtml += `</div></details>`;
    });
    root.innerHTML += tdHtml;
}

// â”€â”€ Helpers â”€â”€
function fv(v) {
    if (v === null || v === undefined) return '0.00';
    return (v >= 0 ? '+' : '') + Number(v).toFixed(2);
}

function switchTab(btn, id) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-body').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(id).classList.add('active');
}

function buildTbl(results) {
    if (!results || !results.length) return '<p style="color:var(--text-muted)">æš‚æ— æ•°æ®ã€‚è¯·è¿è¡Œ <code>python backtest_multi_tf_30d_7d.py</code> ç”Ÿæˆæ•°æ®ã€‚</p>';
    let h = '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
    h += '<th>#</th><th>æ–¹æ¡ˆ</th><th>ä¸»TF</th><th>å†³ç­–TFs</th><th class="center">Alpha</th>';
    h += '<th class="center">ç­–ç•¥æ”¶ç›Š</th><th class="center">BHæ”¶ç›Š</th><th class="center">å›æ’¤</th>';
    h += '<th class="center">äº¤æ˜“</th><th class="center">vså•TF</th>';
    h += '</tr></thead><tbody>';
    results.forEach((r, i) => {
        const rk = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1);
        const tfs = (r.decision_tfs || []).join(', ');
        h += `<tr class="${i===0?'gold':''}">
            <td>${rk}</td>
            <td><span class="tbadge combo">${r.combo_name}</span></td>
            <td><span class="tbadge ptf">${r.primary_tf}</span></td>
            <td style="font-size:0.75rem;color:var(--text-muted)">${tfs}</td>
            <td class="center ${r.alpha>=0?'pos':'neg'}">${fv(r.alpha)}%</td>
            <td class="center ${r.strategy_return>=0?'pos':'neg'}">${fv(r.strategy_return)}%</td>
            <td class="center ${r.buy_hold_return>=0?'pos':'neg'}">${fv(r.buy_hold_return)}%</td>
            <td class="center neg">${Number(r.max_drawdown || 0).toFixed(2)}%</td>
            <td class="center">${Number(r.total_trades || 0).toFixed(0)}</td>
            <td class="center ${(r.vs_single_tf||0)>=0?'pos':'neg'}">${fv(r.vs_single_tf)}%</td>
        </tr>`;
    });
    h += '</tbody></table></div>';
    return h;
}
</script>
{% endblock %}
