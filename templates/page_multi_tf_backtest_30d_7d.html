{% extends "base.html" %}

{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­– Â· 30å¤© vs 7å¤© å›æµ‹{% endblock %}

{% block extra_styles %}
<style>
    .bt-hero {
        background: linear-gradient(135deg, rgba(168,85,247,0.12), rgba(74,158,255,0.1));
        border: 1px solid var(--border);
        padding: 36px 32px;
        border-radius: 14px;
        margin-bottom: 28px;
    }
    .bt-hero h1 {
        font-size: 1.6rem; font-weight: 700;
        background: linear-gradient(135deg, #a855f7, var(--accent-blue));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin: 0 0 6px 0;
    }
    .bt-hero .subtitle { color: var(--text-secondary); font-size: 0.9rem; }
    .bt-hero .badges { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .bt-hero .badge-item {
        background: rgba(255,255,255,0.06); border: 1px solid var(--border);
        padding: 5px 14px; border-radius: 16px; font-size: 0.8rem; color: var(--text-secondary);
    }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .summary-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
    .summary-card.hl { border-color: #a855f7; background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(74,158,255,0.06)); }
    .summary-card .s-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .summary-card .s-value { font-size: 1.5rem; font-weight: 700; }
    .summary-card .s-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

    .sec-title { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); margin: 32px 0 18px 0; padding-bottom: 10px; border-bottom: 2px solid #a855f7; display: flex; align-items: center; gap: 8px; }
    .sec-title .icon { font-size: 1.1rem; }

    .hbar-chart { margin: 16px 0; }
    .hbar-group { margin-bottom: 18px; }
    .hbar-group-label { font-size: 0.82rem; color: var(--text-primary); margin-bottom: 6px; font-weight: 500; }
    .hbar-row { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
    .hbar-period { width: 32px; font-size: 0.72rem; font-weight: 600; flex-shrink: 0; text-align: right; }
    .hbar-period.p30 { color: #a855f7; }
    .hbar-period.p7 { color: var(--accent-yellow); }
    .hbar-track { flex: 1; height: 22px; background: rgba(255,255,255,0.04); border-radius: 4px; overflow: hidden; }
    .hbar-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; font-size: 0.72rem; font-weight: 600; color: #fff; min-width: 50px; transition: width 0.5s ease; }
    .hbar-fill.f30 { background: linear-gradient(90deg, #a855f7, #818cf8); }
    .hbar-fill.f7 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .hbar-legend { display: flex; gap: 20px; margin-bottom: 14px; font-size: 0.82rem; color: var(--text-secondary); }
    .hbar-legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 3px; vertical-align: middle; margin-right: 4px; }

    .tab-wrap { margin-top: 4px; }
    .tab-header { display: flex; gap: 0; }
    .tab-btn { padding: 10px 24px; border: 1px solid var(--border); border-bottom: none; background: var(--bg-secondary); cursor: pointer; font-size: 0.88rem; font-weight: 600; color: var(--text-muted); border-radius: 8px 8px 0 0; transition: all 0.2s; }
    .tab-btn.active { background: var(--bg-card); color: #a855f7; border-color: #a855f7; border-bottom-color: var(--bg-card); }
    .tab-btn:hover:not(.active) { color: var(--text-secondary); }
    .tab-body { display: none; background: var(--bg-card); border: 1px solid #a855f7; border-top: none; border-radius: 0 8px 8px 8px; padding: 20px; }
    .tab-body.active { display: block; }

    .dt { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .dt th { background: var(--bg-secondary); padding: 10px 8px; text-align: left; font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.4px; border-bottom: 2px solid var(--border); white-space: nowrap; }
    .dt td { padding: 9px 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-variant-numeric: tabular-nums; }
    .dt tr:hover td { background: var(--bg-hover); }
    .dt tr.gold td { background: rgba(168,85,247,0.08); }
    .dt tr.gold:hover td { background: rgba(168,85,247,0.14); }
    .dt .pos { color: var(--accent-green); font-weight: 600; }
    .dt .neg { color: var(--accent-red); font-weight: 600; }
    .dt .center { text-align: center; }

    .tbadge { display: inline-block; padding: 2px 7px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 5px; vertical-align: middle; }
    .tbadge.ptf { background: rgba(168,85,247,0.15); color: #a855f7; }
    .tbadge.combo { background: rgba(74,158,255,0.15); color: var(--accent-blue); }

    .insight-box { background: rgba(168,85,247,0.06); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 20px 24px; margin-top: 16px; }
    .insight-box h4 { color: #a855f7; margin: 0 0 12px 0; font-size: 1rem; }
    .insight-box ul { margin: 0; padding-left: 18px; color: var(--text-secondary); }
    .insight-box li { margin-bottom: 8px; line-height: 1.7; font-size: 0.88rem; }
    .insight-box strong { color: var(--text-primary); }
    .insight-box code { background: rgba(168,85,247,0.12); color: #a855f7; padding: 1px 6px; border-radius: 4px; font-size: 0.82rem; }

    .baseline-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .baseline-box h4 { color: var(--accent-blue); margin: 0 0 12px 0; }

    .ld-box { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }
</style>
{% endblock %}

{% block content %}
<div id="root">
    <div class="ld-box" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 14px; color: var(--text-muted);">æ­£åœ¨åŠ è½½å¤šå‘¨æœŸå›æµ‹æ•°æ®...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/multi_tf_backtest_30d_7d')
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('loading').innerHTML =
                    '<p style="color:var(--accent-red);">' + data.error + '</p>';
                return;
            }
            render(data);
        })
        .catch(err => {
            document.getElementById('loading').innerHTML =
                '<p style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ' + err.message + '</p>';
        });
});

function render(data) {
    const r30 = data.results_30d || [];
    const r7 = data.results_7d || [];
    const s = data.summary || {};
    const s30 = s['30d'] || {};
    const s7 = s['7d'] || {};
    const fm = data.fee_model || {};
    const bc = data.base_config || {};
    const baselines = data.single_tf_baselines || {};

    const root = document.getElementById('root');
    root.innerHTML = '';

    // â”€â”€ Hero â”€â”€
    root.innerHTML += `
        <div class="bt-hero">
            <h1>ğŸ”— å¤šå‘¨æœŸè”åˆå†³ç­– Â· 30å¤© vs 7å¤© å›æµ‹</h1>
            <div class="subtitle">åŠ æƒå…±è¯† + å…±æŒ¯é“¾æ£€æµ‹ Â· å¸å®‰ ETH/USDT çœŸå®Kçº¿ Â· å«æ‰‹ç»­è´¹/æ»‘ç‚¹/èµ„é‡‘è´¹ç‡</div>
            <div class="badges">
                <span class="badge-item">ğŸ§  å¤šå‘¨æœŸè”åˆå†³ç­–</span>
                <span class="badge-item">åŸºçº¿: ${bc.best_single_tf||'1h'} Î±=${fv(bc.best_single_alpha)}%</span>
                <span class="badge-item">Taker ${fm.taker_fee||'0.05%'}</span>
                <span class="badge-item">æ»‘ç‚¹ ${fm.slippage||'0.1%'}</span>
                <span class="badge-item">${data.run_time ? new Date(data.run_time).toLocaleString('zh-CN') : ''}</span>
            </div>
        </div>
    `;

    // â”€â”€ Summary Cards â”€â”€
    root.innerHTML += `
        <div class="summary-grid">
            <div class="summary-card hl">
                <div class="s-label">30å¤©æœ€ä¼˜ Alpha</div>
                <div class="s-value" style="color:${(s30.best_alpha||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s30.best_alpha)}%</div>
                <div class="s-detail">${r30.length?r30[0].combo_name+'@'+r30[0].primary_tf:'-'}</div>
            </div>
            <div class="summary-card hl">
                <div class="s-label">7å¤©æœ€ä¼˜ Alpha</div>
                <div class="s-value" style="color:${(s7.best_alpha||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s7.best_alpha)}%</div>
                <div class="s-detail">${r7.length?r7[0].combo_name+'@'+r7[0].primary_tf:'-'}</div>
            </div>
            <div class="summary-card">
                <div class="s-label">30å¤©å¹³å‡ Alpha</div>
                <div class="s-value" style="color:${(s30.avg_alpha||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s30.avg_alpha)}%</div>
                <div class="s-detail">${s30.profitable_count||0}/${s30.total_count||0} ç­–ç•¥ç›ˆåˆ©</div>
            </div>
            <div class="summary-card">
                <div class="s-label">7å¤©å¹³å‡ Alpha</div>
                <div class="s-value" style="color:${(s7.avg_alpha||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(s7.avg_alpha)}%</div>
                <div class="s-detail">${s7.profitable_count||0}/${s7.total_count||0} ç­–ç•¥ç›ˆåˆ©</div>
            </div>
            <div class="summary-card">
                <div class="s-label">30å¤©å¹³å‡äº¤æ˜“æ•°</div>
                <div class="s-value" style="color:var(--accent-blue)">${s30.avg_trades||0}</div>
                <div class="s-detail">å¤šå‘¨æœŸå…±è¯†è¿‡æ»¤å™ªå£°</div>
            </div>
            <div class="summary-card">
                <div class="s-label">å•TFåŸºçº¿</div>
                <div class="s-value" style="color:var(--text-secondary)">${fv(bc.best_single_alpha)}%</div>
                <div class="s-detail">${bc.best_single_tf||'1h'} Â· ${bc.fusion_mode||'c6_veto_4'}</div>
            </div>
        </div>
    `;

    // â”€â”€ Single TF Baselines â”€â”€
    const bl30 = baselines['30'] || {};
    const bl7 = baselines['7'] || {};
    if (Object.keys(bl30).length || Object.keys(bl7).length) {
        let blHtml = `<div class="sec-title"><span class="icon">ğŸ“</span> å•TFåŸºçº¿å¯¹æ¯” (vs å¤šå‘¨æœŸ)</div>`;
        blHtml += '<div class="baseline-box"><div style="overflow-x:auto"><table class="dt"><thead><tr>';
        blHtml += '<th>ä¸»TF</th><th class="center">30å¤©å•TF Alpha</th><th class="center">30å¤©å¤šTFæœ€ä¼˜</th><th class="center">å·®å¼‚</th>';
        blHtml += '<th class="center">7å¤©å•TF Alpha</th><th class="center">7å¤©å¤šTFæœ€ä¼˜</th><th class="center">å·®å¼‚</th>';
        blHtml += '</tr></thead><tbody>';
        for (const ptf of Object.keys(bl30)) {
            const s30a = bl30[ptf]?.alpha || 0;
            const s7a = (bl7[ptf] || {}).alpha || 0;
            const m30 = r30.find(r => r.primary_tf === ptf);
            const m7 = r7.find(r => r.primary_tf === ptf);
            const m30a = m30 ? m30.alpha : 0;
            const m7a = m7 ? m7.alpha : 0;
            const d30 = m30a - s30a;
            const d7 = m7a - s7a;
            blHtml += `<tr>
                <td><strong>${ptf}</strong></td>
                <td class="center ${s30a>=0?'pos':'neg'}">${fv(s30a)}%</td>
                <td class="center ${m30a>=0?'pos':'neg'}">${fv(m30a)}%</td>
                <td class="center ${d30>=0?'pos':'neg'}">${fv(d30)}%</td>
                <td class="center ${s7a>=0?'pos':'neg'}">${fv(s7a)}%</td>
                <td class="center ${m7a>=0?'pos':'neg'}">${fv(m7a)}%</td>
                <td class="center ${d7>=0?'pos':'neg'}">${fv(d7)}%</td>
            </tr>`;
        }
        blHtml += '</tbody></table></div></div>';
        root.innerHTML += blHtml;
    }

    // â”€â”€ Alpha Bar Chart â”€â”€
    const matched = [];
    for (const s of r30) {
        const m = r7.find(r => r.combo_name === s.combo_name && r.primary_tf === s.primary_tf);
        if (m) matched.push({ label: s.combo_name + '@' + s.primary_tf, a30: s.alpha, a7: m.alpha });
    }
    if (matched.length) {
        const maxA = Math.max(...matched.map(m=>Math.abs(m.a30)), ...matched.map(m=>Math.abs(m.a7)), 1);
        let barHtml = `<div class="sec-title"><span class="icon">ğŸ“Š</span> Alpha å¯è§†åŒ–å¯¹æ¯”</div>`;
        barHtml += '<div class="hbar-legend"><span><span class="hbar-legend-dot" style="background:#a855f7"></span> 30å¤©</span>';
        barHtml += '<span><span class="hbar-legend-dot" style="background:#f59e0b"></span> 7å¤©</span></div>';
        barHtml += '<div class="hbar-chart">';
        for (const m of matched.slice(0, 12)) {
            const w30 = Math.max(3, (Math.abs(m.a30) / maxA) * 100);
            const w7 = Math.max(3, (Math.abs(m.a7) / maxA) * 100);
            barHtml += `
                <div class="hbar-group">
                    <div class="hbar-group-label">${m.label}</div>
                    <div class="hbar-row">
                        <div class="hbar-period p30">30d</div>
                        <div class="hbar-track"><div class="hbar-fill f30" style="width:${w30}%">${fv(m.a30)}%</div></div>
                    </div>
                    <div class="hbar-row">
                        <div class="hbar-period p7">7d</div>
                        <div class="hbar-track"><div class="hbar-fill f7" style="width:${w7}%">${fv(m.a7)}%</div></div>
                    </div>
                </div>`;
        }
        barHtml += '</div>';
        root.innerHTML += barHtml;
    }

    // â”€â”€ VS Table â”€â”€
    let vsHtml = `<div class="sec-title"><span class="icon">âš–ï¸</span> 30å¤© vs 7å¤© é€æ–¹æ¡ˆå¯¹æ¯”</div>`;
    vsHtml += '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
    vsHtml += '<th>æ–¹æ¡ˆ</th><th class="center">ä¸»TF</th>';
    vsHtml += '<th class="center">30å¤©Alpha</th><th class="center">30å¤©å›æ’¤</th><th class="center">30å¤©äº¤æ˜“</th><th class="center">vså•TF</th>';
    vsHtml += '<th class="center">7å¤©Alpha</th><th class="center">7å¤©å›æ’¤</th><th class="center">7å¤©äº¤æ˜“</th><th class="center">vså•TF</th>';
    vsHtml += '</tr></thead><tbody>';
    for (const s of r30) {
        const m = r7.find(r => r.combo_name === s.combo_name && r.primary_tf === s.primary_tf);
        if (!m) continue;
        const isTop = s === r30[0];
        vsHtml += `<tr class="${isTop ? 'gold' : ''}">
            <td><span class="tbadge combo">${s.combo_name}</span></td>
            <td class="center"><span class="tbadge ptf">${s.primary_tf}</span></td>
            <td class="center ${s.alpha>=0?'pos':'neg'}">${fv(s.alpha)}%</td>
            <td class="center neg">${s.max_drawdown.toFixed(2)}%</td>
            <td class="center">${s.total_trades}</td>
            <td class="center ${(s.vs_single_tf||0)>=0?'pos':'neg'}">${fv(s.vs_single_tf)}%</td>
            <td class="center ${m.alpha>=0?'pos':'neg'}">${fv(m.alpha)}%</td>
            <td class="center neg">${m.max_drawdown.toFixed(2)}%</td>
            <td class="center">${m.total_trades}</td>
            <td class="center ${(m.vs_single_tf||0)>=0?'pos':'neg'}">${fv(m.vs_single_tf)}%</td>
        </tr>`;
    }
    vsHtml += '</tbody></table></div>';
    root.innerHTML += vsHtml;

    // â”€â”€ Detail Tabs â”€â”€
    let tabHtml = `<div class="sec-title"><span class="icon">ğŸ“‹</span> è¯¦ç»†å›æµ‹ç»“æœ</div>`;
    tabHtml += `<div class="tab-wrap">
        <div class="tab-header">
            <div class="tab-btn active" onclick="switchTab(this,'t30')">æœ€è¿‘30å¤©</div>
            <div class="tab-btn" onclick="switchTab(this,'t7')">æœ€è¿‘7å¤©</div>
        </div>
        <div class="tab-body active" id="t30">${buildTbl(r30)}</div>
        <div class="tab-body" id="t7">${buildTbl(r7)}</div>
    </div>`;
    root.innerHTML += tabHtml;

    // â”€â”€ Stats Compare â”€â”€
    let statHtml = `<div class="sec-title"><span class="icon">ğŸ“ˆ</span> æ€»ä½“ç»Ÿè®¡å¯¹æ¯”</div>`;
    statHtml += `<div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>æŒ‡æ ‡</th><th class="center">30å¤©</th><th class="center">7å¤©</th></tr></thead>
        <tbody>
            <tr><td>å¹³å‡ Alpha</td><td class="center ${(s30.avg_alpha||0)>=0?'pos':'neg'}">${fv(s30.avg_alpha)}%</td><td class="center ${(s7.avg_alpha||0)>=0?'pos':'neg'}">${fv(s7.avg_alpha)}%</td></tr>
            <tr><td>æœ€ä¼˜ Alpha</td><td class="center ${(s30.best_alpha||0)>=0?'pos':'neg'}">${fv(s30.best_alpha)}%</td><td class="center ${(s7.best_alpha||0)>=0?'pos':'neg'}">${fv(s7.best_alpha)}%</td></tr>
            <tr><td>æœ€å·® Alpha</td>
                <td class="center ${(s30.worst_alpha||0)>=0?'pos':'neg'}">${fv(s30.worst_alpha)}%</td>
                <td class="center ${(s7.worst_alpha||0)>=0?'pos':'neg'}">${fv(s7.worst_alpha)}%</td></tr>
            <tr><td>ç›ˆåˆ©ç­–ç•¥æ•°</td><td class="center">${s30.profitable_count||0} / ${s30.total_count||0}</td><td class="center">${s7.profitable_count||0} / ${s7.total_count||0}</td></tr>
            <tr><td>å¹³å‡äº¤æ˜“æ•°</td><td class="center">${s30.avg_trades||0}</td><td class="center">${s7.avg_trades||0}</td></tr>
        </tbody>
    </table></div>`;
    root.innerHTML += statHtml;

    // â”€â”€ Strategy Explanation â”€â”€
    root.innerHTML += `
        <div class="sec-title"><span class="icon">ğŸ§ </span> å¤šå‘¨æœŸè”åˆå†³ç­–ç­–ç•¥è¯´æ˜</div>
        <div class="insight-box">
            <h4>ğŸ“ ä»€ä¹ˆæ˜¯å¤šå‘¨æœŸè”åˆå†³ç­–?</h4>
            <ul>
                <li><strong>æ ¸å¿ƒç†å¿µ</strong>: åŒæ—¶è®¡ç®—å¤šä¸ªæ—¶é—´æ¡†æ¶(å¦‚15m/30m/1h/4h/8h/24h)çš„å…­ç»´ä¿¡å·ï¼Œé€šè¿‡åŠ æƒå…±è¯†ç®—æ³•ç»Ÿä¸€å†³ç­–ï¼Œé¿å…å•ä¸€å‘¨æœŸçš„"ä¸€å¶éšœç›®"ã€‚</li>
                <li><strong>åŠ æƒå…±è¯†</strong>: å¤§å‘¨æœŸæƒé‡è¿œé«˜äºå°å‘¨æœŸ (<code>24h=28</code> vs <code>15m=3</code>)ã€‚3ä¸ªå°å‘¨æœŸçœ‹å¤šæ— æ³•å¯¹æŠ—2ä¸ªå¤§å‘¨æœŸçœ‹ç©ºã€‚</li>
                <li><strong>å…±æŒ¯é“¾æ£€æµ‹</strong>: ç›¸é‚»æ—¶é—´æ¡†æ¶è¿ç»­åŒæ–¹å‘ä¿¡å·(å¦‚ <code>1hâ†’4hâ†’8hâ†’24h</code> å…¨çœ‹å¤š)å½¢æˆå…±æŒ¯é“¾ï¼Œä¿¡å·å¯é åº¦æ›´é«˜ã€‚</li>
                <li><strong>å¤§å‘¨æœŸå®šè°ƒ</strong>: â‰¥4hçš„å‘¨æœŸä½œä¸ºè¶‹åŠ¿"è£åˆ¤"ï¼Œå°å‘¨æœŸä¸èƒ½é€†åŠ¿æ“ä½œã€‚å¤§å‘¨æœŸçœ‹å¤šä½†å°å‘¨æœŸçœ‹ç©º â†’ ç­‰å¾…ï¼Œä¸åšç©ºã€‚</li>
                <li><strong>"ä¸»TF"æ¦‚å¿µ</strong>: ä¸»TF(å¦‚1h/4h)å†³å®šäº¤æ˜“é¢‘ç‡å’ŒKçº¿ç²’åº¦ã€‚è¾…åŠ©TFæä¾›æ–¹å‘ç¡®è®¤ã€‚</li>
            </ul>
        </div>
    `;

    // â”€â”€ Insights â”€â”€
    root.innerHTML += `
        <div class="sec-title"><span class="icon">ğŸ’¡</span> å…³é”®å‘ç°</div>
        <div class="insight-box">
            <h4>ğŸ” å›æµ‹ç»“è®º</h4>
            <ul>
                <li><strong>å¤šå‘¨æœŸ vs å•TF</strong>: "vså•TF"åˆ—æ˜¾ç¤ºå¤šå‘¨æœŸç­–ç•¥æ˜¯å¦è¶…è¶Šäº†ç›¸åŒä¸»TFçš„å•å‘¨æœŸç­–ç•¥ã€‚æ­£å€¼è¡¨ç¤ºå¤šå‘¨æœŸå¸¦æ¥äº†é¢å¤–Alphaã€‚</li>
                <li><strong>äº¤æ˜“æ¬¡æ•°å‡å°‘</strong>: å¤šå‘¨æœŸå…±è¯†å¤©ç„¶è¿‡æ»¤äº†å•TFçš„å‡ä¿¡å·ï¼Œäº¤æ˜“æ¬¡æ•°é€šå¸¸å°‘äºå•TFï¼Œé™ä½äº†æ‰‹ç»­è´¹æˆæœ¬ã€‚</li>
                <li><strong>ä¸åŒTFç»„åˆè¡¨ç°å·®å¼‚å¤§</strong>: "æ ¸å¿ƒå‘¨æœŸ"å’Œ"å¤§å‘¨æœŸ"ç»„åˆé€šå¸¸æ›´ç¨³å¥ï¼Œ"å…¨å‘¨æœŸ"æ–¹æ¡ˆä¿¡å·æ›´åˆ†æ•£å¯èƒ½å¯¼è‡´çŠ¹è±«ã€‚</li>
                <li><strong>ä¸»TFé€‰æ‹©å¾ˆå…³é”®</strong>: åŒä¸€ä¸ªTFç»„åˆé…ä¸åŒä¸»TFï¼ŒAlphaå·®å¼‚å¯è¾¾æ•°åä¸ªç™¾åˆ†ç‚¹ã€‚éœ€è¦æ ¹æ®å¸‚åœºèŠ‚å¥é€‰æ‹©åˆé€‚çš„ä¸»TFã€‚</li>
                <li><strong>30å¤© vs 7å¤©ç¨³å®šæ€§</strong>: ä¸¤ä¸ªå‘¨æœŸAlphaæ–¹å‘ä¸€è‡´çš„ç­–ç•¥å…·å¤‡æ›´å¼ºçš„é²æ£’æ€§ï¼Œé€‚åˆå®ç›˜ä½¿ç”¨ã€‚</li>
            </ul>
        </div>
    `;
}

// â”€â”€ Helpers â”€â”€
function fv(v) {
    if (v === null || v === undefined) return '0.00';
    return (v >= 0 ? '+' : '') + Number(v).toFixed(2);
}

function switchTab(btn, id) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-body').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(id).classList.add('active');
}

function buildTbl(results) {
    if (!results || !results.length) return '<p style="color:var(--text-muted)">æš‚æ— æ•°æ®ã€‚è¯·è¿è¡Œ <code>python backtest_multi_tf_30d_7d.py</code> ç”Ÿæˆæ•°æ®ã€‚</p>';
    let h = '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
    h += '<th>#</th><th>æ–¹æ¡ˆ</th><th>ä¸»TF</th><th>å†³ç­–TFs</th><th class="center">Alpha</th>';
    h += '<th class="center">ç­–ç•¥æ”¶ç›Š</th><th class="center">BHæ”¶ç›Š</th><th class="center">å›æ’¤</th>';
    h += '<th class="center">äº¤æ˜“</th><th class="center">vså•TF</th>';
    h += '</tr></thead><tbody>';
    results.forEach((r, i) => {
        const rk = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i+1);
        const tfs = (r.decision_tfs || []).join(', ');
        h += `<tr class="${i===0?'gold':''}">
            <td>${rk}</td>
            <td><span class="tbadge combo">${r.combo_name}</span></td>
            <td><span class="tbadge ptf">${r.primary_tf}</span></td>
            <td style="font-size:0.75rem;color:var(--text-muted)">${tfs}</td>
            <td class="center ${r.alpha>=0?'pos':'neg'}">${fv(r.alpha)}%</td>
            <td class="center ${r.strategy_return>=0?'pos':'neg'}">${fv(r.strategy_return)}%</td>
            <td class="center ${r.buy_hold_return>=0?'pos':'neg'}">${fv(r.buy_hold_return)}%</td>
            <td class="center neg">${r.max_drawdown.toFixed(2)}%</td>
            <td class="center">${r.total_trades}</td>
            <td class="center ${(r.vs_single_tf||0)>=0?'pos':'neg'}">${fv(r.vs_single_tf)}%</td>
        </tr>`;
    });
    h += '</tbody></table></div>';
    return h;
}
</script>
{% endblock %}
