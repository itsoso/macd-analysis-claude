{% extends "base.html" %}

{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­– Â· 60å¤©/30å¤©/7å¤© å›æµ‹{% endblock %}

{% block extra_styles %}
<style>
    .bt-hero {
        background: linear-gradient(135deg, rgba(168,85,247,0.12), rgba(74,158,255,0.1));
        border: 1px solid var(--border);
        padding: 36px 32px;
        border-radius: 14px;
        margin-bottom: 28px;
    }
    .bt-hero h1 {
        font-size: 1.6rem; font-weight: 700;
        background: linear-gradient(135deg, #a855f7, var(--accent-blue));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin: 0 0 6px 0;
    }
    .bt-hero .subtitle { color: var(--text-secondary); font-size: 0.9rem; }
    .bt-hero .badges { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .bt-hero .badge-item {
        background: rgba(255,255,255,0.06); border: 1px solid var(--border);
        padding: 5px 14px; border-radius: 16px; font-size: 0.8rem; color: var(--text-secondary);
    }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .summary-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
    .summary-card.hl { border-color: #a855f7; background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(74,158,255,0.06)); }
    .summary-card .s-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .summary-card .s-value { font-size: 1.5rem; font-weight: 700; }
    .summary-card .s-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

    .sec-title { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); margin: 32px 0 18px 0; padding-bottom: 10px; border-bottom: 2px solid #a855f7; display: flex; align-items: center; gap: 8px; }
    .sec-title .icon { font-size: 1.1rem; }

    .hbar-chart { margin: 16px 0; }
    .hbar-group { margin-bottom: 18px; }
    .hbar-group-label { font-size: 0.82rem; color: var(--text-primary); margin-bottom: 6px; font-weight: 500; }
    .hbar-row { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
    .hbar-period { width: 32px; font-size: 0.72rem; font-weight: 600; flex-shrink: 0; text-align: right; }
    .hbar-period.p60 { color: #22c55e; }
    .hbar-period.p30 { color: #a855f7; }
    .hbar-period.p7 { color: var(--accent-yellow); }
    .hbar-track { flex: 1; height: 22px; background: rgba(255,255,255,0.04); border-radius: 4px; overflow: hidden; }
    .hbar-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; font-size: 0.72rem; font-weight: 600; color: #fff; min-width: 50px; transition: width 0.5s ease; }
    .hbar-fill.f60 { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .hbar-fill.f30 { background: linear-gradient(90deg, #a855f7, #818cf8); }
    .hbar-fill.f7 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .hbar-legend { display: flex; gap: 20px; margin-bottom: 14px; font-size: 0.82rem; color: var(--text-secondary); }
    .hbar-legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 3px; vertical-align: middle; margin-right: 4px; }

    .tab-wrap { margin-top: 4px; }
    .tab-header { display: flex; gap: 0; }
    .tab-btn { padding: 10px 24px; border: 1px solid var(--border); border-bottom: none; background: var(--bg-secondary); cursor: pointer; font-size: 0.88rem; font-weight: 600; color: var(--text-muted); border-radius: 8px 8px 0 0; transition: all 0.2s; }
    .tab-btn.active { background: var(--bg-card); color: #a855f7; border-color: #a855f7; border-bottom-color: var(--bg-card); }
    .tab-btn:hover:not(.active) { color: var(--text-secondary); }
    .tab-body { display: none; background: var(--bg-card); border: 1px solid #a855f7; border-top: none; border-radius: 0 8px 8px 8px; padding: 20px; }
    .tab-body.active { display: block; }

    .dt { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .dt th { background: var(--bg-secondary); padding: 10px 8px; text-align: left; font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.4px; border-bottom: 2px solid var(--border); white-space: nowrap; }
    .dt td { padding: 9px 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-variant-numeric: tabular-nums; }
    .dt tr:hover td { background: var(--bg-hover); }
    .dt tr.gold td { background: rgba(168,85,247,0.08); }
    .dt tr.gold:hover td { background: rgba(168,85,247,0.14); }
    .dt .pos { color: var(--accent-green); font-weight: 600; }
    .dt .neg { color: var(--accent-red); font-weight: 600; }
    .dt .center { text-align: center; }

    .tbadge { display: inline-block; padding: 2px 7px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 5px; vertical-align: middle; }
    .tbadge.ptf { background: rgba(168,85,247,0.15); color: #a855f7; }
    .tbadge.combo { background: rgba(74,158,255,0.15); color: var(--accent-blue); }

    .insight-box { background: rgba(168,85,247,0.06); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 20px 24px; margin-top: 16px; }
    .insight-box h4 { color: #a855f7; margin: 0 0 12px 0; font-size: 1rem; }
    .insight-box ul { margin: 0; padding-left: 18px; color: var(--text-secondary); }
    .insight-box li { margin-bottom: 8px; line-height: 1.7; font-size: 0.88rem; }
    .insight-box strong { color: var(--text-primary); }
    .insight-box code { background: rgba(168,85,247,0.12); color: #a855f7; padding: 1px 6px; border-radius: 4px; font-size: 0.82rem; }

    .baseline-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .baseline-box h4 { color: var(--accent-blue); margin: 0 0 12px 0; }

    .ld-box { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }

    .interp-box { background: rgba(34,197,94,0.06); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px; padding: 20px 24px; margin-top: 16px; }
    .interp-box h4 { color: #22c55e; margin: 0 0 12px 0; font-size: 1rem; }
    .interp-box ul { margin: 0; padding-left: 18px; color: var(--text-secondary); }
    .interp-box li { margin-bottom: 8px; line-height: 1.7; font-size: 0.88rem; }
    .interp-box strong { color: var(--text-primary); }
</style>
{% endblock %}

{% block content %}
<div id="root">
    <div class="ld-box" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 14px; color: var(--text-muted);">æ­£åœ¨åŠ è½½å¤šå‘¨æœŸå›æµ‹æ•°æ®...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/multi_tf_backtest_30d_7d')
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('loading').innerHTML =
                    '<p style="color:var(--accent-red);">' + data.error + '</p>';
                return;
            }
            render(data);
        })
        .catch(err => {
            document.getElementById('loading').innerHTML =
                '<p style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ' + err.message + '</p>';
        });
});

function render(data) {
    const r60 = data.results_60d || [];
    const r30 = data.results_30d || [];
    const r7 = data.results_7d || [];
    const s = data.summary || {};
    const s60 = s['60d'] || {};
    const s30 = s['30d'] || {};
    const s7 = s['7d'] || {};
    const fm = data.fee_model || {};
    const bc = data.base_config || {};
    const baselines = data.single_tf_baselines || {};
    const hasR60 = r60.length > 0;

    const root = document.getElementById('root');
    root.innerHTML = '';

    // â”€â”€ Hero â”€â”€
    const periodLabel = hasR60 ? '60å¤©/30å¤©/7å¤©' : '30å¤©/7å¤©';
    root.innerHTML += `
        <div class="bt-hero">
            <h1>ğŸ”— å¤šå‘¨æœŸè”åˆå†³ç­– Â· ${periodLabel} å›æµ‹</h1>
            <div class="subtitle">ç»Ÿä¸€ fuse_tf_scores èåˆç®—æ³• Â· å¸å®‰ ETH/USDT çœŸå®Kçº¿ Â· å«æ‰‹ç»­è´¹/æ»‘ç‚¹/èµ„é‡‘è´¹ç‡</div>
            <div class="badges">
                <span class="badge-item">ğŸ§  å¤šå‘¨æœŸè”åˆå†³ç­–</span>
                <span class="badge-item">èåˆ: fuse_tf_scores (å›æµ‹/å®ç›˜ç»Ÿä¸€)</span>
                <span class="badge-item">åŸºçº¿: ${bc.best_single_tf||'1h'} Î±=${fv(bc.best_single_alpha)}%</span>
                <span class="badge-item">Taker ${fm.taker_fee||'0.05%'} Â· æ»‘ç‚¹ ${fm.slippage||'0.1%'}</span>
                <span class="badge-item">${data.run_time ? new Date(data.run_time).toLocaleString('zh-CN') : ''}</span>
            </div>
        </div>
    `;

    // â”€â”€ Summary Cards â”€â”€
    const periods = [];
    if (hasR60) periods.push({label:'60å¤©', s: s60, r: r60, color:'#22c55e'});
    periods.push({label:'30å¤©', s: s30, r: r30, color:'#a855f7'});
    periods.push({label:'7å¤©', s: s7, r: r7, color:'#f59e0b'});

    let cardsHtml = '<div class="summary-grid">';
    for (const p of periods) {
        cardsHtml += `
            <div class="summary-card hl">
                <div class="s-label">${p.label}æœ€ä¼˜ Alpha</div>
                <div class="s-value" style="color:${(p.s.best_alpha||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(p.s.best_alpha)}%</div>
                <div class="s-detail">${p.r.length?p.r[0].combo_name+'@'+p.r[0].primary_tf:'-'}</div>
            </div>`;
    }
    for (const p of periods) {
        cardsHtml += `
            <div class="summary-card">
                <div class="s-label">${p.label}å¹³å‡ Alpha</div>
                <div class="s-value" style="color:${(p.s.avg_alpha||0)>=0?'var(--accent-green)':'var(--accent-red)'}">${fv(p.s.avg_alpha)}%</div>
                <div class="s-detail">${p.s.profitable_count||0}/${p.s.total_count||0} ç­–ç•¥ç›ˆåˆ© Â· å¹³å‡${p.s.avg_trades||0}ç¬”äº¤æ˜“</div>
            </div>`;
    }
    cardsHtml += `
        <div class="summary-card">
            <div class="s-label">å•TFåŸºçº¿</div>
            <div class="s-value" style="color:var(--text-secondary)">${fv(bc.best_single_alpha)}%</div>
            <div class="s-detail">${bc.best_single_tf||'1h'} Â· ${bc.fusion_mode||'c6_veto_4'}</div>
        </div>
    </div>`;
    root.innerHTML += cardsHtml;

    // â”€â”€ Alpha Bar Chart â”€â”€
    const primaryList = hasR60 ? r60 : r30;
    const matched = [];
    for (const s of primaryList) {
        const m30 = r30.find(r => r.combo_name === s.combo_name && r.primary_tf === s.primary_tf);
        const m7 = r7.find(r => r.combo_name === s.combo_name && r.primary_tf === s.primary_tf);
        const m60 = hasR60 ? r60.find(r => r.combo_name === s.combo_name && r.primary_tf === s.primary_tf) : null;
        if (m30 && m7) matched.push({
            label: s.combo_name + '@' + s.primary_tf,
            a60: m60 ? m60.alpha : null, a30: m30.alpha, a7: m7.alpha
        });
    }
    if (matched.length) {
        const allVals = matched.flatMap(m => [Math.abs(m.a30), Math.abs(m.a7), ...(m.a60 !== null ? [Math.abs(m.a60)] : [])]);
        const maxA = Math.max(...allVals, 1);
        let barHtml = `<div class="sec-title"><span class="icon">ğŸ“Š</span> Alpha å¯è§†åŒ–å¯¹æ¯”</div>`;
        barHtml += '<div class="hbar-legend">';
        if (hasR60) barHtml += '<span><span class="hbar-legend-dot" style="background:#22c55e"></span> 60å¤©</span>';
        barHtml += '<span><span class="hbar-legend-dot" style="background:#a855f7"></span> 30å¤©</span>';
        barHtml += '<span><span class="hbar-legend-dot" style="background:#f59e0b"></span> 7å¤©</span></div>';
        barHtml += '<div class="hbar-chart">';
        for (const m of matched.slice(0, 10)) {
            barHtml += `<div class="hbar-group"><div class="hbar-group-label">${m.label}</div>`;
            if (m.a60 !== null) {
                const w = Math.max(3, (Math.abs(m.a60) / maxA) * 100);
                barHtml += `<div class="hbar-row"><div class="hbar-period p60">60d</div>
                    <div class="hbar-track"><div class="hbar-fill f60" style="width:${w}%">${fv(m.a60)}%</div></div></div>`;
            }
            const w30 = Math.max(3, (Math.abs(m.a30) / maxA) * 100);
            const w7 = Math.max(3, (Math.abs(m.a7) / maxA) * 100);
            barHtml += `
                <div class="hbar-row"><div class="hbar-period p30">30d</div>
                    <div class="hbar-track"><div class="hbar-fill f30" style="width:${w30}%">${fv(m.a30)}%</div></div></div>
                <div class="hbar-row"><div class="hbar-period p7">7d</div>
                    <div class="hbar-track"><div class="hbar-fill f7" style="width:${w7}%">${fv(m.a7)}%</div></div></div>
            </div>`;
        }
        barHtml += '</div>';
        root.innerHTML += barHtml;
    }

    // â”€â”€ Detail Tabs â”€â”€
    let tabHtml = `<div class="sec-title"><span class="icon">ğŸ“‹</span> è¯¦ç»†å›æµ‹ç»“æœ</div>`;
    tabHtml += `<div class="tab-wrap"><div class="tab-header">`;
    if (hasR60) tabHtml += `<div class="tab-btn active" onclick="switchTab(this,'t60')">æœ€è¿‘60å¤©</div>`;
    tabHtml += `<div class="tab-btn ${hasR60?'':'active'}" onclick="switchTab(this,'t30')">æœ€è¿‘30å¤©</div>`;
    tabHtml += `<div class="tab-btn" onclick="switchTab(this,'t7')">æœ€è¿‘7å¤©</div>`;
    tabHtml += `</div>`;
    if (hasR60) tabHtml += `<div class="tab-body active" id="t60">${buildTbl(r60)}</div>`;
    tabHtml += `<div class="tab-body ${hasR60?'':'active'}" id="t30">${buildTbl(r30)}</div>`;
    tabHtml += `<div class="tab-body" id="t7">${buildTbl(r7)}</div>`;
    tabHtml += `</div>`;
    root.innerHTML += tabHtml;

    // â”€â”€ Stats Compare â”€â”€
    let statHtml = `<div class="sec-title"><span class="icon">ğŸ“ˆ</span> æ€»ä½“ç»Ÿè®¡å¯¹æ¯”</div>`;
    statHtml += `<div style="overflow-x:auto"><table class="dt"><thead><tr><th>æŒ‡æ ‡</th>`;
    for (const p of periods) statHtml += `<th class="center">${p.label}</th>`;
    statHtml += `</tr></thead><tbody>`;
    const statRows = [
        {label: 'å¹³å‡ Alpha', fn: s => fv(s.avg_alpha)+'%', cls: s => (s.avg_alpha||0) >= 0 ? 'pos' : 'neg'},
        {label: 'æœ€ä¼˜ Alpha', fn: s => fv(s.best_alpha)+'%', cls: s => (s.best_alpha||0) >= 0 ? 'pos' : 'neg'},
        {label: 'æœ€å·® Alpha', fn: s => fv(s.worst_alpha)+'%', cls: s => (s.worst_alpha||0) >= 0 ? 'pos' : 'neg'},
        {label: 'ç›ˆåˆ©ç­–ç•¥æ•°', fn: s => (s.profitable_count||0) + ' / ' + (s.total_count||0), cls: () => ''},
        {label: 'å¹³å‡äº¤æ˜“æ•°', fn: s => String(s.avg_trades||0), cls: () => ''},
    ];
    for (const row of statRows) {
        statHtml += `<tr><td>${row.label}</td>`;
        for (const p of periods) statHtml += `<td class="center ${row.cls(p.s)}">${row.fn(p.s)}</td>`;
        statHtml += `</tr>`;
    }
    statHtml += `</tbody></table></div>`;
    root.innerHTML += statHtml;

    // â”€â”€ Data-Driven Interpretation â”€â”€
    root.innerHTML += buildInterpretation(r60, r30, r7, s60, s30, s7, baselines, bc);

    // â”€â”€ Strategy Explanation â”€â”€
    root.innerHTML += `
        <div class="sec-title"><span class="icon">ğŸ§ </span> å¤šå‘¨æœŸè”åˆå†³ç­–ç­–ç•¥è¯´æ˜</div>
        <div class="insight-box">
            <h4>ğŸ“ ä»€ä¹ˆæ˜¯å¤šå‘¨æœŸè”åˆå†³ç­–?</h4>
            <ul>
                <li><strong>æ ¸å¿ƒç†å¿µ</strong>: åŒæ—¶è®¡ç®—å¤šä¸ªæ—¶é—´æ¡†æ¶(å¦‚15m/30m/1h/4h/8h/24h)çš„å…­ç»´ä¿¡å·ï¼Œé€šè¿‡ <code>fuse_tf_scores</code> ç»Ÿä¸€èåˆç®—æ³•å†³ç­–ï¼Œå›æµ‹ä¸å®ç›˜ä½¿ç”¨å®Œå…¨ç›¸åŒçš„é€»è¾‘ã€‚</li>
                <li><strong>è¿ç»­åˆ†æ•°èåˆ</strong>: å„TFçš„å–å‡ºåˆ†(ss)å’Œä¹°å…¥åˆ†(bs)ç›´æ¥åŠ æƒå¹³å‡ï¼Œä¿ç•™åˆ†æ•°è¿ç»­ä¿¡æ¯ï¼Œé¿å…å…ˆç¦»æ•£åŒ–å†åˆå¹¶çš„ä¿¡æ¯æŸå¤±ã€‚</li>
                <li><strong>å¤§å°å‘¨æœŸè¡°å‡</strong>: å¤§å‘¨æœŸ(â‰¥4h)åç©ºä½†å°å‘¨æœŸåå¤šæ—¶ï¼Œä¹°å…¥ä¿¡å·è¡°å‡50%ï¼›åä¹‹å–å‡ºä¿¡å·è¡°å‡50%ã€‚</li>
                <li><strong>å…±æŒ¯é“¾å¢å¼º</strong>: ç›¸é‚»TFè¿ç»­åŒå‘(å¦‚ <code>1hâ†’4hâ†’8h</code>)å½¢æˆå…±æŒ¯é“¾ï¼Œè·¨4hä»¥ä¸Šçš„3çº§ä»¥ä¸Šå…±æŒ¯ä¿¡å·å¢å¼º+24%ã€‚</li>
                <li><strong>Coverageé—¨æ§</strong>: å®ç›˜æ—¶å¦‚æœéƒ¨åˆ†TFæ•°æ®ç¼ºå¤±ï¼Œä¿¡å·æŒ‰è¦†ç›–ç‡çº¿æ€§è¡°å‡ï¼›ä½äº50%ç›´æ¥ fail-closedã€‚</li>
            </ul>
        </div>
    `;
}

function buildInterpretation(r60, r30, r7, s60, s30, s7, baselines, bc) {
    const findings = [];
    const hasR60 = r60.length > 0;

    // 1. æ•´ä½“è¡¨ç°
    if (hasR60 && s60.avg_alpha !== undefined) {
        const allPositive = s60.profitable_count === s60.total_count
            && s30.profitable_count === s30.total_count
            && s7.profitable_count === s7.total_count;
        if (allPositive) {
            findings.push(`<strong>å…¨é¢ç›ˆåˆ©</strong>: æ‰€æœ‰ ${s60.total_count} ç§ç­–ç•¥ç»„åˆåœ¨60å¤©ã€30å¤©ã€7å¤©ä¸‰ä¸ªå‘¨æœŸå†…å…¨éƒ¨å®ç°æ­£Alphaï¼Œå¤šå‘¨æœŸè”åˆå†³ç­–æ˜¾è‘—é™ä½äº†äºæŸé£é™©ã€‚`);
        }
    }

    // 2. æœ€ä½³æ–¹æ¡ˆ
    const best60 = r60.length ? r60[0] : null;
    const best30 = r30.length ? r30[0] : null;
    const best7 = r7.length ? r7[0] : null;
    if (best60) {
        findings.push(`<strong>60å¤©æœ€ä¼˜</strong>: <code>${best60.combo_name}@${best60.primary_tf}</code> Î±=${fv(best60.alpha)}%ï¼Œç­–ç•¥æ”¶ç›Š${fv(best60.strategy_return)}%ï¼Œå…±${best60.total_trades}ç¬”äº¤æ˜“ã€‚`);
    }
    if (best30) {
        findings.push(`<strong>30å¤©æœ€ä¼˜</strong>: <code>${best30.combo_name}@${best30.primary_tf}</code> Î±=${fv(best30.alpha)}%ã€‚`);
    }

    // 3. ç¨³å®šæ€§åˆ†æ
    if (hasR60 && r30.length && r7.length) {
        // æ‰¾åœ¨ä¸‰ä¸ªå‘¨æœŸä¸­æ’åéƒ½åœ¨å‰5çš„æ–¹æ¡ˆ
        const top5_60 = new Set(r60.slice(0, 5).map(r => r.combo_name + '@' + r.primary_tf));
        const top5_30 = new Set(r30.slice(0, 5).map(r => r.combo_name + '@' + r.primary_tf));
        const top5_7 = new Set(r7.slice(0, 5).map(r => r.combo_name + '@' + r.primary_tf));
        const stableWinners = [...top5_60].filter(k => top5_30.has(k) || top5_7.has(k));
        if (stableWinners.length > 0) {
            findings.push(`<strong>ç¨³å¥æ–¹æ¡ˆ</strong>: ${stableWinners.map(k => '<code>' + k + '</code>').join('ã€')} åœ¨å¤šä¸ªå›æµ‹å‘¨æœŸä¸­éƒ½ä½åˆ—å‰5ï¼Œå…·å¤‡è¾ƒå¼ºçš„è·¨å‘¨æœŸé²æ£’æ€§ï¼Œé€‚åˆä½œä¸ºå®ç›˜å€™é€‰ã€‚`);
        }
    }

    // 4. Alphaè¡°å‡/å¢é•¿è¶‹åŠ¿
    if (hasR60 && s60.avg_alpha !== undefined && s30.avg_alpha !== undefined && s7.avg_alpha !== undefined) {
        const avgPerDay60 = s60.avg_alpha / 60;
        const avgPerDay30 = s30.avg_alpha / 30;
        const avgPerDay7 = s7.avg_alpha / 7;
        if (avgPerDay7 > avgPerDay30 && avgPerDay30 > avgPerDay60) {
            findings.push(`<strong>è¿‘æœŸåŠ é€Ÿ</strong>: æ—¥å‡Alpha 7å¤©(${avgPerDay7.toFixed(2)}%/d) > 30å¤©(${avgPerDay30.toFixed(2)}%/d) > 60å¤©(${avgPerDay60.toFixed(2)}%/d)ï¼Œç­–ç•¥åœ¨è¿‘æœŸå¸‚åœºç¯å¢ƒä¸‹è¡¨ç°æ›´ä½³ï¼Œå¯èƒ½å¤„äºç­–ç•¥é€‚é…æœŸã€‚`);
        } else if (avgPerDay60 > avgPerDay30 && avgPerDay30 > avgPerDay7) {
            findings.push(`<strong>è¿‘æœŸè¡°å‡</strong>: æ—¥å‡Alpha 60å¤©(${avgPerDay60.toFixed(2)}%/d) > 30å¤©(${avgPerDay30.toFixed(2)}%/d) > 7å¤©(${avgPerDay7.toFixed(2)}%/d)ï¼Œè¿‘æœŸå¸‚åœºç¯å¢ƒå¯èƒ½å¯¹ç­–ç•¥ä¸åˆ©ï¼Œéœ€è¦å…³æ³¨å‚æ•°é€‚é…æ€§ã€‚`);
        }
    }

    // 5. vs å•TFæå‡
    if (r30.length) {
        const avgVsSingle = r30.reduce((s, r) => s + (r.vs_single_tf || 0), 0) / r30.length;
        if (avgVsSingle > 0) {
            findings.push(`<strong>å¤šå‘¨æœŸä¼˜åŠ¿</strong>: 30å¤©å¹³å‡ vs å•TF æå‡ ${fv(avgVsSingle)}%ï¼Œå¤šå‘¨æœŸè”åˆå†³ç­–æ¯”å•ä¸€æ—¶é—´æ¡†æ¶ç­–ç•¥å¹³å‡å¤šè·å¾—äº† ${Math.abs(avgVsSingle).toFixed(1)}% çš„Alphaã€‚`);
        }
    }

    // 6. å›æ’¤è­¦å‘Š
    if (r60.length) {
        const worstDD = Math.min(...r60.map(r => r.max_drawdown));
        if (worstDD < -30) {
            findings.push(`<strong>âš ï¸ å›æ’¤æé†’</strong>: æœ€å¤§å›æ’¤è¾¾åˆ° ${worstDD.toFixed(1)}%ï¼Œå°½ç®¡Alphaä¸ºæ­£ï¼Œä½†è¿‡ç¨‹ä¸­å­˜åœ¨è¾ƒå¤§æµ®äºã€‚å®ç›˜éœ€é…åˆä¸¥æ ¼çš„é£æ§å’Œä»“ä½ç®¡ç†ã€‚`);
        }
    }

    let html = `<div class="sec-title"><span class="icon">ğŸ”</span> æ•°æ®è§£è¯»ä¸ç»“è®º</div>`;
    html += `<div class="interp-box"><h4>ğŸ“Š è‡ªåŠ¨åˆ†æ (åŸºäºæœ¬æ¬¡å›æµ‹æ•°æ®)</h4><ul>`;
    for (const f of findings) {
        html += `<li>${f}</li>`;
    }
    if (findings.length === 0) {
        html += `<li>æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆè‡ªåŠ¨åˆ†æã€‚è¯·ç­‰å¾…å›æµ‹å®Œæˆååˆ·æ–°é¡µé¢ã€‚</li>`;
    }
    html += `</ul></div>`;

    return html;
}

// â”€â”€ Helpers â”€â”€
function fv(v) {
    if (v === null || v === undefined) return '0.00';
    return (v >= 0 ? '+' : '') + Number(v).toFixed(2);
}

function switchTab(btn, id) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-body').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(id).classList.add('active');
}

function buildTbl(results) {
    if (!results || !results.length) return '<p style="color:var(--text-muted)">æš‚æ— æ•°æ®ã€‚</p>';
    let h = '<div style="overflow-x:auto"><table class="dt"><thead><tr>';
    h += '<th>#</th><th>æ–¹æ¡ˆ</th><th>ä¸»TF</th><th>å†³ç­–TFs</th><th class="center">Alpha</th>';
    h += '<th class="center">ç­–ç•¥æ”¶ç›Š</th><th class="center">BHæ”¶ç›Š</th><th class="center">å›æ’¤</th>';
    h += '<th class="center">äº¤æ˜“</th><th class="center">vså•TF</th>';
    h += '</tr></thead><tbody>';
    results.forEach((r, i) => {
        const rk = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i+1);
        const tfs = (r.decision_tfs || []).join(', ');
        h += `<tr class="${i===0?'gold':''}">
            <td>${rk}</td>
            <td><span class="tbadge combo">${r.combo_name}</span></td>
            <td><span class="tbadge ptf">${r.primary_tf}</span></td>
            <td style="font-size:0.75rem;color:var(--text-muted)">${tfs}</td>
            <td class="center ${r.alpha>=0?'pos':'neg'}">${fv(r.alpha)}%</td>
            <td class="center ${r.strategy_return>=0?'pos':'neg'}">${fv(r.strategy_return)}%</td>
            <td class="center ${r.buy_hold_return>=0?'pos':'neg'}">${fv(r.buy_hold_return)}%</td>
            <td class="center neg">${r.max_drawdown.toFixed(2)}%</td>
            <td class="center">${r.total_trades}</td>
            <td class="center ${(r.vs_single_tf||0)>=0?'pos':'neg'}">${fv(r.vs_single_tf)}%</td>
        </tr>`;
    });
    h += '</tbody></table></div>';
    return h;
}
</script>
{% endblock %}
