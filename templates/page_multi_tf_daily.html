{% extends "base.html" %}
{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­– Â· é€æ—¥ç›ˆäº{% endblock %}
{% block content %}
<style>
:root {
    --bg-page: #0f1117; --bg-card: #1a1d28; --bg-card2: #22263a;
    --border: #2a2e42; --text: #e8e8f0; --text-muted: #8b8fa8;
    --accent: #5b8af5; --green: #22c55e; --red: #ef4444;
    --orange: #f59e0b; --purple: #a78bfa; --cyan: #06b6d4;
}
.mtd { padding: 20px; max-width: 1500px; margin: 0 auto; color: var(--text); }
.mtd h1 { font-size: 1.8rem; font-weight: 700; text-align: center; margin-bottom: 4px; }
.mtd h1 span { color: var(--accent); }
.mtd .sub { text-align: center; color: var(--text-muted); font-size: 0.88rem; margin-bottom: 20px; }
.meta-bar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
.mbadge { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 5px 12px; font-size: 0.8rem; }
.mbadge b { color: var(--accent); margin-right: 4px; }

.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px 22px; margin-bottom: 18px; }
.card .title { font-size: 1.05rem; font-weight: 600; margin-bottom: 10px; }
.card .icon { margin-right: 5px; }

.mg { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin: 14px 0; }
.mi { background: var(--bg-card2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; }
.mi .lb { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 3px; }
.mi .vl { font-size: 1.2rem; font-weight: 700; }
.pos { color: var(--green); } .neg { color: var(--red); } .neu { color: var(--orange); }

.chart-box { width: 100%; height: 300px; position: relative; }

/* æŒä»“æ—¶é—´çº¿ */
.timeline { position: relative; }
.tl-row { display: flex; align-items: stretch; min-height: 40px; border-bottom: 1px solid var(--border); font-size: 0.78rem; transition: background 0.15s; }
.tl-row:hover { background: rgba(91,138,245,0.06); }
.tl-date { width: 90px; flex-shrink: 0; padding: 8px 6px; color: var(--text-muted); font-size: 0.75rem; display: flex; align-items: center; }
.tl-price { width: 80px; flex-shrink: 0; padding: 8px 4px; display: flex; align-items: center; justify-content: flex-end; }
.tl-bar { flex: 0 0 150px; display: flex; align-items: center; padding: 4px 8px; gap: 6px; }
.tl-pnl { width: 100px; flex-shrink: 0; padding: 8px 6px; text-align: right; font-weight: 600; display: flex; align-items: center; justify-content: flex-end; }
.tl-total { width: 110px; flex-shrink: 0; padding: 8px 6px; text-align: right; display: flex; align-items: center; justify-content: flex-end; font-size: 0.76rem; }
.tl-dd { width: 80px; flex-shrink: 0; padding: 8px 6px; text-align: right; display: flex; align-items: center; justify-content: flex-end; font-size: 0.72rem; }
.tl-trade { flex: 1; padding: 8px 6px; font-size: 0.72rem; display: flex; align-items: center; flex-wrap: wrap; gap: 3px; }

.pos-long { background: rgba(34,197,94,0.08); border-left: 3px solid var(--green); }
.pos-short { background: rgba(239,68,68,0.08); border-left: 3px solid var(--red); }
.pos-both { background: rgba(167,139,250,0.08); border-left: 3px solid var(--purple); }
.pos-none { border-left: 3px solid transparent; }
.pos-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
.pos-pill.long { background: rgba(34,197,94,0.2); color: var(--green); }
.pos-pill.short { background: rgba(239,68,68,0.2); color: var(--red); }

.trade-mark { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; margin-right: 3px; white-space: nowrap; }
.trade-mark.open { background: rgba(6,182,212,0.2); color: var(--cyan); }
.trade-mark.close { background: rgba(245,158,11,0.2); color: var(--orange); }
.trade-mark.liq { background: rgba(239,68,68,0.3); color: var(--red); }

.tl-header { display: flex; background: var(--bg-card2); border-bottom: 2px solid var(--border); font-weight: 600; font-size: 0.72rem; color: var(--text-muted); position: sticky; top: 0; z-index: 2; }
.tl-header > div { padding: 8px 6px; }

/* äº¤æ˜“è¡¨ */
.dt { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.dt th { background: var(--bg-card2); padding: 8px 6px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.72rem; position: sticky; top: 0; }
.dt td { padding: 6px; border-bottom: 1px solid var(--border); }
.dt .center { text-align: center; }
.dt tr:hover { background: rgba(91,138,245,0.06); }

.loading { text-align: center; padding: 60px; color: var(--text-muted); }
.spin { display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: sp 1s linear infinite; margin-bottom: 10px; }
@keyframes sp { to { transform: rotate(360deg); } }

.scroll-y { max-height: 700px; overflow-y: auto; }
details summary { cursor: pointer; }
details summary:hover { color: var(--accent); }

.dd-bar { height: 6px; background: var(--bg-card2); border-radius: 3px; overflow: hidden; margin-top: 2px; }
.dd-fill { height: 100%; background: var(--red); border-radius: 3px; }

/* ç­›é€‰æ§ä»¶ */
.filter-bar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
.filter-bar select, .filter-bar input { background: var(--bg-card2); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 0.78rem; }
.filter-bar label { font-size: 0.78rem; color: var(--text-muted); }
</style>

<div class="mtd" id="mtd-root">
    <div class="loading"><div class="spin"></div><div>åŠ è½½å¤šå‘¨æœŸé€æ—¥ç›ˆäºæ•°æ®...</div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const root = document.getElementById('mtd-root');
    let data;
    try {
        const resp = await fetch('/api/multi_tf_daily');
        if (!resp.ok) throw new Error('æœªæ‰¾åˆ°æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œ python backtest_multi_tf_daily.py');
        data = await resp.json();
    } catch (e) {
        root.innerHTML = `<div class="loading" style="color:var(--red)">âŒ ${e.message}</div>`;
        return;
    }
    if (data.error) { root.innerHTML = `<div class="loading" style="color:var(--red)">âŒ ${data.error}</div>`; return; }

    const m = data.run_meta || {};
    const s = data.summary || {};
    const daily = data.daily_records || [];
    const trades = data.trade_details || [];
    const equity = data.equity_curve || [];

    const fv = v => v != null ? (typeof v === 'number' ? v.toFixed(2) : v) : '-';
    const fc = v => v != null ? '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0}) : '-';
    const cls = v => v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu';

    // æ„å»ºäº¤æ˜“æ—¥æœŸç´¢å¼•: date -> [{trade}]
    const tradeByDate = {};
    trades.forEach(t => {
        const d = (t.time || '').slice(0, 10);
        if (!tradeByDate[d]) tradeByDate[d] = [];
        tradeByDate[d].push(t);
    });

    let html = `
    <h1>ğŸ“Š <span>å¤šå‘¨æœŸè”åˆå†³ç­–</span> Â· é€æ—¥æŒä»“ç›ˆäº</h1>
    <div class="sub">å…­ä¹¦è¯„åˆ† Ã— å¤šå‘¨æœŸèåˆ Â· ETH/USDT Â· æ¯æ—¥å®Œæ•´æŒä»“ä¸äº¤æ˜“è®°å½•</div>
    <div class="meta-bar">
        <span class="mbadge"><b>ğŸ“…</b>${m.start_date||''} ~ ${m.end_date||''}</span>
        <span class="mbadge"><b>ğŸ’°</b>$${(m.initial_capital||200000).toLocaleString()}</span>
        <span class="mbadge"><b>âš¡</b>${m.leverage||5}x</span>
        <span class="mbadge"><b>ğŸ¯</b>ç»„åˆ: ${m.combo_name||''}</span>
        <span class="mbadge"><b>ğŸ”„</b>ä¸»TF: ${m.primary_tf||'1h'} | å†³ç­–: ${(m.decision_tfs||[]).join('+')}</span>
        <span class="mbadge"><b>ğŸ–¥ï¸</b>${m.host||''}</span>
        <span class="mbadge"><b>ğŸ•</b>${m.run_time||''}</span>
    </div>`;

    // â•â•â•â•â•â• æ±‡æ€»å¡ç‰‡ â•â•â•â•â•â•
    html += `<div class="card"><div class="title"><span class="icon">ğŸ“Š</span>å›æµ‹æ±‡æ€»</div>
    <div class="mg">
        <div class="mi"><div class="lb">ç­–ç•¥æ”¶ç›Š</div><div class="vl ${cls(s.total_return_pct)}">${fv(s.total_return_pct)}%</div></div>
        <div class="mi"><div class="lb">ä¹°å…¥æŒæœ‰</div><div class="vl ${cls(s.buy_hold_return_pct)}">${fv(s.buy_hold_return_pct)}%</div></div>
        <div class="mi"><div class="lb">Alpha</div><div class="vl ${cls(s.alpha_pct)}">${fv(s.alpha_pct)}%</div></div>
        <div class="mi"><div class="lb">æœ€å¤§å›æ’¤</div><div class="vl neg">${fv(s.max_drawdown_pct)}%</div></div>
        <div class="mi"><div class="lb">èƒœç‡</div><div class="vl ${(s.win_rate_pct||0)>=50?'pos':'neg'}">${fv(s.win_rate_pct)}%</div></div>
        <div class="mi"><div class="lb">ç›ˆäºæ¯”</div><div class="vl ${(s.profit_factor||0)>=1.5?'pos':'neu'}">${fv(s.profit_factor)}</div></div>
        <div class="mi"><div class="lb">äº¤æ˜“æ¬¡æ•°</div><div class="vl neu">${s.total_trades||0} (å¹³ä»“${s.close_trades||0})</div></div>
        <div class="mi"><div class="lb">å¼ºå¹³æ¬¡æ•°</div><div class="vl ${(s.liquidations||0)>0?'neg':'pos'}">${s.liquidations||0}</div></div>
        <div class="mi"><div class="lb">æœŸæœ«èµ„é‡‘</div><div class="vl">${fc(s.final_capital)}</div></div>
        <div class="mi"><div class="lb">æ€»è´¹ç”¨</div><div class="vl">${fc(s.total_costs)}</div></div>
        <div class="mi"><div class="lb">è´¹ç”¨æ‹–ç´¯</div><div class="vl neg">${fv(s.fee_drag_pct)}%</div></div>
        <div class="mi"><div class="lb">å‡€Funding</div><div class="vl ${cls(s.net_funding)}">${fc(s.net_funding)}</div></div>
    </div></div>`;

    // â•â•â•â•â•â• èµ„é‡‘æ›²çº¿ + å›æ’¤ â•â•â•â•â•â•
    html += `<div class="card">
        <div class="title"><span class="icon">ğŸ“ˆ</span>èµ„é‡‘æ›²çº¿ & å›æ’¤ & ETHä»·æ ¼</div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
    </div>`;

    // â•â•â•â•â•â• é€æ—¥ç›ˆäº+æŒä»“æ—¶é—´çº¿ â•â•â•â•â•â•
    html += `<div class="card">
        <div class="title"><span class="icon">ğŸ“‹</span>é€æ—¥æŒä»“ç›ˆäº (${daily.length} å¤©)</div>
        <div class="filter-bar">
            <label>ç­›é€‰:</label>
            <select id="posFilter">
                <option value="all">å…¨éƒ¨</option>
                <option value="long">ä»…å¤šå¤´æ—¥</option>
                <option value="short">ä»…ç©ºå¤´æ—¥</option>
                <option value="trade">æœ‰äº¤æ˜“æ—¥</option>
                <option value="empty">æ— æŒä»“æ—¥</option>
            </select>
            <label>æœç´¢:</label>
            <input id="dateSearch" placeholder="æ—¥æœŸå¦‚ 2025-03" style="width:120px;">
        </div>
        <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:8px;">
            æ—¥æœŸ | ETHä»·æ ¼ | æŒä»“ | æœªå®ç°PnL | è´¦æˆ·æ€»å€¼ | å›æ’¤ | å½“æ—¥äº¤æ˜“
        </div>
        <div class="timeline scroll-y" id="timeline">
            <div class="tl-header">
                <div class="tl-date">æ—¥æœŸ</div>
                <div class="tl-price">ETHä»·æ ¼</div>
                <div class="tl-bar">æŒä»“çŠ¶æ€</div>
                <div class="tl-pnl">æœªå®ç°PnL</div>
                <div class="tl-total">è´¦æˆ·æ€»å€¼</div>
                <div class="tl-dd">å›æ’¤</div>
                <div class="tl-trade">å½“æ—¥äº¤æ˜“</div>
            </div>
            <div id="tl-body"></div>
        </div>
    </div>`;

    // â•â•â•â•â•â• å®Œæ•´äº¤æ˜“è®°å½• â•â•â•â•â•â•
    html += `<div class="card"><details open>
        <summary class="title" style="cursor:pointer"><span class="icon">ğŸ’¹</span>å®Œæ•´äº¤æ˜“è®°å½• (${trades.length} ç¬”)</summary>
        <div style="overflow-x:auto;margin-top:10px;">
        <table class="dt" style="font-size:0.72rem;white-space:nowrap;"><thead><tr>
            <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>æ–¹å‘</th>
            <th class="center">å¸‚åœºä»·</th><th class="center">æˆäº¤ä»·</th>
            <th class="center">æ•°é‡</th><th class="center">åä¹‰ä»·å€¼</th>
            <th class="center">ä¿è¯é‡‘</th><th class="center">æ æ†</th>
            <th class="center">æ‰‹ç»­è´¹</th><th class="center">æ»‘ç‚¹</th>
            <th class="center">PnL</th>
            <th class="center">è´¦æˆ·æ€»å€¼</th><th>åŸå› </th>
        </tr></thead><tbody>`;
    trades.forEach((t, i) => {
        const pCls = (t.pnl||0) > 0 ? 'color:var(--green)' : (t.pnl||0) < 0 ? 'color:var(--red)' : '';
        const actionMap = {
            'OPEN_LONG':'å¼€å¤š', 'CLOSE_LONG':'å¹³å¤š', 'OPEN_SHORT':'å¼€ç©º',
            'CLOSE_SHORT':'å¹³ç©º', 'LIQUIDATED':'å¼ºå¹³', 'SPOT_BUY':'ç°ä¹°',
            'SPOT_SELL':'ç°å–', 'PARTIAL_TP':'éƒ¨åˆ†æ­¢ç›ˆ',
        };
        const isOpen = t.action && t.action.startsWith('OPEN');
        const isLiq = t.action === 'LIQUIDATED';
        html += `<tr>
            <td>${i+1}</td><td>${(t.time||'').replace('T',' ').slice(0,16)}</td>
            <td style="font-weight:600;${isLiq?'color:var(--red)':isOpen?'color:var(--cyan)':'color:var(--orange)'}">${actionMap[t.action]||t.action}</td>
            <td>${t.direction==='long'?'ğŸŸ¢å¤š':t.direction==='short'?'ğŸ”´ç©º':'-'}</td>
            <td class="center">$${fv(t.market_price)}</td>
            <td class="center">$${fv(t.exec_price)}</td>
            <td class="center">${fv(t.quantity)}</td>
            <td class="center">${fc(t.notional_value)}</td>
            <td class="center">${fc(t.margin)}</td>
            <td class="center">${t.leverage||'-'}x</td>
            <td class="center">$${fv(t.fee)}</td>
            <td class="center">$${fv(t.slippage_cost)}</td>
            <td class="center" style="${pCls};font-weight:700">${t.pnl!=null?'$'+fv(t.pnl):'-'}</td>
            <td class="center">${fc(t.after_total)}</td>
            <td style="font-size:0.68rem;max-width:250px;overflow:hidden;text-overflow:ellipsis">${t.reason||''}</td>
        </tr>`;
    });
    html += '</tbody></table></div></details></div>';

    // â•â•â•â•â•â• äº¤æ˜“ç»Ÿè®¡ â•â•â•â•â•â•
    const closeTrades = trades.filter(t => ['CLOSE_LONG','CLOSE_SHORT','LIQUIDATED'].includes(t.action));
    const wins = closeTrades.filter(t => (t.pnl||0) > 0);
    const losses = closeTrades.filter(t => (t.pnl||0) <= 0);

    html += `<div class="card"><div class="title"><span class="icon">ğŸ“Š</span>äº¤æ˜“ç»Ÿè®¡åˆ†æ</div>
    <div class="mg">
        <div class="mi"><div class="lb">ç›ˆåˆ©ç¬”æ•°</div><div class="vl pos">${wins.length}</div></div>
        <div class="mi"><div class="lb">äºæŸç¬”æ•°</div><div class="vl neg">${losses.length}</div></div>
        <div class="mi"><div class="lb">å¹³å‡ç›ˆåˆ©</div><div class="vl pos">$${fv(wins.reduce((s,t)=>s+(t.pnl||0),0)/(wins.length||1))}</div></div>
        <div class="mi"><div class="lb">å¹³å‡äºæŸ</div><div class="vl neg">$${fv(losses.reduce((s,t)=>s+(t.pnl||0),0)/(losses.length||1))}</div></div>
        <div class="mi"><div class="lb">æœ€å¤§å•ç¬”ç›ˆåˆ©</div><div class="vl pos">$${fv(Math.max(0,...closeTrades.map(t=>t.pnl||0)))}</div></div>
        <div class="mi"><div class="lb">æœ€å¤§å•ç¬”äºæŸ</div><div class="vl neg">$${fv(Math.min(0,...closeTrades.map(t=>t.pnl||0)))}</div></div>
        <div class="mi"><div class="lb">æ€»æ‰‹ç»­è´¹</div><div class="vl">${fc(s.total_fees)}</div></div>
        <div class="mi"><div class="lb">æ€»æ»‘ç‚¹</div><div class="vl">${fc(s.total_slippage)}</div></div>
    </div>
    <div style="margin-top:14px;"><div class="chart-box" style="height:220px"><canvas id="pnlChart"></canvas></div></div>
    </div>`;

    // â•â•â•â•â•â• æœˆåº¦æ±‡æ€» â•â•â•â•â•â•
    const monthMap = {};
    daily.forEach(d => {
        const mon = d.date.slice(0,7);
        if (!monthMap[mon]) monthMap[mon] = { start: null, end: null, trades: 0, pnl: 0 };
        if (!monthMap[mon].start) monthMap[mon].start = d.total_value;
        monthMap[mon].end = d.total_value;
        monthMap[mon].trades += d.day_trades || 0;
        monthMap[mon].pnl += d.day_pnl || 0;
    });
    const months = Object.keys(monthMap).sort();
    html += `<div class="card"><div class="title"><span class="icon">ğŸ“†</span>æœˆåº¦æ±‡æ€»</div>
    <div style="overflow-x:auto;"><table class="dt"><thead><tr>
        <th>æœˆä»½</th><th class="center">æœŸåˆ</th><th class="center">æœŸæœ«</th>
        <th class="center">æœˆæ”¶ç›Š</th><th class="center">äº¤æ˜“æ¬¡æ•°</th><th class="center">å·²å®ç°PnL</th>
    </tr></thead><tbody>`;
    months.forEach(mon => {
        const m2 = monthMap[mon];
        const ret = m2.start ? ((m2.end - m2.start) / m2.start * 100) : 0;
        html += `<tr>
            <td style="font-weight:600">${mon}</td>
            <td class="center">${fc(m2.start)}</td>
            <td class="center">${fc(m2.end)}</td>
            <td class="center"><span class="${cls(ret)}" style="font-weight:700">${ret.toFixed(2)}%</span></td>
            <td class="center">${m2.trades}</td>
            <td class="center"><span class="${cls(m2.pnl)}">${fc(m2.pnl)}</span></td>
        </tr>`;
    });
    html += '</tbody></table></div></div>';

    root.innerHTML = html;

    // â•â•â• æ—¶é—´çº¿æ¸²æŸ“ â•â•â•
    function renderTimeline(filter, search) {
        const body = document.getElementById('tl-body');
        let rows = '';
        daily.forEach(d => {
            const dayTr = tradeByDate[d.date] || [];
            const hasL = d.has_long;
            const hasS = d.has_short;

            // ç­›é€‰
            if (filter === 'long' && !hasL) return;
            if (filter === 'short' && !hasS) return;
            if (filter === 'trade' && dayTr.length === 0) return;
            if (filter === 'empty' && (hasL || hasS)) return;
            if (search && !d.date.includes(search)) return;

            const posClass = hasL && hasS ? 'pos-both' : hasL ? 'pos-long' : hasS ? 'pos-short' : 'pos-none';

            let posHtml = '<span style="color:var(--text-muted)">-</span>';
            if (hasL || hasS) {
                posHtml = '';
                if (hasL) posHtml += `<span class="pos-pill long">å¤š</span>`;
                if (hasS) posHtml += `<span class="pos-pill short">ç©º</span>`;
                if (d.long_entry) posHtml += `<span style="font-size:0.68rem;color:var(--text-muted)"> L@${fv(d.long_entry)}</span>`;
                if (d.short_entry) posHtml += `<span style="font-size:0.68rem;color:var(--text-muted)"> S@${fv(d.short_entry)}</span>`;
            }

            const unrealPnl = (d.long_pnl||0) + (d.short_pnl||0);
            let pnlHtml = '<span style="color:var(--text-muted)">-</span>';
            if (hasL || hasS) {
                pnlHtml = `<span class="${cls(unrealPnl)}" style="font-weight:600">$${fv(unrealPnl)}</span>`;
            }

            let tradeHtml = '';
            dayTr.forEach(t => {
                const actionMap = {'OPEN_LONG':'å¼€å¤š','CLOSE_LONG':'å¹³å¤š','OPEN_SHORT':'å¼€ç©º','CLOSE_SHORT':'å¹³ç©º','LIQUIDATED':'å¼ºå¹³','PARTIAL_TP':'æ­¢ç›ˆ'};
                const isOpen = t.action && t.action.startsWith('OPEN');
                const isLiq = t.action === 'LIQUIDATED';
                const markCls = isLiq ? 'liq' : isOpen ? 'open' : 'close';
                tradeHtml += `<span class="trade-mark ${markCls}">${actionMap[t.action]||t.action}</span>`;
                if (!isOpen && t.pnl != null) {
                    tradeHtml += `<span class="${cls(t.pnl)}" style="font-size:0.68rem;font-weight:600">$${fv(t.pnl)}</span> `;
                }
            });

            const ddPct = Math.abs(d.drawdown_pct || 0);
            const ddWidth = Math.min(100, ddPct * 3);
            const retCls = cls(d.return_pct);

            rows += `<div class="tl-row ${posClass}">
                <div class="tl-date">${d.date}</div>
                <div class="tl-price">$${fv(d.eth_price)}</div>
                <div class="tl-bar">${posHtml}</div>
                <div class="tl-pnl">${pnlHtml}</div>
                <div class="tl-total"><span class="${retCls}">${fc(d.total_value)}</span></div>
                <div class="tl-dd"><span class="neg">${ddPct > 0 ? '-'+ddPct.toFixed(1)+'%' : '-'}</span>
                    <div class="dd-bar" style="width:50px"><div class="dd-fill" style="width:${ddWidth}%"></div></div>
                </div>
                <div class="tl-trade">${tradeHtml || '<span style="color:var(--text-muted)">-</span>'}</div>
            </div>`;
        });
        body.innerHTML = rows;
    }

    renderTimeline('all', '');
    document.getElementById('posFilter').addEventListener('change', e => {
        renderTimeline(e.target.value, document.getElementById('dateSearch').value);
    });
    document.getElementById('dateSearch').addEventListener('input', e => {
        renderTimeline(document.getElementById('posFilter').value, e.target.value);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Chart 1: èµ„é‡‘æ›²çº¿ + å›æ’¤ + ä»·æ ¼
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (equity.length > 0) {
        const labels = equity.map(e => e.date);
        new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'è´¦æˆ·æ€»å€¼', data: equity.map(e=>e.total), borderColor: '#5b8af5', backgroundColor: 'rgba(91,138,245,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y' },
                    { label: 'ETHä»·æ ¼', data: equity.map(e=>e.price), borderColor: '#f59e0b', borderWidth: 1.5, tension: 0.3, pointRadius: 0, borderDash: [4,2], yAxisID: 'y1' },
                    { label: 'å›æ’¤%', data: equity.map(e=> -(e.drawdown||0)), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1, yAxisID: 'y2' },
                ],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { labels: { color: '#8b8fa8', font: { size: 10 } } } },
                scales: {
                    x: { ticks: { color: '#8b8fa8', maxTicksLimit: 15, font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.5)' } },
                    y: { position: 'left', ticks: { color: '#5b8af5', font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.3)' } },
                    y1: { position: 'right', ticks: { color: '#f59e0b', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                    y2: { position: 'right', ticks: { color: '#ef4444', font: { size: 9 }, callback: v=>v+'%' }, grid: { drawOnChartArea: false }, max: 0, min: Math.min(-5, (s.max_drawdown_pct||15)*1.2) },
                },
            },
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Chart 2: æ¯ç¬”äº¤æ˜“PnLç€‘å¸ƒå›¾
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (closeTrades.length > 0) {
        new Chart(document.getElementById('pnlChart'), {
            type: 'bar',
            data: {
                labels: closeTrades.map((t,i) => `#${i+1}`),
                datasets: [{
                    label: 'å•ç¬”PnL',
                    data: closeTrades.map(t => t.pnl||0),
                    backgroundColor: closeTrades.map(t => (t.pnl||0) >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)'),
                    borderColor: closeTrades.map(t => (t.pnl||0) >= 0 ? '#22c55e' : '#ef4444'),
                    borderWidth: 1,
                }],
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8b8fa8', font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.3)' } },
                    y: { ticks: { color: '#8b8fa8', font: { size: 9 }, callback: v=>'$'+v }, grid: { color: 'rgba(42,46,66,0.3)' } },
                },
            },
        });
    }
});
</script>
{% endblock %}
