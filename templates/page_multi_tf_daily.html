{% extends "base.html" %}
{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­– Â· é€æ—¥ç›ˆäº{% endblock %}
{% block content %}
<style>
:root {
    --bg-page: #0f1117; --bg-card: #1a1d28; --bg-card2: #22263a;
    --border: #2a2e42; --text: #e8e8f0; --text-muted: #8b8fa8;
    --accent: #5b8af5; --green: #22c55e; --red: #ef4444;
    --orange: #f59e0b; --purple: #a78bfa; --cyan: #06b6d4;
}
.mtd { padding: 20px; max-width: 1500px; margin: 0 auto; color: var(--text); }
.mtd h1 { font-size: 1.8rem; font-weight: 700; text-align: center; margin-bottom: 4px; }
.mtd h1 span { color: var(--accent); }
.mtd .sub { text-align: center; color: var(--text-muted); font-size: 0.88rem; margin-bottom: 20px; }
.meta-bar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
.mbadge { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 5px 12px; font-size: 0.8rem; }
.mbadge b { color: var(--accent); margin-right: 4px; }

.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px 22px; margin-bottom: 18px; }
.card .title { font-size: 1.05rem; font-weight: 600; margin-bottom: 10px; }
.card .icon { margin-right: 5px; }

.mg { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin: 14px 0; }
.mi { background: var(--bg-card2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; }
.mi .lb { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 3px; }
.mi .vl { font-size: 1.2rem; font-weight: 700; }
.pos { color: var(--green); } .neg { color: var(--red); } .neu { color: var(--orange); }

.chart-box { width: 100%; height: 300px; position: relative; }

/* ç‰ˆæœ¬é€‰æ‹©å™¨ */
.version-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; margin-bottom: 18px; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; }
.version-bar label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
.version-bar select { background: var(--bg-card2); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 0.82rem; min-width: 300px; }
.version-bar button { background: var(--accent); color: #fff; border: none; border-radius: 6px; padding: 6px 16px; font-size: 0.82rem; cursor: pointer; font-weight: 600; }
.version-bar button:hover { opacity: 0.85; }
.version-bar button.active { background: var(--green); }

/* å¯¹æ¯”è¡¨ */
.cmp-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.cmp-table th { background: var(--bg-card2); padding: 10px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.78rem; }
.cmp-table td { padding: 8px; border-bottom: 1px solid var(--border); }
.cmp-table tr:hover { background: rgba(91,138,245,0.06); }
.cmp-table .better { color: var(--green); font-weight: 700; }
.cmp-table .worse { color: var(--red); font-weight: 700; }

/* æŒä»“æ—¶é—´çº¿ */
.timeline { position: relative; }
.tl-row { display: flex; align-items: stretch; min-height: 40px; border-bottom: 1px solid var(--border); font-size: 0.78rem; transition: background 0.15s; }
.tl-row:hover { background: rgba(91,138,245,0.06); }
.tl-date { width: 82px; flex-shrink: 0; padding: 8px 4px; color: var(--text-muted); font-size: 0.73rem; display: flex; align-items: center; }
.tl-price { width: 72px; flex-shrink: 0; padding: 8px 3px; display: flex; align-items: center; justify-content: flex-end; font-size: 0.75rem; }
.tl-assets { width: 160px; flex-shrink: 0; padding: 6px 6px; display: flex; flex-direction: column; justify-content: center; gap: 1px; font-size: 0.68rem; }
.tl-assets .a-row { display: flex; justify-content: space-between; }
.tl-assets .a-label { color: var(--text-muted); }
.tl-assets .a-val { font-weight: 600; text-align: right; }
.tl-bar { flex: 0 0 140px; display: flex; align-items: center; padding: 4px 6px; gap: 4px; }
.tl-pnl { width: 90px; flex-shrink: 0; padding: 8px 4px; text-align: right; font-weight: 600; display: flex; align-items: center; justify-content: flex-end; }
.tl-total { width: 100px; flex-shrink: 0; padding: 8px 4px; text-align: right; display: flex; align-items: center; justify-content: flex-end; font-size: 0.76rem; }
.tl-dd { width: 70px; flex-shrink: 0; padding: 8px 4px; text-align: right; display: flex; align-items: center; justify-content: flex-end; font-size: 0.72rem; }
.tl-trade { flex: 1; padding: 8px 4px; font-size: 0.72rem; display: flex; align-items: center; flex-wrap: wrap; gap: 3px; }

.pos-long { background: rgba(34,197,94,0.08); border-left: 3px solid var(--green); }
.pos-short { background: rgba(239,68,68,0.08); border-left: 3px solid var(--red); }
.pos-both { background: rgba(167,139,250,0.08); border-left: 3px solid var(--purple); }
.pos-none { border-left: 3px solid transparent; }
.pos-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
.pos-pill.long { background: rgba(34,197,94,0.2); color: var(--green); }
.pos-pill.short { background: rgba(239,68,68,0.2); color: var(--red); }

.trade-mark { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; margin-right: 3px; white-space: nowrap; }
.trade-mark.open { background: rgba(6,182,212,0.2); color: var(--cyan); }
.trade-mark.close { background: rgba(245,158,11,0.2); color: var(--orange); }
.trade-mark.liq { background: rgba(239,68,68,0.3); color: var(--red); }

.tl-header { display: flex; background: var(--bg-card2); border-bottom: 2px solid var(--border); font-weight: 600; font-size: 0.72rem; color: var(--text-muted); position: sticky; top: 0; z-index: 2; }
.tl-header > div { padding: 8px 6px; }

/* äº¤æ˜“è¡¨ */
.dt { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.dt th { background: var(--bg-card2); padding: 8px 6px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.72rem; position: sticky; top: 0; }
.dt td { padding: 6px; border-bottom: 1px solid var(--border); }
.dt .center { text-align: center; }
.dt tr:hover { background: rgba(91,138,245,0.06); }

.loading { text-align: center; padding: 60px; color: var(--text-muted); }
.spin { display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: sp 1s linear infinite; margin-bottom: 10px; }
@keyframes sp { to { transform: rotate(360deg); } }

.scroll-y { max-height: 700px; overflow-y: auto; }
details summary { cursor: pointer; }
details summary:hover { color: var(--accent); }

.dd-bar { height: 6px; background: var(--bg-card2); border-radius: 3px; overflow: hidden; margin-top: 2px; }
.dd-fill { height: 100%; background: var(--red); border-radius: 3px; }

/* ç­›é€‰æ§ä»¶ */
.filter-bar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
.filter-bar select, .filter-bar input { background: var(--bg-card2); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 0.78rem; }
.filter-bar label { font-size: 0.78rem; color: var(--text-muted); }

/* ç­–ç•¥å¼€å…³æ ‡ç­¾ */
.switch-tag { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; margin: 1px 2px; }
.switch-tag.on { background: rgba(34,197,94,0.2); color: var(--green); }
.switch-tag.off { background: rgba(239,68,68,0.1); color: var(--text-muted); }
</style>

<div class="mtd" id="mtd-root">
    <div class="loading"><div class="spin"></div><div>åŠ è½½æ•°æ®...</div></div>
</div>

<link rel="preload" href="/static/js/chart.umd.min.js" as="script">
<script src="/static/js/chart.umd.min.js" defer></script>
<script>
// â•â•â• ç«‹å³å‘èµ· API è¯·æ±‚ï¼ˆä¸ç­‰ DOMContentLoaded / Chart.jsï¼‰â•â•â•
const RUNS_PAGE_SIZE = 20;
const _urlParams = new URLSearchParams(window.location.search);
const _initialRunId = _urlParams.get('run_id');

function _loadRunUrl(runId) {
    return runId ? `/api/multi_tf_daily?run_id=${runId}` : '/api/multi_tf_daily';
}
// è¿™ä¸¤ä¸ª fetch åœ¨ HTML è§£æé˜¶æ®µå°±å¼€å§‹äº†ï¼Œä¸ Chart.js ä¸‹è½½å¹¶è¡Œ
const _earlyFetch = Promise.allSettled([
    fetch(`/api/multi_tf_daily/runs?limit=${RUNS_PAGE_SIZE}&offset=0`).then(r => r.ok ? r.json() : []),
    fetch(_loadRunUrl(_initialRunId)).then(r => { if (!r.ok) throw new Error('æ•°æ®åŠ è½½å¤±è´¥'); return r.json(); }),
]);
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const root = document.getElementById('mtd-root');

    // â•â•â• 1. ç­‰å¾…å·²æå‰å‘å‡ºçš„è¯·æ±‚ â•â•â•
    let _runsOffset = 0;
    let _runsHasMore = true;

    async function loadRun(runId) {
        const url = _loadRunUrl(runId);
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
        return await resp.json();
    }

    async function fetchRunsPage(offset, limit) {
        const resp = await fetch(`/api/multi_tf_daily/runs?limit=${limit}&offset=${offset}`);
        return resp.ok ? resp.json() : [];
    }

    // å¤ç”¨æå‰å‘èµ·çš„è¯·æ±‚ç»“æœï¼Œä¸å†é‡æ–°å‘è¯·æ±‚
    const [runsResult, dataResult] = await _earlyFetch;

    let allRuns = runsResult.status === 'fulfilled' ? runsResult.value : [];
    _runsOffset = allRuns.length;
    _runsHasMore = allRuns.length >= RUNS_PAGE_SIZE;

    let data;
    if (dataResult.status === 'fulfilled') {
        data = dataResult.value;
    } else {
        root.innerHTML = `<div class="loading" style="color:var(--red)">åŠ è½½å¤±è´¥: ${dataResult.reason}</div>`;
        return;
    }
    if (data.error) { root.innerHTML = `<div class="loading" style="color:var(--red)">${data.error}</div>`; return; }

    // å¦‚æœå½“å‰ run ä¸åœ¨å·²åŠ è½½çš„åˆ—è¡¨ä¸­ï¼ˆæ¯”å¦‚è€ç‰ˆæœ¬é€šè¿‡ URL ç›´æ¥è®¿é—®ï¼‰ï¼Œè¡¥å…¥åˆ—è¡¨å¤´éƒ¨
    if (data.run_id && !allRuns.some(r => r.run_id === data.run_id)) {
        allRuns.unshift({
            run_id: data.run_id,
            version_tag: data.version_tag || `Run #${data.run_id}`,
            created_at: (data.run_meta || {}).created_at || '',
            start_date: (data.run_meta || {}).start_date || '',
            end_date: (data.run_meta || {}).end_date || '',
            total_return_pct: (data.summary || {}).total_return_pct,
            max_drawdown_pct: (data.summary || {}).max_drawdown_pct,
        });
    }

    // å¯¹æ¯”çŠ¶æ€
    let compareRunId = null;
    let compareData = null;

    function switchTag(on, label) {
        return `<span class="switch-tag ${on?'on':'off'}">${on?'ON':'OFF'} ${label}</span>`;
    }

    function renderPage(data, cmpData) {
        const m = data.run_meta || {};
        const s = data.summary || {};
        const daily = data.daily_records || [];
        const trades = data.trade_details || [];
        const equity = data.equity_curve || [];
        const snap = data.strategy_snapshot || {};
        const vTag = data.version_tag || `Run #${data.run_id}`;

        const fv = v => v != null ? (typeof v === 'number' ? v.toFixed(2) : v) : '-';
        const fc = v => v != null ? '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0}) : '-';
        const cls = v => v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu';

        // äº¤æ˜“æ—¥æœŸç´¢å¼•
        const tradeByDate = {};
        trades.forEach(t => {
            const d = (t.time || '').slice(0, 10);
            if (!tradeByDate[d]) tradeByDate[d] = [];
            tradeByDate[d].push(t);
        });

        const exportAllUrl = '/api/multi_tf_daily/export_all' + (data.run_id ? '?run_id=' + data.run_id : '');
        let html = `
        <h1><span>å¤šå‘¨æœŸè”åˆå†³ç­–</span> Â· é€æ—¥æŒä»“ç›ˆäº</h1>
        <div class="sub">å…­ä¹¦è¯„åˆ† x å¤šå‘¨æœŸèåˆ Â· ETH/USDT Â· ç‰ˆæœ¬å¯¹æ¯”åˆ†æ
            <a href="${exportAllUrl}" class="btn-export-all" title="å¯¼å‡ºæ•´ä¸ªé¡µé¢æ‰€æœ‰æ•°æ®åˆ°Excel"
               style="margin-left:16px;display:inline-block;padding:4px 14px;font-size:0.78rem;background:linear-gradient(135deg,#5b8af5,#a78bfa);color:#fff;border-radius:6px;text-decoration:none;font-weight:600;vertical-align:middle;letter-spacing:0.5px">ğŸ“¥ å¯¼å‡ºå…¨éƒ¨Excel</a>
        </div>`;

        // â•â•â• ç‰ˆæœ¬é€‰æ‹©å™¨ï¼ˆåˆ†é¡µï¼‰ â•â•â•
        function _runOptText(r) {
            const ret = r.total_return_pct != null ? `${r.total_return_pct > 0 ? '+' : ''}${r.total_return_pct.toFixed(1)}%` : '';
            const dd = r.max_drawdown_pct != null ? `DD:${r.max_drawdown_pct.toFixed(1)}%` : '';
            return `#${r.run_id} ${r.version_tag} | ${ret} ${dd} | ${r.start_date}~${r.end_date} | ${(r.created_at||'').slice(0,16)}`;
        }
        html += `<div class="version-bar">
            <label>å½“å‰ç‰ˆæœ¬:</label>
            <select id="runSelector">`;
        allRuns.forEach(r => {
            const sel = r.run_id == data.run_id ? 'selected' : '';
            html += `<option value="${r.run_id}" ${sel}>${_runOptText(r)}</option>`;
        });
        if (_runsHasMore) html += `<option value="__load_more__">â”€â”€ åŠ è½½æ›´å¤šå†å²è®°å½• â”€â”€</option>`;
        html += `</select>
            <label>å¯¹æ¯”:</label>
            <select id="cmpSelector"><option value="">ä¸å¯¹æ¯”</option>`;
        allRuns.forEach(r => {
            if (r.run_id == data.run_id) return;
            const sel = (cmpData && r.run_id == cmpData.run_id) ? 'selected' : '';
            const ret = r.total_return_pct != null ? `${r.total_return_pct > 0 ? '+' : ''}${r.total_return_pct.toFixed(1)}%` : '';
            html += `<option value="${r.run_id}" ${sel}>#${r.run_id} ${r.version_tag} | ${ret}</option>`;
        });
        if (_runsHasMore) html += `<option value="__load_more__">â”€â”€ åŠ è½½æ›´å¤šå†å²è®°å½• â”€â”€</option>`;
        html += `</select></div>`;

        // â•â•â• ç­–ç•¥å¿«ç…§ â•â•â•
        html += `<div class="meta-bar">
            <span class="mbadge"><b>Run#${data.run_id}</b>${vTag}</span>
            <span class="mbadge"><b>åŒºé—´</b>${m.start_date||''} ~ ${m.end_date||''}</span>
            <span class="mbadge"><b>æ æ†</b>${m.leverage||5}x</span>
            <span class="mbadge"><b>ç»„åˆ</b>${m.combo_name||''}</span>
            <span class="mbadge"><b>ä¸»TF</b>${m.primary_tf||'1h'}</span>
            <span class="mbadge"><b>æœºå™¨</b>${m.host||''}</span>
        </div>
        <div style="text-align:center;margin-bottom:10px;">
            ${switchTag(snap.use_trend_enhance, 'è¶‹åŠ¿ä¿æŠ¤v3')}
            ${switchTag(snap.use_microstructure, 'å¾®ç»“æ„')}
            ${switchTag(snap.use_dual_engine, 'åŒå¼•æ“')}
            ${switchTag(snap.use_vol_target, 'æ³¢åŠ¨ç›®æ ‡')}
            ${switchTag(snap.use_live_gate, 'LiveGate')}
            ${switchTag(snap.use_regime_aware, 'Regime')}
            ${switchTag(snap.use_protections, 'é£æ§ä¿æŠ¤')}
            ${switchTag(snap.use_spot_sell_confirm, 'SSç¡®è®¤')}
            ${switchTag(snap.use_regime_short_gate, 'åšç©ºé—¨æ§')}
            ${switchTag(snap.use_dual_macd, 'åŒMACD')}
            ${snap.no_tp_exit_bars > 0 ? switchTag(true, 'NoTPé€€å‡º') : ''}
        </div>
        <div style="text-align:center;margin-bottom:16px;font-size:0.75rem;color:var(--text-muted);">
            ${snap.short_sl != null ? `<span class="mbadge" style="font-size:0.7rem">çŸ­æ­¢æŸ ${snap.short_sl}</span>` : ''}
            ${snap.regime_short_gate_add != null ? `<span class="mbadge" style="font-size:0.7rem">Gate +${snap.regime_short_gate_add}</span>` : ''}
            ${snap.spot_sell_confirm_ss != null && snap.use_spot_sell_confirm ? `<span class="mbadge" style="font-size:0.7rem">ç¡®è®¤SSâ‰¥${snap.spot_sell_confirm_ss} min${snap.spot_sell_confirm_min||2}</span>` : ''}
            ${snap.spot_sell_regime_block ? `<span class="mbadge" style="font-size:0.7rem">Block ${snap.spot_sell_regime_block}</span>` : ''}
            ${snap.hard_stop_loss != null ? `<span class="mbadge" style="font-size:0.7rem">ç¡¬æ–­è·¯ ${snap.hard_stop_loss}</span>` : ''}
            ${snap.no_tp_exit_bars > 0 ? `<span class="mbadge" style="font-size:0.7rem">NoTP ${snap.no_tp_exit_bars}bar â‰¥${((snap.no_tp_exit_min_pnl||0)*100).toFixed(0)}%</span>` : ''}
            ${snap.neutral_mid_ss_sell_ratio != null && snap.neutral_mid_ss_sell_ratio < 1 ? `<span class="mbadge" style="font-size:0.7rem">neutralé™å– ${(snap.neutral_mid_ss_sell_ratio*100).toFixed(0)}%</span>` : ''}
            ${snap.regime_short_threshold ? `<span class="mbadge" style="font-size:0.7rem">åˆ†regimeé—¨æ§› ${JSON.stringify(snap.regime_short_threshold)}</span>` : ''}
        </div>`;

        // â•â•â• å®éªŒè¯´æ˜ â•â•â•
        const notes = data.experiment_notes || '';
        if (notes) {
            html += `<div class="card" style="border-left:3px solid var(--accent);margin-bottom:18px;">
                <div class="title">ğŸ“‹ å®éªŒè¯´æ˜</div>
                <div style="font-size:0.85rem;line-height:1.6;white-space:pre-wrap;color:var(--text-muted);">${notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
            </div>`;
        }

        // â•â•â• å¯¹æ¯”è¡¨ (å¦‚æœæœ‰å¯¹æ¯”æ•°æ®) â•â•â•
        if (cmpData) {
            const cs = cmpData.summary || {};
            const cSnap = cmpData.strategy_snapshot || {};
            const cTag = cmpData.version_tag || `Run #${cmpData.run_id}`;

            function cmpCell(a, b, higherBetter) {
                if (a == null || b == null) return `<td>${fv(a)}</td><td>${fv(b)}</td><td>-</td>`;
                const diff = a - b;
                const better = higherBetter ? diff > 0 : diff < 0;
                const diffStr = diff > 0 ? `+${diff.toFixed(2)}` : diff.toFixed(2);
                return `<td>${fv(a)}</td><td>${fv(b)}</td><td class="${better?'better':'worse'}">${diffStr}</td>`;
            }

            html += `<div class="card"><div class="title">å¯¹æ¯”: #${data.run_id} ${vTag} vs #${cmpData.run_id} ${cTag}</div>
            <div style="margin-bottom:10px;">
                <b>å½“å‰:</b> ${switchTag(snap.use_trend_enhance,'è¶‹åŠ¿v3')} ${switchTag(snap.use_microstructure,'å¾®ç»“æ„')} ${switchTag(snap.use_dual_engine,'åŒå¼•æ“')} ${switchTag(snap.use_vol_target,'æ³¢åŠ¨ç›®æ ‡')}<br>
                <b>å¯¹æ¯”:</b> ${switchTag(cSnap.use_trend_enhance,'è¶‹åŠ¿v3')} ${switchTag(cSnap.use_microstructure,'å¾®ç»“æ„')} ${switchTag(cSnap.use_dual_engine,'åŒå¼•æ“')} ${switchTag(cSnap.use_vol_target,'æ³¢åŠ¨ç›®æ ‡')}
            </div>
            <table class="cmp-table"><thead><tr>
                <th>æŒ‡æ ‡</th><th>#${data.run_id} (å½“å‰)</th><th>#${cmpData.run_id} (å¯¹æ¯”)</th><th>å·®å¼‚</th>
            </tr></thead><tbody>
                <tr><td>ç­–ç•¥æ”¶ç›Š%</td>${cmpCell(s.total_return_pct, cs.total_return_pct, true)}</tr>
                <tr><td>Alpha%</td>${cmpCell(s.alpha_pct, cs.alpha_pct, true)}</tr>
                <tr><td>æœ€å¤§å›æ’¤%</td>${cmpCell(s.max_drawdown_pct, cs.max_drawdown_pct, false)}</tr>
                <tr><td>èƒœç‡%</td>${cmpCell(s.win_rate_pct, cs.win_rate_pct, true)}</tr>
                <tr><td>ç›ˆäºæ¯”</td>${cmpCell(s.profit_factor, cs.profit_factor, true)}</tr>
                <tr><td>æ€»äº¤æ˜“æ•°</td>${cmpCell(s.total_trades, cs.total_trades, false)}</tr>
                <tr><td>å¹³ä»“æ•°</td>${cmpCell(s.close_trades, cs.close_trades, false)}</tr>
                <tr><td>æœŸæœ«èµ„é‡‘</td>${cmpCell(s.final_capital, cs.final_capital, true)}</tr>
                <tr><td>æ€»è´¹ç”¨</td>${cmpCell(s.total_costs, cs.total_costs, false)}</tr>
                <tr><td>å¼ºå¹³æ¬¡æ•°</td>${cmpCell(s.liquidations, cs.liquidations, false)}</tr>
            </tbody></table></div>`;
        }

        // â•â•â• æ±‡æ€»å¡ç‰‡ â•â•â•
        const _spotBuys = trades.filter(t => t.action === 'SPOT_BUY');
        const _spotSells = trades.filter(t => t.action === 'SPOT_SELL');
        const _futuresOpen = trades.filter(t => ['OPEN_LONG','OPEN_SHORT'].includes(t.action));
        const _futuresClose = trades.filter(t => ['CLOSE_LONG','CLOSE_SHORT','LIQUIDATED'].includes(t.action));
        const _partialTP = trades.filter(t => t.action === 'PARTIAL_TP');
        const _spotPnl = _spotSells.reduce((s2,t) => s2+(t.pnl||0), 0);
        const _futuresPnl = _futuresClose.reduce((s2,t) => s2+(t.pnl||0), 0) + _partialTP.reduce((s2,t) => s2+(t.pnl||0), 0);

        html += `<div class="card"><div class="title"><span class="icon"></span>å›æµ‹æ±‡æ€»</div>
        <div class="mg">
            <div class="mi"><div class="lb">ç­–ç•¥æ”¶ç›Š</div><div class="vl ${cls(s.total_return_pct)}">${fv(s.total_return_pct)}%</div></div>
            <div class="mi"><div class="lb">ä¹°å…¥æŒæœ‰</div><div class="vl ${cls(s.buy_hold_return_pct)}">${fv(s.buy_hold_return_pct)}%</div></div>
            <div class="mi"><div class="lb">Alpha</div><div class="vl ${cls(s.alpha_pct)}">${fv(s.alpha_pct)}%</div></div>
            <div class="mi"><div class="lb">æœ€å¤§å›æ’¤</div><div class="vl neg">${fv(s.max_drawdown_pct)}%</div></div>
            <div class="mi"><div class="lb">æœŸæœ«èµ„é‡‘</div><div class="vl">${fc(s.final_capital)}</div></div>
            <div class="mi"><div class="lb">å¼ºå¹³æ¬¡æ•°</div><div class="vl ${(s.liquidations||0)>0?'neg':'pos'}">${s.liquidations||0}</div></div>
        </div>
        <div class="mg">
            <div class="mi"><div class="lb">æ€»äº¤æ˜“</div><div class="vl neu">${s.total_trades||0}ç¬”</div></div>
            <div class="mi"><div class="lb">ç°è´§ä¹°å…¥</div><div class="vl neu">${_spotBuys.length}ç¬”</div></div>
            <div class="mi"><div class="lb">ç°è´§å–å‡º</div><div class="vl neu">${_spotSells.length}ç¬”</div></div>
            <div class="mi"><div class="lb">åˆçº¦å¼€ä»“</div><div class="vl neu">${_futuresOpen.length}ç¬”</div></div>
            <div class="mi"><div class="lb">åˆçº¦å¹³ä»“</div><div class="vl neu">${_futuresClose.length}ç¬”</div></div>
            <div class="mi"><div class="lb">éƒ¨åˆ†æ­¢ç›ˆ</div><div class="vl neu">${_partialTP.length}ç¬”</div></div>
            <div class="mi"><div class="lb">åˆçº¦èƒœç‡</div><div class="vl ${(s.win_rate_pct||0)>=50?'pos':'neg'}">${fv(s.win_rate_pct)}%</div></div>
            <div class="mi"><div class="lb">ç›ˆäºæ¯”</div><div class="vl ${(s.profit_factor||0)>=1.5?'pos':'neu'}">${fv(s.profit_factor)}</div></div>
        </div>
        <div class="mg">
            <div class="mi"><div class="lb">ç°è´§å·²å®ç°PnL(æˆæœ¬æ³•)</div><div class="vl ${cls(_spotPnl)}">${fc(_spotPnl)}</div></div>
            <div class="mi"><div class="lb">åˆçº¦å·²å®ç°PnL</div><div class="vl ${cls(_futuresPnl)}">${fc(_futuresPnl)}</div></div>
            <div class="mi"><div class="lb">æ€»è´¹ç”¨</div><div class="vl">${fc(s.total_costs)}</div></div>
            <div class="mi"><div class="lb">è´¹ç”¨æ‹–ç´¯</div><div class="vl neg">${fv(s.fee_drag_pct)}%</div></div>
            <div class="mi"><div class="lb">å‡€Funding</div><div class="vl ${cls(s.net_funding)}">${fc(s.net_funding)}</div></div>
        </div></div>`;

        // â•â•â• èµ„é‡‘æ›²çº¿ â•â•â•
        html += `<div class="card">
            <div class="title"><span class="icon"></span>èµ„é‡‘æ›²çº¿ & å›æ’¤${cmpData ? ' (å«å¯¹æ¯”)' : ''}</div>
            <div class="chart-box"><canvas id="mainChart"></canvas></div>
        </div>`;

        // â•â•â• é€æ—¥æ—¶é—´çº¿ â•â•â•
        const exportDailyUrl = '/api/multi_tf_daily/export_trades' + (data.run_id ? '?run_id=' + data.run_id : '');
        html += `<div class="card">
            <div class="title"><span class="icon"></span>é€æ—¥æŒä»“ç›ˆäº (${daily.length} å¤©)
                <a href="${exportDailyUrl}" class="btn-export" title="å¯¼å‡ºé€æ—¥ç›ˆäºExcel"
                   style="margin-left:12px;display:inline-block;padding:2px 10px;font-size:0.72rem;background:var(--cyan,#17a2b8);color:#fff;border-radius:4px;text-decoration:none;font-weight:600;vertical-align:middle">ğŸ“¥ å¯¼å‡ºExcel</a>
            </div>
            <div class="filter-bar">
                <label>ç­›é€‰:</label>
                <select id="posFilter">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="long">ä»…å¤šå¤´æ—¥</option>
                    <option value="short">ä»…ç©ºå¤´æ—¥</option>
                    <option value="trade">æœ‰äº¤æ˜“æ—¥</option>
                    <option value="empty">æ— æŒä»“æ—¥</option>
                </select>
                <label>æœç´¢:</label>
                <input id="dateSearch" placeholder="æ—¥æœŸå¦‚ 2025-03" style="width:120px;">
            </div>
            <div class="timeline scroll-y" id="timeline">
                <div class="tl-header">
                    <div class="tl-date">æ—¥æœŸ</div>
                    <div class="tl-price">ETHä»·æ ¼</div>
                    <div class="tl-assets">USDT / ETHèµ„äº§</div>
                    <div class="tl-bar">åˆçº¦æŒä»“</div>
                    <div class="tl-pnl">æœªå®ç°PnL</div>
                    <div class="tl-total">è´¦æˆ·æ€»å€¼</div>
                    <div class="tl-dd">å›æ’¤</div>
                    <div class="tl-trade">å½“æ—¥äº¤æ˜“</div>
                </div>
                <div id="tl-body"></div>
            </div>
        </div>`;

        // â•â•â• äº¤æ˜“è®°å½• â•â•â•
        const exportUrl = '/api/multi_tf_daily/export_trades' + (data.run_id ? '?run_id=' + data.run_id : '');
        html += `<div class="card"><details>
            <summary class="title" style="cursor:pointer">å®Œæ•´äº¤æ˜“è®°å½• (${trades.length} ç¬”)
                <a href="${exportUrl}" class="btn-export" title="å¯¼å‡ºExcel"
                   onclick="event.stopPropagation()" style="margin-left:12px;display:inline-block;padding:2px 10px;font-size:0.72rem;background:var(--cyan,#17a2b8);color:#fff;border-radius:4px;text-decoration:none;font-weight:600;vertical-align:middle">ğŸ“¥ å¯¼å‡ºExcel</a>
            </summary>
            <div style="overflow-x:auto;margin-top:10px;">
            <table class="dt" style="font-size:0.72rem;white-space:nowrap;"><thead><tr>
                <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>æ–¹å‘</th>
                <th class="center">å¸‚åœºä»·</th><th class="center">æˆäº¤ä»·</th>
                <th class="center">æ•°é‡</th><th class="center">åä¹‰ä»·å€¼</th>
                <th class="center">ä¿è¯é‡‘</th><th class="center">æ æ†</th>
                <th class="center">æ‰‹ç»­è´¹</th><th class="center">æ»‘ç‚¹</th>
                <th class="center">PnL</th>
                <th class="center">è´¦æˆ·æ€»å€¼</th><th>åŸå› </th>
            </tr></thead><tbody>`;
        trades.forEach((t, i) => {
            const pCls = (t.pnl||0) > 0 ? 'color:var(--green)' : (t.pnl||0) < 0 ? 'color:var(--red)' : '';
            const actionMap = {'OPEN_LONG':'å¼€å¤š', 'CLOSE_LONG':'å¹³å¤š', 'OPEN_SHORT':'å¼€ç©º', 'CLOSE_SHORT':'å¹³ç©º', 'LIQUIDATED':'å¼ºå¹³', 'SPOT_BUY':'ç°ä¹°', 'SPOT_SELL':'ç°å–', 'PARTIAL_TP':'éƒ¨åˆ†æ­¢ç›ˆ'};
            const isOpen = t.action && t.action.startsWith('OPEN');
            const isLiq = t.action === 'LIQUIDATED';
            html += `<tr>
                <td>${i+1}</td><td>${(t.time||'').replace('T',' ').slice(0,16)}</td>
                <td style="font-weight:600;${isLiq?'color:var(--red)':isOpen?'color:var(--cyan)':'color:var(--orange)'}">${actionMap[t.action]||t.action}</td>
                <td>${t.direction==='long'?'å¤š':t.direction==='short'?'ç©º':'-'}</td>
                <td class="center">$${fv(t.market_price)}</td>
                <td class="center">$${fv(t.exec_price)}</td>
                <td class="center">${fv(t.quantity)}</td>
                <td class="center">${fc(t.notional_value)}</td>
                <td class="center">${fc(t.margin)}</td>
                <td class="center">${t.leverage||'-'}x</td>
                <td class="center">$${fv(t.fee)}</td>
                <td class="center">$${fv(t.slippage_cost)}</td>
                <td class="center" style="${pCls};font-weight:700">${t.pnl!=null?'$'+fv(t.pnl):'-'}</td>
                <td class="center">${fc(t.after_total)}</td>
                <td style="font-size:0.68rem;max-width:250px;overflow:hidden;text-overflow:ellipsis">${t.reason||''}</td>
            </tr>`;
        });
        html += '</tbody></table></div></details></div>';

        // â•â•â• æœˆåº¦æ±‡æ€» â•â•â•
        const monthMap = {};
        daily.forEach(d => {
            const mon = d.date.slice(0,7);
            if (!monthMap[mon]) monthMap[mon] = { start: null, end: null, trades: 0, pnl: 0 };
            if (!monthMap[mon].start) monthMap[mon].start = d.total_value;
            monthMap[mon].end = d.total_value;
            monthMap[mon].trades += d.day_trades || 0;
            monthMap[mon].pnl += d.day_pnl || 0;
        });
        const months = Object.keys(monthMap).sort();
        const exportMonthlyUrl = '/api/multi_tf_daily/export_monthly' + (data.run_id ? '?run_id=' + data.run_id : '');
        html += `<div class="card"><div class="title">æœˆåº¦æ±‡æ€»
            <a href="${exportMonthlyUrl}" class="btn-export" title="å¯¼å‡ºæœˆåº¦æ±‡æ€»Excel"
               style="margin-left:12px;display:inline-block;padding:2px 10px;font-size:0.72rem;background:var(--cyan,#17a2b8);color:#fff;border-radius:4px;text-decoration:none;font-weight:600;vertical-align:middle">ğŸ“¥ å¯¼å‡ºExcel</a>
        </div>
        <div style="overflow-x:auto;"><table class="dt"><thead><tr>
            <th>æœˆä»½</th><th class="center">æœŸåˆ</th><th class="center">æœŸæœ«</th>
            <th class="center">æœˆæ”¶ç›Š</th><th class="center">äº¤æ˜“æ¬¡æ•°</th><th class="center">å·²å®ç°PnL</th>
        </tr></thead><tbody>`;
        months.forEach(mon => {
            const m2 = monthMap[mon];
            const ret = m2.start ? ((m2.end - m2.start) / m2.start * 100) : 0;
            html += `<tr>
                <td style="font-weight:600">${mon}</td>
                <td class="center">${fc(m2.start)}</td>
                <td class="center">${fc(m2.end)}</td>
                <td class="center"><span class="${cls(ret)}" style="font-weight:700">${ret.toFixed(2)}%</span></td>
                <td class="center">${m2.trades}</td>
                <td class="center"><span class="${cls(m2.pnl)}">${fc(m2.pnl)}</span></td>
            </tr>`;
        });
        html += '</tbody></table></div></div>';

        root.innerHTML = html;

        // â•â•â• æ—¶é—´çº¿æ¸²æŸ“ â•â•â•
        function renderTimeline(filter, search) {
            const body = document.getElementById('tl-body');
            let rows = '';
            daily.forEach(d => {
                const dayTr = tradeByDate[d.date] || [];
                const hasL = d.has_long;
                const hasS = d.has_short;
                if (filter === 'long' && !hasL) return;
                if (filter === 'short' && !hasS) return;
                if (filter === 'trade' && dayTr.length === 0) return;
                if (filter === 'empty' && (hasL || hasS)) return;
                if (search && !d.date.includes(search)) return;

                const posClass = hasL && hasS ? 'pos-both' : hasL ? 'pos-long' : hasS ? 'pos-short' : 'pos-none';
                let posHtml = '<span style="color:var(--text-muted)">-</span>';
                if (hasL || hasS) {
                    posHtml = '';
                    if (hasL) posHtml += `<span class="pos-pill long">å¤š</span>`;
                    if (hasS) posHtml += `<span class="pos-pill short">ç©º</span>`;
                    if (d.long_entry) posHtml += `<span style="font-size:0.68rem;color:var(--text-muted)"> L@${fv(d.long_entry)}</span>`;
                    if (d.short_entry) posHtml += `<span style="font-size:0.68rem;color:var(--text-muted)"> S@${fv(d.short_entry)}</span>`;
                }

                const unrealPnl = (d.long_pnl||0) + (d.short_pnl||0);
                let pnlHtml = '<span style="color:var(--text-muted)">-</span>';
                if (hasL || hasS) pnlHtml = `<span class="${cls(unrealPnl)}" style="font-weight:600">$${fv(unrealPnl)}</span>`;

                let tradeHtml = '';
                dayTr.forEach(t => {
                    const actionMap = {'OPEN_LONG':'å¼€å¤š','CLOSE_LONG':'å¹³å¤š','OPEN_SHORT':'å¼€ç©º','CLOSE_SHORT':'å¹³ç©º','LIQUIDATED':'å¼ºå¹³','PARTIAL_TP':'æ­¢ç›ˆ','SPOT_BUY':'ç°ä¹°','SPOT_SELL':'ç°å–'};
                    const isOpen = t.action && (t.action.startsWith('OPEN') || t.action === 'SPOT_BUY');
                    const isLiq = t.action === 'LIQUIDATED';
                    const markCls = isLiq ? 'liq' : isOpen ? 'open' : 'close';
                    tradeHtml += `<span class="trade-mark ${markCls}">${actionMap[t.action]||t.action}</span>`;
                    if (!isOpen && t.pnl != null) tradeHtml += `<span class="${cls(t.pnl)}" style="font-size:0.68rem;font-weight:600">$${fv(t.pnl)}</span> `;
                });

                const ddPct = Math.abs(d.drawdown_pct || 0);
                const ddWidth = Math.min(100, ddPct * 3);
                const usdt = d.usdt || 0;
                const ethVal = d.spot_eth_value || 0;
                const frozenM = d.frozen_margin || 0;
                const ethQty = d.eth_price > 0 ? (ethVal / d.eth_price) : 0;

                rows += `<div class="tl-row ${posClass}">
                    <div class="tl-date">${d.date}</div>
                    <div class="tl-price">$${fv(d.eth_price)}</div>
                    <div class="tl-assets">
                        <div class="a-row"><span class="a-label">USDT</span><span class="a-val">${fc(usdt)}</span></div>
                        <div class="a-row"><span class="a-label">ETH</span><span class="a-val" style="color:var(--orange)">${ethQty.toFixed(2)} (${fc(ethVal)})</span></div>
                        ${frozenM > 0 ? '<div class="a-row"><span class="a-label">å†»ç»“</span><span class="a-val" style="color:var(--purple)">'+fc(frozenM)+'</span></div>' : ''}
                    </div>
                    <div class="tl-bar">${posHtml}</div>
                    <div class="tl-pnl">${pnlHtml}</div>
                    <div class="tl-total"><span class="${cls(d.return_pct)}">${fc(d.total_value)}</span></div>
                    <div class="tl-dd"><span class="neg">${ddPct > 0 ? '-'+ddPct.toFixed(1)+'%' : '-'}</span>
                        <div class="dd-bar" style="width:50px"><div class="dd-fill" style="width:${ddWidth}%"></div></div>
                    </div>
                    <div class="tl-trade">${tradeHtml || '<span style="color:var(--text-muted)">-</span>'}</div>
                </div>`;
            });
            body.innerHTML = rows;
        }
        renderTimeline('all', '');
        document.getElementById('posFilter').addEventListener('change', e => {
            renderTimeline(e.target.value, document.getElementById('dateSearch').value);
        });
        document.getElementById('dateSearch').addEventListener('input', e => {
            renderTimeline(document.getElementById('posFilter').value, e.target.value);
        });

        // â•â•â• å›¾è¡¨ â•â•â•
        if (equity.length > 0) {
            const labels = equity.map(e => e.date);
            const datasets = [
                { label: 'è´¦æˆ·æ€»å€¼', data: equity.map(e=>e.total), borderColor: '#5b8af5', backgroundColor: 'rgba(91,138,245,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y' },
                { label: 'ETHä»·æ ¼', data: equity.map(e=>e.price), borderColor: '#f59e0b', borderWidth: 1.5, tension: 0.3, pointRadius: 0, borderDash: [4,2], yAxisID: 'y1' },
                { label: 'å›æ’¤%', data: equity.map(e=> -(e.drawdown||0)), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1, yAxisID: 'y2' },
            ];

            // å¯¹æ¯”æ›²çº¿
            if (cmpData && cmpData.equity_curve) {
                const cmpEquity = cmpData.equity_curve;
                const cmpMap = {};
                cmpEquity.forEach(e => cmpMap[e.date] = e.total);
                datasets.push({
                    label: `å¯¹æ¯”#${cmpData.run_id}`,
                    data: labels.map(d => cmpMap[d] || null),
                    borderColor: '#a78bfa',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 0,
                    borderDash: [6,3],
                    yAxisID: 'y',
                });
            }

            new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#8b8fa8', font: { size: 10 } } } },
                    scales: {
                        x: { ticks: { color: '#8b8fa8', maxTicksLimit: 15, font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.5)' } },
                        y: { position: 'left', ticks: { color: '#5b8af5', font: { size: 9 } }, grid: { color: 'rgba(42,46,66,0.3)' } },
                        y1: { position: 'right', ticks: { color: '#f59e0b', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                        y2: { position: 'right', ticks: { color: '#ef4444', font: { size: 9 }, callback: v=>v+'%' }, grid: { drawOnChartArea: false }, max: 0, min: Math.min(-5, (s.max_drawdown_pct||15)*1.2) },
                    },
                },
            });
        }

        // â•â•â• äº‹ä»¶ç»‘å®šï¼ˆå«åŠ è½½æ›´å¤šï¼‰ â•â•â•
        async function _loadMoreRuns() {
            const more = await fetchRunsPage(_runsOffset, RUNS_PAGE_SIZE);
            if (more.length > 0) {
                // å»é‡ï¼ˆæŒ‰ run_idï¼‰
                const existIds = new Set(allRuns.map(r => r.run_id));
                more.forEach(r => { if (!existIds.has(r.run_id)) allRuns.push(r); });
                _runsOffset += more.length;
            }
            if (more.length < RUNS_PAGE_SIZE) _runsHasMore = false;
        }

        document.getElementById('runSelector').addEventListener('change', async e => {
            const rid = e.target.value;
            if (rid === '__load_more__') {
                await _loadMoreRuns();
                renderPage(data, compareData);
                return;
            }
            window.history.replaceState(null, '', `?run_id=${rid}`);
            data = await loadRun(rid);
            renderPage(data, compareData);
        });
        document.getElementById('cmpSelector').addEventListener('change', async e => {
            const rid = e.target.value;
            if (rid === '__load_more__') {
                await _loadMoreRuns();
                renderPage(data, compareData);
                return;
            }
            if (rid) {
                compareData = await loadRun(rid);
            } else {
                compareData = null;
            }
            renderPage(data, compareData);
        });
    }

    renderPage(data, null);
});
</script>
{% endblock %}
