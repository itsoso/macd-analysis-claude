{% extends "base.html" %}
{% block title %}å…­ä¹¦èåˆä¼˜åŒ– â€” è¶…è¶ŠÎ±=+86.69%{% endblock %}
{% block content %}
<h1 class="page-title">å…­ä¹¦èåˆå¤šæ—¶é—´æ¡†æ¶ä¼˜åŒ–</h1>
<p class="page-subtitle">12ä¸ªæ—¶é—´å‘¨æœŸ Ã— 1400+å‚æ•°å˜ä½“ Â· å«KDJç¬¬6ç»´ä¿¡å· Â· ç›®æ ‡: è¶…è¶Šäº”ä¹¦æœ€ä¼˜ Î±=+86.69%</p>

<div id="loading" class="loading">
    <div class="spinner"></div> åŠ è½½å…­ä¹¦ä¼˜åŒ–ç»“æœ...
</div>

<div id="content" style="display:none;">

<!-- æ ¸å¿ƒå¯¹æ¯” -->
<div class="stats-grid" id="hero-stats"></div>

<!-- åŸºçº¿ vs æ–°æœ€ä¼˜ -->
<div class="card" style="border-left: 4px solid #ff6b35;">
    <div class="card-title">ğŸ†š äº”ä¹¦æœ€ä¼˜ vs å…­ä¹¦æœ€ä¼˜ å¯¹æ¯”</div>
    <div id="vs-content"></div>
</div>

<!-- å„æ—¶é—´æ¡†æ¶åŸºå‡† -->
<div class="card">
    <div class="card-title">ğŸ“Š 12ä¸ªæ—¶é—´æ¡†æ¶åŸºå‡†æ€§èƒ½(å…­ä¹¦C6+å››ä¹¦å¦å†³)</div>
    <div style="overflow-x: auto;">
        <table class="data-table" id="tf-table">
            <thead>
                <tr>
                    <th>æ—¶é—´æ¡†æ¶</th>
                    <th>Alpha (Î±)</th>
                    <th>ç­–ç•¥æ”¶ç›Š</th>
                    <th>ä¹°æŒæ”¶ç›Š</th>
                    <th>æœ€å¤§å›æ’¤</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- å…¨å±€TOP30 -->
<div class="card">
    <div class="card-title">ğŸ† å…¨å±€TOP30å‚æ•°ç»„åˆ(è·¨æ—¶é—´æ¡†æ¶ Ã— è·¨å‚æ•°)</div>
    <div style="overflow-x: auto;">
        <table class="data-table" id="top-table">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>æ—¶é—´æ¡†æ¶</th>
                    <th>å‚æ•°æ ‡ç­¾</th>
                    <th>Alpha (Î±)</th>
                    <th>ç­–ç•¥æ”¶ç›Š</th>
                    <th>æœ€å¤§å›æ’¤</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                    <th>æ‰‹ç»­è´¹</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- æœ€ä¼˜ç­–ç•¥è¯¦è§£ -->
<div class="card" style="border-left: 4px solid gold;">
    <div class="card-title">ğŸ… å…¨å±€æœ€ä¼˜ç­–ç•¥è¯¦ç»†å‚æ•°</div>
    <div id="best-detail"></div>
</div>

<!-- å›æµ‹æ¡ä»¶è¯´æ˜ -->
<div class="card">
    <div class="card-title">ğŸ“‹ å›æµ‹çœŸå®æ¡ä»¶</div>
    <div class="arch-diagram">
        <div class="arch-layer">
            <div class="arch-box data">ğŸ“ˆ çœŸå®æ•°æ®<br><small>å¸å®‰ ETH/USDT<br>æœ€è¿‘30å¤©Kçº¿</small></div>
            <div class="arch-box analysis">ğŸ’° æ‰‹ç»­è´¹<br><small>Taker 0.05%<br>Maker 0.02%</small></div>
            <div class="arch-box core">â° èµ„é‡‘è´¹ç‡<br><small>æ¯8å°æ—¶ Â±0.01%<br>æ°¸ç»­åˆçº¦</small></div>
            <div class="arch-box signal">ğŸ”’ é£æ§<br><small>é€ä»“æ¨¡å¼<br>5%ç»´æŒä¿è¯é‡‘å¼ºå¹³</small></div>
        </div>
    </div>
</div>

</div>

<style>
.vs-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 20px;
    align-items: center;
    margin: 20px 0;
}
.vs-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    border: 2px solid var(--border-subtle);
}
.vs-card.old { border-color: #666; }
.vs-card.new { border-color: gold; box-shadow: 0 0 20px rgba(255,215,0,0.2); }
.vs-arrow {
    font-size: 2em;
    color: var(--accent-green);
    font-weight: bold;
}
.vs-label { font-size: 0.85em; color: var(--text-dim); margin-bottom: 8px; }
.vs-alpha { font-size: 2.2em; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
.vs-alpha.positive { color: var(--accent-green); }
.vs-detail { margin-top: 12px; font-size: 0.85em; color: var(--text-secondary); line-height: 1.8; }
.improvement-badge {
    display: inline-block;
    background: linear-gradient(135deg, #ff6b35, #ff4500);
    color: white;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1.1em;
    margin-top: 8px;
}
.param-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
    margin: 16px 0;
}
.param-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--bg-hover);
    border-radius: 8px;
    font-size: 0.9em;
}
.param-label { color: var(--text-dim); }
.param-value { font-weight: 600; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const resp = await fetch('/api/optimize_six_book');
        if (!resp.ok) throw new Error('API error');
        const data = await resp.json();
        render(data);
    } catch(e) {
        document.getElementById('loading').innerHTML = '<p style="color:var(--accent-red)">åŠ è½½å¤±è´¥: ' + e.message + '</p>';
    }
});

function render(data) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';

    const best = data.global_best || {};
    const prevAlpha = data.previous_best_alpha || 86.69;
    const improvement = (best.alpha || 0) - prevAlpha;
    const beatPrev = improvement > 0;

    // Hero stats
    const heroHtml = `
        <div class="stat-card ${beatPrev ? 'positive' : ''}">
            <div class="stat-label">ğŸ† å…­ä¹¦å…¨å±€æœ€ä¼˜ Alpha</div>
            <div class="stat-value" style="color: var(--accent-green); font-size: 1.8em;">+${(best.alpha||0).toFixed(2)}%</div>
        </div>
        <div class="stat-card ${beatPrev ? 'positive' : 'negative'}">
            <div class="stat-label">vs äº”ä¹¦æœ€ä¼˜ (+86.69%)</div>
            <div class="stat-value" style="color: ${beatPrev ? 'var(--accent-green)' : 'var(--accent-red)'};">
                ${improvement >= 0 ? '+' : ''}${improvement.toFixed(2)}% ${beatPrev ? 'âœ“ è¶…è¶Š!' : ''}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“ æœ€ä¼˜æ—¶é—´æ¡†æ¶</div>
            <div class="stat-value">${best.tf || '-'}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ”¬ æµ‹è¯•å˜ä½“æ€»æ•°</div>
            <div class="stat-value">${(data.total_variants_tested||0).toLocaleString()}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“ˆ ç­–ç•¥æ”¶ç›Š</div>
            <div class="stat-value" style="color: var(--accent-green);">+${(best.strategy_return||0).toFixed(2)}%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“‰ æœ€å¤§å›æ’¤</div>
            <div class="stat-value" style="color: var(--accent-red);">${(best.max_drawdown||0).toFixed(2)}%</div>
        </div>
    `;
    document.getElementById('hero-stats').innerHTML = heroHtml;

    // VS comparison
    const cfg = best.config || {};
    const vsHtml = `
        <div class="vs-grid">
            <div class="vs-card old">
                <div class="vs-label">äº”ä¹¦æœ€ä¼˜ (ç²¾é€‰åˆ†æ®µTP@20%å¹³30% + æœ€ä½³SL/TP)</div>
                <div class="vs-alpha positive">+86.69%</div>
                <div class="vs-detail">
                    æ—¶é—´æ¡†æ¶: 1h<br>
                    èåˆæ¨¡å¼: C6+ä¸‰ä¹¦å¦å†³<br>
                    åˆ†æ®µæ­¢ç›ˆ: @20%å¹³30%<br>
                    ç©ºSL/TP: -25%/+60%<br>
                    å¤šSL/TP: -8%/+30%
                </div>
            </div>
            <div class="vs-arrow">â†’</div>
            <div class="vs-card new">
                <div class="vs-label">å…­ä¹¦å…¨å±€æœ€ä¼˜</div>
                <div class="vs-alpha positive">+${(best.alpha||0).toFixed(2)}%</div>
                <div class="vs-detail">
                    æ—¶é—´æ¡†æ¶: ${best.tf || '-'}<br>
                    èåˆæ¨¡å¼: ${cfg.fusion_mode || '-'}<br>
                    å‚æ•°: ${best.tag || '-'}<br>
                    ç©ºSL/TP: ${((cfg.short_sl||0)*100).toFixed(0)}%/${((cfg.short_tp||0)*100).toFixed(0)}%<br>
                    å¤šSL/TP: ${((cfg.long_sl||0)*100).toFixed(0)}%/${((cfg.long_tp||0)*100).toFixed(0)}%
                </div>
                <div class="improvement-badge">æå‡ ${improvement >= 0 ? '+' : ''}${improvement.toFixed(2)}%</div>
            </div>
        </div>
    `;
    document.getElementById('vs-content').innerHTML = vsHtml;

    // Timeframe baselines
    const tfBody = document.querySelector('#tf-table tbody');
    const baselines = data.baseline_by_tf || [];
    const topTfs = data.top_timeframes || [];
    baselines.sort((a, b) => b.alpha - a.alpha);
    baselines.forEach(b => {
        const isTop = topTfs.includes(b.tf);
        const tr = document.createElement('tr');
        if (isTop) tr.style.background = 'rgba(255,215,0,0.05)';
        tr.innerHTML = `
            <td>${isTop ? 'â­ ' : ''}${b.tf}</td>
            <td style="color: ${b.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                ${b.alpha >= 0 ? '+' : ''}${b.alpha.toFixed(2)}%
            </td>
            <td>${b.strategy_return >= 0 ? '+' : ''}${b.strategy_return.toFixed(2)}%</td>
            <td>${b.buy_hold_return >= 0 ? '+' : ''}${b.buy_hold_return.toFixed(2)}%</td>
            <td style="color: var(--accent-red);">${b.max_drawdown.toFixed(2)}%</td>
            <td>${b.total_trades}</td>
        `;
        tfBody.appendChild(tr);
    });

    // Global top30
    const topBody = document.querySelector('#top-table tbody');
    const top30 = data.global_top30 || [];
    top30.forEach(r => {
        const tr = document.createElement('tr');
        const isBest = r.rank <= 3;
        if (isBest) tr.style.background = 'rgba(255,215,0,0.08)';
        const star = r.rank === 1 ? ' ğŸ†' : r.rank <= 3 ? ' â­' : '';
        const beatStr = r.alpha > prevAlpha ? ' <span style="color:gold;font-weight:700;">âœ“è¶…è¶Š</span>' : '';
        tr.innerHTML = `
            <td style="font-weight:700;">#${r.rank}${star}</td>
            <td>${r.tf}</td>
            <td style="max-width:280px;">${r.tag}</td>
            <td style="color: var(--accent-green); font-weight: 700;">+${r.alpha.toFixed(2)}%${beatStr}</td>
            <td>${r.strategy_return >= 0 ? '+' : ''}${r.strategy_return.toFixed(2)}%</td>
            <td style="color: var(--accent-red);">${r.max_drawdown.toFixed(2)}%</td>
            <td>${r.total_trades}</td>
            <td>$${(r.fees||0).toLocaleString()}</td>
        `;
        topBody.appendChild(tr);
    });

    // Best detail
    const paramItems = [
        ['èåˆæ¨¡å¼', cfg.fusion_mode || 'c6_veto_4'],
        ['ç©ºå¤´æ­¢æŸ', `${((cfg.short_sl||0)*100).toFixed(0)}%`],
        ['ç©ºå¤´æ­¢ç›ˆ', `${((cfg.short_tp||0)*100).toFixed(0)}%`],
        ['å¤šå¤´æ­¢æŸ', `${((cfg.long_sl||0)*100).toFixed(0)}%`],
        ['å¤šå¤´æ­¢ç›ˆ', `${((cfg.long_tp||0)*100).toFixed(0)}%`],
        ['è¿½è¸ªæ­¢ç›ˆ', `${((cfg.short_trail||0)*100).toFixed(0)}%`],
        ['å›æ’¤æ¯”ä¾‹', `${((cfg.trail_pullback||0)*100).toFixed(0)}%`],
        ['æœ€å¤§æŒä»“', `${cfg.short_max_hold||72} bars`],
        ['å†·å´æœŸ', `${cfg.cooldown||4} bars`],
        ['åˆ†æ®µæ­¢ç›ˆ', cfg.use_partial_tp ? `@${((cfg.partial_tp_1||0)*100).toFixed(0)}% å¹³${((cfg.partial_tp_1_pct||0)*100).toFixed(0)}%` : 'å…³é—­'],
        ['æ æ†', `${cfg.lev||5}x`],
        ['ä»“ä½æ¯”ä¾‹', `${((cfg.margin_use||0.7)*100).toFixed(0)}%`],
    ];
    if (cfg.use_atr_sl) paramItems.push(['ATRæ­¢æŸ', `${cfg.atr_sl_mult||3.0}x`]);
    if (cfg.kdj_bonus) paramItems.push(['KDJå¥–åŠ±', `${((cfg.kdj_bonus||0)*100).toFixed(0)}%`]);
    if (cfg.veto_threshold) paramItems.push(['å¦å†³é˜ˆå€¼', cfg.veto_threshold]);

    const detailHtml = `
        <div style="margin-bottom: 16px;">
            <span style="font-size: 1.2em; font-weight: 700;">
                ${best.tag || '-'}
            </span>
            <span style="margin-left: 12px; color: var(--text-dim);">
                æ—¶é—´æ¡†æ¶: ${best.tf || '-'} Â· äº¤æ˜“${best.total_trades||0}æ¬¡ Â· å›æ’¤${(best.max_drawdown||0).toFixed(2)}% Â· æ‰‹ç»­è´¹$${(best.fees||0).toLocaleString()}
            </span>
        </div>
        <div class="param-grid">
            ${paramItems.map(([label, value]) =>
                `<div class="param-item"><span class="param-label">${label}</span><span class="param-value">${value}</span></div>`
            ).join('')}
        </div>
    `;
    document.getElementById('best-detail').innerHTML = detailHtml;
}
</script>
{% endblock %}
