{% extends "base.html" %}
{% block title %}å…­ä¹¦èåˆç­–ç•¥{% endblock %}
{% block content %}
<h1 class="page-title">å…­ä¹¦èåˆç­–ç•¥</h1>
<p class="page-subtitle">èƒŒç¦» Ã— å‡çº¿ Ã— èœ¡çƒ›å›¾ Ã— å¸ƒæ—å¸¦ Ã— é‡ä»· Ã— KDJ â€” å…­ç»´ä¿¡å·èåˆ Â· ETH/USDT 30å¤©å›æµ‹</p>

<div id="loading" class="loading">
    <div class="spinner"></div> åŠ è½½å…­ä¹¦èåˆç­–ç•¥æ•°æ®...
</div>

<div id="content" style="display:none;">

<!-- æ¦‚è§ˆ -->
<div class="stats-grid" id="overview-stats"></div>

<!-- äº”ä¹¦ vs å…­ä¹¦å¯¹æ¯” -->
<div class="card" id="compare-card" style="border-left: 3px solid var(--accent-blue);">
    <div class="card-title">ğŸ“Š äº”ä¹¦ vs å…­ä¹¦å¯¹æ¯”</div>
    <div id="compare-content"></div>
</div>

<!-- ç­–ç•¥æ’å -->
<div class="card">
    <div class="card-title">ğŸ† å…«ç§èåˆå˜ä½“æ’å</div>
    <div style="overflow-x: auto;">
        <table class="data-table" id="rank-table">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>ç­–ç•¥åç§°</th>
                    <th>Alpha (Î±)</th>
                    <th>ç­–ç•¥æ”¶ç›Š</th>
                    <th>ä¹°æŒæ”¶ç›Š</th>
                    <th>æœ€å¤§å›æ’¤</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                    <th>æ€»è´¹ç”¨</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- èåˆæ¶æ„ -->
<div class="card">
    <div class="card-title">ğŸ—ï¸ å…­ä¹¦èåˆæ¶æ„</div>
    <div class="arch-diagram">
        <div class="arch-layer">
            <div class="arch-box data">ğŸ“– èƒŒç¦»åˆ†æ<br><small>MACD/KDJ/CCI/RSI</small></div>
            <div class="arch-box data">ğŸ“ˆ å‡çº¿åˆ†æ<br><small>è‘›å—ç»´/äº¤å‰/æ’åˆ—</small></div>
        </div>
        <div class="arch-arrow">â–¼ C6åº•åº§(èƒŒç¦»70% + å‡çº¿30%)</div>
        <div class="arch-layer">
            <div class="arch-box analysis">ğŸ•¯ï¸ èœ¡çƒ›å›¾<br><small>30+å½¢æ€</small></div>
            <div class="arch-box analysis">ğŸ“‰ å¸ƒæ—å¸¦<br><small>%B/Squeeze</small></div>
            <div class="arch-box analysis">ğŸ“Š é‡ä»·åˆ†æ<br><small>OBV/MFI/VWAP</small></div>
            <div class="arch-box core">ğŸ“ˆ KDJæ³¢æ®µ â˜…æ–°â˜…<br><small>é‡‘å‰æ­»å‰/èƒŒç¦»/å››æ’</small></div>
        </div>
        <div class="arch-arrow">â–¼ å››ä¹¦å¦å†³/ç¡®è®¤(å‡çº§: 3â†’4ç»´)</div>
        <div class="arch-layer">
            <div class="arch-box out">ğŸ¯ æœ€ç»ˆä¿¡å· â†’ æ‰§è¡Œäº¤æ˜“</div>
        </div>
    </div>
</div>

<!-- KDJæ–°å¢ä¿¡å· -->
<div class="card" style="border-left: 3px solid var(--accent-purple);">
    <div class="card-title">ğŸ“ˆ KDJæ³¢æ®µä¿¡å·(ç¬¬6ç»´)</div>
    <div class="principle-grid">
        <div class="principle-card buy" style="background: var(--bg-secondary);">
            <h3>ğŸŸ¢ ä¹°å…¥ä¿¡å·(æƒé‡0.09ç¡®è®¤)</h3>
            <p>
                <strong>è¶…å–åŒºé‡‘å‰(+30):</strong> K<20 ä¸” D<25 æ—¶é‡‘å‰<br>
                <strong>50ä¸‹é‡‘å‰(+20):</strong> K<50æ—¶é‡‘å‰<br>
                <strong>åº•èƒŒç¦»(+40max):</strong> ä»·æ ¼åˆ›æ–°ä½ä½†Kçº¿ä¸åˆ›æ–°ä½<br>
                <strong>KD-MACDæŠ½è„š(+15):</strong> ç»¿æŸ±ç¼©çŸ­<br>
                <strong>å››æ’åº•(+35max):</strong> Kçº¿4æ¬¡è¿›å…¥è¶…å–åŒº<br>
                <strong>äºŒæ¬¡é‡‘å‰(+25max):</strong> åŒåŒºåŸŸä¸¤æ¬¡é‡‘å‰<br>
                <strong>Jæè¶…å–æ‹å¤´(+8):</strong> J<-10æ—¶æ‹å¤´å‘ä¸Š
            </p>
        </div>
        <div class="principle-card sell" style="background: var(--bg-secondary);">
            <h3>ğŸ”´ å–å‡ºä¿¡å·(æƒé‡0.09ç¡®è®¤)</h3>
            <p>
                <strong>è¶…ä¹°åŒºæ­»å‰(+30):</strong> K>80 ä¸” D>75 æ—¶æ­»å‰<br>
                <strong>50ä¸Šæ­»å‰(+20):</strong> K>50æ—¶æ­»å‰<br>
                <strong>é¡¶èƒŒç¦»(+40max):</strong> ä»·æ ¼åˆ›æ–°é«˜ä½†Kçº¿ä¸åˆ›æ–°é«˜<br>
                <strong>KD-MACDç¼©å¤´(+15):</strong> çº¢æŸ±ç¼©çŸ­<br>
                <strong>å››æ’é¡¶(+35max):</strong> Kçº¿4æ¬¡è¿›å…¥è¶…ä¹°åŒº<br>
                <strong>äºŒæ¬¡æ­»å‰(+25max):</strong> åŒåŒºåŸŸä¸¤æ¬¡æ­»å‰<br>
                <strong>Jæè¶…ä¹°æ‹å¤´(+8):</strong> J>110æ—¶æ‹å¤´å‘ä¸‹
            </p>
        </div>
    </div>
</div>

<!-- ç­–ç•¥å˜ä½“è¯´æ˜ -->
<div class="card">
    <div class="card-title">ğŸ“‹ å…«ç§èåˆå˜ä½“è¯´æ˜</div>
    <div style="color: var(--text-secondary); line-height: 1.8; font-size: 14px;">
        <p><strong>S1: äº”ä¹¦åŸºå‡†</strong> â€” åŸäº”ä¹¦C6+ä¸‰ä¹¦å¦å†³(ä¸å«KDJ), ä½œä¸ºå¯¹ç…§ç»„</p>
        <p><strong>S2: å…­ä¹¦C6+å››ä¹¦å¦å†³</strong> â€” æ ¸å¿ƒå‡çº§: KDJåŠ å…¥å¦å†³/ç¡®è®¤ä½“ç³»</p>
        <p><strong>S3: å…­ä¹¦(ä½å¦å†³é˜ˆå€¼)</strong> â€” veto_thresholdä»25é™è‡³20, æ›´æ•æ„Ÿçš„å¦å†³</p>
        <p><strong>S4: KDJåŠ æƒ</strong> â€” KDJè¿›å…¥åŸºç¡€åˆ†æƒé‡(èƒŒç¦»55%+å‡çº¿25%+KDJ20%)</p>
        <p><strong>S5: KDJæ‹©æ—¶</strong> â€” KDJä½œä¸ºC6çš„æ‹©æ—¶ä¹˜æ•°(å¼ºå–Ã—1.25/åå‘Ã—0.7)</p>
        <p><strong>S6: å…­ä¹¦å¦å†³(æ— åˆ†æ®µTP)</strong> â€” æ¶ˆèæµ‹è¯•: å…³é—­åˆ†æ®µæ­¢ç›ˆ</p>
        <p><strong>S7: å…­ä¹¦å¦å†³(é«˜é˜ˆå€¼)</strong> â€” ä¿å®ˆæ¨¡å¼: æé«˜æ‰€æœ‰ä¿¡å·é˜ˆå€¼, å‡å°‘å™ªéŸ³</p>
        <p><strong>S8: å…­ä¹¦å¦å†³(æ¿€è¿›åšç©º)</strong> â€” é™ä½åšç©ºé—¨æ§›, æé«˜ä¿è¯é‡‘ä½¿ç”¨ç‡</p>
    </div>
</div>

</div>

<script>
fetch('/api/six_book')
    .then(r => r.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        if (data.error) {
            document.getElementById('content').innerHTML = '<div class="card"><p style="color:var(--accent-red);">'+data.error+'</p></div>';
            return;
        }

        const strats = data.strategies || [];
        const best = strats[0] || {};
        const fiveAlpha = data.five_book_alpha || 0;
        const sixAlpha = data.six_book_alpha || 0;
        const improvement = data.improvement || 0;

        // Overview cards
        const statsHtml = `
            <div class="stat-card">
                <div class="stat-label">å…­ä¹¦æœ€ä½³Alpha</div>
                <div class="stat-value ${sixAlpha >= 0 ? 'positive' : 'negative'}">${sixAlpha >= 0 ? '+' : ''}${sixAlpha.toFixed(2)}%</div>
                <div class="stat-note">${best.name || ''}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">äº”ä¹¦åŸºå‡†Alpha</div>
                <div class="stat-value ${fiveAlpha >= 0 ? 'positive' : 'negative'}">${fiveAlpha >= 0 ? '+' : ''}${fiveAlpha.toFixed(2)}%</div>
                <div class="stat-note">C6+ä¸‰ä¹¦å¦å†³(å¯¹ç…§ç»„)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">KDJèåˆæå‡</div>
                <div class="stat-value ${improvement >= 0 ? 'positive' : 'negative'}">${improvement >= 0 ? '+' : ''}${improvement.toFixed(2)}%</div>
                <div class="stat-note">å…­ä¹¦ vs äº”ä¹¦å·®å€¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç­–ç•¥æ•°é‡</div>
                <div class="stat-value">${strats.length}</div>
                <div class="stat-note">å˜ä½“å¯¹æ¯”</div>
            </div>
        `;
        document.getElementById('overview-stats').innerHTML = statsHtml;

        // Compare card
        const compareHtml = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 12px;">
                <div style="flex: 1; min-width: 200px; padding: 16px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border);">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">ğŸ“– äº”ä¹¦åŸºå‡†(S1)</div>
                    <div style="font-size: 28px; font-weight: 700; color: ${fiveAlpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">Î± = ${fiveAlpha >= 0 ? '+' : ''}${fiveAlpha.toFixed(2)}%</div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">èƒŒç¦»Ã—å‡çº¿Ã—èœ¡çƒ›å›¾Ã—å¸ƒæ—å¸¦Ã—é‡ä»·</div>
                </div>
                <div style="display: flex; align-items: center; font-size: 24px; color: var(--accent-blue);">â†’</div>
                <div style="flex: 1; min-width: 200px; padding: 16px; border-radius: 8px; background: rgba(74,158,255,0.05); border: 2px solid var(--accent-blue);">
                    <div style="font-size: 12px; color: var(--accent-blue); margin-bottom: 8px;">â­ å…­ä¹¦æœ€ä½³(${best.name || ''})</div>
                    <div style="font-size: 28px; font-weight: 700; color: ${sixAlpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">Î± = ${sixAlpha >= 0 ? '+' : ''}${sixAlpha.toFixed(2)}%</div>
                    <div style="font-size: 12px; color: var(--accent-green); margin-top: 4px;">+KDJæ³¢æ®µ â†’ æå‡ ${improvement >= 0 ? '+' : ''}${improvement.toFixed(2)}%</div>
                </div>
            </div>
        `;
        document.getElementById('compare-content').innerHTML = compareHtml;

        // Rank table
        const tbody = document.querySelector('#rank-table tbody');
        strats.forEach((s, idx) => {
            const alpha = s.alpha || 0;
            const ret = s.strategy_return || 0;
            const bh = s.buy_hold_return || 0;
            const dd = s.max_drawdown || 0;
            const trades = s.total_trades || 0;
            const fees = (s.fees && s.fees.total_costs) ? s.fees.total_costs : 0;
            const isKDJ = (s.name || '').includes('å…­ä¹¦') || (s.name || '').includes('KDJ');

            let rankBadge = `<span style="color: var(--text-muted);">#${idx+1}</span>`;
            if (idx === 0) rankBadge = '<span class="rank-badge rank-1">1</span>';
            else if (idx === 1) rankBadge = '<span class="rank-badge rank-2">2</span>';
            else if (idx === 2) rankBadge = '<span class="rank-badge rank-3">3</span>';

            const row = document.createElement('tr');
            if (isKDJ && idx === 0) row.style.background = 'rgba(74,158,255,0.05)';
            row.innerHTML = `
                <td>${rankBadge}</td>
                <td style="font-weight: ${idx < 3 ? '600' : '400'};">${s.name || ''} ${isKDJ ? 'â˜…' : ''}</td>
                <td class="${alpha >= 0 ? 'pnl-pos' : 'pnl-neg'}">${alpha >= 0 ? '+' : ''}${alpha.toFixed(2)}%</td>
                <td class="${ret >= 0 ? 'pnl-pos' : 'pnl-neg'}">${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%</td>
                <td>${bh.toFixed(2)}%</td>
                <td class="pnl-neg">${dd.toFixed(2)}%</td>
                <td>${trades}</td>
                <td>$${fees.toFixed(0)}</td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(err => {
        document.getElementById('loading').innerHTML = '<p style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ' + err.message + '</p>';
    });
</script>
{% endblock %}
