{% extends "base.html" %}
{% block title %}çƒ­ç‚¹å¸é…ç½® - æŠ€æœ¯åˆ†æå¹³å°{% endblock %}

{% block content %}
<style>
    .page-header { margin-bottom: 20px; }
    .page-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
    .page-header p { color: var(--text-secondary); font-size: 14px; }
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
    }
    .card h3 {
        margin: 0 0 14px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
    }
    @media (max-width: 1100px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 760px) { .grid { grid-template-columns: 1fr; } }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 12px; color: var(--text-secondary); }
    .field input, .field select, .field textarea {
        background: #0e1320;
        border: 1px solid var(--border);
        color: var(--text-primary);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 13px;
        outline: none;
    }
    .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--accent-blue); }
    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-primary);
        padding-top: 20px;
    }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .btn {
        padding: 9px 14px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #101827;
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
    }
    .btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
    .btn.primary {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: #fff;
    }
    .editor {
        width: 100%;
        min-height: 420px;
        resize: vertical;
        font-family: "JetBrains Mono", monospace;
        line-height: 1.6;
    }
    .result {
        font-size: 13px;
        margin-top: 8px;
        color: var(--text-secondary);
    }
    .result.ok { color: var(--accent-green); }
    .result.err { color: var(--accent-red); }
    .metrics {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        margin-bottom: 12px;
    }
    @media (max-width: 900px) { .metrics { grid-template-columns: 1fr; } }
    .metric-box {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        background: #0e1320;
    }
    .metric-box .label { font-size: 12px; color: var(--text-secondary); }
    .metric-box .value { font-size: 20px; font-weight: 700; margin-top: 4px; }
    .list-box {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        background: #0e1320;
        min-height: 110px;
    }
    .list-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 12px;
        padding: 5px 0;
        border-bottom: 1px dashed #2a2f40;
    }
    .list-row:last-child { border-bottom: none; }
    .list-key { color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .list-val { color: var(--text-primary); font-weight: 600; }
    .muted { color: var(--text-secondary); font-size: 12px; }
</style>

<div class="page-header">
    <h1>ğŸ”¥ çƒ­ç‚¹å¸é…ç½®</h1>
    <p>ç‹¬ç«‹äºä¸»ç­–ç•¥é…ç½®ï¼Œä¿å­˜åç”¨äº <code>hotcoin.runner</code> è¯»å–ï¼ˆDB + JSON åŒå†™ï¼‰ã€‚</p>
</div>

<div class="card">
    <h3>å¸¸ç”¨å‚æ•°</h3>
    <div class="grid">
        <div class="field">
            <label>æ—¥å¿—çº§åˆ«</label>
            <select id="logLevel">
                <option value="DEBUG">DEBUG</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
            </select>
        </div>
        <div class="field">
            <label>æ•°æ®åº“è·¯å¾„</label>
            <input id="dbPath" type="text" />
        </div>
        <div class="field">
            <label>åˆå§‹èµ„é‡‘ (USDT)</label>
            <input id="initialCapital" type="number" step="10" />
        </div>
        <div class="field">
            <label>æœ€å¤§å¹¶å‘ä»“ä½</label>
            <input id="maxConcurrent" type="number" step="1" />
        </div>
        <div class="field">
            <label>å•å¸ä»“ä½ä¸Šé™</label>
            <input id="maxSinglePct" type="number" step="0.01" />
        </div>
        <div class="field">
            <label>æ€»æ•å£ä¸Šé™</label>
            <input id="maxExposurePct" type="number" step="0.01" />
        </div>
        <div class="field">
            <label>é‡èƒ½çªå¢å€æ•°</label>
            <input id="volSurgeRatio" type="number" step="0.1" />
        </div>
        <div class="field">
            <label>5m æ¶¨å¹…é˜ˆå€¼</label>
            <input id="priceSurge5m" type="number" step="0.001" />
        </div>
        <div class="field">
            <label>æœ€ä½ 24h æˆäº¤é¢</label>
            <input id="minQuoteVol24h" type="number" step="10000" />
        </div>
        <div class="field">
            <label>äº¤æ˜“å‘¨æœŸ (é€—å·åˆ†éš”)</label>
            <input id="timeframes" type="text" placeholder="1m,5m,15m,1h" />
        </div>
        <div class="field">
            <label>ä¿¡å·å¾ªç¯ç§’æ•°</label>
            <input id="signalLoopSec" type="number" step="1" />
        </div>
        <div class="field">
            <label>æœ€å°å…±è¯†å¼ºåº¦</label>
            <input id="minConsensus" type="number" step="1" />
        </div>
        <div class="field">
            <label>é»˜è®¤æ­¢æŸæ¯”ä¾‹</label>
            <input id="defaultSlPct" type="number" step="0.001" />
        </div>
        <div class="field">
            <label>è¿½è¸ªæ­¢æŸæ¯”ä¾‹</label>
            <input id="trailingStopPct" type="number" step="0.001" />
        </div>
        <div class="field">
            <label>æœ€å¤§æŒä»“åˆ†é’Ÿæ•°</label>
            <input id="maxHoldMinutes" type="number" step="1" />
        </div>
        <div class="checkbox-row">
            <input id="enableExecution" type="checkbox" />
            <label for="enableExecution">å¯ç”¨æ‰§è¡Œ (HOTCOIN_EXECUTE)</label>
        </div>
        <div class="checkbox-row">
            <input id="usePaperTrading" type="checkbox" />
            <label for="usePaperTrading">çº¸é¢äº¤æ˜“ (HOTCOIN_PAPER)</label>
        </div>
    </div>
</div>

<div class="card">
    <h3>ä¸‹å•é¢„æ£€ç›‘æ§</h3>
    <div class="btn-row">
        <button class="btn" onclick="refreshPrecheckStats()">åˆ·æ–°é¢„æ£€ç»Ÿè®¡</button>
        <span id="precheckMeta" class="muted">ç­‰å¾…æ•°æ®...</span>
    </div>
    <div class="metrics">
        <div class="metric-box">
            <div class="label">é¢„æ£€å¤±è´¥æ€»æ•°</div>
            <div class="value" id="precheckTotal">0</div>
        </div>
        <div class="metric-box">
            <div class="label">å¤±è´¥ç ç±»å‹æ•°</div>
            <div class="value" id="precheckCodeKinds">0</div>
        </div>
        <div class="metric-box">
            <div class="label">å—å½±å“å¸ç§æ•°</div>
            <div class="value" id="precheckSymbolKinds">0</div>
        </div>
    </div>
    <div class="grid">
        <div class="field">
            <label>æŒ‰å¤±è´¥ç ç»Ÿè®¡ (Top 10)</label>
            <div id="precheckByCode" class="list-box"></div>
        </div>
        <div class="field">
            <label>æŒ‰å¸ç§ç»Ÿè®¡ (Top 10)</label>
            <div id="precheckBySymbol" class="list-box"></div>
        </div>
    </div>
</div>

<div class="card">
    <h3>è¿è¡ŒçŠ¶æ€ä¸æ‰§è¡ŒæŒ‡æ ‡</h3>
    <div class="btn-row">
        <button class="btn" onclick="refreshRuntimeStatus()">åˆ·æ–°è¿è¡ŒçŠ¶æ€</button>
        <span id="runtimeMeta" class="muted">ç­‰å¾…æ•°æ®...</span>
    </div>
    <div class="metrics">
        <div class="metric-box">
            <div class="label">å¼•æ“çŠ¶æ€</div>
            <div class="value" id="engineState">unknown</div>
        </div>
        <div class="metric-box">
            <div class="label">å¯å¼€æ–°ä»“</div>
            <div class="value" id="canOpenNewPositions">false</div>
        </div>
        <div class="metric-box">
            <div class="label">è¡Œæƒ…æœ€æ–°å»¶è¿Ÿ(s)</div>
            <div class="value" id="latestTickerAgeSec">-</div>
        </div>
    </div>
    <div class="grid">
        <div class="field">
            <label>æ‰§è¡ŒæŒ‡æ ‡ (5m)</label>
            <div id="runtimeMetrics" class="list-box"></div>
        </div>
        <div class="field">
            <label>çŠ¶æ€åŸå› </label>
            <div id="runtimeReasons" class="list-box"></div>
        </div>
    </div>
</div>

<div class="card">
    <h3>å®Œæ•´ JSON é…ç½®</h3>
    <div class="btn-row">
        <button class="btn" onclick="loadHotcoinConfig()">åŠ è½½</button>
        <button class="btn" onclick="syncFormToEditor()">åŒæ­¥å¸¸ç”¨å‚æ•°åˆ° JSON</button>
        <button class="btn" onclick="resetHotcoinDefault()">æ¢å¤é»˜è®¤</button>
        <button class="btn primary" onclick="saveHotcoinConfig()">ä¿å­˜</button>
    </div>
    <div class="field">
        <textarea id="hotcoinConfigEditor" class="editor" spellcheck="false"></textarea>
    </div>
    <div id="resultBox" class="result"></div>
</div>

<script>
let _loadedConfig = null;
let _defaultConfig = null;
let _precheckTimer = null;

function setResult(msg, ok = true) {
    const box = document.getElementById('resultBox');
    box.textContent = msg;
    box.className = `result ${ok ? 'ok' : 'err'}`;
}

async function apiCall(url, options = {}) {
    const resp = await fetch(url, {
        headers: {'Content-Type': 'application/json'},
        ...options
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || data.success === false) {
        throw new Error(data.message || `HTTP ${resp.status}`);
    }
    return data;
}

function getByPath(obj, path, fallback = null) {
    let cur = obj;
    for (const key of path) {
        if (!cur || typeof cur !== 'object' || !(key in cur)) return fallback;
        cur = cur[key];
    }
    return cur;
}

function setByPath(obj, path, value) {
    let cur = obj;
    for (let i = 0; i < path.length - 1; i++) {
        const key = path[i];
        if (!cur[key] || typeof cur[key] !== 'object') cur[key] = {};
        cur = cur[key];
    }
    cur[path[path.length - 1]] = value;
}

function parseNumber(v, fallback = 0) {
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
}

function parseIntSafe(v, fallback = 0) {
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : fallback;
}

function formatTs(ts) {
    if (!ts) return '-';
    const d = new Date(Number(ts) * 1000);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleString();
}

function renderKeyValueList(containerId, rows) {
    const box = document.getElementById(containerId);
    if (!rows || rows.length === 0) {
        box.innerHTML = '<div class="muted">æš‚æ— æ•°æ®</div>';
        return;
    }
    box.innerHTML = rows.map(([k, v]) => `
        <div class="list-row">
            <span class="list-key" title="${k}">${k}</span>
            <span class="list-val">${v}</span>
        </div>
    `).join('');
}

function renderPrecheckStats(data) {
    const byCode = data.by_code || {};
    const bySymbolRaw = data.by_symbol || {};
    const bySymbol = Object.entries(bySymbolRaw).map(([symbol, detail]) => {
        const subtotal = Object.values(detail || {}).reduce((acc, n) => acc + (Number(n) || 0), 0);
        return [symbol, subtotal];
    });
    bySymbol.sort((a, b) => b[1] - a[1]);

    const codeRows = Object.entries(byCode).sort((a, b) => (b[1] || 0) - (a[1] || 0)).slice(0, 10);
    const symbolRows = bySymbol.slice(0, 10);

    document.getElementById('precheckTotal').textContent = Number(data.total || 0).toString();
    document.getElementById('precheckCodeKinds').textContent = Object.keys(byCode).length.toString();
    document.getElementById('precheckSymbolKinds').textContent = Object.keys(bySymbolRaw).length.toString();
    document.getElementById('precheckMeta').textContent = `æ¥æº: ${data.source || '-'} | æ—¶é—´: ${formatTs(data.ts)}`;

    renderKeyValueList('precheckByCode', codeRows);
    renderKeyValueList('precheckBySymbol', symbolRows);
}

async function refreshPrecheckStats() {
    try {
        const data = await apiCall('/hotcoin/api/precheck_stats');
        renderPrecheckStats(data || {});
    } catch (e) {
        document.getElementById('precheckMeta').textContent = `é¢„æ£€ç»Ÿè®¡åŠ è½½å¤±è´¥: ${e.message}`;
    }
}

function renderRuntimeStatus(data) {
    const state = data.engine_state || 'unknown';
    const canOpen = !!data.can_open_new_positions;
    const freshness = data.freshness || {};
    const metrics = data.execution_metrics || {};
    const reasons = data.engine_state_reasons || [];

    document.getElementById('engineState').textContent = state;
    document.getElementById('canOpenNewPositions').textContent = String(canOpen);
    const age = freshness.latest_ticker_age_sec;
    document.getElementById('latestTickerAgeSec').textContent =
        (age === null || age === undefined) ? '-' : String(age);
    document.getElementById('runtimeMeta').textContent =
        `æ›´æ–°æ—¶é—´: ${formatTs(data.ts)} | priced_symbols: ${freshness.priced_symbols ?? 0}`;

    const metricRows = [
        ['order_attempts_5m', metrics.order_attempts_5m ?? 0],
        ['order_success_5m', metrics.order_success_5m ?? 0],
        ['order_errors_5m', metrics.order_errors_5m ?? 0],
        ['precheck_failures_5m', metrics.precheck_failures_5m ?? 0],
        ['dedup_rejects_5m', metrics.dedup_rejects_5m ?? 0],
        ['precheck_fail_rate_5m', metrics.precheck_fail_rate_5m ?? 0],
        ['order_error_rate_5m', metrics.order_error_rate_5m ?? 0],
    ];
    renderKeyValueList('runtimeMetrics', metricRows);
    renderKeyValueList('runtimeReasons', reasons.map(r => [r, 1]));
}

async function refreshRuntimeStatus() {
    try {
        const data = await apiCall('/hotcoin/api/status');
        renderRuntimeStatus(data || {});
    } catch (e) {
        document.getElementById('runtimeMeta').textContent = `è¿è¡ŒçŠ¶æ€åŠ è½½å¤±è´¥: ${e.message}`;
    }
}

function fillCommonFields(cfg) {
    document.getElementById('logLevel').value = getByPath(cfg, ['log_level'], 'INFO');
    document.getElementById('dbPath').value = getByPath(cfg, ['db_path'], '');
    document.getElementById('initialCapital').value = getByPath(cfg, ['execution', 'initial_capital'], 1000);
    document.getElementById('maxConcurrent').value = getByPath(cfg, ['execution', 'max_concurrent_positions'], 5);
    document.getElementById('maxSinglePct').value = getByPath(cfg, ['execution', 'max_single_position_pct'], 0.10);
    document.getElementById('maxExposurePct').value = getByPath(cfg, ['execution', 'max_total_exposure_pct'], 0.40);
    document.getElementById('volSurgeRatio').value = getByPath(cfg, ['discovery', 'volume_surge_ratio'], 5.0);
    document.getElementById('priceSurge5m').value = getByPath(cfg, ['discovery', 'price_surge_5m_pct'], 0.03);
    document.getElementById('minQuoteVol24h').value = getByPath(cfg, ['discovery', 'min_quote_volume_24h'], 500000);
    document.getElementById('timeframes').value = (getByPath(cfg, ['trading', 'timeframes'], ['1m', '5m', '15m', '1h']) || []).join(',');
    document.getElementById('signalLoopSec').value = getByPath(cfg, ['trading', 'signal_loop_sec'], 10);
    document.getElementById('minConsensus').value = getByPath(cfg, ['trading', 'min_consensus_strength'], 20);
    document.getElementById('defaultSlPct').value = getByPath(cfg, ['trading', 'default_sl_pct'], -0.05);
    document.getElementById('trailingStopPct').value = getByPath(cfg, ['trading', 'trailing_stop_pct'], 0.03);
    document.getElementById('maxHoldMinutes').value = getByPath(cfg, ['trading', 'max_hold_minutes'], 240);
    document.getElementById('enableExecution').checked = !!getByPath(cfg, ['execution', 'enable_order_execution'], false);
    document.getElementById('usePaperTrading').checked = !!getByPath(cfg, ['execution', 'use_paper_trading'], true);
}

function patchCommonFields(cfg) {
    setByPath(cfg, ['log_level'], document.getElementById('logLevel').value.trim() || 'INFO');
    setByPath(cfg, ['db_path'], document.getElementById('dbPath').value.trim());

    setByPath(cfg, ['execution', 'initial_capital'], parseNumber(document.getElementById('initialCapital').value, 1000));
    setByPath(cfg, ['execution', 'max_concurrent_positions'], parseIntSafe(document.getElementById('maxConcurrent').value, 5));
    setByPath(cfg, ['execution', 'max_single_position_pct'], parseNumber(document.getElementById('maxSinglePct').value, 0.10));
    setByPath(cfg, ['execution', 'max_total_exposure_pct'], parseNumber(document.getElementById('maxExposurePct').value, 0.40));
    setByPath(cfg, ['execution', 'enable_order_execution'], document.getElementById('enableExecution').checked);
    setByPath(cfg, ['execution', 'use_paper_trading'], document.getElementById('usePaperTrading').checked);

    setByPath(cfg, ['discovery', 'volume_surge_ratio'], parseNumber(document.getElementById('volSurgeRatio').value, 5.0));
    setByPath(cfg, ['discovery', 'price_surge_5m_pct'], parseNumber(document.getElementById('priceSurge5m').value, 0.03));
    setByPath(cfg, ['discovery', 'min_quote_volume_24h'], parseNumber(document.getElementById('minQuoteVol24h').value, 500000));

    const tfList = document.getElementById('timeframes').value
        .split(',')
        .map(v => v.trim())
        .filter(Boolean);
    setByPath(cfg, ['trading', 'timeframes'], tfList.length ? tfList : ['1m', '5m', '15m', '1h']);
    setByPath(cfg, ['trading', 'signal_loop_sec'], parseNumber(document.getElementById('signalLoopSec').value, 10));
    setByPath(cfg, ['trading', 'min_consensus_strength'], parseIntSafe(document.getElementById('minConsensus').value, 20));
    setByPath(cfg, ['trading', 'default_sl_pct'], parseNumber(document.getElementById('defaultSlPct').value, -0.05));
    setByPath(cfg, ['trading', 'trailing_stop_pct'], parseNumber(document.getElementById('trailingStopPct').value, 0.03));
    setByPath(cfg, ['trading', 'max_hold_minutes'], parseIntSafe(document.getElementById('maxHoldMinutes').value, 240));
}

function getEditorConfig() {
    const text = document.getElementById('hotcoinConfigEditor').value.trim();
    if (!text) return {};
    return JSON.parse(text);
}

function setEditorConfig(cfg) {
    document.getElementById('hotcoinConfigEditor').value = JSON.stringify(cfg, null, 2);
}

function syncFormToEditor() {
    try {
        const cfg = getEditorConfig();
        patchCommonFields(cfg);
        setEditorConfig(cfg);
        setResult('å·²åŒæ­¥å¸¸ç”¨å‚æ•°åˆ° JSONã€‚');
    } catch (e) {
        setResult(`åŒæ­¥å¤±è´¥: ${e.message}`, false);
    }
}

async function loadHotcoinConfig() {
    try {
        const data = await apiCall('/api/live/hotcoin_config');
        _loadedConfig = data.config || {};
        _defaultConfig = data.default_config || {};
        fillCommonFields(_loadedConfig);
        setEditorConfig(_loadedConfig);
        setResult('çƒ­ç‚¹å¸é…ç½®åŠ è½½æˆåŠŸã€‚');
    } catch (e) {
        setResult(`åŠ è½½å¤±è´¥: ${e.message}`, false);
    }
}

function resetHotcoinDefault() {
    if (!_defaultConfig) {
        setResult('é»˜è®¤é…ç½®å°šæœªåŠ è½½ï¼Œè¯·å…ˆç‚¹å‡»â€œåŠ è½½â€ã€‚', false);
        return;
    }
    fillCommonFields(_defaultConfig);
    setEditorConfig(_defaultConfig);
    setResult('å·²æ¢å¤é»˜è®¤é…ç½®ã€‚');
}

async function saveHotcoinConfig() {
    try {
        const cfg = getEditorConfig();
        patchCommonFields(cfg);
        const data = await apiCall('/api/live/hotcoin_config', {
            method: 'POST',
            body: JSON.stringify(cfg),
        });
        const saved = data.config || cfg;
        _loadedConfig = saved;
        fillCommonFields(saved);
        setEditorConfig(saved);
        setResult('çƒ­ç‚¹å¸é…ç½®ä¿å­˜æˆåŠŸã€‚');
    } catch (e) {
        setResult(`ä¿å­˜å¤±è´¥: ${e.message}`, false);
    }
}

loadHotcoinConfig();
refreshPrecheckStats();
refreshRuntimeStatus();
if (_precheckTimer) clearInterval(_precheckTimer);
_precheckTimer = setInterval(() => {
    refreshPrecheckStats();
    refreshRuntimeStatus();
}, 15000);
</script>
{% endblock %}
