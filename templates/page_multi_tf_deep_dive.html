{% extends "base.html" %}
{% block title %}å¤šå‘¨æœŸè”åˆå†³ç­– Â· ç­–ç•¥ä¸ä»£ç è¯¦è§£{% endblock %}
{% block content %}
<h1 class="page-title">å¤šå‘¨æœŸè”åˆå†³ç­– Â· ç­–ç•¥ä¸ä»£ç è¯¦è§£</h1>
<p class="page-subtitle">ä»å•TFä¿¡å· â†’ åŠ æƒå…±è¯† â†’ å…±æŒ¯é“¾æ£€æµ‹ â†’ å¤§å‘¨æœŸå®šè°ƒ â†’ å®ç›˜é—¨æ§ï¼Œå®Œæ•´æ‹†è§£å¤šå‘¨æœŸè”åˆå†³ç­–ç³»ç»Ÿ</p>

<style>
.deep-toc { background: var(--bg-secondary); border-radius: 12px; padding: 24px; margin-bottom: 32px; }
.deep-toc h3 { margin: 0 0 16px; color: var(--accent-yellow); }
.deep-toc ol { margin: 0; padding-left: 20px; }
.deep-toc li { margin: 6px 0; }
.deep-toc a { color: var(--accent-blue); text-decoration: none; }
.deep-toc a:hover { text-decoration: underline; }

.section-title { font-size: 1.4em; font-weight: 700; margin: 40px 0 16px; padding-bottom: 8px; border-bottom: 2px solid var(--accent-blue); color: var(--text-primary); }
.section-title .num { color: var(--accent-yellow); margin-right: 8px; }
.subsection-title { font-size: 1.1em; font-weight: 600; color: var(--accent-blue); margin: 24px 0 12px; }

.code-block { background: #1a1b26; border-radius: 10px; padding: 20px; margin: 16px 0; overflow-x: auto; font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 0.85em; line-height: 1.6; color: #c0caf5; border: 1px solid #2a2b3d; }
.code-block .comment { color: #565f89; }
.code-block .keyword { color: #bb9af7; }
.code-block .string { color: #9ece6a; }
.code-block .number { color: #ff9e64; }
.code-block .func { color: #7aa2f7; }
.code-block .var { color: #73daca; }
.code-block .op { color: #89ddff; }
.code-block .highlight-line { background: rgba(74, 158, 255, 0.1); display: block; margin: 0 -20px; padding: 0 20px; border-left: 3px solid var(--accent-blue); }
.code-block .highlight-green { background: rgba(0, 214, 143, 0.1); display: block; margin: 0 -20px; padding: 0 20px; border-left: 3px solid var(--accent-green); }
.code-block .highlight-red { background: rgba(255, 77, 106, 0.1); display: block; margin: 0 -20px; padding: 0 20px; border-left: 3px solid var(--accent-red); }
.code-block .highlight-gold { background: rgba(255, 215, 0, 0.1); display: block; margin: 0 -20px; padding: 0 20px; border-left: 3px solid gold; }
.code-filename { background: #2a2b3d; display: inline-block; padding: 4px 14px; border-radius: 8px 8px 0 0; font-family: 'JetBrains Mono', monospace; font-size: 0.8em; color: #7aa2f7; margin-bottom: -1px; }

.explain-box { background: var(--bg-card); border-radius: 10px; padding: 20px; margin: 16px 0; border-left: 4px solid var(--accent-blue); }
.explain-box.warn { border-left-color: var(--accent-yellow); }
.explain-box.key { border-left-color: var(--accent-green); }
.explain-box.red { border-left-color: var(--accent-red); }
.explain-box h4 { margin: 0 0 8px; color: var(--text-primary); }
.explain-box p { margin: 4px 0; color: var(--text-secondary); line-height: 1.7; }

.flow-diagram { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: center; margin: 20px 0; }
.flow-box { background: var(--bg-card); border: 2px solid var(--border-subtle); border-radius: 10px; padding: 14px 18px; text-align: center; min-width: 130px; }
.flow-box.primary { border-color: var(--accent-blue); background: rgba(74,158,255,0.08); }
.flow-box.secondary { border-color: var(--accent-green); background: rgba(0,214,143,0.08); }
.flow-box.danger { border-color: var(--accent-red); background: rgba(255,77,106,0.08); }
.flow-box.gold { border-color: gold; background: rgba(255,215,0,0.08); }
.flow-box.purple { border-color: #bb9af7; background: rgba(187,154,247,0.08); }
.flow-box .label { font-size: 0.8em; color: var(--text-dim); }
.flow-box .value { font-weight: 700; font-size: 1.1em; margin-top: 4px; }
.flow-arrow { font-size: 1.5em; color: var(--text-dim); }

.param-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 0.9em; }
.param-table th, .param-table td { padding: 10px 14px; border: 1px solid var(--border-subtle); text-align: left; }
.param-table th { background: var(--bg-secondary); color: var(--text-primary); font-weight: 600; }
.param-table td { color: var(--text-secondary); }
.param-table tr:hover { background: var(--bg-hover); }
.param-table code { background: rgba(74,158,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; color: var(--accent-blue); }

.decision-card { background: var(--bg-card); border-radius: 12px; padding: 20px; margin: 12px 0; border: 1px solid var(--border-subtle); }
.decision-card h4 { margin: 0 0 8px; }
.decision-card .formula { background: #1a1b26; padding: 12px 16px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #73daca; margin: 8px 0; }
.decision-card p { color: var(--text-secondary); line-height: 1.7; }
.decision-card.strong { border-left: 4px solid #ff9e64; }
.decision-card.medium { border-left: 4px solid var(--accent-blue); }
.decision-card.weak { border-left: 4px solid var(--accent-yellow); }
.decision-card.block { border-left: 4px solid var(--accent-red); }

.arch-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin: 20px 0; }
.arch-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-subtle); }
.arch-card h4 { margin: 0 0 8px; color: var(--accent-blue); }
.arch-card .tag { display: inline-block; background: rgba(74,158,255,0.15); color: var(--accent-blue); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin: 2px 4px 2px 0; }
</style>

<!-- ç›®å½• -->
<div class="deep-toc">
    <h3>ğŸ“‹ ç›®å½•</h3>
    <ol>
        <li><a href="#s1">è®¾è®¡å“²å­¦: ä¸ºä»€ä¹ˆéœ€è¦å¤šå‘¨æœŸè”åˆå†³ç­–</a></li>
        <li><a href="#s2">ç³»ç»Ÿæ¶æ„: 5ä¸ªæ–‡ä»¶çš„åä½œå…³ç³»</a></li>
        <li><a href="#s3">å±‚1 â€” åŠ æƒå¾—åˆ†ç®—æ³•: å¤§å‘¨æœŸæƒé‡ç¢¾å‹å°å‘¨æœŸ</a></li>
        <li><a href="#s4">å±‚2 â€” å…±æŒ¯é“¾æ£€æµ‹: ç›¸é‚»TFè¿ç»­åŒå‘çš„é“¾æ¡</a></li>
        <li><a href="#s5">å±‚3 â€” å¤§å‘¨æœŸå®šè°ƒ: â‰¥4hçš„è¶‹åŠ¿åŸºè°ƒ</a></li>
        <li><a href="#s6">å†³ç­–çŸ©é˜µ: 6ç§æƒ…å†µçš„ç»¼åˆåˆ¤æ–­ (Aâ†’F)</a></li>
        <li><a href="#s7">å®ç›˜é—¨æ§: ä»ä¿¡å·åˆ°äº¤æ˜“çš„æœ€åä¸€å…³</a></li>
        <li><a href="#s8">ä»“ä½ç¼©æ”¾: å…±è¯†å¼ºåº¦é©±åŠ¨ä»“ä½å¤§å°</a></li>
        <li><a href="#s9">é…ç½®å‚æ•°: å¯è°ƒèŠ‚çš„å†³ç­–æ—‹é’®</a></li>
        <li><a href="#s10">å®‰å…¨è®¾è®¡: é™çº§æœºåˆ¶ä¸é£æ§ä¸å˜åŸåˆ™</a></li>
    </ol>
</div>

<!-- ==================== 1. è®¾è®¡å“²å­¦ ==================== -->
<div id="s1" class="section-title"><span class="num">1</span>è®¾è®¡å“²å­¦: ä¸ºä»€ä¹ˆéœ€è¦å¤šå‘¨æœŸè”åˆå†³ç­–</div>

<div class="explain-box key">
    <h4>æ ¸å¿ƒé—®é¢˜: å•TFä¿¡å·çš„å±€é™æ€§</h4>
    <p>ä¼ ç»Ÿç­–ç•¥åªçœ‹ä¸€ä¸ªæ—¶é—´æ¡†æ¶(å¦‚1h)ï¼Œä½†å¸‚åœºæ˜¯åˆ†å½¢çš„â€”â€”<strong>åŒä¸€æ—¶åˆ»</strong>ï¼Œ15åˆ†é’Ÿå›¾å¯èƒ½åœ¨ä¸Šæ¶¨ï¼Œè€Œ4å°æ—¶å›¾åœ¨ä¸‹è·Œã€‚å•TFç­–ç•¥æ— æ³•åŒºåˆ†"è¶‹åŠ¿ä¸­çš„å›è°ƒ"å’Œ"çœŸæ­£çš„åè½¬"ã€‚</p>
</div>

<div class="explain-box warn">
    <h4>è§£å†³æ–¹æ¡ˆ: ä¸‰å±‚åˆ¤æ–­ä½“ç³»</h4>
    <p>å¤šå‘¨æœŸè”åˆå†³ç­–ç³»ç»Ÿä»ä¸‰ä¸ªç»´åº¦è¯„ä¼°å¸‚åœºæ–¹å‘ï¼š</p>
    <p>1. <strong>åŠ æƒå¾—åˆ†</strong> â€” æŠŠæ‰€æœ‰TFçš„ä¿¡å·æ±‡æ€»ï¼Œå¤§å‘¨æœŸæƒé‡è¿œé«˜äºå°å‘¨æœŸ (24h=28 vs 15m=3)</p>
    <p>2. <strong>å…±æŒ¯é“¾æ£€æµ‹</strong> â€” ç›¸é‚»TFè¿ç»­åŒå‘(å¦‚15mâ†’30mâ†’1héƒ½çœ‹å¤š)è§†ä¸ºæ›´å¼ºç¡®è®¤</p>
    <p>3. <strong>å¤§å‘¨æœŸå®šè°ƒ</strong> â€” â‰¥4hçš„å‘¨æœŸä½œä¸ºè¶‹åŠ¿åŸºè°ƒï¼Œå°å‘¨æœŸä¸èƒ½é€†åŠ¿æ“ä½œ</p>
    <p>è¿™ç¡®ä¿äº†: <strong>åªæœ‰å½“å¤šä¸ªæ—¶é—´ç»´åº¦å½¢æˆå…±è¯†æ—¶ï¼Œæ‰å‘å‡ºäº¤æ˜“ä¿¡å·</strong>ã€‚</p>
</div>

<div class="explain-box">
    <h4>äº¤æ˜“å“²å­¦: ä¸åšæ¯”åšé”™æ›´é‡è¦</h4>
    <p>ç³»ç»Ÿçš„é»˜è®¤å€¾å‘æ˜¯<strong>ä¸äº¤æ˜“</strong>ã€‚åœ¨6ç§å†³ç­–æƒ…å†µä¸­ï¼Œåªæœ‰2ç§(æƒ…å†µAå’ŒB)ä¼šå‘å‡ºå¯æ“ä½œä¿¡å·ã€‚å…¶ä½™4ç§éƒ½ä¼šé˜»æ­¢äº¤æ˜“ã€‚è¿™æ„å‘³ç€å¤§éƒ¨åˆ†æ—¶é—´ç³»ç»Ÿåœ¨"ç­‰å¾…"â€”â€”ç­‰å¾…å¤§å°å‘¨æœŸå½¢æˆä¸€è‡´æ—¶æ‰å‡ºæ‰‹ã€‚</p>
</div>

<!-- ==================== 2. ç³»ç»Ÿæ¶æ„ ==================== -->
<div id="s2" class="section-title"><span class="num">2</span>ç³»ç»Ÿæ¶æ„: 5ä¸ªæ–‡ä»¶çš„åä½œå…³ç³»</div>

<div class="flow-diagram">
    <div class="flow-box primary"><div class="label">é…ç½®å±‚</div><div class="value">live_config.py</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box gold"><div class="label">ä¿¡å·å±‚</div><div class="value">live_signal<br>_generator.py</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box purple"><div class="label">å…±è¯†ç®—æ³•</div><div class="value">multi_tf<br>_consensus.py</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box secondary"><div class="label">äº¤æ˜“å¼•æ“</div><div class="value">live_trading<br>_engine.py</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box danger"><div class="label">CLIå…¥å£</div><div class="value">live_runner.py</div></div>
</div>

<div class="arch-grid">
    <div class="arch-card">
        <h4>ğŸ“„ multi_tf_consensus.py (å…±äº«æ¨¡å—)</h4>
        <p>å¤šå‘¨æœŸå…±è¯†ç®—æ³•çš„æ ¸å¿ƒï¼Œè¢«æ‰€æœ‰å…¶ä»–æ¨¡å—å¯¼å…¥ã€‚åŒ…å«:</p>
        <div class="tag">TF_WEIGHT æƒé‡è¡¨</div>
        <div class="tag">compute_weighted_consensus()</div>
        <div class="tag">_detect_resonance_chains()</div>
        <div class="tag">_compute_large_tf_signal()</div>
        <div class="tag">_make_decision()</div>
    </div>
    <div class="arch-card">
        <h4>ğŸ“„ live_signal_generator.py (ä¿¡å·ç”Ÿæˆ)</h4>
        <p>è´Ÿè´£ä»å¸å®‰è·å–Kçº¿æ•°æ®ï¼Œå¹¶è¡Œè®¡ç®—å¤šä¸ªTFçš„å…­ç»´ä¿¡å·:</p>
        <div class="tag">compute_multi_tf_signal(tf)</div>
        <div class="tag">compute_multi_tf_consensus(tfs)</div>
        <div class="tag">ThreadPoolExecutor å¹¶è¡Œ</div>
    </div>
    <div class="arch-card">
        <h4>ğŸ“„ live_trading_engine.py (äº¤æ˜“å¼•æ“)</h4>
        <p>æ ¸å¿ƒäº¤æ˜“å¾ªç¯ä¸­é›†æˆäº†å¤šå‘¨æœŸé—¨æ§:</p>
        <div class="tag">_apply_multi_tf_gate()</div>
        <div class="tag">ä»“ä½ç¼©æ”¾</div>
        <div class="tag">é™çº§æœºåˆ¶</div>
    </div>
    <div class="arch-card">
        <h4>ğŸ“„ live_config.py (é…ç½®)</h4>
        <p>å¤šå‘¨æœŸå†³ç­–çš„å¯è°ƒå‚æ•°:</p>
        <div class="tag">use_multi_tf</div>
        <div class="tag">decision_timeframes</div>
        <div class="tag">consensus_min_strength</div>
        <div class="tag">consensus_position_scale</div>
    </div>
</div>

<div class="explain-box">
    <h4>æ•°æ®æµ: ä»Kçº¿åˆ°äº¤æ˜“å†³ç­–</h4>
    <p>1. <strong>æ¯ä¸ªTick</strong>: ä¸»TF(å¦‚1h)æ”¶ç›˜æ—¶è§¦å‘ â†’ è®¡ç®—ä¸»TFçš„sell/buyåˆ†æ•°</p>
    <p>2. <strong>å•TFå†³ç­–</strong>: åŸºäºåˆ†æ•°å†³å®š OPEN_LONG / OPEN_SHORT / CLOSE / HOLD</p>
    <p>3. <strong>å¹³ä»“ç›´æ¥æ‰§è¡Œ</strong>: æ­¢æŸ/æ­¢ç›ˆ/è¿½è¸ªæ­¢ç›ˆä¸å—å¤šå‘¨æœŸå½±å“ (é£æ§ä¼˜å…ˆ)</p>
    <p>4. <strong>å¼€ä»“éœ€è¿‡é—¨æ§</strong>: å¦‚æœæ˜¯ OPEN_LONG/SHORT â†’ è°ƒç”¨å¤šå‘¨æœŸå…±è¯† â†’ 6ä¸ªTFå¹¶è¡Œè®¡ç®— â†’ ä¸‰å±‚åˆ¤æ–­ â†’ æ”¾è¡Œæˆ–é˜»æ­¢</p>
</div>

<!-- ==================== 3. åŠ æƒå¾—åˆ† ==================== -->
<div id="s3" class="section-title"><span class="num">3</span>å±‚1 â€” åŠ æƒå¾—åˆ†ç®—æ³•: å¤§å‘¨æœŸæƒé‡ç¢¾å‹å°å‘¨æœŸ</div>

<div class="explain-box key">
    <h4>æ ¸å¿ƒæ€æƒ³: å¤§å‘¨æœŸçš„æ„è§æ›´é‡è¦</h4>
    <p>ä¸€ä¸ª24hå›¾ä¸Šçš„å¤šå¤´ä¿¡å·ï¼Œåº”è¯¥æ¯”15åˆ†é’Ÿå›¾ä¸Šçš„å¤šå¤´ä¿¡å·æ›´æœ‰"å‘è¨€æƒ"ã€‚æƒé‡è®¾è®¡åæ˜ äº†è¿™ä¸ªç›´è§‰ï¼š24hæƒé‡28ï¼Œæ˜¯15mæƒé‡3çš„<strong>9.3å€</strong>ã€‚</p>
</div>

<table class="param-table">
    <tr>
        <th>æ—¶é—´æ¡†æ¶</th><th>æƒé‡</th><th>å½’ç±»</th><th>è¯´æ˜</th>
    </tr>
    <tr><td><code>1m</code> <code>3m</code> <code>5m</code></td><td>1</td><td>è¶…çŸ­çº¿</td><td>å™ªå£°æå¤§ï¼Œå‡ ä¹ä¸å‚ä¸å®ç›˜å†³ç­–</td></tr>
    <tr><td><code>10m</code></td><td>2</td><td>çŸ­çº¿</td><td>ç•¥æœ‰å‚è€ƒä»·å€¼</td></tr>
    <tr><td><code>15m</code></td><td>3</td><td>çŸ­çº¿</td><td>é»˜è®¤å†³ç­–TFä¸­æœ€å°çš„</td></tr>
    <tr><td><code>30m</code></td><td>5</td><td>ä¸­çŸ­çº¿</td><td>å¼€å§‹æœ‰è¶‹åŠ¿æ„ä¹‰</td></tr>
    <tr><td><code>1h</code></td><td>8</td><td>ä¸­çº¿</td><td>å¤šæ•°ç­–ç•¥çš„ä¸»å‘¨æœŸ</td></tr>
    <tr><td><code>2h</code></td><td>10</td><td>ä¸­çº¿</td><td></td></tr>
    <tr><td><code>4h</code></td><td>15</td><td>â­ å¤§å‘¨æœŸèµ·å§‹</td><td>â‰¥4hè§†ä¸ºå¤§å‘¨æœŸï¼Œæƒé‡è·ƒå‡</td></tr>
    <tr><td><code>8h</code></td><td>20</td><td>â­ å¤§å‘¨æœŸ</td><td>æ—¥å†…è¶‹åŠ¿çš„æ ¸å¿ƒ</td></tr>
    <tr><td><code>12h</code></td><td>22</td><td>â­ å¤§å‘¨æœŸ</td><td></td></tr>
    <tr><td><code>24h</code> <code>1d</code></td><td>28</td><td>â­ å¤§å‘¨æœŸ</td><td>æœ€é«˜æƒé‡ï¼Œè¶‹åŠ¿å®šè°ƒè€…</td></tr>
</table>

<div class="code-filename">multi_tf_consensus.py Â· åŠ æƒå¾—åˆ†è®¡ç®—</div>
<div class="code-block">
<span class="comment"># â”€â”€ 1. åŠ æƒå¾—åˆ† â”€â”€</span>
<span class="var">long_score</span>  = <span class="func">sum</span>(<span class="var">TF_WEIGHT</span>.get(tf, <span class="number">5</span>) <span class="keyword">for</span> tf <span class="keyword">in</span> long_tfs)
<span class="var">short_score</span> = <span class="func">sum</span>(<span class="var">TF_WEIGHT</span>.get(tf, <span class="number">5</span>) <span class="keyword">for</span> tf <span class="keyword">in</span> short_tfs)
<span class="var">total_weight</span> = <span class="func">sum</span>(<span class="var">TF_WEIGHT</span>.get(r[<span class="string">"tf"</span>], <span class="number">5</span>) <span class="keyword">for</span> r <span class="keyword">in</span> ok_results)

<span class="comment"># å½’ä¸€åŒ–åˆ° 0~100</span>
<span class="highlight-line"><span class="var">long_pct</span>  = <span class="func">round</span>(long_score / total_weight * <span class="number">100</span>, <span class="number">1</span>)</span>
<span class="highlight-line"><span class="var">short_pct</span> = <span class="func">round</span>(short_score / total_weight * <span class="number">100</span>, <span class="number">1</span>)</span>
<span class="highlight-line"><span class="var">net_score</span> = <span class="func">round</span>(long_pct - short_pct, <span class="number">1</span>)</span>
<span class="comment"># net_score > 0 åå¤š; < 0 åç©º; â‰ˆ0 ä¸­æ€§</span>
</div>

<div class="explain-box">
    <h4>ä¸¾ä¾‹: é»˜è®¤6ä¸ªå†³ç­–TFçš„æƒé‡åˆ†å¸ƒ</h4>
    <p>é»˜è®¤TFs: <code>15m(3) + 30m(5) + 1h(8) + 4h(15) + 8h(20) + 24h(28)</code> = æ€»æƒé‡ <strong>79</strong></p>
    <p>å‡è®¾ 15mçœ‹å¤š, 30mçœ‹å¤š, 1hçœ‹å¤š, 4hè§‚æœ›, 8hçœ‹ç©º, 24hçœ‹ç©º:</p>
    <p>â†’ å¤šå¤´æƒé‡ = 3+5+8 = <strong>16</strong> (20.3%)</p>
    <p>â†’ ç©ºå¤´æƒé‡ = 20+28 = <strong>48</strong> (60.8%)</p>
    <p>â†’ å‡€åˆ† = 20.3 - 60.8 = <strong>-40.5</strong> â†’ è™½ç„¶3ä¸ªTFçœ‹å¤šï¼Œä½†å‡€åˆ†ä¾ç„¶ä¸¥é‡åç©ºï¼Œå› ä¸º8hå’Œ24hæƒé‡å¤ªé«˜äº†ã€‚</p>
    <p><strong>è¿™å°±æ˜¯åŠ æƒçš„ä»·å€¼: 3ä¸ªå°å‘¨æœŸçœ‹å¤šæ— æ³•å¯¹æŠ—2ä¸ªå¤§å‘¨æœŸçœ‹ç©ºã€‚</strong></p>
</div>

<!-- ==================== 4. å…±æŒ¯é“¾ ==================== -->
<div id="s4" class="section-title"><span class="num">4</span>å±‚2 â€” å…±æŒ¯é“¾æ£€æµ‹: ç›¸é‚»TFè¿ç»­åŒå‘çš„é“¾æ¡</div>

<div class="explain-box key">
    <h4>ä»€ä¹ˆæ˜¯å…±æŒ¯é“¾?</h4>
    <p>å½“<strong>ç›¸é‚»çš„</strong>æ—¶é—´æ¡†æ¶è¿ç»­å‘å‡ºåŒæ–¹å‘ä¿¡å·æ—¶ï¼Œå½¢æˆ"å…±æŒ¯é“¾"ã€‚ä¾‹å¦‚ <code>1hâ†’4hâ†’8hâ†’24h</code> å…¨éƒ¨çœ‹å¤šï¼Œè¿™æ˜¯ä¸€æ¡<strong>4çº§åšå¤šå…±æŒ¯é“¾</strong>ï¼Œæƒé‡ = 8+15+20+28 = 71ã€‚</p>
    <p>å…±æŒ¯é“¾è¶Šé•¿ã€åŒ…å«çš„å¤§å‘¨æœŸè¶Šå¤šï¼Œä¿¡å·è¶Šå¯é ã€‚ç®—æ³•å…è®¸<strong>1ä¸ªholdé—´éš”</strong>ä¸æ‰“æ–­é“¾æ¡ï¼ˆå¦‚ 15må¤šâ†’30mè§‚æœ›â†’1hå¤š ä»ç®—è¿ç»­ï¼‰ã€‚</p>
</div>

<div class="code-filename">multi_tf_consensus.py Â· _detect_resonance_chains()</div>
<div class="code-block">
<span class="keyword">for</span> target_dir <span class="keyword">in</span> [<span class="string">"long"</span>, <span class="string">"short"</span>]:
    chain = []
    gap_count = <span class="number">0</span>
    <span class="keyword">for</span> d, tf <span class="keyword">in</span> directions:
        <span class="keyword">if</span> d == target_dir:
<span class="highlight-green">            chain.append(tf)        <span class="comment"># åŒå‘: åŠ å…¥é“¾</span></span>
            gap_count = <span class="number">0</span>
<span class="highlight-line">        <span class="keyword">elif</span> d == <span class="string">"hold"</span> <span class="keyword">and</span> chain <span class="keyword">and</span> gap_count == <span class="number">0</span>:</span>
<span class="highlight-line">            gap_count += <span class="number">1</span>          <span class="comment"># å…è®¸1ä¸ªholdé—´éš”</span></span>
<span class="highlight-line">            <span class="keyword">continue</span></span>
        <span class="keyword">else</span>:
            <span class="keyword">if</span> <span class="func">len</span>(chain) >= <span class="number">2</span>:
<span class="highlight-gold">                has_4h = <span class="func">any</span>(TF_MINUTES.get(t,<span class="number">0</span>) >= <span class="number">240</span> <span class="keyword">for</span> t <span class="keyword">in</span> chain)</span>
                resonance_chains.append({
                    <span class="string">"direction"</span>: target_dir,
                    <span class="string">"chain"</span>: chain,
                    <span class="string">"length"</span>: <span class="func">len</span>(chain),
                    <span class="string">"has_4h_plus"</span>: has_4h,   <span class="comment"># æ˜¯å¦åŒ…å«å¤§å‘¨æœŸ</span>
                    <span class="string">"weight"</span>: <span class="func">sum</span>(TF_WEIGHT.get(t,<span class="number">5</span>) <span class="keyword">for</span> t <span class="keyword">in</span> chain),
                })
            chain = []              <span class="comment"># é“¾æ–­è£‚ï¼Œé‡ç½®</span>
</div>

<div class="explain-box warn">
    <h4>å…±æŒ¯é“¾çš„å…³é”®åˆ¤æ–­æ ‡å‡†</h4>
    <p>1. <strong>é•¿åº¦ â‰¥ 2</strong>: è‡³å°‘2ä¸ªç›¸é‚»TFåŒå‘æ‰ç®—é“¾</p>
    <p>2. <strong>has_4h_plus</strong>: é“¾ä¸­æ˜¯å¦åŒ…å«â‰¥4hçš„å¤§å‘¨æœŸ (è¿™å¾ˆå…³é”®ï¼Œå†³ç­–çŸ©é˜µä¸­ä¼šç”¨åˆ°)</p>
    <p>3. <strong>æƒé‡</strong>: é“¾ä¸­æ‰€æœ‰TFæƒé‡ä¹‹å’Œï¼Œç”¨äºåœ¨å¤šæ¡é“¾ä¸­é€‰æœ€å¼ºçš„</p>
    <p>4. <strong>å…è®¸1ä¸ªholdé—´éš”</strong>: æ¨¡ç³Šå®¹é”™ï¼Œé¿å…ä¸€ä¸ªè§‚æœ›TFå°±æ‰“æ–­æ•´æ¡é“¾</p>
</div>

<!-- ==================== 5. å¤§å‘¨æœŸå®šè°ƒ ==================== -->
<div id="s5" class="section-title"><span class="num">5</span>å±‚3 â€” å¤§å‘¨æœŸå®šè°ƒ: â‰¥4hçš„è¶‹åŠ¿åŸºè°ƒ</div>

<div class="explain-box key">
    <h4>å¤§å‘¨æœŸ = è¶‹åŠ¿æ–¹å‘çš„"è£åˆ¤"</h4>
    <p>â‰¥4hçš„TF(4h/8h/12h/24h)è¢«è§†ä¸ºå¤§å‘¨æœŸã€‚å®ƒä»¬çš„æ–¹å‘å†³å®šäº†å¸‚åœºçš„<strong>è¶‹åŠ¿åŸºè°ƒ</strong>â€”â€”å°å‘¨æœŸä¿¡å·å¦‚æœä¸å¤§å‘¨æœŸæ–¹å‘ç›¸åï¼Œè¢«è§†ä¸º"å™ªå£°"æˆ–"å›è°ƒ"ï¼Œä¸åº”äº¤æ˜“ã€‚</p>
</div>

<div class="code-filename">multi_tf_consensus.py Â· _compute_large_tf_signal()</div>
<div class="code-block">
<span class="keyword">def</span> <span class="func">_compute_large_tf_signal</span>(ok_results):
    large_long  = [r[<span class="string">"tf"</span>] <span class="keyword">for</span> r <span class="keyword">in</span> ok_results
                   <span class="keyword">if</span> <span class="string">"LONG"</span> <span class="keyword">in</span> r.get(<span class="string">"action"</span>,<span class="string">""</span>) <span class="keyword">and</span> TF_MINUTES[r[<span class="string">"tf"</span>]] >= <span class="number">240</span>]
    large_short = [r[<span class="string">"tf"</span>] <span class="keyword">for</span> r <span class="keyword">in</span> ok_results
                   <span class="keyword">if</span> <span class="string">"SHORT"</span> <span class="keyword">in</span> r.get(<span class="string">"action"</span>,<span class="string">""</span>) <span class="keyword">and</span> TF_MINUTES[r[<span class="string">"tf"</span>]] >= <span class="number">240</span>]

<span class="highlight-green">    <span class="keyword">if</span> large_long <span class="keyword">and not</span> large_short:              <span class="comment"># å¤§å‘¨æœŸä¸€è‡´çœ‹å¤š</span></span>
        <span class="keyword">return</span> {<span class="string">"direction"</span>: <span class="string">"long"</span>, <span class="string">"tfs"</span>: large_long}
<span class="highlight-red">    <span class="keyword">elif</span> large_short <span class="keyword">and not</span> large_long:            <span class="comment"># å¤§å‘¨æœŸä¸€è‡´çœ‹ç©º</span></span>
        <span class="keyword">return</span> {<span class="string">"direction"</span>: <span class="string">"short"</span>, <span class="string">"tfs"</span>: large_short}
    <span class="keyword">elif</span> large_long <span class="keyword">and</span> large_short:                <span class="comment"># å¤§å‘¨æœŸè‡ªèº«å†²çª</span>
        <span class="keyword">return</span> {<span class="string">"direction"</span>: <span class="string">"conflict"</span>, ...}
    <span class="keyword">else</span>:                                           <span class="comment"># å¤§å‘¨æœŸå…¨éƒ¨è§‚æœ›</span>
        <span class="keyword">return</span> {<span class="string">"direction"</span>: <span class="string">"neutral"</span>, ...}
</div>

<div class="explain-box">
    <h4>4ç§å¤§å‘¨æœŸçŠ¶æ€</h4>
    <p>1. <strong>long</strong> â€” æ‰€æœ‰å¤§å‘¨æœŸTFçœ‹å¤š(å¦‚ 4hå¤š+8hå¤š+24hå¤š) â†’ å…è®¸åšå¤š</p>
    <p>2. <strong>short</strong> â€” æ‰€æœ‰å¤§å‘¨æœŸTFçœ‹ç©º â†’ å…è®¸åšç©º</p>
    <p>3. <strong>conflict</strong> â€” å¤§å‘¨æœŸå†…éƒ¨åˆ†æ­§(å¦‚ 4hå¤šä½†24hç©º) â†’ è§‚æœ›</p>
    <p>4. <strong>neutral</strong> â€” å¤§å‘¨æœŸå…¨éƒ¨HOLD â†’ æ— è¶‹åŠ¿åŸºè°ƒï¼Œå°å‘¨æœŸä¿¡å·åªèƒ½ä½œä¸ºå¼±ä¿¡å·</p>
</div>

<!-- ==================== 6. å†³ç­–çŸ©é˜µ ==================== -->
<div id="s6" class="section-title"><span class="num">6</span>å†³ç­–çŸ©é˜µ: 6ç§æƒ…å†µçš„ç»¼åˆåˆ¤æ–­ (Aâ†’F)</div>

<div class="explain-box key">
    <h4>å†³ç­–ä¼˜å…ˆçº§: A > B > C > D > E > F</h4>
    <p>ç³»ç»ŸæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ£€æŸ¥6ç§æƒ…å†µã€‚å‘½ä¸­ç¬¬ä¸€ä¸ªå°±è¿”å›ï¼Œä¸å†ç»§ç»­æ£€æŸ¥ã€‚<strong>åªæœ‰æƒ…å†µAå’ŒBä¼šè¾“å‡º actionable=True</strong>ï¼Œå…¶ä½™éƒ½ä¼šé˜»æ­¢äº¤æ˜“ã€‚</p>
</div>

<div class="decision-card strong">
    <h4>ğŸ”¥ æƒ…å†µA: å¼ºä¿¡å· â€” å¤§å°åŒå‘ + å…±æŒ¯é“¾ (strength 70-100)</h4>
    <div class="formula">æ¡ä»¶: å…±æŒ¯é“¾â‰¥3çº§ && åŒ…å«â‰¥4hå‘¨æœŸ && å¤§å‘¨æœŸæ–¹å‘ä¸€è‡´ && |å‡€åˆ†|>15</div>
    <p>è¿™æ˜¯æœ€é«˜çº§åˆ«ä¿¡å·ã€‚å¤šä¸ªæ—¶é—´ç»´åº¦å½¢æˆå®Œç¾å…±è¯†ï¼Œä¸”æœ‰â‰¥3çº§è¿ç»­å…±æŒ¯é“¾è·¨è¶Šå¤§å°å‘¨æœŸã€‚</p>
    <p><strong>ä¸¾ä¾‹</strong>: 30mâ†’1hâ†’4hâ†’8h è¿ç»­çœ‹å¤šï¼Œ24hä¹Ÿçœ‹å¤šï¼Œå‡€åˆ†+65 â†’ ğŸ”¥ å¼ºåšå¤šå…±æŒ¯ strength=89</p>

    <div class="formula">strength = min(100, 50 + chain_weight * 0.5 + |net| * 0.3)</div>
</div>

<div class="decision-card medium">
    <h4>ğŸ“ˆ æƒ…å†µB: ä¸­ç­‰ä¿¡å· â€” å¤§å‘¨æœŸæ˜ç¡® + å°å‘¨æœŸç¡®è®¤ (strength 40-80)</h4>
    <div class="formula">æ¡ä»¶: å¤§å‘¨æœŸæ–¹å‘æ˜ç¡®(long/short) && å°å‘¨æœŸåŒå‘ && å°å‘¨æœŸæ— åå‘</div>
    <p>å¤§å‘¨æœŸå®šäº†æ–¹å‘ï¼Œå°å‘¨æœŸä¹Ÿç¡®è®¤äº†ã€‚è™½ç„¶ä¸ä¸€å®šæœ‰å…±æŒ¯é“¾ï¼Œä½†æ–¹å‘ä¸€è‡´ã€‚</p>
    <p><strong>ä¸¾ä¾‹</strong>: 4h+8hçœ‹ç©ºï¼Œ15m+1hä¹Ÿçœ‹ç©º â†’ ğŸ“‰ å¤§å‘¨æœŸçœ‹ç©º+å°å‘¨æœŸç¡®è®¤ strength=55</p>

    <div class="formula">strength = min(80, 40 + |net| * 0.5)</div>
</div>

<div class="decision-card block">
    <h4>â›” æƒ…å†µC: å¤§å°å‘¨æœŸåå‘ â€” ä¸åš (strength 0-10)</h4>
    <div class="formula">æ¡ä»¶: å¤§å‘¨æœŸçœ‹å¤š && å°å‘¨æœŸåªçœ‹ç©º (æˆ–åè¿‡æ¥)</div>
    <p><strong>æ ¸å¿ƒåŸåˆ™: ä¸é€†å¤§åŠ¿</strong>ã€‚å¤§å‘¨æœŸçœ‹å¤šä½†å°å‘¨æœŸçœ‹ç©ºï¼Œè¯´æ˜å¯èƒ½æ˜¯è¶‹åŠ¿ä¸­çš„æ­£å¸¸å›è°ƒã€‚æ­£ç¡®åšæ³•æ˜¯ç­‰å›è°ƒç»“æŸåé¡ºåŠ¿åšå¤šï¼Œè€Œä¸æ˜¯é€†åŠ¿åšç©ºã€‚</p>
    <p><strong>ä¸¾ä¾‹</strong>: 4h+8h+24hçœ‹å¤šï¼Œä½†15m+30m+1hçœ‹ç©º â†’ â›” å¯èƒ½æ˜¯å›è°ƒ, ç­‰å°å‘¨æœŸè½¬å‘åå†é¡ºåŠ¿åšå¤š</p>
</div>

<div class="decision-card block">
    <h4>âš ï¸ æƒ…å†µD: å¤šç©ºåˆ†æ­§ â€” è§‚æœ› (strength 0-15)</h4>
    <div class="formula">æ¡ä»¶: åŒæ—¶å­˜åœ¨çœ‹å¤šTFå’Œçœ‹ç©ºTF (ä¸è®ºå¤§å°)</div>
    <p>å¸‚åœºæ–¹å‘ä¸æ˜ç¡®ï¼Œå¤šç©ºåŠ›é‡äº¤ç»‡ã€‚æ­¤æ—¶äº¤æ˜“ç­‰äºèµŒåšï¼Œç³»ç»Ÿé€‰æ‹©è§‚æœ›ã€‚</p>
</div>

<div class="decision-card weak">
    <h4>ğŸ“Š æƒ…å†µE: å¼±ä¿¡å· â€” åªæœ‰å°å‘¨æœŸçœ‹å¤š/ç©º (strength 10-40)</h4>
    <div class="formula">æ¡ä»¶: å°å‘¨æœŸæœ‰æ–¹å‘ && å¤§å‘¨æœŸä¸­æ€§(neutral)</div>
    <p>å¤§å‘¨æœŸæ²¡æœ‰ç»™å‡ºæ–¹å‘ï¼Œåªæœ‰å°å‘¨æœŸæœ‰ä¿¡å·ã€‚å¯èƒ½æ˜¯è¶‹åŠ¿æ­£åœ¨å½¢æˆçš„æ—©æœŸé˜¶æ®µï¼Œä¹Ÿå¯èƒ½åªæ˜¯å™ªå£°ã€‚ç³»ç»Ÿæ ‡è®°ä¸ºå¼±ä¿¡å·ï¼Œ<strong>ä¸å…è®¸å¼€ä»“</strong>(actionable=False)ã€‚</p>
    <p>å¦‚æœæœ‰å…±æŒ¯é“¾åŠ æˆï¼Œå¼ºåº¦ä¼šç•¥é«˜ï¼Œä½†ä»ä¸è¶³ä»¥è§¦å‘äº¤æ˜“ã€‚</p>
</div>

<div class="decision-card">
    <h4>âšª æƒ…å†µF: å®Œå…¨ä¸­æ€§ â€” æ— ä¿¡å· (strength 0)</h4>
    <div class="formula">æ¡ä»¶: æ‰€æœ‰TFéƒ½æ˜¯HOLD</div>
    <p>å¸‚åœºå®Œå…¨æ²¡æœ‰æ–¹å‘ã€‚è€å¿ƒç­‰å¾…ã€‚</p>
</div>

<div class="code-filename">multi_tf_consensus.py Â· _make_decision() æ ¸å¿ƒé€»è¾‘</div>
<div class="code-block">
<span class="keyword">def</span> <span class="func">_make_decision</span>(ws, best_chain, large_sig, ...):
    net = ws[<span class="string">"net"</span>]
    large_dir = large_sig[<span class="string">"direction"</span>]

<span class="highlight-gold">    <span class="comment"># A: å¤§å°åŒå‘ + å…±æŒ¯é“¾(â‰¥3çº§,å«4h+) â†’ å¼ºä¿¡å·</span></span>
    <span class="keyword">if</span> best_chain <span class="keyword">and</span> best_chain[<span class="string">"has_4h_plus"</span>] <span class="keyword">and</span> best_chain[<span class="string">"length"</span>] >= <span class="number">3</span>:
        ...  <span class="comment"># actionable=True, strength 70-100</span>

<span class="highlight-green">    <span class="comment"># B: å¤§å‘¨æœŸæ˜ç¡® + å°å‘¨æœŸåŒå‘ â†’ ä¸­ç­‰ä¿¡å·</span></span>
    <span class="keyword">if</span> large_dir == <span class="string">"long"</span> <span class="keyword">and</span> small_long <span class="keyword">and not</span> small_short:
        ...  <span class="comment"># actionable=True, strength 40-80</span>

<span class="highlight-red">    <span class="comment"># C: å¤§å°å‘¨æœŸåå‘ â†’ ä¸åš</span></span>
    <span class="keyword">if</span> large_dir == <span class="string">"long"</span> <span class="keyword">and</span> small_short <span class="keyword">and not</span> small_long:
        ...  <span class="comment"># actionable=False, "ç­‰å›è°ƒç»“æŸé¡ºåŠ¿"</span>

    <span class="comment"># D: å¤šç©ºåŒæ—¶å­˜åœ¨ â†’ è§‚æœ›</span>
    <span class="keyword">if</span> long_tfs <span class="keyword">and</span> short_tfs:
        ...  <span class="comment"># actionable=False</span>

    <span class="comment"># E: åªæœ‰å°å‘¨æœŸä¿¡å· â†’ å¼±ä¿¡å·</span>
    <span class="keyword">if</span> small_long <span class="keyword">and</span> large_dir == <span class="string">"neutral"</span>:
        ...  <span class="comment"># actionable=False</span>

    <span class="comment"># F: å®Œå…¨ä¸­æ€§</span>
    <span class="keyword">return</span> {<span class="string">"direction"</span>: <span class="string">"hold"</span>, <span class="string">"strength"</span>: <span class="number">0</span>, <span class="string">"actionable"</span>: <span class="keyword">False</span>}
</div>

<!-- ==================== 7. å®ç›˜é—¨æ§ ==================== -->
<div id="s7" class="section-title"><span class="num">7</span>å®ç›˜é—¨æ§: ä»ä¿¡å·åˆ°äº¤æ˜“çš„æœ€åä¸€å…³</div>

<div class="explain-box key">
    <h4>é—¨æ§è®¾è®¡: å¹³ä»“ä¸æ‹¦ï¼Œå¼€ä»“å¿…æŸ¥</h4>
    <p>å¤šå‘¨æœŸå…±è¯†<strong>ä»…ä½œä¸ºå¼€ä»“é—¨æ§</strong>ã€‚å¹³ä»“é€»è¾‘(æ­¢æŸ/æ­¢ç›ˆ/è¿½è¸ªæ­¢ç›ˆ/è¶…æ—¶)å®Œå…¨ç‹¬ç«‹ï¼Œç”±ä¸»TFçš„ä¿¡å·å’ŒæŒä»“çŠ¶æ€é©±åŠ¨ã€‚è¿™ç¡®ä¿äº†: å³ä½¿å¤šå‘¨æœŸç³»ç»Ÿå‡ºæ•…éšœï¼Œé£æ§ä»ç„¶100%æ­£å¸¸å·¥ä½œã€‚</p>
</div>

<div class="flow-diagram">
    <div class="flow-box primary"><div class="label">ä¸»TFä¿¡å·</div><div class="value">sell/buyåˆ†æ•°</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box gold"><div class="label">evaluate_action</div><div class="value">OPEN/CLOSE/HOLD</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box"><div class="label">åˆ†æµ</div><div class="value">CLOSE?</div></div>
    <div class="flow-arrow" style="color: var(--accent-green)">â†’ ç›´æ¥æ‰§è¡Œ</div>
</div>
<div class="flow-diagram">
    <div class="flow-box" style="visibility:hidden"><div class="value">.</div></div>
    <div class="flow-arrow" style="visibility:hidden">â†’</div>
    <div class="flow-box" style="visibility:hidden"><div class="value">.</div></div>
    <div class="flow-arrow" style="visibility:hidden">â†’</div>
    <div class="flow-box"><div class="label">åˆ†æµ</div><div class="value">OPEN?</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box purple"><div class="label">å¤šå‘¨æœŸé—¨æ§</div><div class="value">_apply_multi_tf_gate</div></div>
    <div class="flow-arrow">â†’</div>
    <div class="flow-box secondary"><div class="label">âœ… é€šè¿‡</div><div class="value">æ‰§è¡Œå¼€ä»“</div></div>
</div>

<div class="code-filename">live_trading_engine.py Â· _apply_multi_tf_gate()</div>
<div class="code-block">
<span class="keyword">def</span> <span class="func">_apply_multi_tf_gate</span>(self, sig):
    <span class="comment"># 1. å¹¶è¡Œè®¡ç®—6ä¸ªTFçš„ä¿¡å· + å…±è¯†å†³ç­–</span>
    multi_result = self.signal_generator.<span class="func">compute_multi_tf_consensus</span>(
        self._decision_tfs  <span class="comment"># ['15m','30m','1h','4h','8h','24h']</span>
    )

    direction = decision.get(<span class="string">"direction"</span>)
    strength  = decision.get(<span class="string">"strength"</span>)
    actionable = decision.get(<span class="string">"actionable"</span>)

    sig_direction = <span class="string">"long"</span> <span class="keyword">if</span> sig.action == <span class="string">"OPEN_LONG"</span> <span class="keyword">else</span> <span class="string">"short"</span>

<span class="highlight-red">    <span class="comment"># è§„åˆ™1: å…±è¯†ä¸å¯æ“ä½œ(æƒ…å†µC/D/E/F) â†’ é˜»æ­¢</span></span>
<span class="highlight-red">    <span class="keyword">if not</span> actionable:</span>
<span class="highlight-red">        sig.action = <span class="string">"HOLD"</span></span>
<span class="highlight-red">        <span class="keyword">return</span> sig</span>

<span class="highlight-red">    <span class="comment"># è§„åˆ™2: å…±è¯†æ–¹å‘ä¸å•TFæ–¹å‘ä¸ä¸€è‡´ â†’ é˜»æ­¢</span></span>
<span class="highlight-red">    <span class="keyword">if</span> direction != sig_direction:</span>
<span class="highlight-red">        sig.action = <span class="string">"HOLD"</span></span>
<span class="highlight-red">        <span class="keyword">return</span> sig</span>

<span class="highlight-red">    <span class="comment"># è§„åˆ™3: å…±è¯†å¼ºåº¦ä¸å¤Ÿ â†’ é˜»æ­¢</span></span>
<span class="highlight-red">    <span class="keyword">if</span> strength < self._consensus_min_strength:</span>
<span class="highlight-red">        sig.action = <span class="string">"HOLD"</span></span>
<span class="highlight-red">        <span class="keyword">return</span> sig</span>

<span class="highlight-green">    <span class="comment"># âœ… å…¨éƒ¨é€šè¿‡ â†’ æ”¾è¡Œå¼€ä»“</span></span>
<span class="highlight-green">    sig.reason += <span class="string">f" | å¤šå‘¨æœŸç¡®è®¤ strength={strength}"</span></span>
<span class="highlight-green">    <span class="keyword">return</span> sig</span>
</div>

<div class="explain-box warn">
    <h4>ä¸‰é‡é—¨æ§: å¿…é¡»å…¨éƒ¨é€šè¿‡</h4>
    <p>1. <strong>actionable = True</strong> â€” å…±è¯†å†³ç­–æ ‡è®°ä¸ºå¯æ“ä½œ (ä»…æƒ…å†µAå’ŒB)</p>
    <p>2. <strong>æ–¹å‘ä¸€è‡´</strong> â€” å…±è¯†æ–¹å‘å¿…é¡»ä¸å•TFä¿¡å·æ–¹å‘ç›¸åŒ</p>
    <p>3. <strong>strength â‰¥ 40</strong> â€” å…±è¯†å¼ºåº¦å¿…é¡»è¾¾åˆ°æœ€ä½é˜ˆå€¼</p>
    <p>ä¸‰ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯ã€‚ä»»ä½•ä¸€ä¸ªä¸æ»¡è¶³ï¼Œå¼€ä»“ä¿¡å·éƒ½ä¼šè¢«é™çº§ä¸ºHOLDã€‚</p>
</div>

<!-- ==================== 8. ä»“ä½ç¼©æ”¾ ==================== -->
<div id="s8" class="section-title"><span class="num">8</span>ä»“ä½ç¼©æ”¾: å…±è¯†å¼ºåº¦é©±åŠ¨ä»“ä½å¤§å°</div>

<div class="explain-box key">
    <h4>å¼ºå…±è¯† = å¤§ä»“ä½ï¼Œå¼±å…±è¯† = å°ä»“ä½</h4>
    <p>å½“å¤šå‘¨æœŸå…±è¯†é€šè¿‡é—¨æ§åï¼Œä»“ä½å¤§å°ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯<strong>æŒ‰å…±è¯†å¼ºåº¦ç¼©æ”¾</strong>:</p>
    <p><code>ä»“ä½æ¯”ä¾‹ = max(50%, min(100%, strength / 100))</code></p>
    <p>strength=40(æœ€ä½é—¨æ§›) â†’ ä»“ä½50% | strength=70 â†’ ä»“ä½70% | strength=100 â†’ ä»“ä½100%</p>
</div>

<div class="code-filename">live_trading_engine.py Â· _open_position() ä»“ä½ç¼©æ”¾</div>
<div class="code-block">
<span class="comment"># åŸºç¡€ä¿è¯é‡‘</span>
raw_margin = equity * cfg.margin_use * cfg.single_pct

<span class="comment"># å¤šå‘¨æœŸå…±è¯†å¼ºåº¦ç¼©æ”¾ä»“ä½</span>
<span class="keyword">if</span> self._use_multi_tf <span class="keyword">and</span> self._consensus_position_scale:
    consensus_strength = self._last_consensus \
        .get(<span class="string">"consensus"</span>, {}).get(<span class="string">"decision"</span>, {}).get(<span class="string">"strength"</span>, <span class="number">50</span>)

<span class="highlight-line">    <span class="comment"># strength 40-100 æ˜ å°„åˆ° 0.5-1.0 çš„ä»“ä½æ¯”ä¾‹</span></span>
<span class="highlight-line">    scale = <span class="func">max</span>(<span class="number">0.5</span>, <span class="func">min</span>(<span class="number">1.0</span>, consensus_strength / <span class="number">100</span>))</span>
<span class="highlight-line">    raw_margin *= scale</span>
</div>

<div class="explain-box">
    <h4>è®¾è®¡æ„å›¾</h4>
    <p>1. <strong>å¼ºä¿¡å·å¤šä¸‹æ³¨</strong>: å¤§å°å‘¨æœŸå®Œç¾å…±æŒ¯(strength=90) â†’ ç”¨90%ä»“ä½</p>
    <p>2. <strong>å¼±ä¿¡å·å°‘ä¸‹æ³¨</strong>: åˆšè¿‡é—¨æ§›(strength=42) â†’ åªç”¨50%ä»“ä½</p>
    <p>3. <strong>æœ€ä½50%ä¿åº•</strong>: æ—¢ç„¶å·²ç»é€šè¿‡äº†ä¸‰é‡é—¨æ§ï¼Œè‡³å°‘ç”¨ä¸€åŠä»“ä½</p>
    <p>4. <strong>å¯å…³é—­</strong>: è®¾ç½® <code>consensus_position_scale: false</code> åˆ™å›ºå®šä»“ä½</p>
</div>

<!-- ==================== 9. é…ç½®å‚æ•° ==================== -->
<div id="s9" class="section-title"><span class="num">9</span>é…ç½®å‚æ•°: å¯è°ƒèŠ‚çš„å†³ç­–æ—‹é’®</div>

<table class="param-table">
    <tr>
        <th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th>
    </tr>
    <tr>
        <td><code>use_multi_tf</code></td>
        <td>bool</td>
        <td><code>True</code></td>
        <td>æ€»å¼€å…³ã€‚è®¾ä¸º False å¯ä¸€é”®å›é€€åˆ°å•TFæ¨¡å¼</td>
    </tr>
    <tr>
        <td><code>decision_timeframes</code></td>
        <td>list</td>
        <td><code>['15m','30m','1h','4h','8h','24h']</code></td>
        <td>å‚ä¸å…±è¯†å†³ç­–çš„æ—¶é—´æ¡†æ¶åˆ—è¡¨ã€‚å»ºè®®è¦†ç›–å¤§å°å‘¨æœŸ</td>
    </tr>
    <tr>
        <td><code>consensus_min_strength</code></td>
        <td>int</td>
        <td><code>40</code></td>
        <td>å…±è¯†å¼ºåº¦æœ€ä½é˜ˆå€¼ã€‚æé«˜æ­¤å€¼ä¼šå‡å°‘äº¤æ˜“æ¬¡æ•°ä½†æé«˜ç²¾åº¦</td>
    </tr>
    <tr>
        <td><code>consensus_position_scale</code></td>
        <td>bool</td>
        <td><code>True</code></td>
        <td>æ˜¯å¦æŒ‰å…±è¯†å¼ºåº¦ç¼©æ”¾ä»“ä½ã€‚å…³é—­åˆ™å›ºå®šä»“ä½</td>
    </tr>
</table>

<div class="code-filename">live_trading_config.json Â· ç­–ç•¥é…ç½®ç¤ºä¾‹</div>
<div class="code-block">
{
    <span class="string">"strategy"</span>: {
        <span class="string">"optimize_result_file"</span>: <span class="string">"optimize_six_book_result.json"</span>,
        <span class="string">"symbol"</span>: <span class="string">"ETHUSDT"</span>,
        <span class="string">"timeframe"</span>: <span class="string">"1h"</span>,
<span class="highlight-line">        <span class="string">"use_multi_tf"</span>: <span class="keyword">true</span>,</span>
<span class="highlight-line">        <span class="string">"decision_timeframes"</span>: [<span class="string">"15m"</span>, <span class="string">"30m"</span>, <span class="string">"1h"</span>, <span class="string">"4h"</span>, <span class="string">"8h"</span>, <span class="string">"24h"</span>],</span>
<span class="highlight-line">        <span class="string">"consensus_min_strength"</span>: <span class="number">40</span></span>
    }
}
</div>

<div class="explain-box warn">
    <h4>è°ƒå‚å»ºè®®</h4>
    <p>1. <strong>æ›´ä¿å®ˆ</strong>: æé«˜ consensus_min_strength åˆ° 60, å‡å°‘TFåˆ—è¡¨ä¸­çš„å°å‘¨æœŸ â†’ æ›´å°‘äº¤æ˜“ä½†æ›´ç²¾å‡†</p>
    <p>2. <strong>æ›´æ¿€è¿›</strong>: é™ä½ consensus_min_strength åˆ° 30, å¢åŠ æ›´å¤šå°å‘¨æœŸTF â†’ æ›´å¤šäº¤æ˜“æœºä¼š</p>
    <p>3. <strong>è°ƒè¯•æ¨¡å¼</strong>: use_multi_tf=False å¯å¿«é€Ÿå›é€€ï¼Œå¯¹æ¯”å•TFä¸å¤šTFçš„æ•ˆæœå·®å¼‚</p>
</div>

<!-- ==================== 10. å®‰å…¨è®¾è®¡ ==================== -->
<div id="s10" class="section-title"><span class="num">10</span>å®‰å…¨è®¾è®¡: é™çº§æœºåˆ¶ä¸é£æ§ä¸å˜åŸåˆ™</div>

<div class="explain-box key">
    <h4>åŸåˆ™1: é£æ§å±‚çº§é«˜äºç­–ç•¥å±‚çº§</h4>
    <p>æ­¢æŸã€æ­¢ç›ˆã€è¿½è¸ªæ­¢ç›ˆã€æœ€å¤§å›æ’¤ç†”æ–­ç­‰é£æ§é€»è¾‘<strong>å®Œå…¨ä¸å—å¤šå‘¨æœŸå½±å“</strong>ã€‚å®ƒä»¬ç”± RiskManager å’Œ evaluate_action() ç‹¬ç«‹ç®¡ç†ã€‚å¤šå‘¨æœŸå…±è¯†åªå½±å“"æ˜¯å¦å¼€ä»“"ï¼Œä¸å½±å“"ä½•æ—¶å¹³ä»“"ã€‚</p>
</div>

<div class="explain-box red">
    <h4>åŸåˆ™2: æ•…éšœé™çº§è€Œä¸æ˜¯æ•…éšœåœæ­¢</h4>
    <p>å¦‚æœå¤šå‘¨æœŸä¿¡å·è®¡ç®—è¶…æ—¶æˆ–å¼‚å¸¸(å¦‚ç½‘ç»œé—®é¢˜å¯¼è‡´æŸä¸ªTFæ•°æ®è·å–å¤±è´¥)ï¼Œç³»ç»Ÿ<strong>è‡ªåŠ¨é™çº§ä¸ºå•TFæ¨¡å¼</strong>ï¼Œä¸ä¼šé˜»æ­¢æ­£å¸¸äº¤æ˜“ã€‚</p>
</div>

<div class="code-filename">live_trading_engine.py Â· é™çº§æœºåˆ¶</div>
<div class="code-block">
<span class="keyword">def</span> <span class="func">_apply_multi_tf_gate</span>(self, sig):
    <span class="keyword">try</span>:
        multi_result = self.signal_generator.<span class="func">compute_multi_tf_consensus</span>(...)
        <span class="comment"># ... æ­£å¸¸ä¸‰é‡é—¨æ§é€»è¾‘ ...</span>
        <span class="keyword">return</span> sig

<span class="highlight-gold">    <span class="keyword">except</span> <span class="var">Exception</span> <span class="keyword">as</span> e:</span>
<span class="highlight-gold">        <span class="comment"># å¤šå‘¨æœŸè®¡ç®—å¤±è´¥ â†’ ä¸é˜»æ­¢äº¤æ˜“ï¼Œé™çº§ä¸ºå•TFæ¨¡å¼</span></span>
<span class="highlight-gold">        self.logger.<span class="func">warning</span>(</span>
<span class="highlight-gold">            <span class="string">f"[å¤šå‘¨æœŸé—¨æ§] è®¡ç®—å¼‚å¸¸ï¼Œé™çº§ä¸ºå•TFæ¨¡å¼: {e}"</span></span>
<span class="highlight-gold">        )</span>
<span class="highlight-gold">        <span class="keyword">return</span> sig  <span class="comment"># åŸæ ·è¿”å›ï¼Œä¸ä¿®æ”¹action</span></span>
</div>

<div class="explain-box">
    <h4>åŸåˆ™3: å¹¶è¡Œè®¡ç®—æœ‰è¶…æ—¶ä¿æŠ¤</h4>
    <p>å¤šTFä¿¡å·å¹¶è¡Œè®¡ç®—ä½¿ç”¨ <code>ThreadPoolExecutor</code>ï¼Œæ¯ä¸ªTFæœ‰120ç§’è¶…æ—¶ã€‚å³ä½¿æŸä¸ªTFçš„æ•°æ®è·å–å¡ä½ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–TFçš„è®¡ç®—å’Œæ•´ä½“å†³ç­–æµç¨‹ã€‚å¤±è´¥çš„TFä¼šè¢«æ ‡è®°ä¸º <code>ok: false</code>ï¼Œåœ¨å…±è¯†è®¡ç®—ä¸­è¢«å¿½ç•¥ã€‚</p>
</div>

<div class="explain-box">
    <h4>äº¤æ˜“å¼•æ“å®Œæ•´tickæµç¨‹ (é›†æˆå¤šå‘¨æœŸå)</h4>
    <p>1. â° ä¸»TFæ”¶ç›˜ â†’ åˆ·æ–°æ•°æ®</p>
    <p>2. ğŸ“Š compute_latest_signal() â†’ ä¸»TFçš„ sell_score / buy_score</p>
    <p>3. ğŸ“ˆ æ›´æ–°æŒä»“ç›ˆäº</p>
    <p>4. ğŸ›¡ï¸ é£æ§æ£€æŸ¥ (RiskManager)</p>
    <p>5. âœ‚ï¸ æ£€æŸ¥éƒ¨åˆ†æ­¢ç›ˆ</p>
    <p>6. ğŸ” evaluate_action() â†’ å†³å®šåŠ¨ä½œ (OPEN / CLOSE / HOLD)</p>
    <p>7. ğŸ”— <strong>å¦‚æœæ˜¯OPEN â†’ å¤šå‘¨æœŸé—¨æ§</strong> (æ–°å¢)</p>
    <p>8. ğŸ“ è®°å½•ä¿¡å·æ—¥å¿—</p>
    <p>9. âš¡ æ‰§è¡Œäº¤æ˜“ (å¦‚æœåŠ¨ä½œä¸æ˜¯HOLD)</p>
    <p>10. ğŸ“² é€šçŸ¥æ¨é€</p>
</div>

{% endblock %}
