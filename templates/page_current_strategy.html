{% extends "base.html" %}
{% block title %}å½“å‰æœ€ä¼˜ç­–ç•¥(v5.0) - æŠ€æœ¯åˆ†æå¹³å°{% endblock %}

{% block content %}
<style>
    .strategy-hero {
        background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(168,85,247,0.09));
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 28px 32px;
        margin-bottom: 28px;
    }
    .strategy-hero h1 { font-size: 26px; font-weight: 700; margin-bottom: 8px; }
    .strategy-hero .tagline { font-size: 14px; color: var(--text-secondary); margin-bottom: 18px; line-height: 1.7; }
    .strategy-meta { display: flex; flex-wrap: wrap; gap: 10px; }
    .strategy-meta .badge {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
    }
    .strategy-meta .blue { background: rgba(74,158,255,0.2); color: var(--accent-blue); }
    .strategy-meta .green { background: rgba(0,214,143,0.2); color: var(--accent-green); }
    .strategy-meta .purple { background: rgba(168,85,247,0.2); color: var(--accent-purple); }
    .strategy-meta .yellow { background: rgba(255,170,0,0.2); color: var(--accent-yellow); }
    .strategy-meta .orange { background: rgba(230,126,34,0.2); color: #e67e22; }
    .strategy-meta .red { background: rgba(239,68,68,0.15); color: #ef4444; }

    .section { margin-bottom: 24px; }
    .section p, .section li {
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.75;
    }
    .section ul { margin: 0; padding-left: 20px; }
    .param-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 8px;
    }
    .param-table th, .param-table td {
        text-align: left;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
    }
    .param-table th { color: var(--text-muted); font-weight: 600; }
    .param-table code { background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; }
    .hint {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-muted);
    }
    .new-tag { display:inline-block; background:#22c55e; color:#fff; font-size:10px; padding:1px 6px; border-radius:4px; margin-left:4px; vertical-align:middle; font-weight:700; }
    .fix-tag { display:inline-block; background:#ef4444; color:#fff; font-size:10px; padding:1px 6px; border-radius:4px; margin-left:4px; vertical-align:middle; font-weight:700; }
    .timeline { border-left: 3px solid var(--accent-blue); padding-left: 16px; margin-top: 12px; }
    .timeline .round { margin-bottom: 14px; }
    .round .round-title { font-weight: 700; font-size: 13px; color: var(--text-primary); }
    .round .round-body { font-size: 13px; color: var(--text-secondary); line-height: 1.65; }
    .round .round-date { font-size: 11px; color: var(--text-muted); }
    .bugfix-banner {
        background: rgba(239,68,68,0.08);
        border: 1px solid rgba(239,68,68,0.3);
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 20px;
        font-size: 13px;
        line-height: 1.7;
        color: var(--text-secondary);
    }
    .bugfix-banner strong { color: #ef4444; }
</style>

<div class="strategy-hero">
    <h1>ğŸ“Œ å½“å‰æœ€ä¼˜ç­–ç•¥ v5.0 <span class="fix-tag">BUGFIX</span></h1>
    <p class="tagline">
        å…­ä¹¦èåˆ Ã— å¤šå‘¨æœŸè”åˆå†³ç­–ï¼ˆ15m+1h+4h+24hï¼‰<br>
        v5.0 = <strong>ä¿®å¤ partial_tp margin_released é‡å¤è®¡å…¥ bug</strong> + å…¨é‡é‡è·‘éªŒè¯ã€‚<br>
        v4.x å…¨éƒ¨å†å²å›æµ‹æ•°æ®å› æ­¤ bug å­˜åœ¨ä¸¥é‡æ”¶ç›Šè†¨èƒ€ï¼ˆçº¦ 6 å€ï¼‰ï¼Œv5.0 ä¸ºä¿®æ­£åçœŸå®æ•°æ®ã€‚
    </p>
    <div class="strategy-meta">
        <span class="badge red">BUGFIX: partial_tp margin é‡å¤è®¡å…¥</span>
        <span class="badge blue">ä¸»TF: 1h / å†³ç­–TF: 15m+1h+4h+24h</span>
        <span class="badge green">SPOT_SELL: SSâ‰¥35ç¡®è®¤Ã—3 + block high_vol,trend</span>
        <span class="badge purple">Regimeé—¨æ§: low_vol_trend +35</span>
        <span class="badge yellow">åˆ†æ®µæ­¢ç›ˆv3: 12% / 25%</span>
        <span class="badge orange">short_thr=40 + NoTPé€€å‡º16bar</span>
    </div>
</div>

<div class="bugfix-banner">
    <strong>P0 Bug ä¿®å¤è¯´æ˜ï¼ˆ2026-02-11ï¼‰ï¼š</strong><br>
    å‘ç° <code>optimize_six_book.py</code> ä¸­ PARTIAL_TPï¼ˆåˆ†æ®µæ­¢ç›ˆï¼‰ä»£ç å­˜åœ¨ <strong>margin_released é‡å¤è®¡å…¥ bug</strong>ã€‚
    å¼€ä»“æ—¶ margin æœªä» <code>eng.usdt</code> æ‰£é™¤ï¼ˆä»…è®°å½• <code>frozen_margin</code>ï¼‰ï¼Œä½†åˆ†æ®µæ­¢ç›ˆæ—¶
    <code>eng.usdt += margin_released + partial_pnl</code> å°† margin_released åŠ å›äº† usdtâ€”â€”ç›¸å½“äºå‡­ç©ºæ³¨å…¥èµ„é‡‘ã€‚<br>
    144 ç¬” PARTIAL_TP ç´¯è®¡è™šå¢ <strong>$1,167,019</strong>ï¼Œç»å¤åˆ©æ•ˆåº”æ”¾å¤§åå¯¼è‡´ä¸»åŒºé—´æ”¶ç›Šä»çœŸå® +137% è†¨èƒ€åˆ° +857%ã€‚
    ä¿®å¤æ–¹å¼ï¼š<code>eng.usdt += partial_pnl</code>ï¼ˆç§»é™¤ margin_released åŠ é¡¹ï¼‰ï¼Œ4 å¤„ä¿®æ”¹ã€‚<br>
    <strong>v4.x æ‰€æœ‰å†å²å›æµ‹ç»“è®ºï¼ˆrun#1~#118ï¼‰å‡å—æ­¤ bug å½±å“ï¼Œå‚æ•°å¯¹æ¯”ç»“è®ºéœ€è¦åœ¨ v5.0 å£å¾„ä¸‹é‡æ–°éªŒè¯ã€‚</strong>
</div>

<div class="card section">
    <h3 class="card-title">ğŸ¯ ç­–ç•¥æ‘˜è¦</h3>
    <ul>
        <li>ä¿¡å·å±‚ï¼šå…­ç»´è¯„åˆ†ï¼ˆèƒŒç¦»/å‡çº¿/èœ¡çƒ›å›¾/å¸ƒæ—å¸¦/é‡ä»·/KDJï¼‰åœ¨å¤šå‘¨æœŸå¹¶è¡Œç”Ÿæˆ SS/BSã€‚</li>
        <li>å†³ç­–å±‚ï¼šå¤šå‘¨æœŸå…±è¯† + veto è¿‡æ»¤ + regime åŠ¨æ€é˜ˆå€¼ + åŒå¼•æ“ï¼ˆtrend/reversionï¼‰åˆ‡æ¢ã€‚</li>
        <li>é£æ§å±‚ï¼šç»„åˆä¿æŠ¤ï¼ˆè¿äº/æ—¥äº/å…¨å±€å›æ’¤ï¼‰ã€ç¡¬æ–­è·¯å™¨ã€åˆ†æ®µæ­¢ç›ˆã€è¶‹åŠ¿æŒä»“åº•çº¿ã€‚</li>
        <li><strong>v5.0 æ ¸å¿ƒä¿®å¤ï¼š</strong>æ¶ˆé™¤ partial_tp margin_released é‡å¤è®¡å…¥ bugï¼ˆ4 å¤„ï¼‰ï¼Œå›æµ‹æ•°æ®å›å½’çœŸå®ã€‚</li>
    </ul>
</div>

<div class="card section">
    <h3 class="card-title">ğŸ“Š v5.0 ä¿®æ­£åè¡¨ç°</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">å›æµ‹åŒºé—´</div>
            <div class="stat-value">2025-01 ~ 2026-01</div>
            <div class="stat-note">run#119ï¼ˆä¿®å¤ååŸºçº¿ï¼‰</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ç­–ç•¥æ”¶ç›Š</div>
            <div class="stat-value positive">+137.86%</div>
            <div class="stat-note">ä¿®å¤å‰è™šæŠ¥ +857.86%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Alpha</div>
            <div class="stat-value positive">+151.42%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">æœ€å¤§å›æ’¤</div>
            <div class="stat-value" style="color:var(--accent-yellow);">-12.30%</div>
            <div class="stat-note">ä¿®å¤å‰è™šæŠ¥ -6.51%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">åˆçº¦PF</div>
            <div class="stat-value positive">1.06</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ç»„åˆPF</div>
            <div class="stat-value positive">1.91</div>
            <div class="stat-note">ä¿®å¤å‰è™šæŠ¥ 2.35</div>
        </div>
    </div>

    <h4 style="font-size:14px;font-weight:600;margin:16px 0 8px;color:var(--text-primary);">ä¿®å¤å‰åå¯¹æ¯”</h4>
    <table class="param-table">
        <thead>
            <tr><th>æŒ‡æ ‡</th><th>ä¿®å¤å‰ (v4.x, æœ‰bug)</th><th>ä¿®å¤å (v5.0)</th><th>è¯´æ˜</th></tr>
        </thead>
        <tbody>
            <tr>
                <td>ä¸»åŒºé—´æ”¶ç›Š</td>
                <td style="color:#ef4444;text-decoration:line-through;">+857.86%</td>
                <td class="pnl-pos"><strong>+137.86%</strong></td>
                <td>è™šå¢çº¦ 6 å€</td>
            </tr>
            <tr>
                <td>æœŸæœ«èµ„é‡‘</td>
                <td style="color:#ef4444;text-decoration:line-through;">$1,915,714</td>
                <td><strong>$475,729</strong></td>
                <td>åˆå§‹ $200,000</td>
            </tr>
            <tr>
                <td>æœ€å¤§å›æ’¤</td>
                <td style="color:#ef4444;text-decoration:line-through;">-6.51%</td>
                <td><strong>-12.30%</strong></td>
                <td>è™šå‡çš„ä½å›æ’¤</td>
            </tr>
            <tr>
                <td>ç»„åˆPF</td>
                <td style="color:#ef4444;text-decoration:line-through;">2.35</td>
                <td><strong>1.91</strong></td>
                <td>ä» >1.5</td>
            </tr>
            <tr>
                <td>åˆçº¦PF</td>
                <td style="text-decoration:line-through;">0.93</td>
                <td class="pnl-pos"><strong>1.06</strong></td>
                <td>åˆçº¦æœ¬èº«ç¿»æ­£</td>
            </tr>
            <tr>
                <td>äº¤æ˜“ç¬”æ•°</td>
                <td>874</td>
                <td>782</td>
                <td>è™šå‡èµ„é‡‘å¯¼è‡´æ›´å¤šäº¤æ˜“</td>
            </tr>
        </tbody>
    </table>

    <h4 style="font-size:14px;font-weight:600;margin:16px 0 8px;color:var(--text-primary);">OOS (2024) å¯¹æ¯”</h4>
    <table class="param-table">
        <thead>
            <tr><th>æŒ‡æ ‡</th><th>ä¿®å¤å‰ (run#86)</th><th>ä¿®å¤å (run#120)</th></tr>
        </thead>
        <tbody>
            <tr><td>OOS æ”¶ç›Š</td><td style="text-decoration:line-through;">+81.45%</td><td class="pnl-pos"><strong>+33.87%</strong></td></tr>
            <tr><td>OOS å›æ’¤</td><td style="text-decoration:line-through;">-19.71%</td><td><strong>-27.43%</strong></td></tr>
            <tr><td>OOS ç»„åˆPF</td><td style="text-decoration:line-through;">1.35</td><td><strong>1.76</strong></td></tr>
            <tr><td>OOS åˆçº¦PF</td><td style="text-decoration:line-through;">1.52</td><td><strong>1.08</strong></td></tr>
        </tbody>
    </table>

    <h4 style="font-size:14px;font-weight:600;margin:16px 0 8px;color:var(--text-primary);">Regime åˆ†æï¼ˆä¿®å¤å run#119ï¼‰</h4>
    <table class="param-table">
        <thead>
            <tr><th>Regime</th><th>ç¬”æ•°</th><th>å‡€PnL</th><th>pPF</th></tr>
        </thead>
        <tbody>
            <tr><td>neutral</td><td>280</td><td class="pnl-pos">+$117,707</td><td>1.43</td></tr>
            <tr><td>trend</td><td>110</td><td class="pnl-pos">+$134,069</td><td>3.43</td></tr>
            <tr><td>high_vol</td><td>28</td><td class="pnl-pos">+$54,205</td><td>4.72</td></tr>
            <tr><td>low_vol_trend</td><td>41</td><td class="pnl-pos">+$38,399</td><td>2.32</td></tr>
            <tr><td>high_vol_choppy</td><td>6</td><td class="pnl-pos">+$1,186</td><td>1.28</td></tr>
        </tbody>
    </table>

    <h4 style="font-size:14px;font-weight:600;margin:16px 0 8px;color:var(--text-primary);">å…³é”® Run å…³è”</h4>
    <table class="param-table">
        <thead>
            <tr><th>Run</th><th>æ ‡ç­¾</th><th>åŒºé—´</th><th>æ”¶ç›Š</th><th>MaxDD</th><th>pPF</th><th>ç”¨é€”</th></tr>
        </thead>
        <tbody>
            <tr style="background:rgba(34,197,94,0.06);">
                <td><strong>#119</strong></td>
                <td>v5.0 bugfixåŸºçº¿</td>
                <td>2025-01~2026-01</td>
                <td class="pnl-pos"><strong>+137.86%</strong></td>
                <td><strong>-12.30%</strong></td>
                <td><strong>1.91</strong></td>
                <td><strong>v5.0 ä¸»çº¿ (å½“å‰) â­</strong></td>
            </tr>
            <tr style="background:rgba(34,197,94,0.06);">
                <td><strong>#120</strong></td>
                <td>v5.0 OOS</td>
                <td>2024-01~2024-12</td>
                <td class="pnl-pos"><strong>+33.87%</strong></td>
                <td><strong>-27.43%</strong></td>
                <td><strong>1.76</strong></td>
                <td>OOSéªŒè¯</td>
            </tr>
            <tr>
                <td><del>#85</del></td>
                <td>v4.5 (æœ‰bug)</td>
                <td>2025-01~2026-01</td>
                <td style="text-decoration:line-through;">+857.86%</td>
                <td style="text-decoration:line-through;">-6.51%</td>
                <td style="text-decoration:line-through;">2.35</td>
                <td style="color:#ef4444">å·²åºŸå¼ƒ(å«bug)</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card section">
    <h3 class="card-title">âš™ï¸ v5.0 ä¸Šçº¿å‚æ•°é›†ï¼ˆä¸ v4.5 å‚æ•°ä¸€è‡´ï¼Œä»…ä¿®å¤å¼•æ“ bugï¼‰</h3>
    <table class="param-table">
        <thead>
            <tr><th>å‚æ•°ç»„</th><th>å‚æ•°</th><th>å€¼</th><th>è¯´æ˜</th></tr>
        </thead>
        <tbody>
            <tr><td>å¤šå‘¨æœŸ</td><td><code>decision_tfs</code></td><td>15m,1h,4h,24h</td><td>æ—¥çº¿çº§è¶‹åŠ¿é”šå®šä¿ç•™ 24h</td></tr>
            <tr><td>å…¥åœºé˜ˆå€¼</td><td><code>short_threshold</code></td><td>40</td><td>è¿‡æ»¤ä½è´¨é‡å¼€ç©º</td></tr>
            <tr><td>å…¥åœºé˜ˆå€¼</td><td><code>sell/buy/long_threshold</code></td><td>18 / 25 / 30</td><td>ä¿æŒ</td></tr>
            <tr><td>æ­¢æŸæ­¢ç›ˆ</td><td><code>short_sl / short_tp / long_sl / long_tp</code></td><td>-0.16 / 0.6 / -0.1 / 0.4</td><td>ä¿æŒ</td></tr>
            <tr><td>åˆ†æ®µæ­¢ç›ˆ</td><td><code>use_partial_tp_v3</code></td><td>true</td><td>æ—©é”åˆ©ï¼šTP1=12%ï¼ŒTP2=25%</td></tr>
            <tr><td>NoTPé€€å‡º</td><td><code>no_tp_exit_bars / no_tp_exit_min_pnl</code></td><td>16 / 0.03</td><td>ç©ºå•æŒä»“â‰¥16bar + æœªè¾¾TP1 â†’ å¹³ä»“</td></tr>
            <tr><td>SPOT_SELLè¿‡æ»¤</td><td><code>use_spot_sell_confirm / ss / min</code></td><td>true / 35 / 3</td><td>confirm_min=3</td></tr>
            <tr><td>SPOT_SELLå±è”½</td><td><code>spot_sell_regime_block</code></td><td>high_vol,trend</td><td>è¶‹åŠ¿æ®µè¯¯å–å±è”½</td></tr>
            <tr><td>Regimeé—¨æ§</td><td><code>regime_short_gate_add</code></td><td>35</td><td>ä»… low_vol_trend ç”Ÿæ•ˆ</td></tr>
            <tr><td>ä¿æŠ¤</td><td><code>hard_stop_loss / prot_global_dd_limit_pct</code></td><td>-0.28 / 0.15</td><td>ä¿æŒ</td></tr>
        </tbody>
    </table>
</div>

<div class="card section">
    <h3 class="card-title">ğŸ§ª ä¼˜åŒ–å†ç¨‹</h3>
    <div class="timeline">
        <div class="round">
            <div class="round-date">2026-02-11 æœ€æ–°</div>
            <div class="round-title">v5.0: ä¿®å¤ partial_tp margin_released é‡å¤è®¡å…¥ bug <span class="fix-tag">CRITICAL</span></div>
            <div class="round-body">
                å‘ç° PARTIAL_TP åˆ†æ®µæ­¢ç›ˆä»£ç ä¸­ <code>eng.usdt += margin_released + partial_pnl</code>
                å­˜åœ¨ margin é‡å¤è®¡å…¥ï¼ˆmargin ä»æœªä» usdt æ‰£é™¤ï¼Œä½†åœ¨æ­¢ç›ˆæ—¶åŠ å›ï¼‰ã€‚<br>
                å½±å“ï¼š144 ç¬” partial_tp ç´¯è®¡è™šå¢ $1.17Mï¼Œç»å¤åˆ©æ”¾å¤§ï¼Œä¸»åŒºé—´æ”¶ç›Šä»çœŸå® +137% è†¨èƒ€åˆ° +857%ã€‚<br>
                <strong>ä¿®å¤å run#119: +137.86% / -12.30% MaxDD / pPF 1.91 / cPF 1.06</strong>
            </div>
        </div>
        <div class="round">
            <div class="round-date">2026-02-14</div>
            <div class="round-title">v4.5: run#85 åŸºçº¿ + NoTPé€€å‡ºï¼ˆæ•°æ®å·²åºŸå¼ƒï¼‰</div>
            <div class="round-body">ç¬¬åä¸‰è½®æ¶ˆèç¡®è®¤ NoTP æœ‰æ•ˆæ€§ã€‚ä½†æ‰€æœ‰æ•°æ®å› ä¸Šè¿° bug è€Œè†¨èƒ€ï¼Œç»“è®ºéœ€ v5.0 å£å¾„é‡éªŒã€‚</div>
        </div>
        <div class="round">
            <div class="round-date">2026-02-14</div>
            <div class="round-title">P0ä¿®å¤: å‰è§† bug (ema20/vol_now)</div>
            <div class="round-body">ä¿®å¤ use_spot_sell_confirm ä¸­ idxâ†’idx-1 æ—¶åºé—®é¢˜ã€‚æ­¤ä¿®å¤åœ¨ v5.0 ä¸­ä¿ç•™ã€‚</div>
        </div>
    </div>
</div>

<div class="card section">
    <h3 class="card-title">ğŸ“‹ ä¸‹ä¸€æ­¥</h3>
    <ul>
        <li><strong>å‚æ•°é‡éªŒï¼š</strong>v4.x çš„ A/B å¯¹æ¯”ç»“è®ºï¼ˆNoTPã€threshold=40 ç­‰ï¼‰éœ€åœ¨ v5.0 å¼•æ“ä¸‹é‡æ–°éªŒè¯ã€‚</li>
        <li><strong>Regime åˆ†æï¼š</strong>neutral æ®µ pPF ä»… 1.43ï¼Œå›æ’¤ -27.43% é›†ä¸­äº OOSï¼Œéœ€é‡ç‚¹ä¼˜åŒ–ã€‚</li>
        <li><strong>å›æ’¤æ§åˆ¶ï¼š</strong>çœŸå® MaxDD -12.30%ï¼ˆä¸»ï¼‰/ -27.43%ï¼ˆOOSï¼‰åå¤§ï¼Œè€ƒè™‘åŠ å¼ºé£æ§ã€‚</li>
        <li><strong>æ”¶ç›Šç»“æ„ï¼š</strong>ç°è´§ PnL +$124K + åˆçº¦ PnL +$221K = æ€»å·²å®ç° +$345Kï¼ˆå æœŸæœ«æ”¶ç›Šçš„ä¸»è¦éƒ¨åˆ†ï¼‰ã€‚</li>
    </ul>
</div>

<div class="card section">
    <h3 class="card-title">ğŸ”— ç»“æœä¸å…¥å£</h3>
    <p>
        <a href="/strategy/multi-tf-daily?run_id=119" style="color:var(--accent-blue);">v5.0 ä¸»åŒºé—´ run#119</a> Â·
        <a href="/strategy/multi-tf-daily?run_id=120" style="color:var(--accent-blue);">v5.0 OOS run#120</a> Â·
        <a href="/strategy/live-control" style="color:var(--accent-blue);">å®ç›˜æ§åˆ¶é¢æ¿</a>
    </p>
    <p>
        <a href="https://invest.executor.life/strategy/current" target="_blank" rel="noopener noreferrer" style="color:var(--accent-blue);">çº¿ä¸Šç­–ç•¥è¯´æ˜é¡µ</a> Â·
        <a href="https://invest.executor.life/strategy/multi-tf-daily" target="_blank" rel="noopener noreferrer" style="color:var(--accent-blue);">çº¿ä¸Šè¿è¡Œç»“æœé¡µ</a>
    </p>
    <div class="hint">æœ€åæ›´æ–°ï¼š2026-02-11 Â· v5.0 = ä¿®å¤ partial_tp margin bug + å…¨é‡é‡è·‘ Â· run#119 / #120</div>
</div>
{% endblock %}
