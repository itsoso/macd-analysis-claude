{% extends "base.html" %}
{% block title %}最优策略详解 · 分段止盈+最佳SL/TP - 技术分析平台{% endblock %}

{% block content %}
            <div class="page-title">最优策略详解: 精选分段TP@20%平30% + 最佳SL/TP</div>
            <div class="page-subtitle">Alpha +86.69% · 12时间框架×94参数变体×精细组合搜索 · 从286次回测中筛选的全局最优</div>

            <!-- Hero 性能指标 -->
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:28px;">
                <div class="card" style="text-align:center;border-top:3px solid #00d68f;padding:16px;">
                    <div style="font-size:11px;color:var(--text-tertiary);">Alpha</div>
                    <div style="font-size:26px;font-weight:700;color:#00d68f;">+86.69%</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid #4a9eff;padding:16px;">
                    <div style="font-size:11px;color:var(--text-tertiary);">策略收益</div>
                    <div style="font-size:26px;font-weight:700;color:#4a9eff;">+68.28%</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid #ffaa00;padding:16px;">
                    <div style="font-size:11px;color:var(--text-tertiary);">毛收益</div>
                    <div style="font-size:26px;font-weight:700;color:#ffaa00;">+75.0%</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid #ff4d6a;padding:16px;">
                    <div style="font-size:11px;color:var(--text-tertiary);">最大回撤</div>
                    <div style="font-size:26px;font-weight:700;color:#ff4d6a;">-6.94%</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid #a855f7;padding:16px;">
                    <div style="font-size:11px;color:var(--text-tertiary);">交易次数</div>
                    <div style="font-size:26px;font-weight:700;color:#a855f7;">141</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid #e1e4ea;padding:16px;">
                    <div style="font-size:11px;color:var(--text-tertiary);">费用拖累</div>
                    <div style="font-size:26px;font-weight:700;color:#e1e4ea;">6.72%</div>
                </div>
            </div>

            <!-- vs F12 对比 -->
            <div class="card" style="border-left:3px solid #00d68f;margin-bottom:24px;">
                <div class="card-title"><span style="color:#00d68f;">VS</span> 与F12基准策略对比</div>
                <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:24px;align-items:center;">
                    <div style="text-align:center;">
                        <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px;">F12: C6+三书否决 (旧)</div>
                        <div style="font-size:32px;font-weight:700;color:#ffaa00;">+44.02%</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Alpha · 回撤 -10.97% · 129笔交易</div>
                    </div>
                    <div style="font-size:36px;color:#00d68f;">→</div>
                    <div style="text-align:center;">
                        <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px;">精选分段TP+最佳SL/TP (新)</div>
                        <div style="font-size:32px;font-weight:700;color:#00d68f;">+86.69%</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Alpha · 回撤 -6.94% · 141笔交易</div>
                    </div>
                </div>
                <div style="text-align:center;margin-top:12px;padding:8px;background:rgba(0,214,143,0.08);border-radius:6px;">
                    <span style="font-weight:600;color:#00d68f;">Alpha提升 +42.67个百分点 · 回撤降低 4.03个百分点</span>
                </div>
            </div>

            <!-- Tab导航 -->
            <div style="display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap;">
                <button class="opt-tab active" onclick="showOptTab('arch')">策略架构</button>
                <button class="opt-tab" onclick="showOptTab('partial-tp')">分段止盈(核心创新)</button>
                <button class="opt-tab" onclick="showOptTab('params')">完整参数</button>
                <button class="opt-tab" onclick="showOptTab('code')">核心代码</button>
                <button class="opt-tab" onclick="showOptTab('trades')">交易明细</button>
                <button class="opt-tab" onclick="showOptTab('equity')">资金曲线</button>
                <button class="opt-tab" onclick="showOptTab('fees')">费用分析</button>
            </div>

            <!-- Tab 1: 策略架构 -->
            <div id="tab-arch" class="opt-panel active">
                <div class="card">
                    <div class="card-title">策略架构总览</div>
                    <div style="font-size:14px;color:var(--text-secondary);line-height:1.9;">
                        <p>本策略在F12(C6+三书否决)的信号引擎基础上，通过<b>系统性参数优化</b>找到了最优的止盈止损配置。</p>
                        <p>优化流程经历了4个阶段：</p>
                    </div>

                    <!-- 架构流程图 -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0;">
                        <div style="background:rgba(74,158,255,0.08);border:1px solid rgba(74,158,255,0.2);border-radius:10px;padding:16px;text-align:center;">
                            <div style="font-size:24px;margin-bottom:6px;">A</div>
                            <div style="font-weight:600;font-size:13px;color:#4a9eff;">12时间框架基准</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">10m~24h全量扫描<br>找到TOP3: 16h/1h/12h</div>
                        </div>
                        <div style="background:rgba(0,214,143,0.08);border:1px solid rgba(0,214,143,0.2);border-radius:10px;padding:16px;text-align:center;">
                            <div style="font-size:24px;margin-bottom:6px;">B</div>
                            <div style="font-weight:600;font-size:13px;color:#00d68f;">94参数变体搜索</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">在TOP3框架上<br>测试6类94种参数</div>
                        </div>
                        <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:10px;padding:16px;text-align:center;">
                            <div style="font-size:24px;margin-bottom:6px;">C</div>
                            <div style="font-weight:600;font-size:13px;color:#a855f7;">全局排名</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">282次回测汇总<br>按Alpha排序TOP20</div>
                        </div>
                        <div style="background:rgba(255,170,0,0.08);border:1px solid rgba(255,170,0,0.2);border-radius:10px;padding:16px;text-align:center;">
                            <div style="font-size:24px;margin-bottom:6px;">D</div>
                            <div style="font-weight:600;font-size:13px;color:#ffaa00;">精细组合</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">取各维度最优参数<br>交叉组合精细搜索</div>
                        </div>
                    </div>

                    <!-- 信号层 -->
                    <div style="margin-top:20px;padding:16px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                        <div style="font-weight:600;margin-bottom:12px;">信号层: C6+三书否决 (不变)</div>
                        <div style="display:grid;grid-template-columns:2fr 1fr 2fr;gap:8px;font-size:12px;">
                            <div style="background:rgba(74,158,255,0.06);padding:10px;border-radius:6px;">
                                <div style="font-weight:600;color:#4a9eff;">C6底座 (权重100%)</div>
                                <div style="color:var(--text-secondary);margin-top:4px;">背离信号 × 0.7 + 均线信号 × 0.3</div>
                            </div>
                            <div style="display:flex;align-items:center;justify-content:center;color:var(--text-tertiary);">+否决/加成→</div>
                            <div style="background:rgba(168,85,247,0.06);padding:10px;border-radius:6px;">
                                <div style="font-weight:600;color:#a855f7;">三书否决层</div>
                                <div style="color:var(--text-secondary);margin-top:4px;">K线/布林/量价 ≥2票反对 → 削弱70%<br>未否决 → 加成(BB+10% VP+8% CS+6%)</div>
                            </div>
                        </div>
                    </div>

                    <!-- 执行层 -->
                    <div style="margin-top:12px;padding:16px;background:rgba(0,214,143,0.04);border-radius:8px;border:1px solid rgba(0,214,143,0.15);">
                        <div style="font-weight:600;margin-bottom:12px;color:#00d68f;">执行层: 优化后的风控引擎 (核心改进)</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:12px;">
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;">
                                <div style="font-weight:600;color:#00d68f;">分段止盈 ★新增</div>
                                <div style="color:var(--text-secondary);margin-top:4px;">盈利≥20%时先平30%<br>剩余70%继续追踪</div>
                            </div>
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;">
                                <div style="font-weight:600;color:#ffaa00;">收紧止损 ★优化</div>
                                <div style="color:var(--text-secondary);margin-top:4px;">空头SL: -30%→-25%<br>多头SL: -15%→-8%</div>
                            </div>
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;">
                                <div style="font-weight:600;color:#4a9eff;">降低止盈 ★优化</div>
                                <div style="color:var(--text-secondary);margin-top:4px;">空头TP: 80%→60%<br>多头TP: 50%→30%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 分段止盈 -->
            <div id="tab-partial-tp" class="opt-panel">
                <div class="card">
                    <div class="card-title"><span style="color:#00d68f;">★</span> 分段止盈 — 本次优化的核心发现</div>
                    <div style="font-size:14px;color:var(--text-secondary);line-height:1.8;">
                        <p>在全部286次回测中，<b style="color:#00d68f;">分段止盈(Partial Take-Profit)</b>以压倒性优势成为最大的Alpha提升因素。</p>
                        <p>它在<b>所有3个TOP时间框架</b>(1h/16h/12h)上都是#1参数变体。</p>
                    </div>

                    <!-- 原理对比 -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
                        <div style="border:1px solid rgba(255,77,106,0.3);border-radius:10px;padding:20px;">
                            <div style="font-weight:600;color:#ff4d6a;margin-bottom:12px;font-size:15px;">传统全仓止盈 (F12原版)</div>
                            <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
                                <div style="margin-bottom:12px;">
                                    <b>流程：</b><br>
                                    盈利达到80% → 一次性全部平仓 → 冷却8小时 → 等待下一个信号
                                </div>
                                <div style="padding:10px;background:rgba(255,77,106,0.06);border-radius:6px;">
                                    <b>问题1:</b> 80%止盈阈值太高，很多盈利20~60%的好交易无法止盈<br>
                                    <b>问题2:</b> 全仓平仓后如果行情继续，需要重新开仓+再付手续费<br>
                                    <b>问题3:</b> 冷却期间可能错过后续行情
                                </div>
                            </div>
                        </div>
                        <div style="border:1px solid rgba(0,214,143,0.3);border-radius:10px;padding:20px;">
                            <div style="font-weight:600;color:#00d68f;margin-bottom:12px;font-size:15px;">分段止盈 (优化后)</div>
                            <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
                                <div style="margin-bottom:12px;">
                                    <b>流程：</b><br>
                                    盈利达到20% → 先平30%锁利 → 剩余70%继续持有 → 达60%全部止盈
                                </div>
                                <div style="padding:10px;background:rgba(0,214,143,0.06);border-radius:6px;">
                                    <b>优势1:</b> 20%即可部分获利，大幅提高"落袋"频率<br>
                                    <b>优势2:</b> 70%仓位继续追踪，不错过大行情<br>
                                    <b>优势3:</b> 无需重新开仓，节省手续费+无冷却损失
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 实际案例 -->
                    <div style="margin-top:16px;padding:16px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                        <div style="font-weight:600;margin-bottom:12px;">实战案例: 2026-01-18 ~ 2026-01-20 空单</div>
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;font-size:13px;">
                            <div style="color:var(--text-tertiary);">01-18 00:00</div>
                            <div><span style="color:#4a9eff;">开空</span> @$3,304.53 · 5x杠杆</div>
                            <div style="color:var(--text-tertiary);">01-20 06:00</div>
                            <div><span style="color:#00d68f;font-weight:600;">分段止盈</span> @$3,116.91 · 盈利+28% → <b>平30%仓位</b> → 锁定利润 <span style="color:#00d68f;">$2,345</span></div>
                            <div style="color:var(--text-tertiary);">01-20 23:00</div>
                            <div><span style="color:#ffaa00;">超时平仓</span> @$2,939.88 · 剩余70%继续赚 → 总盈利 <span style="color:#00d68f;">$10,640 + $2,345 = $12,985</span></div>
                        </div>
                        <div style="margin-top:10px;padding:8px 12px;background:rgba(0,214,143,0.08);border-radius:6px;font-size:12px;">
                            <b>关键:</b> 如果用传统全仓止盈(80%)，这笔交易在超时前不会达到80%。<br>
                            分段止盈在20%时锁定了$2,345，总利润提高了<b>22%</b>。
                        </div>
                    </div>

                    <!-- 统计数据 -->
                    <div style="margin-top:16px;">
                        <div style="font-weight:600;margin-bottom:10px;">分段止盈统计</div>
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
                            <div style="text-align:center;padding:12px;background:rgba(0,214,143,0.06);border-radius:8px;">
                                <div style="font-size:11px;color:var(--text-tertiary);">分段止盈空</div>
                                <div style="font-size:22px;font-weight:700;color:#00d68f;">7次</div>
                                <div style="font-size:11px;color:var(--text-secondary);">平均利润 $1,946</div>
                            </div>
                            <div style="text-align:center;padding:12px;background:rgba(74,158,255,0.06);border-radius:8px;">
                                <div style="font-size:11px;color:var(--text-tertiary);">分段止盈多</div>
                                <div style="font-size:22px;font-weight:700;color:#4a9eff;">5次</div>
                                <div style="font-size:11px;color:var(--text-secondary);">平均利润 $1,418</div>
                            </div>
                            <div style="text-align:center;padding:12px;background:rgba(255,170,0,0.06);border-radius:8px;">
                                <div style="font-size:11px;color:var(--text-tertiary);">总锁定利润</div>
                                <div style="font-size:22px;font-weight:700;color:#ffaa00;">$20,710</div>
                                <div style="font-size:11px;color:var(--text-secondary);">占总利润约15%</div>
                            </div>
                            <div style="text-align:center;padding:12px;background:rgba(168,85,247,0.06);border-radius:8px;">
                                <div style="font-size:11px;color:var(--text-tertiary);">分段止盈贡献Alpha</div>
                                <div style="font-size:22px;font-weight:700;color:#a855f7;">+41.4%</div>
                                <div style="font-size:11px;color:var(--text-secondary);">F12基准44→分段85</div>
                            </div>
                        </div>
                    </div>

                    <!-- 各时间框架的分段止盈效果 -->
                    <div style="margin-top:16px;padding:16px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                        <div style="font-weight:600;margin-bottom:10px;">分段止盈在各时间框架的效果</div>
                        <table style="width:100%;font-size:13px;border-collapse:collapse;">
                            <thead>
                                <tr style="border-bottom:2px solid var(--border);">
                                    <th style="text-align:left;padding:6px 10px;color:var(--text-tertiary);font-size:12px;">时间框架</th>
                                    <th style="text-align:center;padding:6px 10px;color:var(--text-tertiary);font-size:12px;">F12基准Alpha</th>
                                    <th style="text-align:center;padding:6px 10px;color:var(--text-tertiary);font-size:12px;">分段TP@20%平30% Alpha</th>
                                    <th style="text-align:center;padding:6px 10px;color:var(--text-tertiary);font-size:12px;">提升</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid var(--border);">
                                    <td style="padding:6px 10px;font-weight:600;">1h ★</td>
                                    <td style="text-align:center;color:#ffaa00;">+44.02%</td>
                                    <td style="text-align:center;color:#00d68f;font-weight:600;">+85.38%</td>
                                    <td style="text-align:center;color:#00d68f;">+41.36</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--border);">
                                    <td style="padding:6px 10px;font-weight:600;">16h</td>
                                    <td style="text-align:center;color:#ffaa00;">+51.06%</td>
                                    <td style="text-align:center;color:#00d68f;font-weight:600;">+72.39%</td>
                                    <td style="text-align:center;color:#00d68f;">+21.33</td>
                                </tr>
                                <tr>
                                    <td style="padding:6px 10px;font-weight:600;">12h</td>
                                    <td style="text-align:center;color:#ffaa00;">+39.31%</td>
                                    <td style="text-align:center;color:#00d68f;font-weight:600;">+61.49%</td>
                                    <td style="text-align:center;color:#00d68f;">+22.18</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 3: 完整参数 -->
            <div id="tab-params" class="opt-panel">
                <div class="card">
                    <div class="card-title">完整参数配置 (F12基准 vs 最优)</div>
                    <table style="width:100%;font-size:13px;border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:2px solid var(--border);">
                                <th style="text-align:left;padding:8px 12px;color:var(--text-tertiary);width:25%;">参数</th>
                                <th style="text-align:center;padding:8px 12px;color:var(--text-tertiary);width:20%;">F12基准</th>
                                <th style="text-align:center;padding:8px 12px;color:var(--text-tertiary);width:20%;">最优值</th>
                                <th style="text-align:center;padding:8px 12px;color:var(--text-tertiary);width:15%;">变化</th>
                                <th style="text-align:left;padding:8px 12px;color:var(--text-tertiary);width:20%;">说明</th>
                            </tr>
                        </thead>
                        <tbody id="params-tbody">
                        </tbody>
                    </table>
                </div>

                <div class="card" style="margin-top:16px;">
                    <div class="card-title">参数配置代码</div>
                    <div class="code-section">
                        <div class="code-header"><span class="code-file">optimize_sl_tp.py</span> <span>Python</span></div>
                        <pre><code><span class="cm"># 全局最优策略配置 (从286次回测中筛选)</span>
<span class="cl">optimal_config</span> = {
    <span class="cm"># === 信号引擎 (继承F12) ===</span>
    <span class="st">'fusion_mode'</span>:    <span class="st">'c6_veto'</span>,      <span class="cm"># C6底座+三书否决</span>
    <span class="st">'veto_threshold'</span>: <span class="nu">25</span>,             <span class="cm"># 否决门槛</span>

    <span class="cm"># === 信号阈值 (继承F12) ===</span>
    <span class="st">'sell_threshold'</span>:  <span class="nu">18</span>,             <span class="cm"># 卖出现货门槛</span>
    <span class="st">'short_threshold'</span>: <span class="nu">25</span>,             <span class="cm"># 开空合约门槛</span>
    <span class="st">'buy_threshold'</span>:   <span class="nu">25</span>,             <span class="cm"># 买入现货门槛</span>
    <span class="st">'long_threshold'</span>:  <span class="nu">40</span>,             <span class="cm"># 开多合约门槛</span>

    <span class="cm"># === 止损 (优化后) ===</span>
    <span class="st">'short_sl'</span>: <span class="nu">-0.25</span>,               <span class="cm"># 空头止损: -30% → -25% ✓收紧</span>
    <span class="st">'long_sl'</span>:  <span class="nu">-0.08</span>,               <span class="cm"># 多头止损: -15% → -8%  ✓大幅收紧</span>

    <span class="cm"># === 止盈 (优化后) ===</span>
    <span class="st">'short_tp'</span>: <span class="nu">0.60</span>,                <span class="cm"># 空头止盈: 80% → 60% ✓降低(配合分段)</span>
    <span class="st">'long_tp'</span>:  <span class="nu">0.30</span>,                <span class="cm"># 多头止盈: 50% → 30% ✓降低(配合分段)</span>

    <span class="cm"># === 分段止盈 ★核心创新 ===</span>
    <span class="st">'use_partial_tp'</span>:   <span class="kw">True</span>,          <span class="cm"># 开启分段止盈</span>
    <span class="st">'partial_tp_1'</span>:     <span class="nu">0.20</span>,          <span class="cm"># 盈利≥20%时触发第一段</span>
    <span class="st">'partial_tp_1_pct'</span>: <span class="nu">0.30</span>,          <span class="cm"># 平掉30%仓位锁定利润</span>

    <span class="cm"># === 追踪止盈 (不变) ===</span>
    <span class="st">'short_trail'</span>:    <span class="nu">0.25</span>,            <span class="cm"># 追踪止盈激活: 25%</span>
    <span class="st">'long_trail'</span>:     <span class="nu">0.20</span>,            <span class="cm"># 追踪止盈激活: 20%</span>
    <span class="st">'trail_pullback'</span>: <span class="nu">0.60</span>,            <span class="cm"># 利润回撤60%时平仓</span>

    <span class="cm"># === 仓位管理 (继承F12) ===</span>
    <span class="st">'lev'</span>: <span class="nu">5</span>, <span class="st">'max_lev'</span>: <span class="nu">5</span>,          <span class="cm"># 最大杠杆5x</span>
    <span class="st">'margin_use'</span>: <span class="nu">0.70</span>,               <span class="cm"># 可用保证金使用率70%</span>
    <span class="st">'short_max_hold'</span>: <span class="nu">72</span>,             <span class="cm"># 最大持仓72小时</span>

    <span class="cm"># === 冷却 (不变) ===</span>
    <span class="st">'cooldown'</span>:      <span class="nu">4</span>,               <span class="cm"># 合约冷却4小时</span>
    <span class="st">'spot_cooldown'</span>: <span class="nu">12</span>,              <span class="cm"># 现货冷却12小时</span>
}</code></pre>
                    </div>
                </div>
            </div>

            <!-- Tab 4: 核心代码 -->
            <div id="tab-code" class="opt-panel">
                <div class="card">
                    <div class="card-title">分段止盈核心代码</div>
                    <div class="code-section">
                        <div class="code-header"><span class="code-file">optimize_sl_tp.py → run_strategy()</span> <span>空仓分段止盈</span></div>
                        <pre><code><span class="cm"># 管理空仓</span>
<span class="kw">if</span> eng.futures_short <span class="kw">and not</span> short_just_opened:
    short_bars += <span class="nu">1</span>
    pnl_r = eng.futures_short.calc_pnl(price) / eng.futures_short.margin

    <span class="cm"># ★ 分段止盈: 盈利达20%时先平30%仓位</span>
    <span class="kw">if</span> use_partial_tp <span class="kw">and not</span> short_partial_done <span class="kw">and</span> pnl_r >= partial_tp_1:
        <span class="cm"># 计算部分平仓</span>
        old_qty = eng.futures_short.quantity
        partial_qty = old_qty * partial_tp_1_pct    <span class="cm"># 平30%</span>
        partial_pnl = (eng.futures_short.entry_price - price) * partial_qty
        
        <span class="cm"># 归还保证金 + 部分盈亏</span>
        eng.usdt += eng.futures_short.margin * partial_tp_1_pct + partial_pnl
        fee = partial_qty * price * FuturesEngine.TAKER_FEE
        eng.usdt -= fee
        eng.total_futures_fees += fee
        
        <span class="cm"># 缩减仓位(剩余70%继续持有)</span>
        eng.futures_short.quantity = old_qty - partial_qty
        eng.futures_short.margin *= (<span class="nu">1</span> - partial_tp_1_pct)
        short_partial_done = <span class="kw">True</span>   <span class="cm"># 每个仓位只分段一次</span>

    <span class="cm"># 后续: 全仓止盈(60%) / 追踪止盈 / 反向信号 / 止损 / 超时</span>
    <span class="kw">if</span> pnl_r >= actual_short_tp:      <span class="cm"># 60%全仓止盈</span>
        eng.close_short(price, dt, <span class="st">f"止盈 +{pnl_r*100:.0f}%"</span>)
    <span class="kw">elif</span> short_max_pnl >= short_trail: <span class="cm"># 追踪止盈</span>
        <span class="kw">if</span> pnl_r < short_max_pnl * trail_pullback:
            eng.close_short(price, dt, <span class="st">"追踪止盈"</span>)
    <span class="kw">elif</span> bs >= close_short_bs:         <span class="cm"># 反向信号平仓</span>
        ...
    <span class="kw">elif</span> pnl_r < actual_short_sl:      <span class="cm"># 止损 -25%</span>
        eng.close_short(price, dt, <span class="st">f"止损 {pnl_r*100:.0f}%"</span>)
    <span class="kw">elif</span> short_bars >= short_max_hold:  <span class="cm"># 超时 72h</span>
        eng.close_short(price, dt, <span class="st">"超时"</span>)</code></pre>
                    </div>
                </div>

                <div class="card" style="margin-top:16px;">
                    <div class="card-title">五重保护机制优先级</div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
                        <div style="text-align:center;padding:12px;background:rgba(0,214,143,0.06);border-radius:8px;border:1px solid rgba(0,214,143,0.15);">
                            <div style="font-size:20px;">1</div>
                            <div style="font-weight:600;font-size:12px;color:#00d68f;">分段止盈</div>
                            <div style="font-size:11px;color:var(--text-secondary);">≥20%先平30%</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(0,214,143,0.06);border-radius:8px;">
                            <div style="font-size:20px;">2</div>
                            <div style="font-weight:600;font-size:12px;color:#00d68f;">全仓止盈</div>
                            <div style="font-size:11px;color:var(--text-secondary);">≥60%全平</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(255,170,0,0.06);border-radius:8px;">
                            <div style="font-size:20px;">3</div>
                            <div style="font-weight:600;font-size:12px;color:#ffaa00;">追踪止盈</div>
                            <div style="font-size:11px;color:var(--text-secondary);">回撤40%平仓</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(74,158,255,0.06);border-radius:8px;">
                            <div style="font-size:20px;">4</div>
                            <div style="font-weight:600;font-size:12px;color:#4a9eff;">反向信号</div>
                            <div style="font-size:11px;color:var(--text-secondary);">BS≥40主导</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(255,77,106,0.06);border-radius:8px;">
                            <div style="font-size:20px;">5</div>
                            <div style="font-weight:600;font-size:12px;color:#ff4d6a;">止损/超时</div>
                            <div style="font-size:11px;color:var(--text-secondary);">-25%或72h</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: 交易明细 -->
            <div id="tab-trades" class="opt-panel">
                <div class="card">
                    <div class="card-title">完整交易明细 (141笔)</div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;">
                        <div style="text-align:center;padding:8px;background:rgba(74,158,255,0.06);border-radius:6px;">
                            <div style="font-size:11px;color:var(--text-tertiary);">开空/平空</div>
                            <div style="font-weight:600;">20次/20次</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,214,143,0.06);border-radius:6px;">
                            <div style="font-size:11px;color:var(--text-tertiary);">开多/平多</div>
                            <div style="font-weight:600;">19次/19次</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(255,170,0,0.06);border-radius:6px;">
                            <div style="font-size:11px;color:var(--text-tertiary);">卖/买现货</div>
                            <div style="font-weight:600;">36次/15次</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(168,85,247,0.06);border-radius:6px;">
                            <div style="font-size:11px;color:var(--text-tertiary);">分段止盈</div>
                            <div style="font-weight:600;color:#a855f7;">12次</div>
                        </div>
                    </div>
                    <div style="max-height:600px;overflow-y:auto;">
                        <table style="width:100%;font-size:12px;border-collapse:collapse;" id="trade-detail-table">
                            <thead>
                                <tr style="border-bottom:2px solid var(--border);position:sticky;top:0;background:var(--bg-card);">
                                    <th style="text-align:left;padding:6px 8px;color:var(--text-tertiary);">#</th>
                                    <th style="text-align:left;padding:6px 8px;color:var(--text-tertiary);">时间</th>
                                    <th style="text-align:left;padding:6px 8px;color:var(--text-tertiary);">操作</th>
                                    <th style="text-align:right;padding:6px 8px;color:var(--text-tertiary);">价格</th>
                                    <th style="text-align:center;padding:6px 8px;color:var(--text-tertiary);">杠杆</th>
                                    <th style="text-align:right;padding:6px 8px;color:var(--text-tertiary);">PnL</th>
                                    <th style="text-align:left;padding:6px 8px;color:var(--text-tertiary);">原因</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 6: 资金曲线 -->
            <div id="tab-equity" class="opt-panel">
                <div class="card">
                    <div class="card-title">资金曲线 · 策略 vs 买入持有</div>
                    <div style="margin-bottom:8px;font-size:12px;color:var(--text-secondary);">
                        初始: 10万USDT + 价值10万USDT的ETH → 最终: $336,974 (策略) vs $163,275 (买入持有)
                    </div>
                    <svg id="opt-equity-chart" width="100%" height="400" viewBox="0 0 900 400"></svg>
                </div>
            </div>

            <!-- Tab 7: 费用分析 -->
            <div id="tab-fees" class="opt-panel">
                <div class="card">
                    <div class="card-title">费用详解</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;">
                        <div style="text-align:center;padding:16px;background:rgba(255,77,106,0.06);border-radius:8px;">
                            <div style="font-size:12px;color:var(--text-tertiary);">总交易成本</div>
                            <div style="font-size:28px;font-weight:700;color:#ff4d6a;">$13,436</div>
                            <div style="font-size:11px;color:var(--text-secondary);">费用拖累 6.72%</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:rgba(255,170,0,0.06);border-radius:8px;">
                            <div style="font-size:12px;color:var(--text-tertiary);">毛收益(扣费前)</div>
                            <div style="font-size:28px;font-weight:700;color:#ffaa00;">+75.0%</div>
                            <div style="font-size:11px;color:var(--text-secondary);">$150,000 → $262,500</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:rgba(0,214,143,0.06);border-radius:8px;">
                            <div style="font-size:12px;color:var(--text-tertiary);">净收益(扣费后)</div>
                            <div style="font-size:28px;font-weight:700;color:#00d68f;">+68.28%</div>
                            <div style="font-size:11px;color:var(--text-secondary);">最终 $336,974</div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;">
                        <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                            <div style="font-size:11px;color:var(--text-tertiary);">现货费用</div>
                            <div style="font-size:18px;font-weight:600;">$581</div>
                            <div style="font-size:11px;color:var(--text-secondary);">4.3%</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                            <div style="font-size:11px;color:var(--text-tertiary);">合约费用</div>
                            <div style="font-size:18px;font-weight:600;">$3,961</div>
                            <div style="font-size:11px;color:var(--text-secondary);">29.5%</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                            <div style="font-size:11px;color:var(--text-tertiary);">资金费率(净)</div>
                            <div style="font-size:18px;font-weight:600;color:#00d68f;">+$207</div>
                            <div style="font-size:11px;color:var(--text-secondary);">做空收益</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                            <div style="font-size:11px;color:var(--text-tertiary);">滑点成本</div>
                            <div style="font-size:18px;font-weight:600;color:#ff4d6a;">$8,666</div>
                            <div style="font-size:11px;color:var(--text-secondary);">64.5% (最大项)</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border);">
                            <div style="font-size:11px;color:var(--text-tertiary);">强平费用</div>
                            <div style="font-size:18px;font-weight:600;color:#00d68f;">$0</div>
                            <div style="font-size:11px;color:var(--text-secondary);">0次强平</div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .opt-tab {
                    padding:8px 16px;border:1px solid var(--border);background:var(--bg-card);
                    color:var(--text-secondary);border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.2s;
                }
                .opt-tab.active,.opt-tab:hover { background:#00d68f;color:#fff;border-color:#00d68f; }
                .opt-panel { display:none; }
                .opt-panel.active { display:block; }
            </style>

            <script>
            function showOptTab(id) {
                document.querySelectorAll('.opt-panel').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.opt-tab').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + id).classList.add('active');
                event.target.classList.add('active');
            }

            document.addEventListener('DOMContentLoaded', function() {
                fetch('/api/optimize_sl_tp').then(r => r.json()).then(data => {
                    // 参数对比表
                    const params = [
                        ['short_sl', '空头止损', '-30%', '-25%', '收紧5%', '更快止损,减少大亏'],
                        ['short_tp', '空头止盈', '+80%', '+60%', '降低20%', '配合分段TP,更早全仓止盈'],
                        ['long_sl', '多头止损', '-15%', '-8%', '大幅收紧7%', '多头快速止损,减少逆势损失'],
                        ['long_tp', '多头止盈', '+50%', '+30%', '降低20%', '配合分段TP,更快锁定利润'],
                        ['partial_tp_1', '分段止盈触发点', '无', '20%', '★新增', '盈利20%时触发第一段止盈'],
                        ['partial_tp_1_pct', '分段止盈比例', '无', '30%', '★新增', '先平30%仓位锁定利润'],
                        ['short_trail', '追踪止盈', '25%', '25%', '不变', '利润达25%后开始追踪'],
                        ['trail_pullback', '回撤平仓', '60%', '60%', '不变', '利润从高点回撤40%平仓'],
                        ['short_max_hold', '最大持仓', '72h', '72h', '不变', '超时强制平仓'],
                        ['cooldown', '冷却期', '4h', '4h', '不变', '平仓后等待时间'],
                    ];
                    const tbody = document.getElementById('params-tbody');
                    params.forEach(p => {
                        const changed = p[4] !== '不变';
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid var(--border)';
                        tr.innerHTML = `
                            <td style="padding:8px 12px;font-weight:500">${p[1]}</td>
                            <td style="text-align:center;padding:8px 12px;color:var(--text-secondary)">${p[2]}</td>
                            <td style="text-align:center;padding:8px 12px;font-weight:600;${changed?'color:#00d68f':''}">${p[3]}</td>
                            <td style="text-align:center;padding:8px 12px;color:${changed?'#00d68f':'var(--text-tertiary)'};font-size:12px">${p[4]}</td>
                            <td style="padding:8px 12px;font-size:12px;color:var(--text-secondary)">${p[5]}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // 交易明细
                    const trades = data.global_best_trades || [];
                    const tradeBody = document.querySelector('#trade-detail-table tbody');
                    trades.forEach((t, i) => {
                        const action = t.action || '';
                        const isPartial = action.includes('分段');
                        const isOpen = action.includes('OPEN') || action.includes('开');
                        const isClose = action.includes('CLOSE') || action.includes('止');
                        const isBuy = action.includes('BUY');
                        const isSell = action.includes('SELL') && !action.includes('分段');
                        let color = 'var(--text-primary)';
                        if (isPartial) color = '#a855f7';
                        else if (isOpen) color = '#4a9eff';
                        else if (isClose) color = '#ffaa00';
                        else if (isBuy) color = '#00d68f';
                        else if (isSell) color = '#ff4d6a';

                        const pnl = t.pnl || 0;
                        let pnlStr = '';
                        if (pnl > 0) pnlStr = `<span style="color:#00d68f">+$${pnl.toLocaleString()}</span>`;
                        else if (pnl < 0) pnlStr = `<span style="color:#ff4d6a">-$${Math.abs(pnl).toLocaleString()}</span>`;

                        // 从reason中提取PnL
                        const reason = t.reason || '';
                        if (!pnlStr && reason.includes('PnL=')) {
                            const m = reason.match(/PnL=([+-]?\d+)/);
                            if (m) {
                                const v = parseInt(m[1]);
                                if (v > 0) pnlStr = `<span style="color:#00d68f">+$${v.toLocaleString()}</span>`;
                                else if (v < 0) pnlStr = `<span style="color:#ff4d6a">$${v.toLocaleString()}</span>`;
                            }
                        }

                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid var(--border)';
                        if (isPartial) tr.style.background = 'rgba(168,85,247,0.04)';
                        tr.innerHTML = `
                            <td style="padding:4px 8px;color:var(--text-tertiary)">${i+1}</td>
                            <td style="padding:4px 8px;font-size:11px">${(t.time||'').substring(0,16)}</td>
                            <td style="padding:4px 8px;color:${color};font-weight:500">${action}</td>
                            <td style="padding:4px 8px;text-align:right">$${(t.price||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                            <td style="padding:4px 8px;text-align:center">${t.leverage||'-'}x</td>
                            <td style="padding:4px 8px;text-align:right">${pnlStr}</td>
                            <td style="padding:4px 8px;font-size:11px;color:var(--text-secondary)">${(reason).substring(0,55)}</td>
                        `;
                        tradeBody.appendChild(tr);
                    });

                    // 资金曲线
                    const history = data.global_best_history || [];
                    if (history.length > 0) drawOptEquity(history);
                });
            });

            function drawOptEquity(history) {
                const svg = document.getElementById('opt-equity-chart');
                const W = 900, H = 400, pad = {t:30,r:40,b:40,l:70};
                const plotW = W - pad.l - pad.r;
                const plotH = H - pad.t - pad.b;

                const totals = history.map(h => h.total || 0);
                // 用起始total和ETH价格计算BH
                const startTotal = history[0]?.total || 200000;
                const startPrice = history[0]?.eth_price || 1;
                const bhs = history.map(h => {
                    const ethPrice = h.eth_price || startPrice;
                    return 100000 + (100000 / startPrice) * ethPrice;
                });

                const allV = [...totals, ...bhs];
                const maxV = Math.max(...allV) * 1.05;
                const minV = Math.min(...allV) * 0.95;
                const range = maxV - minV || 1;

                let html = '';
                for (let i = 0; i <= 5; i++) {
                    const val = minV + (range * i / 5);
                    const y = pad.t + plotH - (plotH * i / 5);
                    html += `<line x1="${pad.l}" y1="${y}" x2="${W-pad.r}" y2="${y}" stroke="rgba(255,255,255,0.05)"/>`;
                    html += `<text x="${pad.l-8}" y="${y+4}" fill="rgba(255,255,255,0.4)" font-size="11" text-anchor="end">$${(val/1000).toFixed(0)}k</text>`;
                }

                // BH line
                let bhPath = '';
                history.forEach((h, i) => {
                    const x = pad.l + (i / Math.max(1, history.length - 1)) * plotW;
                    const y = pad.t + plotH - ((bhs[i] - minV) / range) * plotH;
                    bhPath += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });
                html += `<path d="${bhPath}" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.5"/>`;

                // Strategy fill
                let fillPath = `M${pad.l},${pad.t + plotH}`;
                history.forEach((h, i) => {
                    const x = pad.l + (i / Math.max(1, history.length - 1)) * plotW;
                    const y = pad.t + plotH - ((totals[i] - minV) / range) * plotH;
                    fillPath += `L${x},${y}`;
                });
                fillPath += `L${pad.l + plotW},${pad.t + plotH}Z`;
                html += `<path d="${fillPath}" fill="url(#grad)" opacity="0.3"/>`;

                // Strategy line
                let stratPath = '';
                history.forEach((h, i) => {
                    const x = pad.l + (i / Math.max(1, history.length - 1)) * plotW;
                    const y = pad.t + plotH - ((totals[i] - minV) / range) * plotH;
                    stratPath += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });
                html += `<defs><linearGradient id="grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgb(0,214,143)" stop-opacity="0.4"/><stop offset="100%" stop-color="rgb(0,214,143)" stop-opacity="0"/></linearGradient></defs>`;
                html += `<path d="${stratPath}" fill="none" stroke="rgb(0,214,143)" stroke-width="2.5"/>`;

                // Labels
                const lastTotal = totals[totals.length-1];
                const lastBH = bhs[bhs.length-1];
                const lastX = pad.l + plotW;
                html += `<text x="${lastX+5}" y="${pad.t + plotH - ((lastTotal - minV) / range) * plotH}" fill="#00d68f" font-size="11" font-weight="600">$${(lastTotal/1000).toFixed(0)}k</text>`;
                html += `<text x="${lastX+5}" y="${pad.t + plotH - ((lastBH - minV) / range) * plotH}" fill="rgba(255,255,255,0.5)" font-size="11">$${(lastBH/1000).toFixed(0)}k</text>`;

                // Legend
                html += `<rect x="${pad.l+10}" y="${pad.t+5}" width="12" height="3" fill="rgb(0,214,143)"/>`;
                html += `<text x="${pad.l+26}" y="${pad.t+10}" fill="rgba(255,255,255,0.7)" font-size="11">分段TP策略 +68.28%</text>`;
                html += `<rect x="${pad.l+160}" y="${pad.t+5}" width="12" height="3" fill="rgba(255,255,255,0.2)"/>`;
                html += `<text x="${pad.l+176}" y="${pad.t+10}" fill="rgba(255,255,255,0.5)" font-size="11">买入持有 -18.37%</text>`;

                svg.innerHTML = html;
            }
            </script>
{% endblock %}
