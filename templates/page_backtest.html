{% extends "base.html" %}
{% block title %}backtest-summary - 技术分析平台{% endblock %}
{% block head_extra %}
<script src="/static/js/lightweight-charts.standalone.production.js" defer></script>
{% endblock %}

{% block content %}
            <div class="page-title">ETH/USDT 回测摘要</div>
            <div class="page-subtitle">10分钟K线 · 币安现货 · 背离/背驰策略</div>

            <div id="summary-loading" class="loading">
                <div class="spinner"></div>
                正在加载回测数据...
            </div>

            <div id="summary-content" style="display:none;">
                <div class="stats-grid" id="stats-grid"></div>

                <div class="card">
                    <div class="card-title">策略说明</div>
                    <div class="principle-grid">
                        <div class="principle-card sell">
                            <h3>卖出信号</h3>
                            <p>
                                • 综合顶背离评分 ≥ 45<br>
                                • 背驰卖出信号 (最高优先级)<br>
                                • 止损: -5% / 止盈: +8%<br>
                                • 遵循 "卖点用背离, 宁早勿晚"
                            </p>
                        </div>
                        <div class="principle-card buy">
                            <h3>买入信号</h3>
                            <p>
                                • 综合底背离评分 ≥ 65<br>
                                • 背驰买入信号 (最高优先级)<br>
                                • 冷却期: 30根K线 (5小时)<br>
                                • 遵循 "买点用背驰, 宁迟勿早"
                            </p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>资产曲线</h3>
                        <span style="font-size:12px;color:var(--text-muted);">蓝线=策略净值 | 基准=ETH买入持有</span>
                    </div>
                    <div id="equity-chart"></div>
                </div>
            </div>

            <div class="page-title">K线图与交易信号</div>
            <div class="page-subtitle">ETH/USDT 10分钟K线 · 买卖点标注</div>

            <div id="chart-loading" class="loading">
                <div class="spinner"></div>
                正在加载图表数据...
            </div>

            <div id="chart-content" style="display:none;">
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <h3>ETH/USDT · 10分钟</h3>
                    </div>
                    <div id="kline-chart"></div>
                </div>
            </div>

            <div class="page-title">交易明细</div>
            <div class="page-subtitle">完整交易记录 (买入-卖出配对)</div>

            <div id="trades-loading" class="loading">
                <div class="spinner"></div>
                正在加载交易数据...
            </div>

            <div id="trades-content" style="display:none;">
                <div class="stats-grid" id="trade-stats"></div>
                <div class="card">
                    <div class="card-title">交易记录</div>
                    <div class="trade-table-wrap">
                        <table id="trades-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>买入时间</th>
                                    <th>买入价</th>
                                    <th>卖出时间</th>
                                    <th>卖出价</th>
                                    <th>盈亏(USDT)</th>
                                    <th>盈亏%</th>
                                    <th>买入原因</th>
                                    <th>卖出原因</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
{% endblock %}

{% block scripts %}
<script>
const INTERVALS = ['10m','15m','30m','1h','2h','3h','4h','6h','8h','16h','24h','32h'];
const INTERVAL_LABELS = {'10m':'10分钟','15m':'15分钟','30m':'30分钟','1h':'1小时','2h':'2小时','3h':'3小时','4h':'4小时','6h':'6小时','8h':'8小时','16h':'16小时','24h':'24小时','32h':'32小时'};
const COLORS = ['#4a9eff','#ff4d6a','#00d68f','#ffaa00','#a855f7','#06b6d4','#f43f5e','#84cc16','#ec4899','#f97316','#8b5cf6','#14b8a6'];
function fmtDate(d) { return d ? d.toString().substring(0,16) : ''; }

    // ========================================
    //   Single Interval Detail (existing)
    // ========================================
    let btData = null;

    async function loadBacktestData() {
        if (window._backtestLoaded) return;
        try {
            const resp = await fetch('/api/backtest');
            if (!resp.ok) throw new Error('No data');
            btData = await resp.json();
            window._backtestLoaded = true;
            renderSummary();
            renderEquityChart();
            renderKlineChart();
            renderTrades();
        } catch (e) {
            ['summary-loading','chart-loading','trades-loading'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<span style="color:var(--accent-red)">未找到回测数据。请先运行: python backtest.py</span>';
            });
        }
    }

    function renderSummary() {
        const s = btData.summary;
        document.getElementById('summary-loading').style.display = 'none';
        document.getElementById('summary-content').style.display = 'block';

        const statsHtml = [
            {label: '策略收益', value: s.total_return + '%', cls: s.total_return >= 0 ? 'positive' : 'negative'},
            {label: '买入持有收益', value: s.buy_hold_return + '%', cls: s.buy_hold_return >= 0 ? 'positive' : 'negative'},
            {label: '最终资金', value: '$' + s.final_equity.toLocaleString(), cls: s.final_equity >= s.initial_capital ? 'positive' : 'negative'},
            {label: '最大回撤', value: s.max_drawdown + '%', cls: 'negative'},
            {label: '交易次数', value: s.total_trades, cls: ''},
            {label: '胜率', value: s.win_rate + '%', cls: s.win_rate >= 50 ? 'positive' : 'negative', note: s.win_count + '胜 / ' + s.lose_count + '负'},
            {label: '平均盈利', value: '+' + s.avg_win_pct + '%', cls: 'positive'},
            {label: '平均亏损', value: s.avg_loss_pct + '%', cls: 'negative'},
            {label: 'Sharpe比率', value: s.sharpe_ratio, cls: s.sharpe_ratio >= 0 ? 'positive' : 'negative'},
            {label: '回测天数', value: s.total_days + '天', cls: ''},
        ].map(item => `
            <div class="stat-card">
                <div class="stat-label">${item.label}</div>
                <div class="stat-value ${item.cls}">${item.value}</div>
                ${item.note ? '<div class="stat-note">' + item.note + '</div>' : ''}
            </div>
        `).join('');
        document.getElementById('stats-grid').innerHTML = statsHtml;
    }

    function renderEquityChart() {
        const container = document.getElementById('equity-chart');
        if (!btData || !btData.equity_curve || !btData.equity_curve.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 300,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const equitySeries = chart.addLineSeries({ color: '#4a9eff', lineWidth: 2, title: '策略净值' });
        equitySeries.setData(btData.equity_curve.map(e => ({
            time: Math.floor(new Date(e.date).getTime() / 1000), value: e.equity,
        })));

        if (btData.kline_data && btData.kline_data.length > 0) {
            const baseline = chart.addLineSeries({ color: '#5c6078', lineWidth: 1, lineStyle: 2, title: '买入持有' });
            const fp = btData.kline_data[0].close;
            const ic = btData.summary.initial_capital;
            baseline.setData(btData.kline_data.map(k => ({
                time: Math.floor(new Date(k.date).getTime() / 1000), value: ic * (k.close / fp),
            })));
        }
        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderKlineChart() {
        const container = document.getElementById('kline-chart');
        document.getElementById('chart-loading').style.display = 'none';
        document.getElementById('chart-content').style.display = 'block';
        if (!btData || !btData.kline_data || !btData.kline_data.length) return;

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 400,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const cs = chart.addCandlestickSeries({
            upColor: '#00d68f', downColor: '#ff4d6a',
            borderUpColor: '#00d68f', borderDownColor: '#ff4d6a',
            wickUpColor: '#00d68f', wickDownColor: '#ff4d6a',
        });
        cs.setData(btData.kline_data.map(k => ({
            time: Math.floor(new Date(k.date).getTime() / 1000),
            open: k.open, high: k.high, low: k.low, close: k.close,
        })));

        if (btData.signals && btData.signals.length > 0) {
            cs.setMarkers(btData.signals.map(s => ({
                time: Math.floor(new Date(s.date).getTime() / 1000),
                position: s.signal === 'BUY' ? 'belowBar' : 'aboveBar',
                color: s.signal === 'BUY' ? '#00d68f' : '#ff4d6a',
                shape: s.signal === 'BUY' ? 'arrowUp' : 'arrowDown',
                text: s.signal === 'BUY' ? 'B' : 'S',
            })));
        }

        const vs = chart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'vol' });
        chart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.85, bottom: 0 } });
        vs.setData(btData.kline_data.map(k => ({
            time: Math.floor(new Date(k.date).getTime() / 1000), value: k.volume,
            color: k.close >= k.open ? 'rgba(0,214,143,0.3)' : 'rgba(255,77,106,0.3)',
        })));

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderTrades() {
        document.getElementById('trades-loading').style.display = 'none';
        document.getElementById('trades-content').style.display = 'block';
        if (!btData || !btData.completed_trades) return;

        const trades = btData.completed_trades;
        const totalPnl = trades.reduce((s, t) => s + t.pnl, 0);
        const best = trades.length ? trades.reduce((b, t) => t.pnl_pct > b.pnl_pct ? t : b, trades[0]) : {pnl_pct:0};
        const worst = trades.length ? trades.reduce((w, t) => t.pnl_pct < w.pnl_pct ? t : w, trades[0]) : {pnl_pct:0};

        document.getElementById('trade-stats').innerHTML = [
            {label:'总盈亏', value:'$'+totalPnl.toFixed(2), cls:totalPnl>=0?'positive':'negative'},
            {label:'最佳交易', value:'+'+(best.pnl_pct||0).toFixed(2)+'%', cls:'positive'},
            {label:'最差交易', value:(worst.pnl_pct||0).toFixed(2)+'%', cls:'negative'},
            {label:'完成交易', value:trades.length, cls:''},
        ].map(item=>`<div class="stat-card"><div class="stat-label">${item.label}</div><div class="stat-value ${item.cls}">${item.value}</div></div>`).join('');

        document.querySelector('#trades-table tbody').innerHTML = trades.map((t,i)=>`
            <tr>
                <td>${i+1}</td>
                <td>${fmtDate(t.buy_date)}</td><td>$${t.buy_price.toFixed(2)}</td>
                <td>${fmtDate(t.sell_date)}</td><td>$${t.sell_price.toFixed(2)}</td>
                <td class="${t.pnl>=0?'pnl-pos':'pnl-neg'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</td>
                <td class="${t.pnl_pct>=0?'pnl-pos':'pnl-neg'}">${t.pnl_pct>=0?'+':''}${t.pnl_pct.toFixed(2)}%</td>
                <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.buy_reason||''}">${t.buy_reason||'-'}</td>
                <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.sell_reason||''}">${t.sell_reason||'-'}</td>
            </tr>`).join('');
    }

    function fmtDate(s) {
        if (!s) return '-';
        const d = new Date(s);
        return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }


// Auto-load on page ready
document.addEventListener('DOMContentLoaded', function() {
    loadBacktestData();
});
</script>
{% endblock %}
