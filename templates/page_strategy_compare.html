{% extends "base.html" %}
{% block title %}strategy-compare - æŠ€æœ¯åˆ†æå¹³å°{% endblock %}

{% block content %}
            <div class="page-title">ç­–ç•¥ä¼˜åŒ–å¯¹æ¯”å®éªŒ</div>
            <div class="page-subtitle">6ç§ç­–ç•¥æ€è·¯ + 12ç§å‚æ•°å˜ä½“ Â· å¯»æ‰¾æœ€ä¼˜ç­–ç•¥é…ç½®</div>

            <div id="sc-loading" class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½ç­–ç•¥å¯¹æ¯”æ•°æ®...
            </div>

            <div id="sc-content" style="display:none;">
                <!-- ç¬¬ä¸€éƒ¨åˆ†: 6å¤§ç­–ç•¥å¯¹æ¯” -->
                <div class="card">
                    <div class="card-title">6å¤§ç­–ç•¥æ€è·¯å¯¹æ¯” <span class="badge purple">Phase 1</span></div>
                    <div class="page-subtitle" style="margin-bottom:16px;">ç›¸åŒæ•°æ®ã€ç›¸åŒåˆå§‹èµ„é‡‘(10ä¸‡USDT+10ä¸‡ETH)ï¼Œæµ‹è¯•6ç§ä¸åŒç­–ç•¥é€»è¾‘</div>

                    <!-- ç­–ç•¥è¯´æ˜å¡ç‰‡ -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="sc-strategy-cards"></div>

                    <!-- è¶…é¢æ”¶ç›Šå¯¹æ¯”æŸ±çŠ¶å›¾ -->
                    <div id="sc-bar-chart" style="width:100%;min-height:320px;margin-bottom:20px;"></div>

                    <!-- å¯¹æ¯”è¡¨æ ¼ -->
                    <div class="trade-table-wrap" style="max-height:none;">
                        <table id="sc-table">
                            <thead><tr id="sc-table-head"></tr></thead>
                            <tbody id="sc-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ç¬¬äºŒéƒ¨åˆ†: æœ€ä¼˜ç­–ç•¥å‚æ•°è°ƒä¼˜ -->
                <div class="card">
                    <div class="card-title">æœ€ä¼˜ç­–ç•¥å‚æ•°è°ƒä¼˜ <span class="badge green">Phase 2</span></div>
                    <div class="page-subtitle" style="margin-bottom:16px;">åŸºäºæœ€ä¼˜ç­–ç•¥(æ¸è¿›å‡ä»“)ï¼Œæµ‹è¯•12ç§å‚æ•°ç»„åˆå¯»æ‰¾æœ€ä¼˜é…ç½®</div>

                    <!-- ä¼˜åŒ–å˜ä½“æŸ±çŠ¶å›¾ -->
                    <div id="sc-opt-bar" style="width:100%;min-height:360px;margin-bottom:20px;"></div>

                    <!-- ä¼˜åŒ–å˜ä½“è¡¨æ ¼ -->
                    <div class="trade-table-wrap" style="max-height:none;">
                        <table id="sc-opt-table">
                            <thead><tr id="sc-opt-head"></tr></thead>
                            <tbody id="sc-opt-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- èµ„äº§æ›²çº¿å¯¹æ¯” -->
                <div class="card">
                    <div class="card-title">TOPç­–ç•¥èµ„äº§æ›²çº¿å¯¹æ¯”</div>
                    <div id="sc-equity-chart" style="width:100%;height:380px;"></div>
                </div>

                <!-- æœ€ç»ˆç»“è®º -->
                <div class="card" id="sc-conclusion"></div>

                <!-- ç¬¬ä¸‰éƒ¨åˆ†: æ·±åº¦æŒ‡æ ‡å¢å¼º -->
                <div id="se-section" style="display:none;">
                    <div class="card">
                        <div class="card-title">æ·±åº¦æŒ‡æ ‡å¢å¼ºç­–ç•¥ <span class="badge" style="background:rgba(255,77,106,0.15);color:var(--accent-red);">Phase 3 Â· å…¨æŒ‡æ ‡</span></div>
                        <div class="page-subtitle" style="margin-bottom:16px;">
                            å……åˆ†åˆ©ç”¨ä¹¦ä¸­ç¬¬äºŒ~äº”ç« çš„æ‰€æœ‰ç»†ç²’åº¦æŒ‡æ ‡ï¼šMACDé‡‘å‰æ­»å‰ã€KDJè¶…ä¹°è¶…å–ã€CCIå¤©åœ°çº¿ã€RSIæå€¼ã€é‡ä»·èƒŒç¦»ã€å‡ ä½•å½¢æ€
                        </div>

                        <!-- ç­–ç•¥è¯´æ˜ -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="se-strategy-cards"></div>

                        <!-- æŸ±çŠ¶å›¾ -->
                        <div id="se-bar-chart" style="width:100%;min-height:320px;margin-bottom:20px;"></div>

                        <!-- è¡¨æ ¼ -->
                        <div class="trade-table-wrap" style="max-height:none;">
                            <table id="se-table">
                                <thead><tr id="se-table-head"></tr></thead>
                                <tbody id="se-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- èµ„äº§æ›²çº¿å¯¹æ¯” -->
                    <div class="card">
                        <div class="card-title">å¢å¼ºç­–ç•¥èµ„äº§æ›²çº¿</div>
                        <div id="se-equity-chart" style="width:100%;height:380px;"></div>
                    </div>

                    <!-- æœ€ä½³ç­–ç•¥äº¤æ˜“æ˜ç»† -->
                    <div class="card">
                        <div class="card-title">æœ€ä½³ç­–ç•¥äº¤æ˜“æ˜ç»† <span class="badge green" id="se-trade-count"></span></div>
                        <div class="trade-table-wrap" style="max-height:500px;">
                            <table id="se-trades-table">
                                <thead>
                                    <tr>
                                        <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>ä»·æ ¼</th>
                                        <th>æ•°é‡</th><th>é‡‘é¢</th><th>æ‰‹ç»­è´¹</th>
                                        <th>USDTä½™é¢</th><th>ETHæŒä»“</th><th>æ€»èµ„äº§</th><th>åŸå› </th>
                                    </tr>
                                </thead>
                                <tbody id="se-trades-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ç»ˆæç»“è®º -->
                    <div class="card" id="se-conclusion"></div>
                </div>
            </div>
{% endblock %}

{% block scripts %}
<script>
const INTERVALS = ['10m','15m','30m','1h','2h','3h','4h','6h','8h','16h','24h','32h'];
const INTERVAL_LABELS = {'10m':'10åˆ†é’Ÿ','15m':'15åˆ†é’Ÿ','30m':'30åˆ†é’Ÿ','1h':'1å°æ—¶','2h':'2å°æ—¶','3h':'3å°æ—¶','4h':'4å°æ—¶','6h':'6å°æ—¶','8h':'8å°æ—¶','16h':'16å°æ—¶','24h':'24å°æ—¶','32h':'32å°æ—¶'};
const COLORS = ['#4a9eff','#ff4d6a','#00d68f','#ffaa00','#a855f7','#06b6d4','#f43f5e','#84cc16','#ec4899','#f97316','#8b5cf6','#14b8a6'];
function fmtDate(d) { return d ? d.toString().substring(0,16) : ''; }

    // ========================================
    //   Strategy Compare & Optimize
    // ========================================
    let scData = null;
    let scOptData = null;

    async function loadStrategyCompare() {
        if (window._scLoaded) return;
        try {
            const [r1, r2] = await Promise.all([
                fetch('/api/strategy_compare'),
                fetch('/api/strategy_optimize'),
            ]);
            if (!r1.ok || !r2.ok) throw new Error('No data');
            scData = await r1.json();
            scOptData = await r2.json();
            window._scLoaded = true;
            renderSCPage();
            document.getElementById('sc-loading').style.display = 'none';
            document.getElementById('sc-content').style.display = 'block';
            // Also load enhanced strategies
            loadEnhancedStrategy();
        } catch (e) {
            document.getElementById('sc-loading').innerHTML =
                '<span style="color:var(--accent-red)">æœªæ‰¾åˆ°ç­–ç•¥å¯¹æ¯”æ•°æ®ã€‚è¯·å…ˆè¿è¡Œ python strategy_compare.py && python strategy_optimize.py</span>';
        }
    }

    function renderSCPage() {
        renderSCCards();
        renderSCBarChart();
        renderSCTable();
        renderSCOptBar();
        renderSCOptTable();
        renderSCEquity();
        renderSCConclusion();
    }

    function renderSCCards() {
        const strategies = scData.strategies || [];
        const descriptions = {
            'A: å¤šå‘¨æœŸèåˆ (baseline)': { icon: 'ğŸ”€', desc: 'å¤šå‘¨æœŸä¿¡å·åŠ æƒèåˆï¼Œç»¼åˆå¤šä¸ªæ—¶é—´æ¡†æ¶çš„èƒŒç¦»/èƒŒé©°ä¿¡å·åšå†³ç­–', color: '#4a9eff' },
            'B: 4hä¸“æ³¨ç­–ç•¥': { icon: 'ğŸ¯', desc: 'åªä½¿ç”¨4hå‘¨æœŸä¿¡å·ï¼Œæœ€ä¼˜å•å‘¨æœŸä¸“æ³¨æ“ä½œï¼Œé«˜é˜ˆå€¼+é•¿å†·å´æœŸ', color: '#a855f7' },
            'C: è¶‹åŠ¿è·Ÿéšé˜²å¾¡': { icon: 'ğŸ“‰', desc: 'MA50åˆ¤æ–­è¶‹åŠ¿æ–¹å‘ï¼Œä¸‹è·Œåªå–ä¸ä¹°ï¼Œä¸Šæ¶¨è¶‹åŠ¿ä¸­æ‰è€ƒè™‘ä¹°å…¥', color: '#f97316' },
            'D: ä¿å®ˆé«˜é˜ˆå€¼': { icon: 'ğŸ›¡ï¸', desc: 'æé«˜ä¿¡å·é˜ˆå€¼(å…±æŒ¯å¾—åˆ†â‰¥55/60)ï¼Œ36å°æ—¶å†·å´æœŸï¼Œåªåšç¡®å®šæ€§æœ€é«˜çš„äº¤æ˜“', color: '#06b6d4' },
            'E: æ¸è¿›å‡ä»“': { icon: 'â¬‡ï¸', desc: 'æ ¹æ®èƒŒç¦»å¼ºåº¦é€æ­¥å–å‡ºETHï¼Œä¿ç•™10%åº•ä»“ï¼Œåªåœ¨å¼ºèƒŒé©°ä¿¡å·ä¹°å›', color: '#00d68f' },
            'F: åŠ¨æ€å†å¹³è¡¡': { icon: 'âš–ï¸', desc: 'æ ¹æ®èƒŒç¦»ä¿¡å·åŠ¨æ€è°ƒæ•´ETHç›®æ ‡æ¯”ä¾‹(10%~70%)ï¼Œåå·®>8%æ—¶å†å¹³è¡¡', color: '#ffaa00' },
        };

        const container = document.getElementById('sc-strategy-cards');
        container.innerHTML = strategies.map(s => {
            const d = descriptions[s.name] || { icon: 'ğŸ“Š', desc: '', color: '#4a9eff' };
            const alpha = s.summary.alpha;
            const alphaColor = alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            return `<div style="padding:16px;border-radius:10px;border:1px solid var(--border);border-top:3px solid ${d.color};">
                <div style="font-size:20px;margin-bottom:8px;">${d.icon}</div>
                <div style="font-weight:600;font-size:14px;margin-bottom:6px;">${s.name}</div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin-bottom:10px;">${d.desc}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;color:var(--text-muted);">${s.summary.total_trades}ç¬”äº¤æ˜“</span>
                    <span style="font-size:16px;font-weight:700;color:${alphaColor};">${alpha >= 0 ? '+' : ''}${alpha.toFixed(2)}%</span>
                </div>
            </div>`;
        }).join('');
    }

    function renderSCBarChart() {
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const container = document.getElementById('sc-bar-chart');
        const maxAbs = Math.max(...strategies.map(s => Math.abs(s.summary.alpha)), 1);
        const barColors = ['#00d68f', '#06b6d4', '#ffaa00', '#a855f7', '#4a9eff', '#ff4d6a'];

        const barH = 220;
        let html = '<div style="position:relative;height:' + (barH + 60) + 'px;display:flex;align-items:center;">';
        html += '<div style="display:flex;flex-direction:column;justify-content:space-between;height:' + barH + 'px;padding-right:8px;font-size:11px;color:var(--text-muted);width:50px;text-align:right;">';
        html += '<span>+' + maxAbs.toFixed(0) + '%</span><span>0%</span><span>-' + maxAbs.toFixed(0) + '%</span></div>';
        html += '<div style="flex:1;display:flex;align-items:center;height:' + barH + 'px;position:relative;">';
        html += '<div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--text-muted);opacity:0.3;"></div>';
        html += '<div style="display:flex;align-items:center;height:100%;width:100%;justify-content:space-around;">';

        strategies.forEach((s, i) => {
            const alpha = s.summary.alpha;
            const h = Math.abs(alpha / maxAbs) * (barH / 2 - 10);
            const isPos = alpha >= 0;
            const color = barColors[i % barColors.length];
            const valColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';
            const shortName = s.name.split(':')[1] || s.name;

            html += '<div style="display:flex;flex-direction:column;align-items:center;flex:1;max-width:130px;height:100%;justify-content:center;position:relative;">';
            if (isPos) {
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:50%;">';
                html += '<span style="font-size:12px;font-weight:700;color:' + valColor + ';margin-bottom:3px;">' + (alpha >= 0 ? '+' : '') + alpha.toFixed(2) + '%</span>';
                html += '<div style="width:48px;height:' + h + 'px;background:' + color + ';border-radius:6px 6px 0 0;opacity:0.85;"></div>';
                html += '</div><div style="height:50%;"></div>';
            } else {
                html += '<div style="height:50%;"></div>';
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:50%;">';
                html += '<div style="width:48px;height:' + h + 'px;background:' + color + ';border-radius:0 0 6px 6px;opacity:0.85;"></div>';
                html += '<span style="font-size:12px;font-weight:700;color:' + valColor + ';margin-top:3px;">' + alpha.toFixed(2) + '%</span>';
                html += '</div>';
            }
            html += '<div style="position:absolute;bottom:-28px;font-size:11px;color:var(--text-muted);white-space:nowrap;text-align:center;">' + shortName.trim() + '</div>';
            html += '</div>';
        });

        html += '</div></div></div>';
        container.innerHTML = html;
    }

    function renderSCTable() {
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        let headHtml = '<th style="text-align:left;">æ’å</th><th style="text-align:left;">ç­–ç•¥</th>';
        headHtml += '<th>ç­–ç•¥æ”¶ç›Š</th><th>ä¹°å…¥æŒæœ‰</th><th>è¶…é¢æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>äº¤æ˜“æ•°</th><th>æœ€ç»ˆèµ„äº§</th>';
        document.getElementById('sc-table-head').innerHTML = headHtml;

        const tbody = document.getElementById('sc-table-body');
        tbody.innerHTML = strategies.map((s, i) => {
            const sm = s.summary;
            const isBest = i === 0;
            const rowStyle = isBest ? 'background:rgba(0,214,143,0.05);' : '';
            const rankBadge = i < 3 ? `<span class="rank-badge rank-${i+1}">${i+1}</span>` : `<span style="padding:0 8px;color:var(--text-muted);">${i+1}</span>`;
            const alphaColor = sm.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const retColor = sm.strategy_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            return `<tr style="${rowStyle}">
                <td>${rankBadge}</td>
                <td style="text-align:left;font-weight:${isBest?'700':'500'};">${s.name}${isBest?' â˜…':''}</td>
                <td style="color:${retColor};font-weight:600;">${sm.strategy_return >= 0 ? '+' : ''}${sm.strategy_return}%</td>
                <td style="color:var(--text-muted);">${sm.buy_hold_return}%</td>
                <td style="color:${alphaColor};font-weight:700;">${sm.alpha >= 0 ? '+' : ''}${sm.alpha}%</td>
                <td style="color:var(--accent-red);">${sm.max_drawdown}%</td>
                <td>${sm.total_trades}</td>
                <td style="font-weight:600;">$${sm.final_total.toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    function renderSCOptBar() {
        const results = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const container = document.getElementById('sc-opt-bar');
        const maxAbs = Math.max(...results.map(r => Math.abs(r.summary.alpha)), 1);

        const barH = 260;
        let html = '<div style="position:relative;height:' + (barH + 70) + 'px;display:flex;align-items:center;">';
        html += '<div style="display:flex;flex-direction:column;justify-content:space-between;height:' + barH + 'px;padding-right:8px;font-size:11px;color:var(--text-muted);width:50px;text-align:right;">';
        html += '<span>+' + maxAbs.toFixed(0) + '%</span><span>0%</span><span>-' + maxAbs.toFixed(0) + '%</span></div>';
        html += '<div style="flex:1;display:flex;align-items:center;height:' + barH + 'px;position:relative;overflow-x:auto;">';
        html += '<div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--text-muted);opacity:0.3;"></div>';
        html += '<div style="display:flex;align-items:center;height:100%;min-width:100%;justify-content:space-around;">';

        const optColors = results.map((r, i) => {
            const a = r.summary.alpha;
            if (a >= 8) return '#00d68f';
            if (a >= 5) return '#06b6d4';
            if (a >= 2) return '#4a9eff';
            if (a >= 0) return '#ffaa00';
            return '#ff4d6a';
        });

        results.forEach((r, i) => {
            const alpha = r.summary.alpha;
            const h = Math.abs(alpha / maxAbs) * (barH / 2 - 15);
            const isPos = alpha >= 0;
            const color = optColors[i];
            const valColor = isPos ? 'var(--accent-green)' : 'var(--accent-red)';
            const label = r.name.split(':')[0];

            html += '<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:55px;max-width:80px;height:100%;justify-content:center;position:relative;">';
            if (isPos) {
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:50%;">';
                html += '<span style="font-size:10px;font-weight:700;color:' + valColor + ';margin-bottom:2px;">' + (alpha >= 0 ? '+' : '') + alpha.toFixed(1) + '%</span>';
                html += '<div style="width:28px;height:' + h + 'px;background:' + color + ';border-radius:4px 4px 0 0;opacity:0.85;"></div>';
                html += '</div><div style="height:50%;"></div>';
            } else {
                html += '<div style="height:50%;"></div>';
                html += '<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:50%;">';
                html += '<div style="width:28px;height:' + h + 'px;background:' + color + ';border-radius:0 0 4px 4px;opacity:0.85;"></div>';
                html += '<span style="font-size:10px;font-weight:700;color:' + valColor + ';margin-top:2px;">' + alpha.toFixed(1) + '%</span>';
                html += '</div>';
            }
            html += '<div style="position:absolute;bottom:-34px;font-size:10px;color:var(--text-muted);white-space:nowrap;text-align:center;transform:rotate(-15deg);">' + label + '</div>';
            html += '</div>';
        });

        html += '</div></div></div>';
        container.innerHTML = html;
    }

    function renderSCOptTable() {
        const results = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        let headHtml = '<th style="text-align:left;">#</th><th style="text-align:left;">å˜ä½“</th>';
        headHtml += '<th>ç­–ç•¥æ”¶ç›Š</th><th>è¶…é¢æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>äº¤æ˜“æ•°</th><th>æœ€ç»ˆèµ„äº§</th>';
        document.getElementById('sc-opt-head').innerHTML = headHtml;

        const tbody = document.getElementById('sc-opt-body');
        tbody.innerHTML = results.map((r, i) => {
            const sm = r.summary;
            const isBest = i === 0;
            const rowStyle = isBest ? 'background:rgba(0,214,143,0.05);' : (i < 3 ? 'background:rgba(74,158,255,0.03);' : '');
            const alphaColor = sm.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const retColor = sm.strategy_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const medal = i === 0 ? ' ğŸ¥‡' : i === 1 ? ' ğŸ¥ˆ' : i === 2 ? ' ğŸ¥‰' : '';
            return `<tr style="${rowStyle}">
                <td style="font-weight:600;color:var(--text-muted);">${i+1}</td>
                <td style="text-align:left;font-weight:${isBest?'700':'400'};font-size:12px;">${r.name}${medal}</td>
                <td style="color:${retColor};">${sm.strategy_return >= 0 ? '+' : ''}${sm.strategy_return}%</td>
                <td style="color:${alphaColor};font-weight:700;">${sm.alpha >= 0 ? '+' : ''}${sm.alpha}%</td>
                <td style="color:var(--accent-red);">${sm.max_drawdown}%</td>
                <td>${sm.total_trades}</td>
                <td style="font-weight:500;">$${sm.final_total.toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    function renderSCEquity() {
        const container = document.getElementById('sc-equity-chart');

        const chart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 380,
            layout: { background: { color: '#1e2130' }, textColor: '#8b8fa3' },
            grid: { vertLines: { color: '#2a2d3e' }, horzLines: { color: '#2a2d3e' } },
            crosshair: { mode: 0 },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        // Show top 6 optimization variants
        const results = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const topN = results.slice(0, 6);
        const eqColors = ['#00d68f', '#06b6d4', '#4a9eff', '#ffaa00', '#a855f7', '#f43f5e'];

        topN.forEach((r, i) => {
            const hist = r.history || [];
            if (hist.length < 2) return;
            const line = chart.addLineSeries({
                color: eqColors[i],
                lineWidth: i === 0 ? 3 : 1,
                title: r.name.split(':')[0],
            });
            line.setData(hist.map(h => ({
                time: Math.floor(new Date(h.time).getTime() / 1000),
                value: h.total,
            })));
        });

        // Also show strategies from phase 1
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        if (strategies.length > 0) {
            const bestS = strategies[0];
            const hist = bestS.history || [];
            if (hist.length >= 2) {
                const line = chart.addLineSeries({
                    color: '#5c6078', lineWidth: 1, lineStyle: 2,
                    title: 'ä¹°å…¥æŒæœ‰(å‚è€ƒ)',
                });
                // Approximate buy-hold using first and last points
                const initT = bestS.summary.initial_total;
                const bhRet = bestS.summary.buy_hold_return / 100;
                const startV = initT;
                const endV = initT * (1 + bhRet);
                const startTime = Math.floor(new Date(hist[0].time).getTime() / 1000);
                const endTime = Math.floor(new Date(hist[hist.length-1].time).getTime() / 1000);
                line.setData(hist.map((h, idx) => {
                    const t = Math.floor(new Date(h.time).getTime() / 1000);
                    const progress = (t - startTime) / (endTime - startTime || 1);
                    return { time: t, value: startV + (endV - startV) * progress };
                }));
            }
        }

        chart.timeScale().fitContent();
        new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
    }

    function renderSCConclusion() {
        const strategies = (scData.strategies || []).sort((a, b) => b.summary.alpha - a.summary.alpha);
        const optResults = (scOptData.optimization_results || []).sort((a, b) => b.summary.alpha - a.summary.alpha);

        const bestStrategy = strategies[0];
        const bestOpt = optResults[0];
        const worstOpt = optResults[optResults.length - 1];

        let html = '<div class="conclusion-title">ğŸ”¬ ç­–ç•¥ä¼˜åŒ–ç»“è®º</div>';
        html += '<div class="conclusion-grid">';

        // Finding 1: Best strategy type
        html += '<div class="conclusion-item" style="border-color:var(--accent-green);">';
        html += '<h4 style="color:var(--accent-green);">æœ€ä¼˜ç­–ç•¥æ€è·¯</h4>';
        html += '<p>';
        html += '<strong>' + bestStrategy.name + '</strong> ä»¥è¶…é¢æ”¶ç›Š <strong style="color:var(--accent-green);">' + (bestStrategy.summary.alpha >= 0 ? '+' : '') + bestStrategy.summary.alpha + '%</strong> é¢†å…ˆå…¶ä»–5ç§ç­–ç•¥ã€‚';
        html += '<br><br>';
        html += 'æ ¸å¿ƒé€»è¾‘: åœ¨ä¸‹è·Œè¶‹åŠ¿ä¸­<strong>é€æ­¥å‡ä»“</strong>è€Œéä¸€æ¬¡æ€§æ“ä½œï¼Œ';
        html += 'ä¿ç•™æœ€ä½åº•ä»“(10%)é˜²æ­¢è¸ç©ºï¼Œåªåœ¨å¼ºèƒŒé©°ä¿¡å·å‡ºç°æ—¶æ‰ä¹°å›ã€‚';
        html += '</p></div>';

        // Finding 2: Best optimized variant
        html += '<div class="conclusion-item" style="border-color:var(--accent-blue);">';
        html += '<h4 style="color:var(--accent-blue);">æœ€ä¼˜å‚æ•°é…ç½®</h4>';
        html += '<p>';
        html += '<strong>' + bestOpt.name + '</strong> è¿›ä¸€æ­¥å°†è¶…é¢æ”¶ç›Šæå‡è‡³ <strong style="color:var(--accent-green);">' + (bestOpt.summary.alpha >= 0 ? '+' : '') + bestOpt.summary.alpha + '%</strong>';
        html += 'ï¼Œæœ€å¤§å›æ’¤ <strong>' + bestOpt.summary.max_drawdown + '%</strong> (ä¼˜äºåŸºå‡†)ã€‚';
        html += '<br><br>';
        html += 'å…³é”®å‘ç°: åœ¨ä¸‹è·Œè¡Œæƒ…ä¸­ï¼Œ<strong>"åªå–ä¸ä¹°"</strong>ç­–ç•¥åè€Œè¡¨ç°æœ€å¥½â€”â€”å‡å°‘ä¸ç¡®å®šæ€§ä¹°å…¥ï¼Œè®©åˆ©æ¶¦è‡ªç„¶ç§¯ç´¯ã€‚';
        html += '</p></div>';

        // Finding 3: What doesn't work
        html += '<div class="conclusion-item" style="border-color:var(--accent-red);">';
        html += '<h4 style="color:var(--accent-red);">å¤±æ•ˆç­–ç•¥è­¦ç¤º</h4>';
        html += '<p>';
        const worst = strategies[strategies.length - 1];
        html += '<strong>' + worst.name + '</strong> è¡¨ç°æœ€å·®(è¶…é¢ ' + worst.summary.alpha + '%)ã€‚';
        html += '<br><br>';
        html += 'è¿‡äºé¢‘ç¹çš„å¤šå‘¨æœŸä¿¡å·èåˆåœ¨éœ‡è¡è¡Œæƒ…ä¸­äº§ç”Ÿå¤§é‡<strong>å‡ä¿¡å·</strong>ï¼Œå¯¼è‡´é¢‘ç¹äº¤æ˜“å’Œæ‰‹ç»­è´¹æŸè€—ã€‚';
        html += '<br>æé«˜å–å‡ºé˜ˆå€¼(â‰¥30)æˆ–è¿‡åº¦ä¾èµ–4hå•å‘¨æœŸåŒæ ·æ•ˆæœä¸ä½³ã€‚';
        html += '</p></div>';

        // Finding 4: Actionable insight
        html += '<div class="conclusion-item" style="border-color:var(--accent-yellow);">';
        html += '<h4 style="color:var(--accent-yellow);">å®æ“å»ºè®®</h4>';
        html += '<p>';
        html += 'ğŸ“Œ <strong>ç†Šå¸‚</strong>: æ¸è¿›å‡ä»“ç­–ç•¥(E)æœ€ä¼˜ï¼Œé™ä½æœ€ä½ä»“ä½è‡³5%ï¼Œå–å‡ºå†·å´æœŸ5h';
        html += '<br>ğŸ“Œ <strong>éœ‡è¡å¸‚</strong>: åŠ¨æ€å†å¹³è¡¡(F)æˆ–è¶‹åŠ¿è·Ÿéš(C)æ›´ç¨³å¥';
        html += '<br>ğŸ“Œ <strong>ç‰›å¸‚</strong>: éœ€åå‘ä¼˜åŒ–â€”â€”æ¸è¿›åŠ ä»“ã€é«˜é˜ˆå€¼æ‰å–å‡º';
        html += '<br><br>';
        html += '<span style="color:var(--text-muted);font-size:12px;">âš ï¸ ä»¥ä¸Šç»“è®ºåŸºäºæœ€è¿‘30å¤©ä¸‹è·Œè¡Œæƒ…ï¼Œä¸åŒå¸‚åœºç¯å¢ƒéœ€é‡æ–°éªŒè¯</span>';
        html += '</p></div>';

        html += '</div>';
        document.getElementById('sc-conclusion').innerHTML = html;
    }


// Auto-load on page ready
document.addEventListener('DOMContentLoaded', function() {
    loadStrategyCompare();
});
</script>
{% endblock %}
