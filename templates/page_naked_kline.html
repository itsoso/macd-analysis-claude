{% extends "base.html" %}
{% block title %}è£¸Kçº¿äº¤æ˜“æ³• Â· è®¸ä½³èª{% endblock %}
{% block content %}
<style>
:root {
    --bg-page: #0f1117;
    --bg-card: #1a1d28;
    --bg-card2: #22263a;
    --border: #2a2e42;
    --text: #e8e8f0;
    --text-muted: #8b8fa8;
    --accent: #5b8af5;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f59e0b;
    --purple: #a78bfa;
    --cyan: #06b6d4;
}
.nk-page { padding: 20px; max-width: 1400px; margin: 0 auto; color: var(--text); }
.nk-header { text-align: center; margin-bottom: 32px; }
.nk-header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
.nk-header h1 span { color: var(--accent); }
.nk-header .sub { color: var(--text-muted); font-size: 0.95rem; }
.nk-meta { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 16px 0; }
.nk-badge { background: var(--bg-card2); border: 1px solid var(--border); border-radius: 8px; padding: 6px 14px; font-size: 0.82rem; }
.nk-badge b { color: var(--accent); margin-right: 4px; }

/* å¡ç‰‡ */
.nk-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; }
.nk-card .title { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; }
.nk-card .icon { margin-right: 6px; }

/* æŒ‡æ ‡å¡ç‰‡ç»„ */
.metric-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin: 16px 0; }
.metric-item { background: var(--bg-card2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; text-align: center; }
.metric-item .label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
.metric-item .val { font-size: 1.3rem; font-weight: 700; }
.metric-item .val.pos { color: var(--green); }
.metric-item .val.neg { color: var(--red); }
.metric-item .val.neu { color: var(--orange); }

/* ç« èŠ‚ */
.ch-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 14px; }
.ch-item { background: var(--bg-card2); border-left: 3px solid var(--accent); border-radius: 0 10px 10px 0; padding: 14px 18px; }
.ch-item .ch-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 6px; color: var(--cyan); }
.ch-item .ch-summary { font-size: 0.82rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 8px; }
.ch-item .ch-code { font-size: 0.75rem; color: var(--purple); font-style: italic; }
.ch-item ul { margin: 6px 0 0 16px; font-size: 0.8rem; color: var(--text); }
.ch-item ul li { margin-bottom: 3px; }

/* è¡¨æ ¼ */
.dt { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.dt th { background: var(--bg-card2); position: sticky; top: 0; padding: 8px 6px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.75rem; }
.dt td { padding: 6px; border-bottom: 1px solid var(--border); }
.dt .center { text-align: center; }
.dt tr:hover { background: rgba(91,138,245,0.06); }

/* å›¾è¡¨åŒº */
.chart-box { width: 100%; height: 350px; background: var(--bg-card2); border-radius: 10px; margin: 12px 0; position: relative; }

/* ä¿¡å·æ—¥å† */
.signal-day { display: inline-block; width: 16px; height: 16px; border-radius: 3px; margin: 1px; cursor: pointer; }
.signal-day.long { background: var(--green); }
.signal-day.short { background: var(--red); }
.signal-day.none { background: var(--bg-card2); border: 1px solid var(--border); }
.signal-day:hover { opacity: 0.8; transform: scale(1.3); }

/* loading */
.loading { text-align: center; padding: 60px; color: var(--text-muted); }
.loading .spin { display: inline-block; width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }

details summary { cursor: pointer; }
details summary:hover { color: var(--accent); }
</style>

<div class="nk-page" id="nk-root">
    <div class="loading">
        <div class="spin"></div>
        <div>åŠ è½½è£¸Kçº¿å›æµ‹æ•°æ®...</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const root = document.getElementById('nk-root');
    let data;
    try {
        const resp = await fetch('/api/naked_kline_backtest');
        if (!resp.ok) throw new Error('æœªæ‰¾åˆ°å›æµ‹æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œ python backtest_naked_kline.py');
        data = await resp.json();
    } catch (e) {
        root.innerHTML = `<div class="loading" style="color:var(--red)">âŒ ${e.message}</div>`;
        return;
    }
    if (data.error) {
        root.innerHTML = `<div class="loading" style="color:var(--red)">âŒ ${data.error}</div>`;
        return;
    }

    const m = data.run_meta || {};
    const s = data.summary || {};
    const book = data.book_analysis || {};
    const daily = data.daily_records || [];
    const trades = data.trade_details || [];
    const equity = data.equity_curve || [];
    const patterns = data.pattern_stats || [];
    const sigSummary = data.signal_summary || {};

    const fv = v => v != null ? (typeof v === 'number' ? v.toFixed(2) : v) : '-';
    const cls = v => v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu';

    // â•â•â•â•â•â• Header â•â•â•â•â•â•
    let html = `
    <div class="nk-header">
        <h1>ğŸ“– <span>è£¸Kçº¿äº¤æ˜“æ³•</span> Â· è®¸ä½³èª</h1>
        <div class="sub">çº¯ä»·æ ¼è¡Œä¸º(Price Action)ç­–ç•¥ Â· é›¶æŒ‡æ ‡ Â· ETH/USDT æ—¥çº¿åˆçº¦å›æµ‹</div>
        <div class="nk-meta">
            <span class="nk-badge"><b>ğŸ“…</b> ${m.start_date || ''} ~ ${m.end_date || ''}</span>
            <span class="nk-badge"><b>ğŸ’°</b> åˆå§‹ $${(m.initial_capital||100000).toLocaleString()}</span>
            <span class="nk-badge"><b>âš¡</b> ${m.leverage||3}x æ æ†</span>
            <span class="nk-badge"><b>ğŸ¯</b> å•ç¬”é£é™© ${((m.risk_per_trade||0.02)*100).toFixed(0)}%</span>
            <span class="nk-badge"><b>ğŸ–¥ï¸</b> ${m.runner||''} @ ${m.host||''}</span>
            <span class="nk-badge"><b>ğŸ•</b> ${m.run_time||''}</span>
        </div>
    </div>`;

    // â•â•â•â•â•â• å›æµ‹æ±‡æ€» â•â•â•â•â•â•
    html += `<div class="nk-card"><div class="title"><span class="icon">ğŸ“Š</span> å›æµ‹ç»“æœæ±‡æ€»</div>
    <div class="metric-grid">
        <div class="metric-item"><div class="label">æ€»æ”¶ç›Šç‡</div><div class="val ${cls(s.total_return_pct)}">${fv(s.total_return_pct)}%</div></div>
        <div class="metric-item"><div class="label">å¹´åŒ–æ”¶ç›Šç‡</div><div class="val ${cls(s.annual_return_pct)}">${fv(s.annual_return_pct)}%</div></div>
        <div class="metric-item"><div class="label">æœ€å¤§å›æ’¤</div><div class="val neg">${fv(s.max_drawdown_pct)}%</div></div>
        <div class="metric-item"><div class="label">æ€»äº¤æ˜“æ¬¡æ•°</div><div class="val neu">${s.total_trades || 0}</div></div>
        <div class="metric-item"><div class="label">èƒœç‡</div><div class="val ${s.win_rate_pct >= 50 ? 'pos' : 'neg'}">${fv(s.win_rate_pct)}%</div></div>
        <div class="metric-item"><div class="label">ç›ˆäºæ¯”</div><div class="val ${s.profit_factor >= 1.5 ? 'pos' : 'neu'}">${fv(s.profit_factor)}</div></div>
        <div class="metric-item"><div class="label">æœŸæœ«èµ„é‡‘</div><div class="val">${s.final_capital ? '$'+s.final_capital.toLocaleString() : '-'}</div></div>
        <div class="metric-item"><div class="label">å¹³å‡ç›ˆåˆ©</div><div class="val pos">$${fv(s.avg_win)}</div></div>
        <div class="metric-item"><div class="label">å¹³å‡äºæŸ</div><div class="val neg">$${fv(s.avg_loss)}</div></div>
        <div class="metric-item"><div class="label">æ€»æ‰‹ç»­è´¹</div><div class="val">${s.total_fees ? '$'+s.total_fees.toLocaleString() : '-'}</div></div>
        <div class="metric-item"><div class="label">æ€»æ»‘ç‚¹</div><div class="val">${s.total_slippage ? '$'+s.total_slippage.toLocaleString() : '-'}</div></div>
        <div class="metric-item"><div class="label">èµ„é‡‘è´¹ç‡</div><div class="val">${s.total_funding ? '$'+s.total_funding.toLocaleString() : '-'}</div></div>
    </div></div>`;

    // â•â•â•â•â•â• èµ„é‡‘æ›²çº¿ â•â•â•â•â•â•
    html += `<div class="nk-card">
        <div class="title"><span class="icon">ğŸ“ˆ</span> èµ„é‡‘æ›²çº¿ & ETH ä»·æ ¼</div>
        <div class="chart-box"><canvas id="equityChart"></canvas></div>
    </div>`;

    // â•â•â•â•â•â• ä¿¡å·çƒ­åŠ›å›¾ â•â•â•â•â•â•
    html += `<div class="nk-card">
        <div class="title"><span class="icon">ğŸ—“ï¸</span> æ¯æ—¥ä¿¡å·çƒ­åŠ›å›¾</div>
        <div style="margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">
            <span style="display:inline-block;width:14px;height:14px;background:var(--green);border-radius:3px;vertical-align:middle;margin-right:4px"></span> åšå¤šä¿¡å· &nbsp;
            <span style="display:inline-block;width:14px;height:14px;background:var(--red);border-radius:3px;vertical-align:middle;margin-right:4px"></span> åšç©ºä¿¡å· &nbsp;
            <span style="display:inline-block;width:14px;height:14px;background:var(--bg-card2);border:1px solid var(--border);border-radius:3px;vertical-align:middle;margin-right:4px"></span> æ— ä¿¡å·
        </div>
        <div id="signal-heatmap" style="line-height:0;"></div>
    </div>`;

    // â•â•â•â•â•â• å½¢æ€ä¿¡å·ç»Ÿè®¡ â•â•â•â•â•â•
    html += `<div class="nk-card">
        <div class="title"><span class="icon">ğŸ”</span> ä¿¡å·æ£€æµ‹ç»Ÿè®¡</div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;">`;
    const sigByPat = sigSummary.by_pattern || {};
    Object.entries(sigByPat).forEach(([p, n]) => {
        const nameMap = {
            'pin_bar_bullish': 'çœ‹æ¶¨Pin Bar', 'pin_bar_bearish': 'çœ‹è·ŒPin Bar',
            'inside_bar': 'å†…åŒ…çº¿', 'engulfing_bullish': 'çœ‹æ¶¨åæ²¡',
            'engulfing_bearish': 'çœ‹è·Œåæ²¡', 'fakey_bullish': 'çœ‹æ¶¨Fakey',
            'fakey_bearish': 'çœ‹è·ŒFakey', 'two_bar_reversal_bullish': 'çœ‹æ¶¨åŒKåè½¬',
            'two_bar_reversal_bearish': 'çœ‹è·ŒåŒKåè½¬',
        };
        html += `<span class="nk-badge"><b>${nameMap[p]||p}</b> ${n}ä¸ª</span>`;
    });
    html += `</div>`;

    // å½¢æ€äº¤æ˜“ç»Ÿè®¡è¡¨
    if (patterns.length > 0) {
        html += `<table class="dt"><thead><tr>
            <th>å½¢æ€</th><th class="center">äº¤æ˜“æ¬¡æ•°</th><th class="center">èƒœ</th>
            <th class="center">è´Ÿ</th><th class="center">èƒœç‡</th><th class="center">æ€»PnL</th>
            <th class="center">å¹³å‡PnL</th>
        </tr></thead><tbody>`;
        patterns.forEach(p => {
            html += `<tr>
                <td>${p.name}</td><td class="center">${p.total}</td>
                <td class="center" style="color:var(--green)">${p.wins}</td>
                <td class="center" style="color:var(--red)">${p.losses}</td>
                <td class="center">${fv(p.win_rate)}%</td>
                <td class="center ${cls(p.total_pnl)}">${fv(p.total_pnl)}</td>
                <td class="center ${cls(p.avg_pnl)}">${fv(p.avg_pnl)}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    html += `</div>`;

    // â•â•â•â•â•â• ç« èŠ‚è§£è¯» â•â•â•â•â•â•
    if (book.chapters && book.chapters.length) {
        html += `<div class="nk-card">
            <div class="title"><span class="icon">ğŸ“š</span> ã€Šè£¸Kçº¿äº¤æ˜“æ³•ã€‹ç« èŠ‚è§£è¯»ä¸ä»£ç æ˜ å°„</div>
            <div style="margin-bottom:12px;font-size:0.88rem;color:var(--text-muted);line-height:1.6;">
                <b>æ ¸å¿ƒç†å¿µ:</b> ${book.core_philosophy || ''}
            </div>
            <div class="ch-list">`;
        book.chapters.forEach(ch => {
            html += `<div class="ch-item">
                <div class="ch-title">${ch.chapter}</div>
                <div class="ch-summary">${ch.summary}</div>
                <ul>${(ch.key_points||[]).map(k => `<li>${k}</li>`).join('')}</ul>
                <div class="ch-code">ğŸ’» ${ch.code_mapping}</div>
            </div>`;
        });
        html += `</div></div>`;
    }

    // â•â•â•â•â•â• æ¯æ—¥ä¿¡å·æ˜ç»†è¡¨ â•â•â•â•â•â•
    html += `<div class="nk-card">
        <details>
            <summary class="title" style="cursor:pointer"><span class="icon">ğŸ“‹</span> æ¯æ—¥ä¿¡å· & æŒä»“æ˜ç»† (${daily.length} å¤©)</summary>
            <div style="overflow-x:auto;margin-top:12px;max-height:600px;overflow-y:auto;">
                <table class="dt"><thead><tr>
                    <th>æ—¥æœŸ</th><th>ETHä»·æ ¼</th><th>è¶‹åŠ¿</th><th>ä¿¡å·</th>
                    <th>æŒä»“æ–¹å‘</th><th>æœªå®ç°PnL</th><th>è´¦æˆ·æ€»å€¼</th><th>æ”¶ç›Šç‡</th>
                </tr></thead><tbody>`;
    daily.forEach(d => {
        const p = d.position;
        const trendIcon = d.trend === 'up' ? 'ğŸŸ¢' : d.trend === 'down' ? 'ğŸ”´' : 'ğŸŸ¡';
        html += `<tr>
            <td>${d.date}</td>
            <td>$${fv(d.open)}</td>
            <td>${trendIcon} ${d.trend}</td>
            <td style="font-size:0.75rem;max-width:200px;overflow:hidden;text-overflow:ellipsis">${d.signal || '-'}</td>
            <td>${p ? (p.direction==='long'?'ğŸŸ¢å¤š':'ğŸ”´ç©º') : '-'}</td>
            <td class="${p ? cls(p.unrealized_pnl) : ''}">${p ? '$'+fv(p.unrealized_pnl) : '-'}</td>
            <td>$${d.total_value.toLocaleString()}</td>
            <td class="${cls(d.return_pct)}">${fv(d.return_pct)}%</td>
        </tr>`;
    });
    html += '</tbody></table></div></details></div>';

    // â•â•â•â•â•â• äº¤æ˜“æ˜ç»† â•â•â•â•â•â•
    html += `<div class="nk-card">
        <details>
            <summary class="title" style="cursor:pointer"><span class="icon">ğŸ’¹</span> å®Œæ•´äº¤æ˜“è®°å½• (${trades.length} ç¬”)</summary>
            <div style="overflow-x:auto;margin-top:12px;max-height:600px;overflow-y:auto;">
                <table class="dt" style="font-size:0.72rem;white-space:nowrap;"><thead><tr>
                    <th>#</th><th>æ—¶é—´</th><th>æ“ä½œ</th><th>æ–¹å‘</th>
                    <th class="center">å¸‚åœºä»·</th><th class="center">æˆäº¤ä»·</th>
                    <th class="center">æ•°é‡</th><th class="center">åä¹‰ä»·å€¼</th>
                    <th class="center">ä¿è¯é‡‘</th><th class="center">æ æ†</th>
                    <th class="center">æ‰‹ç»­è´¹</th><th class="center">æ»‘ç‚¹</th>
                    <th class="center">PnL</th>
                    <th class="center">è´¦æˆ·æ€»å€¼</th><th class="center">å¹³ä»“åŸå› </th>
                </tr></thead><tbody>`;
    trades.forEach((t, i) => {
        const pnlCls = t.pnl > 0 ? 'color:var(--green)' : t.pnl < 0 ? 'color:var(--red)' : '';
        html += `<tr>
            <td>${i+1}</td>
            <td>${t.time}</td>
            <td style="font-weight:600;${t.action==='OPEN'?'color:var(--cyan)':'color:var(--orange)'}">${t.action}</td>
            <td>${t.direction==='long'?'ğŸŸ¢å¤š':'ğŸ”´ç©º'}</td>
            <td class="center">$${fv(t.market_price)}</td>
            <td class="center">$${fv(t.exec_price)}</td>
            <td class="center">${fv(t.quantity)}</td>
            <td class="center">$${fv(t.notional_value)}</td>
            <td class="center">$${fv(t.margin)}</td>
            <td class="center">${t.leverage}x</td>
            <td class="center">$${fv(t.fee)}</td>
            <td class="center">$${fv(t.slippage_cost)}</td>
            <td class="center" style="${pnlCls};font-weight:600">$${fv(t.pnl)}</td>
            <td class="center">$${t.after_total ? t.after_total.toLocaleString() : '-'}</td>
            <td style="font-size:0.7rem">${t.close_reason||t.pattern||''}</td>
        </tr>`;
    });
    html += '</tbody></table></div></details></div>';

    root.innerHTML = html;

    // â•â•â•â•â•â• ç»˜åˆ¶èµ„é‡‘æ›²çº¿ â•â•â•â•â•â•
    if (equity.length > 0) {
        const labels = equity.map(e => e.date);
        const equityData = equity.map(e => e.total);
        const priceData = equity.map(e => e.price);

        new Chart(document.getElementById('equityChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'è´¦æˆ·æ€»å€¼ (USDT)',
                        data: equityData,
                        borderColor: '#5b8af5',
                        backgroundColor: 'rgba(91,138,245,0.08)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'ETH/USDT ä»·æ ¼',
                        data: priceData,
                        borderColor: '#f59e0b',
                        borderWidth: 1.5,
                        tension: 0.3,
                        pointRadius: 0,
                        borderDash: [4, 2],
                        yAxisID: 'y1',
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#8b8fa8', font: { size: 11 } } },
                },
                scales: {
                    x: { ticks: { color: '#8b8fa8', maxTicksLimit: 15, font: { size: 10 } }, grid: { color: 'rgba(42,46,66,0.5)' } },
                    y: { position: 'left', ticks: { color: '#5b8af5', font: { size: 10 } }, grid: { color: 'rgba(42,46,66,0.3)' } },
                    y1: { position: 'right', ticks: { color: '#f59e0b', font: { size: 10 } }, grid: { drawOnChartArea: false } },
                },
            },
        });
    }

    // â•â•â•â•â•â• ä¿¡å·çƒ­åŠ›å›¾ â•â•â•â•â•â•
    const heatmap = document.getElementById('signal-heatmap');
    if (heatmap && daily.length > 0) {
        let hmHtml = '';
        daily.forEach(d => {
            let cls = 'none';
            if (d.signal && d.signal.includes('long')) cls = 'long';
            else if (d.signal && d.signal.includes('short')) cls = 'short';
            hmHtml += `<span class="signal-day ${cls}" title="${d.date}: ${d.signal || 'æ— ä¿¡å·'}"></span>`;
        });
        heatmap.innerHTML = hmHtml;
    }
});
</script>
{% endblock %}
