{% extends "base.html" %}
{% block title %}æ­¢ç›ˆæ­¢æŸä¼˜åŒ– - æŠ€æœ¯åˆ†æå¹³å°{% endblock %}

{% block content %}
            <div class="page-title">å¤šæ—¶é—´æ¡†æ¶æ­¢ç›ˆæ­¢æŸä¼˜åŒ–</div>
            <div class="page-subtitle">12ä¸ªæ—¶é—´å‘¨æœŸ Ã— 94ç§å‚æ•°å˜ä½“ Ã— ç²¾ç»†ç»„åˆæœç´¢ Â· åŸºäºF12(C6+ä¸‰ä¹¦å¦å†³)ç­–ç•¥çš„ç³»ç»Ÿæ€§ä¼˜åŒ–</div>

            <div id="loading" style="text-align:center;padding:40px;color:var(--text-secondary);">
                åŠ è½½ä¼˜åŒ–æ•°æ®ä¸­...
            </div>
            <div id="content" style="display:none;">

            <!-- æ€»è§ˆå¡ç‰‡ -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;">
                <div class="card" style="text-align:center;border-top:3px solid var(--accent-green);">
                    <div style="font-size:12px;color:var(--text-tertiary);">å…¨å±€æœ€ä¼˜Alpha</div>
                    <div id="best-alpha" style="font-size:28px;font-weight:700;color:var(--accent-green);margin:4px 0;">--</div>
                    <div id="best-tag" style="font-size:11px;color:var(--text-secondary);">--</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid var(--accent-blue);">
                    <div style="font-size:12px;color:var(--text-tertiary);">æœ€ä¼˜æ—¶é—´æ¡†æ¶</div>
                    <div id="best-tf" style="font-size:28px;font-weight:700;color:var(--accent-blue);margin:4px 0;">--</div>
                    <div id="best-return" style="font-size:11px;color:var(--text-secondary);">ç­–ç•¥æ”¶ç›Š --</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid var(--accent-yellow);">
                    <div style="font-size:12px;color:var(--text-tertiary);">F12åŸºå‡†Alpha(1h)</div>
                    <div id="baseline-alpha" style="font-size:28px;font-weight:700;color:var(--accent-yellow);margin:4px 0;">--</div>
                    <div id="improve-pct" style="font-size:11px;color:var(--accent-green);">æå‡ --</div>
                </div>
                <div class="card" style="text-align:center;border-top:3px solid var(--accent-purple);">
                    <div style="font-size:12px;color:var(--text-tertiary);">æµ‹è¯•æ€»é‡</div>
                    <div id="total-tests" style="font-size:28px;font-weight:700;color:var(--accent-purple);margin:4px 0;">--</div>
                    <div style="font-size:11px;color:var(--text-secondary);">å‚æ•°å˜ä½“Ã—æ—¶é—´æ¡†æ¶</div>
                </div>
            </div>

            <!-- Tabåˆ‡æ¢ -->
            <div style="display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap;">
                <button class="tab-btn active" onclick="showTab('tf-baseline')">å„æ—¶é—´æ¡†æ¶åŸºå‡†</button>
                <button class="tab-btn" onclick="showTab('global-top')">å…¨å±€TOPæ’å</button>
                <button class="tab-btn" onclick="showTab('best-params')">æœ€ä¼˜å‚æ•°è¯¦è§£</button>
                <button class="tab-btn" onclick="showTab('best-trades')">æœ€ä¼˜ç­–ç•¥äº¤æ˜“æ˜ç»†</button>
                <button class="tab-btn" onclick="showTab('best-equity')">èµ„é‡‘æ›²çº¿</button>
            </div>

            <!-- Tab 1: å„æ—¶é—´æ¡†æ¶åŸºå‡† -->
            <div id="tab-tf-baseline" class="tab-content active">
                <div class="card">
                    <div class="card-title">12ä¸ªæ—¶é—´æ¡†æ¶ F12åŸºå‡†ç­–ç•¥æ€§èƒ½å¯¹æ¯”</div>
                    <div style="margin-bottom:16px;">
                        <svg id="tf-chart" width="100%" height="400" viewBox="0 0 900 400"></svg>
                    </div>
                    <table class="data-table" id="tf-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´æ¡†æ¶</th>
                                <th>Kçº¿æ•°</th>
                                <th>Alpha</th>
                                <th>ç­–ç•¥æ”¶ç›Š</th>
                                <th>BHæ”¶ç›Š</th>
                                <th>æœ€å¤§å›æ’¤</th>
                                <th>äº¤æ˜“æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: å…¨å±€TOPæ’å -->
            <div id="tab-global-top" class="tab-content">
                <div class="card">
                    <div class="card-title">å…¨å±€TOP20å‚æ•°ç»„åˆ</div>
                    <table class="data-table" id="top-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>æ—¶é—´æ¡†æ¶</th>
                                <th>å‚æ•°æ ‡ç­¾</th>
                                <th>Alpha</th>
                                <th>ç­–ç•¥æ”¶ç›Š</th>
                                <th>æœ€å¤§å›æ’¤</th>
                                <th>äº¤æ˜“</th>
                                <th>è´¹ç”¨</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 3: æœ€ä¼˜å‚æ•°è¯¦è§£ -->
            <div id="tab-best-params" class="tab-content">
                <div class="card">
                    <div class="card-title">æœ€ä¼˜ç­–ç•¥å‚æ•°é…ç½®</div>
                    <div id="best-params-content"></div>
                </div>

                <div class="card" style="margin-top:16px;">
                    <div class="card-title">æ ¸å¿ƒå‘ç°: åˆ†æ®µæ­¢ç›ˆ(Partial Take-Profit)</div>
                    <div style="font-size:14px;color:var(--text-secondary);line-height:1.8;">
                        <p>ä¼˜åŒ–ç»“æœæ˜¾ç¤ºï¼Œ<span style="color:var(--accent-green);font-weight:600;">åˆ†æ®µæ­¢ç›ˆ</span>æ˜¯æœ€å¤§çš„æ€§èƒ½æå‡å› ç´ ã€‚</p>

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
                            <div style="background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:16px;">
                                <div style="font-weight:600;color:var(--accent-red);margin-bottom:8px;">ä¼ ç»Ÿæ­¢ç›ˆ(å…¨ä»“)</div>
                                <ul style="font-size:13px;padding-left:16px;">
                                    <li>ç›ˆåˆ©è¾¾åˆ°TPé˜ˆå€¼æ—¶ä¸€æ¬¡æ€§å…¨éƒ¨å¹³ä»“</li>
                                    <li>å¯èƒ½é”™è¿‡åç»­æ›´å¤§çš„è¡Œæƒ…</li>
                                    <li>æ­¢ç›ˆåéœ€è¦ç­‰å¾…å†·å´æœŸé‡æ–°å…¥åœº</li>
                                    <li>å¦‚æœè¡Œæƒ…ç»§ç»­ï¼Œéœ€è¦ä»˜äºŒæ¬¡å…¥åœºè´¹ç”¨</li>
                                </ul>
                            </div>
                            <div style="background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:16px;">
                                <div style="font-weight:600;color:var(--accent-green);margin-bottom:8px;">åˆ†æ®µæ­¢ç›ˆ(æœ€ä¼˜)</div>
                                <ul style="font-size:13px;padding-left:16px;">
                                    <li>ç›ˆåˆ©è¾¾20%æ—¶å…ˆå¹³30%ä»“ä½é”å®šåˆ©æ¶¦</li>
                                    <li>å‰©ä½™70%ç»§ç»­æŒæœ‰è¿½è¸ªæ›´å¤§è¡Œæƒ…</li>
                                    <li>å…¼é¡¾"è½è¢‹ä¸ºå®‰"å’Œ"è®©åˆ©æ¶¦å¥”è·‘"</li>
                                    <li>å‡å°‘äºŒæ¬¡å…¥åœºçš„è´¹ç”¨æ‘©æ“¦</li>
                                </ul>
                            </div>
                        </div>

                        <div style="margin-top:16px;padding:12px;background:rgba(0,200,150,0.08);border-radius:8px;border-left:3px solid var(--accent-green);">
                            <b>å…³é”®æ´å¯Ÿï¼š</b>åˆ†æ®µæ­¢ç›ˆåœ¨å‡ ä¹æ‰€æœ‰æ—¶é—´æ¡†æ¶ä¸Šéƒ½æ˜¯TOP1å‚æ•°å˜ä½“ã€‚<br>
                            åœ¨1hä¸Šï¼šAlphaä»+44.02%æå‡åˆ°+85.38%(+41.36%)ï¼›<br>
                            åœ¨16hä¸Šï¼šAlphaä»+51.06%æå‡åˆ°+72.39%(+21.33%)ï¼›<br>
                            åœ¨12hä¸Šï¼šAlphaä»+39.31%æå‡åˆ°+61.49%(+22.18%)ã€‚
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top:16px;">
                    <div class="card-title">æ—¶é—´æ¡†æ¶åˆ†æ</div>
                    <div style="font-size:14px;color:var(--text-secondary);line-height:1.8;">
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                            <div style="background:rgba(0,200,150,0.06);border-radius:8px;padding:12px;text-align:center;">
                                <div style="font-size:11px;color:var(--text-tertiary);">çŸ­å‘¨æœŸ(10m-30m)</div>
                                <div style="font-size:18px;font-weight:600;color:var(--accent-yellow);margin:4px 0;">é€‚ä¸­</div>
                                <div style="font-size:12px;">ä¿¡å·å¤šä½†å™ªéŸ³å¤§<br>è´¹ç”¨é«˜(äº¤æ˜“é¢‘ç¹)</div>
                            </div>
                            <div style="background:rgba(0,200,150,0.06);border-radius:8px;padding:12px;text-align:center;">
                                <div style="font-size:11px;color:var(--text-tertiary);">ä¸­å‘¨æœŸ(1h-4h)</div>
                                <div style="font-size:18px;font-weight:600;color:var(--accent-green);margin:4px 0;">æœ€ä¼˜</div>
                                <div style="font-size:12px;">ä¿¡å·è´¨é‡é«˜<br>1hä¸ºæœ€ä½³Alphaæ¡†æ¶</div>
                            </div>
                            <div style="background:rgba(0,200,150,0.06);border-radius:8px;padding:12px;text-align:center;">
                                <div style="font-size:11px;color:var(--text-tertiary);">é•¿å‘¨æœŸ(8h-24h)</div>
                                <div style="font-size:18px;font-weight:600;color:var(--accent-blue);margin:4px 0;">ç¨³å¥</div>
                                <div style="font-size:12px;">ä½å›æ’¤ä½äº¤æ˜“<br>16hå›æ’¤ä»…-2.79%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: äº¤æ˜“æ˜ç»† -->
            <div id="tab-best-trades" class="tab-content">
                <div class="card">
                    <div class="card-title">æœ€ä¼˜ç­–ç•¥äº¤æ˜“æ˜ç»†</div>
                    <table class="data-table" id="trades-table">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                                <th>ä»·æ ¼</th>
                                <th>æ æ†</th>
                                <th>æ€»èµ„äº§</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 5: èµ„é‡‘æ›²çº¿ -->
            <div id="tab-best-equity" class="tab-content">
                <div class="card">
                    <div class="card-title">æœ€ä¼˜ç­–ç•¥èµ„é‡‘æ›²çº¿</div>
                    <svg id="equity-chart" width="100%" height="450" viewBox="0 0 900 450"></svg>
                </div>
                <div class="card" style="margin-top:16px;">
                    <div class="card-title">è´¹ç”¨åˆ†æ</div>
                    <div id="fee-analysis" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;"></div>
                </div>
            </div>

            </div><!-- end #content -->

            <style>
                .tab-btn {
                    padding: 8px 16px; border: 1px solid var(--border);
                    background: var(--card-bg); color: var(--text-secondary);
                    border-radius: 6px; cursor: pointer; font-size: 13px;
                    transition: all 0.2s;
                }
                .tab-btn.active, .tab-btn:hover {
                    background: var(--accent-green); color: #fff; border-color: var(--accent-green);
                }
                .tab-content { display: none; }
                .tab-content.active { display: block; }
                .data-table {
                    width: 100%; border-collapse: collapse; font-size: 13px;
                }
                .data-table th {
                    text-align: left; padding: 8px 12px; border-bottom: 2px solid var(--border);
                    color: var(--text-tertiary); font-weight: 600; font-size: 12px;
                }
                .data-table td {
                    padding: 6px 12px; border-bottom: 1px solid var(--border);
                }
                .data-table tr:hover td { background: rgba(255,255,255,0.02); }
                .pos { color: var(--accent-green); }
                .neg { color: var(--accent-red); }
                .param-grid {
                    display: grid; grid-template-columns: repeat(3, 1fr);
                    gap: 12px; margin-top: 12px;
                }
                .param-item {
                    background: var(--card-bg); border: 1px solid var(--border);
                    border-radius: 8px; padding: 12px; text-align: center;
                }
                .param-item .label { font-size: 11px; color: var(--text-tertiary); }
                .param-item .value { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 4px 0; }
                .param-item .desc { font-size: 11px; color: var(--text-secondary); }
            </style>

            <script>
            function showTab(id) {
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + id).classList.add('active');
                event.target.classList.add('active');
            }

            function fmt(v, d=2) {
                if (v == null) return '--';
                return (v >= 0 ? '+' : '') + v.toFixed(d) + '%';
            }

            document.addEventListener('DOMContentLoaded', function() {
                fetch('/api/optimize_sl_tp')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';

                    // æ€»è§ˆ
                    const gb = data.global_best || data.global_top20?.[0] || {};
                    const gbCfg = gb.config || {};
                    document.getElementById('best-alpha').textContent = fmt(gb.alpha);
                    document.getElementById('best-tag').textContent = gb.tag || '--';
                    document.getElementById('best-tf').textContent = gb.tf || '--';
                    document.getElementById('best-return').textContent = 'ç­–ç•¥æ”¶ç›Š ' + fmt(gb.strategy_return);
                    document.getElementById('total-tests').textContent = data.total_variants_tested || '--';

                    // baseline
                    const bl1h = (data.baseline_by_tf || []).find(b => b.tf === '1h');
                    if (bl1h) {
                        document.getElementById('baseline-alpha').textContent = fmt(bl1h.alpha);
                        const diff = (gb.alpha || 0) - bl1h.alpha;
                        document.getElementById('improve-pct').textContent = 'æå‡ ' + fmt(diff);
                    }

                    // Tab 1: æ—¶é—´æ¡†æ¶åŸºå‡†
                    const tfData = data.baseline_by_tf || [];
                    const tbody1 = document.querySelector('#tf-table tbody');
                    tfData.forEach(t => {
                        const tr = document.createElement('tr');
                        const isTop = data.top_timeframes?.includes(t.tf);
                        tr.innerHTML = `
                            <td style="font-weight:${isTop?'600':'400'}">${t.tf} ${isTop?'â˜…':''}</td>
                            <td>--</td>
                            <td class="${t.alpha>=0?'pos':'neg'}" style="font-weight:600">${fmt(t.alpha)}</td>
                            <td class="${t.strategy_return>=0?'pos':'neg'}">${fmt(t.strategy_return)}</td>
                            <td class="${t.buy_hold_return>=0?'pos':'neg'}">${fmt(t.buy_hold_return)}</td>
                            <td class="neg">${t.max_drawdown?.toFixed(2)}%</td>
                            <td>${t.total_trades}</td>
                        `;
                        tbody1.appendChild(tr);
                    });

                    // æŸ±çŠ¶å›¾
                    drawTfChart(tfData);

                    // Tab 2: å…¨å±€TOP
                    const topData = data.global_top20 || [];
                    const tbody2 = document.querySelector('#top-table tbody');
                    topData.forEach(t => {
                        const tr = document.createElement('tr');
                        const medal = t.rank <= 3 ? ['','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][t.rank] : '';
                        tr.innerHTML = `
                            <td style="font-weight:600">${medal} #${t.rank}</td>
                            <td>${t.tf}</td>
                            <td>${t.tag}</td>
                            <td class="pos" style="font-weight:600">${fmt(t.alpha)}</td>
                            <td class="${t.strategy_return>=0?'pos':'neg'}">${fmt(t.strategy_return)}</td>
                            <td class="neg">${t.max_drawdown?.toFixed(2)}%</td>
                            <td>${t.total_trades}</td>
                            <td>$${(t.fees||0).toLocaleString()}</td>
                        `;
                        tbody2.appendChild(tr);
                    });

                    // Tab 3: æœ€ä¼˜å‚æ•°
                    renderBestParams(gb);

                    // Tab 4: äº¤æ˜“æ˜ç»†
                    const trades = data.global_best_trades || [];
                    const tbody4 = document.querySelector('#trades-table tbody');
                    trades.forEach(t => {
                        const tr = document.createElement('tr');
                        const action = t.action || '';
                        const isOpen = action.includes('å¼€') || action.includes('open');
                        const isClose = action.includes('å¹³') || action.includes('close') || action.includes('æ­¢');
                        const color = isOpen ? 'var(--accent-blue)' : isClose ? 'var(--accent-yellow)' : '';
                        tr.innerHTML = `
                            <td style="font-size:12px">${(t.time||'').substring(0,16)}</td>
                            <td style="color:${color};font-weight:500">${action}</td>
                            <td>$${(t.price||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                            <td>${t.leverage||'-'}x</td>
                            <td>$${(t.total||0).toLocaleString()}</td>
                            <td style="font-size:11px;color:var(--text-secondary)">${(t.reason||'').substring(0,60)}</td>
                        `;
                        tbody4.appendChild(tr);
                    });

                    // Tab 5: èµ„é‡‘æ›²çº¿
                    const history = data.global_best_history || [];
                    if (history.length > 0) drawEquityChart(history);

                    const fees = data.global_best_fees || {};
                    const feeDiv = document.getElementById('fee-analysis');
                    const feeItems = [
                        ['ç°è´§è´¹ç”¨', fees.spot_fees],
                        ['åˆçº¦è´¹ç”¨', fees.futures_fees],
                        ['èµ„é‡‘è´¹ç‡(å‡€)', fees.net_funding],
                        ['æ»‘ç‚¹æˆæœ¬', fees.slippage_cost],
                        ['æ€»æˆæœ¬', fees.total_costs],
                    ];
                    feeItems.forEach(([label, val]) => {
                        feeDiv.innerHTML += `
                            <div style="text-align:center;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:12px;">
                                <div style="font-size:11px;color:var(--text-tertiary)">${label}</div>
                                <div style="font-size:16px;font-weight:600;color:var(--accent-red);margin:4px 0">
                                    $${(val||0).toLocaleString()}
                                </div>
                            </div>
                        `;
                    });
                })
                .catch(err => {
                    document.getElementById('loading').innerHTML =
                        '<span style="color:var(--accent-red)">åŠ è½½å¤±è´¥: ' + err.message +
                        '</span><br><small>è¯·å…ˆè¿è¡Œ python optimize_sl_tp.py</small>';
                });
            });

            function renderBestParams(gb) {
                const cfg = gb.config || {};
                const div = document.getElementById('best-params-content');
                div.innerHTML = `
                    <div class="param-grid">
                        <div class="param-item" style="border-color:var(--accent-red)">
                            <div class="label">ç©ºå¤´æ­¢æŸ</div>
                            <div class="value" style="color:var(--accent-red)">${((cfg.short_sl||0)*100).toFixed(0)}%</div>
                            <div class="desc">short_sl</div>
                        </div>
                        <div class="param-item" style="border-color:var(--accent-green)">
                            <div class="label">ç©ºå¤´æ­¢ç›ˆ</div>
                            <div class="value" style="color:var(--accent-green)">${((cfg.short_tp||0)*100).toFixed(0)}%</div>
                            <div class="desc">short_tp</div>
                        </div>
                        <div class="param-item">
                            <div class="label">è¿½è¸ªæ­¢ç›ˆæ¿€æ´»</div>
                            <div class="value">${((cfg.short_trail||0)*100).toFixed(0)}%</div>
                            <div class="desc">short_trail</div>
                        </div>
                        <div class="param-item" style="border-color:var(--accent-red)">
                            <div class="label">å¤šå¤´æ­¢æŸ</div>
                            <div class="value" style="color:var(--accent-red)">${((cfg.long_sl||0)*100).toFixed(0)}%</div>
                            <div class="desc">long_sl</div>
                        </div>
                        <div class="param-item" style="border-color:var(--accent-green)">
                            <div class="label">å¤šå¤´æ­¢ç›ˆ</div>
                            <div class="value" style="color:var(--accent-green)">${((cfg.long_tp||0)*100).toFixed(0)}%</div>
                            <div class="desc">long_tp</div>
                        </div>
                        <div class="param-item">
                            <div class="label">å›æ’¤å¹³ä»“æ¯”ä¾‹</div>
                            <div class="value">${((cfg.trail_pullback||0)*100).toFixed(0)}%</div>
                            <div class="desc">trail_pullback</div>
                        </div>
                        <div class="param-item">
                            <div class="label">æœ€å¤§æŒä»“</div>
                            <div class="value">${cfg.short_max_hold||72} bars</div>
                            <div class="desc">short_max_hold</div>
                        </div>
                        <div class="param-item" style="border-color:var(--accent-blue)">
                            <div class="label">åˆ†æ®µæ­¢ç›ˆç‚¹</div>
                            <div class="value" style="color:var(--accent-blue)">${cfg.use_partial_tp?((cfg.partial_tp_1||0)*100).toFixed(0)+'%':'å…³é—­'}</div>
                            <div class="desc">partial_tp_1</div>
                        </div>
                        <div class="param-item" style="border-color:var(--accent-blue)">
                            <div class="label">åˆ†æ®µå¹³ä»“æ¯”ä¾‹</div>
                            <div class="value" style="color:var(--accent-blue)">${cfg.use_partial_tp?((cfg.partial_tp_1_pct||0)*100).toFixed(0)+'%':'--'}</div>
                            <div class="desc">partial_tp_1_pct</div>
                        </div>
                    </div>

                    <div style="margin-top:20px;padding:12px 16px;background:rgba(0,200,150,0.06);border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:8px;">æœ€ä¼˜ vs F12åŸºå‡† å‚æ•°å¯¹æ¯”</div>
                        <table style="width:100%;font-size:13px;border-collapse:collapse;">
                            <tr style="border-bottom:1px solid var(--border)">
                                <th style="text-align:left;padding:4px 8px;color:var(--text-tertiary)">å‚æ•°</th>
                                <th style="text-align:center;padding:4px 8px;color:var(--text-tertiary)">F12åŸºå‡†</th>
                                <th style="text-align:center;padding:4px 8px;color:var(--text-tertiary)">æœ€ä¼˜</th>
                                <th style="text-align:center;padding:4px 8px;color:var(--text-tertiary)">å˜åŒ–</th>
                            </tr>
                            <tr><td style="padding:4px 8px">ç©ºå¤´æ­¢æŸ</td><td style="text-align:center">-30%</td>
                                <td style="text-align:center;font-weight:600">${((cfg.short_sl||0)*100).toFixed(0)}%</td>
                                <td style="text-align:center;color:var(--accent-yellow)">${cfg.short_sl!=-0.30?'å·²ä¼˜åŒ–':'ä¸å˜'}</td></tr>
                            <tr><td style="padding:4px 8px">ç©ºå¤´æ­¢ç›ˆ</td><td style="text-align:center">+80%</td>
                                <td style="text-align:center;font-weight:600">${((cfg.short_tp||0)*100).toFixed(0)}%</td>
                                <td style="text-align:center;color:var(--accent-yellow)">${cfg.short_tp!=0.80?'å·²ä¼˜åŒ–':'ä¸å˜'}</td></tr>
                            <tr><td style="padding:4px 8px">å¤šå¤´æ­¢æŸ</td><td style="text-align:center">-15%</td>
                                <td style="text-align:center;font-weight:600">${((cfg.long_sl||0)*100).toFixed(0)}%</td>
                                <td style="text-align:center;color:var(--accent-yellow)">${cfg.long_sl!=-0.15?'å·²ä¼˜åŒ–':'ä¸å˜'}</td></tr>
                            <tr><td style="padding:4px 8px">å¤šå¤´æ­¢ç›ˆ</td><td style="text-align:center">+50%</td>
                                <td style="text-align:center;font-weight:600">${((cfg.long_tp||0)*100).toFixed(0)}%</td>
                                <td style="text-align:center;color:var(--accent-yellow)">${cfg.long_tp!=0.50?'å·²ä¼˜åŒ–':'ä¸å˜'}</td></tr>
                            <tr><td style="padding:4px 8px">åˆ†æ®µæ­¢ç›ˆ</td><td style="text-align:center">æ— </td>
                                <td style="text-align:center;font-weight:600;color:var(--accent-green)">${cfg.use_partial_tp?'å¼€å¯':''}</td>
                                <td style="text-align:center;color:var(--accent-green)">${cfg.use_partial_tp?'æ–°å¢!':''}</td></tr>
                        </table>
                    </div>
                `;
            }

            function drawTfChart(tfData) {
                const svg = document.getElementById('tf-chart');
                const W = 900, H = 400, pad = {t:30,r:40,b:60,l:60};
                const plotW = W - pad.l - pad.r;
                const plotH = H - pad.t - pad.b;

                const alphas = tfData.map(t => t.alpha);
                const maxA = Math.max(...alphas, 10);
                const minA = Math.min(...alphas, -10);
                const range = maxA - minA || 1;
                const barW = plotW / tfData.length * 0.6;
                const gap = plotW / tfData.length;

                let html = '';
                // Y axis
                for (let i = 0; i <= 5; i++) {
                    const val = minA + (range * i / 5);
                    const y = pad.t + plotH - (plotH * i / 5);
                    html += `<line x1="${pad.l}" y1="${y}" x2="${W-pad.r}" y2="${y}" stroke="rgba(255,255,255,0.05)"/>`;
                    html += `<text x="${pad.l-8}" y="${y+4}" fill="rgba(255,255,255,0.4)" font-size="11" text-anchor="end">${val.toFixed(0)}%</text>`;
                }

                // Zero line
                const zeroY = pad.t + plotH - (plotH * (-minA) / range);
                html += `<line x1="${pad.l}" y1="${zeroY}" x2="${W-pad.r}" y2="${zeroY}" stroke="rgba(255,255,255,0.2)" stroke-dasharray="4,4"/>`;

                // Bars
                tfData.forEach((t, i) => {
                    const x = pad.l + i * gap + (gap - barW) / 2;
                    const h = Math.abs(t.alpha) / range * plotH;
                    const y = t.alpha >= 0 ? zeroY - h : zeroY;
                    const color = t.alpha >= 0 ? 'rgba(0,200,150,0.7)' : 'rgba(255,80,80,0.7)';
                    html += `<rect x="${x}" y="${y}" width="${barW}" height="${h}" fill="${color}" rx="3"/>`;
                    html += `<text x="${x+barW/2}" y="${H-pad.b+15}" fill="rgba(255,255,255,0.6)" font-size="11" text-anchor="middle">${t.tf}</text>`;
                    html += `<text x="${x+barW/2}" y="${(t.alpha>=0?y-5:y+h+14)}" fill="rgba(255,255,255,0.8)" font-size="11" text-anchor="middle" font-weight="600">${t.alpha>=0?'+':''}${t.alpha.toFixed(1)}%</text>`;
                });

                svg.innerHTML = html;
            }

            function drawEquityChart(history) {
                const svg = document.getElementById('equity-chart');
                const W = 900, H = 450, pad = {t:30,r:40,b:40,l:70};
                const plotW = W - pad.l - pad.r;
                const plotH = H - pad.t - pad.b;

                const totals = history.map(h => h.total || h.value || 0);
                const bhs = history.map(h => h.bh || h.buy_hold || 0);
                const maxV = Math.max(...totals, ...bhs) * 1.05;
                const minV = Math.min(...totals, ...bhs) * 0.95;
                const range = maxV - minV || 1;

                let html = '';

                // Grid
                for (let i = 0; i <= 5; i++) {
                    const val = minV + (range * i / 5);
                    const y = pad.t + plotH - (plotH * i / 5);
                    html += `<line x1="${pad.l}" y1="${y}" x2="${W-pad.r}" y2="${y}" stroke="rgba(255,255,255,0.05)"/>`;
                    html += `<text x="${pad.l-8}" y="${y+4}" fill="rgba(255,255,255,0.4)" font-size="11" text-anchor="end">$${(val/1000).toFixed(0)}k</text>`;
                }

                // BH line
                let bhPath = '';
                history.forEach((h, i) => {
                    const x = pad.l + (i / (history.length - 1)) * plotW;
                    const y = pad.t + plotH - ((bhs[i] - minV) / range) * plotH;
                    bhPath += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });
                html += `<path d="${bhPath}" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>`;

                // Strategy line
                let stratPath = '';
                history.forEach((h, i) => {
                    const x = pad.l + (i / (history.length - 1)) * plotW;
                    const y = pad.t + plotH - ((totals[i] - minV) / range) * plotH;
                    stratPath += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });
                html += `<path d="${stratPath}" fill="none" stroke="rgb(0,200,150)" stroke-width="2"/>`;

                // Legend
                html += `<rect x="${pad.l+10}" y="${pad.t+5}" width="12" height="3" fill="rgb(0,200,150)"/>`;
                html += `<text x="${pad.l+26}" y="${pad.t+10}" fill="rgba(255,255,255,0.7)" font-size="11">ä¼˜åŒ–ç­–ç•¥</text>`;
                html += `<rect x="${pad.l+100}" y="${pad.t+5}" width="12" height="3" fill="rgba(255,255,255,0.25)"/>`;
                html += `<text x="${pad.l+116}" y="${pad.t+10}" fill="rgba(255,255,255,0.7)" font-size="11">ä¹°å…¥æŒæœ‰</text>`;

                svg.innerHTML = html;
            }
            </script>
{% endblock %}
