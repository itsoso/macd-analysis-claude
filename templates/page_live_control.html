{% extends "base.html" %}
{% block title %}å®ç›˜æ§åˆ¶é¢æ¿ - æŠ€æœ¯åˆ†æå¹³å°{% endblock %}

{% block content %}
<style>
    .control-header { margin-bottom: 32px; }
    .control-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .control-header p { color: var(--text-secondary); font-size: 14px; }

    .status-bar {
        display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 28px;
    }
    .status-chip {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 16px; border-radius: 8px;
        background: var(--bg-card); border: 1px solid var(--border);
        font-size: 13px;
    }
    .status-dot {
        width: 8px; height: 8px; border-radius: 50%;
    }
    .status-dot.green { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
    .status-dot.red { background: var(--accent-red); }
    .status-dot.yellow { background: var(--accent-yellow); animation: pulse 2s infinite; }
    .status-dot.gray { background: var(--text-muted); }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    .grid-2 { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 20px; margin-bottom: 20px; }
    .grid-1 { margin-bottom: 20px; }
    .grid-2 > * { min-width: 0; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

    .ctrl-card {
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: 12px; padding: 24px; position: relative;
    }
    .ctrl-card h3 {
        font-size: 15px; font-weight: 600; margin-bottom: 6px;
        display: flex; align-items: center; gap: 8px;
    }
    .ctrl-card .desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }

    .btn {
        padding: 10px 20px; border: none; border-radius: 8px;
        font-size: 14px; font-weight: 600; cursor: pointer;
        transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent-blue); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #3b82f6; box-shadow: 0 4px 16px rgba(74,158,255,0.3); }
    .btn-success { background: var(--accent-green); color: #000; }
    .btn-success:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(0,214,143,0.3); }
    .btn-danger { background: var(--accent-red); color: #fff; }
    .btn-danger:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(255,77,106,0.3); }
    .btn-warn { background: var(--accent-yellow); color: #000; }
    .btn-warn:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(255,170,0,0.3); }
    .btn-outline {
        background: transparent; color: var(--text-primary);
        border: 1px solid var(--border);
    }
    .btn-outline:hover:not(:disabled) { border-color: var(--accent-blue); color: var(--accent-blue); }
    .btn-sm { padding: 6px 14px; font-size: 13px; }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

    .output-box {
        margin-top: 16px; background: #0d0f17; border: 1px solid var(--border);
        border-radius: 8px; padding: 16px; font-family: 'JetBrains Mono', monospace;
        font-size: 13px; line-height: 1.7; white-space: pre-wrap; word-break: break-all;
        max-height: 400px; overflow-y: auto; color: var(--text-secondary);
        display: none;
    }
    .output-box.visible { display: block; }
    .output-box .line-ok { color: var(--accent-green); }
    .output-box .line-err { color: var(--accent-red); }
    .output-box .line-info { color: var(--accent-blue); }
    .output-box .line-warn { color: var(--accent-yellow); }

    .result-badge {
        display: inline-block; padding: 3px 10px; border-radius: 6px;
        font-size: 12px; font-weight: 600; margin-top: 12px;
    }
    .result-badge.success { background: rgba(0,214,143,0.15); color: var(--accent-green); }
    .result-badge.error { background: rgba(255,77,106,0.15); color: var(--accent-red); }

    .spinner-sm {
        display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .config-editor {
        width: 100%; min-height: 300px; background: #0d0f17; color: var(--text-primary);
        border: 1px solid var(--border); border-radius: 8px; padding: 16px;
        font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6;
        resize: vertical; outline: none;
    }
    .config-editor:focus { border-color: var(--accent-blue); }

    select.phase-select {
        padding: 8px 12px; background: var(--bg-secondary); color: var(--text-primary);
        border: 1px solid var(--border); border-radius: 8px; font-size: 14px;
        outline: none; cursor: pointer;
    }
    select.phase-select:focus { border-color: var(--accent-blue); }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .info-item { background: var(--bg-secondary); border-radius: 8px; padding: 12px; }
    .info-item .label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
    .info-item .value { font-size: 18px; font-weight: 700; }
    .info-item .value.green { color: var(--accent-green); }
    .info-item .value.red { color: var(--accent-red); }

    .history-toolbar {
        display: flex; justify-content: space-between; align-items: center;
        gap: 10px; margin-bottom: 12px; flex-wrap: wrap;
    }
    .history-select {
        padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border);
        background: var(--bg-secondary); color: var(--text-primary); font-size: 13px;
    }
    .history-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 10px;
    }
    .history-metric {
        background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.04);
        border-radius: 8px; padding: 10px 12px;
    }
    .history-metric .label {
        font-size: 11px; color: var(--text-muted); text-transform: uppercase;
    }
    .history-metric .value {
        margin-top: 4px; font-size: 17px; font-weight: 700;
    }
    .history-metric .value.green { color: var(--accent-green); }
    .history-metric .value.red { color: var(--accent-red); }

    .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .history-table {
        width: 100%; min-width: 680px; border-collapse: collapse; font-size: 12px;
    }
    .history-table th {
        text-align: left; padding: 8px 10px; font-size: 11px; font-weight: 600;
        color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border);
        white-space: nowrap;
    }
    .history-table td {
        padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04);
        white-space: nowrap; font-family: 'JetBrains Mono', monospace;
    }
    .history-table tr:hover td { background: rgba(255,255,255,0.02); }
    .history-note {
        margin-top: 8px; font-size: 11px; color: var(--text-muted);
    }
    .ops-hint {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-secondary);
        font-size: 12px;
        color: var(--text-secondary);
    }
    .ops-hint.warn {
        border-color: rgba(255, 170, 0, 0.45);
        color: var(--accent-yellow);
    }
    .report-card { margin-top: 16px; }
    .report-toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .report-editor {
        width: 100%;
        min-height: 220px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0d0f17;
        color: var(--text-primary);
        padding: 12px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        line-height: 1.6;
        resize: vertical;
    }

    /* å¤šTFä¿¡å·æ£€æµ‹ */
    .tf-checkbox-grid {
        display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;
    }
    .tf-chip {
        display: flex; align-items: center; gap: 4px;
        padding: 5px 10px; border-radius: 6px; cursor: pointer;
        font-size: 12px; font-weight: 600; user-select: none;
        background: var(--bg-secondary); border: 1px solid var(--border);
        transition: all 0.2s;
    }
    .tf-chip:hover { border-color: var(--accent-blue); }
    .tf-chip input { display: none; }
    .tf-chip.checked {
        background: rgba(74,158,255,0.15); border-color: var(--accent-blue);
        color: var(--accent-blue);
    }

    .multi-result-table {
        width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 12px;
    }
    .multi-result-table th {
        text-align: left; padding: 8px 10px; font-weight: 600; font-size: 11px;
        color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
    }
    .multi-result-table td {
        padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04);
        font-family: 'JetBrains Mono', monospace; font-size: 12px;
    }
    .multi-result-table tr:hover td { background: rgba(255,255,255,0.02); }
    .action-long { color: var(--accent-green); font-weight: 700; }
    .action-short { color: var(--accent-red); font-weight: 700; }
    .action-hold { color: var(--text-muted); }
    .consensus-box {
        margin-top: 14px; padding: 16px 20px; border-radius: 10px;
        background: var(--bg-secondary); border: 1px solid var(--border);
        font-size: 14px; font-weight: 600;
    }
    .consensus-box.long { border-color: var(--accent-green); color: var(--accent-green); }
    .consensus-box.short { border-color: var(--accent-red); color: var(--accent-red); }
    .consensus-box.neutral { border-color: var(--text-muted); color: var(--text-secondary); }
    .consensus-box.conflict { border-color: var(--accent-yellow); color: var(--accent-yellow); }
    .consensus-box.hold { border-color: var(--text-muted); color: var(--text-secondary); }

    /* æ™ºèƒ½å…±è¯†é¢æ¿ */
    .consensus-decision {
        font-size: 18px; font-weight: 700; margin-bottom: 10px;
        display: flex; align-items: center; gap: 8px;
    }
    .consensus-strength {
        margin: 10px 0; display: flex; align-items: center; gap: 10px;
    }
    .strength-bar-bg {
        flex: 1; height: 10px; background: rgba(255,255,255,0.06);
        border-radius: 5px; overflow: hidden; max-width: 240px;
    }
    .strength-bar-fill {
        height: 100%; border-radius: 5px; transition: width 0.6s ease;
    }
    .strength-bar-fill.long { background: linear-gradient(90deg, #00d68f, #00ff99); }
    .strength-bar-fill.short { background: linear-gradient(90deg, #ff4d6a, #ff6b8a); }
    .strength-bar-fill.hold { background: linear-gradient(90deg, #888, #aaa); }
    .strength-label { font-size: 13px; font-weight: 700; min-width: 48px; }

    .consensus-reason {
        font-size: 12px; font-weight: 400; color: var(--text-secondary);
        margin-top: 8px; line-height: 1.6; padding: 8px 10px;
        background: rgba(255,255,255,0.03); border-radius: 6px;
    }
    .consensus-detail-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        margin-top: 12px; font-size: 12px; font-weight: 400;
    }
    @media (max-width: 700px) { .consensus-detail-grid { grid-template-columns: 1fr; } }
    .detail-card {
        padding: 10px 12px; border-radius: 8px;
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
    }
    .detail-card .detail-title {
        font-size: 11px; font-weight: 600; color: var(--text-muted);
        text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
    }
    .detail-card .detail-value {
        color: var(--text-primary); font-weight: 500;
    }
    .resonance-chain {
        display: flex; align-items: center; gap: 4px; flex-wrap: wrap;
        margin-top: 4px;
    }
    .resonance-chain .chain-tf {
        padding: 2px 7px; border-radius: 4px; font-size: 11px; font-weight: 600;
    }
    .resonance-chain .chain-tf.long { background: rgba(0,214,143,0.15); color: var(--accent-green); }
    .resonance-chain .chain-tf.short { background: rgba(255,77,106,0.15); color: var(--accent-red); }
    .resonance-chain .chain-arrow { color: var(--text-muted); font-size: 10px; }

    .tab-bar { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .tab-btn {
        padding: 10px 20px; font-size: 14px; font-weight: 500;
        color: var(--text-muted); background: none; border: none;
        border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .kill-switch-btn {
        padding: 16px 32px; font-size: 18px; font-weight: 700;
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: #fff; border: 2px solid #ef4444; border-radius: 12px;
        cursor: pointer; transition: all 0.2s; width: 100%;
    }
    .kill-switch-btn:hover:not(:disabled) {
        box-shadow: 0 0 30px rgba(255,77,106,0.4);
        transform: scale(1.01);
    }
    .kill-switch-btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

<div class="control-header">
    <h1>ğŸ›ï¸ å®ç›˜æ§åˆ¶é¢æ¿</h1>
    <p>å…­ä¹¦èåˆç­–ç•¥ Â· å®æ—¶ç®¡ç†ä¸ç›‘æ§</p>
</div>

<!-- çŠ¶æ€æ  -->
<div class="status-bar" id="statusBar">
    <div class="status-chip">
        <span class="status-dot gray" id="engineDot"></span>
        <span id="engineStatus">å¼•æ“: æœªè¿è¡Œ</span>
    </div>
    <div class="status-chip">
        <span class="status-dot gray" id="riskDot"></span>
        <span id="riskStatus">é£æ§: --</span>
    </div>
    <div class="status-chip">
        <span id="equityDisplay">æƒç›Š: --</span>
    </div>
    <div class="status-chip">
        <span id="positionDisplay">æŒä»“: æ— </span>
    </div>
</div>

<!-- Tab æ  -->
<div class="tab-bar">
    <button class="tab-btn active" data-tab="operations">æ“ä½œ</button>
    <button class="tab-btn" data-tab="config">é…ç½®</button>
    <button class="tab-btn" data-tab="status">çŠ¶æ€ç›‘æ§</button>
    <button class="tab-btn" data-tab="logs">æ—¥å¿—</button>
</div>

<!-- Tab: æ“ä½œ -->
<div class="tab-panel active" id="tab-operations">
    <div class="grid-2">
        <!-- å¤šæ—¶é—´æ¡†æ¶ä¿¡å·æ£€æµ‹ -->
        <div class="ctrl-card" style="grid-column: 1 / -1;">
            <h3>ğŸ“¡ å¤šå‘¨æœŸä¿¡å·æ£€æµ‹</h3>
            <p class="desc">åŒæ—¶è·å–å¤šä¸ªæ—¶é—´æ¡†æ¶çš„Kçº¿æ•°æ®ï¼Œå¹¶è¡Œè®¡ç®—å…­ç»´èåˆä¿¡å·ï¼Œå±•ç¤ºå¤šå‘¨æœŸå…±è¯†</p>

            <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">ä¸å½“å‰ç­–ç•¥ä¸€è‡´ï¼šä¼˜å…ˆå‹¾é€‰ <strong>15mã€1hã€4hã€24h</strong>ï¼ˆå†³ç­–å‘¨æœŸï¼‰ï¼Œå…¶ä½™æŒ‰éœ€æ·»åŠ </p>
            <div class="tf-checkbox-grid" id="tfCheckboxes">
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="10m"> 10m
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="15m" checked> 15m
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="30m"> 30m
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="1h" checked> 1h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="2h"> 2h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="4h" checked> 4h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="6h"> 6h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="8h"> 8h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="12h"> 12h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="16h"> 16h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="24h" checked> 24h
                </label>
            </div>

            <div class="btn-group" style="flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="testSignalMulti()">
                    <span id="signalMultiBtnText">ğŸš€ å…¨éƒ¨æ£€æµ‹</span>
                </button>
                <button class="btn btn-outline btn-sm" onclick="selectAllTF(true)">å…¨é€‰</button>
                <button class="btn btn-outline btn-sm" onclick="selectAllTF(false)">å…¨ä¸é€‰</button>
                <button class="btn btn-outline btn-sm" onclick="setStrategyDefaultTFs()" title="ä¸å½“å‰ç­–ç•¥å†³ç­–å‘¨æœŸä¸€è‡´">ç­–ç•¥é»˜è®¤(15m/1h/4h/24h)</button>
                <button class="btn btn-outline btn-sm" id="autoDetectBtn" onclick="toggleAutoDetect()" style="margin-left:8px;">
                    â±ï¸ <span id="autoDetectText">è‡ªåŠ¨æ£€æµ‹: å…³</span>
                </button>
                <select id="autoDetectInterval" onchange="onAutoDetectIntervalChange()" style="background:var(--bg-secondary);color:var(--text-secondary);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;">
                    <option value="300">5åˆ†é’Ÿ</option>
                    <option value="600" selected>10åˆ†é’Ÿ</option>
                    <option value="900">15åˆ†é’Ÿ</option>
                    <option value="1800">30åˆ†é’Ÿ</option>
                    <option value="3600">1å°æ—¶</option>
                </select>
                <span id="signalMultiTimer" style="font-size:12px;color:var(--text-muted);align-self:center;"></span>
            </div>
            <div id="signalCacheHint" style="display:none;font-size:12px;color:var(--text-muted);margin-top:6px;"></div>
            <div id="signalMultiHealth" style="font-size:12px;color:var(--text-muted);margin-top:4px;">ğŸŸ¡ çŠ¶æ€: ç©ºé—²</div>

            <div id="signalMultiResult" style="display:none;margin-top:16px;">
                <table class="multi-result-table">
                    <thead>
                        <tr>
                            <th>å‘¨æœŸ</th>
                            <th>ä»·æ ¼</th>
                            <th>å–å‡ºåˆ†</th>
                            <th>ä¹°å…¥åˆ†</th>
                            <th>åŠ¨ä½œ</th>
                            <th>åŸå› </th>
                            <th>è€—æ—¶</th>
                        </tr>
                    </thead>
                    <tbody id="signalMultiBody"></tbody>
                </table>
                <div id="signalConsensus" class="consensus-box neutral"></div>
            </div>

            <div class="output-box" id="signalOutput"></div>
        </div>

        <!-- API è¿æ¥æµ‹è¯• -->
        <div class="ctrl-card">
            <h3>ğŸ”— æµ‹è¯• API è¿æ¥</h3>
            <p class="desc">æ£€æµ‹ Binance API è¿æ¥çŠ¶æ€ã€ä½™é¢å’Œå½“å‰ä»·æ ¼</p>
            <button class="btn btn-primary" onclick="testConnection()">
                <span id="connBtnText">æµ‹è¯•è¿æ¥</span>
            </button>
            <div class="output-box" id="connOutput"></div>
        </div>

        <!-- å¯åŠ¨å¼•æ“ -->
        <div class="ctrl-card">
            <h3>ğŸš€ å¯åŠ¨äº¤æ˜“å¼•æ“</h3>
            <p class="desc">é€‰æ‹©é˜¶æ®µå¹¶å¯åŠ¨åå°äº¤æ˜“å¼•æ“</p>
            <div class="btn-group">
                <select class="phase-select" id="enginePhase">
                    <option value="paper" selected>Phase 1: çº¸ä¸Šäº¤æ˜“</option>
                    <option value="testnet">Phase 2: æµ‹è¯•ç½‘</option>
                    <option value="small_live">Phase 3: å°èµ„é‡‘å®ç›˜</option>
                    <option value="scale_up">Phase 4: é€æ­¥åŠ ä»“</option>
                </select>
                <button class="btn btn-success" onclick="startEngine()">
                    <span id="startBtnText">å¯åŠ¨</span>
                </button>
                <button class="btn btn-outline" onclick="stopEngine()">åœæ­¢</button>
            </div>
            <div class="output-box" id="engineOutput"></div>
        </div>

        <!-- ç”Ÿæˆé…ç½® -->
        <div class="ctrl-card">
            <h3>âš™ï¸ ç”Ÿæˆé…ç½®æ¨¡æ¿</h3>
            <p class="desc">ç”Ÿæˆ live_trading_config.json é…ç½®æ¨¡æ¿æ–‡ä»¶</p>
            <button class="btn btn-primary" onclick="generateConfig()">
                <span id="genBtnText">ç”Ÿæˆé…ç½®</span>
            </button>
            <div class="output-box" id="genOutput"></div>
        </div>
    </div>

    <!-- Kill Switch -->
    <div class="ctrl-card" style="border-color: rgba(255,77,106,0.3);">
        <h3 style="color: var(--accent-red);">ğŸš¨ Kill Switch ç´§æ€¥å¹³ä»“</h3>
        <p class="desc">ç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“ã€æ’¤é”€æ‰€æœ‰æŒ‚å•ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
        <button class="kill-switch-btn" id="killBtn" onclick="killSwitch()">
            âš ï¸ ç´§æ€¥å¹³ä»“ (Kill Switch)
        </button>
        <div class="output-box" id="killOutput"></div>
    </div>

    <!-- é‡ç½®ç»Ÿè®¡ -->
    <div class="ctrl-card" style="border-color: rgba(255,170,0,0.3);">
        <h3 style="color: #ffaa00;">ğŸ”„ é‡ç½®ç»Ÿè®¡æ•°æ®</h3>
        <p class="desc">æ¸…é™¤ç´¯è®¡ç›ˆäºã€å³°å€¼æƒç›Šã€äº¤æ˜“è®°å½•ç­‰ç»Ÿè®¡æ•°æ®ã€‚ç”¨äºèµ„é‡‘å˜æ›´æˆ–é‡æ–°å¼€å§‹æ—¶ã€‚</p>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input type="number" id="resetCapital" placeholder="æ–°åˆå§‹èµ„é‡‘ (å¯é€‰)" step="100" min="0"
                   style="width:200px;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--card-bg);color:var(--text-primary);font-size:13px;">
            <button class="btn btn-outline" style="border-color:#ffaa00;color:#ffaa00;" onclick="resetStats()">
                é‡ç½®ç»Ÿè®¡
            </button>
        </div>
        <div class="output-box" id="resetOutput"></div>
    </div>
</div>

<!-- Tab: é…ç½® -->
<div class="tab-panel" id="tab-config">
    <!-- v11 åŠŸèƒ½å¼€å…³ -->
    <div class="ctrl-card" style="margin-bottom: 20px; border-color: rgba(74,158,255,0.3);">
        <h3>ğŸ§ª v11 ä¼˜åŒ–åŠŸèƒ½å¼€å…³</h3>
        <p class="desc">å›æµ‹éªŒè¯æœ‰æ•ˆçš„ v11 åŠŸèƒ½ï¼Œå¯åœ¨æ­¤å¿«é€Ÿå¼€å…³ã€‚ä¿®æ”¹åéœ€é‡å¯å¼•æ“ç”Ÿæ•ˆã€‚</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 16px;">
            <!-- Soft Anti-Squeeze -->
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px; border: 1px solid rgba(255,255,255,0.06);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">ğŸ›¡ï¸ Soft Anti-Squeeze</span>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
                        <input type="checkbox" id="toggle_soft_antisqueeze" onchange="onV11ToggleChange()"
                               style="opacity:0;width:0;height:0;">
                        <span style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.1);border-radius:12px;transition:0.3s;"></span>
                        <span id="toggle_soft_antisqueeze_dot" style="position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:0.3s;"></span>
                    </label>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                    å°†ç¡¬é—¨æ§ Anti-Squeeze æ›¿æ¢ä¸ºè¿ç»­ sigmoid æƒ©ç½šã€‚<br>
                    å¤šå¤´/ç©ºå¤´æ‹¥æŒ¤æ—¶å¯¹ SS/BS æ–½åŠ è¿ç»­æŠ˜æ‰£ï¼Œè€Œéç›´æ¥é˜»æ–­ã€‚<br>
                    <span style="color: var(--accent-green);">å›æµ‹æ•ˆæœ: OOS PF +0.04 (1.51â†’1.55)</span>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: var(--text-muted);">
                    å‚æ•°: midpoint=1.5, steepness=2.0, max_discount=50%
                </div>
            </div>

            <!-- Score Calibration -->
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px; border: 1px solid rgba(255,255,255,0.06);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">ğŸ¯ Score Calibration</span>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
                        <input type="checkbox" id="toggle_score_calibration" onchange="onV11ToggleChange()"
                               style="opacity:0;width:0;height:0;">
                        <span style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.1);border-radius:12px;transition:0.3s;"></span>
                        <span id="toggle_score_calibration_dot" style="position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:0.3s;"></span>
                    </label>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                    ä½¿ç”¨ isotonic regression å°† SS/BS æ˜ å°„ä¸º P(win) å’Œ E[R]ã€‚<br>
                    ä»…æ”¾è¡Œ E[R] > cost ä¸” P(win) > 0.48 çš„å…¥åœºä¿¡å·ã€‚<br>
                    <span style="color: var(--accent-green);">å›æµ‹æ•ˆæœ: OOS PF +30% (1.51â†’1.96)</span>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: var(--text-muted);">
                    <label style="cursor:pointer;">
                        <input type="checkbox" id="toggle_score_cal_shadow" checked onchange="onV11ToggleChange()"
                               style="margin-right:4px;">
                        Shadow æ¨¡å¼ (åªè®°å½•ä¸æ‹¦æˆªï¼Œå®‰å…¨è§‚å¯Ÿ)
                    </label>
                </div>
            </div>
        </div>

        <!-- ML Enhancement -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px;">
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px; border: 1px solid rgba(139,92,246,0.25);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">ğŸ§  ML Enhancement (ç¬¬ä¸ƒç»´åº¦)</span>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
                        <input type="checkbox" id="toggle_ml_enhancement" onchange="onV11ToggleChange()"
                               style="opacity:0;width:0;height:0;">
                        <span style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.1);border-radius:12px;transition:0.3s;"></span>
                        <span id="toggle_ml_enhancement_dot" style="position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:0.3s;"></span>
                    </label>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                    H800 GPU è®­ç»ƒ 8 æ¨¡å‹çŸ©é˜µèå…¥å…­ä¹¦ä¿¡å·ï¼Œäº”å±‚æ¶æ„ï¼š<br>
                    <span style="color: #a78bfa;">â‘  æ–¹å‘é¢„æµ‹</span> â€” LGB(AUC 0.55) + LSTM(0.54) åŠ æƒé›†æˆ â†’ bull_prob<br>
                    <span style="color: #a78bfa;">â‘¡ Regime è¿‡æ»¤</span> â€” æ³¢åŠ¨ç‡+è¶‹åŠ¿åˆ†ç±»ï¼Œè¶‹åŠ¿è¡Œæƒ… boost / éœ‡è¡è¡Œæƒ… dampen<br>
                    <span style="color: #a78bfa;">â‘¢ åˆ†ä½æ•°é£æ§</span> â€” æ”¶ç›Šåˆ†å¸ƒ q05~q95 â†’ Kelly ä»“ä½ + åŠ¨æ€æ­¢æŸ + å°¾éƒ¨é™æƒ<br>
                    <span style="color: #a78bfa;">â‘£ ç¥ç»èåˆ</span> â€” MTF Fusion MLP (AUC 0.56) æ›¿ä»£è§„åˆ™åŠ æƒå…±è¯† (å¯é€‰)<br>
                    <span style="color: #a78bfa;">â‘¤ æ‰§è¡Œå±‚</span> â€” bull_prob â‰¥ 0.58 åšå¤š / â‰¤ 0.42 åšç©º â†’ ä¿¡å·ä¹˜æ³•è°ƒæ•´
                </div>
                <div id="mlModelStatus" style="margin-top: 10px; font-size: 11px; color: var(--text-muted);">
                    æ¨¡å‹çŠ¶æ€: æ£€æŸ¥ä¸­...
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: var(--text-muted);">
                    <label style="cursor:pointer;">
                        <input type="checkbox" id="toggle_ml_shadow" checked onchange="onV11ToggleChange()"
                               style="margin-right:4px;">
                        Shadow æ¨¡å¼ (åªè®°å½• ML è¾“å‡ºï¼Œä¸å®é™…ä¿®æ”¹ä¿¡å·åˆ†æ•°)
                    </label>
                </div>

                <!-- GPU ML å­åŠŸèƒ½å¼€å…³ -->
                <div id="mlSubToggles" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(139,92,246,0.15);">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">
                        ğŸš€ GPU ML å­åŠŸèƒ½ <span style="color: var(--text-muted); font-weight: normal;">(shadow å…³é—­åç”Ÿæ•ˆ)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px;color:var(--text-secondary);background:rgba(0,0,0,0.2);padding:8px 10px;border-radius:8px;">
                            <input type="checkbox" id="toggle_ml_kelly" onchange="onV11ToggleChange()" style="accent-color:#a78bfa;">
                            <div>
                                <div style="font-weight:600;color:var(--text-primary);">Kelly ä»“ä½</div>
                                <div style="font-size:10px;margin-top:2px;">åŠ Kelly å…¬å¼ (0.1~1.0)</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px;color:var(--text-secondary);background:rgba(0,0,0,0.2);padding:8px 10px;border-radius:8px;">
                            <input type="checkbox" id="toggle_ml_dynamic_sl" onchange="onV11ToggleChange()" style="accent-color:#a78bfa;">
                            <div>
                                <div style="font-weight:600;color:var(--text-primary);">åŠ¨æ€æ­¢æŸ</div>
                                <div style="font-size:10px;margin-top:2px;">q05/q95 é©±åŠ¨ (1%~8%)</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px;color:var(--text-secondary);background:rgba(0,0,0,0.2);padding:8px 10px;border-radius:8px;">
                            <input type="checkbox" id="toggle_ml_neural_fusion" onchange="onV11ToggleChange()" style="accent-color:#a78bfa;">
                            <div>
                                <div style="font-weight:600;color:var(--text-primary);">ç¥ç»èåˆ</div>
                                <div style="font-size:10px;margin-top:2px;">MLP æ›¿ä»£è§„åˆ™åŠ æƒ</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="btn-group" style="margin-top: 16px;">
            <button class="btn btn-primary btn-sm" onclick="saveV11Toggles()">
                <span id="v11SaveBtnText">ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨</span>
            </button>
            <button class="btn btn-outline btn-sm" onclick="loadV11Toggles()">åˆ·æ–°çŠ¶æ€</button>
        </div>
        <div id="v11ToggleResult" style="margin-top: 8px;"></div>
    </div>

    <div class="ctrl-card">
        <h3>ğŸ“ é…ç½®æ–‡ä»¶ç¼–è¾‘å™¨</h3>
        <p class="desc">ç¼–è¾‘ live_trading_config.json â€” ä¿®æ”¹ API Keyã€äº¤æ˜“å‚æ•°ã€é£æ§è®¾ç½®</p>
        <div class="btn-group" style="margin-bottom: 16px;">
            <button class="btn btn-outline btn-sm" onclick="loadConfig()">åŠ è½½é…ç½®</button>
            <button class="btn btn-primary btn-sm" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            <button class="btn btn-outline btn-sm" onclick="generateConfig()">é‡æ–°ç”Ÿæˆæ¨¡æ¿</button>
        </div>
        <textarea class="config-editor" id="configEditor" spellcheck="false" placeholder='ç‚¹å‡» "åŠ è½½é…ç½®" æˆ– "é‡æ–°ç”Ÿæˆæ¨¡æ¿" å¼€å§‹...'></textarea>
        <div id="configResult"></div>
    </div>
</div>

<!-- Tab: çŠ¶æ€ç›‘æ§ -->
<div class="tab-panel" id="tab-status">
    <div class="ctrl-card" style="margin-bottom: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3>ğŸ“Š å¼•æ“çŠ¶æ€</h3>
            <button class="btn btn-outline btn-sm" onclick="refreshStatus()">åˆ·æ–°</button>
        </div>
        <div class="info-grid" id="statusGrid">
            <div class="info-item"><div class="label">è¿›ç¨‹çŠ¶æ€</div><div class="value" id="s_proc">--</div></div>
            <div class="info-item"><div class="label">è¿è¡Œé˜¶æ®µ</div><div class="value" id="s_phase">--</div></div>
            <div class="info-item"><div class="label">USDT ä½™é¢</div><div class="value" id="s_usdt">--</div></div>
            <div class="info-item"><div class="label">å†»ç»“ä¿è¯é‡‘</div><div class="value" id="s_frozen">--</div></div>
            <div class="info-item"><div class="label">æ€»Kçº¿</div><div class="value" id="s_bars">--</div></div>
            <div class="info-item"><div class="label">æŒä»“</div><div class="value" id="s_positions">--</div></div>
        </div>
    </div>
    <div class="grid-2">
        <div class="ctrl-card">
            <h3>ğŸ›¡ï¸ é£æ§çŠ¶æ€</h3>
            <div class="info-grid" id="riskGrid">
                <div class="info-item"><div class="label">æš‚åœçŠ¶æ€</div><div class="value" id="r_paused">--</div></div>
                <div class="info-item"><div class="label">Kill Switch</div><div class="value" id="r_kill">--</div></div>
                <div class="info-item"><div class="label">æ—¥ç›ˆäº</div><div class="value" id="r_daily">--</div></div>
                <div class="info-item"><div class="label">è¿ç»­äºæŸ</div><div class="value" id="r_consec">--</div></div>
                <div class="info-item"><div class="label">æœ€å¤§å›æ’¤</div><div class="value" id="r_dd">--</div></div>
                <div class="info-item"><div class="label">æ€»äº¤æ˜“</div><div class="value" id="r_trades">--</div></div>
            </div>
        </div>
        <div class="ctrl-card">
            <h3>ğŸ’° ç»©æ•ˆç»Ÿè®¡</h3>
            <div class="info-grid" id="perfGrid">
                <div class="info-item"><div class="label">æœªå®ç°ç›ˆäº</div><div class="value" id="p_unrealized">--</div></div>
                <div class="info-item"><div class="label">å·²å®ç°ç›ˆäº</div><div class="value" id="p_pnl">--</div></div>
                <div class="info-item"><div class="label">èƒœç‡</div><div class="value" id="p_winrate">--</div></div>
                <div class="info-item"><div class="label">æ€»æ‰‹ç»­è´¹</div><div class="value" id="p_fees">--</div></div>
                <div class="info-item"><div class="label">å³°å€¼æƒç›Š</div><div class="value" id="p_peak">--</div></div>
                <div class="info-item"><div class="label">å½“å‰æƒç›Š</div><div class="value" id="p_equity">--</div></div>
            </div>
        </div>
    </div>

    <div class="ctrl-card" style="margin-bottom: 20px;">
        <div class="history-toolbar">
            <h3>ğŸ“ˆ å®ç›˜äº¤æ˜“ç»Ÿè®¡</h3>
            <div class="btn-group">
                <select id="historyDays" class="history-select" onchange="refreshLiveHistoryData()">
                    <option value="7">æœ€è¿‘7å¤©</option>
                    <option value="14">æœ€è¿‘14å¤©</option>
                    <option value="30" selected>æœ€è¿‘30å¤©</option>
                    <option value="60">æœ€è¿‘60å¤©</option>
                </select>
                <button class="btn btn-outline btn-sm" onclick="refreshLiveHistoryData()">åˆ·æ–°äº¤æ˜“è®°å½•</button>
            </div>
        </div>
        <div class="history-grid">
            <div class="history-metric"><div class="label">æ€»äº¤æ˜“</div><div class="value" id="h_total_trades">--</div></div>
            <div class="history-metric"><div class="label">å·²å®ç°äº¤æ˜“</div><div class="value" id="h_realized">--</div></div>
            <div class="history-metric"><div class="label">èƒœç‡</div><div class="value" id="h_win_rate">--</div></div>
            <div class="history-metric"><div class="label">å·²å®ç°PnL</div><div class="value" id="h_realized_pnl">--</div></div>
            <div class="history-metric"><div class="label">æ‰‹ç»­è´¹</div><div class="value" id="h_fees">--</div></div>
            <div class="history-metric"><div class="label">å‡€PnL(ä¼°ç®—)</div><div class="value" id="h_net_pnl">--</div></div>
        </div>
        <div class="history-note" id="historyBalanceNote">æœ€æ–°ä½™é¢å¿«ç…§: --</div>
        <div class="ops-hint" id="opsActionHint">ç›‘æ§å»ºè®®: --</div>
    </div>

    <div class="ctrl-card" style="margin-bottom: 20px;">
        <div class="history-toolbar">
            <h3>ğŸ§­ v7.0 é¦–å‘¨ç›‘æ§æŒ‡æ ‡</h3>
            <div class="btn-group">
                <button class="btn btn-outline btn-sm" onclick="generateDailyReport()">ç”Ÿæˆæ—¥æŠ¥</button>
                <button class="btn btn-outline btn-sm" onclick="copyDailyReport()">å¤åˆ¶æ—¥æŠ¥</button>
                <button class="btn btn-outline btn-sm" onclick="loadMonitorRules()">åŠ è½½é˜ˆå€¼</button>
                <button class="btn btn-outline btn-sm" onclick="saveMonitorRules()">ä¿å­˜é˜ˆå€¼</button>
            </div>
        </div>
        <div class="history-grid" style="margin-bottom:10px;">
            <div class="history-metric">
                <div class="label">PFé¢„è­¦é˜ˆå€¼</div>
                <input id="rule_pf_threshold" class="history-select" type="number" step="0.01" min="0.1" max="5" value="1.00" style="width:100%;margin-top:6px;">
            </div>
            <div class="history-metric">
                <div class="label">PFæœ€å°æ ·æœ¬æ•°</div>
                <input id="rule_pf_min_count" class="history-select" type="number" step="1" min="1" max="200" value="8" style="width:100%;margin-top:6px;">
            </div>
            <div class="history-metric">
                <div class="label">è¿äºå¤©æ•°é¢„è­¦</div>
                <input id="rule_loss_streak_days" class="history-select" type="number" step="1" min="1" max="30" value="3" style="width:100%;margin-top:6px;">
            </div>
            <div class="history-metric">
                <div class="label">æœ€å·®å•æ—¥å‡€PnLé˜ˆå€¼</div>
                <input id="rule_worst_day_alert" class="history-select" type="number" step="100" min="-1000000" max="-1" value="-2000" style="width:100%;margin-top:6px;">
            </div>
        </div>
        <div class="history-note" id="monitorRulesNote">é˜ˆå€¼çŠ¶æ€: é»˜è®¤</div>
        <div class="history-grid">
            <div class="history-metric"><div class="label">å·²å®ç°PF</div><div class="value" id="h_realized_pf">--</div></div>
            <div class="history-metric"><div class="label">è´¹ç”¨æ‹–ç´¯</div><div class="value" id="h_fee_drag">--</div></div>
            <div class="history-metric"><div class="label">æœ€ä½³å•æ—¥å‡€PnL</div><div class="value" id="h_best_day">--</div></div>
            <div class="history-metric"><div class="label">æœ€å·®å•æ—¥å‡€PnL</div><div class="value" id="h_worst_day">--</div></div>
            <div class="history-metric"><div class="label">è¿äºå¤©æ•°(æœ€å¤§)</div><div class="value" id="h_max_loss_streak_days">--</div></div>
            <div class="history-metric"><div class="label">è¿äºå¤©æ•°(å½“å‰)</div><div class="value" id="h_current_loss_streak_days">--</div></div>
        </div>
        <div class="report-card">
            <div class="history-note">æ—¥æŠ¥æ¨¡æ¿ï¼ˆå¯ç›´æ¥å‘ç¾¤/å½’æ¡£ï¼‰</div>
            <div class="report-toolbar">
                <button class="btn btn-outline btn-sm" onclick="generateDailyReport()">åˆ·æ–°æ¨¡æ¿</button>
                <button class="btn btn-outline btn-sm" onclick="copyDailyReport()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
            <textarea id="dailyReportTemplate" class="report-editor" readonly>æš‚æ— æ—¥æŠ¥æ•°æ®ï¼Œç‚¹å‡»â€œåˆ·æ–°æ¨¡æ¿â€ç”Ÿæˆã€‚</textarea>
        </div>
    </div>

    <div class="ctrl-card" style="margin-bottom: 20px;">
        <div class="history-toolbar">
            <h3>ğŸ¤– ML Shadow è¯Šæ–­</h3>
            <div class="btn-group">
                <select id="mlDiagDays" class="history-select" onchange="refreshMLDiagnostic()">
                    <option value="3">æœ€è¿‘3å¤©</option>
                    <option value="7" selected>æœ€è¿‘7å¤©</option>
                    <option value="14">æœ€è¿‘14å¤©</option>
                    <option value="30">æœ€è¿‘30å¤©</option>
                </select>
                <button class="btn btn-outline btn-sm" onclick="refreshMLDiagnostic()">åˆ·æ–°</button>
            </div>
        </div>
        <div class="history-grid" style="margin-bottom:10px;">
            <div class="history-metric"><div class="label">æ—¥å¿—æ–‡ä»¶</div><div class="value" id="ml_log_files">--</div></div>
            <div class="history-metric"><div class="label">ä¿¡å·æ€»æ•°</div><div class="value" id="ml_total_signals">--</div></div>
            <div class="history-metric"><div class="label">ML è¦†ç›–ç‡</div><div class="value" id="ml_coverage">--</div></div>
            <div class="history-metric"><div class="label">ML æŠ¥é”™æ•°</div><div class="value" id="ml_errors">--</div></div>
            <div class="history-metric"><div class="label">Bull Prob å‡å€¼</div><div class="value" id="ml_bull_mean">--</div></div>
            <div class="history-metric"><div class="label">Bull Prob ä¸­ä½æ•°</div><div class="value" id="ml_bull_median">--</div></div>
        </div>
        <div class="history-grid" style="margin-bottom:10px;">
            <div class="history-metric"><div class="label">çœ‹å¤šä¿¡å·</div><div class="value" id="ml_dir_long">--</div></div>
            <div class="history-metric"><div class="label">çœ‹ç©ºä¿¡å·</div><div class="value" id="ml_dir_short">--</div></div>
            <div class="history-metric"><div class="label">ä¸­æ€§ä¿¡å·</div><div class="value" id="ml_dir_neutral">--</div></div>
            <div class="history-metric"><div class="label">Regime åˆ†å¸ƒ</div><div class="value" id="ml_regime_dist" style="font-size:12px;">--</div></div>
            <div class="history-metric"><div class="label">è¿œç¨‹æ¨ç†å‘½ä¸­</div><div class="value" id="ml_remote_count">--</div></div>
            <div class="history-metric"><div class="label">Stackingç¦ç”¨/è·³è¿‡/CAè·³è¿‡</div><div class="value" id="ml_skip_counts" style="font-size:12px;">--</div></div>
        </div>
        <div id="mlErrorList" style="display:none; margin-bottom:10px;">
            <div class="history-note" style="color:#e07070;">ML é”™è¯¯æ‘˜è¦:</div>
            <div id="mlErrorItems"></div>
        </div>
        <div id="mlStackingList" style="display:none; margin-bottom:10px;">
            <div class="history-note" style="color:#e0b070;">Stacking/è·¨èµ„äº§é—¨æ§æ‘˜è¦:</div>
            <div id="mlStackingItems"></div>
        </div>
        <div class="history-note" id="mlDiagNote">ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®</div>
        <div id="mlSignalTableWrap" style="display:none; margin-top:10px;">
            <div class="history-note">æœ€è¿‘ ML ä¿¡å·ï¼ˆæœ€å¤š20æ¡ï¼‰</div>
            <div class="table-wrap">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th><th>å‘¨æœŸ</th><th>Bull Prob</th><th>æ–¹å‘</th><th>Regime</th><th>Kelly</th><th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="mlSignalTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid-1">
        <div class="ctrl-card">
            <h3>ğŸ“† é€æ—¥ç›ˆäº</h3>
            <div class="table-wrap">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>äº¤æ˜“</th>
                            <th>å·²å®ç°PnL</th>
                            <th>è´¹ç”¨</th>
                            <th>Funding</th>
                            <th>å‡€PnL</th>
                            <th>èƒœç‡</th>
                            <th>æ”¶ç›˜æƒç›Š</th>
                        </tr>
                    </thead>
                    <tbody id="dailyPnlBody">
                        <tr><td colspan="8" style="color:var(--text-muted);">æš‚æ— æ•°æ®</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="grid-1">
        <div class="ctrl-card">
            <h3>ğŸ§¾ å†å²äº¤æ˜“è®°å½•</h3>
            <div class="table-wrap">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>åŠ¨ä½œ</th>
                            <th>æ–¹å‘</th>
                            <th>æ•°é‡@ä»·æ ¼</th>
                            <th>PnL</th>
                            <th>è´¹ç”¨</th>
                            <th>åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistoryBody">
                        <tr><td colspan="7" style="color:var(--text-muted);">æš‚æ— æ•°æ®</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Tab: æ—¥å¿— -->
<div class="tab-panel" id="tab-logs">
    <div class="ctrl-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
            <div class="btn-group">
                <button class="btn btn-outline btn-sm" onclick="refreshLogs()">åˆ·æ–°</button>
                <button class="btn btn-outline btn-sm" onclick="autoRefreshLogs()">
                    <span id="autoLogBtn">è‡ªåŠ¨åˆ·æ–°: å¼€</span>
                </button>
            </div>
        </div>
        <div id="logFile" style="font-size:12px; color:var(--text-muted); margin-bottom:8px;"></div>
        <div class="output-box visible" id="logOutput" style="max-height:600px; min-height:300px;">æš‚æ— æ—¥å¿—</div>
    </div>
</div>

<script>
// ============================================================
// Tab åˆ‡æ¢
// ============================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        saveActiveTab(btn.dataset.tab);
        // åˆ‡æ¢åˆ°æ—¥å¿— Tab æ—¶è‡ªåŠ¨åŠ è½½
        if (btn.dataset.tab === 'logs') refreshLogs();
        // åˆ‡æ¢åˆ°çŠ¶æ€ Tab æ—¶è‡ªåŠ¨åˆ·æ–°
        if (btn.dataset.tab === 'status') refreshStatus();
    });
});

// ============================================================
// é€šç”¨å·¥å…·
// ============================================================
function showOutput(id, text, type) {
    const box = document.getElementById(id);
    box.classList.add('visible');
    // ç€è‰²å¤„ç†
    const colored = text
        .replace(/^(.*âœ….*|.*æˆåŠŸ.*|.*PASSED.*|.*active.*)$/gm, '<span class="line-ok">$1</span>')
        .replace(/^(.*âŒ.*|.*å¤±è´¥.*|.*ERROR.*|.*FAILED.*)$/gm, '<span class="line-err">$1</span>')
        .replace(/^(.*âš ï¸.*|.*WARNING.*|.*WARN.*)$/gm, '<span class="line-warn">$1</span>')
        .replace(/^(.*â•â•â•.*|.*---.*|.*INFO.*)$/gm, '<span class="line-info">$1</span>');
    box.innerHTML = colored;
    box.scrollTop = box.scrollHeight;
}

function setLoading(btnId, loading) {
    const el = document.getElementById(btnId);
    if (loading) {
        el.dataset.origText = el.textContent;
        el.innerHTML = '<span class="spinner-sm"></span> æ‰§è¡Œä¸­...';
        el.closest('button')?.setAttribute('disabled', '');
    } else {
        el.textContent = el.dataset.origText || el.textContent;
        el.closest('button')?.removeAttribute('disabled');
    }
}

async function apiCall(url, options = {}, timeoutMs = 30000) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    let resp;
    try {
        resp = await fetch(url, {
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal,
            ...options
        });
    } catch (e) {
        if (e && e.name === 'AbortError') {
            throw new Error(`è¯·æ±‚è¶…æ—¶ (${Math.round(timeoutMs / 1000)}s)`);
        }
        throw e;
    } finally {
        clearTimeout(timer);
    }
    // ä¼šè¯è¿‡æœŸ â†’ è‡ªåŠ¨è·³è½¬ç™»å½•
    if (resp.status === 401) {
        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
        throw new Error('ä¼šè¯å·²è¿‡æœŸï¼Œæ­£åœ¨è·³è½¬ç™»å½•...');
    }
    // é JSON å“åº”ï¼ˆå¦‚æ„å¤–çš„ HTML é‡å®šå‘ï¼‰
    const ct = resp.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
        throw new Error('æœåŠ¡å™¨è¿”å›äº†é JSON å“åº”ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•');
    }
    return await resp.json();
}

// ============================================================
// æ“ä½œå‡½æ•°
// ============================================================
// ============================================================
// localStorage æŒä¹…åŒ–
// ============================================================
const LS_KEY_TFS = 'lc_selected_tfs';
const LS_KEY_RESULT = 'lc_last_result';
const LS_KEY_TAB = 'lc_active_tab';
const LS_KEY_AUTO = 'lc_auto_detect';
const LS_KEY_AUTO_INTERVAL = 'lc_auto_interval';
let _lastSignalTsEpoch = 0;
let _signalMultiFailCount = 0;
let _signalMultiLastOkAt = 0;

function _fmtAgo(secAgo) {
    if (secAgo < 60) return `${secAgo}ç§’å‰`;
    if (secAgo < 3600) return `${Math.floor(secAgo / 60)}åˆ†é’Ÿå‰`;
    return `${Math.floor(secAgo / 3600)}å°æ—¶å‰`;
}

function updateSignalHealth(state, detail = '') {
    const el = document.getElementById('signalMultiHealth');
    if (!el) return;
    const now = Math.floor(Date.now() / 1000);
    const okAgo = _signalMultiLastOkAt ? _fmtAgo(Math.max(0, now - _signalMultiLastOkAt)) : 'æš‚æ— ';
    const failText = _signalMultiFailCount > 0 ? ` Â· è¿ç»­å¤±è´¥ ${_signalMultiFailCount} æ¬¡` : '';
    const suffix = detail ? ` Â· ${detail}` : '';
    if (state === 'running') {
        el.textContent = `ğŸŸ¡ çŠ¶æ€: æ£€æµ‹ä¸­${failText}${suffix}`;
        el.style.color = 'var(--text-muted)';
    } else if (state === 'ok') {
        el.textContent = `ğŸŸ¢ çŠ¶æ€: æ­£å¸¸ Â· ä¸Šæ¬¡æˆåŠŸ ${okAgo}${failText}${suffix}`;
        el.style.color = 'var(--accent-green)';
    } else if (state === 'fail') {
        el.textContent = `ğŸ”´ çŠ¶æ€: å¼‚å¸¸ Â· ä¸Šæ¬¡æˆåŠŸ ${okAgo}${failText}${suffix}`;
        el.style.color = 'var(--accent-red)';
    } else {
        el.textContent = `ğŸŸ¡ çŠ¶æ€: ç©ºé—² Â· ä¸Šæ¬¡æˆåŠŸ ${okAgo}${failText}${suffix}`;
        el.style.color = 'var(--text-muted)';
    }
}

function saveTFSelection() {
    const tfs = [];
    document.querySelectorAll('#tfCheckboxes input').forEach(cb => {
        if (cb.checked) tfs.push(cb.value);
    });
    try { localStorage.setItem(LS_KEY_TFS, JSON.stringify(tfs)); } catch(e) {}
}

function restoreTFSelection() {
    try {
        const saved = localStorage.getItem(LS_KEY_TFS);
        if (!saved) return;
        const tfs = JSON.parse(saved);
        if (!Array.isArray(tfs)) return;
        document.querySelectorAll('#tfCheckboxes input').forEach(cb => {
            const checked = tfs.includes(cb.value);
            cb.checked = checked;
            cb.closest('.tf-chip').classList.toggle('checked', checked);
        });
    } catch(e) {}
}

function saveLastResult(data) {
    try {
        const payload = { data, ts: Date.now() };
        localStorage.setItem(LS_KEY_RESULT, JSON.stringify(payload));
    } catch(e) {}
}

async function restoreLastResult() {
    // ä¼˜å…ˆçº§: æœåŠ¡å™¨ç¼“å­˜ > localStorage
    let restored = false;

    // 1. å°è¯•ä»æœåŠ¡å™¨è¯»å–ç¼“å­˜
    try {
        const resp = await fetch('/api/live/signal_cache');
        const cache = await resp.json();
        if (cache.success && cache.data && cache.data.results) {
            // ç¼“å­˜ä¸è¶…è¿‡ 2 å°æ—¶æ‰æ¢å¤
            if (cache.age_sec < 7200) {
                renderMultiSignalResult(cache.data);
                _showCacheHint(`ğŸ“Œ æœåŠ¡å™¨ç¼“å­˜ (${cache.age_text})`, cache.timeframes);
                _lastSignalTsEpoch = Number(cache.ts_epoch || 0) || Math.floor(Date.now() / 1000);
                _signalMultiLastOkAt = _lastSignalTsEpoch;
                // åŒæ­¥åˆ° localStorage
                saveLastResult(cache.data);
                restored = true;
            }
        }
    } catch(e) { /* æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œfallback */ }

    // 2. æœåŠ¡å™¨ç¼“å­˜ä¸å¯ç”¨ â†’ ä» localStorage æ¢å¤
    if (!restored) {
        try {
            const saved = localStorage.getItem(LS_KEY_RESULT);
            if (!saved) return;
            const { data, ts } = JSON.parse(saved);
            if (!data || !data.results) return;
            if (Date.now() - ts > 2 * 60 * 60 * 1000) return;
            renderMultiSignalResult(data);
            _lastSignalTsEpoch = Math.floor((Number(ts) || Date.now()) / 1000);
            _signalMultiLastOkAt = _lastSignalTsEpoch;
            const ago = Math.round((Date.now() - ts) / 1000);
            const agoText = ago < 60 ? `${ago}ç§’å‰` : `${Math.round(ago/60)}åˆ†é’Ÿå‰`;
            _showCacheHint(`ğŸ“Œ æµè§ˆå™¨ç¼“å­˜ (${agoText})`);
        } catch(e) {}
    }
    updateSignalHealth('idle');
}

function _showCacheHint(text, timeframes) {
    const hint = document.getElementById('signalCacheHint');
    if (hint) {
        let html = text;
        if (timeframes && timeframes.length) {
            html += ` Â· å‘¨æœŸ: ${timeframes.join(', ')}`;
        }
        hint.innerHTML = html;
        hint.style.display = 'block';
    }
    // ä¹Ÿåœ¨å…±è¯†é¢æ¿åº•éƒ¨æ·»åŠ 
    const cEl = document.getElementById('signalConsensus');
    if (cEl) {
        const div = document.createElement('div');
        div.style.cssText = 'font-size:11px;color:var(--text-muted);margin-top:4px;text-align:right;';
        div.textContent = text;
        cEl.appendChild(div);
    }
}

function saveActiveTab(tabName) {
    try { localStorage.setItem(LS_KEY_TAB, tabName); } catch(e) {}
}

function restoreActiveTab() {
    try {
        const saved = localStorage.getItem(LS_KEY_TAB);
        if (!saved) return;
        const btn = document.querySelector(`.tab-btn[data-tab="${saved}"]`);
        if (btn) btn.click();
    } catch(e) {}
}

// ============================================================
// è‡ªåŠ¨å®šæ—¶æ£€æµ‹
// ============================================================
let _autoDetectTimer = null;
let _autoDetectCountdown = null;

function toggleAutoDetect() {
    if (_autoDetectTimer) {
        // å…³é—­
        clearInterval(_autoDetectTimer);
        clearInterval(_autoDetectCountdown);
        _autoDetectTimer = null;
        _autoDetectCountdown = null;
        document.getElementById('autoDetectText').textContent = 'è‡ªåŠ¨æ£€æµ‹: å…³';
        document.getElementById('autoDetectBtn').classList.remove('btn-success');
        document.getElementById('autoDetectBtn').classList.add('btn-outline');
        document.getElementById('signalMultiTimer').textContent = '';
        try { localStorage.removeItem(LS_KEY_AUTO); } catch(e) {}
    } else {
        // å¼€å¯
        const intervalSec = parseInt(document.getElementById('autoDetectInterval').value) || 900;
        _startAutoDetect(intervalSec);
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        if (!_signalMultiRunning) testSignalMulti();
    }
}

function _startAutoDetect(intervalSec) {
    document.getElementById('autoDetectText').textContent = `è‡ªåŠ¨æ£€æµ‹: å¼€`;
    document.getElementById('autoDetectBtn').classList.remove('btn-outline');
    document.getElementById('autoDetectBtn').classList.add('btn-success');

    // ä¿å­˜çŠ¶æ€
    try {
        localStorage.setItem(LS_KEY_AUTO, JSON.stringify({ on: true, interval: intervalSec }));
    } catch(e) {}

    // è®¾å®šé—´éš”
    _autoDetectTimer = setInterval(() => {
        if (!_signalMultiRunning) testSignalMulti();
    }, intervalSec * 1000);

    // å€’è®¡æ—¶æ˜¾ç¤º
    let remaining = intervalSec;
    const timerEl = document.getElementById('signalMultiTimer');
    _autoDetectCountdown = setInterval(() => {
        remaining--;
        if (remaining <= 0) remaining = intervalSec;
        if (!_signalMultiRunning) {
            const m = Math.floor(remaining / 60);
            const s = remaining % 60;
            timerEl.textContent = `ä¸‹æ¬¡æ£€æµ‹: ${m}:${s.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

function onAutoDetectIntervalChange() {
    // å¦‚æœè‡ªåŠ¨æ£€æµ‹æ­£åœ¨è¿è¡Œ, ç”¨æ–°é—´éš”é‡å¯å®šæ—¶å™¨
    if (_autoDetectTimer) {
        clearInterval(_autoDetectTimer);
        clearInterval(_autoDetectCountdown);
        _autoDetectTimer = null;
        _autoDetectCountdown = null;
        const intervalSec = parseInt(document.getElementById('autoDetectInterval').value) || 900;
        _startAutoDetect(intervalSec);
    }
}

function restoreAutoDetect() {
    try {
        const saved = localStorage.getItem(LS_KEY_AUTO);
        if (!saved) return;
        const { on, interval } = JSON.parse(saved);
        if (!on) return;
        // æ¢å¤ interval ä¸‹æ‹‰æ¡†
        const sel = document.getElementById('autoDetectInterval');
        if (sel) {
            for (const opt of sel.options) {
                if (parseInt(opt.value) === interval) { opt.selected = true; break; }
            }
        }
        _startAutoDetect(interval);
        // æ¢å¤åè‹¥ä¸Šæ¬¡ç»“æœè¿‡æ—§(è¶…è¿‡è®¾å®šé—´éš”)æˆ–æ— å†å²ç»“æœï¼Œç«‹å³è¡¥è·‘ä¸€æ¬¡
        const nowSec = Math.floor(Date.now() / 1000);
        if (!_signalMultiRunning && (!_lastSignalTsEpoch || (nowSec - _lastSignalTsEpoch) >= interval)) {
            testSignalMulti();
        }
    } catch(e) {}
}

// ============================================================

function toggleTFChip(label) {
    const cb = label.querySelector('input');
    cb.checked = !cb.checked;
    label.classList.toggle('checked', cb.checked);
    saveTFSelection();
}

function selectAllTF(checked) {
    document.querySelectorAll('#tfCheckboxes input').forEach(cb => {
        cb.checked = checked;
        cb.closest('.tf-chip').classList.toggle('checked', checked);
    });
    saveTFSelection();
}

/** ä¸å½“å‰ç­–ç•¥ä¸€è‡´ï¼šä»…å‹¾é€‰å†³ç­–å‘¨æœŸ 15mã€1hã€4hã€24h */
function setStrategyDefaultTFs() {
    const strategyTFs = ['15m', '1h', '4h', '24h'];
    document.querySelectorAll('#tfCheckboxes input').forEach(cb => {
        const checked = strategyTFs.includes(cb.value);
        cb.checked = checked;
        cb.closest('.tf-chip').classList.toggle('checked', checked);
    });
    saveTFSelection();
}

function getSelectedTFs() {
    const tfs = [];
    document.querySelectorAll('#tfCheckboxes input:checked').forEach(cb => tfs.push(cb.value));
    return tfs;
}

let _signalMultiRunning = false;

async function testSignalMulti() {
    if (_signalMultiRunning) return;          // é˜²æ­¢é‡å¤è§¦å‘
    const tfs = getSelectedTFs();
    if (tfs.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¶é—´æ¡†æ¶'); return; }

    _signalMultiRunning = true;
    updateSignalHealth('running');
    setLoading('signalMultiBtnText', true);
    // åŒæ—¶ç¦ç”¨å…¨é€‰/å…¨ä¸é€‰æŒ‰é’®ï¼Œé¿å…æ£€æµ‹ä¸­ä¿®æ”¹TF
    document.querySelectorAll('#tfCheckboxes .tf-chip').forEach(l => l.style.pointerEvents = 'none');

    const timerEl = document.getElementById('signalMultiTimer');
    const t0 = Date.now();
    const timer = setInterval(() => {
        timerEl.textContent = `å·²ç”¨æ—¶ ${((Date.now() - t0) / 1000).toFixed(0)}s ...`;
    }, 500);

    try {
        const data = await apiCall('/api/live/test_signal_multi', {
            method: 'POST',
            body: JSON.stringify({ timeframes: tfs })
        }, 330000);

        clearInterval(timer);
        timerEl.textContent = '';

        if (data.data && data.data.results) {
            renderMultiSignalResult(data.data);
            saveLastResult(data.data);
            // æ›´æ–°ç¼“å­˜æç¤º
            const hint = document.getElementById('signalCacheHint');
            if (hint) {
                hint.innerHTML = `âœ… åˆšåˆšæ£€æµ‹å®Œæˆ Â· ${new Date().toLocaleTimeString('zh-CN')}`;
                hint.style.display = 'block';
            }
            _lastSignalTsEpoch = Math.floor(Date.now() / 1000);
            _signalMultiLastOkAt = _lastSignalTsEpoch;
            _signalMultiFailCount = 0;
            updateSignalHealth('ok', 'æ£€æµ‹å®Œæˆ');
        }
        // åŒæ—¶æ˜¾ç¤ºæ–‡æœ¬è¾“å‡ºï¼ˆå¯æŠ˜å ï¼‰
        if (data.output) {
            showOutput('signalOutput', data.output);
        } else if (data.error) {
            showOutput('signalOutput', data.error);
            _signalMultiFailCount += 1;
            updateSignalHealth('fail', data.error);
        }
    } catch(e) {
        clearInterval(timer);
        timerEl.textContent = '';
        showOutput('signalOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
        _signalMultiFailCount += 1;
        updateSignalHealth('fail', e.message);
    }
    setLoading('signalMultiBtnText', false);
    document.querySelectorAll('#tfCheckboxes .tf-chip').forEach(l => l.style.pointerEvents = '');
    _signalMultiRunning = false;
}

function renderMultiSignalResult(data) {
    const container = document.getElementById('signalMultiResult');
    const tbody = document.getElementById('signalMultiBody');
    const consensusEl = document.getElementById('signalConsensus');

    container.style.display = 'block';
    tbody.innerHTML = '';

    for (const r of data.results) {
        const tr = document.createElement('tr');
        if (r.ok) {
            let actionClass = 'action-hold';
            let actionIcon = 'âšª';
            if (r.action && r.action.includes('LONG')) { actionClass = 'action-long'; actionIcon = 'ğŸŸ¢'; }
            else if (r.action && r.action.includes('SHORT')) { actionClass = 'action-short'; actionIcon = 'ğŸ”´'; }

            tr.innerHTML = `
                <td><strong>${r.tf}</strong></td>
                <td>$${r.price.toFixed(2)}</td>
                <td style="color:${r.sell_score > 30 ? 'var(--accent-red)' : 'var(--text-secondary)'}">${r.sell_score.toFixed(1)}</td>
                <td style="color:${r.buy_score > 30 ? 'var(--accent-green)' : 'var(--text-secondary)'}">${r.buy_score.toFixed(1)}</td>
                <td class="${actionClass}">${actionIcon} ${r.action || 'HOLD'}</td>
                <td style="font-size:11px;color:var(--text-secondary)">${r.reason || ''}</td>
                <td style="color:var(--text-muted)">${r.elapsed}s</td>
            `;
        } else {
            tr.innerHTML = `
                <td><strong>${r.tf}</strong></td>
                <td colspan="5" style="color:var(--accent-red)">âŒ ${r.error || 'å¤±è´¥'}</td>
                <td style="color:var(--text-muted)">${r.elapsed || 0}s</td>
            `;
        }
        tbody.appendChild(tr);
    }

    // â•â•â• æ¸²æŸ“æ™ºèƒ½å…±è¯†é¢æ¿ â•â•â•
    const c = data.consensus || {};
    const dec = c.decision || {};
    const ws = c.weighted_scores || {};
    const chains = c.resonance_chains || [];
    const largeSig = c.large_tf_signal || {};
    const totalN = data.results.filter(r => r.ok).length;

    // å†³ç­–æ–¹å‘ â†’ CSS class
    const dir = dec.direction || 'hold';
    let consensusClass = dir === 'long' ? 'long' : dir === 'short' ? 'short' : 'neutral';
    if (dec.label && dec.label.includes('åˆ†æ­§')) consensusClass = 'conflict';
    if (dec.label && dec.label.includes('åå‘')) consensusClass = 'conflict';

    // å¼ºåº¦æ¡é¢œè‰²
    const barClass = dir === 'long' ? 'long' : dir === 'short' ? 'short' : 'hold';
    const strength = dec.strength || 0;

    let html = '';

    // 1. å†³ç­–æ ‡é¢˜
    html += `<div class="consensus-decision">${dec.label || 'âšª æ— ä¿¡å·'}</div>`;

    // 2. å¼ºåº¦æ¡
    html += `<div class="consensus-strength">
        <span style="font-size:12px;color:var(--text-muted);">ä¿¡å·å¼ºåº¦</span>
        <div class="strength-bar-bg">
            <div class="strength-bar-fill ${barClass}" style="width:${strength}%"></div>
        </div>
        <span class="strength-label" style="color:${strength >= 50 ? (dir==='long'?'var(--accent-green)':'var(--accent-red)') : 'var(--text-muted)'}">${strength}/100</span>
    </div>`;

    // 3. ç†ç”±
    if (dec.reason) {
        html += `<div class="consensus-reason">ğŸ“ ${dec.reason}</div>`;
    }

    // 4. è¯¦ç»†é¢æ¿ (2x2 grid)
    html += `<div class="consensus-detail-grid">`;

    // 4a. åŠ æƒå¾—åˆ†
    html += `<div class="detail-card">
        <div class="detail-title">åŠ æƒå¾—åˆ†</div>
        <div class="detail-value">
            <span style="color:var(--accent-green)">å¤š ${(ws.long||0).toFixed(1)}</span>
            <span style="color:var(--text-muted);margin:0 6px">|</span>
            <span style="color:var(--accent-red)">ç©º ${(ws.short||0).toFixed(1)}</span>
            <span style="color:var(--text-muted);margin:0 6px">|</span>
            <span style="color:${(ws.net||0) > 0 ? 'var(--accent-green)' : (ws.net||0) < 0 ? 'var(--accent-red)' : 'var(--text-muted)'}">
                å‡€ ${(ws.net||0) > 0 ? '+' : ''}${(ws.net||0).toFixed(1)}
            </span>
        </div>
    </div>`;

    // 4b. å¤§å‘¨æœŸå®šè°ƒ
    const lgDir = largeSig.direction || 'neutral';
    const lgIcon = lgDir === 'long' ? 'ğŸŸ¢' : lgDir === 'short' ? 'ğŸ”´' : lgDir === 'conflict' ? 'âš ï¸' : 'âšª';
    const lgLabel = lgDir === 'long' ? 'çœ‹å¤š' : lgDir === 'short' ? 'çœ‹ç©º' : lgDir === 'conflict' ? 'å†²çª' : 'ä¸­æ€§';
    html += `<div class="detail-card">
        <div class="detail-title">å¤§å‘¨æœŸ (â‰¥4h) å®šè°ƒ</div>
        <div class="detail-value">${lgIcon} ${lgLabel}
            ${(largeSig.tfs||[]).length ? `<span style="font-size:11px;color:var(--text-muted);margin-left:6px">(${(largeSig.tfs||[]).join(', ')})</span>` : ''}
        </div>
    </div>`;

    // 4c. å¤šç©ºåˆ†å¸ƒ
    const longTFs = c.long_tfs || c.long || [];
    const shortTFs = c.short_tfs || c.short || [];
    const holdTFs = c.hold_tfs || c.hold || [];
    html += `<div class="detail-card">
        <div class="detail-title">å¤šç©ºåˆ†å¸ƒ</div>
        <div class="detail-value" style="font-size:12px;line-height:1.6">
            ${longTFs.length ? `<div>ğŸŸ¢ åšå¤š: <span style="color:var(--accent-green)">${longTFs.join(', ')}</span> (${longTFs.length})</div>` : ''}
            ${shortTFs.length ? `<div>ğŸ”´ åšç©º: <span style="color:var(--accent-red)">${shortTFs.join(', ')}</span> (${shortTFs.length})</div>` : ''}
            ${holdTFs.length ? `<div>âšª è§‚æœ›: <span style="color:var(--text-muted)">${holdTFs.join(', ')}</span> (${holdTFs.length})</div>` : ''}
        </div>
    </div>`;

    // 4d. å…±æŒ¯é“¾
    html += `<div class="detail-card">
        <div class="detail-title">å…±æŒ¯é“¾æ£€æµ‹</div>
        <div class="detail-value">`;
    if (chains.length === 0) {
        html += `<span style="color:var(--text-muted);font-size:12px">æœªæ£€æµ‹åˆ°è¿ç»­å…±æŒ¯</span>`;
    } else {
        for (const ch of chains.slice(0, 3)) {
            const chIcon = ch.direction === 'long' ? 'ğŸŸ¢' : 'ğŸ”´';
            html += `<div class="resonance-chain">${chIcon} `;
            ch.chain.forEach((tf, i) => {
                if (i > 0) html += `<span class="chain-arrow">â†’</span>`;
                html += `<span class="chain-tf ${ch.direction}">${tf}</span>`;
            });
            html += ` <span style="font-size:10px;color:var(--text-muted);margin-left:4px">(${ch.length}çº§${ch.has_4h_plus ? ', å«å¤§å‘¨æœŸ' : ''})</span>`;
            html += `</div>`;
        }
    }
    html += `</div></div>`;

    html += `</div>`;  // close detail-grid

    // 5. åº•éƒ¨ meta
    html += `<div style="font-size:11px;font-weight:400;color:var(--text-muted);margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
        <span>æ€»è€—æ—¶ ${data.total_elapsed}s Â· å…± ${totalN} ä¸ªå‘¨æœŸ</span>
        <span>${dec.actionable ? 'âœ… å¯æ“ä½œ' : 'â¸ï¸ æš‚ä¸æ“ä½œ'}</span>
    </div>`;

    consensusEl.className = `consensus-box ${consensusClass}`;
    consensusEl.innerHTML = html;
}

/* ä¿ç•™å•TFæµ‹è¯•ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼‰ */
async function testSignal() {
    testSignalMulti();
}

async function testConnection() {
    setLoading('connBtnText', true);
    try {
        const data = await apiCall('/api/live/test_connection', { method: 'POST' });
        showOutput('connOutput', data.output || data.error || 'æ— è¾“å‡º');
    } catch(e) {
        showOutput('connOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('connBtnText', false);
}

async function startEngine() {
    const phase = document.getElementById('enginePhase').value;
    if (phase === 'small_live' || phase === 'scale_up') {
        if (!confirm(`âš ï¸ å³å°†å¯åŠ¨ ${phase} æ¨¡å¼ï¼Œæ¶‰åŠçœŸå®èµ„é‡‘ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ`)) return;
    }
    setLoading('startBtnText', true);
    try {
        const data = await apiCall('/api/live/start', {
            method: 'POST', body: JSON.stringify({ phase })
        });
        showOutput('engineOutput', data.success
            ? 'âœ… ' + data.message
            : 'âŒ ' + data.message);
        refreshStatus();
    } catch(e) {
        showOutput('engineOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('startBtnText', false);
}

async function stopEngine() {
    if (!confirm('ç¡®è®¤åœæ­¢äº¤æ˜“å¼•æ“ï¼Ÿ')) return;
    try {
        const data = await apiCall('/api/live/stop', { method: 'POST' });
        showOutput('engineOutput', data.success
            ? 'âœ… ' + data.message
            : 'âŒ ' + data.message);
        refreshStatus();
    } catch(e) {
        showOutput('engineOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
}

async function generateConfig() {
    setLoading('genBtnText', true);
    try {
        const data = await apiCall('/api/live/generate_config', { method: 'POST' });
        if (data.success && data.config) {
            showOutput('genOutput', 'âœ… ' + data.message);
            document.getElementById('configEditor').value = JSON.stringify(data.config, null, 2);
        } else {
            showOutput('genOutput', 'âŒ ' + (data.message || 'ç”Ÿæˆå¤±è´¥'));
        }
    } catch(e) {
        showOutput('genOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('genBtnText', false);
}

async function killSwitch() {
    if (!confirm('âš ï¸ ç¡®è®¤æ‰§è¡Œç´§æ€¥å¹³ä»“ï¼Ÿæ­¤æ“ä½œå°†å…³é—­æ‰€æœ‰æŒä»“ï¼')) return;
    if (!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“ï¼Ÿ')) return;
    document.getElementById('killBtn').disabled = true;
    try {
        const data = await apiCall('/api/live/kill_switch', { method: 'POST' });
        showOutput('killOutput', data.output || data.error || data.message);
    } catch(e) {
        showOutput('killOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    document.getElementById('killBtn').disabled = false;
}

async function resetStats() {
    const capitalInput = document.getElementById('resetCapital');
    const newCapital = parseFloat(capitalInput.value) || 0;
    const msg = newCapital > 0
        ? `ç¡®è®¤é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®å¹¶è®¾ç½®åˆå§‹èµ„é‡‘ä¸º $${newCapital.toLocaleString()}ï¼Ÿ`
        : 'ç¡®è®¤é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼Ÿ(å³°å€¼æƒç›Šã€ç´¯è®¡ç›ˆäºã€äº¤æ˜“è®°å½•ç­‰å°†è¢«æ¸…é›¶)';
    if (!confirm(msg)) return;
    try {
        const body = newCapital > 0 ? { new_capital: newCapital } : {};
        const data = await apiCall('/api/live/reset-stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        showOutput('resetOutput', data.success ? 'âœ… ' + data.message : 'âŒ ' + (data.message || 'é‡ç½®å¤±è´¥'));
        if (data.success) {
            capitalInput.value = '';
            setTimeout(() => refreshStatus(), 1000);
        }
    } catch(e) {
        showOutput('resetOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
}

// ============================================================
// é…ç½®æ“ä½œ
// ============================================================
async function loadConfig() {
    try {
        const data = await apiCall('/api/live/load_config');
        if (data.success) {
            document.getElementById('configEditor').value = JSON.stringify(data.config, null, 2);
            document.getElementById('configResult').innerHTML =
                '<span class="result-badge success">âœ“ é…ç½®å·²åŠ è½½</span>';
        } else {
            document.getElementById('configResult').innerHTML =
                '<span class="result-badge error">' + data.message + '</span>';
        }
    } catch(e) {
        document.getElementById('configResult').innerHTML =
            '<span class="result-badge error">åŠ è½½å¤±è´¥: ' + e.message + '</span>';
    }
}

async function saveConfig() {
    const text = document.getElementById('configEditor').value;
    try {
        const config = JSON.parse(text);
        const data = await apiCall('/api/live/save_config', {
            method: 'POST', body: JSON.stringify(config)
        });
        document.getElementById('configResult').innerHTML = data.success
            ? '<span class="result-badge success">âœ“ é…ç½®å·²ä¿å­˜</span>'
            : '<span class="result-badge error">' + data.message + '</span>';
    } catch(e) {
        document.getElementById('configResult').innerHTML =
            '<span class="result-badge error">JSON æ ¼å¼é”™è¯¯: ' + e.message + '</span>';
    }
}

// ============================================================
// çŠ¶æ€ç›‘æ§
// ============================================================
function formatUsd(value) {
    if (value == null || Number.isNaN(Number(value))) return '--';
    return '$' + Number(value).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });
}

function formatSignedUsd(value) {
    if (value == null || Number.isNaN(Number(value))) return '--';
    const n = Number(value);
    return (n >= 0 ? '+' : '-') + '$' + Math.abs(n).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });
}

function formatPct(value, digits = 1) {
    if (value == null || Number.isNaN(Number(value))) return '--';
    return Number(value).toFixed(digits) + '%';
}

function escapeHtml(text) {
    return String(text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function setMetricValue(id, text, cls = '') {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = text;
    el.className = 'value' + (cls ? ' ' + cls : '');
}

function toNumber(value, fallback = 0) {
    const n = Number(value);
    return Number.isFinite(n) ? n : fallback;
}

let _latestStatusPayload = null;
let _latestHistoryPayload = null;
let _monitorRules = {
    pf_alert_threshold: 1.0,
    pf_min_realized_count: 8,
    current_loss_streak_alert_days: 3,
    worst_day_net_alert_usdt: -2000,
};

function getMonitorRulesFromInputs() {
    return {
        pf_alert_threshold: toNumber(document.getElementById('rule_pf_threshold')?.value, 1.0),
        pf_min_realized_count: toNumber(document.getElementById('rule_pf_min_count')?.value, 8),
        current_loss_streak_alert_days: toNumber(document.getElementById('rule_loss_streak_days')?.value, 3),
        worst_day_net_alert_usdt: toNumber(document.getElementById('rule_worst_day_alert')?.value, -2000),
    };
}

function applyMonitorRulesToInputs(rules) {
    if (!rules) return;
    const pf = toNumber(rules.pf_alert_threshold, 1.0);
    const minCnt = toNumber(rules.pf_min_realized_count, 8);
    const lossDays = toNumber(rules.current_loss_streak_alert_days, 3);
    const worstDay = toNumber(rules.worst_day_net_alert_usdt, -2000);
    const pfEl = document.getElementById('rule_pf_threshold');
    const cntEl = document.getElementById('rule_pf_min_count');
    const lossEl = document.getElementById('rule_loss_streak_days');
    const worstEl = document.getElementById('rule_worst_day_alert');
    if (pfEl) pfEl.value = pf.toFixed(2);
    if (cntEl) cntEl.value = String(Math.round(minCnt));
    if (lossEl) lossEl.value = String(Math.round(lossDays));
    if (worstEl) worstEl.value = String(Math.round(worstDay));
}

function renderMonitorRulesNote(text, warn = false) {
    const noteEl = document.getElementById('monitorRulesNote');
    if (!noteEl) return;
    noteEl.textContent = text;
    noteEl.style.color = warn ? 'var(--accent-yellow)' : 'var(--text-muted)';
}

async function loadMonitorRules() {
    try {
        const data = await apiCall('/api/live/monitor_rules');
        if (data.success && data.rules) {
            _monitorRules = data.rules;
            applyMonitorRulesToInputs(_monitorRules);
            renderMonitorRulesNote('é˜ˆå€¼çŠ¶æ€: å·²ä»æœåŠ¡ç«¯åŠ è½½');
            if (_latestHistoryPayload?.trade_stats) {
                renderOpsHint(_latestHistoryPayload.trade_stats);
                generateDailyReport();
            }
        }
    } catch (e) {
        renderMonitorRulesNote('é˜ˆå€¼çŠ¶æ€: åŠ è½½å¤±è´¥', true);
    }
}

async function saveMonitorRules() {
    const rules = getMonitorRulesFromInputs();
    try {
        const data = await apiCall('/api/live/monitor_rules', {
            method: 'POST',
            body: JSON.stringify({ rules })
        });
        if (data.success && data.rules) {
            _monitorRules = data.rules;
            applyMonitorRulesToInputs(_monitorRules);
            renderMonitorRulesNote('é˜ˆå€¼çŠ¶æ€: å·²ä¿å­˜å¹¶ç”Ÿæ•ˆ');
            if (_latestHistoryPayload?.trade_stats) {
                renderOpsHint(_latestHistoryPayload.trade_stats);
                generateDailyReport();
            }
        } else {
            renderMonitorRulesNote('é˜ˆå€¼çŠ¶æ€: ä¿å­˜å¤±è´¥', true);
        }
    } catch (e) {
        renderMonitorRulesNote('é˜ˆå€¼çŠ¶æ€: ä¿å­˜å¤±è´¥', true);
    }
}

function renderOpsHint(stats) {
    const hintEl = document.getElementById('opsActionHint');
    if (!hintEl) return;
    const rules = _monitorRules || {};
    const pfThreshold = toNumber(rules.pf_alert_threshold, 1.0);
    const pfMinCount = toNumber(rules.pf_min_realized_count, 8);
    const streakAlertDays = toNumber(rules.current_loss_streak_alert_days, 3);
    const worstDayAlert = toNumber(rules.worst_day_net_alert_usdt, -2000);
    const realizedPf = toNumber(stats.realized_pf, 0);
    const currentLossStreak = toNumber(stats.current_consecutive_loss_days, 0);
    const worstDay = toNumber(stats.worst_day_net_pnl, 0);

    let msg = 'ç›‘æ§å»ºè®®: ç»§ç»­è§‚å¯Ÿï¼Œä¿æŒ v7.0 å‚æ•°ã€‚';
    let warn = false;
    if (realizedPf > 0 && realizedPf < pfThreshold && toNumber(stats.total_realized_count, 0) >= pfMinCount) {
        msg = `ç›‘æ§å»ºè®®: è¿‘çª— PF<${pfThreshold.toFixed(2)}ï¼ˆæ ·æœ¬â‰¥${Math.round(pfMinCount)}ï¼‰ï¼Œå»ºè®®è¯„ä¼°åˆ‡å› B1bï¼ˆneutral:999ï¼‰æˆ–é™ä»“ã€‚`;
        warn = true;
    }
    if (currentLossStreak >= streakAlertDays) {
        msg = `ç›‘æ§å»ºè®®: å·²è¿ç»­${Math.round(streakAlertDays)}å¤©äºæŸï¼Œä¼˜å…ˆè§¦å‘å›é€€é¢„æ¡ˆï¼ˆB1bï¼‰å¹¶å¤ç›˜ neutral shortã€‚`;
        warn = true;
    } else if (worstDay <= worstDayAlert) {
        msg = `ç›‘æ§å»ºè®®: å•æ—¥å‡€PnLä½äº ${formatUsd(worstDayAlert)}ï¼Œå»ºè®®ç¼©å°ä»“ä½å¹¶æ£€æŸ¥å¼€ä»“è¿‡æ»¤å‘½ä¸­ã€‚`;
        warn = true;
    }
    hintEl.textContent = msg;
    hintEl.className = 'ops-hint' + (warn ? ' warn' : '');
}

function buildDailyReportText(statusData, historyData) {
    const proc = statusData?.process || {};
    const eng = statusData?.engine || {};
    const risk = statusData?.risk || {};
    const perf = statusData?.performance_summary || statusData?.performance || {};
    const stats = historyData?.trade_stats || {};
    const rules = _monitorRules || {};
    const dailyRows = historyData?.daily_records || [];
    const today = dailyRows.length ? dailyRows[0] : {};

    const now = new Date();
    const todayStr = now.toLocaleDateString('zh-CN');
    const nowStr = now.toLocaleString('zh-CN', { hour12: false });
    const phase = eng.phase || proc.phase || '--';
    const engineState = proc.running ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ';
    const equity = eng.equity ?? perf.current_equity;
    const totalPnl = risk.total_pnl ?? perf.total_pnl;
    const ddPct = risk.max_drawdown != null ? toNumber(risk.max_drawdown) * 100 : toNumber(perf.max_drawdown_pct, 0);
    const pfThreshold = toNumber(rules.pf_alert_threshold, 1.0);
    const pfMinCount = toNumber(rules.pf_min_realized_count, 8);
    const fallbackSuggestion = toNumber(stats.realized_pf, 0) < pfThreshold && toNumber(stats.total_realized_count, 0) >= pfMinCount
        ? 'å»ºè®®è§¦å‘ B1b å›é€€ï¼ˆneutral:999ï¼‰'
        : 'ç»§ç»­ v7.0 è§‚å¯Ÿ';

    return [
        `# v7.0 å®ç›˜æ—¥æŠ¥ï¼ˆ${todayStr}ï¼‰`,
        '',
        '## 1) è¿è¡ŒçŠ¶æ€',
        `- æ—¶é—´: ${nowStr}`,
        `- å¼•æ“: ${engineState}`,
        `- é˜¶æ®µ: ${phase}`,
        `- å½“å‰æƒç›Š: ${formatUsd(equity)}`,
        `- æœªå®ç°PnL: ${formatSignedUsd(eng.unrealized_pnl)}`,
        '',
        '## 2) è¿‘çª—äº¤æ˜“è¡¨ç°',
        `- è§‚å¯Ÿçª—å£: æœ€è¿‘ ${toNumber(stats.days, 0)} å¤©`,
        `- æ€»äº¤æ˜“/å·²å®ç°: ${toNumber(stats.total_trade_count, 0)} / ${toNumber(stats.total_realized_count, 0)}`,
        `- èƒœç‡: ${formatPct(stats.win_rate_pct, 1)}`,
        `- å·²å®ç°PnL: ${formatSignedUsd(stats.realized_pnl)}`,
        `- å‡€PnL(ä¼°ç®—): ${formatSignedUsd(stats.net_pnl)}`,
        `- å·²å®ç°PF: ${stats.realized_pf != null ? toNumber(stats.realized_pf).toFixed(2) : '--'}`,
        `- è´¹ç”¨æ‹–ç´¯: ${formatPct(stats.fee_drag_pct, 1)}`,
        `- å›é€€é˜ˆå€¼: PF<${pfThreshold.toFixed(2)} ä¸”æ ·æœ¬â‰¥${Math.round(pfMinCount)}`,
        '',
        '## 3) å½“æ—¥å¿«ç…§',
        `- å½“æ—¥äº¤æ˜“/å·²å®ç°: ${toNumber(today.trade_count, 0)} / ${toNumber(today.realized_count, 0)}`,
        `- å½“æ—¥å·²å®ç°PnL: ${formatSignedUsd(today.realized_pnl)}`,
        `- å½“æ—¥å‡€PnL(ä¼°ç®—): ${formatSignedUsd(today.net_pnl)}`,
        `- å½“æ—¥èƒœç‡: ${formatPct(today.win_rate_pct, 0)}`,
        '',
        '## 4) é£é™©ä¸å›é€€',
        `- è¿äºå¤©æ•°(å½“å‰/æœ€å¤§): ${toNumber(stats.current_consecutive_loss_days, 0)} / ${toNumber(stats.max_consecutive_loss_days, 0)}`,
        `- æœ€å¤§å›æ’¤: ${ddPct.toFixed(2)}%`,
        `- æœ€å·®å•æ—¥å‡€PnL: ${formatSignedUsd(stats.worst_day_net_pnl)}`,
        `- å›é€€å»ºè®®: ${fallbackSuggestion}`,
        '',
        `## 5) ç´¯è®¡`,
        `- ç´¯è®¡å·²å®ç°PnL: ${formatSignedUsd(totalPnl)}`,
        `- ç´¯è®¡æ‰‹ç»­è´¹: ${formatUsd(stats.fees)}`,
    ].join('\n');
}

function generateDailyReport() {
    const text = buildDailyReportText(_latestStatusPayload || {}, _latestHistoryPayload || {});
    const ta = document.getElementById('dailyReportTemplate');
    if (ta) ta.value = text;
}

async function copyDailyReport() {
    const ta = document.getElementById('dailyReportTemplate');
    if (!ta || !ta.value) {
        return;
    }
    try {
        await navigator.clipboard.writeText(ta.value);
    } catch (e) {
        ta.select();
        document.execCommand('copy');
    }
}

function renderLiveHistory(data) {
    const stats = data.trade_stats || {};
    const latestBalance = data.latest_balance || null;
    const dailyRows = data.daily_records || [];
    const tradeRows = data.trade_records || [];

    setMetricValue('h_total_trades', String(stats.total_trade_count ?? 0));
    setMetricValue('h_realized', String(stats.total_realized_count ?? 0));
    setMetricValue('h_win_rate', formatPct(stats.win_rate_pct, 1),
        Number(stats.win_rate_pct || 0) >= 50 ? 'green' : 'red');
    setMetricValue('h_realized_pnl', formatSignedUsd(stats.realized_pnl),
        Number(stats.realized_pnl || 0) >= 0 ? 'green' : 'red');
    setMetricValue('h_fees', formatUsd(stats.fees));
    setMetricValue('h_net_pnl', formatSignedUsd(stats.net_pnl),
        Number(stats.net_pnl || 0) >= 0 ? 'green' : 'red');
    setMetricValue('h_realized_pf', stats.realized_pf != null ? toNumber(stats.realized_pf).toFixed(2) : '--',
        toNumber(stats.realized_pf, 0) >= 1 ? 'green' : 'red');
    setMetricValue('h_fee_drag', formatPct(stats.fee_drag_pct, 1),
        toNumber(stats.fee_drag_pct, 0) <= 35 ? 'green' : 'red');
    setMetricValue('h_best_day', formatSignedUsd(stats.best_day_net_pnl),
        toNumber(stats.best_day_net_pnl, 0) >= 0 ? 'green' : '');
    setMetricValue('h_worst_day', formatSignedUsd(stats.worst_day_net_pnl),
        toNumber(stats.worst_day_net_pnl, 0) < 0 ? 'red' : 'green');
    setMetricValue('h_max_loss_streak_days', String(toNumber(stats.max_consecutive_loss_days, 0)),
        toNumber(stats.max_consecutive_loss_days, 0) >= 3 ? 'red' : '');
    setMetricValue('h_current_loss_streak_days', String(toNumber(stats.current_consecutive_loss_days, 0)),
        toNumber(stats.current_consecutive_loss_days, 0) >= 2 ? 'red' : '');
    renderOpsHint(stats);

    const noteEl = document.getElementById('historyBalanceNote');
    if (noteEl) {
        if (latestBalance) {
            noteEl.textContent = `æœ€æ–°ä½™é¢å¿«ç…§: ${latestBalance.timestamp || '--'} Â· ` +
                `æƒç›Š ${formatUsd(latestBalance.total_equity)} Â· ` +
                `USDT ${formatUsd(latestBalance.usdt)} Â· ` +
                `æœªå®ç° ${formatSignedUsd(latestBalance.unrealized_pnl)}`;
        } else {
            noteEl.textContent = 'æœ€æ–°ä½™é¢å¿«ç…§: --';
        }
    }

    const dailyBody = document.getElementById('dailyPnlBody');
    if (dailyBody) {
        if (!dailyRows.length) {
            dailyBody.innerHTML = '<tr><td colspan="8" style="color:var(--text-muted);">æš‚æ— é€æ—¥æ•°æ®</td></tr>';
        } else {
            dailyBody.innerHTML = dailyRows.slice(0, 60).map(r => {
                const realized = Number(r.realized_pnl || 0);
                const net = Number(r.net_pnl || 0);
                const wr = Number(r.win_rate_pct || 0);
                return `<tr>
                    <td>${escapeHtml(r.date)}</td>
                    <td>${Number(r.trade_count || 0)} / ${Number(r.realized_count || 0)}</td>
                    <td style="color:${realized >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatSignedUsd(realized)}</td>
                    <td>${formatUsd(r.fees)}</td>
                    <td style="color:${Number(r.funding || 0) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatSignedUsd(r.funding || 0)}</td>
                    <td style="color:${net >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatSignedUsd(net)}</td>
                    <td style="color:${wr >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatPct(wr, 0)}</td>
                    <td>${r.close_equity != null ? formatUsd(r.close_equity) : '--'}</td>
                </tr>`;
            }).join('');
        }
    }

    const tradeBody = document.getElementById('tradeHistoryBody');
    if (tradeBody) {
        if (!tradeRows.length) {
            tradeBody.innerHTML = '<tr><td colspan="7" style="color:var(--text-muted);">æš‚æ— å†å²äº¤æ˜“è®°å½•</td></tr>';
        } else {
            tradeBody.innerHTML = tradeRows.slice(0, 160).map(t => {
                const pnl = Number(t.pnl || 0);
                const side = escapeHtml(t.side || '--');
                const action = escapeHtml(t.action || '--');
                const reason = escapeHtml(t.reason || '');
                const qty = Number(t.qty || 0).toFixed(4);
                const price = formatUsd(t.price);
                return `<tr>
                    <td>${escapeHtml(t.timestamp || '--')}</td>
                    <td>${action}</td>
                    <td style="color:${side.includes('LONG') ? 'var(--accent-green)' : side.includes('SHORT') ? 'var(--accent-red)' : 'var(--text-secondary)'}">${side}</td>
                    <td>${qty} @ ${price}</td>
                    <td style="color:${pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatSignedUsd(pnl)}</td>
                    <td>${formatUsd(t.fee)}</td>
                    <td title="${reason}">${reason || '--'}</td>
                </tr>`;
            }).join('');
        }
    }
}

async function refreshMLDiagnostic() {
    const days = document.getElementById('mlDiagDays')?.value || 7;
    document.getElementById('mlDiagNote').textContent = 'åŠ è½½ä¸­...';
    try {
        const data = await apiCall(`/api/ml/shadow/diagnostic?days=${days}`);
        if (!data.success) {
            document.getElementById('mlDiagNote').textContent = 'é”™è¯¯: ' + (data.message || 'æœªçŸ¥');
            return;
        }
        document.getElementById('ml_log_files').textContent = data.log_files;
        document.getElementById('ml_total_signals').textContent = data.total_signals;

        const covEl = document.getElementById('ml_coverage');
        covEl.textContent = data.coverage_pct + '%';
        covEl.className = 'value ' + (data.coverage_pct > 80 ? 'green' : data.coverage_pct > 0 ? 'yellow' : '');

        const errEl = document.getElementById('ml_errors');
        errEl.textContent = data.with_error;
        errEl.className = 'value ' + (data.with_error > 0 ? 'red' : 'green');

        document.getElementById('ml_bull_mean').textContent =
            data.bull_prob_mean != null ? data.bull_prob_mean.toFixed(3) : '--';
        document.getElementById('ml_bull_median').textContent =
            data.bull_prob_median != null ? data.bull_prob_median.toFixed(3) : '--';

        const dc = data.direction_counts || {};
        document.getElementById('ml_dir_long').textContent = dc.long || 0;
        document.getElementById('ml_dir_short').textContent = dc.short || 0;
        document.getElementById('ml_dir_neutral').textContent = dc.neutral || 0;

        const rc = data.regime_counts || {};
        const regimeStr = Object.entries(rc)
            .sort((a, b) => b[1] - a[1])
            .map(([k, v]) => `${k}:${v}`)
            .join(', ') || '--';
        document.getElementById('ml_regime_dist').textContent = regimeStr;
        document.getElementById('ml_remote_count').textContent = data.remote_inference_count || 0;

        const sdSummary = data.stacking_disabled_summary || [];
        const ssSummary = data.stacking_skipped_summary || [];
        const caSummary = data.ca_skipped_summary || [];
        const sumCount = arr => arr.reduce((acc, x) => acc + Number(x.count || 0), 0);
        const sdCount = sumCount(sdSummary);
        const ssCount = sumCount(ssSummary);
        const caCount = sumCount(caSummary);
        document.getElementById('ml_skip_counts').textContent = `${sdCount}/${ssCount}/${caCount}`;

        const errList = document.getElementById('mlErrorList');
        if (data.error_summary && data.error_summary.length > 0) {
            errList.style.display = 'block';
            document.getElementById('mlErrorItems').innerHTML = data.error_summary
                .map(e => `<div style="font-size:12px;color:#ccc;padding:2px 0;">[${e.count}x] ${e.error}</div>`)
                .join('');
        } else {
            errList.style.display = 'none';
        }

        const stackingList = document.getElementById('mlStackingList');
        const stackingItems = document.getElementById('mlStackingItems');
        const renderReasonGroup = (title, arr, color) => {
            if (!arr || arr.length === 0) return '';
            const items = arr
                .map(e => `<div style="font-size:12px;color:#ccc;padding:1px 0;">[${e.count}x] ${escapeHtml(e.reason || '--')}</div>`)
                .join('');
            return `<div style="margin-bottom:6px;"><div style="font-size:12px;color:${color};">${title}</div>${items}</div>`;
        };
        const stackingHtml =
            renderReasonGroup('Stacking ç¦ç”¨', sdSummary, '#e0b070') +
            renderReasonGroup('Stacking è·³è¿‡', ssSummary, '#d0a0d0') +
            renderReasonGroup('è·¨èµ„äº§è·³è¿‡', caSummary, '#a0c0e0');
        if (stackingHtml) {
            stackingList.style.display = 'block';
            stackingItems.innerHTML = stackingHtml;
        } else {
            stackingList.style.display = 'none';
        }

        const tbody = document.getElementById('mlSignalTableBody');
        if (data.recent_signals && data.recent_signals.length > 0) {
            document.getElementById('mlSignalTableWrap').style.display = 'block';
            tbody.innerHTML = data.recent_signals.map(s => {
                const prob = s.bull_prob !== '' ? Number(s.bull_prob).toFixed(3) : '--';
                const kelly = s.kelly !== '' ? Number(s.kelly).toFixed(2) : '--';
                const statusRaw = s.error || s.stacking_disabled || s.stacking_skipped || s.ca_skipped || '';
                const status = statusRaw
                    ? `<span style="color:#e07070">${escapeHtml(String(statusRaw).slice(0, 60))}</span>`
                    : `<span style="color:#6c6">${s.remote ? 'OK(remote)' : 'OK'}</span>`;
                return `<tr><td>${s.ts||'--'}</td><td>${s.tf||'--'}</td><td>${prob}</td><td>${s.direction||'--'}</td><td>${s.regime||'--'}</td><td>${kelly}</td><td>${status}</td></tr>`;
            }).join('');
        } else {
            document.getElementById('mlSignalTableWrap').style.display = 'none';
        }

        let note;
        if (data.coverage_pct === 0 && data.with_error === 0) {
            note = 'âš  ML æœªè¿è¡Œ â€” ç¡®è®¤æ¨¡å‹å·²éƒ¨ç½²ä¸” use_ml_enhancement=True';
        } else if ((sdCount + ssCount + caCount) > 0) {
            note = `! å‘ç°é—¨æ§è§¦å‘ (ç¦ç”¨:${sdCount} è·³è¿‡:${ssCount} CAè·³è¿‡:${caCount})ï¼Œè¯·æŒ‰æ‘˜è¦æ’æŸ¥ç‰¹å¾è¦†ç›–/æ¨¡å‹è´¨é‡`;
        } else if (data.coverage_pct < 50) {
            note = `! ML è¦†ç›–ç‡åä½ (${data.coverage_pct}%)ï¼Œéƒ¨åˆ†ä¿¡å·æ—  ML å¢å¼º`;
        } else {
            note = `âœ“ ML Shadow è¿è¡Œæ­£å¸¸ï¼ˆè¦†ç›–ç‡ ${data.coverage_pct}%ï¼‰`;
        }
        document.getElementById('mlDiagNote').textContent = note;
    } catch (e) {
        document.getElementById('mlDiagNote').textContent = 'è¯·æ±‚å¤±è´¥: ' + e.message;
    }
}

async function refreshLiveHistoryData() {
    const daysEl = document.getElementById('historyDays');
    const days = Number(daysEl?.value || 30);
    try {
        const data = await apiCall(`/api/live/history?days=${days}&limit=180`);
        if (data.success) {
            _latestHistoryPayload = data;
            if (data.monitor_rules) {
                _monitorRules = data.monitor_rules;
                applyMonitorRulesToInputs(_monitorRules);
                renderMonitorRulesNote('é˜ˆå€¼çŠ¶æ€: å·²åŒæ­¥æœåŠ¡ç«¯è§„åˆ™');
            }
            renderLiveHistory(data);
            generateDailyReport();
        }
    } catch (e) {
        console.error('History refresh failed:', e);
    }
}

async function refreshStatus() {
    try {
        const data = await apiCall('/api/live/status');
        _latestStatusPayload = data;

        // è¿›ç¨‹çŠ¶æ€
        const proc = data.process || {};
        const running = proc.running;
        document.getElementById('s_proc').textContent = running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
        document.getElementById('s_proc').className = 'value ' + (running ? 'green' : '');

        // å¼•æ“çŠ¶æ€ (ä¼˜å…ˆä» engine_state.jsonï¼Œfallback åˆ°æ—¥å¿—æ•°æ®)
        const eng = data.engine || {};
        const phase = eng.phase || proc.phase || '--';
        document.getElementById('s_phase').textContent = phase;

        document.getElementById('engineDot').className = 'status-dot ' + (running ? 'green' : 'gray');
        document.getElementById('engineStatus').textContent = running
            ? 'å¼•æ“: è¿è¡Œä¸­ (' + phase + ')'
            : 'å¼•æ“: æœªè¿è¡Œ';

        // ä½™é¢ & æƒç›Š
        const equity = eng.equity;
        const usdt = eng.usdt;
        document.getElementById('s_usdt').textContent = usdt != null ? '$' + Number(usdt).toFixed(2) : '--';
        document.getElementById('s_frozen').textContent = eng.frozen_margin != null ? '$' + Number(eng.frozen_margin).toFixed(2) : '--';
        document.getElementById('s_bars').textContent = eng.total_bars || '--';

        // æŒä»“ä¿¡æ¯ - å…¼å®¹ dict (engine_state.json) å’Œ array (æ—¥å¿—) æ ¼å¼
        let posDisplay = 'æ— ';
        let posDetail = '';
        const positions = eng.positions;
        if (positions) {
            if (Array.isArray(positions)) {
                posDisplay = positions.length > 0
                    ? positions.map(p => p.side + ' $' + Number(p.entry_price).toFixed(2)).join(', ')
                    : 'æ— ';
            } else {
                const posList = Object.entries(positions);
                if (posList.length > 0) {
                    posDisplay = posList.map(([k]) => k.toUpperCase()).join(', ');
                    posDetail = posList.map(([k, p]) => {
                        const side = (p.side || k).toUpperCase();
                        const icon = side.includes('LONG') ? 'ğŸŸ¢' : 'ğŸ”´';
                        const entry = Number(p.entry_price || 0).toFixed(2);
                        const qty = Number(p.quantity || 0).toFixed(4);
                        const margin = Number(p.margin || 0).toFixed(2);
                        const lev = p.leverage || '-';
                        const bars = p.bars_held || 0;
                        const maxPnl = p.max_pnl_ratio != null ? (Number(p.max_pnl_ratio) * 100).toFixed(2) + '%' : '--';
                        const tp1 = p.partial_tp_1_done
                            ? '<span style="color:#22c55e;">âœ“å·²è§¦å‘</span>'
                            : '<span style="color:#64748b;">æœªè§¦å‘</span>';
                        const tp2 = p.partial_tp_2_done
                            ? '<span style="color:#22c55e;">âœ“å·²è§¦å‘</span>'
                            : '<span style="color:#64748b;">æœªè§¦å‘</span>';
                        const entryTime = p.entry_time || '--';

                        // === å…¥åœºå†³ç­–è¯¦æƒ… ===
                        let decisionHtml = '';
                        const reason = p.entry_reason || '';
                        const sig = p.entry_signal || {};
                        const cons = p.entry_consensus || {};

                        if (reason || Object.keys(sig).length > 0 || Object.keys(cons).length > 0) {
                            // å¼€ä»“åŸå› 
                            let reasonLine = '';
                            if (reason) {
                                reasonLine = `<div style="margin-bottom:6px;"><span style="color:var(--accent);">ğŸ“‹ å¼€ä»“åŸå› :</span> ${reason}</div>`;
                            }

                            // å…­ä¹¦ä¿¡å·è¯„åˆ†
                            let signalHtml = '';
                            if (Object.keys(sig).length > 0) {
                                const bs = Number(sig.buy_score || 0).toFixed(1);
                                const ss = Number(sig.sell_score || 0).toFixed(1);
                                const comp = sig.components || {};
                                const bookNames = {
                                    'div': 'èƒŒç¦»', 'ma': 'å‡çº¿', 'cs': 'Kçº¿å½¢æ€',
                                    'bb': 'å¸ƒæ—å¸¦', 'vp': 'é‡ä»·', 'kdj': 'KDJ'
                                };
                                const isBuy = side.includes('LONG');
                                let booksHtml = '';
                                for (const [key, label] of Object.entries(bookNames)) {
                                    const bVal = Number(comp[key + '_b'] || 0);
                                    const sVal = Number(comp[key + '_s'] || 0);
                                    const val = isBuy ? bVal : sVal;
                                    const barWidth = Math.min(val * 100 / 3, 100);
                                    const barColor = val > 1.5 ? '#22c55e' : val > 0.5 ? '#eab308' : '#64748b';
                                    booksHtml += `<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
                                        <span style="width:52px;text-align:right;color:var(--text-muted);font-size:11px;">${label}</span>
                                        <div style="flex:1;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;">
                                            <div style="width:${barWidth}%;height:100%;background:${barColor};border-radius:3px;"></div>
                                        </div>
                                        <span style="width:30px;font-size:11px;color:${barColor};">${val.toFixed(1)}</span>
                                    </div>`;
                                }
                                signalHtml = `<div style="margin-bottom:6px;">
                                    <div style="margin-bottom:4px;">
                                        <span style="color:var(--accent);">ğŸ“Š ä¿¡å·è¯„åˆ†:</span>
                                        <span style="color:#22c55e;font-weight:600;">ä¹°å…¥ ${bs}</span>
                                        <span style="margin:0 4px;color:var(--text-muted);">/</span>
                                        <span style="color:#ef4444;font-weight:600;">å–å‡º ${ss}</span>
                                        ${sig.conflict ? '<span style="margin-left:6px;color:#eab308;">âš ï¸å†²çª</span>' : ''}
                                    </div>
                                    <div style="padding:4px 0;">${booksHtml}</div>
                                </div>`;
                            }

                            // å¤šå‘¨æœŸå…±è¯†
                            let consensusHtml = '';
                            if (Object.keys(cons).length > 0) {
                                const dir = cons.direction || '--';
                                const str = cons.strength || 0;
                                const lbl = cons.label || '--';
                                const tfs = (cons.decision_tfs || []).join(', ');
                                const strColor = str >= 70 ? '#22c55e' : str >= 50 ? '#eab308' : '#ef4444';
                                // å„å‘¨æœŸè¯„åˆ†
                                let tfScoresHtml = '';
                                const tfScores = cons.tf_scores || {};
                                if (Object.keys(tfScores).length > 0) {
                                    tfScoresHtml = '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;">';
                                    for (const [tf, score] of Object.entries(tfScores)) {
                                        // å…¼å®¹ä¸¤ç§æ ¼å¼:
                                        // 1) æ—§æ ¼å¼: tf_scores[tf] = number
                                        // 2) æ–°æ ¼å¼: tf_scores[tf] = {ss, bs, dir}
                                        let text = '--';
                                        let c = '#64748b';
                                        if (score && typeof score === 'object') {
                                            const ssTf = Number(score.ss || 0);
                                            const bsTf = Number(score.bs || 0);
                                            const dirTf = score.dir || (bsTf > ssTf ? 'long' : ssTf > bsTf ? 'short' : 'hold');
                                            c = dirTf === 'long' ? '#22c55e' : dirTf === 'short' ? '#ef4444' : '#64748b';
                                            text = `bs ${bsTf.toFixed(1)} / ss ${ssTf.toFixed(1)}`;
                                        } else {
                                            const sc = Number(score || 0);
                                            c = sc > 0 ? '#22c55e' : sc < 0 ? '#ef4444' : '#64748b';
                                            text = `${sc > 0 ? '+' : ''}${sc.toFixed(1)}`;
                                        }
                                        tfScoresHtml += `<span style="display:inline-block;padding:2px 8px;border-radius:4px;background:rgba(255,255,255,0.05);font-size:11px;">
                                            <span style="color:var(--text-muted);">${tf}</span>
                                            <span style="color:${c};font-weight:600;margin-left:3px;">${text}</span>
                                        </span>`;
                                    }
                                    tfScoresHtml += '</div>';
                                }
                                consensusHtml = `<div>
                                    <span style="color:var(--accent);">ğŸ”— å¤šå‘¨æœŸå…±è¯†:</span>
                                    <span style="font-weight:600;color:${strColor};">${lbl}</span>
                                    <span style="color:var(--text-muted);margin-left:4px;">æ–¹å‘=${dir} å¼ºåº¦=${str}</span>
                                    ${tfs ? '<span style="color:var(--text-muted);margin-left:4px;">[' + tfs + ']</span>' : ''}
                                    ${tfScoresHtml}
                                </div>`;
                            }

                            decisionHtml = `<div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.06);">
                                <div style="font-weight:600;font-size:12px;margin-bottom:6px;color:var(--text-secondary);">ğŸ“Œ å…¥åœºå†³ç­–è¯¦æƒ…</div>
                                ${reasonLine}${signalHtml}${consensusHtml}
                            </div>`;
                        }

                        return `<div style="background:var(--bg-secondary);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:12px;line-height:1.8;">
                            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">${icon} ${side} Â· ${lev}xæ æ†</div>
                            <div>å…¥åœºä»·: <b>$${entry}</b> Â· æ•°é‡: <b>${qty}</b> ETH Â· ä¿è¯é‡‘: $${margin}</div>
                            <div>å…¥åœºæ—¶é—´: ${entryTime} Â· æŒä»“Kçº¿: ${bars}</div>
                            <div>æœ€é«˜ç›ˆåˆ©æ¯”: ${maxPnl}</div>
                            <div>åˆ†æ®µæ­¢ç›ˆ: TP1 ${tp1} Â· TP2 ${tp2}</div>
                            ${decisionHtml}
                        </div>`;
                    }).join('');
                } else {
                    posDisplay = 'æ— ';
                }
            }
        }
        document.getElementById('s_positions').innerHTML = posDisplay;
        document.getElementById('positionDisplay').textContent = 'æŒä»“: ' + posDisplay;

        // æŒä»“è¯¦æƒ…é¢æ¿
        let detailEl = document.getElementById('positionDetail');
        if (!detailEl) {
            detailEl = document.createElement('div');
            detailEl.id = 'positionDetail';
            document.getElementById('statusGrid').parentElement.appendChild(detailEl);
        }
        detailEl.innerHTML = posDetail;

        // æƒç›Šæ˜¾ç¤º (çŠ¶æ€æ )
        if (equity != null) {
            document.getElementById('equityDisplay').textContent = 'æƒç›Š: $' + Number(equity).toFixed(2);
        } else if (usdt != null) {
            document.getElementById('equityDisplay').textContent = 'ä½™é¢: $' + Number(usdt).toFixed(2);
        }

        // é£æ§
        const risk = data.risk || {};
        const paused = risk.is_paused;
        if (Object.keys(risk).length > 0) {
            document.getElementById('r_paused').textContent = paused ? 'æ˜¯' : 'å¦';
            document.getElementById('r_paused').className = 'value ' + (paused ? 'red' : 'green');
            document.getElementById('r_kill').textContent = risk.kill_switch_active ? 'æ¿€æ´»' : 'æ­£å¸¸';
            document.getElementById('r_kill').className = 'value ' + (risk.kill_switch_active ? 'red' : 'green');
            document.getElementById('r_daily').textContent = risk.daily_pnl != null ? '$' + Number(risk.daily_pnl).toFixed(2) : '$0.00';
            document.getElementById('r_daily').className = 'value ' + ((risk.daily_pnl||0) >= 0 ? 'green' : 'red');
            document.getElementById('r_consec').textContent = risk.consecutive_losses || '0';
            document.getElementById('r_dd').textContent = risk.max_drawdown != null ? (Number(risk.max_drawdown) * 100).toFixed(1) + '%' : '0.0%';
            document.getElementById('r_trades').textContent = risk.total_trades || '0';

            document.getElementById('riskDot').className = 'status-dot ' + (paused ? 'red' : risk.kill_switch_active ? 'red' : 'green');
            document.getElementById('riskStatus').textContent = paused ? 'é£æ§: å·²æš‚åœ' : 'é£æ§: æ­£å¸¸';
        } else if (running) {
            // å¼•æ“è¿è¡Œä½†é£æ§æ–‡ä»¶è¿˜æ²¡ç”Ÿæˆ
            document.getElementById('riskDot').className = 'status-dot green';
            document.getElementById('riskStatus').textContent = 'é£æ§: æ­£å¸¸';
        }

        // ç»©æ•ˆ (ä» risk state / performance / engine_state ç»¼åˆè¯»å–)
        const perf = data.performance || {};
        const perfSummary = data.performance_summary || perf;

        // æœªå®ç°ç›ˆäº (ä» engine_state)
        const unrealizedPnl = eng.unrealized_pnl;
        const unrealEl = document.getElementById('p_unrealized');
        if (unrealizedPnl != null) {
            unrealEl.textContent = (unrealizedPnl >= 0 ? '+' : '') + '$' + Number(unrealizedPnl).toFixed(2);
            unrealEl.className = 'value ' + (unrealizedPnl >= 0 ? 'green' : 'red');
        } else {
            unrealEl.textContent = '$0.00';
            unrealEl.className = 'value';
        }

        // å·²å®ç°ç›ˆäº
        const totalPnl = risk.total_pnl ?? perfSummary.total_pnl;
        document.getElementById('p_pnl').textContent = totalPnl != null ? '$' + Number(totalPnl).toFixed(2) : '$0.00';
        document.getElementById('p_pnl').className = 'value ' + ((totalPnl||0) >= 0 ? 'green' : 'red');
        const totalTrades = risk.total_trades || perfSummary.total_trades || 0;
        const totalWins = risk.total_wins || perfSummary.wins || perfSummary.total_wins || 0;
        const wr = totalTrades > 0 ? (totalWins / totalTrades * 100).toFixed(0) + '%' : '--';
        document.getElementById('p_winrate').textContent = wr;
        const fees = risk.total_fees ?? perfSummary.total_fees;
        document.getElementById('p_fees').textContent = fees != null ? '$' + Number(fees).toFixed(2) : '$0.00';
        const peak = risk.peak_equity ?? perfSummary.peak_equity;
        document.getElementById('p_peak').textContent = peak != null ? '$' + Number(peak).toFixed(2) : '--';

        // å½“å‰æƒç›Š
        const eqEl = document.getElementById('p_equity');
        if (equity != null) {
            eqEl.textContent = '$' + Number(equity).toFixed(2);
            const initialCapital = Number(
                perfSummary.initial_capital ?? eng.initial_capital ?? 0
            );
            if (initialCapital > 0) {
                const eqChg = equity - initialCapital;
                eqEl.className = 'value ' + (eqChg >= 0 ? 'green' : 'red');
            } else {
                eqEl.className = 'value';
            }
        } else {
            eqEl.textContent = '--';
        }

        // å†å²äº¤æ˜“/é€æ—¥ç›ˆäº/ç»Ÿè®¡
        await refreshLiveHistoryData();

    } catch(e) {
        console.error('Status refresh failed:', e);
    }
}

// ============================================================
// æ—¥å¿—
// ============================================================
let _autoLogInterval = null;

function startAutoLogRefresh() {
    if (!_autoLogInterval) {
        refreshLogs();
        _autoLogInterval = setInterval(refreshLogs, 5000);
        document.getElementById('autoLogBtn').textContent = 'è‡ªåŠ¨åˆ·æ–°: å¼€';
    }
}

async function refreshLogs() {
    try {
        const data = await apiCall('/api/live/logs?lines=150');
        if (data.success) {
            const el = document.getElementById('logOutput');
            // ç€è‰²
            let html = (data.logs || 'æš‚æ— æ—¥å¿—')
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/^(.*\[TRADE\].*)$/gm, '<span class="line-ok">$1</span>')
                .replace(/^(.*\[RISK\].*)$/gm, '<span class="line-warn">$1</span>')
                .replace(/^(.*\[ERROR\].*)$/gm, '<span class="line-err">$1</span>')
                .replace(/^(.*\[SIGNAL\].*)$/gm, '<span class="line-info">$1</span>');
            el.innerHTML = html;
            el.scrollTop = el.scrollHeight;
            document.getElementById('logFile').textContent = data.file
                ? 'æ—¥å¿—æ–‡ä»¶: ' + data.file + ' (' + data.total_lines + ' è¡Œ)'
                : '';
        }
    } catch(e) {
        document.getElementById('logOutput').textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
    }
}

function autoRefreshLogs() {
    if (_autoLogInterval) {
        clearInterval(_autoLogInterval);
        _autoLogInterval = null;
        document.getElementById('autoLogBtn').textContent = 'è‡ªåŠ¨åˆ·æ–°: å…³';
    } else {
        refreshLogs();
        _autoLogInterval = setInterval(refreshLogs, 5000);
        document.getElementById('autoLogBtn').textContent = 'è‡ªåŠ¨åˆ·æ–°: å¼€';
    }
}

// ============================================================
// v11 åŠŸèƒ½å¼€å…³
// ============================================================
function _updateToggleStyle(checkboxId, dotId) {
    const cb = document.getElementById(checkboxId);
    const dot = document.getElementById(dotId);
    const track = dot?.previousElementSibling;
    if (!cb || !dot || !track) return;
    if (cb.checked) {
        track.style.background = 'var(--accent-blue)';
        dot.style.transform = 'translateX(20px)';
    } else {
        track.style.background = 'rgba(255,255,255,0.1)';
        dot.style.transform = 'translateX(0)';
    }
}

function onV11ToggleChange() {
    _updateToggleStyle('toggle_soft_antisqueeze', 'toggle_soft_antisqueeze_dot');
    _updateToggleStyle('toggle_score_calibration', 'toggle_score_calibration_dot');
    _updateToggleStyle('toggle_ml_enhancement', 'toggle_ml_enhancement_dot');
}

async function loadV11Toggles() {
    try {
        const data = await apiCall('/api/live/load_config');
        if (data.success && data.config) {
            const strategy = data.config.strategy || {};
            document.getElementById('toggle_soft_antisqueeze').checked =
                !!strategy.use_soft_antisqueeze;
            document.getElementById('toggle_score_calibration').checked =
                !!strategy.use_score_calibration;
            document.getElementById('toggle_score_cal_shadow').checked =
                strategy.score_calibration_shadow_mode !== false;
            document.getElementById('toggle_ml_enhancement').checked =
                !!strategy.use_ml_enhancement;
            document.getElementById('toggle_ml_shadow').checked =
                strategy.ml_enhancement_shadow_mode !== false;
            document.getElementById('toggle_ml_kelly').checked =
                !!strategy.ml_use_kelly_position;
            document.getElementById('toggle_ml_dynamic_sl').checked =
                !!strategy.ml_use_dynamic_sl;
            document.getElementById('toggle_ml_neural_fusion').checked =
                !!strategy.ml_use_neural_fusion;
            onV11ToggleChange();
            document.getElementById('v11ToggleResult').innerHTML =
                '<span class="result-badge success">âœ“ çŠ¶æ€å·²åˆ·æ–°</span>';
        }
    } catch(e) {
        document.getElementById('v11ToggleResult').innerHTML =
            '<span class="result-badge error">åŠ è½½å¤±è´¥: ' + e.message + '</span>';
    }
    loadMLModelStatus();
}

async function loadMLModelStatus() {
    const el = document.getElementById('mlModelStatus');
    try {
        const data = await apiCall('/api/ml/status');
        if (data.success && data.status) {
            const s = data.status;
            const ok = '<span style="color: var(--accent-green);">âœ“</span>';
            const no = '<span style="color: var(--accent-red);">âœ—</span>';
            let parts = [];
            if (s.models) {
                for (const [key, m] of Object.entries(s.models)) {
                    let tag = m.exists ? ok : no;
                    let label = m.label || key;
                    if (m.exists && m.test_auc) {
                        label += '<span style="color:var(--text-muted);">(' + m.test_auc.toFixed(3) + ')</span>';
                    }
                    parts.push(tag + ' ' + label);
                }
            } else {
                parts.push(s.lgb_direction_model ? ok + ' LGBæ–¹å‘' : no + ' LGBæ–¹å‘');
                parts.push(s.lstm_model ? ok + ' LSTM' : no + ' LSTM');
                parts.push(s.regime_model ? ok + ' Regime' : no + ' Regime');
                parts.push(s.quantile_model ? ok + ' åˆ†ä½æ•°' : no + ' åˆ†ä½æ•°');
            }
            let total = s.total_models || 4;
            let html = 'MLæ¨¡å‹ (' + (s.model_count || 0) + '/' + total + '): '
                + parts.join(' Â· ');
            if (s.training_meta) {
                const m = s.training_meta;
                html += '<br><span style="color: var(--text-muted); font-size: 10px;">'
                    + (m.version || '') + ' | GPU: ' + (m.gpu || 'N/A')
                    + ' | è®­ç»ƒ: ' + (m.trained_at || '').slice(0, 16)
                    + '</span>';
            }
            if (!s.any_model) {
                html += '<br><span style="color: var(--accent-yellow);">âš  æ¨¡å‹æœªå°±ç»ª</span>';
            }
            el.innerHTML = html;
        }
    } catch(e) {
        el.innerHTML = 'MLæ¨¡å‹: <span style="color: var(--accent-red);">æŸ¥è¯¢å¤±è´¥</span>';
    }
}

async function saveV11Toggles() {
    setLoading('v11SaveBtnText', true);
    try {
        // å…ˆåŠ è½½ç°æœ‰é…ç½®
        const loadData = await apiCall('/api/live/load_config');
        if (!loadData.success || !loadData.config) {
            throw new Error('æ— æ³•åŠ è½½ç°æœ‰é…ç½®');
        }
        const config = loadData.config;
        if (!config.strategy) config.strategy = {};

        // æ›´æ–° v11 å¼€å…³
        config.strategy.use_soft_antisqueeze =
            document.getElementById('toggle_soft_antisqueeze').checked;
        config.strategy.use_score_calibration =
            document.getElementById('toggle_score_calibration').checked;
        config.strategy.score_calibration_shadow_mode =
            document.getElementById('toggle_score_cal_shadow').checked;
        config.strategy.use_ml_enhancement =
            document.getElementById('toggle_ml_enhancement').checked;
        config.strategy.ml_enhancement_shadow_mode =
            document.getElementById('toggle_ml_shadow').checked;
        config.strategy.ml_use_kelly_position =
            document.getElementById('toggle_ml_kelly').checked;
        config.strategy.ml_use_dynamic_sl =
            document.getElementById('toggle_ml_dynamic_sl').checked;
        config.strategy.ml_use_neural_fusion =
            document.getElementById('toggle_ml_neural_fusion').checked;

        // ä¿å­˜
        const saveData = await apiCall('/api/live/save_config', {
            method: 'POST', body: JSON.stringify(config)
        });

        if (saveData.success) {
            document.getElementById('v11ToggleResult').innerHTML =
                '<span class="result-badge success">âœ“ å·²ä¿å­˜ï¼Œé‡å¯å¼•æ“åç”Ÿæ•ˆ</span>';
            // åŒæ­¥åˆ°é…ç½®ç¼–è¾‘å™¨
            document.getElementById('configEditor').value = JSON.stringify(config, null, 2);
        } else {
            document.getElementById('v11ToggleResult').innerHTML =
                '<span class="result-badge error">' + saveData.message + '</span>';
        }
    } catch(e) {
        document.getElementById('v11ToggleResult').innerHTML =
            '<span class="result-badge error">ä¿å­˜å¤±è´¥: ' + e.message + '</span>';
    }
    setLoading('v11SaveBtnText', false);
}

// åˆå§‹åŠ è½½: æ¢å¤æŒä¹…åŒ–çŠ¶æ€
async function initLiveControlPage() {
    restoreTFSelection();
    await restoreLastResult();   // ä¼˜å…ˆä»æœåŠ¡å™¨è¯»ç¼“å­˜ï¼Œå†å†³å®šæ˜¯å¦è‡ªåŠ¨è¡¥è·‘
    restoreActiveTab();
    restoreAutoDetect();         // æ¢å¤è‡ªåŠ¨æ£€æµ‹å¼€å…³
    loadMonitorRules();
    loadV11Toggles();            // åŠ è½½ v11 å¼€å…³çŠ¶æ€
    refreshStatus();
    startAutoLogRefresh();       // é»˜è®¤å¯åŠ¨æ—¥å¿—è‡ªåŠ¨åˆ·æ–°
    setInterval(refreshStatus, 30000); // æ¯30ç§’åˆ·æ–°çŠ¶æ€
}
initLiveControlPage();
</script>
{% endblock %}
