{% extends "base.html" %}
{% block title %}å®ç›˜æ§åˆ¶é¢æ¿ - æŠ€æœ¯åˆ†æå¹³å°{% endblock %}

{% block content %}
<style>
    .control-header { margin-bottom: 32px; }
    .control-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .control-header p { color: var(--text-secondary); font-size: 14px; }

    .status-bar {
        display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 28px;
    }
    .status-chip {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 16px; border-radius: 8px;
        background: var(--bg-card); border: 1px solid var(--border);
        font-size: 13px;
    }
    .status-dot {
        width: 8px; height: 8px; border-radius: 50%;
    }
    .status-dot.green { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
    .status-dot.red { background: var(--accent-red); }
    .status-dot.yellow { background: var(--accent-yellow); animation: pulse 2s infinite; }
    .status-dot.gray { background: var(--text-muted); }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .grid-1 { margin-bottom: 20px; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

    .ctrl-card {
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: 12px; padding: 24px; position: relative;
    }
    .ctrl-card h3 {
        font-size: 15px; font-weight: 600; margin-bottom: 6px;
        display: flex; align-items: center; gap: 8px;
    }
    .ctrl-card .desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }

    .btn {
        padding: 10px 20px; border: none; border-radius: 8px;
        font-size: 14px; font-weight: 600; cursor: pointer;
        transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent-blue); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #3b82f6; box-shadow: 0 4px 16px rgba(74,158,255,0.3); }
    .btn-success { background: var(--accent-green); color: #000; }
    .btn-success:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(0,214,143,0.3); }
    .btn-danger { background: var(--accent-red); color: #fff; }
    .btn-danger:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(255,77,106,0.3); }
    .btn-warn { background: var(--accent-yellow); color: #000; }
    .btn-warn:hover:not(:disabled) { box-shadow: 0 4px 16px rgba(255,170,0,0.3); }
    .btn-outline {
        background: transparent; color: var(--text-primary);
        border: 1px solid var(--border);
    }
    .btn-outline:hover:not(:disabled) { border-color: var(--accent-blue); color: var(--accent-blue); }
    .btn-sm { padding: 6px 14px; font-size: 13px; }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

    .output-box {
        margin-top: 16px; background: #0d0f17; border: 1px solid var(--border);
        border-radius: 8px; padding: 16px; font-family: 'JetBrains Mono', monospace;
        font-size: 13px; line-height: 1.7; white-space: pre-wrap; word-break: break-all;
        max-height: 400px; overflow-y: auto; color: var(--text-secondary);
        display: none;
    }
    .output-box.visible { display: block; }
    .output-box .line-ok { color: var(--accent-green); }
    .output-box .line-err { color: var(--accent-red); }
    .output-box .line-info { color: var(--accent-blue); }
    .output-box .line-warn { color: var(--accent-yellow); }

    .result-badge {
        display: inline-block; padding: 3px 10px; border-radius: 6px;
        font-size: 12px; font-weight: 600; margin-top: 12px;
    }
    .result-badge.success { background: rgba(0,214,143,0.15); color: var(--accent-green); }
    .result-badge.error { background: rgba(255,77,106,0.15); color: var(--accent-red); }

    .spinner-sm {
        display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .config-editor {
        width: 100%; min-height: 300px; background: #0d0f17; color: var(--text-primary);
        border: 1px solid var(--border); border-radius: 8px; padding: 16px;
        font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6;
        resize: vertical; outline: none;
    }
    .config-editor:focus { border-color: var(--accent-blue); }

    select.phase-select {
        padding: 8px 12px; background: var(--bg-secondary); color: var(--text-primary);
        border: 1px solid var(--border); border-radius: 8px; font-size: 14px;
        outline: none; cursor: pointer;
    }
    select.phase-select:focus { border-color: var(--accent-blue); }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .info-item { background: var(--bg-secondary); border-radius: 8px; padding: 12px; }
    .info-item .label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
    .info-item .value { font-size: 18px; font-weight: 700; }
    .info-item .value.green { color: var(--accent-green); }
    .info-item .value.red { color: var(--accent-red); }

    /* å¤šTFä¿¡å·æ£€æµ‹ */
    .tf-checkbox-grid {
        display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;
    }
    .tf-chip {
        display: flex; align-items: center; gap: 4px;
        padding: 5px 10px; border-radius: 6px; cursor: pointer;
        font-size: 12px; font-weight: 600; user-select: none;
        background: var(--bg-secondary); border: 1px solid var(--border);
        transition: all 0.2s;
    }
    .tf-chip:hover { border-color: var(--accent-blue); }
    .tf-chip input { display: none; }
    .tf-chip.checked {
        background: rgba(74,158,255,0.15); border-color: var(--accent-blue);
        color: var(--accent-blue);
    }

    .multi-result-table {
        width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 12px;
    }
    .multi-result-table th {
        text-align: left; padding: 8px 10px; font-weight: 600; font-size: 11px;
        color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
    }
    .multi-result-table td {
        padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04);
        font-family: 'JetBrains Mono', monospace; font-size: 12px;
    }
    .multi-result-table tr:hover td { background: rgba(255,255,255,0.02); }
    .action-long { color: var(--accent-green); font-weight: 700; }
    .action-short { color: var(--accent-red); font-weight: 700; }
    .action-hold { color: var(--text-muted); }
    .consensus-box {
        margin-top: 14px; padding: 12px 16px; border-radius: 8px;
        background: var(--bg-secondary); border: 1px solid var(--border);
        font-size: 14px; font-weight: 600;
    }
    .consensus-box.long { border-color: var(--accent-green); color: var(--accent-green); }
    .consensus-box.short { border-color: var(--accent-red); color: var(--accent-red); }
    .consensus-box.neutral { border-color: var(--text-muted); color: var(--text-secondary); }
    .consensus-box.conflict { border-color: var(--accent-yellow); color: var(--accent-yellow); }

    .tab-bar { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .tab-btn {
        padding: 10px 20px; font-size: 14px; font-weight: 500;
        color: var(--text-muted); background: none; border: none;
        border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .kill-switch-btn {
        padding: 16px 32px; font-size: 18px; font-weight: 700;
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: #fff; border: 2px solid #ef4444; border-radius: 12px;
        cursor: pointer; transition: all 0.2s; width: 100%;
    }
    .kill-switch-btn:hover:not(:disabled) {
        box-shadow: 0 0 30px rgba(255,77,106,0.4);
        transform: scale(1.01);
    }
    .kill-switch-btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

<div class="control-header">
    <h1>ğŸ›ï¸ å®ç›˜æ§åˆ¶é¢æ¿</h1>
    <p>å…­ä¹¦èåˆç­–ç•¥ Â· å®æ—¶ç®¡ç†ä¸ç›‘æ§</p>
</div>

<!-- çŠ¶æ€æ  -->
<div class="status-bar" id="statusBar">
    <div class="status-chip">
        <span class="status-dot gray" id="engineDot"></span>
        <span id="engineStatus">å¼•æ“: æœªè¿è¡Œ</span>
    </div>
    <div class="status-chip">
        <span class="status-dot gray" id="riskDot"></span>
        <span id="riskStatus">é£æ§: --</span>
    </div>
    <div class="status-chip">
        <span id="equityDisplay">æƒç›Š: --</span>
    </div>
    <div class="status-chip">
        <span id="positionDisplay">æŒä»“: æ— </span>
    </div>
</div>

<!-- Tab æ  -->
<div class="tab-bar">
    <button class="tab-btn active" data-tab="operations">æ“ä½œ</button>
    <button class="tab-btn" data-tab="config">é…ç½®</button>
    <button class="tab-btn" data-tab="status">çŠ¶æ€ç›‘æ§</button>
    <button class="tab-btn" data-tab="logs">æ—¥å¿—</button>
</div>

<!-- Tab: æ“ä½œ -->
<div class="tab-panel active" id="tab-operations">
    <div class="grid-2">
        <!-- å¤šæ—¶é—´æ¡†æ¶ä¿¡å·æ£€æµ‹ -->
        <div class="ctrl-card" style="grid-column: 1 / -1;">
            <h3>ğŸ“¡ å¤šå‘¨æœŸä¿¡å·æ£€æµ‹</h3>
            <p class="desc">åŒæ—¶è·å–å¤šä¸ªæ—¶é—´æ¡†æ¶çš„Kçº¿æ•°æ®ï¼Œå¹¶è¡Œè®¡ç®—å…­ç»´èåˆä¿¡å·ï¼Œå±•ç¤ºå¤šå‘¨æœŸå…±è¯†</p>

            <div class="tf-checkbox-grid" id="tfCheckboxes">
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="10m" checked> 10m
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="15m" checked> 15m
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="30m" checked> 30m
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="1h" checked> 1h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="2h"> 2h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="4h" checked> 4h
                </label>
                <label class="tf-chip" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="6h"> 6h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="8h" checked> 8h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="12h" checked> 12h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="16h" checked> 16h
                </label>
                <label class="tf-chip checked" onclick="toggleTFChip(this)">
                    <input type="checkbox" value="24h" checked> 24h
                </label>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="testSignalMulti()">
                    <span id="signalMultiBtnText">ğŸš€ å…¨éƒ¨æ£€æµ‹</span>
                </button>
                <button class="btn btn-outline btn-sm" onclick="selectAllTF(true)">å…¨é€‰</button>
                <button class="btn btn-outline btn-sm" onclick="selectAllTF(false)">å…¨ä¸é€‰</button>
                <span id="signalMultiTimer" style="font-size:12px;color:var(--text-muted);align-self:center;"></span>
            </div>

            <div id="signalMultiResult" style="display:none;margin-top:16px;">
                <table class="multi-result-table">
                    <thead>
                        <tr>
                            <th>å‘¨æœŸ</th>
                            <th>ä»·æ ¼</th>
                            <th>å–å‡ºåˆ†</th>
                            <th>ä¹°å…¥åˆ†</th>
                            <th>åŠ¨ä½œ</th>
                            <th>åŸå› </th>
                            <th>è€—æ—¶</th>
                        </tr>
                    </thead>
                    <tbody id="signalMultiBody"></tbody>
                </table>
                <div id="signalConsensus" class="consensus-box neutral"></div>
            </div>

            <div class="output-box" id="signalOutput"></div>
        </div>

        <!-- API è¿æ¥æµ‹è¯• -->
        <div class="ctrl-card">
            <h3>ğŸ”— æµ‹è¯• API è¿æ¥</h3>
            <p class="desc">æ£€æµ‹ Binance API è¿æ¥çŠ¶æ€ã€ä½™é¢å’Œå½“å‰ä»·æ ¼</p>
            <button class="btn btn-primary" onclick="testConnection()">
                <span id="connBtnText">æµ‹è¯•è¿æ¥</span>
            </button>
            <div class="output-box" id="connOutput"></div>
        </div>

        <!-- å¯åŠ¨å¼•æ“ -->
        <div class="ctrl-card">
            <h3>ğŸš€ å¯åŠ¨äº¤æ˜“å¼•æ“</h3>
            <p class="desc">é€‰æ‹©é˜¶æ®µå¹¶å¯åŠ¨åå°äº¤æ˜“å¼•æ“</p>
            <div class="btn-group">
                <select class="phase-select" id="enginePhase">
                    <option value="paper" selected>Phase 1: çº¸ä¸Šäº¤æ˜“</option>
                    <option value="testnet">Phase 2: æµ‹è¯•ç½‘</option>
                    <option value="small_live">Phase 3: å°èµ„é‡‘å®ç›˜</option>
                    <option value="scale_up">Phase 4: é€æ­¥åŠ ä»“</option>
                </select>
                <button class="btn btn-success" onclick="startEngine()">
                    <span id="startBtnText">å¯åŠ¨</span>
                </button>
                <button class="btn btn-outline" onclick="stopEngine()">åœæ­¢</button>
            </div>
            <div class="output-box" id="engineOutput"></div>
        </div>

        <!-- ç”Ÿæˆé…ç½® -->
        <div class="ctrl-card">
            <h3>âš™ï¸ ç”Ÿæˆé…ç½®æ¨¡æ¿</h3>
            <p class="desc">ç”Ÿæˆ live_trading_config.json é…ç½®æ¨¡æ¿æ–‡ä»¶</p>
            <button class="btn btn-primary" onclick="generateConfig()">
                <span id="genBtnText">ç”Ÿæˆé…ç½®</span>
            </button>
            <div class="output-box" id="genOutput"></div>
        </div>
    </div>

    <!-- Kill Switch -->
    <div class="ctrl-card" style="border-color: rgba(255,77,106,0.3);">
        <h3 style="color: var(--accent-red);">ğŸš¨ Kill Switch ç´§æ€¥å¹³ä»“</h3>
        <p class="desc">ç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“ã€æ’¤é”€æ‰€æœ‰æŒ‚å•ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
        <button class="kill-switch-btn" id="killBtn" onclick="killSwitch()">
            âš ï¸ ç´§æ€¥å¹³ä»“ (Kill Switch)
        </button>
        <div class="output-box" id="killOutput"></div>
    </div>
</div>

<!-- Tab: é…ç½® -->
<div class="tab-panel" id="tab-config">
    <div class="ctrl-card">
        <h3>ğŸ“ é…ç½®æ–‡ä»¶ç¼–è¾‘å™¨</h3>
        <p class="desc">ç¼–è¾‘ live_trading_config.json â€” ä¿®æ”¹ API Keyã€äº¤æ˜“å‚æ•°ã€é£æ§è®¾ç½®</p>
        <div class="btn-group" style="margin-bottom: 16px;">
            <button class="btn btn-outline btn-sm" onclick="loadConfig()">åŠ è½½é…ç½®</button>
            <button class="btn btn-primary btn-sm" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            <button class="btn btn-outline btn-sm" onclick="generateConfig()">é‡æ–°ç”Ÿæˆæ¨¡æ¿</button>
        </div>
        <textarea class="config-editor" id="configEditor" spellcheck="false" placeholder='ç‚¹å‡» "åŠ è½½é…ç½®" æˆ– "é‡æ–°ç”Ÿæˆæ¨¡æ¿" å¼€å§‹...'></textarea>
        <div id="configResult"></div>
    </div>
</div>

<!-- Tab: çŠ¶æ€ç›‘æ§ -->
<div class="tab-panel" id="tab-status">
    <div class="ctrl-card" style="margin-bottom: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3>ğŸ“Š å¼•æ“çŠ¶æ€</h3>
            <button class="btn btn-outline btn-sm" onclick="refreshStatus()">åˆ·æ–°</button>
        </div>
        <div class="info-grid" id="statusGrid">
            <div class="info-item"><div class="label">è¿›ç¨‹çŠ¶æ€</div><div class="value" id="s_proc">--</div></div>
            <div class="info-item"><div class="label">è¿è¡Œé˜¶æ®µ</div><div class="value" id="s_phase">--</div></div>
            <div class="info-item"><div class="label">USDT ä½™é¢</div><div class="value" id="s_usdt">--</div></div>
            <div class="info-item"><div class="label">å†»ç»“ä¿è¯é‡‘</div><div class="value" id="s_frozen">--</div></div>
            <div class="info-item"><div class="label">æ€»Kçº¿</div><div class="value" id="s_bars">--</div></div>
            <div class="info-item"><div class="label">æŒä»“</div><div class="value" id="s_positions">--</div></div>
        </div>
    </div>
    <div class="grid-2">
        <div class="ctrl-card">
            <h3>ğŸ›¡ï¸ é£æ§çŠ¶æ€</h3>
            <div class="info-grid" id="riskGrid">
                <div class="info-item"><div class="label">æš‚åœçŠ¶æ€</div><div class="value" id="r_paused">--</div></div>
                <div class="info-item"><div class="label">Kill Switch</div><div class="value" id="r_kill">--</div></div>
                <div class="info-item"><div class="label">æ—¥ç›ˆäº</div><div class="value" id="r_daily">--</div></div>
                <div class="info-item"><div class="label">è¿ç»­äºæŸ</div><div class="value" id="r_consec">--</div></div>
                <div class="info-item"><div class="label">æœ€å¤§å›æ’¤</div><div class="value" id="r_dd">--</div></div>
                <div class="info-item"><div class="label">æ€»äº¤æ˜“</div><div class="value" id="r_trades">--</div></div>
            </div>
        </div>
        <div class="ctrl-card">
            <h3>ğŸ’° ç»©æ•ˆç»Ÿè®¡</h3>
            <div class="info-grid" id="perfGrid">
                <div class="info-item"><div class="label">æ€»ç›ˆäº</div><div class="value" id="p_pnl">--</div></div>
                <div class="info-item"><div class="label">èƒœç‡</div><div class="value" id="p_winrate">--</div></div>
                <div class="info-item"><div class="label">æ€»æ‰‹ç»­è´¹</div><div class="value" id="p_fees">--</div></div>
                <div class="info-item"><div class="label">å³°å€¼æƒç›Š</div><div class="value" id="p_peak">--</div></div>
            </div>
        </div>
    </div>
</div>

<!-- Tab: æ—¥å¿— -->
<div class="tab-panel" id="tab-logs">
    <div class="ctrl-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
            <div class="btn-group">
                <button class="btn btn-outline btn-sm" onclick="refreshLogs()">åˆ·æ–°</button>
                <button class="btn btn-outline btn-sm" onclick="autoRefreshLogs()">
                    <span id="autoLogBtn">è‡ªåŠ¨åˆ·æ–°: å…³</span>
                </button>
            </div>
        </div>
        <div id="logFile" style="font-size:12px; color:var(--text-muted); margin-bottom:8px;"></div>
        <div class="output-box visible" id="logOutput" style="max-height:600px; min-height:300px;">æš‚æ— æ—¥å¿—</div>
    </div>
</div>

<script>
// ============================================================
// Tab åˆ‡æ¢
// ============================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        // åˆ‡æ¢åˆ°æ—¥å¿— Tab æ—¶è‡ªåŠ¨åŠ è½½
        if (btn.dataset.tab === 'logs') refreshLogs();
        // åˆ‡æ¢åˆ°çŠ¶æ€ Tab æ—¶è‡ªåŠ¨åˆ·æ–°
        if (btn.dataset.tab === 'status') refreshStatus();
    });
});

// ============================================================
// é€šç”¨å·¥å…·
// ============================================================
function showOutput(id, text, type) {
    const box = document.getElementById(id);
    box.classList.add('visible');
    // ç€è‰²å¤„ç†
    const colored = text
        .replace(/^(.*âœ….*|.*æˆåŠŸ.*|.*PASSED.*|.*active.*)$/gm, '<span class="line-ok">$1</span>')
        .replace(/^(.*âŒ.*|.*å¤±è´¥.*|.*ERROR.*|.*FAILED.*)$/gm, '<span class="line-err">$1</span>')
        .replace(/^(.*âš ï¸.*|.*WARNING.*|.*WARN.*)$/gm, '<span class="line-warn">$1</span>')
        .replace(/^(.*â•â•â•.*|.*---.*|.*INFO.*)$/gm, '<span class="line-info">$1</span>');
    box.innerHTML = colored;
    box.scrollTop = box.scrollHeight;
}

function setLoading(btnId, loading) {
    const el = document.getElementById(btnId);
    if (loading) {
        el.dataset.origText = el.textContent;
        el.innerHTML = '<span class="spinner-sm"></span> æ‰§è¡Œä¸­...';
        el.closest('button')?.setAttribute('disabled', '');
    } else {
        el.textContent = el.dataset.origText || el.textContent;
        el.closest('button')?.removeAttribute('disabled');
    }
}

async function apiCall(url, options = {}) {
    const resp = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...options
    });
    // ä¼šè¯è¿‡æœŸ â†’ è‡ªåŠ¨è·³è½¬ç™»å½•
    if (resp.status === 401) {
        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
        throw new Error('ä¼šè¯å·²è¿‡æœŸï¼Œæ­£åœ¨è·³è½¬ç™»å½•...');
    }
    // é JSON å“åº”ï¼ˆå¦‚æ„å¤–çš„ HTML é‡å®šå‘ï¼‰
    const ct = resp.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
        throw new Error('æœåŠ¡å™¨è¿”å›äº†é JSON å“åº”ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•');
    }
    return await resp.json();
}

// ============================================================
// æ“ä½œå‡½æ•°
// ============================================================
function toggleTFChip(label) {
    const cb = label.querySelector('input');
    cb.checked = !cb.checked;
    label.classList.toggle('checked', cb.checked);
}

function selectAllTF(checked) {
    document.querySelectorAll('#tfCheckboxes input').forEach(cb => {
        cb.checked = checked;
        cb.closest('.tf-chip').classList.toggle('checked', checked);
    });
}

function getSelectedTFs() {
    const tfs = [];
    document.querySelectorAll('#tfCheckboxes input:checked').forEach(cb => tfs.push(cb.value));
    return tfs;
}

async function testSignalMulti() {
    const tfs = getSelectedTFs();
    if (tfs.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¶é—´æ¡†æ¶'); return; }

    setLoading('signalMultiBtnText', true);
    const timerEl = document.getElementById('signalMultiTimer');
    const t0 = Date.now();
    const timer = setInterval(() => {
        timerEl.textContent = `å·²ç”¨æ—¶ ${((Date.now() - t0) / 1000).toFixed(0)}s ...`;
    }, 500);

    try {
        const data = await apiCall('/api/live/test_signal_multi', {
            method: 'POST',
            body: JSON.stringify({ timeframes: tfs })
        });

        clearInterval(timer);
        timerEl.textContent = '';

        if (data.data && data.data.results) {
            renderMultiSignalResult(data.data);
        }
        // åŒæ—¶æ˜¾ç¤ºæ–‡æœ¬è¾“å‡ºï¼ˆå¯æŠ˜å ï¼‰
        if (data.output) {
            showOutput('signalOutput', data.output);
        } else if (data.error) {
            showOutput('signalOutput', data.error);
        }
    } catch(e) {
        clearInterval(timer);
        timerEl.textContent = '';
        showOutput('signalOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('signalMultiBtnText', false);
}

function renderMultiSignalResult(data) {
    const container = document.getElementById('signalMultiResult');
    const tbody = document.getElementById('signalMultiBody');
    const consensusEl = document.getElementById('signalConsensus');

    container.style.display = 'block';
    tbody.innerHTML = '';

    for (const r of data.results) {
        const tr = document.createElement('tr');
        if (r.ok) {
            let actionClass = 'action-hold';
            let actionIcon = 'âšª';
            if (r.action && r.action.includes('LONG')) { actionClass = 'action-long'; actionIcon = 'ğŸŸ¢'; }
            else if (r.action && r.action.includes('SHORT')) { actionClass = 'action-short'; actionIcon = 'ğŸ”´'; }

            tr.innerHTML = `
                <td><strong>${r.tf}</strong></td>
                <td>$${r.price.toFixed(2)}</td>
                <td style="color:${r.sell_score > 30 ? 'var(--accent-red)' : 'var(--text-secondary)'}">${r.sell_score.toFixed(1)}</td>
                <td style="color:${r.buy_score > 30 ? 'var(--accent-green)' : 'var(--text-secondary)'}">${r.buy_score.toFixed(1)}</td>
                <td class="${actionClass}">${actionIcon} ${r.action || 'HOLD'}</td>
                <td style="font-size:11px;color:var(--text-secondary)">${r.reason || ''}</td>
                <td style="color:var(--text-muted)">${r.elapsed}s</td>
            `;
        } else {
            tr.innerHTML = `
                <td><strong>${r.tf}</strong></td>
                <td colspan="5" style="color:var(--accent-red)">âŒ ${r.error || 'å¤±è´¥'}</td>
                <td style="color:var(--text-muted)">${r.elapsed || 0}s</td>
            `;
        }
        tbody.appendChild(tr);
    }

    // æ¸²æŸ“å…±è¯†
    const c = data.consensus || {};
    const longN = (c.long || []).length;
    const shortN = (c.short || []).length;
    const holdN = (c.hold || []).length;
    const totalN = data.results.filter(r => r.ok).length;

    let consensusHTML = '';
    let consensusClass = 'neutral';
    if (c.direction === 'long') {
        consensusClass = 'long';
        consensusHTML = `ğŸŸ¢ å¤šå¤´å…±æŒ¯ â€” ${longN}/${totalN} ä¸ªå‘¨æœŸçœ‹å¤š (${(c.long||[]).join(', ')})`;
    } else if (c.direction === 'short') {
        consensusClass = 'short';
        consensusHTML = `ğŸ”´ ç©ºå¤´å…±æŒ¯ â€” ${shortN}/${totalN} ä¸ªå‘¨æœŸçœ‹ç©º (${(c.short||[]).join(', ')})`;
    } else if (c.direction === 'conflict') {
        consensusClass = 'conflict';
        consensusHTML = `âš ï¸ å¤šç©ºåˆ†æ­§ â€” åšå¤š: ${(c.long||[]).join(',')} | åšç©º: ${(c.short||[]).join(',')} | è§‚æœ›: ${(c.hold||[]).join(',')}`;
    } else {
        consensusClass = 'neutral';
        consensusHTML = `âšª ä¸­æ€§ â€” æ— æ˜ç¡®æ–¹å‘ (è§‚æœ› ${holdN}/${totalN})`;
    }

    consensusHTML += `<div style="font-size:12px;font-weight:400;color:var(--text-muted);margin-top:6px;">
        æ€»è€—æ—¶ ${data.total_elapsed}s Â· å…± ${totalN} ä¸ªå‘¨æœŸ</div>`;

    consensusEl.className = `consensus-box ${consensusClass}`;
    consensusEl.innerHTML = consensusHTML;
}

/* ä¿ç•™å•TFæµ‹è¯•ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼‰ */
async function testSignal() {
    testSignalMulti();
}

async function testConnection() {
    setLoading('connBtnText', true);
    try {
        const data = await apiCall('/api/live/test_connection', { method: 'POST' });
        showOutput('connOutput', data.output || data.error || 'æ— è¾“å‡º');
    } catch(e) {
        showOutput('connOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('connBtnText', false);
}

async function startEngine() {
    const phase = document.getElementById('enginePhase').value;
    if (phase === 'small_live' || phase === 'scale_up') {
        if (!confirm(`âš ï¸ å³å°†å¯åŠ¨ ${phase} æ¨¡å¼ï¼Œæ¶‰åŠçœŸå®èµ„é‡‘ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ`)) return;
    }
    setLoading('startBtnText', true);
    try {
        const data = await apiCall('/api/live/start', {
            method: 'POST', body: JSON.stringify({ phase })
        });
        showOutput('engineOutput', data.success
            ? 'âœ… ' + data.message
            : 'âŒ ' + data.message);
        refreshStatus();
    } catch(e) {
        showOutput('engineOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('startBtnText', false);
}

async function stopEngine() {
    if (!confirm('ç¡®è®¤åœæ­¢äº¤æ˜“å¼•æ“ï¼Ÿ')) return;
    try {
        const data = await apiCall('/api/live/stop', { method: 'POST' });
        showOutput('engineOutput', data.success
            ? 'âœ… ' + data.message
            : 'âŒ ' + data.message);
        refreshStatus();
    } catch(e) {
        showOutput('engineOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
}

async function generateConfig() {
    setLoading('genBtnText', true);
    try {
        const data = await apiCall('/api/live/generate_config', { method: 'POST' });
        if (data.success && data.config) {
            showOutput('genOutput', 'âœ… ' + data.message);
            document.getElementById('configEditor').value = JSON.stringify(data.config, null, 2);
        } else {
            showOutput('genOutput', 'âŒ ' + (data.message || 'ç”Ÿæˆå¤±è´¥'));
        }
    } catch(e) {
        showOutput('genOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    setLoading('genBtnText', false);
}

async function killSwitch() {
    if (!confirm('âš ï¸ ç¡®è®¤æ‰§è¡Œç´§æ€¥å¹³ä»“ï¼Ÿæ­¤æ“ä½œå°†å…³é—­æ‰€æœ‰æŒä»“ï¼')) return;
    if (!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šç«‹å³å¹³ä»“æ‰€æœ‰æŒä»“ï¼Ÿ')) return;
    document.getElementById('killBtn').disabled = true;
    try {
        const data = await apiCall('/api/live/kill_switch', { method: 'POST' });
        showOutput('killOutput', data.output || data.error || data.message);
    } catch(e) {
        showOutput('killOutput', 'è¯·æ±‚å¤±è´¥: ' + e.message);
    }
    document.getElementById('killBtn').disabled = false;
}

// ============================================================
// é…ç½®æ“ä½œ
// ============================================================
async function loadConfig() {
    try {
        const data = await apiCall('/api/live/load_config');
        if (data.success) {
            document.getElementById('configEditor').value = JSON.stringify(data.config, null, 2);
            document.getElementById('configResult').innerHTML =
                '<span class="result-badge success">âœ“ é…ç½®å·²åŠ è½½</span>';
        } else {
            document.getElementById('configResult').innerHTML =
                '<span class="result-badge error">' + data.message + '</span>';
        }
    } catch(e) {
        document.getElementById('configResult').innerHTML =
            '<span class="result-badge error">åŠ è½½å¤±è´¥: ' + e.message + '</span>';
    }
}

async function saveConfig() {
    const text = document.getElementById('configEditor').value;
    try {
        const config = JSON.parse(text);
        const data = await apiCall('/api/live/save_config', {
            method: 'POST', body: JSON.stringify(config)
        });
        document.getElementById('configResult').innerHTML = data.success
            ? '<span class="result-badge success">âœ“ é…ç½®å·²ä¿å­˜</span>'
            : '<span class="result-badge error">' + data.message + '</span>';
    } catch(e) {
        document.getElementById('configResult').innerHTML =
            '<span class="result-badge error">JSON æ ¼å¼é”™è¯¯: ' + e.message + '</span>';
    }
}

// ============================================================
// çŠ¶æ€ç›‘æ§
// ============================================================
async function refreshStatus() {
    try {
        const data = await apiCall('/api/live/status');

        // è¿›ç¨‹çŠ¶æ€
        const proc = data.process || {};
        const running = proc.running;
        document.getElementById('s_proc').textContent = running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
        document.getElementById('s_proc').className = 'value ' + (running ? 'green' : '');

        // å¼•æ“çŠ¶æ€ (ä¼˜å…ˆä» engine_state.jsonï¼Œfallback åˆ°æ—¥å¿—æ•°æ®)
        const eng = data.engine || {};
        const phase = eng.phase || proc.phase || '--';
        document.getElementById('s_phase').textContent = phase;

        document.getElementById('engineDot').className = 'status-dot ' + (running ? 'green' : 'gray');
        document.getElementById('engineStatus').textContent = running
            ? 'å¼•æ“: è¿è¡Œä¸­ (' + phase + ')'
            : 'å¼•æ“: æœªè¿è¡Œ';

        // ä½™é¢ & æƒç›Š
        const equity = eng.equity;
        const usdt = eng.usdt;
        document.getElementById('s_usdt').textContent = usdt != null ? '$' + Number(usdt).toFixed(2) : '--';
        document.getElementById('s_frozen').textContent = eng.frozen_margin != null ? '$' + Number(eng.frozen_margin).toFixed(2) : '--';
        document.getElementById('s_bars').textContent = eng.total_bars || '--';

        // æŒä»“ä¿¡æ¯ - å…¼å®¹ dict (engine_state.json) å’Œ array (æ—¥å¿—) æ ¼å¼
        let posDisplay = 'æ— ';
        const positions = eng.positions;
        if (positions) {
            if (Array.isArray(positions)) {
                // æ—¥å¿—æ¥æº: [{side, entry_price, qty, pnl}]
                posDisplay = positions.length > 0
                    ? positions.map(p => p.side + ' $' + Number(p.entry_price).toFixed(2)).join(', ')
                    : 'æ— ';
            } else {
                // engine_state æ¥æº: {symbol: {side, entry_price, ...}}
                const posList = Object.keys(positions);
                posDisplay = posList.length > 0 ? posList.join(', ') : 'æ— ';
            }
        }
        document.getElementById('s_positions').textContent = posDisplay;
        document.getElementById('positionDisplay').textContent = 'æŒä»“: ' + posDisplay;

        // æƒç›Šæ˜¾ç¤º (çŠ¶æ€æ )
        if (equity != null) {
            document.getElementById('equityDisplay').textContent = 'æƒç›Š: $' + Number(equity).toFixed(2);
        } else if (usdt != null) {
            document.getElementById('equityDisplay').textContent = 'ä½™é¢: $' + Number(usdt).toFixed(2);
        }

        // é£æ§
        const risk = data.risk || {};
        const paused = risk.is_paused;
        if (Object.keys(risk).length > 0) {
            document.getElementById('r_paused').textContent = paused ? 'æ˜¯' : 'å¦';
            document.getElementById('r_paused').className = 'value ' + (paused ? 'red' : 'green');
            document.getElementById('r_kill').textContent = risk.kill_switch_active ? 'æ¿€æ´»' : 'æ­£å¸¸';
            document.getElementById('r_kill').className = 'value ' + (risk.kill_switch_active ? 'red' : 'green');
            document.getElementById('r_daily').textContent = risk.daily_pnl != null ? '$' + Number(risk.daily_pnl).toFixed(2) : '$0.00';
            document.getElementById('r_daily').className = 'value ' + ((risk.daily_pnl||0) >= 0 ? 'green' : 'red');
            document.getElementById('r_consec').textContent = risk.consecutive_losses || '0';
            document.getElementById('r_dd').textContent = risk.max_drawdown != null ? (Number(risk.max_drawdown) * 100).toFixed(1) + '%' : '0.0%';
            document.getElementById('r_trades').textContent = risk.total_trades || '0';

            document.getElementById('riskDot').className = 'status-dot ' + (paused ? 'red' : risk.kill_switch_active ? 'red' : 'green');
            document.getElementById('riskStatus').textContent = paused ? 'é£æ§: å·²æš‚åœ' : 'é£æ§: æ­£å¸¸';
        } else if (running) {
            // å¼•æ“è¿è¡Œä½†é£æ§æ–‡ä»¶è¿˜æ²¡ç”Ÿæˆ
            document.getElementById('riskDot').className = 'status-dot green';
            document.getElementById('riskStatus').textContent = 'é£æ§: æ­£å¸¸';
        }

        // ç»©æ•ˆ (ä» risk state å’Œ performance ç»¼åˆè¯»å–)
        const perf = data.performance || {};
        const totalPnl = risk.total_pnl ?? perf.total_pnl;
        document.getElementById('p_pnl').textContent = totalPnl != null ? '$' + Number(totalPnl).toFixed(2) : '$0.00';
        document.getElementById('p_pnl').className = 'value ' + ((totalPnl||0) >= 0 ? 'green' : 'red');
        const totalTrades = risk.total_trades || perf.total_trades || 0;
        const totalWins = risk.total_wins || perf.total_wins || 0;
        const wr = totalTrades > 0 ? (totalWins / totalTrades * 100).toFixed(0) + '%' : '--';
        document.getElementById('p_winrate').textContent = wr;
        const fees = risk.total_fees ?? perf.total_fees;
        document.getElementById('p_fees').textContent = fees != null ? '$' + Number(fees).toFixed(2) : '$0.00';
        const peak = risk.peak_equity ?? perf.peak_equity;
        document.getElementById('p_peak').textContent = peak != null ? '$' + Number(peak).toFixed(2) : '--';

    } catch(e) {
        console.error('Status refresh failed:', e);
    }
}

// ============================================================
// æ—¥å¿—
// ============================================================
let _autoLogInterval = null;

async function refreshLogs() {
    try {
        const data = await apiCall('/api/live/logs?lines=150');
        if (data.success) {
            const el = document.getElementById('logOutput');
            // ç€è‰²
            let html = (data.logs || 'æš‚æ— æ—¥å¿—')
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/^(.*\[TRADE\].*)$/gm, '<span class="line-ok">$1</span>')
                .replace(/^(.*\[RISK\].*)$/gm, '<span class="line-warn">$1</span>')
                .replace(/^(.*\[ERROR\].*)$/gm, '<span class="line-err">$1</span>')
                .replace(/^(.*\[SIGNAL\].*)$/gm, '<span class="line-info">$1</span>');
            el.innerHTML = html;
            el.scrollTop = el.scrollHeight;
            document.getElementById('logFile').textContent = data.file
                ? 'æ—¥å¿—æ–‡ä»¶: ' + data.file + ' (' + data.total_lines + ' è¡Œ)'
                : '';
        }
    } catch(e) {
        document.getElementById('logOutput').textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
    }
}

function autoRefreshLogs() {
    if (_autoLogInterval) {
        clearInterval(_autoLogInterval);
        _autoLogInterval = null;
        document.getElementById('autoLogBtn').textContent = 'è‡ªåŠ¨åˆ·æ–°: å…³';
    } else {
        refreshLogs();
        _autoLogInterval = setInterval(refreshLogs, 5000);
        document.getElementById('autoLogBtn').textContent = 'è‡ªåŠ¨åˆ·æ–°: å¼€';
    }
}

// åˆå§‹åŠ è½½çŠ¶æ€
refreshStatus();
setInterval(refreshStatus, 30000); // æ¯30ç§’åˆ·æ–°çŠ¶æ€
</script>
{% endblock %}
