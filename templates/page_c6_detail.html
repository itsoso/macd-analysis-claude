{% extends "base.html" %}
{% block title %}C6策略代码详解 - 技术分析平台{% endblock %}

{% block content %}
<div class="page-title">C6: 激进融合做空 — 代码实现详解</div>
<div class="page-subtitle">《背离技术分析》× 《均线技术分析》 双书信号加权融合 · 高杠杆做空 · 完整代码逻辑拆解</div>

<!-- 策略概览 -->
<div class="card">
    <div class="card-title">策略概览</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px">
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px;text-align:center;border-top:3px solid var(--accent-green)">
            <div style="font-size:32px;font-weight:700;color:var(--accent-green)" id="c6-alpha">-</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">超额收益 Alpha</div>
        </div>
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px;text-align:center;border-top:3px solid var(--accent-blue)">
            <div style="font-size:32px;font-weight:700;color:var(--accent-blue)" id="c6-trades">-</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">交易次数</div>
        </div>
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px;text-align:center;border-top:3px solid var(--accent-yellow)">
            <div style="font-size:32px;font-weight:700;color:var(--accent-yellow)" id="c6-drawdown">-</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">最大回撤</div>
        </div>
    </div>
</div>

<!-- 1. 策略核心思想 -->
<div class="card">
    <div class="card-title"><span class="badge purple">1</span> 核心思想: 两套信号系统的加权融合</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px;border-left:4px solid var(--accent-red)">
            <div style="font-weight:700;color:var(--accent-red);margin-bottom:10px">信号源A: 背离技术分析 (权重70%)</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:1.8">
                <b>顶部信号 (TS):</b><br>
                · MACD隔堆背离 → +18~30分<br>
                · 面积背离 → +12分<br>
                · DIF背离 → +8分<br>
                · 背驰信号 → +18分<br>
                · 零轴回归 → +10分<br>
                · 下跌趋势加成 → ×1.3<br>
                <br>
                <b>底部信号 (BS):</b><br>
                · 隔堆底背离 → +15~30分<br>
                · 背驰买入 → +18分<br>
                · 面积底背离 → +10分<br>
                · 上升趋势加成 → ×1.2
            </div>
        </div>
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px;border-left:4px solid var(--accent-blue)">
            <div style="font-weight:700;color:var(--accent-blue);margin-bottom:10px">信号源B: 均线技术分析 (权重30%)</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:1.8">
                <b>卖出信号 (SS):</b><br>
                · 葛南维法则5~8 → 卖出评分<br>
                · 死叉(MA5<MA10) → +15分<br>
                · 空头排列(MA5<MA10<MA20) → +20分<br>
                · 死亡谷/逐浪下降 → +10~15分<br>
                <br>
                <b>买入信号 (BS):</b><br>
                · 葛南维法则1~4 → 买入评分<br>
                · 金叉(MA5>MA10) → +15分<br>
                · 多头排列(MA5>MA10>MA20) → +20分<br>
                · 银山谷/金山谷 → +10~15分
            </div>
        </div>
    </div>
    <div style="background:var(--bg-secondary);border-radius:12px;padding:20px;border-left:4px solid var(--accent-purple)">
        <div style="font-weight:700;color:var(--accent-purple);margin-bottom:8px">融合公式</div>
        <div style="font-size:14px;font-family:'JetBrains Mono',monospace;color:var(--accent-yellow);line-height:2">
            sell_score = 背离TS × <span style="color:var(--accent-red)">0.7</span> + 均线SS × <span style="color:var(--accent-blue)">0.3</span><br>
            buy_score  = 背离BS × <span style="color:var(--accent-red)">0.7</span> + 均线BS × <span style="color:var(--accent-blue)">0.3</span>
        </div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:8px">
            C6策略偏向背离系统(70%)，因为背离更擅长捕捉拐点。均线(30%)提供趋势方向确认和排列加成。
        </div>
    </div>
</div>

<!-- 2. 参数配置 -->
<div class="card">
    <div class="card-title"><span class="badge red">2</span> 参数配置</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        <div style="background:var(--bg-secondary);border-radius:10px;padding:16px">
            <div style="font-weight:600;color:var(--accent-blue);margin-bottom:10px;font-size:14px">信号阈值</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:2">
                <code>sell_threshold</code> = <span style="color:var(--accent-yellow)">18</span> <span style="color:var(--text-muted)">(低阈值, 更多卖出)</span><br>
                <code>short_threshold</code> = <span style="color:var(--accent-yellow)">25</span> <span style="color:var(--text-muted)">(较低, 更多做空)</span><br>
                <code>buy_threshold</code> = <span style="color:var(--accent-yellow)">25</span><br>
                <code>long_threshold</code> = <span style="color:var(--accent-yellow)">40</span> <span style="color:var(--text-muted)">(高阈值, 少做多)</span>
            </div>
        </div>
        <div style="background:var(--bg-secondary);border-radius:10px;padding:16px">
            <div style="font-weight:600;color:var(--accent-red);margin-bottom:10px;font-size:14px">仓位与杠杆</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:2">
                <code>lev</code> = <span style="color:var(--accent-yellow)">5</span> <span style="color:var(--text-muted)">(最大5倍杠杆)</span><br>
                <code>margin_use</code> = <span style="color:var(--accent-yellow)">70%</span> <span style="color:var(--text-muted)">(可用保证金70%)</span><br>
                <code>sell_pct</code> = <span style="color:var(--accent-yellow)">55%</span> <span style="color:var(--text-muted)">(每次卖出55%ETH)</span><br>
                <code>single_pct</code> = <span style="color:var(--accent-yellow)">20%</span> <span style="color:var(--text-muted)">(单笔最大总资产20%)</span>
            </div>
        </div>
        <div style="background:var(--bg-secondary);border-radius:10px;padding:16px">
            <div style="font-weight:600;color:var(--accent-green);margin-bottom:10px;font-size:14px">风控参数</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:2">
                <code>short_sl</code> = <span style="color:var(--accent-red)">-30%</span> <span style="color:var(--text-muted)">(空仓止损)</span><br>
                <code>short_tp</code> = <span style="color:var(--accent-green)">+80%</span> <span style="color:var(--text-muted)">(空仓止盈)</span><br>
                <code>short_trail</code> = <span style="color:var(--accent-yellow)">25%</span> <span style="color:var(--text-muted)">(追踪止盈起点)</span><br>
                <code>short_max_hold</code> = <span style="color:var(--accent-yellow)">72h</span> <span style="color:var(--text-muted)">(最大持仓时间)</span>
            </div>
        </div>
    </div>
</div>

<!-- 3. 核心代码: 融合信号计算 -->
<div class="card">
    <div class="card-title"><span class="badge green">3</span> 核心代码: 融合信号计算</div>
    <div class="code-section">
        <div class="code-header"><span class="code-file">combined_strategy.py</span> calc_combined_signals()</div>
        <pre><code><span class="kw">def</span> <span class="fn">calc_combined_signals</span>(data, div_signals_1h, div_signals_8h, ma_signals, dt, idx, config):
    <span class="cm">"""计算融合信号: 背离系统 × 均线系统"""</span>

    <span class="cm"># ---- 步骤1: 获取背离信号 ----</span>
    sig_1h = get_signal_at(div_signals_1h, dt) <span class="kw">or</span> dict(DEFAULT_SIG)
    sig_8h = get_signal_at(div_signals_8h, dt) <span class="kw">or</span> dict(DEFAULT_SIG)

    <span class="cm"># 多周期融合: 1h为主(权重1.0), 8h为辅(权重0.5)</span>
    merged_div = dict(DEFAULT_SIG)
    <span class="kw">for</span> sig_src, w <span class="kw">in</span> [(sig_1h, <span class="nu">1.0</span>), (sig_8h, <span class="nu">0.5</span>)]:
        merged_div[<span class="st">'top'</span>] += sig_src.get(<span class="st">'top'</span>, <span class="nu">0</span>) * w
        merged_div[<span class="st">'bottom'</span>] += sig_src.get(<span class="st">'bottom'</span>, <span class="nu">0</span>) * w

    <span class="cm"># 使用书中方法计算顶部/底部评分</span>
    div_ts, div_parts = _calc_top_score(merged_div, trend)   <span class="cm"># 背离顶部分数</span>
    div_bs = _calc_bottom_score(merged_div, trend)            <span class="cm"># 背离底部分数</span>

    <span class="cm"># ---- 步骤2: 获取均线信号 ----</span>
    ma_buy  = ma_signals[<span class="st">'buy_score'</span>].iloc[idx]    <span class="cm"># 均线买入评分</span>
    ma_sell = ma_signals[<span class="st">'sell_score'</span>].iloc[idx]   <span class="cm"># 均线卖出评分</span>
    ma_arr  = ma_signals[<span class="st">'arrangement'</span>].iloc[idx]  <span class="cm"># 多头/空头排列</span>

    <span class="cm"># ---- 步骤3: C6使用加权融合模式(weighted) ----</span>
    div_w = config[<span class="st">'div_weight'</span>]   <span class="cm"># 0.7 — 背离权重</span>
    ma_w  = config[<span class="st">'ma_weight'</span>]    <span class="cm"># 0.3 — 均线权重</span>

    <span class="cm"># 核心公式: 两个系统的分数按权重叠加</span>
    sell_score = div_ts * div_w + ma_sell * ma_w
    buy_score  = div_bs * div_w + ma_buy  * ma_w

    <span class="cm"># ---- 步骤4: 均线排列加成 ----</span>
    <span class="kw">if</span> ma_arr == <span class="st">'bearish'</span>:       <span class="cm"># 空头排列: 卖出信号 ×1.1</span>
        sell_score *= <span class="nu">1.1</span>
    <span class="kw">elif</span> ma_arr == <span class="st">'bullish'</span>:     <span class="cm"># 多头排列: 买入信号 ×1.1</span>
        buy_score *= <span class="nu">1.1</span>

    <span class="kw">return</span> sell_score, buy_score, reasons_sell, reasons_buy</code></pre>
    </div>
</div>

<!-- 4. 核心代码: 交易执行逻辑 -->
<div class="card">
    <div class="card-title"><span class="badge yellow">4</span> 核心代码: 交易执行逻辑</div>

    <div style="margin-bottom:16px;padding:16px;background:var(--bg-secondary);border-radius:10px;border-left:3px solid var(--accent-blue)">
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.8">
            <b style="color:var(--accent-blue)">执行顺序:</b>
            冲突检测 → 卖出现货 → 开空仓 → 管理空仓(止盈/止损/追踪/超时) → 买入现货 → 开多仓 → 管理多仓
        </div>
    </div>

    <div class="code-section">
        <div class="code-header"><span class="code-file">combined_strategy.py</span> run_combined_strategy() — 卖出与做空</div>
        <pre><code><span class="cm"># ===== 冲突检测: 避免多空信号同时触发 =====</span>
<span class="kw">if</span> ss > <span class="nu">0</span> <span class="kw">and</span> bs > <span class="nu">0</span>:
    ratio = min(ss, bs) / max(ss, bs)
    in_conflict = ratio >= <span class="nu">0.6</span> <span class="kw">and</span> min(ss, bs) >= <span class="nu">15</span>
    <span class="cm"># 仅当两信号强度接近(比例>60%)且都超过15分时才视为冲突</span>

<span class="cm"># ===== 卖出现货 =====</span>
<span class="kw">if</span> ss >= sell_threshold <span class="kw">and</span> spot_cd == <span class="nu">0</span> <span class="kw">and not</span> in_conflict:
    eng.spot_sell(price, dt, <span class="nu">0.55</span>,       <span class="cm"># 每次卖出55%持仓</span>
                  f<span class="st">"卖出 {reasons}"</span>)
    spot_cd = <span class="nu">12</span>                           <span class="cm"># 12小时冷却期</span>

<span class="cm"># ===== 开空仓 =====</span>
sell_dom = (ss > bs * <span class="nu">1.5</span>)              <span class="cm"># 卖出信号必须主导(>买入的1.5倍)</span>
<span class="kw">if</span> ss >= short_threshold <span class="kw">and not</span> eng.futures_short <span class="kw">and</span> sell_dom:
    margin = eng.available_margin() * <span class="nu">0.70</span>   <span class="cm"># 用70%可用保证金</span>

    <span class="cm"># 动态杠杆: 信号越强, 杠杆越高</span>
    <span class="kw">if</span> ss >= <span class="nu">50</span>:   actual_lev = <span class="nu">5</span>         <span class="cm"># 强信号: 5x</span>
    <span class="kw">elif</span> ss >= <span class="nu">35</span>: actual_lev = <span class="nu">3</span>         <span class="cm"># 中等信号: 3x</span>
    <span class="kw">else</span>:          actual_lev = <span class="nu">2</span>         <span class="cm"># 弱信号: 2x</span>

    eng.open_short(price, dt, margin, actual_lev)</code></pre>
    </div>

    <div class="code-section">
        <div class="code-header"><span class="code-file">combined_strategy.py</span> run_combined_strategy() — 空仓风控</div>
        <pre><code><span class="cm"># ===== 空仓管理: 4层风控 =====</span>
<span class="kw">if</span> eng.futures_short <span class="kw">and not</span> short_just_opened:
    pnl_r = eng.futures_short.calc_pnl(price) / eng.futures_short.margin

    <span class="cm"># 第1层: 止盈 — 利润达到80%</span>
    <span class="kw">if</span> pnl_r >= <span class="nu">0.80</span>:
        eng.close_short(price, dt, <span class="st">"止盈"</span>)

    <span class="cm"># 第2层: 追踪止盈 — 利润曾达25%, 回撤40%则平仓</span>
    <span class="kw">if</span> pnl_r > short_max_pnl: short_max_pnl = pnl_r
    <span class="kw">if</span> short_max_pnl >= <span class="nu">0.25</span> <span class="kw">and</span> pnl_r < short_max_pnl * <span class="nu">0.60</span>:
        eng.close_short(price, dt, <span class="st">f"追踪止盈 max={short_max_pnl*100:.0f}%"</span>)

    <span class="cm"># 第3层: 反向信号平仓 — 买入信号主导时平空</span>
    <span class="kw">if</span> bs >= <span class="nu">40</span> <span class="kw">and</span> ss < bs * <span class="nu">0.7</span>:
        eng.close_short(price, dt, <span class="st">"买信号平空"</span>)

    <span class="cm"># 第4层: 止损 — 亏损达到30%</span>
    <span class="kw">if</span> pnl_r < -<span class="nu">0.30</span>:
        eng.close_short(price, dt, <span class="st">"止损"</span>)

    <span class="cm"># 第5层: 超时 — 持仓超过72小时</span>
    <span class="kw">if</span> short_bars >= <span class="nu">72</span>:
        eng.close_short(price, dt, <span class="st">"超时"</span>)</code></pre>
    </div>
</div>

<!-- 5. 信号源详解 -->
<div class="card">
    <div class="card-title"><span class="badge">5</span> 信号源详解: 背离系统评分</div>
    <div class="code-section">
        <div class="code-header"><span class="code-file">strategy_futures_v4.py</span> _calc_top_score() — 顶部背离评分</div>
        <pre><code><span class="kw">def</span> <span class="fn">_calc_top_score</span>(sig, trend):
    <span class="cm">"""计算顶部综合评分 — 融合MACD+KDJ+CCI+RSI+量价"""</span>
    score = <span class="nu">0</span>

    <span class="cm"># MACD背离(最重要的信号)</span>
    <span class="kw">if</span> sig.get(<span class="st">'sep_divs_top'</span>) >= <span class="nu">2</span>:     <span class="cm"># 双隔堆背离</span>
        score += <span class="nu">30</span>
    <span class="kw">elif</span> sig.get(<span class="st">'sep_divs_top'</span>) >= <span class="nu">1</span>:    <span class="cm"># 单隔堆背离</span>
        score += <span class="nu">18</span>

    <span class="kw">if</span> sig.get(<span class="st">'area_top_div'</span>) >= <span class="nu">1</span>:       <span class="cm"># MACD面积背离</span>
        score += <span class="nu">12</span>
    <span class="kw">if</span> sig.get(<span class="st">'dif_top_div'</span>) >= <span class="nu">1</span>:        <span class="cm"># DIF线背离</span>
        score += <span class="nu">8</span>

    <span class="cm"># 背驰(技术分析核心概念)</span>
    <span class="kw">if</span> sig.get(<span class="st">'exhaust_sell'</span>):             <span class="cm"># 卖出背驰信号</span>
        score += <span class="nu">18</span>

    <span class="cm"># 零轴回归</span>
    <span class="kw">if</span> sig.get(<span class="st">'zero_returns_top'</span>) >= <span class="nu">1</span>:
        score += <span class="nu">10</span>

    <span class="cm"># 趋势加成: 已在下跌趋势中 → 信号更可信</span>
    <span class="kw">if</span> trend[<span class="st">'is_downtrend'</span>]:
        score = <span class="kw">int</span>(score * <span class="nu">1.3</span>)

    <span class="kw">return</span> score, parts</code></pre>
    </div>
</div>

<!-- 6. 信号源详解: 均线系统 -->
<div class="card">
    <div class="card-title"><span class="badge green">6</span> 信号源详解: 均线系统评分</div>
    <div class="code-section">
        <div class="code-header"><span class="code-file">ma_indicators.py</span> compute_ma_signals() — 均线综合评分</div>
        <pre><code><span class="kw">def</span> <span class="fn">compute_ma_signals</span>(df, timeframe=<span class="st">'1h'</span>):
    <span class="cm">"""综合均线信号分析 — 葛南维+排列+交叉+形态"""</span>

    <span class="cm"># 1. 葛南维八大买卖法则</span>
    gran = granville_rules(df, ma_col=<span class="st">'MA20'</span>)
    buy_score  += gran[<span class="st">'buy_strength'</span>] * <span class="nu">0.4</span>    <span class="cm"># 权重40%</span>
    sell_score += gran[<span class="st">'sell_strength'</span>] * <span class="nu">0.4</span>

    <span class="cm"># 2. 均线排列</span>
    <span class="kw">if</span> arr == <span class="st">'bearish'</span>:     <span class="cm"># 空头排列: MA5 < MA10 < MA20</span>
        sell_score += <span class="nu">20</span>
    <span class="kw">elif</span> arr == <span class="st">'bullish'</span>:   <span class="cm"># 多头排列: MA5 > MA10 > MA20</span>
        buy_score += <span class="nu">20</span>

    <span class="cm"># 3. 金叉/死叉</span>
    <span class="kw">if</span> death_cross:    sell_score += <span class="nu">15</span>
    <span class="kw">if</span> golden_cross:   buy_score += <span class="nu">15</span>

    <span class="cm"># 4. 特殊形态(17种)</span>
    <span class="kw">if</span> death_valley:   sell_score += <span class="nu">15</span>   <span class="cm"># 死亡谷</span>
    <span class="kw">if</span> silver_valley:  buy_score += <span class="nu">10</span>    <span class="cm"># 银山谷</span>
    <span class="kw">if</span> gold_valley:    buy_score += <span class="nu">15</span>    <span class="cm"># 金山谷</span>
    <span class="cm"># ... 蛟龙出海、烘云托月、逐浪上升/下降 等</span>

    <span class="kw">return</span> {<span class="st">'buy_score'</span>: buy_score, <span class="st">'sell_score'</span>: sell_score, ...}</code></pre>
    </div>
</div>

<!-- 7. 趋势判断 -->
<div class="card">
    <div class="card-title"><span class="badge red">7</span> 融合趋势判断</div>
    <div class="code-section">
        <div class="code-header"><span class="code-file">combined_strategy.py</span> get_combined_trend()</div>
        <pre><code><span class="kw">def</span> <span class="fn">get_combined_trend</span>(data, dt, price):
    <span class="cm">"""融合均线和价格的趋势判断"""</span>

    <span class="cm"># 1. MA排列方向</span>
    <span class="kw">if</span> ma5 > ma10 > ma20:
        trend[<span class="st">'ma_bullish'</span>] = <span class="kw">True</span>     <span class="cm"># 多头排列</span>
    <span class="kw">elif</span> ma5 < ma10 < ma20:
        trend[<span class="st">'ma_bearish'</span>] = <span class="kw">True</span>     <span class="cm"># 空头排列</span>

    <span class="cm"># 2. MA20斜率(5根K线)</span>
    slope_pct = (ma20_now - ma20_prev) / ma20_prev * <span class="nu">100</span>
    <span class="kw">if</span> slope_pct < -<span class="nu">0.3</span>:
        trend[<span class="st">'ma_slope_down'</span>] = <span class="kw">True</span>    <span class="cm"># 均线下行</span>

    <span class="cm"># 3. 短期价格趋势(5日均 vs 20日均)</span>
    close_5 = df[<span class="st">'close'</span>].iloc[-<span class="nu">5</span>:].mean()
    close_20 = df[<span class="st">'close'</span>].iloc[-<span class="nu">20</span>:].mean()
    <span class="kw">if</span> close_5 < close_20 * <span class="nu">0.99</span>:
        trend[<span class="st">'is_downtrend'</span>] = <span class="kw">True</span>     <span class="cm"># 下跌趋势</span>

    <span class="kw">return</span> trend</code></pre>
    </div>
</div>

<!-- 8. C6为什么是最佳 -->
<div class="card">
    <div class="card-title"><span class="badge purple">8</span> C6为什么是最佳策略?</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px">
            <div style="font-weight:700;color:var(--accent-green);margin-bottom:10px">优势</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:2">
                1. <b>信号互补:</b> 背离捕捉拐点 + 均线确认趋势方向<br>
                2. <b>偏重背离(70%):</b> 在下跌行情中, 背离更善于提前预判顶部<br>
                3. <b>低卖出阈值(18):</b> 积极卖出现货, 减少持仓风险<br>
                4. <b>高杠杆做空(5x):</b> 信号强时放大空头收益<br>
                5. <b>动态杠杆:</b> 信号强度决定杠杆倍数(2x/3x/5x)<br>
                6. <b>不对称阈值:</b> 做空阈值(25)远低于做多阈值(40), 偏向做空
            </div>
        </div>
        <div style="background:var(--bg-secondary);border-radius:12px;padding:20px">
            <div style="font-weight:700;color:var(--accent-red);margin-bottom:10px">风险控制</div>
            <div style="font-size:13px;color:var(--text-secondary);line-height:2">
                1. <b>止损-30%:</b> 单笔最大亏损30%保证金<br>
                2. <b>追踪止盈:</b> 利润达25%后回撤40%自动平仓<br>
                3. <b>超时72h:</b> 不长期持有合约<br>
                4. <b>保证金上限20%:</b> 单笔不超过总资产20%<br>
                5. <b>冲突过滤:</b> 多空信号同时出现时不操作<br>
                6. <b>冷却期:</b> 合约4h、现货12h冷却期避免过度交易
            </div>
        </div>
    </div>
</div>

<!-- 9. 交易记录 -->
<div class="card">
    <div class="card-header">
        <h3>C6 交易记录</h3>
        <span class="badge green" id="c6-trade-count">-</span>
    </div>
    <div style="overflow-x:auto;max-height:500px;overflow-y:auto">
        <table class="data-table" style="font-size:12px">
            <thead>
                <tr>
                    <th>时间</th><th>操作</th><th>价格</th>
                    <th>杠杆</th><th>总资产</th><th>原因</th>
                </tr>
            </thead>
            <tbody id="c6-trades-body"></tbody>
        </table>
    </div>
</div>

<!-- 10. 完整策略配置 -->
<div class="card">
    <div class="card-title"><span class="badge">9</span> 完整策略配置字典</div>
    <div class="code-section">
        <div class="code-header"><span class="code-file">combined_strategy.py</span> get_strategies() — C6配置</div>
        <pre><code><span class="cm"># C6: 激进融合做空 — 加权融合 + 高杠杆 + 低阈值</span>
{
    <span class="st">'name'</span>: <span class="st">'C6: 激进融合做空'</span>,
    <span class="st">'fusion_mode'</span>: <span class="st">'weighted'</span>,          <span class="cm"># 加权融合模式</span>
    <span class="st">'div_weight'</span>: <span class="nu">0.7</span>,                  <span class="cm"># 背离系统权重70%</span>
    <span class="st">'ma_weight'</span>: <span class="nu">0.3</span>,                   <span class="cm"># 均线系统权重30%</span>
    <span class="st">'sell_threshold'</span>: <span class="nu">18</span>,               <span class="cm"># 现货卖出阈值(低→积极卖出)</span>
    <span class="st">'short_threshold'</span>: <span class="nu">25</span>,              <span class="cm"># 做空开仓阈值(低→更多做空)</span>
    <span class="st">'buy_threshold'</span>: <span class="nu">25</span>,                <span class="cm"># 现货买入阈值</span>
    <span class="st">'long_threshold'</span>: <span class="nu">40</span>,               <span class="cm"># 做多开仓阈值(高→少做多)</span>
    <span class="st">'lev'</span>: <span class="nu">5</span>,                             <span class="cm"># 最大杠杆倍数</span>
    <span class="st">'max_lev'</span>: <span class="nu">5</span>,                         <span class="cm"># 引擎最大杠杆限制</span>
    <span class="st">'margin_use'</span>: <span class="nu">0.70</span>,                 <span class="cm"># 可用保证金使用比例</span>
    <span class="st">'single_pct'</span>: <span class="nu">0.20</span>,                 <span class="cm"># 单笔最大保证金占比</span>
    <span class="st">'total_pct'</span>: <span class="nu">0.50</span>,                  <span class="cm"># 总保证金上限</span>
    <span class="st">'sell_pct'</span>: <span class="nu">0.55</span>,                   <span class="cm"># 每次卖出ETH比例</span>
    <span class="st">'short_sl'</span>: -<span class="nu">0.30</span>,                  <span class="cm"># 空仓止损-30%</span>
    <span class="st">'short_tp'</span>: <span class="nu">0.80</span>,                   <span class="cm"># 空仓止盈+80%</span>
    <span class="st">'short_trail'</span>: <span class="nu">0.25</span>,                <span class="cm"># 追踪止盈触发点</span>
    <span class="st">'short_max_hold'</span>: <span class="nu">72</span>,               <span class="cm"># 最大持仓72小时</span>
    <span class="st">'cooldown'</span>: <span class="nu">4</span>,                       <span class="cm"># 合约冷却4小时</span>
    <span class="st">'spot_cooldown'</span>: <span class="nu">12</span>,                <span class="cm"># 现货冷却12小时</span>
}</code></pre>
    </div>
</div>

<script>
async function loadC6Data() {
    try {
        const res = await fetch('/api/combined_strategy');
        if (!res.ok) return;
        const data = await res.json();
        const results = data.results || [];
        const c6 = results.find(r => (r.name||'').includes('C6'));
        if (!c6) return;

        document.getElementById('c6-alpha').textContent = (c6.alpha > 0 ? '+' : '') + c6.alpha.toFixed(2) + '%';
        document.getElementById('c6-trades').textContent = c6.total_trades || 0;
        document.getElementById('c6-drawdown').textContent = (c6.max_drawdown || 0).toFixed(2) + '%';

        const trades = c6.trades || [];
        document.getElementById('c6-trade-count').textContent = trades.length + '笔';
        const tbody = document.getElementById('c6-trades-body');
        tbody.innerHTML = trades.map(t => {
            const action = t.action || '';
            const ac = action.includes('SELL') || action.includes('SHORT') ? 'var(--accent-red)' :
                        action.includes('BUY') || action.includes('LONG') ? 'var(--accent-green)' : 'var(--text-secondary)';
            return `<tr>
                <td style="font-size:11px">${(t.time||'').toString().substring(0,16)}</td>
                <td style="color:${ac};font-weight:600">${action}</td>
                <td>$${(t.price||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                <td>${t.leverage||1}x</td>
                <td>$${(t.total||0).toLocaleString()}</td>
                <td style="font-size:11px;color:var(--text-muted);max-width:350px;overflow:hidden;text-overflow:ellipsis">${t.reason||''}</td>
            </tr>`;
        }).join('');
    } catch(e) {
        console.error('加载C6数据失败:', e);
    }
}
loadC6Data();
</script>
{% endblock %}
