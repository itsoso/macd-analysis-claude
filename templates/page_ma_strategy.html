{% extends "base.html" %}
{% block title %}ma-strategy - 技术分析平台{% endblock %}

{% block content %}
            <div class="page-title">均线技术分析</div>
            <div class="page-subtitle">《均线技术分析》邱立波著 · 葛南维八大法则 + 均线排列 + 17种特殊形态 · ETH/USDT回测</div>

            <div id="ma-loading" class="loading">
                <div class="spinner"></div>
                正在加载均线策略数据...
            </div>

            <div id="ma-content" style="display:none;">
                <!-- 书籍大纲 -->
                <div class="card" id="ma-outline">
                    <div class="card-title">书籍大纲
                        <span class="badge" style="background:rgba(59,130,246,0.15);color:#3b82f6;">4章 · 364页</span>
                    </div>
                    <div id="ma-outline-content"></div>
                </div>

                <!-- 信号统计 -->
                <div class="card" id="ma-signal-stats">
                    <div class="card-title">信号统计
                        <span class="badge" style="background:rgba(168,85,247,0.15);color:#a855f7;">SIGNAL ANALYSIS</span>
                    </div>
                    <div id="ma-signal-content"></div>
                </div>

                <!-- 策略卡片 -->
                <div class="card">
                    <div class="card-title" id="ma-strat-title">8种均线策略对比</div>
                    <div style="background:rgba(59,130,246,0.06);border-radius:8px;padding:14px 18px;margin-bottom:16px;border-left:3px solid #3b82f6;">
                        <div style="font-weight:600;color:#3b82f6;margin-bottom:6px;">策略说明</div>
                        <div style="font-size:13px;color:var(--text-secondary);line-height:1.7;" id="ma-desc"></div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:16px;" id="ma-cards"></div>
                </div>

                <!-- Alpha对比图 -->
                <div class="card">
                    <div class="card-title">策略Alpha对比</div>
                    <div id="ma-alpha-chart" style="height:300px;"></div>
                </div>

                <!-- 策略详情表格 -->
                <div class="card">
                    <div class="card-title">策略详细对比</div>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="ma-table">
                            <thead><tr>
                                <th>排名</th><th>策略</th><th>α%</th>
                                <th>策略收益</th><th>BH收益</th><th>最大回撤</th>
                                <th>交易数</th><th>强平</th><th>总费用</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- 最佳策略交易明细 -->
                <div class="card">
                    <div class="card-title" id="ma-best-title">最佳策略交易明细</div>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="ma-trades-table">
                            <thead><tr>
                                <th>时间</th><th>操作</th><th>方向</th>
                                <th>价格</th><th>杠杆</th><th>总资产</th><th>原因</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- 结论 -->
                <div class="card" id="ma-conclusion"></div>
            </div>
{% endblock %}

{% block scripts %}
<script>
const INTERVALS = ['10m','15m','30m','1h','2h','3h','4h','6h','8h','16h','24h','32h'];
const INTERVAL_LABELS = {'10m':'10分钟','15m':'15分钟','30m':'30分钟','1h':'1小时','2h':'2小时','3h':'3小时','4h':'4小时','6h':'6小时','8h':'8小时','16h':'16小时','24h':'24小时','32h':'32小时'};
const COLORS = ['#4a9eff','#ff4d6a','#00d68f','#ffaa00','#a855f7','#06b6d4','#f43f5e','#84cc16','#ec4899','#f97316','#8b5cf6','#14b8a6'];
function fmtDate(d) { return d ? d.toString().substring(0,16) : ''; }

    // ===================== 均线技术分析 =====================
    async function loadMAStrategy() {
        try {
            const res = await fetch('/api/ma_strategy');
            if (res.ok) {
                window._maLoaded = true;
                renderMAStrategy(await res.json());
            } else {
                document.getElementById('ma-loading').innerHTML = '<p style="color:var(--accent-red);">均线策略数据未找到, 请先运行 python ma_strategy.py</p>';
            }
        } catch(e) {
            document.getElementById('ma-loading').innerHTML = `<p style="color:var(--accent-red);">加载失败: ${e.message}</p>`;
        }
    }

    function renderMAStrategy(data) {
        document.getElementById('ma-loading').style.display = 'none';
        document.getElementById('ma-content').style.display = 'block';

        const results = data.results || [];
        const ranked = [...results].sort((a, b) => b.alpha - a.alpha);
        const best = ranked[0] || {};
        const stats = data.signal_stats || {};
        const outline = data.book_outline || {};

        // 标题更新
        const titleEl = document.getElementById('ma-strat-title');
        if (titleEl) titleEl.textContent = `8种均线策略对比 · ${data.trade_days || 7}天`;

        const descEl = document.getElementById('ma-desc');
        if (descEl) {
            descEl.innerHTML = `主信号: 1h K线 (${data.total_bars || '?'}根) · 均线: SMA5/10/20/30/60/120/240<br>
                交易区间: ${data.trade_range || ''}<br>
                方向: 买入信号→买入现货+开多 | 卖出信号→卖出现货+开空<br>
                初始: ${data.initial_capital || '10万USDT + 价值10万USDT的ETH'}`;
        }

        // 书籍大纲
        const outlineEl = document.getElementById('ma-outline-content');
        if (outlineEl && outline.chapters) {
            const chapterColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444'];
            outlineEl.innerHTML = outline.chapters.map((ch, i) => `
                <div style="margin-bottom:16px;">
                    <div style="font-weight:700;color:${chapterColors[i % 4]};font-size:15px;margin-bottom:8px;">${ch.chapter}</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px;">
                        ${ch.sections.map(s => `<div style="background:var(--bg-hover);border-radius:6px;padding:8px 12px;font-size:13px;color:var(--text-secondary);border-left:3px solid ${chapterColors[i % 4]}30;">${s}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 信号统计
        const sigEl = document.getElementById('ma-signal-content');
        if (sigEl && stats.buy_signals) {
            const bs = stats.buy_signals;
            const ss = stats.sell_signals;
            const arr = stats.arrangement || {};
            const gran = stats.granville || {};
            const buyRules = (gran.rule_1||0)+(gran.rule_2||0)+(gran.rule_3||0)+(gran.rule_4||0);
            const sellRules = (gran.rule_5||0)+(gran.rule_6||0)+(gran.rule_7||0)+(gran.rule_8||0);
            sigEl.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                    <div style="background:rgba(34,197,94,0.08);border-radius:8px;padding:14px;">
                        <div style="font-size:12px;color:var(--text-muted);">买入信号</div>
                        <div style="font-size:24px;font-weight:700;color:#22c55e;">${bs.count_gt_15}</div>
                        <div style="font-size:12px;color:var(--text-muted);">强信号(>30): ${bs.count_gt_30} | 极强(>50): ${bs.count_gt_50}</div>
                    </div>
                    <div style="background:rgba(239,68,68,0.08);border-radius:8px;padding:14px;">
                        <div style="font-size:12px;color:var(--text-muted);">卖出信号</div>
                        <div style="font-size:24px;font-weight:700;color:#ef4444;">${ss.count_gt_15}</div>
                        <div style="font-size:12px;color:var(--text-muted);">强信号(>30): ${ss.count_gt_30} | 极强(>50): ${ss.count_gt_50}</div>
                    </div>
                    <div style="background:rgba(59,130,246,0.08);border-radius:8px;padding:14px;">
                        <div style="font-size:12px;color:var(--text-muted);">均线排列</div>
                        <div style="font-size:14px;margin-top:6px;">
                            <span style="color:#22c55e;">多头 ${arr.bullish_pct?.toFixed(1)||0}%</span> ·
                            <span style="color:#ef4444;">空头 ${arr.bearish_pct?.toFixed(1)||0}%</span> ·
                            <span style="color:var(--text-muted);">混合 ${arr.mixed_pct?.toFixed(1)||0}%</span>
                        </div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border-radius:8px;padding:14px;">
                        <div style="font-size:12px;color:var(--text-muted);">葛南维法则</div>
                        <div style="font-size:14px;margin-top:6px;">
                            <span style="color:#22c55e;">买入 ${buyRules}次</span> ·
                            <span style="color:#ef4444;">卖出 ${sellRules}次</span>
                        </div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">
                            法则1-4(买): ${gran.rule_1||0}/${gran.rule_2||0}/${gran.rule_3||0}/${gran.rule_4||0} |
                            法则5-8(卖): ${gran.rule_5||0}/${gran.rule_6||0}/${gran.rule_7||0}/${gran.rule_8||0}
                        </div>
                    </div>
                </div>
            `;
        }

        // 策略卡片
        const cardsEl = document.getElementById('ma-cards');
        if (cardsEl) {
            const colors = ['#3b82f6', '#22c55e', '#a855f7', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#6b7280'];
            cardsEl.innerHTML = ranked.map((r, i) => {
                const isBest = i === 0;
                const c = colors[i % colors.length];
                return `<div style="background:var(--bg-hover);border-radius:10px;padding:14px;${isBest ? 'border:1.5px solid #22c55e;' : ''}">
                    <div style="font-weight:700;font-size:14px;color:${c};margin-bottom:4px;">${r.name}${isBest ? ' ★' : ''}</div>
                    <div style="display:flex;gap:12px;font-size:13px;flex-wrap:wrap;">
                        <span style="color:${r.alpha > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${r.alpha > 0 ? '+' : ''}${r.alpha.toFixed(2)}% α</span>
                        <span style="color:var(--text-muted);">${r.max_drawdown.toFixed(1)}% DD</span>
                        <span style="color:var(--text-muted);">${r.total_trades}笔</span>
                    </div>
                </div>`;
            }).join('');
        }

        // Alpha对比柱状图
        const chartEl = document.getElementById('ma-alpha-chart');
        if (chartEl && ranked.length > 0) {
            chartEl.innerHTML = '';
            const maxAlpha = Math.max(...ranked.map(r => Math.abs(r.alpha)), 1);
            chartEl.innerHTML = `<div style="display:flex;align-items:flex-end;gap:12px;height:260px;padding:20px;">
                ${ranked.map((r, i) => {
                    const h = Math.max(Math.abs(r.alpha) / maxAlpha * 200, 8);
                    const isPos = r.alpha >= 0;
                    const c = isPos ? '#22c55e' : '#ef4444';
                    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;">
                        <div style="font-size:11px;color:${c};font-weight:700;margin-bottom:4px;">${r.alpha > 0 ? '+' : ''}${r.alpha.toFixed(2)}%</div>
                        <div style="width:100%;max-width:60px;height:${h}px;background:${c}30;border:1px solid ${c};border-radius:4px 4px 0 0;"></div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:6px;text-align:center;writing-mode:vertical-rl;height:80px;">${r.name}</div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        // 策略详情表格
        const tableBody = document.querySelector('#ma-table tbody');
        if (tableBody) {
            tableBody.innerHTML = ranked.map((r, i) => {
                const fees = r.fees || {};
                return `<tr ${i === 0 ? 'style="background:rgba(34,197,94,0.06);"' : ''}>
                    <td>#${i + 1}${i === 0 ? ' ★' : ''}</td>
                    <td><b>${r.name}</b></td>
                    <td style="color:${r.alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${r.alpha > 0 ? '+' : ''}${r.alpha.toFixed(2)}%</td>
                    <td>${r.strategy_return > 0 ? '+' : ''}${r.strategy_return.toFixed(2)}%</td>
                    <td>${r.buy_hold_return > 0 ? '+' : ''}${r.buy_hold_return.toFixed(2)}%</td>
                    <td>${r.max_drawdown.toFixed(2)}%</td>
                    <td>${r.total_trades}</td>
                    <td>${r.liquidations || 0}</td>
                    <td>$${(fees.total_costs || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                </tr>`;
            }).join('');
        }

        // 最佳策略交易明细
        const bestTitle = document.getElementById('ma-best-title');
        if (bestTitle) bestTitle.textContent = `最佳策略: ${best.name} · 交易明细`;

        const tradesBody = document.querySelector('#ma-trades-table tbody');
        if (tradesBody && best.trades) {
            tradesBody.innerHTML = best.trades.slice(0, 50).map(t => {
                const isOpen = t.action?.includes('OPEN');
                const isSell = t.action?.includes('SELL') || t.action?.includes('SHORT');
                const color = isSell ? 'var(--accent-red)' : 'var(--accent-green)';
                return `<tr>
                    <td style="font-size:12px;">${String(t.time).substring(0, 16)}</td>
                    <td style="color:${color};font-weight:600;">${t.action || ''}</td>
                    <td>${t.direction || ''}</td>
                    <td>$${(t.price || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${t.leverage || 1}x</td>
                    <td>$${(t.total || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td style="font-size:12px;max-width:300px;overflow:hidden;text-overflow:ellipsis;">${(t.reason || '').substring(0, 60)}</td>
                </tr>`;
            }).join('');
        }

        // 结论
        const conclusionEl = document.getElementById('ma-conclusion');
        if (conclusionEl) {
            const bestStrat = data.best_strategy || {};
            conclusionEl.innerHTML = `
                <div class="card-title">回测结论</div>
                <div style="background:rgba(59,130,246,0.06);border-radius:8px;padding:16px;border-left:3px solid #3b82f6;">
                    <div style="font-weight:700;color:#3b82f6;margin-bottom:8px;">
                        最佳策略: ${bestStrat.name || best.name} · α = ${(bestStrat.alpha || best.alpha || 0) > 0 ? '+' : ''}${(bestStrat.alpha || best.alpha || 0).toFixed(2)}%
                    </div>
                    <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
                        基于《均线技术分析》全书理论, 在ETH/USDT ${data.trade_days || 7}天回测中:<br>
                        · 买入持有收益: ${(best.buy_hold_return || 0).toFixed(2)}%<br>
                        · 最佳策略收益: ${(best.strategy_return || 0).toFixed(2)}%, 超额α = ${(best.alpha || 0) > 0 ? '+' : ''}${(best.alpha || 0).toFixed(2)}%<br>
                        · 交易${bestStrat.trades_count || best.total_trades || 0}笔, 最大回撤${(best.max_drawdown || 0).toFixed(2)}%<br>
                        · 核心信号源: 葛南维八大法则 + 均线排列(多头/空头) + 金叉死叉 + 特殊形态(银山谷/金山谷/死亡谷/蛟龙出海/烘云托月等)
                    </div>
                </div>
            `;
        }
    }


// Auto-load on page ready
document.addEventListener('DOMContentLoaded', function() {
    loadMAStrategy();
});
</script>
{% endblock %}
