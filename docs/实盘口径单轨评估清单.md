# 实盘口径单轨评估清单

## 1. 口径约定

- **实盘口径** = 与 live 一致：`use_microstructure=True`, `use_dual_engine=True`, `use_vol_target=True`。
- **研究口径** = 日回测默认：上述三开关关闭（backtest_multi_tf_daily 强制关）。
- **主线**：后续 A/B 与策略调参统一在实盘口径下进行，使用 `python ab_test_v3.py --live`（或 `RUN_LIVE_AB=1`）。
- 决策与迁移性以 **实盘口径** 结果为准；研究口径 run#43 仅作参考，不直接迁移。

---

## 2. 实盘口径基线

| 项目 | 值 |
|------|-----|
| 基线 run | run#44 |
| 收益 / Alpha | +702.04% / +715.59% |
| MaxDD / 组合PF | -6.43% / 1.69 |
| CLOSE_SHORT 净亏 | -86,936 |
| 总交易 / 总费用 | 958 / $148,558 |

---

## 3. 建议跑的组合（实盘口径内）

在 `ab_test_v3.py --live` 下已覆盖的变体及建议优先级：

| 优先级 | 变体 | 说明 | 验收方向 |
|--------|------|------|----------|
| P0 | A:live基线 | 对照 | — |
| P0 | **E:LVT+35** | 第八轮最优，已作主线默认 | pPF≥1.69, CLOSE_SHORT 下降, DD≥-9% |
| P1 | F:gate+neutral | 纳入 neutral 门控 | 若 CLOSE_SHORT 再降且 pPF 不劣 |
| P1 | D:LVT+25 | 门控略弱于 E | 对照 |
| P2 | G:确认SS100 | 仅高分确认，不做禁卖 | 趋势尾部 SPOT_SELL 收敛 |

不建议在实盘口径下优先：B/C（收紧 hard_stop）、H/I（sl-22 或 LVT25+neutral 组合），第八轮已显示恶化或收益代价大。

---

## 4. 验收门槛与优先指标（Codex）

**优先看这四个指标**：`pPF`、`CLOSE_SHORT 净亏`、`high_vol SPOT_SELL 净值`、`fee_drag`。改进空间主要在“高波动期卖出噪声”，不是再堆空头参数。

**固定门槛**：
- **MaxDD** 不劣于 **-9%**。
- **组合 pPF** 不低于 **实盘口径基线 1.69**（run#44）或当前主线 run#46 的 **1.84**。
- **CLOSE_SHORT** 净亏较基线 **下降或持平**。
- **2024 OOS**：同口径对照（见下）不退化。

任一不满足则该变体不晋级为默认。

---

## 5. 淘汰规则

- 实盘口径下：若 CLOSE_SHORT 恶化且 pPF 下降 → 淘汰。
- 若 MaxDD 劣于 -9% → 淘汰。
- 若 2024 OOS 同参明显退化（如 Alpha 大幅为负或 DD 显著放大）→ 淘汰或仅作观察。

---

## 6. 正式落库与 OOS 对照（已执行）

- **落库**：E:LVT+35 已落库为 **run#46**（2025-01-01～2026-01-31，实盘口径）：+738.40% / Alpha +751.95% / MaxDD -6.83% / pPF 1.84。
- **2024 OOS 必须同口径对照**：先有“实盘口径基线 gate=15”再与 run#47(gate=35) 比较，否则无法归因 +35 是否在 OOS 上真有效。
  - **run#47**（实盘口径 + LVT35）：+81.74% / Alpha +59.04% / pPF 1.23；high_vol 净亏（run#47 约 -20.7k，主要来自 3 笔 SPOT_SELL）。
  - **run#48**（2024 实盘口径 基线 gate=15）：已跑，标签「2024 OOS 实盘口径基线 gate=15」，与 run#47(gate=35) 同口径对照，便于归因 +35 在 OOS 上是否有效。
- 结论以 **DB mtf_runs / summary_json** 为准；csv 导出仅辅助，量纲不一致时不参与决策。

---

## 7. warmup 与 OOS 可解释性

- 回测循环 warmup 已改为 **按指标窗口固定 200 bar**（不再按样本长度 5%），避免长区间前段被跳过过多（如 2024 实际从 2 月才开始）。
- 固定 200 bar 后，OOS 起点可明确推算（如 1h 约 8 天），便于复现与解释。

---

## 8. 第九轮：现货卖出质量（Codex）

- **命令**：`python ab_test_v3.py --live --spot`（或 `RUN_LIVE_AB=1 RUN_LIVE_SPOT=1`）。
- **基线**：run#46（实盘口径 LVT+35）。
- **变体**：A/B-1 把 `spot_sell_confirm_ss` 从 100 下调到 60/70、`spot_sell_confirm_min=2`；A/B-2 提高 `sell_threshold`(18→22) 或拉长 `spot_cooldown`(12→18/24)；组合 G：SS70min2+cd18。
- **目的**：压低高波动期 SPOT_SELL 噪声（run#47 中 high_vol 下 SS 37/44/58 等中等强度卖出导致净亏），不改为 hard_stop=-0.22。

---

## 9. 中期重构（Codex，暂不实现）

- 将 **SPOT_SELL 阈值** 从 `short_threshold` 体系拆出，改为独立 **`spot_sell_threshold`**，并尽量支持按 regime 调整（optimize_six_book 中 1099-1110 与 sell_threshold 解耦）。
- `trend_enhance_active` 与 `engine_mode != reversion` 解耦（optimize_six_book 约 1011），避免实盘双引擎下 neutral/high_vol 落 reversion 时趋势持仓保护失效。
